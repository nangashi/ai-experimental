# skill_audit 収束性分析レポート

## 1. 実行概要

### agent_audit_new 対象 (7 runs)

| Run | タイムスタンプ | 検出 | 承認 | 解決済み | 部分的解決 | 未対応 | リグレッション | 判定 | リトライ |
|-----|-------------|------|------|---------|-----------|--------|---------------|------|--------|
| 1 | 20260212-230131 | 18 | 18 | 17 | 0 | 1 | 0 | NEEDS_ATTENTION | あり(1件) |
| 2 | 20260212-234727 | 17 | 17 | 16 | 1 | 0 | 1(行数増加) | PASS | あり(1件) |
| 3 | 20260213-000343 | 13 | 13 | 11 | 1 | 1 | 1(参照整合性) | ISSUES_FOUND | あり(2件) |
| 4 | 20260213-001941 | 15 | 15 | 15 | 0 | 0 | 0 | PASS | なし |
| 5 | 20260213-081128 | 12 | 12 | 12 | 0 | 0 | 0 | PASS | なし |
| 6 | 20260213-082335 | 14 | 14 | 13 | 1 | 0 | 0 | PASS | なし |
| 7 | 20260213-084321 | 14 | 14 | 13 | 0 | 1 | 1(参照整合性) | ISSUES_FOUND | あり(1件) |

### agent_bench_new 対象 (5 runs)

| Run | タイムスタンプ | 検出 | 承認 | 解決済み | 部分的解決 | 未対応 | リグレッション | 判定 | リトライ |
|-----|-------------|------|------|---------|-----------|--------|---------------|------|--------|
| 8 | 20260212-234915 | 8 | 8 | 7 | 1 | 0 | 0 | PASS | なし |
| 9 | 20260213-000814 | 14 | 14 | 13 | 0 | 1 | 1(参照整合性) | ISSUES_FOUND | なし |
| 10 | 20260213-081136 | 9 | 9 | 9 | 0 | 0 | 0 | PASS | なし |
| 11 | 20260213-082600 | 18 | 18 | 18 | 0 | 0 | 1(参照整合性) | ISSUES_FOUND | なし |
| 12 | 20260213-084529 | 16 | 16 | 16 | 0 | 0 | 4(内部変数) | PASS | なし |

**重要な観察**: 検出件数が run 間で減少していない（Run 1: 18件 -> Run 7: 14件、Run 8: 8件 -> Run 12: 16件）。理論上、前回の改善が反映されれば検出件数は漸減するはずだが、実際には新規指摘が次々と生成されている。

---

## 2. 指摘の繰り返しパターン

### パターン A: 外部パス参照の不一致（最も顕著な繰り返し）

| Run | ID | タイトル | 状態 |
|-----|-----|---------|------|
| 1 | C-1 | 外部パス参照のスキル名不一致 (agent_audit -> agent_audit_new) | 検出->修正->解決済み |
| 2 | C-1 | 外部参照パスが旧スキル名を使用 | **同一問題が再検出** |
| 5 | C-1 | 外部参照のパス不整合 | **再度検出（Run 4 で解決済みのはず）** |
| 8 | C-1 | 外部パス参照の不整合 (agent_bench -> agent_bench_new) | 検出->修正->解決済み |
| 10 | C-1 | 外部スキル参照により独立性が損なわれている | **同一問題が再検出** |

**分析**: Run 1 で検出・修正・解決済み判定されたパス不整合が、Run 2 で再度検出されている。さらに Run 5 でも再検出。これは skill_audit スキルが「前回 run の resolved_issues を正しく引き継げていない」ことを示す。各 run が独立してゼロからレビューを開始するため、前回の修正を認識できない。

### パターン B: SKILL.md 行数超過

| Run | ID | 行数 | 状態 |
|-----|-----|------|------|
| 1 | I-4 | 279行 (目標250行超過) | 検出->修正->解決済み |
| 2 | C-5 | 279行 (改善前と同値で再検出) | 検出->修正->部分的解決(305行に増加) |
| 3 | C-6 | 262行 (~12行超過) | 検出->修正->部分的解決(268行) |
| 8 | C-7 | 372行 (122行超過) | 検出->修正->部分的解決(350行) |
| 9 | C-4 | 340行 (90行超過) | 検出->修正 |

**分析**: 行数超過は毎回検出されるが、改善適用時に他の指摘対応で行数が増加するため、永続的に収束しない。改善適用そのものが行数を増やすという構造的矛盾がある。

### パターン C: テンプレート内パス変数の未定義

| Run | ID | タイトル | 状態 |
|-----|-----|---------|------|
| 3 | C-3 | テンプレート内プレースホルダの定義欠落 | 検出->修正->**未対応** |
| 3 (retry) | C-3 | 同上（リトライで再承認） | 承認->修正試行 |
| 7 | C-1 | テンプレート内のパス変数が未定義 | **同一問題が再検出** |
| 7 (retry) | C-1 | 同上 | 承認->**再度未対応** |

**分析**: templates/apply-improvements.md へのパス変数セクション追加が、Run 3 で指摘され、リトライでも未対応、Run 7 で再度検出され、リトライでも未対応。改善適用サブエージェントが SKILL.md の変更を優先し、テンプレートファイルへの変更を実装しないパターンが繰り返されている。

### パターン D: Phase 2 Step 4 失敗時のフォールバック

| Run | ID | タイトル | 状態 |
|-----|-----|---------|------|
| 1 | C-6 | Phase 2 Step 4 サブエージェント失敗時のフォールバック未定義 | 検出->修正->解決済み |
| 2 | C-2 | Phase 2 Step 4 サブエージェント失敗時の処理が未定義 | **同一問題が再検出** |
| 5 | C-2 | Phase 2 Step 4 改善適用失敗時のフォールバック未定義 | **再度検出** |

**分析**: 同一問題が3回検出。Run 1 で解決済み判定後、Run 2 で「別の観点から」同じ問題が再検出される。レビューアーが前回の修正を認識していないか、修正が不十分と判断しているが、その判断基準が不安定。

---

## 3. 指摘のドリフト・振動パターン

### ドリフト A: グループ分類ロジックの配置

| Run | 方向性 |
|-----|-------|
| 1 (I-4) | SKILL.md が行数超過 -> グループ分類を group-classification.md へ委譲すべき |
| 2 (C-1推奨) | パス参照修正 -> またはグループ分類基準を SKILL.md に**インライン化**することを検討 |
| 3 (I-4) | グループ分類ロジックの外部化 -> group-classification.md への参照に置換 |
| 6 (I-2) | グループ分類判定ロジックと group-classification.md の内容が**重複** -> Read + apply で一貫性を保つ |

**分析**: Run 1 で「外部化すべき」、Run 2 で「インライン化も検討」、Run 3 で再度「外部化すべき」、Run 6 で「重複している」と方向性が振動している。外部化を実行すると「参照パスの不整合」が発生し、インライン化すると「行数超過」が悪化するというジレンマ。

### ドリフト B: findings 収集のコンテキスト管理

| Run | 方向性 |
|-----|-------|
| 1 (I-5) | findings を全て親コンテキストに保持 -> findings 要約のみを保持すべき |
| 1 (retry) | findings メタデータ方式に変更 |
| 4 (I-1) | findings 収集を**サブエージェントに委譲**してコンテキスト削減 |
| 6 (I-7) | 親が findings ファイルを全件 Read -> **必要時のみ個別 Read** に変更すべき |
| 7 (I-7) | Phase 1 返答行数を拡張して findings 情報を含める -> **再読み込みを削減** |

**分析**: findings の管理方式が「全文保持 -> メタデータ -> サブエージェント委譲 -> 遅延読み込み -> 返答拡張」と毎回異なる方向に変化。Run 1 の改善が完了した後も、Run 4, 6, 7 で「同じ問題を別の角度から」再指摘している。

### ドリフト C: バックアップファイル管理

| Run | 方向性 |
|-----|-------|
| 1 (C-9) | バックアップ無限増殖 -> 既存バックアップ確認を追加 |
| 5 (I-8) | バックアップ重複生成 -> 既存バックアップ確認を追加 |
| 6 (I-5) | 既存バックアップ再利用ロジックあるが方針不明確 -> 方針を明記 |
| 7 (I-8) | バックアップ検出方法が環境依存 -> `ls -t` に変更 |

**分析**: 同一テーマが4回にわたり異なる粒度で指摘。Run 1 の修正後、Run 5 で同一問題が再検出（修正が引き継がれていない）。その後 Run 6, 7 では改善された状態に対して更に細かい指摘が続く。

---

## 4. 改善誘発の連鎖パターン

### 連鎖 A: 行数超過の悪化サイクル

```
Run 1: 279行で超過 -> 18件の改善を適用
Run 2: 305行に増加（改善適用で26行増）-> 行数超過が「部分的解決」
Run 3: 262行に減少（外部化で削減）-> まだ12行超過
Run 4: 改善適用で再び増加（推定）
```

改善を適用するたびにエラーハンドリング、条件分岐、変数定義などが追加され、行数が増加する。行数削減の指摘と行数を増やす他の指摘が同時に出るため、永続的に解決しない。

### 連鎖 B: 外部化 -> 参照整合性問題

```
Run 1: グループ分類をインラインから外部化 (I-4)
Run 3: 外部化したファイルの参照パス不整合 (C-3: group-classification.md 不在時の処理)
Run 4: 参照パスが相対パスで解決方法が不明 (C-3)
Run 6: 参照先ファイル不在時の挙動未定義 (C-1)
```

外部化するたびに「参照先が不在の場合の処理」「パスの解決方法」という新しい問題が生じる。

### 連鎖 C: エラーハンドリング追加 -> 条件分岐の完全性

```
Run 2: エラーハンドリング追加 (C-2)
Run 3: 追加されたエラーハンドリングの条件分岐が不完全 (C-2, C-4)
Run 4: 分岐ロジックに未定義ケース (C-2)
Run 6: 分岐のデフォルト処理欠落 (C-4)
Run 7: 分岐の追加条件が曖昧 (C-2, C-4)
```

エラーハンドリングを追加するたびに「追加された分岐のエッジケース」が新しい指摘を生む。

---

## 5. レビューアー基準のブレ

### 重大度の変動

| テーマ | Run 1 | Run 2 | Run 3 | Run 5 | Run 6 |
|--------|-------|-------|-------|-------|-------|
| パス参照不整合 | C (critical) | C (critical) | - | C (critical) | - |
| SKILL.md 行数超過 | I (improvement) | C (critical) | C (critical) | - | - |
| パス変数未定義 | C (critical) | I (improvement) | C (critical) | I (improvement) | C (critical) |
| バックアップ管理 | C (critical) | - | - | I (improvement) | I (improvement) |

**分析**: 同一テーマの重大度が run によって critical と improvement の間で変動する。特に「パス変数未定義」は Run 1 で C、Run 2 で I、Run 3 で C と振動。レビューアーの判断基準が実行ごとに異なる。

### 検出件数の不安定性

- Run 1: 18件（C:9, I:9）
- Run 2: 17件（C:8, I:9）
- Run 3: 13件（C:6, I:7、ただし「13件省略」と注記）
- Run 4: 15件（C:6, I:9）
- Run 5: 12件（C:3, I:9）
- Run 6: 14件（C:5, I:9）
- Run 7: 14件（C:5, I:9）

improvement の件数が常に9件前後で安定しているのは、レビューアーが「枠を埋めるために」一定数の改善提案を生成している可能性を示唆する。

---

## 6. 解決済み判定の問題

### resolved_issues フィルタの不在

全12 run を通じて、**前回 run の resolved_issues を参照して除外するメカニズムが存在しない**。各 run は独立してゼロからレビューを実行するため、前回解決済みの問題が再検出される。

具体例:
- Run 1 で C-1（パス参照不整合）が解決済み判定 -> Run 2 で同一問題が C-1 として再検出
- Run 1 で C-6（サブエージェント失敗時フォールバック）が解決済み -> Run 2 で C-2 として再検出
- Run 1 で I-1（一括承認粒度）が解決済み -> Run 5 で I-4 として再検出
- Run 1 で I-8（グループ判定基準の曖昧性）が解決済み -> Run 6 で I-2 として再検出

### verification の精度

verification フェーズの判定精度は概ね正確だが、以下の問題がある:

1. **テンプレートファイルへの変更の見落とし**: Run 3 と Run 7 で templates/apply-improvements.md への変更が「未対応」と正しく判定されているが、改善適用サブエージェントがこのファイルを修正しない問題が繰り返されている
2. **行数増加のリグレッション検出**: Run 2 で行数が 279 -> 305 に増加したことをリグレッションとして検出しているが、影響度を「low」と判定。改善が行数増加を招く構造的問題を正しく認識していない
3. **参照整合性チェックの不完全性**: Run 9 で phase3-error-handling.md が存在しないことをリグレッションとして検出できたが、Run 11 では批評テンプレート内の未定義変数をリグレッションとして検出しつつも PASS 判定をオーバーライドしていない

---

## 7. 検証フェーズの問題

### verification の誤判定パターン

| パターン | 頻度 | 影響 |
|---------|------|------|
| SKILL.md の変更は正確に検出するが、テンプレートファイルの変更漏れを検出しない | 3回 (Run 3, 7) | 高 - テンプレート修正が永続的に未対応 |
| 「部分的解決」判定が甘い（行数増加を「機能強化優先」として PASS） | 2回 (Run 2, 3) | 中 - 構造的問題が許容される |
| リグレッション検出後の判定が不一致（low 影響度リグレッションで PASS/ISSUES_FOUND が揺れる） | 3回 (Run 2, 11, 12) | 中 - 判定基準の一貫性不足 |

### 検証漏れの具体例

**Run 7 の C-1 未対応**:
- 改善計画に「templates/apply-improvements.md にパス変数セクションを追加」と記載
- 改善適用サブエージェントが SKILL.md のみを修正し、テンプレートファイルを修正しなかった
- verification が正しく「未対応」と判定
- しかし、これは Run 3 で全く同じ問題が発生し、リトライでも修正されなかったパターンの再発

**根本原因**: apply-improvements サブエージェントが複数ファイルにまたがる変更を一貫して実行できない。SKILL.md の変更に集中し、テンプレートファイルの変更を落とす傾向がある。

---

## 8. 指摘の質の評価

### 実質的改善 vs 表面的指摘

全12 run の指摘を分類すると:

| カテゴリ | 件数 | 割合 | 例 |
|---------|------|------|-----|
| 実質的バグ・参照エラー | 12 | 8% | パス参照不整合（agent_audit -> agent_audit_new） |
| エラーハンドリング不足 | 38 | 25% | サブエージェント失敗時のフォールバック、エッジケース処理 |
| 仕様の曖昧さ | 42 | 28% | 条件分岐の完全性、変数定義の欠落 |
| 効率改善 | 28 | 18% | コンテキスト削減、二重読み込み排除 |
| UX 改善 | 22 | 14% | ユーザー確認追加、エラーメッセージ改善 |
| 表面的・主観的 | 10 | 7% | 行数超過（閾値自体が主観的）、テンプレートサイズ削減 |

**分析**: 指摘の約 70% は実質的な改善につながるものだが、以下の問題がある:

1. **エッジケースの無限展開**: エラーハンドリング系の指摘は、対応するたびに新しいエッジケースが検出される。例えば「サブエージェント失敗時の処理」を追加すると、「失敗時のリトライ回数」「リトライ失敗後の処理」「タイムアウト時の処理」が順次指摘される。これは収束しない。

2. **仕様の完全性への過度な要求**: 条件分岐の完全性に関する指摘は、理論上は全てのパスが明示されるまで終わらない。しかし、LLM が実行するワークフローに対して全パスを明示する意義は低い（LLM は未定義の状況にも適応できる）。

3. **改善提案の枠埋め**: improvement カテゴリが常に 9 件前後で安定していることから、レビューアーが「一定数の指摘を出す」バイアスを持っている可能性がある。

---

## 9. 収束を阻害する根本原因（まとめ）

### 原因 1: run 間の状態引き継ぎの欠如 [影響: 致命的]

各 run が独立して実行され、前回の resolved_issues がフィルタリングされない。これが最大の収束阻害要因。Run 1 で解決済みと判定された問題が Run 2 で再検出される。

### 原因 2: 改善適用が新規指摘を誘発する構造的循環 [影響: 高]

改善を適用すると:
- エラーハンドリング追加 -> 新しいエッジケースが発生
- 外部化 -> 参照整合性の問題が発生
- 行数削減 -> 他の改善で行数が増加

この循環は skill_audit スキルの設計に内在する問題であり、「全ての改善を1回で適用し切る」ことができない限り収束しない。

### 原因 3: レビューアーの判断基準の非決定性 [影響: 高]

同一の問題に対して:
- 重大度が run ごとに変動（critical <-> improvement）
- 推奨方向が振動（外部化 <-> インライン化）
- improvement 件数が常に 9 件前後（枠埋めバイアス）

LLM ベースのレビューアーが、毎回異なるコンテキストで判断するため、一貫性が保証されない。

### 原因 4: 改善適用サブエージェントの限界 [影響: 中]

複数ファイルにまたがる変更（SKILL.md + テンプレート）が一貫して実行されない。Run 3 と Run 7 で同一のテンプレート修正漏れが発生。

### 原因 5: エッジケース指摘の無限後退 [影響: 中]

「条件分岐の完全性」「エラーハンドリング」系の指摘は、対応するたびに次のレベルのエッジケースが検出される。理論上、完全な仕様は無限の分岐を要するため、この種の指摘は収束しない。

### 原因 6: 品質基準の閾値が主観的 [影響: 低]

SKILL.md の目標行数（250行）のような基準が、改善適用と矛盾する場合がある。基準自体の妥当性が検証されていない。

---

## 10. 改善提案

### 提案 1: resolved_issues の引き継ぎメカニズムの導入 [対象: 原因 1]

**具体策**:
- 前回 run の `approved-findings.md` と `verification.md` を次回 run のレビューアーに入力として渡す
- verification で「解決済み」と判定された指摘の ID・タイトル・対象箇所をブラックリストとして保持
- レビューアーは新規検出した指摘がブラックリストに該当するかチェックし、該当する場合は除外

**期待効果**: 前回解決済みの問題の再検出を防止し、新規問題のみに集中できる

### 提案 2: 指摘の階層化と収束判定の導入 [対象: 原因 2, 5]

**具体策**:
- 指摘を「Tier 1: 実行阻害バグ」「Tier 2: 仕様の曖昧さ」「Tier 3: 効率・UX改善」に分類
- Tier 1 が 0 件になった時点で収束と判定
- Tier 2, 3 は一定回数（例: 3回）改善を試みて残存する場合は「許容」として打ち切り
- 「行数超過」のような改善適用と矛盾する指摘には上限回数を設定

**期待効果**: 無限に新規指摘が生まれる問題を構造的に解決

### 提案 3: レビューアーへの一貫性制約の追加 [対象: 原因 3]

**具体策**:
- レビューアーに「前回 run で出した推奨と矛盾する推奨を出さない」制約を追加
- 重大度の判定基準を quality-criteria.md に明文化し、レビューアーが参照する
- improvement の最大件数を前回 run の未解決件数 + 3 に制限（枠埋めバイアスの排除）
- 推奨方向（外部化 vs インライン化）が振動する場合、前回の方向を維持する

**期待効果**: run 間の判断一貫性を向上

### 提案 4: 改善適用の検証強化 [対象: 原因 4]

**具体策**:
- 改善計画に含まれる変更対象ファイルのリストを improvement-plan.md に明記
- 改善適用後、変更対象ファイル全てに対して diff を確認し、変更されていないファイルがあれば再適用
- テンプレートファイルへの変更は SKILL.md への変更と別のサブエージェント呼び出しで実行

**期待効果**: テンプレートファイルの修正漏れを防止

### 提案 5: 指摘の深さ制限 [対象: 原因 5]

**具体策**:
- 各テーマ（エラーハンドリング、条件分岐、バックアップ管理等）に「深さレベル」を設定
  - Level 1: 主要パスの処理定義（初回で検出）
  - Level 2: エッジケースの処理定義（2回目で検出）
  - Level 3: エッジケースのエッジケース（検出しない、または info レベルに格下げ）
- 同一テーマが 3 回以上検出された場合、自動的に info レベルに格下げ

**期待効果**: エッジケースの無限後退を防止

### 提案 6: 改善適用の原子性確保 [対象: 原因 2]

**具体策**:
- 1回の run で適用する改善を最大 5 件に制限
- 優先度の高い指摘（Tier 1）から順に適用
- 改善適用後の行数変化を計測し、行数超過が悪化する場合は警告を出力
- 「外部化」と「行数削減」を同時に適用しない（外部化を先に実行し、次回 run で行数を評価）

**期待効果**: 改善適用が新規問題を誘発するサイクルを制御
