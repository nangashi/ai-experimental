# Problem Generator — v001-variant-validation-gate

baseline に対して「生成後のセルフバリデーションステップ」を追加したバリアント。
生成ロジックは baseline と同一だが、保存前に入力型整合性とタスク整合性を自己検証し、不合格なら再生成する。

---

## あなたのタスク

与えられたエージェント定義を分析し、テストシナリオセットとルーブリックを生成してください。生成後、品質バリデーションを実行し、不合格の場合は修正してください。

## 入力

- `{agent_definition_path}`: 評価対象エージェントの定義ファイルパス
- `{knowledge_path}`: 知見ファイルパス（テスト履歴確認用、存在する場合）
- `{test_set_save_path}`: テストシナリオセットの保存先パス
- `{rubric_save_path}`: ルーブリックの保存先パス
- `{agent_name}`: エージェント名

## 手順

### Step 1: エージェント定義の分析

Read で `{agent_definition_path}` を読み込み、以下を特定する:
- 主要タスク、想定入力、期待出力、主要な能力カテゴリ（3-5個）

`{knowledge_path}` が存在する場合は Read で読み込み、テスト履歴を確認。

### Step 2: テストシナリオの生成

5-8個のテストシナリオを生成する（各シナリオの構造は以下）:

```markdown
### T01: {Scenario Title}

**Difficulty**: Easy / Medium / Hard
**Category**: {テストする能力カテゴリ}

#### Input
{20-100行の入力コンテンツ}

#### Quality Rubric

| Criterion ID | Criterion | Full (2) | Partial (1) | Miss (0) | Weight |
|-------------|-----------|----------|-------------|----------|--------|
| T01-C1 | {基準名} | {条件} | {条件} | {条件} | 1.0 |

#### Expected Key Behaviors
- {良い出力に含まれるべき要素}

#### Anti-patterns
- {悪い出力の特徴}
```

ルーブリック基準: 具体的に記述。核心=1.0、補助=0.5。各シナリオ3-6個。
分布: 易2 / 中3 / 難1-3。全カテゴリカバー。
入力: 自然で現実的。多様なドメイン。

### Step 3: バリデーションゲート

生成したテストシナリオに対して以下の3段階の検証を実行する。各検証項目について Pass/Fail を判定し、1つでも Fail があれば Step 4（修正）に進む。

#### 3-a. 入力型整合性チェック

各テストシナリオの Input セクションを確認し、以下を自問する:

> 「このテスト入力は、エージェントが実際の運用で受け取る入力と同じ種類のものか？」

具体的に確認:
- エージェントが設計書を評価するのにコードを入力にしていないか
- エージェントが観点定義を評価するのに設計書を入力にしていないか
- エージェントがコードを生成するのに設計書ではなく要件を入力にしているか

**Pass**: 全シナリオの入力型がエージェントの想定入力と一致
**Fail**: 1つでも不一致がある

#### 3-b. タスク整合性チェック

各シナリオのルーブリック基準を確認し、以下を自問する:

> 「この基準はエージェントの核心能力を測定しているか？エージェントの目的とは無関係な基準が含まれていないか？」

具体的に確認:
- ルーブリック基準がエージェントの能力カテゴリのどれに対応するか
- 対応しない基準が全体の 20% 以上あるか

**Pass**: 80%以上の基準がエージェントの能力カテゴリに対応
**Fail**: 20%以上の基準が無関係

#### 3-c. 多様性チェック

> 「テストシナリオ間で入力の内容が十分に多様か？同じパターンの入力が連続していないか？」

**Pass**: 全シナリオの入力が異なるドメイン/状況をカバー
**Fail**: 半数以上のシナリオが類似のパターン

### Step 4: 修正（Fail がある場合のみ）

Fail になった項目について、以下の修正を行う:

- **入力型 Fail**: 該当シナリオの Input を、エージェントの想定入力型に合致するものに書き直す
- **タスク整合性 Fail**: 無関係な基準を、エージェントの能力カテゴリに対応する基準に置き換える
- **多様性 Fail**: 重複パターンのシナリオの入力を、異なるドメイン/状況に差し替える

修正後、Step 3 を再実行する（最大1回の修正ループ）。

### Step 5: 保存

テストシナリオセットを `{test_set_save_path}` に、ルーブリックを `{rubric_save_path}` に Write で保存する。

### Step 6: サマリ返答

```
## テストシナリオセット
- エージェント: {agent_name}
- シナリオ数: {N}
- 能力カテゴリ: {カテゴリリスト}
- バリデーション: {Pass / 修正後Pass / Fail(理由)}

| ID | タイトル | 難易度 | カテゴリ | 基準数 |
|----|---------|--------|---------|--------|
...
```
