# agent_audit_reviewer2 設計書

## 設計判断と根拠

### D1: 自己完結型（agent_benchへの依存排除）

**決定**: agent_bench のファイルに依存せず、必要なテンプレートを全てスキル内に統合する。

**根拠**:
- agent_bench はワーキングツリーから削除済み → 将来的な復元保証なし
- 削除済みファイルへの依存は脆弱なアーキテクチャ
- 自己完結型の方がポータビリティ・保守性が高い
- agent_bench の良質なテンプレート内容はv2に取り込める

### D2: 2テスト文書 × 10問 × 2回 = 40データポイント/バリアント

**決定**: 2つのテスト文書（異なるドメイン）を初期化時に生成し、各2回評価する。

**根拠**:
- v1の最大の問題は単一テスト文書への過適合（proven-insightsのR1-R10で繰り返し確認）
- 2文書の交差検証で過適合を構造的に防止
- 10問/文書で主要カテゴリを十分にカバー（5スコープ項目 × 2問 = 最低10問）
- 2回/文書/バリアント → 合計4回でSD計算可能（v1の3回より1データポイント多い）
- コスト: v1比+33%程度（8評価エージェント vs v1の6）

**代替案との比較**:
| 案 | データポイント | 過適合対策 | コスト比 |
|----|-------------|----------|---------|
| v1: 1doc×15q×3run | 45 | なし | 1.0x |
| **v2: 2doc×10q×2run** | **40** | **交差検証** | **1.3x** |
| 2doc×15q×3run | 90 | 交差検証 | 2.0x |
| 1doc×15q×5run | 75 | なし | 1.7x |

v2案は過適合対策を得ながらコスト増を最小限に抑えるスイートスポット。

### D3: カテゴリバランス目的関数

**決定**: 平均スコアに加え、カテゴリ別検出率と回帰ペナルティを導入する。

**根拠**:
- v1のproven-insightsで10ラウンド連続「注意力再配分トラップ」(-1.3〜-4.7pt)
- 原因: 全体平均のみを最適化 → カテゴリ間のトレードオフに鈍感
- 解決: 回帰を明示的にペナルティ化
  - 改善スコア = Σ(カテゴリ改善) - 1.5 × Σ(|カテゴリ回帰|)
  - 回帰がある限り推奨されにくい仕組み

### D4: 制約なしメタインプルーバー

**決定**: v1のS1-S5戦略メニューを廃止し、エラー分析からの自由生成に変更。

**根拠**:
- OPROの核心は「LLMの自由な探索」だが、v1はS1-S5の5戦略に制約
- v1のhistoryでは同じ戦略の繰り返し適用（S1: コンテンツ追加）が失敗パターン
- 自由形式なら、分析結果に基づいてLLMが最適なアプローチを自ら発見できる
- 代わりに「回帰予測」を必須化：各変更のカテゴリ別影響を事前予測し、事後と照合

### D5: 床効果・天井効果の識別と除外

**決定**: ベースライン評価後、常時検出(天井)・常時未検出(床)の問題を識別し、改善対象から除外。

**根拠**:
- v1のhistoryで15問中3問(20%)が全ラウンドで×固定（床効果）
- これらはプロンプト最適化では改善不可能 → メタインプルーバーのリソース浪費
- 天井問題（常時○）は改善不要 → 「保持すべき強み」としてのみ参照
- 識別力の高い問題にメタインプルーバーの注力を集中させる

### D6: パースペクティブ生成の統合テンプレート

**決定**: 4つのcritic テンプレートを1つのパラメータ化テンプレートに統合。

**根拠**:
- 4テンプレートの構造は類似（入力読み込み→分析→報告）
- 差異はfocus_areaのみ → パラメータ化で1ファイルに統合可能
- ファイル数削減(4→1)で保守性向上
- 4並列起動は維持（各サブエージェントに異なるfocus_areaを渡す）

---

## アーキテクチャ

### ファイル構成

```
.claude/skills/agent_audit_reviewer2/
├── SKILL.md                         # メインワークフロー定義
├── scoring-rubric.md                # 採点基準（カテゴリバランス追加）
├── proven-insights.md               # エージェント横断知見（初期は空構造）
├── test-document-guide.md           # テスト文書生成ガイド（自己完結）
└── templates/
    ├── generate-perspective.md      # パースペクティブ生成
    ├── critic-perspective.md        # パースペクティブ批評（パラメータ化）
    ├── init-test-document.md        # テスト文書生成
    ├── validate-test-document.md    # テスト文書品質検証
    ├── meta-improver.md             # 制約なしメタインプルーバー
    ├── scoring.md                   # 採点＋エラー分析
    ├── analysis-report.md           # 比較レポート
    ├── history-update.md            # 履歴更新
    └── insights-extract.md          # 知見抽出
```

### 出力ディレクトリ

```
.agent_audit_reviewer2/{agent_name}/
├── perspective-source.md           # パースペクティブ（問題バンク含む）
├── perspective.md                  # 作業コピー（問題バンク除外）
├── test-document-1.md              # テスト文書1
├── answer-key-1.md                 # 正解キー1
├── test-document-2.md              # テスト文書2
├── answer-key-2.md                 # 正解キー2
├── history.md                      # 最適化履歴
├── prompts/                        # バリアントプロンプト
├── results/                        # 評価結果・採点
└── reports/                        # 比較レポート
```

### Phase構造とエージェント数

#### Phase 0: 初期化（初回のみ）
- パースペクティブ解決: 0-5エージェント（既存なら0、自動生成なら1+4+1=6）
- テスト文書生成: 2エージェント（2文書並列）
- テスト文書検証: 2エージェント（2文書並列）
- ベースライン評価: 4エージェント（2文書×2回）
- ベースライン採点: 2エージェント（文書別）
- 合計: 10-16エージェント（1回のみ）

#### Phase 1: メタインプルーバー
- 1エージェント → 2バリアント生成

#### Phase 2: 並列評価
- 2バリアント × 2文書 × 2回 = 8エージェント

#### Phase 3: 採点＋分析
- 2バリアント × 2文書 = 4採点エージェント
- 1レポートエージェント
- 合計: 5エージェント

#### Phase 4: 更新・次アクション
- 1 history更新 + 1 insights更新 = 2エージェント

#### ラウンド合計: 16エージェント（v1は12-16）

### スコアリング設計

#### 基本スコア（per document, per run）
```
run_score = Σ(検出スコア) + (ボーナス × 0.5) - (ペナルティ × 0.5)
```

#### 統合スコア（cross-document）
```
overall_mean = average(doc1_run1, doc1_run2, doc2_run1, doc2_run2)
overall_sd = stddev(doc1_run1, doc1_run2, doc2_run1, doc2_run2)
cross_doc_gap = |doc1_mean - doc2_mean|
```

#### カテゴリバランス指標
```
per-category: detection_rate = (Σ○ + 0.5×Σ△) / (total_questions × total_runs)
balance = min(category_rates) / max(category_rates)  # 0-1
```

#### 回帰加重比較
```
adjusted_diff = raw_mean_diff - 1.5 × Σ(regressed_category_rate_drops)
```
- raw_mean_diff > 0 でも、回帰があれば adjusted_diff が負になりうる
- これにより「注意力再配分トラップ」を構造的に抑制

### 推奨判定基準

| 条件 | 判定 |
|------|------|
| adjusted_diff > 1.0pt AND cross_doc_gap < 1.5pt | バリアントを推奨 |
| adjusted_diff 0.5-1.0pt AND no category regression | SDが小さい方を推奨 |
| adjusted_diff < 0.5pt OR category regression あり | 現在ベストを推奨 |

### 収束判定

| 条件 | 判定 |
|------|------|
| 3ラウンド連続で改善幅 < 0.5pt | 収束の可能性あり |
| それ以外 | 継続推奨 |
