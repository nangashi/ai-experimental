# 正解キー

## 実行条件
- **観点**: セキュリティ（設計レビュー）
- **入力型**: 設計書
- **埋め込み問題数**: 10問

---

## 埋め込み問題一覧

### P01: JWTアクセストークンのlocalStorage保存によるXSS脆弱性

- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **検出難易度**: easy
- **埋め込み技法**: 省略（HttpOnly Cookieへの言及なし）
- **該当箇所**: セクション4.1「トークン保存場所」— 「アクセストークン: ブラウザの `localStorage` に保存」
- **問題の説明**: JWTをlocalStorageに保存すると、XSS攻撃が成立した際にJavaScriptからトークンが読み取られ、セッションハイジャックが発生する。マルチテナントプラットフォームではテナント管理者アカウントのなりすましに連鎖し、テナント全データへの不正アクセスが可能になるため影響範囲が広い。アクセストークンもHttpOnly Cookieでの保存に変更すべき。
- **検出判定基準**:
  - ○: localStorageへのJWT保存がXSS時のトークン漏洩リスクをもたらすことを具体的に指摘し、HttpOnly Cookieや代替手段への変更を提案している
  - △: localStorageへの保存に言及しているが、XSS脆弱性との具体的な接続や修正案がない
  - ×: 問題を検出していない、またはlocalStorageの使用に言及していない

---

### P02: 本番シークレットのGitリポジトリ保存

- **カテゴリ**: インフラ・依存関係・監査
- **深刻度**: 重大
- **検出難易度**: medium
- **埋め込み技法**: 矛盾（AWS Secrets Manager管理と宣言しながら、`config/secrets.prod.yaml` もリポジトリに含める）
- **該当箇所**: セクション8.1「シークレット管理」— 「本番環境のシークレット値はデプロイ担当者の参照用に `config/secrets.prod.yaml` へも記録し、アクセス制限を設けたうえでリポジトリに含める」
- **問題の説明**: AWS Secrets Managerでの管理を謳いながら、本番シークレット（DBパスワード・APIキー・JWT署名鍵）をGitリポジトリ内ファイルにも保存する設計は、リポジトリへの不正アクセス・内部不正・CI/CDログ漏洩等により全シークレットが一括漏洩するリスクをもたらす。「アクセス制限付きブランチ」では十分な保護にならず、Secrets Manager一元管理に徹するべき。
- **検出判定基準**:
  - ○: `config/secrets.prod.yaml` をリポジトリに含める設計がシークレット漏洩リスクをもたらすことを具体的に指摘し、リポジトリからの除外とSecrets Manager一元管理への移行を提案している
  - △: シークレット管理に問題があると言及しているが、リポジトリへの本番シークレット保存という核心に触れていない
  - ×: 問題を検出していない

---

### P03: テナント識別ヘッダーの外部操作によるテナント横断アクセスリスク

- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **検出難易度**: hard
- **埋め込み技法**: 暗黙の前提（Kong ゲートウェイが `X-Tenant-ID` を付与する設計において、外部からのヘッダー注入を防ぐ設計が明示されていない）
- **該当箇所**: セクション3.2「マルチテナント分離方式」— 「Kong ゲートウェイが付与する `X-Tenant-ID` ヘッダーはエンドユーザーのリクエストでは検証済みの値として扱われ、コアAPIサービスはこの値を信頼してデータアクセスの絞り込みに使用する」
- **問題の説明**: コアAPIサービスが `X-Tenant-ID` ヘッダーを無条件に信頼する設計において、KongゲートウェイをバイパスしてコアAPIサービスに直接リクエストできる経路が存在する場合（VPC内からの直接アクセス等）、攻撃者が任意のテナントIDをヘッダーに設定することで他テナントデータにアクセスできる。設計書には外部からのヘッダー注入を防ぐネットワーク分離やコアAPI側での検証に関する記述がなく、Kongのみへの依存が暗黙の前提となっている。
- **検出判定基準**:
  - ○: `X-Tenant-ID` ヘッダーを無条件に信頼する設計のリスクを指摘し、Kong経由以外でのアクセスをネットワーク層で遮断する設計、またはコアAPI側でのヘッダー出所検証の必要性を提案している
  - △: テナント間の分離設計に懸念を示しているが、`X-Tenant-ID` ヘッダーの外部注入という具体的なリスクに触れていない
  - ×: 問題を検出していない

---

### P04: state-changing APIへのCSRF対策欠如

- **カテゴリ**: 入力検証・攻撃防御
- **深刻度**: 中
- **検出難易度**: easy
- **埋め込み技法**: 省略（JWTのAuthorizationヘッダー必須でCSRF対策十分と主張し、SameSite CookieやCSRFトークンへの言及なし）
- **該当箇所**: セクション6.3「CSRF対策」— 「JWTは認証済みユーザーのみ保持できるため、CSRF対策として十分と判断する」
- **問題の説明**: CSRF対策としてJWTのAuthorizationヘッダー付与を必須とする設計は、APIクライアントからの呼び出しには有効である。しかし、リフレッシュトークンをHttpOnly Cookieで保持する設計と組み合わせると、CookieをCSRFに悪用される経路が完全には排除されていない。さらに、この方針ではブラウザのform submitやリダイレクト経由の攻撃への防御が設計書上明示されておらず、CSRFリスクを「十分」と断言する根拠が不十分である。明示的なCSRFトークンまたはSameSite=Strict Cookie設定の設計が必要。
- **検出判定基準**:
  - ○: JWTのみに依存したCSRF対策の不十分さを指摘し、CSRFトークンまたはSameSite Cookie設定の必要性を提案している
  - △: CSRF対策に関する問題に言及しているが、設計上の根拠不足という核心に触れていない
  - ×: 問題を検出していない

---

### P05: CORSオリジン検証の正規表現バイパスリスク

- **カテゴリ**: 入力検証・攻撃防御
- **深刻度**: 中
- **検出難易度**: medium
- **埋め込み技法**: 不十分な実装（`/\.nexamart\.com$/` の正規表現は `evil-nexamart.com` や `nexamart.com.attacker.com` にもマッチする）
- **該当箇所**: セクション6.4「CORS設定」— 正規表現 `/\.nexamart\.com$/`
- **問題の説明**: 提示された正規表現 `/\.nexamart\.com$/` は末尾に `nexamart.com` を含む任意のドメインにマッチするため、`evil-nexamart.com` や `nexamart.com.attacker.com` といった攻撃者が管理するドメインもCORSホワイトリストに通過する。また `Access-Control-Allow-Credentials: true` と組み合わさることで、悪意あるサイトからのクロスオリジンリクエストに認証情報が付与されるリスクが生じる。明示的なホワイトリスト（許可オリジン一覧）への変更が必要。
- **検出判定基準**:
  - ○: 正規表現によるオリジン検証が攻撃者ドメインをバイパスできることを具体的に指摘し、明示的なホワイトリスト方式への変更を提案している
  - △: CORS設定に問題があると言及しているが、正規表現バイパスという具体的な攻撃手法に触れていない
  - ×: 問題を検出していない

---

### P06: 認証エンドポイントのレート制限設計欠如

- **カテゴリ**: 脅威モデリング（DoS / Spoofing）
- **深刻度**: 中
- **検出難易度**: medium
- **埋め込み技法**: 省略（ログイン・登録エンドポイントへのレート制限の記述なし）
- **該当箇所**: セクション4.4「認証エンドポイント」— `/api/auth/login` および `/api/auth/register` にレート制限の記述なし
- **問題の説明**: ログイン・アカウント登録エンドポイントにレート制限の設計が存在しない。ブルートフォース攻撃によるパスワード総当たりや大量アカウント登録によるリソース枯渇が可能になる。STRIDEのSpoofing（なりすまし）とDoS（サービス拒否）の観点から、認証エンドポイントにIPまたはアカウントベースのレート制限設計が必要である。
- **検出判定基準**:
  - ○: 認証エンドポイントにレート制限がない設計を指摘し、ブルートフォース攻撃リスクを具体的に説明して対策を提案している
  - △: レート制限の欠如に言及しているが、認証エンドポイントへの特定や攻撃手法の説明が不十分
  - ×: 問題を検出していない

---

### P07: 個人情報のフィールドレベル暗号化を省略した設計上の矛盾

- **カテゴリ**: データ保護
- **深刻度**: 中
- **検出難易度**: hard
- **埋め込み技法**: 矛盾（PII保護を謳いながらフィールドレベル暗号化を「不要」と断言）
- **該当箇所**: セクション5.1「個人情報フィールドの暗号化」— 「氏名・住所・電話番号などの個人情報は平文で保存する。RDS暗号化により保護されているため、フィールドレベルでの追加暗号化は不要と判断する」
- **問題の説明**: RDS全体暗号化（TDE）はディスクの物理的な盗難に対しては有効だが、データベースへの不正アクセス（SQLインジェクション成功、DBAアカウント侵害等）に対しては保護を提供しない。マルチテナントプラットフォームでは全テナントのPIIが同一DBに格納されており、一度の侵害で全テナントの顧客データが漏洩するリスクがある。PIIのフィールドレベル暗号化またはトークナイゼーションの検討が必要。
- **検出判定基準**:
  - ○: RDS TDEがDB不正アクセスに対して保護を提供しないことを指摘し、フィールドレベル暗号化やトークナイゼーションの設計が必要と述べている
  - △: 個人情報の暗号化に関する問題に言及しているが、TDEの保護範囲の限界という核心に触れていない
  - ×: 問題を検出していない

---

### P08: PIIの保持期間・削除方針の未定義

- **カテゴリ**: データ保護
- **深刻度**: 軽微
- **検出難易度**: medium
- **埋め込み技法**: 省略（保持期間・削除方針が「今後設計する」として未定義）
- **該当箇所**: セクション5.3「個人情報（PII）管理」— 「データ保持期間・削除方針: 現時点では未定義。退会申請があった場合の対応フローは今後設計する」
- **問題の説明**: 氏名・メールアドレス・住所・電話番号を保存する設計において、保持期間と削除方針が未定義のままリリースすると、GDPR（忘れられる権利）や個人情報保護法上の対応ができない状態になる。マルチテナントプラットフォームでは退会ユーザーのPII削除責任がテナントとプラットフォームにまたがるため、設計段階での方針定義が必要である。
- **検出判定基準**:
  - ○: PII保持期間・削除方針が未定義であることを指摘し、規制コンプライアンス上の問題（GDPR、個人情報保護法）を具体的に説明している
  - △: 個人情報管理の問題に言及しているが、保持期間・削除方針の欠如という核心に触れていない
  - ×: 問題を検出していない

---

### P09: EOL近接バージョンのライブラリ使用（multer）

- **カテゴリ**: インフラ・依存関係・監査
- **深刻度**: 軽微
- **検出難易度**: easy
- **埋め込み技法**: 過剰な信頼（`multer@1.4.4` を既知の脆弱性があるバージョンとして使用）
- **該当箇所**: セクション2「技術スタック」および8.2「依存ライブラリ管理」— 「`multer@1.4.4` を使用（マルチパートフォーム処理）」
- **問題の説明**: `multer@1.4.4` にはファイルアップロード処理における既知の脆弱性が報告されており、セキュリティパッチを含む新バージョンが公開されている。「四半期ごとの脆弱性確認」を計画しながら既知の脆弱性を持つバージョンを設計書に明記することは設計の一貫性に欠ける。最新の安定バージョンへのアップデートが必要。
- **検出判定基準**:
  - ○: `multer@1.4.4` の既知脆弱性を指摘し、最新バージョンへのアップデートを提案している
  - △: 依存ライブラリのバージョン管理に問題があると言及しているが、multerの具体的なバージョン問題に触れていない
  - ×: 問題を検出していない

---

### P10: セキュリティ監査ログを一般アプリケーションログと混在させる設計

- **カテゴリ**: インフラ・依存関係・監査
- **深刻度**: 軽微
- **検出難易度**: hard
- **埋め込み技法**: 省略（専用の監査ログストリームと保護方針の記述なし）
- **該当箇所**: セクション8.4「監査ログ」— 「ログはアプリケーションの通常ログと同一のCloudWatch Logsストリームに出力する」
- **問題の説明**: 認証失敗・ロール変更・機密データアクセスなどのセキュリティイベントを一般アプリケーションログと同一ストリームに出力する設計は、STRIDEのRepudiation（否認）対策として不十分である。一般ログと混在させると改ざん防止・アクセス制御・保持期間の個別設定ができず、インシデント調査やコンプライアンス監査（SOC2、PCI DSS等）時に必要な証跡として機能しない可能性がある。専用の監査ログストリームと適切な保護設定が必要。
- **検出判定基準**:
  - ○: セキュリティ監査ログを一般ログと混在させる設計の問題を指摘し、専用ストリーム・改ざん防止・保持期間設定の必要性を提案している
  - △: 監査ログの設計に改善余地があると言及しているが、一般ログとの混在という具体的な問題に触れていない
  - ×: 問題を検出していない

---

## ボーナス問題リスト

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 脅威モデリング（Repudiation） | 監査ログ対象イベントに「認証失敗」と「ロール変更」が明示されていないため、STRIDEのRepudiation（否認）対策の漏れが生じている | STRIDEのRepudiationカテゴリとして認証失敗・ロール変更ログの欠落を具体的に指摘している |
| B02 | 入力検証・攻撃防御 | Stripe Webhookエンドポイント（`/api/webhooks/stripe`）での署名検証（`stripe-signature` ヘッダー検証）の設計記述がなく、改ざんされたWebhookイベントを受け入れるリスクがある | Webhook署名検証の欠如を指摘し、偽イベントによる注文ステータス不正書き換えリスクを説明している |
| B03 | 認証・認可設計 | 注文詳細API（GET /api/orders/:id）において、buyerが自分以外の注文を参照できないことを保証するアクセス制御の設計記述がない（buyer間の注文参照を防ぐ認可チェックの明示不足） | 購買者が自分の注文のみ参照できる認可チェックの設計欠如を指摘している |
| B04 | 脅威モデリング（DoS） | 商品検索APIや注文APIへのテナント別利用量制限がなく、特定テナントによる過剰リクエストが他テナントのサービス品質を低下させるリスクがある | テナントごとのAPIレート制限設計の欠如を指摘している |
| B05 | データ保護 | ファイルアップロードでS3署名付きURLを使用する設計において、アップロード完了後にバックエンドがファイルの実際のContent-TypeやMagic Bytesを検証する処理の設計が欠如している | クライアントから送信されるContent-Typeヘッダーの偽装可能性とサーバーサイドでのMIME検証の必要性を指摘している |
