# セキュリティレビュー結果: Nexamart プラットフォーム システム設計書 v1.4.0

**レビュー対象**: test-document-2.md (Nexamart プラットフォーム システム設計書 v1.4.0)
**レビューバージョン**: v001-baseline
**実行日**: 2026-02-18

---

## Critical Issues（重大）

### C-1: 本番シークレットのリポジトリ保存（8.1節）

**問題**: `config/secrets.prod.yaml` に本番環境のシークレット値を記録し、アクセス制限を設けたうえでリポジトリに含める設計となっている。

**影響**: リポジトリへのアクセス権を持つ全員（開発者・CI/CDシステム・外部コントリビューター等）がDBパスワード・JWT署名鍵・外部APIキーを取得可能になる。Gitの履歴からも永続的に参照可能となり、アクセス制限の設定ミス1件でシステム全体が危殆化する。

**対策**:
- `config/secrets.prod.yaml` をリポジトリから完全に除外し、`.gitignore` に追加する
- AWS Secrets Manager での管理を本番含む全環境で一元化する
- 参照用には AWS Secrets Manager のシークレット名・ARNの一覧（値を含まない）を管理する

---

### C-2: アクセストークンの localStorage 保存によるXSS盗取リスク（4.1節）

**問題**: アクセストークン（JWT）を `localStorage` に保存する設計となっている。

**影響**: XSS脆弱性（既存または将来発生するもの）があった場合、攻撃者のスクリプトが `localStorage` からアクセストークンを直接読み取り、正規ユーザーとしてAPIを呼び出せる。CSPが `default-src 'self'` であっても、サードパーティスクリプトの混入や依存ライブラリの脆弱性を介したXSSで悪用可能。

**影響範囲**: buyer・tenant_staff・tenant_admin のセッション全件が攻撃対象になる。

**対策**:
- アクセストークンを `HttpOnly; Secure; SameSite=Strict` Cookie に移行する
- 短命なアクセストークン（現行60分）とリフレッシュトークンの両方を Cookie に格納し、CSRFはJWT二重送信パターンまたはSameSite Cookieで対処する

---

### C-3: テナント分離のアプリケーション層単一依存（3.2節）

**問題**: テナント間データ分離を「アプリケーション層でのクエリフィルタリングのみ」で実現している。Kong が付与した `X-Tenant-ID` ヘッダーをコアAPIサービスが無条件に信頼する設計（3.2節・3.3節）。

**影響**: 以下の経路でテナント間データ漏洩が発生しうる:
1. コーディングミスによる `tenant_id` フィルタ漏れ（クエリ1件のミスで全テナントデータが露出）
2. 内部ネットワークからコアAPIサービスに直接アクセスできる場合、任意の `X-Tenant-ID` を偽装可能
3. 結合クエリやサブクエリにおける `tenant_id` 伝播ミス

**対策**:
- Row-Level Security (RLS) をPostgreSQLで有効化し、DB接続時にセッション変数 `app.tenant_id` を設定、全クエリに自動フィルタを適用する
- コアAPIサービスはゲートウェイ認証と独立してJWTの `tenantId` クレームを検証し、`X-Tenant-ID` との照合をミドルウェア層で必須化する
- コアAPIサービスをVPC内部からも直接アクセス不可にする（Security GroupでKong経由のみ許可）

---

### C-4: CORS設定の正規表現バイパスリスク（6.4節）

**問題**: CORS許可オリジンを `/\.nexamart\.com$/` の正規表現マッチで判定している。

**影響**: `evil-nexamart.com` や `attacker.com?x=nexamart.com`（一部実装でURLエンコードが通る場合）などのドメインが許可される可能性がある。`Access-Control-Allow-Credentials: true` と組み合わせているため、クロスオリジンからCookieを含むリクエストが可能になり、CSRF的な攻撃やセッションアクセスが可能になる。

**影響の深刻度**: Cookie認証との組み合わせで認証済みリクエストの偽造が可能。

**対策**:
- ホワイトリスト方式（許可ドメインの明示的な配列照合）に変更する:
  ```javascript
  const allowedOrigins = [
    'https://nexamart.com',
    'https://admin.nexamart.com',
  ];
  // サブドメインは動的に検証する場合も末尾一致ではなく完全ドメイン照合
  ```
- テナントサブドメインを許可する場合は `^https://[a-z0-9-]+\.nexamart\.com$` のように前方アンカーも付ける

---

## Significant Issues（重要）

### S-1: アクセストークン即時無効化不可（4.2節）

**問題**: アクセストークンの失効管理をトークン有効期限（60分）のみで実施し、権限変更・不正検知時のトークン即時無効化をリフレッシュトークン期限切れ（最大30日）に依存する設計。

**影響**: テナント管理者の権限を剥奪または停止した場合でも、最大60分間は有効なアクセストークンでAPIが呼び出せる。セキュリティインシデント発生時の緊急対応が不可能。

**対策**:
- Redis に短期ブラックリスト（TTL=アクセストークン有効期限）を設け、ログアウト・権限変更・アカウント停止時にJTIを追加する
- または、アクセストークン有効期限を15分以内に短縮し、リフレッシュを頻繁化する

---

### S-2: Stripe Webhookエンドポイントの署名検証記載なし（7.3節）

**問題**: `/api/webhooks/stripe` のWebhookエンドポイントに署名検証の設計が明記されていない。

**影響**: 攻撃者が任意のペイロードをWebhookエンドポイントに送信し、決済完了イベントを偽造できる。支払いなしで注文を「支払済み」に変更したり、他テナントの注文ステータスを改ざんする攻撃が可能。

**対策**:
- `stripe-signature` ヘッダーを用いたStripe署名検証（`stripe.webhooks.constructEvent()`）を必須化する設計を明記する
- Webhookエンドポイントを認証ミドルウェアの対象外とし、Stripe署名検証のみで保護する設計を明示する

---

### S-3: 認証エンドポイントのレートリミット未設計（4.4節・6節）

**問題**: ログイン（`/api/auth/login`）、ユーザー登録（`/api/auth/register`）、トークンリフレッシュ（`/api/auth/refresh`）に対するレートリミットの設計が記載されていない。

**影響**:
- ブルートフォース攻撃: パスワードを無制限に試行可能（bcrypt cost=12でも自動化攻撃で突破リスクあり）
- アカウント列挙: 登録エンドポイントへの大量試行でメールアドレスの存在確認が可能
- リフレッシュトークン乱用: 有効な refresh token を大量並列リクエストで悪用可能

**対策**:
- IPベースおよびアカウントベースのレートリミットを設計する（例: ログイン失敗5回/15分でテンポラリロック、IP単位で100req/hの上限）
- Kong ゲートウェイのRate Limitingプラグインで適用する設計を明記する

---

### S-4: multer@1.4.4 の既知脆弱性（8.2節）

**問題**: `multer@1.4.4` を使用しているが、このバージョンには複数の既知の脆弱性（ReDoS, prototype pollution等）が報告されており、最新安定版（1.4.5-lts.1以降）への更新が必要。ただし、設計書ではPresigned URL経由での直接アップロード（6.5節）が主方式とされているため、multerの実際の使用範囲が不明確。

**対策**:
- multerの使用箇所を明確化する（Presigned URLが主方式であればmulterは不要な可能性）
- 使用する場合は最新の安定版にアップデートし、脆弱性スキャンを四半期待たずに即時実施する

---

### S-5: 署名付きURL有効期限7日間（5.4節）

**問題**: 請求書・契約書類のPresigned URLの有効期限が7日間に設定されている。

**影響**: 発行されたURLがメール・Slackなどで転送・共有された場合、7日間は認証なしでアクセス可能。流出したURLが第三者に利用されるリスクが高い。

**対策**:
- 有効期限を1時間以内に短縮する（AWS S3の推奨は最短期間）
- 重要書類へのアクセスにはダウンロードリンクの再生成フローを採用し、アクセスログを記録する

---

## Moderate Issues（中程度）

### M-1: ファイルアップロードのMIME型検証がContent-Typeヘッダーのみ（6.5節）

**問題**: ファイルの種別検証を `Content-Type` ヘッダーのみで行い、ファイルマジックバイト（実際のファイル内容）の検証および拡張子検証を行っていない。

**影響**: 攻撃者がHTMLファイルや実行可能スクリプトを `Content-Type: image/jpeg` で偽装してアップロードし、S3に保存することが可能。公開バケット経由でCloudFrontから配信された場合、被害ユーザーのブラウザでスクリプトが実行されうる。

**対策**:
- アップロード後にAWS Lambda（S3イベントトリガー）でマジックバイト検証を実施する
- 許可する拡張子をホワイトリストで明示的に制限する
- 公開バケットに対してCloudFrontで `Content-Type` を強制設定するレスポンスヘッダーポリシーを適用する

---

### M-2: 監査ログの分離不足（8.4節）

**問題**: セキュリティ監査ログ（テナント操作・ユーザーデータエクスポート等）をアプリケーションの通常ログと同一のCloudWatch Logsストリームに出力する設計。また、認証失敗・ロール変更の記録が「9.4節のセキュリティ要件に従い実施」と記載されているが、9.4節には「アプリケーションログに記録する」とのみ書かれており、具体的な設計が不明確。

**影響**:
- 監査ログが通常ログに混在すると、ログ削除・改ざんの検出が困難
- ログ検索・集計コストが増加し、インシデント対応時の調査が遅延する
- 認証失敗イベントのアラート設定ができない

**対策**:
- セキュリティ監査ログ専用のCloudWatch Logsストリーム（またはS3バケット）を設け、書き込み専用アクセスで保護する
- 認証失敗イベントのCloudWatch Alarmを設定し、閾値超過時にアラートを発報する設計を明記する

---

### M-3: PII保存フィールドの平文保存（5.1節）

**問題**: 氏名・住所・電話番号などのPIIフィールドを平文で保存し、RDS暗号化のみに依存している。

**影響**: RDS TDEはデータファイルレベルの暗号化であり、DBアクセス権を持つ内部ユーザー（DBA、開発者）や、クエリを実行できる攻撃者（SQLインジェクション等）からはPIIが平文で読み取られる。マルチテナント環境では、テナント間でPIIが分離されていても、DBレベルでは全テナントのPIIにアクセス可能。

**対策**:
- メールアドレス以外の検索不要なPIIフィールド（住所・電話番号）はアプリケーション層でのフィールドレベル暗号化（AWS KMS + Envelope Encryption）を適用する
- PII暗号化の対象フィールドと除外フィールドを設計書に明示する

---

### M-4: データ保持期間・削除方針の未定義（5.3節）

**問題**: 退会申請時のPII削除フローが「今後設計する」と明記されており、現時点で未定義。

**影響**: GDPRや個人情報保護法のデータ削除要求（忘れられる権利）への対応ができない。退会ユーザーのPIIが無期限に保存される状態が発生する。

**対策**:
- 退会申請受理後のPII削除・匿名化フローを設計書に記載する（例: 90日後に自動削除、注文履歴は匿名化して保持等）
- データ保持ポリシーをPIIカテゴリごとに定義する

---

### M-5: 注文APIの認可設計の曖昧さ（7.2節）

**問題**: `GET /api/orders/:id` の権限が `buyer, tenant_admin` とされているが、buyerが自分の注文のみアクセスできることを保証する所有者確認の設計が明記されていない。また、tenant_adminが他テナントの注文に誤ってアクセスできるかの境界も不明確。

**影響**: 設計不備があれば、buyerが他のbuyerの注文詳細（個人情報・決済情報）を参照できるInsecure Direct Object Reference (IDOR)が発生しうる。

**対策**:
- APIハンドラの認可設計に「リソース所有者検証」の記載を追加する（例: 注文の `buyer_id` がJWTの `userId` と一致することを検証）
- tenant_adminは自テナントの注文のみ参照可能であることを設計書に明示する

---

## Minor Issues（軽微）

### Mi-1: KMSキーローテーション年1回（5.1節）

AWS KMSのデフォルト自動ローテーション（年1回）は最低限として許容されるが、JWT署名鍵などのアプリケーションシークレットはより頻繁なローテーション（90日ごと）を推奨する。特にJWT署名鍵のローテーション手順（旧鍵での検証継続期間、移行手順）を設計書に記載すること。

### Mi-2: セキュリティ要件7.4節の参照先不整合（8.4節）

8.4節に「認証失敗やロール変更の記録はセキュリティ要件（7.4節）に従い実施する」と記載があるが、本設計書には7.4節が存在しない。設計書の一貫性を確保するため、参照先を正しい節番号（9.4節）に修正すること。

### Mi-3: 商品更新APIのテナント所有権確認（7.1節）

`PUT /api/products/:id` および `DELETE /api/products/:id` において、操作対象商品が操作者のテナントに属することを確認する設計が明記されていない。JWTの `tenantId` とリソースの `tenant_id` の照合をハンドラ設計に明示する。

---

## Positive Aspects（良好な点）

- bcrypt（cost factor: 12）によるパスワードハッシュ化: 適切な強度設定
- クレジットカード情報のStripe委譲: PCI DSS対応の合理的な設計
- リフレッシュトークンのRedisブラックリスト管理: ログアウト時の即時無効化が可能
- Prisma ORMのパラメータ化クエリによるSQL injection対策
- DOMPurifyによるリッチテキストサニタイズ
- AWS Secrets Manager によるシークレット管理（本番シークレットのリポジトリ保存C-1を除く）
- ECSコンテナのプライベートサブネット配置とSecurity Groupによる最小権限ネットワーク設計
- ログへのPII出力禁止ポリシー

---

## Summary

| 深刻度 | 件数 | 主要項目 |
|-------|------|---------|
| Critical | 4 | 本番シークレットのリポジトリ保存、JWTのlocalStorage保存、テナント分離の単一依存、CORSバイパスリスク |
| Significant | 5 | トークン即時無効化不可、Webhook署名検証未設計、レートリミット未設計、multer脆弱性、署名付きURL長期有効 |
| Moderate | 5 | ファイルMIME検証不足、監査ログ分離不足、PII平文保存、削除ポリシー未定義、IDOR設計不備 |
| Minor | 3 | KMSローテーション、参照先不整合、商品所有権確認 |

最優先対応: C-1（シークレットリポジトリ保存）は即座にリポジトリから除去が必要。C-3（テナント分離）とC-4（CORS）はマルチテナントSaaSとして設計段階での修正が不可欠。
