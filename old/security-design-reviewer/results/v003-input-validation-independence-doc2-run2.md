# セキュリティレビュー結果

**対象**: Nexamart プラットフォーム システム設計書 v1.4.0
**レビュー日**: 2026-02-18
**プロンプトバージョン**: v003-variant-input-validation-independence

---

## Critical Issues（重大な問題）

### C-01: 本番シークレットのリポジトリ管理（機密情報漏洩リスク）

**問題**: セクション8.1に「本番環境のシークレット値はデプロイ担当者の参照用に `config/secrets.prod.yaml` へも記録し、アクセス制限を設けたうえでリポジトリに含める」と記載されている。

**なぜ危険か**: AWS Secrets Managerを使用しているにもかかわらず、平文の本番シークレットをGitリポジトリに含めることは根本的な設計上の矛盾である。リポジトリへのアクセス権限を持つすべての開発者・CI/CDシステムが本番シークレットにアクセス可能となり、内部不正・リポジトリ漏洩・CI/CDの侵害時にDBパスワード・JWT署名鍵・外部APIキーが全て流出する。

**影響範囲**: システム全体の完全侵害（データベース直接アクセス、JWT偽造、外部API悪用）

**対策**:
- `config/secrets.prod.yaml` をリポジトリから即座に削除し、git historyからも削除（`git filter-branch` または `git-secrets`）
- 本番シークレットへのアクセスは AWS Secrets Manager + IAMロールに一元化
- デプロイ担当者が参照が必要な場合はAWS Secrets Managerコンソール経由とする

---

### C-02: テナント分離の根本的欠陥（テナント間データ漏洩リスク）

**問題**: セクション3.2に「コアAPIサービスはこの値（X-Tenant-IDヘッダー）を信頼してデータアクセスの絞り込みに使用する」と記載されているが、同セクションおよび3.3に「コアAPIサービスはゲートウェイを通過したリクエストを信頼済みとして処理する」とある。

**なぜ危険か**: Kong API Gatewayがテナント識別の唯一の防御ラインとなっている。Kongの設定ミス・Kongバイパス・内部ネットワーク経由の直接アクセス・Kong侵害のいずれかが発生した場合、アプリケーション層でのテナント分離が完全に機能しなくなる。マルチテナントSaaSにおいてテナント間のデータ漏洩は最重大リスクである。

**影響範囲**: 全テナントの全データへの横断アクセス

**対策**:
- コアAPIサービス内でも、JWTクレーム（`tenantId`）とX-Tenant-IDヘッダーの照合をすべてのリクエストで実施する設計を明示
- データアクセス層（ORM/リポジトリ層）でも `tenant_id` フィルタを強制する設計を追加
- 内部通信にもmTLSまたはサービスアカウント認証を設計

---

### C-03: アクセストークンのlocalStorage保存（XSSによる全セッション侵害）

**問題**: セクション4.1に「アクセストークン: ブラウザの `localStorage` に保存」と記載されている。

**なぜ危険か**: localStorageはJavaScriptから直接アクセス可能であり、XSS脆弱性が存在する場合（またはサプライチェーン攻撃でスクリプトが注入された場合）、攻撃者はすべてのユーザーのアクセストークンを窃取できる。CSP設定（`default-src 'self'`）は基本的な保護を提供するが、依存ライブラリ経由の攻撃やCSPバイパスに対しては完全ではない。

**影響範囲**: XSS発生時の全認証セッションの侵害

**対策**:
- アクセストークンを `HttpOnly` Cookie で保存する設計に変更（リフレッシュトークンと同様）
- Cookie保存に変更した場合、CSRF対策を明示的に設計する必要がある（後述C-04参照）

---

### C-04: CSRF対策の独立性欠如（状態変更操作への攻撃リスク）

**問題**: セクション6.3に「JWTをAuthorizationヘッダーに付与することを必須とする。JWTは認証済みユーザーのみ保持できるため、CSRF対策として十分と判断する」と記載されている。

**Defense Layer Independence Assessment（防御レイヤー独立性評価）**:

この設計のCSRF対策は、以下の条件が全て成立することに依存している:
1. JWTがlocalStorageに保存されていること
2. JavaScriptが明示的にAuthorizationヘッダーを付与していること
3. XSSが存在しないこと

しかし、C-03の問題が修正され（またはその他の理由で）JWTがCookieで保存される設計に変更された場合、このCSRF対策は完全に無効化される。また現状でもCookieベースのJWT保存ライブラリ・フレームワークへの変更時に再評価が必要であることが設計書に記載されていない。

**なぜ危険か**: CSRF対策がJWTのlocalStorage保存という別の設計判断に依存しており、独立した防御レイヤーとして機能していない。設計の変更伝播時にCSRF対策が無効化されるリスクがある。さらに、リフレッシュトークンはすでにCookieで保存されており、`/api/auth/refresh` エンドポイントはCSRF攻撃の標的になりうる。

**影響範囲**: ログイン中ユーザーへのCSRF攻撃（注文作成、アカウント情報変更等）

**対策**:
- JWTの保存場所に依存しない独立したCSRF対策を設計する（Double Submit Cookie方式またはSameSite=Strict Cookie属性）
- リフレッシュトークンエンドポイントへのCSRF保護を明示的に設計
- CSRFトークンの検証をゲートウェイまたはミドルウェア層で実施する設計を追加

---

## Significant Issues（重要な問題）

### S-01: CORS設定の正規表現バイパスリスク

**問題**: セクション6.4のCORS実装で `/\.nexamart\.com$/` の正規表現を使用している。

**なぜ危険か**: `evilnexamart.com` や `attacker-nexamart.com` はこの正規表現にマッチする。`Access-Control-Allow-Credentials: true` と組み合わせることで、攻撃者が制御するサイトからクロスオリジンリクエストが認証付きで送信可能となる。

**対策**:
- 許可オリジンを明示的なホワイトリスト（配列）で管理: `['nexamart.com', '*.nexamart.com']`
- 正規表現マッチの場合は `^https://([a-z0-9-]+\.)?nexamart\.com$` のように先頭固定・スキーム指定を追加

---

### S-02: ファイルアップロードのMIME型検証の独立性欠如

**問題**: セクション6.5に「MIME型チェック: `Content-Type` ヘッダーによる判定のみ（拡張子検証なし）」と記載されている。

**Defense Layer Independence Assessment（防御レイヤー独立性評価）**:

Content-Typeヘッダーはクライアントが任意に設定可能であり、これ単独では独立した検証レイヤーとして機能しない。サーバーサイドでのファイルコンテンツ検証（マジックバイト検証）が存在しない場合、Content-Typeの検証は攻撃者によって簡単にバイパスされる。

**なぜ危険か**: 攻撃者は `Content-Type: image/jpeg` を設定したWebShell等の悪意あるファイルをアップロード可能。Presigned URLでS3に直接アップロードするためサーバーサイドの検証をバイパスできる。

**影響範囲**: 悪意あるコンテンツのS3格納、特にパブリックバケットへの格納によるコンテンツ配信攻撃

**対策**:
- Presigned URL生成時の制限に加え、S3イベントトリガーによるアップロード後検証を設計（AWS Lambdaでのマジックバイト検証・ウイルススキャン）
- 拡張子の許可リスト検証をPresigned URL生成API側で実施
- ウイルススキャン（Amazon GuardDuty Malware Protectionまたは専用ツール）の導入計画を明確化

---

### S-03: 認証エンドポイントのレートリミット未設計

**問題**: セクション4.4の認証エンドポイント（ログイン・登録・リフレッシュ）に対してレートリミットの設計が記載されていない。

**なぜ危険か**:
- `/api/auth/login`: ブルートフォース攻撃・パスワードスプレー攻撃が無制限に実行可能
- `/api/auth/register`: アカウント大量作成によるリソース枯渇
- `/api/auth/refresh`: リフレッシュトークンを用いた大量アクセストークン生成

bcrypt cost factor 12はハッシュ比較を低速化するが、並列攻撃の軽減には十分でない。

**対策**:
- Kongゲートウェイでの認証エンドポイント別レートリミット設計（例: ログイン: IPあたり10回/分）
- ログイン失敗時のアカウントロックアウトまたはCAPCHAの設計
- アカウント列挙対策（登録済みメールアドレスへのエラーメッセージ統一化）

---

### S-04: アクセストークンの即時無効化不可

**問題**: セクション4.2に「不正検知や権限変更が発生した場合のトークン即時無効化は、リフレッシュトークンの期限切れに依存する設計とする」と記載されている。

**なぜ危険か**: アクセストークンの有効期限が60分であるため、権限剥奪・アカウント停止・侵害検知後も最大60分間、侵害されたトークンは有効なままとなる。マルチテナントSaaSにおいて不正テナントまたは不正ユーザーへの対応が遅延する。

**対策**:
- アクセストークンのブロックリスト（Redis）の導入を検討
- または有効期限を15分以下に短縮しリフレッシュトークンで補完する設計
- 少なくともプラットフォーム管理者操作（テナント停止等）後のトークン即時無効化フローを設計

---

### S-05: Stripe Webhookの検証設計の明記なし

**問題**: セクション7.3にStripe Webhookエンドポイント `/api/webhooks/stripe` が記載されているが、署名検証の設計が明記されていない。

**なぜ危険か**: Stripe Webhookエンドポイントが署名検証なしで実装された場合、攻撃者がStripeになりすました偽リクエストを送信し、支払いステータスを任意に変更可能（注文の不正確定等）。

**対策**:
- `Stripe-Signature` ヘッダーのHMAC検証（`stripe.webhooks.constructEvent`）を設計に明示
- Webhookエンドポイントへの認証除外設定がある場合は特に検証の重要性を明記

---

## Moderate Issues（中程度の問題）

### M-01: 監査ログの分離と保護

**問題**: セクション8.4に「ログはアプリケーションの通常ログと同一のCloudWatch Logsストリームに出力する」と記載されている。

**なぜ危険か**: セキュリティ監査ログが通常のアプリケーションログと混在することで、インシデント調査時の証跡追跡が困難になる。また、アプリケーションバグや意図的な操作によって監査ログが希薄化されるリスクがある。

**対策**:
- 監査ログ専用のCloudWatch Logsストリームを設計
- CloudWatch Logs Insights またはSIEM連携を検討
- 監査ログへの書き込み権限を最小化（アプリケーションは書き込みのみ、削除不可）

---

### M-02: PII保持期間・削除方針の未定義

**問題**: セクション5.3に「データ保持期間・削除方針: 現時点では未定義」と記載されている。

**なぜ危険か**: 個人情報保護法・GDPRにおいて、データ主体の削除権（忘れられる権利）への対応は法的要件。退会時の削除フローが未設計のまま本番リリースすることは法的リスクとなる。

**対策**:
- データ保持期間ポリシーを設計フェーズで定義
- 退会申請時のデータ削除フロー（ソフトデリート→物理削除スケジュール）を設計
- S3上のPII含有データの削除フローも含める

---

### M-03: multer 1.4.4 の脆弱性リスク

**問題**: セクション8.2に `multer@1.4.4` の使用が記載されているが、このバージョンには既知の脆弱性（DoS）が存在する。

**なぜ危険か**: multerの古いバージョンに対するDoS攻撃リスク。ただしS3 Presigned URLへの直接アップロードを採用しているため、multerの使用箇所と影響範囲の再確認が必要。

**対策**:
- multerの最新安定版へのアップグレード、または使用箇所の確認と不要な場合は依存を除去
- 依存ライブラリ脆弱性スキャンを四半期ごとではなくCI/CDパイプラインに統合（`npm audit` / Dependabot）

---

### M-04: KMSキーローテーション周期

**問題**: セクション5.1に「ローテーション周期: 年1回」と記載されている。

**なぜ危険か**: 年1回のKMSキーローテーションは、長期間のキー露出リスクを増大させる。マーケットプレイスで扱われる決済関連データ（注文情報等）の機密性を考慮すると、より短いローテーション周期が望ましい。

**対策**:
- KMSキーローテーションを四半期（90日）に短縮することを検討
- JWT署名鍵のローテーション方針も別途設計

---

## Positive Aspects（良好な設計）

- **SQLインジェクション対策**: Prisma ORMのパラメータ化クエリを明示的に採用（P-01）
- **パスワードハッシュ化**: bcrypt cost factor 12は適切な設定（P-02）
- **リフレッシュトークン管理**: HttpOnly Cookie保存とサーバーサイドブラックリスト（P-03）
- **シークレット管理**: AWS Secrets Managerの採用（`config/secrets.prod.yaml` の問題を除く）（P-04）
- **内部ネットワーク分離**: プライベートサブネット配置とSecurity Groupによる最小権限（P-05）
- **クレジットカード情報のスコープ外**: Stripe委譲によりPCIスコープを縮小（P-06）
- **XSS対策の多層設計**: JSX自動エスケープ + CSP + DOMPurifyの組み合わせ（P-07）
- **バックエンド入力検証**: Zodスキーマによる全リクエストパラメータ検証（P-08）

---

## サマリー

| 重大度 | 件数 | 主要リスク |
|--------|------|-----------|
| Critical | 4 | シークレット漏洩、テナント分離欠陥、XSS経由トークン窃取、CSRF対策の独立性欠如 |
| Significant | 5 | CORS正規表現バイパス、ファイルアップロード検証不足、レートリミット未設計、トークン即時無効化不可、Webhook検証未明記 |
| Moderate | 4 | 監査ログ分離、PII削除方針未定義、multer脆弱性、KMSローテーション周期 |

**最優先対応**: C-01（本番シークレットリポジトリ管理）およびC-02（テナント分離欠陥）は即時対応が必要。これらは単一のミスがシステム全体の侵害に直結する。

**Defense Layer Independence Assessment 総評**: 本設計書においてCSRF対策（C-04）とファイルアップロードMIME検証（S-02）は防御レイヤーの独立性が欠如しており、他の設計判断への依存により無効化されるリスクがある。各防御レイヤーは他のレイヤーの正常動作を前提とせず独立して機能するよう再設計する必要がある。
