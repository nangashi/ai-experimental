# Security Design Review: MediConnect システム設計書

## Critical Issues

### [CRITICAL] P07: PIIおよび医療機密情報の平文保存 — RDS暗号化(TDE)のみでは不十分

**対象セクション:** 6.2 保存データの暗号化

**問題の詳細:**

設計書6.2節に「診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している」と明記されている。

しかしRDS TDE（透過的暗号化）はストレージ層の暗号化であり、**有効なデータベース認証情報を持つユーザーに対して論理的アクセスを保護しない**。具体的に言えば：

- SQLクエリを実行できるDBアカウントを持つ内部攻撃者（不正アクセスした開発者・DBA）は、RDS暗号化が有効であってもPIIや診断内容を平文で読み取れる
- SQLインジェクション攻撃が成立した場合、攻撃者はアプリケーションの認証をバイパスしてDBへ直接クエリを投げるが、TDEはこの読み取りを防げない
- 不正アクセスされたRDSエンドポイント（パスワード漏洩、IAM設定ミス等）からのデータ流出を防げない

本システムのpatientsテーブルには氏名、生年月日、電話番号、メールアドレス、保険証番号といった高感度PIIが、medical_recordsテーブルには診断内容・SOAPノートが平文カラムとして格納される設計になっている。これらは日本の医療情報ガイドライン（厚生労働省）が準拠要件として求める保護対象である。

**リスクの影響:**

- 内部犯行・不正DBアクセスによる大規模なPII漏洩
- 医療情報ガイドライン違反（行政指導・業務停止処分の可能性）
- 患者の医療プライバシー侵害

**推奨対策:**

1. **フィールドレベル暗号化（Field-Level Encryption）**: `full_name`、`date_of_birth`、`phone_number`、`email`、`insurance_number`、`diagnosis`、`soap_note` の各カラムにアプリケーション層での暗号化を適用する（AES-256-GCM推奨）
2. **鍵管理**: 暗号鍵はAWS KMSで管理し、アプリケーションはKMSエンドポイント経由でデータキーを取得する（Envelope Encryption方式）
3. **最低限の対応として**: 保険証番号・氏名・診断内容の3カテゴリに絞ってフィールドレベル暗号化を先行実装する

---

### [CRITICAL] P01: localStorageへのJWTアクセストークン保存によるXSS脆弱性

**対象セクション:** 5.1 認証フロー（手順4）

**問題の詳細:**

「クライアントはアクセストークンをlocalStorageに保存し」との記述がある。localStorageはJavaScriptから読み取り可能であるため、XSS攻撃が成立した場合にアクセストークンが盗取される。医療システムという高感度データを扱う環境でこのリスクは許容できない。

**推奨対策:**

- アクセストークンを`HttpOnly; Secure; SameSite=Strict`属性付きCookieに保存する
- またはメモリ内（変数）のみに保持し、ページリロード時はリフレッシュトークンで再取得する

---

### [CRITICAL] P02: doctorロールによる全患者データへの無制限アクセス

**対象セクション:** 5.2 認可モデル

**問題の詳細:**

「doctorロールはpatient_idパラメータによるフィルタリングなしにpatient-serviceの全患者データを参照できる設計」と明記されている。マルチテナント医療システムにおいて、担当外患者の記録へアクセスできる設計は最小権限原則に反し、内部からの不正閲覧を防止できない。

**リスクの影響:**

- 担当外患者の医療情報への無制限参照
- HIPAA（海外展開時）および医療情報ガイドライン違反
- 内部不正による患者プライバシー侵害

**推奨対策:**

- 診療担当関係テーブル（doctor_patient_assignments等）を定義し、担当患者のみアクセス許可するABACまたはリソースベースの認可設計を追加する
- `GET /api/v1/patients/{id}` では患者の担当医師リストとリクエスト元doctor_idを照合する

---

## Significant Issues

### [HIGH] P03: VPC内部通信の平文化

**対象セクション:** 6.1 通信の暗号化

**問題の詳細:**

「VPC内部の通信については内部ネットワークであるため平文で行う」とある。ECS Fargate上のapplication-service群からRDS・Redisへの通信が暗号化されない。VPC内部でもネットワーク盗聴（AWSアカウント侵害後のパケットキャプチャ、ミスコンフィグしたセキュリティグループ経由の横断移動）の可能性はある。医療データの機密性を考慮すると内部通信にもTLSを適用すべきである。

**推奨対策:**

- RDS接続: SSL/TLS強制（`sslmode=require`またはverify-full）
- Redisへの通信: Redis 6以降のTLS対応を有効化
- ECS→ECS（マイクロサービス間）: App Mesh / mTLS、またはHTTPS強制

---

### [HIGH] P04: CORS設定のワイルドカード（`Access-Control-Allow-Origin: *`）

**対象セクション:** 7.3 CORS設定

**問題の詳細:**

「開発効率を優先するため`Access-Control-Allow-Origin: *`を設定する。本番環境では必要に応じて絞り込みを検討する」とある。設計フェーズで本番用の許可オリジンが未定義のままでは、そのまま本番デプロイされるリスクが高い。ワイルドカードCORSはCookieベース認証と組み合わせた攻撃（CSRF的な流用）を容易にする。

**推奨対策:**

- 設計書に本番環境の許可オリジンを明示的に定義する（例: `https://app.mediconnect.jp`）
- 認証情報を含むリクエストに対してはワイルドカードは使用できない（仕様上`Access-Control-Allow-Credentials: true`との組み合わせ不可）ことを設計に明示する

---

### [HIGH] P05: 認証エンドポイントへのレート制限なし

**対象セクション:** 8.5 認証エンドポイント保護

**問題の詳細:**

「`/api/v1/auth/login`エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計」とある。医療システムのログインエンドポイントをブルートフォース攻撃から無防備にする設計は重大な認証リスクを生む。また同様に`/api/v1/auth/refresh`トークンリフレッシュエンドポイントへの乱用防止設計も見当たらない。

**推奨対策:**

- API GatewayまたはWAFによるIPベースのレート制限を設計に明記する（例: ログイン失敗5回/15分でIPブロック）
- アカウントロック機能の「別途検討」は具体的な検討期限・担当を設計書に記載する
- `/api/v1/auth/refresh`にも同様のレート制限を設計する

---

### [HIGH] P06: CSRF保護の設計が欠落

**対象セクション:** 7.4 セッション系APIの保護

**問題の詳細:**

「処方箋発行・患者情報更新などのstate-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外」とある。処方箋発行（`POST /api/v1/prescriptions`）はCSRF攻撃の標的として高リスクである。医師がCSRF誘導ページを踏んだ場合、悪意ある処方箋が発行される可能性がある。

**推奨対策:**

- CSRFトークン（synchronizer tokenパターン）またはSameSite=Strict Cookie属性を設計に明記する
- state-changing操作のCSRF保護はリリース前必須要件として設計書に明示する

---

## Moderate Issues

### [MEDIUM] P08: PIIを含むログ出力の管理方針が未定義

**対象セクション:** 6.3 個人情報の取り扱い

**問題の詳細:**

「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用」とある。エンジニアの個人判断に委ねる運用は、医療PIIがCloudWatch Logsに平文で出力されるリスクを常態化させる。ログはセキュリティ要件上PIIのマスク・除外が必要である。

**推奨対策:**

- ロギングポリシーを設計書に明記する: PII（氏名、保険証番号、診断内容）はログ出力禁止、UUIDのみ記録
- ログ出力ライブラリへのフィルター実装を設計の一部として定義する
- CloudWatch Logsへのアクセス制御ポリシーを設計に含める

---

### [MEDIUM] P09: ファイルアップロードのバリデーション仕様が未定義

**対象セクション:** 7.2 ファイルアップロード

**問題の詳細:**

「ファイル種別・サイズの制限は実装フェーズで決定する」とある。ウイルススキャンの実施は記載されているが、許可ファイル種別（MIME type allowlist）と最大サイズ上限が設計フェーズで未定義のまま実装に委ねられている。

**推奨対策:**

- 設計書に許可するファイル種別（例: `image/jpeg`, `image/png`, `application/pdf`）と最大サイズ（例: 20MB）を明記する
- S3保存時のオブジェクトキー設計（ランダムUUID使用、元ファイル名を使わない）も設計に含める

---

### [MEDIUM] P10: サードパーティ依存関係の脆弱性管理方針が未定義

**対象セクション:** 8.2 サードパーティ依存関係

**問題の詳細:**

「脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定」とある。Twilio Video SDK v2.27.0など特定バージョンを固定する設計方針は、既知脆弱性対応を遅延させるリスクがある。

**推奨対策:**

- Dependabot / Snyk等による自動脆弱性スキャンをCI/CDパイプラインに組み込む設計を明記する
- 重大度CriticalまたはHighの脆弱性は発見後X営業日以内に対応するSLAを設計書に記載する

---

## Minor Notes

### [LOW] 監査ログの対象範囲が不明確

**対象セクション:** 8.3 監査ログ

設計書は「操作ユーザーID、操作種別、タイムスタンプ」をログに含めると記載しているが、医療システムとして特に重要な以下の操作が明示的に対象とされていない: 患者データ参照、診療記録作成、処方箋発行、認証失敗、権限変更。これらを監査ログの必須対象として明記することを推奨する。

### [LOW] リフレッシュトークンのセキュリティ設計が不完全

**対象セクション:** 5.3 セッション管理

リフレッシュトークンをRedisに保存しユーザーIDをキーとする設計では、同一ユーザーの複数デバイスセッションが同じキーを上書きする可能性がある。また、トークンローテーション（リフレッシュトークン使用後に新しいトークンを発行し古いトークンを無効化する）の設計が明記されていない。

### [POSITIVE] 適切な設計

- bcryptコスト係数12による適切なパスワードハッシュ設計
- AWS Secrets ManagerによるシークレットのVault管理
- RDSおよびRedisのプライベートサブネット配置
- マルチスキーマ方式によるテナントデータ分離
- JWTトークンへのtenant_idクレーム付与によるテナント識別

---

## Summary

| 深刻度 | 件数 | 主な問題 |
|--------|------|----------|
| Critical | 3 | PII平文保存(TDE限界)、JWTのlocalStorage保存、doctorロールの無制限アクセス |
| High | 4 | 内部通信平文、CORSワイルドカード、レート制限なし、CSRF設計欠落 |
| Medium | 3 | PIIログ管理未定義、ファイルバリデーション未定義、依存関係管理未定義 |
| Low | 2 | 監査ログ対象範囲、リフレッシュトークン設計 |

最優先で対処すべき問題はPIIのアプリケーション層暗号化（P07）とJWTストレージ（P01）、doctorロールの認可設計（P02）の3点である。本システムは日本の医療情報ガイドライン準拠を要件としており、PIIおよび医療機密情報の適切な保護は設計段階での必須要件である。
