# Security Design Review: Nexamart プラットフォーム システム設計書

**Reviewer Prompt**: v004-variant-pii-logical-access
**Test Document**: test-document-2.md (Nexamart v1.4.0)
**Run**: 1

---

## CRITICAL ISSUES

### [CRITICAL-1] PIIの平文保存とRDS TDE依存による論理アクセス保護の欠如

**該当箇所**: セクション 5.1「保存データの暗号化」

**問題の詳細**:
設計書は「氏名・住所・電話番号などの個人情報は平文で保存する。RDS暗号化により保護されているため、フィールドレベルでの追加暗号化は不要」と明示している。しかし、RDS TDE（Transparent Data Encryption）はストレージ層の暗号化であり、有効なデータベース認証情報を持つユーザーからの論理アクセスに対しては保護を提供しない。

**影響範囲と攻撃シナリオ**:
- **内部脅威**: DBアクセス権を持つ内部攻撃者（DBA、開発者）はTDE保護を迂回してPII全件を平文で参照できる
- **SQLインジェクション経由の漏洩**: SQLインジェクション攻撃が成功した場合（Prisma ORMの使用により軽減されているが完全排除ではない）、TDEはデータの漏洩を防げない
- **DBアカウント侵害**: DBパスワードがAWS Secrets Managerで管理されているが、侵害された場合にPII全件が平文で露出する
- **マルチテナント環境のリスク**: 本システムはマルチテナント構成で全テナントが同一インフラを共有する。アプリケーション層のテナント分離（tenant_idフィルタリング）が唯一の防御線であり、バイパスされた場合に全テナントのPIIが露出する

**なぜ危険か**:
TDEはディスク盗難やストレージスナップショット不正取得に対して有効だが、正規のDBセッションを通じたアクセスには無力である。氏名・住所・電話番号・メールアドレスを平文で保存するデータベースにSQLインジェクション、内部攻撃、または侵害されたDBアカウントでアクセスすると、データ保護レイヤーが存在しないため全PIIが即座に漏洩する。

**推奨対策**:
1. **フィールドレベル暗号化の導入**: 氏名、住所、電話番号等の高感度PIIに対してアプリケーション層での暗号化（例: AWS KMSを用いたエンベロープ暗号化、PostgreSQL pgcrypto等）を設計する
2. **暗号化対象フィールドの明示**: 設計書にて暗号化する列、使用するアルゴリズム、鍵管理方針を明示する
3. **最小権限DBアクセス**: サービスごとにDBロールを分離し、PIIフィールドへのアクセスを必要なサービスのみに制限する

---

### [CRITICAL-2] 本番シークレットのリポジトリ管理

**該当箇所**: セクション 8.1「シークレット管理」

**問題の詳細**:
「本番環境のシークレット値はデプロイ担当者の参照用に `config/secrets.prod.yaml` へも記録し、アクセス制限を設けたうえでリポジトリに含める」と記載されている。

**影響範囲**:
DBパスワード・外部APIキー・JWT署名鍵がGitリポジトリに含まれることになる。Gitの性質上、一度コミットされたシークレットは履歴として永続的に残る。リポジトリへのアクセス権（開発者権限、CIシステム）を持つ者全員に本番シークレットが露出する。

**なぜ危険か**:
AWS Secrets Managerを使用しているにもかかわらず、バイパスする形でシークレットをリポジトリに保存することは、Secrets Managerを導入したセキュリティ効果を完全に無効化する。リポジトリへのコード読み取り権限があれば認証なしでシークレットに到達できる。

**推奨対策**:
1. `config/secrets.prod.yaml` のリポジトリ管理を中止し、Secrets Managerを唯一の本番シークレット管理源とする
2. デプロイ担当者がシークレットを参照する必要がある場合はAWS Secrets Manager コンソール/CLIへのIAMアクセスを提供する
3. 既存ファイルがリポジトリに追加された場合はgit-filter-repoで履歴から削除する

---

## SIGNIFICANT ISSUES

### [SIGNIFICANT-1] アクセストークンのlocalStorage保存によるXSS脆弱性

**該当箇所**: セクション 4.1「認証フロー」— トークン保存場所

**問題の詳細**:
JWTアクセストークンを `localStorage` に保存する設計は、XSS攻撃による認証情報窃取リスクを生む。攻撃者がXSSを成功させた場合、JavaScriptから `localStorage` に直接アクセスしてトークンを窃取できる。

**影響**: XSS経由でアカウント乗っ取りが可能になる。本設計では60分のアクセストークンを払い出すため、攻撃後60分間はサーバー側無効化も困難（後述）。

**推奨対策**:
アクセストークンも `HttpOnly` Cookie で管理する。JWTが必要な場合はBFF（Backend for Frontend）パターンでサーバー側セッションとして管理する方式を検討する。

---

### [SIGNIFICANT-2] アクセストークンの即時無効化不能設計

**該当箇所**: セクション 4.2「セッション管理」

**問題の詳細**:
「不正検知や権限変更が発生した場合のトークン即時無効化は、リフレッシュトークンの期限切れに依存する」と明示されている。アクセストークンは60分間有効であり、この間は不正アクセスを検知しても強制失効できない。

**影響**: ロール変更・アカウント停止後も最大60分間、旧アクセス権でAPIアクセスが継続できる。テナント停止操作の即時効果がない。

**推奨対策**:
Redisにアクセストークンのブロックリスト（JTI: JWT ID）を維持し、即時無効化を可能にする設計を追加する。または有効期限を5〜15分程度に短縮してリスクを軽減する。

---

### [SIGNIFICANT-3] CORS設定の正規表現による誤マッチリスク

**該当箇所**: セクション 6.4「CORS設定」

**問題の詳細**:
`/\.nexamart\.com$/` の正規表現パターンは `evil.nexamart.com` を許可するが、`evilnexamart.com` など `nexamart.com` を末尾に含む任意のドメインも許可してしまうリスクがある。また、`Access-Control-Allow-Credentials: true` が設定されており、クロスオリジンリクエストで認証情報（Cookie）が送信される。

**推奨対策**:
許可するサブドメインのホワイトリストを明示的に定義する（例: `api.nexamart.com`, `admin.nexamart.com`, `*.nexamart.com` は厳密に第一レベルサブドメインのみ許可）。正規表現マッチを避け、完全一致リストで検証する。

---

### [SIGNIFICANT-4] StripeWebhookエンドポイントの署名検証未記載

**該当箇所**: セクション 7.3「外部サービス連携」

**問題の詳細**:
`/api/webhooks/stripe` にてStripeイベントを受信するが、Stripe-Signature ヘッダーによるWebhook署名検証の設計が明示されていない。

**影響**: 署名検証がない場合、任意の第三者が支払いステータス変更リクエストを偽造できる。注文の不正な「支払い済み」状態への変更が可能になる。

**推奨対策**:
Stripe公式のWebhook署名検証（`stripe.webhooks.constructEvent`）を実施することを設計書に明記する。

---

### [SIGNIFICANT-5] 認証エンドポイントのレートリミット未設計

**該当箇所**: セクション 4.4「認証エンドポイント」

**問題の詳細**:
ログイン（`/api/auth/login`）、パスワードリセット、リフレッシュトークン（`/api/auth/refresh`）エンドポイントに対するレートリミット設計が記載されていない。

**影響**: ブルートフォース攻撃、クレデンシャルスタッフィング攻撃に対する防御がない。リフレッシュトークンエンドポイントへの大量リクエストによるトークン更新の乱用も考えられる。

**推奨対策**:
KongゲートウェイまたはアプリケーションレベルでIPアドレス・アカウント単位のレートリミットを設計する（例: ログイン失敗5回でアカウントロックまたは指数バックオフ）。

---

## MODERATE ISSUES

### [MODERATE-1] PIIデータ保持期間・削除方針の未定義

**該当箇所**: セクション 5.3「個人情報（PII）管理」

**問題の詳細**:
「データ保持期間・削除方針は現時点では未定義。退会申請があった場合の対応フローは今後設計する」と記載されている。

**影響**: GDPRやPIPA等のプライバシー規制への非準拠リスク。退会ユーザーのデータが無期限に保存され続ける可能性がある。

**推奨対策**:
本番稼働前にデータ保持ポリシー（最大保持期間、退会時削除フロー、削除方式）を設計書に定義する。

---

### [MODERATE-2] ファイルアップロードのMIMEタイプ検証不足

**該当箇所**: セクション 6.5「ファイルアップロード」

**問題の詳細**:
「MIME型チェック: `Content-Type` ヘッダーによる判定のみ（拡張子検証なし）」と記載されている。`Content-Type` ヘッダーはクライアントが自由に設定できるため、悪意あるファイル（スクリプト、実行ファイル）のアップロードを防げない。

**影響**: Presigned URL経由でのアップロードのため、サーバー側での事後検証が必要。悪意あるファイルがS3に保存され、CloudFront経由で配信される可能性がある。

**推奨対策**:
1. ファイルのマジックバイト（ファイル先頭バイト列）によるコンテンツ検証を実施する
2. 拡張子の許可リスト検証を追加する
3. S3にアップロードされたファイルをAmazon Inspectorまたはサードパーティのウイルススキャンで検証するフローを設計する

---

### [MODERATE-3] multer@1.4.4の既知脆弱性

**該当箇所**: セクション 8.2「依存ライブラリ管理」

**問題の詳細**:
`multer@1.4.4` は既知のセキュリティ問題を含むバージョンである可能性がある。依存ライブラリの脆弱性スキャンが四半期ごとと記載されており、発見から適用まで最大3か月のウィンドウが存在する。

**推奨対策**:
最新の安定版への更新を確認する。セキュリティスキャン（`npm audit`）をCI/CDパイプラインに組み込み、クリティカル脆弱性は即日対応フローを設計する。

---

### [MODERATE-4] テナント分離の単一防御線リスク

**該当箇所**: セクション 3.2「マルチテナント分離方式」

**問題の詳細**:
テナントデータ分離はアプリケーション層の `tenant_id` クエリフィルタリングのみに依存している。「コアAPIサービスはゲートウェイを通過したリクエストを信頼済みとして処理する」という設計により、ゲートウェイバイパスまたはアプリケーションバグが他テナントデータへの直接アクセスにつながる。

**影響**: SQLインジェクション成功またはアプリケーションロジックバグにより、全テナントのデータが漏洩するリスクがある。

**推奨対策**:
Row Level Security (RLS) をPostgreSQL側で設定し、アプリケーション層のフィルタリングに加えてDB層でもテナント分離を強制する二重防御を設計する。

---

### [MODERATE-5] 監査ログの分離不足

**該当箇所**: セクション 8.4「監査ログ」

**問題の詳細**:
「ログはアプリケーションの通常ログと同一のCloudWatch Logsストリームに出力する」と記載されている。セキュリティ監査ログとアプリケーションログが混在すると、改ざん検知・インシデント調査・コンプライアンス報告が困難になる。

**推奨対策**:
セキュリティイベントログ（認証失敗、権限変更、PII操作）を専用のCloudWatch LogsストリームまたはSIEMに分離し、保存期間・アクセス制御を別途設定する。

---

## MINOR IMPROVEMENTS

### [MINOR-1] S3署名付きURLの有効期限（7日）が長すぎる

**該当箇所**: セクション 5.4「S3ストレージセキュリティ」

請求書・契約書類の署名付きURLは有効期限7日と記載されている。URLが漏洩した場合の露出ウィンドウが長い。用途に応じて15〜60分程度に短縮することを検討する。

---

### [MINOR-2] JWT署名アルゴリズムの明示なし

**該当箇所**: セクション 4.1「認証フロー」

JWTに使用する署名アルゴリズム（RS256推奨、HS256の場合は鍵管理方針）が明示されていない。`jsonwebtoken@9.0.0` 使用時はアルゴリズムの明示指定を設計書に記載する。

---

### [MINOR-3] セキュリティ要件7.4節への参照が存在しない

**該当箇所**: セクション 8.4「監査ログ」

「認証失敗やロール変更の記録はセキュリティ要件（7.4節）に従い実施する」と記載されているが、設計書に7.4節は存在しない（7.3節が最終）。参照整合性の誤りであり、設計書の信頼性に影響する。

---

## POSITIVE ASPECTS

- **HTTPS強制**: 全通信でTLS 1.2以上を強制しており、転送時の保護は適切に設計されている
- **bcrypt使用**: cost factor 12のbcryptによるパスワードハッシュ化は適切である
- **クレジットカード非保持**: Stripeへの委譲によりPCI DSS対象範囲を最小化している
- **Zodによる入力検証**: Zodスキーマによる全パラメータ検証でインジェクション対策の基礎が整っている
- **Prisma ORMの使用**: パラメータ化クエリによるSQLインジェクション対策が組み込まれている
- **RefreshToken HttpOnly Cookie**: リフレッシュトークンのHttpOnly Cookie管理は適切である
- **Secrets Manager使用**: AWS Secrets Managerによるシークレット管理の方針は適切（ただしconfig/secrets.prod.yamlとの矛盾あり、CRITICAL-2参照）

---

## SUMMARY

| 深刻度 | 件数 | 主要項目 |
|--------|------|----------|
| Critical | 2 | PII平文保存(TDE限界)、本番シークレットのリポジトリ管理 |
| Significant | 5 | localStorage/JWT無効化/CORS/Stripe署名/レートリミット |
| Moderate | 5 | PII削除方針/ファイル検証/multer脆弱性/テナント分離/監査ログ分離 |
| Minor | 3 | 署名付きURL期限/JWTアルゴリズム/参照整合性 |

最優先対応事項はCRITICAL-1（PIIフィールドレベル暗号化の設計）とCRITICAL-2（本番シークレットのリポジトリ除外）である。特にCRITICAL-1は、設計書が「RDS TDEで十分」と明示的に判断しているが、TDE保護対象外の論理アクセス（内部攻撃者、SQLインジェクション、侵害DBアカウント）に対してPIIが無防備であるため、マルチテナント環境における全テナントPII漏洩の潜在リスクを持つ。
