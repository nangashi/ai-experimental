# セキュリティ設計レビュー: Nexamart プラットフォーム システム設計書 v1.4.0

## エグゼクティブサマリー

本設計書にはいくつかの重大なセキュリティ問題が含まれており、特にCORS設定の正規表現バイパス脆弱性、シークレット情報のリポジトリへの保存、アクセストークンのXSS露出リスクは早急な対応が必要である。

---

## 重大な問題

### [CRITICAL-01] CORS正規表現サフィックスマッチによる任意オリジン許可バイパス

**設計箇所**: セクション 6.4 CORS設定

**問題の詳細**:
設計書では以下の実装が示されている:

```javascript
const allowedOrigin = /\.nexamart\.com$/;
if (allowedOrigin.test(origin)) {
  reply.header('Access-Control-Allow-Origin', origin);
  reply.header('Access-Control-Allow-Credentials', 'true');
}
```

この正規表現 `/\.nexamart\.com$/` はサフィックスマッチ（末尾一致）を行うが、`evilnexamart.com` や `attacker-nexamart.com` のように **`.nexamart.com` で終わるすべての文字列** にマッチする。

具体的な攻撃シナリオ:
- 攻撃者が `evil.nexamart.com` というドメインを取得（またはサブドメインテイクオーバーを悪用）すると、そのオリジンはマッチ判定を通過する
- `Access-Control-Allow-Credentials: true` が付与されているため、攻撃者のサイトからのリクエストでも認証済みCookieが送信される
- さらに、`evilnexamart.com`（サードパーティドメイン）も正規表現 `/\.nexamart\.com$/` にはマッチしない（`\.` がリテラルのドット）が、`evil.nexamart.com` は完全にマッチする
- より正確には: `attacker.evil.nexamart.com` のような任意のサブドメインも許可されてしまう

**危険な構文の特定**:
- `$` アンカーによるサフィックスマッチ: ドメイン名の末尾一致のみを検証するため、攻撃者が `.nexamart.com` で終わる任意のドメインを制御すれば認証情報付きクロスオリジンリクエストが可能になる
- `Access-Control-Allow-Credentials: true` との組み合わせ: オリジン許可とCredentials送信の組み合わせにより、認証済みセッションへのクロスオリジンアクセスが可能になる

**影響**:
- 攻撃者制御のサイトから被害者のブラウザ経由でAPIリクエストを実行可能
- 認証済みユーザーの注文情報、個人情報、テナントデータへの不正アクセス
- マルチテナント環境のため、テナント間データ漏洩にも波及する可能性

**推奨対策**:
許可オリジンを完全一致する許可リストで管理する:

```javascript
const ALLOWED_ORIGINS = new Set([
  'https://nexamart.com',
  'https://www.nexamart.com',
  'https://admin.nexamart.com',
]);
// テナントサブドメインは動的に許可リストへ追加（DBから取得した登録済みテナントスラッグのみ）
if (ALLOWED_ORIGINS.has(origin) || isRegisteredTenantSubdomain(origin)) {
  reply.header('Access-Control-Allow-Origin', origin);
  reply.header('Access-Control-Allow-Credentials', 'true');
}
```

---

### [CRITICAL-02] 本番シークレットのリポジトリへの保存

**設計箇所**: セクション 8.1 シークレット管理

**問題の詳細**:
設計書に以下の記述がある:
> 本番環境のシークレット値はデプロイ担当者の参照用に `config/secrets.prod.yaml` へも記録し、アクセス制限を設けたうえでリポジトリに含める

Gitリポジトリに本番シークレット（DBパスワード、JWT署名鍵、外部APIキー等）を保存することは、以下の理由から重大なリスクである:
- リポジトリへのアクセス権を持つすべての開発者・CI/CDシステムが本番シークレットを参照可能
- リポジトリの誤公開・漏洩時に全シークレットが即座に漏洩
- Gitの履歴にシークレットが残り、削除後も取得可能
- アクセス制限の実装・運用ミスが直接的なシークレット漏洩につながる

AWS Secrets Manager（設計書に既に導入されている）が存在するにもかかわらず、冗長にリポジトリへも保存する設計は矛盾している。

**影響**:
- JWT署名鍵の漏洩により、任意のユーザーになりすましたトークンの偽造が可能
- DBパスワードの漏洩により、全テナントの全データへの直接アクセスが可能

**推奨対策**:
- `config/secrets.prod.yaml` のリポジトリへの追加を廃止する
- デプロイ担当者のシークレット参照はAWS Secrets Manager ConsoleまたはCLI経由に統一する
- リポジトリに既にコミットされている場合はGit履歴からも完全に除去し、全シークレットをローテーションする

---

### [CRITICAL-03] アクセストークンのlocalStorage保存によるXSS脆弱性

**設計箇所**: セクション 4.1 認証フロー

**問題の詳細**:
設計書では:
> アクセストークン: ブラウザの `localStorage` に保存

`localStorage` に保存されたJWTアクセストークンは、XSS（クロスサイトスクリプティング）攻撃により読み取り可能である。XSS脆弱性が1箇所でも存在すれば、攻撃者はJavaScriptで `localStorage.getItem('token')` を実行してトークンを窃取できる。

本設計書ではCSP (`default-src 'self'`) やDOMPurifyによるXSS対策が施されているが、対策が完全でない場合や第三者ライブラリの脆弱性が存在する場合のリスクは排除できない。

リフレッシュトークンは `HttpOnly` Cookieで保護されているが、アクセストークン（有効期限60分）が窃取された場合、その期間中は不正アクセスが可能である。

**影響**:
- XSS成立時にアクセストークンを窃取され、60分間の認証済みAPIアクセスが可能
- マルチテナント環境では、窃取したテナント管理者トークンにより自テナントデータの全アクセスが可能

**推奨対策**:
- アクセストークンも `HttpOnly` Cookieで保存し、JavaScriptからアクセス不能にする
- CSRFリスクはSameSite=Strict/LaxまたはCSRFトークンで対応する
- アクセストークンの有効期限を短縮（例: 15分）し、窃取時の影響を限定する

---

## 重要な問題

### [HIGH-01] CSRF対策の単一層依存（JWT単独依存）

**設計箇所**: セクション 6.3 CSRF対策

**問題の詳細**:
設計書では「JWTをAuthorizationヘッダーに付与することでCSRF対策として十分」と判断しているが、これは特定の条件下でのみ有効である。

しかし本設計では:
- アクセストークンを `localStorage` に保存しJavaScriptで付与するフロー（CSRF耐性あり）
- と、Cookie保存のリフレッシュトークンを使用する `/api/auth/refresh` エンドポイントが混在する

`/api/auth/refresh` はCookieを使用してリフレッシュトークンを送信するため、CSRF攻撃に対して脆弱な設計となる可能性がある。JWT認証がないリフレッシュエンドポイントにCSRF攻撃が成立すれば、新しいアクセストークンを攻撃者が取得できる。

また、[CRITICAL-03]でアクセストークンをHttpOnly Cookieへ移行した場合、全APIエンドポイントでCSRF対策（CSRFトークンまたはSameSite属性）が必要となる。

**推奨対策**:
- `/api/auth/refresh` に対してCSRFトークンまたはSameSite=Strict Cookie設定を明示的に設計する
- 全Cookieに`SameSite=Strict`または`SameSite=Lax`を付与する設計を追加する

---

### [HIGH-02] アクセストークンの即時無効化不可

**設計箇所**: セクション 4.2 セッション管理

**問題の詳細**:
設計書では:
> 不正検知や権限変更が発生した場合のトークン即時無効化は、リフレッシュトークンの期限切れに依存する設計とする

アクセストークンは有効期限（60分）のみで管理され、サーバーサイドの無効化機能がない。これは以下のシナリオで重大なリスクとなる:
- テナントスタッフが不正行為を行い、管理者が権限を剥奪しても60分間はAPIアクセスが継続可能
- アカウント侵害が検知されてもトークンを即座に無効化できない
- ロール変更（`tenant_staff` → `tenant_admin`の剥奪等）が即座に反映されない

**推奨対策**:
- Redisにアクセストークンのブロックリストを維持し、権限変更・不正検知時に即座に無効化する
- またはアクセストークンの有効期限を大幅に短縮（5〜15分）し、影響時間を限定する

---

### [HIGH-03] 認証エンドポイントのレートリミット設計欠如

**設計箇所**: セクション 4.4 認証エンドポイント

**問題の詳細**:
ログイン（`POST /api/auth/login`）、パスワードリセット、トークンリフレッシュ（`POST /api/auth/refresh`）エンドポイントに対するレートリミット設計が明示されていない。

レートリミットなしの認証エンドポイントはブルートフォース攻撃・クレデンシャルスタッフィング攻撃に脆弱である。マルチテナント型プラットフォームでは、単一の認証エンドポイントが全テナントの認証を処理するため、攻撃の影響範囲が広い。

**推奨対策**:
- `/api/auth/login`: IPアドレスごとに一定時間内のリクエスト数制限（例: 10回/分）
- 連続失敗時のアカウントロックアウトまたはCAPCHAチャレンジ設計を追加する
- `/api/auth/refresh`: トークン単位のレートリミットを設計する

---

### [HIGH-04] Webhook署名検証の設計欠如

**設計箇所**: セクション 7.3 外部サービス連携

**問題の詳細**:
Stripe Webhook（`/api/webhooks/stripe`）の設計において、Stripe署名ヘッダー（`Stripe-Signature`）の検証に関する記述がない。

Webhook署名検証なしでは:
- 攻撃者が偽のWebhookリクエストを送信し、支払い完了を偽装して商品を不正入手できる
- 注文ステータスを任意に変更される可能性がある

**推奨対策**:
- Stripeが提供するWebhook署名検証（`stripe.webhooks.constructEvent()`）を必須として設計に明記する

---

### [HIGH-05] テナント分離のアプリケーション層依存（SQLインジェクションによる迂回リスク）

**設計箇所**: セクション 3.2 マルチテナント分離方式

**問題の詳細**:
テナントデータの分離は「アプリケーション層でのクエリフィルタリング」のみに依存している。`tenant_id` カラムによる共有スキーマ方式は、以下のリスクを持つ:
- フィルタリング漏れ（実装ミス）が他テナントデータへのアクセスを直接引き起こす
- Row Level Security（RLS）等のデータベースレベルの分離が設計されていない

Prisma ORMを使用しているためSQLインジェクション対策は施されているが、ORMのクエリビルダーで `tenant_id` フィルタを付け忘れた場合の安全網がない。

**推奨対策**:
- PostgreSQL Row Level Security (RLS) をデータベースレベルの分離レイヤーとして追加設計する
- 各テナントサービスに `tenant_id` を必須パラメータとする内部APIインターフェースを設計し、フィルタリング漏れを構造的に防ぐ

---

## 中程度の問題

### [MEDIUM-01] ファイルアップロードのMIMEタイプ検証不足

**設計箇所**: セクション 6.5 ファイルアップロード

**問題の詳細**:
- `Content-Type` ヘッダーによる判定のみ（拡張子検証なし）と明記されている
- `Content-Type` ヘッダーはクライアントが任意に設定可能であり、ファイル内容の実際のMIMEタイプを保証しない
- `multer@1.4.4` は既知のセキュリティ脆弱性を含むバージョンである（後続のバージョンでセキュリティパッチが適用されている）
- ウイルススキャンが未導入

**推奨対策**:
- サーバーサイドでファイルマジックバイト（ファイルシグネチャ）による実際のファイル種別検証を実施する
- `multer` を最新の安全なバージョンにアップデートする（またはS3 Presigned URLを使用し、サーバー側でのmulter処理を廃止する）
- S3へのアップロード後にAWS GuardDutyまたは外部ウイルススキャンを実施する設計を追加する

---

### [MEDIUM-02] 個人情報のフィールドレベル暗号化未実施

**設計箇所**: セクション 5.1 保存データの暗号化

**問題の詳細**:
設計書では「RDS暗号化により保護されているため、フィールドレベルでの追加暗号化は不要」と判断しているが、RDS TDEはディスクレベルの暗号化であり、以下のシナリオでは保護されない:
- RDSへの不正なクエリアクセス（SQLインジェクション、内部不正）では平文でデータが取得される
- アプリケーションログへのデバッグ出力によるPII漏洩（ログ出力禁止ポリシーはあるが実装依存）

**推奨対策**:
- 氏名・住所・電話番号等の高感度PII項目にはアプリケーションレベルの暗号化を実施する
- 少なくとも暗号化対象フィールドの優先順位付けと段階的導入計画を設計書に記載する

---

### [MEDIUM-03] 監査ログの分離不足

**設計箇所**: セクション 8.4 監査ログ

**問題の詳細**:
設計書では「アプリケーションの通常ログと同一のCloudWatch Logsストリームに出力」としている。

セキュリティ監査ログを通常ログと同一ストリームに出力すると:
- ログの改ざん・削除に対する保護が不十分
- セキュリティ調査時に通常ログとの分離ができず調査効率が低下
- コンプライアンス要件（データアクセス監査証跡の完全性保証）を満たせない可能性

また、セクション 8.4の監査対象にはセキュリティ上重要な「認証失敗」「ロール変更」「管理者操作」が含まれているが、セクション 9.4では「認証失敗・権限変更等の重要イベントをアプリケーションログに記録する」と記載されており、分離した監査ログへの記録設計が矛盾している。

**推奨対策**:
- セキュリティ監査ログは独立したCloudWatch Logsストリームまたは専用のログ管理サービスへ出力する
- 監査ログへのアクセス権限を最小化し、改ざん防止のためにS3へのアーカイブ・CloudTrailとの連携を設計する

---

### [MEDIUM-04] PIIデータ保持期間・削除方針の未定義

**設計箇所**: セクション 5.3 個人情報（PII）管理

**問題の詳細**:
設計書では「データ保持期間・削除方針: 現時点では未定義」と明記されている。

個人情報の保持期間と削除手順が未定義の場合、GDPRや個人情報保護法に基づく「忘れられる権利」への対応が不可能となる。退会申請後の対応フローが設計されていないことは、法的コンプライアンスリスクとなる。

**推奨対策**:
- データ保持期間（例: 退会後X年）と削除フローを設計書に明記する
- 退会時の個人情報削除・匿名化処理を設計する

---

### [MEDIUM-05] 署名付きURLの有効期限過長

**設計箇所**: セクション 5.4 S3ストレージセキュリティ

**問題の詳細**:
請求書・契約書類のPresigned URLの有効期限が7日間に設定されている。

7日間は機密書類の共有URLとしては長すぎる有効期限であり、URLが漏洩した場合（メール誤送信、ブラウザ履歴等）に7日間は不正アクセスが継続する。

**推奨対策**:
- 機密書類のPresigned URLは用途に応じた短い有効期限（例: 1時間〜24時間）に短縮する

---

## 軽微な問題・改善点

### [LOW-01] 依存ライブラリの脆弱性スキャン頻度が不十分

**設計箇所**: セクション 8.2 依存ライブラリ管理

**問題の詳細**:
セキュリティアップデートを四半期ごとに確認する設計となっているが、`multer@1.4.4` のような既知の脆弱性を持つパッケージが現時点で使用されている。

**推奨対策**:
- Dependabot またはSnykによる自動継続監視を導入し、重大な脆弱性は即座に対応できる体制を設計する

---

### [POSITIVE-01] 適切に設計されているセキュリティ対策

以下の対策は適切に設計されている:
- AWS Secrets Managerによるシークレット管理（ただしリポジトリ二重保存問題を除く）
- bcrypt cost factor 12 によるパスワードハッシュ
- Prisma ORMによるSQLインジェクション対策
- リフレッシュトークンのHttpOnly Cookie保存
- ログアウト時のリフレッシュトークンブラックリスト登録
- CSP設定とDOMPurifyによるXSS多層防御
- Stripeへのカード情報委譲（PCI DSS対応）
- プライベートサブネット配置とSecurity Groupによる最小権限ネットワーク設計
- 内部通信もHTTPS強制

---

## 脅威モデル（STRIDE）サマリー

| カテゴリ | 評価 | 主要リスク |
|---------|------|-----------|
| Spoofing（なりすまし） | 要改善 | ブルートフォース対策未設計、トークン即時無効化不可 |
| Tampering（改ざん） | 要改善 | Webhook署名検証未設計、監査ログ分離不足 |
| Repudiation（否認） | 要改善 | 監査ログが通常ログと混在、改ざん防止なし |
| Information Disclosure（情報漏洩） | 要改善 | CORS正規表現バイパス、PII平文保存、シークレットリポジトリ保存 |
| Denial of Service（サービス拒否） | 部分的 | 認証エンドポイントのレートリミット未設計 |
| Elevation of Privilege（権限昇格） | 部分的 | テナント分離がアプリ層のみ依存、トークン即時無効化不可 |
