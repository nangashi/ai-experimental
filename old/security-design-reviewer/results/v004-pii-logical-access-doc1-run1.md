# Security Design Review: MediConnect システム設計書

**Reviewer:** security-design-reviewer (v004-variant-pii-logical-access)
**Document:** test-document-1.md
**Run:** 1

---

## CRITICAL Issues

### C1: PIIおよび医療機密情報のアプリケーション層暗号化の欠如

**該当箇所:** セクション 6.2「保存データの暗号化」

**問題の詳細:**
設計書は「診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している」と明記している。

しかし、RDS TDE（Transparent Data Encryption）やディスクレベルの暗号化は、**データベースへの正規アクセス権限を持つ内部関係者（内部不正、DBアカウント侵害、SQLインジェクション経由の権限昇格）** からデータを保護しない。透過的暗号化はストレージI/Oを保護するが、DBクレデンシャルを持つ攻撃者はSQLクエリを通じてすべてのデータを平文で読み取ることができる。

本システムが扱うデータには以下が含まれる:
- `patients` テーブル: 氏名、生年月日、電話番号、メールアドレス、**保険証番号**
- `medical_records` テーブル: **診断内容 (diagnosis)**、**SOAPノート (soap_note)**
- `prescriptions` テーブル: **処方薬情報 (medications)**

これらは医療情報ガイドライン（厚生労働省）が定める要保護情報であり、医療法・個人情報保護法の観点からも最高機密区分に相当する。

**影響:**
- DBクレデンシャルの漏洩、内部不正、SQLインジェクションによる全患者医療情報の平文取得
- マルチテナント環境において、一つのテナントのDB接続情報侵害が全テナントのデータ漏洩につながるリスク
- 厚生労働省ガイドラインおよびGDPR相当の個人情報保護要件への非準拠

**推奨対策:**
1. `insurance_number`、`diagnosis`、`soap_note`、`medications` 等の高感度フィールドに対してフィールドレベル暗号化（AES-256-GCM）をアプリケーション層で実装する
2. 暗号鍵はAWS KMSで管理し、DBクレデンシャルと分離する（DBアクセス権限と復号権限を分離）
3. 最低限、保険証番号（`insurance_number`）と診断内容（`diagnosis`, `soap_note`）は行/カラムレベルの暗号化対象として設計に明記する

---

### C2: JWTトークンのlocalStorage保存によるXSS経由の認証情報漏洩

**該当箇所:** セクション 5.1「認証フロー」ステップ4

**問題の詳細:**
アクセストークンを `localStorage` に保存する設計は、XSS（クロスサイトスクリプティング）攻撃が成功した場合にトークンが完全に窃取されるリスクがある。攻撃者は任意のスクリプトで `localStorage.getItem()` を呼び出すだけでトークンを取得できる。

医療情報を扱う本システムにおいて、トークン窃取は患者の全医療記録への不正アクセスに直結する。

**影響:**
- XSS成功時に攻撃者が有効なアクセストークン（24時間有効）を取得し、患者になりすましてAPIを呼び出せる
- `Authorization: Bearer` ヘッダーで付与されるため、Cookieのhttponly設定による保護が効かない

**推奨対策:**
1. アクセストークンを `httpOnly; Secure; SameSite=Strict` 属性付きのCookieに格納する
2. リフレッシュトークンはサーバーサイドセッションのみで管理し、クライアントには渡さない設計を検討する
3. アクセストークンの有効期限を24時間から15〜30分程度に短縮し、リフレッシュトークンによる定期的な再発行を行う

---

### C3: VPC内部通信の平文化による内部経路での盗聴リスク

**該当箇所:** セクション 6.1「通信の暗号化」

**問題の詳細:**
「VPC 内部の通信については内部ネットワークであるため平文で行う」と明記されている。

マイクロサービス間（auth-service、patient-service、consultation-service、prescription-service）および各サービスとPostgreSQL/Redis間の通信が平文であると、以下のリスクが生じる:
- VPC内で侵害されたコンテナや不正なECSタスクが他サービスの通信を傍受できる
- マルチテナント環境において、サービス間で渡されるテナントデータが平文で露出する

**影響:**
- VPC内のECSコンテナ侵害（Supply Chainや脆弱性経由）で全マイクロサービス間通信を傍受可能
- 医療情報が含まれるサービス間APIレスポンスの平文盗聴

**推奨対策:**
1. サービス間通信にTLS（mTLS推奨）を適用する
2. 少なくともApplication LoadBalancerレベルでHTTPSを強制し、ECS間通信も内部証明書によるTLSを設計する
3. AWS App Meshや Service Meshパターンによるサービス間mTLS適用を検討する

---

## SIGNIFICANT Issues

### S1: 医師ロールによる全患者データへの無制限アクセス（Broken Object Level Authorization）

**該当箇所:** セクション 5.2「認可モデル」

**問題の詳細:**
「doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする」と明記されている。

これは、医師が自分の担当でない患者の医療記録を閲覧できることを意味し、最小権限の原則に反する。マルチテナント環境ではテナント内の全患者データへのアクセスが可能となる。

APIエンドポイント `GET /api/v1/patients/{id}` および `GET /api/v1/patients/{id}/prescriptions` において、担当患者かどうかの検証が設計されていない。

**影響:**
- 悪意ある医師や侵害されたアカウントによる、担当外患者の医療情報への不正アクセス
- HIPAA/個人情報保護法の観点からの「必要最小限のアクセス」原則違反
- 厚生労働省ガイドラインへの非準拠リスク

**推奨対策:**
1. 医師の患者アクセスを `doctor_id` と `patient_id` の紐付けテーブル（担当関係テーブル）で管理する
2. `GET /api/v1/patients/{id}` で医師の担当患者であることを検証するロジックをミドルウェアまたはサービス層に明示的に設計する
3. 例外的な全患者閲覧が必要な場合（救急等）は、アクセス記録と承認フローを設計する

---

### S2: CORS設定のワイルドカード (`*`) による資格情報付きリクエストの漏洩リスク

**該当箇所:** セクション 7.3「CORS設定」

**問題の詳細:**
「開発効率を優先するため `Access-Control-Allow-Origin: *` を設定する。本番環境では必要に応じて絞り込みを検討する」と記述されており、本番適用時の明確な設計が示されていない。

ワイルドカードCORSと資格情報付きリクエストの組み合わせは、悪意あるサードパーティサイトからのCSRF攻撃の起点となりうる。なお、`*` はCookieベースの資格情報付きリクエストと組み合わせられないが、Bearerトークン（localStorageから取得）を用いる場合はこの制限が回避される。

**影響:**
- フィッシングサイトがユーザーのブラウザ上で医療APIを呼び出し、データを窃取できる
- 「本番環境で必要に応じて」という記述は設計上の保証がなく、実装フェーズで見落とされるリスクが高い

**推奨対策:**
1. 設計書にて本番CORSの許可オリジンを明示的に列挙する（例: `https://app.mediconnect.example.jp`）
2. `Access-Control-Allow-Credentials: true` を必要とする場合はワイルドカードを禁止し、明示的なオリジン指定を必須とする
3. 環境別のCORS設定ポリシーをIaC (Terraform)で管理する設計を明記する

---

### S3: ログへのPII出力制御の欠如

**該当箇所:** セクション 6.3「個人情報の取り扱い」

**問題の詳細:**
「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする」と明記されている。

CloudWatch Logsに集約されるログに患者氏名、診断内容、保険証番号等が含まれた場合、CloudWatchへのアクセス権限を持つ全エンジニア・運用担当者が医療情報に平文でアクセスできる。

**影響:**
- ログ基盤へのアクセス権限がある全員が患者医療情報を平文で閲覧可能
- 「エンジニアの判断に委ねる」は組織的コントロールがなく、コンプライアンス審査で指摘を受ける
- インシデント時のフォレンジックにPIIが含まれ、二次漏洩リスクが生じる

**推奨対策:**
1. PIIを含むフィールドのログ出力を明示的に禁止する設計ルールを定義する
2. ログに含める場合は患者IDのみ（UUID）を使用し、氏名・診断内容・保険証番号等の平文PIIは除外する
3. CloudWatch Logsのアクセス制御ポリシーを設計に明記する

---

## MODERATE Issues

### M1: 認証エンドポイントへのレート制限なし

**該当箇所:** セクション 8.5「認証エンドポイント保護」

**問題の詳細:**
「高可用性を優先するため呼び出し制限は設けない設計とする」と記述されている。`POST /api/v1/auth/login` および `POST /api/v1/auth/refresh` へのレート制限がない設計は、ブルートフォース攻撃やクレデンシャルスタッフィング攻撃を許容する。

**影響:**
- 医師・患者アカウントへのパスワードブルートフォース攻撃が無制限に実行可能
- リフレッシュトークンエンドポイントの悪用によるトークンローテーション枯渇

**推奨対策:**
1. APIゲートウェイまたはnginxレベルでIPベースのレート制限を設計する（例: 10回/分を超えたらブロック）
2. アカウントロックポリシー（5回失敗でN分ロック）を設計に明記する
3. 高可用性とセキュリティのトレードオフを明示し、CAPTCHAや段階的遅延を代替手段として検討する

---

### M2: ファイルアップロードの種別・サイズ制限が設計未定

**該当箇所:** セクション 7.2「ファイルアップロード」

**問題の詳細:**
「ファイル種別・サイズの制限は実装フェーズで決定する」と記述されており、設計段階での制限が定義されていない。ウイルススキャンは実装されているが、ファイル種別検証なしでは悪意あるファイルの保存が可能。

**影響:**
- ウイルス以外のWebShell等の悪意あるコンテンツがS3に保存され、CloudFront経由で配信されうる
- 巨大ファイルのアップロードによるDoS攻撃リスク

**推奨対策:**
1. 許可するファイル種別（MIME type + マジックバイト検証）を設計書に明記する（例: DICOM, PDF, JPEG, PNG のみ）
2. 最大ファイルサイズ上限を設計段階で定義する（例: 100MB）
3. S3バケットポリシーでアップロード可能なContent-Typeを制限する

---

### M3: CSRF保護の設計欠如

**該当箇所:** セクション 7.4「セッション系APIの保護」

**問題の詳細:**
「state-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外とする」と明記されており、`POST /api/v1/prescriptions`（処方箋発行）や `PUT /api/v1/patients/{id}`（患者情報更新）へのCSRF保護が設計されていない。

**影響:**
- 医師がフィッシングサイトを閲覧した際に、医師の認証情報で不正な処方箋が発行される可能性

**推奨対策:**
1. SameSite=StrictのCookieによるCSRF防止またはCSRFトークンの設計を明記する
2. BearerトークンをlocalStorageから付与する場合、CORSオリジン制限との組み合わせでCSRF対策とする設計を明記する

---

### M4: リフレッシュトークンのユーザーIDキー管理による単一デバイス制限と並行アクセス競合

**該当箇所:** セクション 5.3「セッション管理」

**問題の詳細:**
「ユーザーIDをキーとしてトークン値を管理する」設計では、同一ユーザーが複数デバイスでログインした場合に後発ログインが先行セッションを無効化する。また、複数デバイスからの同時リフレッシュでレースコンディションが発生しうる。

**影響:**
- 医師が自宅PC・病院PC・タブレットで同時ログインできない運用上の問題
- 複数デバイスからの同時トークンリフレッシュによるトークン無効化ループ

**推奨対策:**
1. RedisキーをユーザーIDではなく `{user_id}:{device_id}` または `{session_id}` に変更し、マルチデバイスに対応する
2. トークンローテーション（リフレッシュ時に旧トークン無効化+新トークン発行）を原子的操作で実装する設計を明記する

---

### M5: サードパーティ依存関係の脆弱性管理方針の欠如

**該当箇所:** セクション 8.2「サードパーティ依存関係」

**問題の詳細:**
「脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定」と記述されている。Twilio Video SDK v2.27.0 等の固定バージョンを使用しているが、継続的な脆弱性監視の設計がない。

**影響:**
- 既知脆弱性を持つライブラリが本番環境で長期間使用されるリスク
- Node.js 18 等のEOL追跡が不明確

**推奨対策:**
1. Dependabot または npm audit をCI/CDパイプラインに組み込む設計を明記する
2. 重大度Criticalの脆弱性に対する対応SLAを設計段階で定義する

---

## MINOR / Positive Aspects

### Positive: 認証基盤の適切な実装

- bcryptコスト係数12の使用は現時点での推奨値として適切
- JWTによるステートレス認証の採用
- Secrets ManagerによるDBクレデンシャル管理は適切な設計
- マルチスキーマによるテナント分離は基本的なデータ分離として有効

### Positive: インフラセキュリティの基本設計

- RDS・RedisをVPCプライベートサブネットに配置
- セキュリティグループによるポートアクセス制限
- S3サーバーサイド暗号化の有効化

---

## 総括

本設計書の最重要課題は、**PIIおよび医療機密情報をRDS TDE（透過的暗号化）のみで保護し、アプリケーション層での暗号化を省略している点**（C1）である。TDEはDBアクセス権限を持つ内部関係者や侵害されたDBアカウントからの保護を提供しないため、医療情報という最高機密データに対しては不十分である。特に `insurance_number`、`diagnosis`、`soap_note`、`medications` フィールドは、フィールドレベル暗号化と鍵管理（KMS）の明示的な設計が必要である。

次点として、JWTのlocalStorage保存（C2）、VPC内部通信の平文化（C3）、医師ロールの無制限患者データアクセス（S1）が重大な設計上のリスクを構成する。

厚生労働省の医療情報ガイドラインへの準拠を要件とする本システムにおいて、これらの課題は設計フェーズでの解決が必要であり、実装フェーズへの先送りは許容されない。
