# Security Design Review: MediConnect システム設計書

## Executive Summary

MediConnect は医療機関向けの電子カルテ・遠隔診療プラットフォームであり、患者の医療情報・PII・保険情報を扱う高リスクシステムである。本レビューにより、データ侵害・権限昇格・システム全体の侵害に繋がりうる重大な設計上の欠陥が複数確認された。

---

## Critical Issues（即座に対処が必要）

### [C-01] フロントエンド検証依存: バックエンド入力検証の欠如

**対象箇所:** セクション 7.1「入力検証方針」

**問題:**
> すべてのAPIリクエストにおいて、フロントエンドで入力検証が完了した状態でAPIに送信される設計とする。バックエンドでは基本的な型チェック（JSONスキーマバリデーション）のみ実施する。

これは**重大な設計上の欠陥（Critical Design Flaw）**である。フロントエンドのバリデーションはクライアント側で動作するため、攻撃者はAPIへの直接リクエスト、プロキシツール（Burp Suite等）によるリクエスト改ざん、またはモバイルアプリのリバースエンジニアリングにより容易に迂回できる。

医療情報・処方箋データ・患者PII を扱うシステムにおいて、サーバーサイドのバリデーションは必須の防衛層である。診断内容（SOAPノート）や処方薬情報（medications JSONB）に対して不正データが注入された場合、SQLインジェクション・NoSQLインジェクション・XSSの経路となりうる。

**影響:**
- SQLインジェクション / NoSQL インジェクション攻撃による患者データ全漏洩
- XSSペイロード注入による医師・患者セッションの奪取
- 処方箋情報の改ざんによる医療安全上の危険

**対策:**
- 全APIエンドポイントにおいてサーバーサイドでの完全な入力検証を実施する（フロントエンド検証とは独立して）
- `diagnosis`・`soap_note`・`medications` フィールドに対してスキーマ検証・サニタイズを必須化する
- Joi、Zod、express-validator 等のライブラリを用いてバックエンドバリデーション層を設計に明示する

---

### [C-02] CSRF 保護の欠如（State-Changing API）

**対象箇所:** セクション 7.4「セッション系 API の保護」

**問題:**
> 医師による処方箋発行（`POST /api/v1/prescriptions`）や患者情報更新（`PUT /api/v1/patients/{id}`）などのstate-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外とする。

処方箋発行・患者情報更新という最も高リスクな操作に対してCSRF保護が未設計である。これは設計上の重大な欠落である。

さらに、本設計では認証トークンを `localStorage` に保存し `Authorization: Bearer` ヘッダーで送信しているため（セクション5.1）、CSRF攻撃に対してXHRリクエストはある程度保護される。しかし以下の理由から JWT 単独では CSRF 対策として不完全である:

- JWTを `Authorization: Bearer` で送信する場合、ブラウザは自動でヘッダーを付与しないため通常のCSRFは成立しにくいが、`localStorage` はXSS脆弱性と組み合わさると完全に無効化される
- Cookie認証が並行して存在する場合（将来的なモバイルWebView対応等）は直ちにCSRF脆弱性となる
- 設計書には「CSRF不要」とは明記されておらず、「スコープ外」として保護を後回しにしている点が危険

**影響:**
- 悪意あるWebサイトから医師のセッションを利用した不正処方箋発行
- 患者情報の不正更新・改ざん

**対策:**
- `POST /api/v1/prescriptions`・`PUT /api/v1/patients/{id}` 等のすべてのstate-changing APIに対して、設計段階でCSRF保護を明示する
- SameSite=Strict または SameSite=Lax Cookie属性の設計を明記する
- Originヘッダー検証をサーバーサイドで実施する設計を追加する

---

### [C-03] localStorage へのトークン保存によるXSS脆弱性

**対象箇所:** セクション 5.1「認証フロー」ステップ4

**問題:**
> クライアントはアクセストークンを `localStorage` に保存する

`localStorage` はJavaScriptから完全にアクセス可能であり、XSS攻撃が成功した場合にアクセストークンおよびリフレッシュトークンが即座に窃取される。医療情報システムにおいてこれは特に危険であり、攻撃者が医師または管理者のトークンを取得すれば全患者データへのアクセスが可能となる。

**影響:**
- XSS攻撃によるトークン窃取 → 患者全データの漏洩
- 30日間有効なリフレッシュトークンの永続的な悪用

**対策:**
- アクセストークンはメモリ（Reactのstate/Redux store）に保持し、リフレッシュトークンは `HttpOnly; Secure; SameSite=Strict` Cookie に保存する設計に変更する
- アクセストークンの有効期限を24時間から15〜60分程度に短縮する

---

### [C-04] Doctor ロールによるテナント横断的な全患者データアクセス

**対象箇所:** セクション 5.2「認可モデル」

**問題:**
> doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする。

マルチテナントシステム（セクション1.3・3.2）において、医師が担当外の患者データを `patient_id` を変更するだけでアクセスできる設計は、IDOR（Insecure Direct Object Reference）脆弱性を設計レベルで容認している。

医療法・個人情報保護法の観点からも、医師は担当患者のデータのみにアクセスできるよう制限されるべきである。

**影響:**
- 医師が他院・他医師の患者全データを参照可能
- テナント間データ漏洩（マルチテナント設計の根幹を破壊）
- 医療法・個人情報保護法への違反リスク

**対策:**
- 医師は自身が担当する（または同一テナント内で許可された）患者のみアクセス可能に制限する
- `GET /api/v1/patients/{id}` において `doctor_id` と `patient_id` の担当関係をデータベースで検証する設計を追加する
- JWTの `tenant_id` クレームを全クエリに強制適用し、テナント境界を保証する

---

## Significant Issues（リリース前に対処すべき）

### [S-01] VPC内部通信の平文送信

**対象箇所:** セクション 6.1「通信の暗号化」

**問題:**
> VPC 内部の通信については内部ネットワークであるため平文で行う。

ECSサービス間（auth-service・patient-service・consultation-service・prescription-service）、API GatewayとECS間、ECSとRDS/Redis間の通信が平文である。VPC内部の通信であっても、以下のリスクが存在する:

- VPCが侵害された場合（インスタンス侵害・SSRFによる内部アクセス等）の盗聴
- AWSの内部ネットワーク上でのリスク（共有インフラ）
- 医療情報（診断内容・処方薬情報）の内部経路での平文露出

**対策:**
- マイクロサービス間通信にTLS（mTLS推奨）を設計に明記する
- RDSおよびRedisへの接続もTLS必須と明記する（RDS PostgreSQL 15はTLS対応）

---

### [S-02] ブルートフォース攻撃に対する認証エンドポイント無防備

**対象箇所:** セクション 8.5「認証エンドポイント保護」

**問題:**
> `/api/v1/auth/login` エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計とする。

医療従事者のアカウントに対してブルートフォース攻撃が可能な設計となっている。bcrypt コスト係数12は適切であるが、呼び出し制限がないため攻撃者は低速でも無制限に試行できる。

同様に、`POST /api/v1/auth/refresh` についてもレート制限の設計が明記されていない。

**対策:**
- ログインエンドポイントに対して、IPベースのレート制限（例: 5回失敗/分）を設計に明記する
- アカウントロック（一時的なロックアウト）ポリシーを設計する
- リフレッシュトークンエンドポイントにもレート制限を追加する

---

### [S-03] CORS ワイルドカード設定

**対象箇所:** セクション 7.3「CORS設定」

**問題:**
> `Access-Control-Allow-Origin: *` を設定する。本番環境では必要に応じて絞り込みを検討する。

設計書に本番環境でのワイルドカードCORSが記載されており、「必要に応じて」という曖昧な表現で絞り込みが担保されていない。

ワイルドカードCORSは医療情報APIにとって危険であり、認証情報（Credentialed requests）との組み合わせでは特に問題となる。

**対策:**
- 許可するオリジン（医療機関のドメイン・モバイルアプリ等）を設計段階で明示的に列挙する
- 本番環境での `Access-Control-Allow-Origin: *` を設計書から明確に禁止する記述を追加する

---

### [S-04] ファイルアップロードの種別・サイズ制限未設計

**対象箇所:** セクション 7.2「ファイルアップロード」

**問題:**
> ファイル種別・サイズの制限は実装フェーズで決定する。

`/api/v1/files/upload` エンドポイントにおけるファイル種別・サイズ制限が設計段階で未定義である。ウイルススキャンは実施されるが、ファイル種別バリデーションがなければ悪意あるファイル（スクリプト・実行ファイル等）をS3にアップロードされうる。

**対策:**
- 許可するMIMEタイプ（JPEG・PNG・PDF等）を設計書に明記する
- ファイルサイズ上限（例: 50MB）を設計書に明記する
- アップロードファイルのS3保存パスを推測不可能なUUID形式にし、直接アクセスをS3バケットポリシーで制限する設計を追加する

---

## Moderate Issues（次フェーズで対処すべき）

### [M-01] 患者PII ログ出力のエンジニア裁量

**対象箇所:** セクション 6.3「個人情報の取り扱い」

**問題:**
> 患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする。

PIIのログ出力ポリシーを個人の判断に委ねることは、意図しない個人情報漏洩（CloudWatch Logsへの患者氏名・保険証番号の記録等）につながりうる。

**対策:**
- PIIフィールド（氏名・生年月日・保険証番号・診断内容等）のログ出力を原則禁止するポリシーを設計書に明記する
- ログマスキングライブラリの採用を設計に含める

---

### [M-02] 監査ログの不完全性

**対象箇所:** セクション 8.3「監査ログ」

**問題:**
> ログには操作ユーザーID、操作種別、タイムスタンプを含める。

医療システムとして必要な監査項目が不足している。特に以下が欠落:
- 対象リソースID（どの患者のデータを操作したか）
- 失敗したアクセス試行の記録
- 権限変更・ユーザー管理操作の記録

**対策:**
- 監査ログに `resource_id`・`resource_type`・`result (success/failure)`・`ip_address` を追加する設計を明記する
- 認証失敗・権限エラー・患者データアクセスを必須の監査イベントとして定義する

---

### [M-03] 医療機密情報のアプリケーションレベル追加暗号化の欠如

**対象箇所:** セクション 6.2「保存データの暗号化」

**問題:**
> 診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している。

RDS暗号化（AES-256）はディスクレベルの保護であり、DBアクセス権限を持つエンジニアやSQLインジェクション攻撃に対しては透過的に復号される。医療情報システムとしては、高感度データへのアプリケーションレベルの暗号化を検討すべきである。

**対策:**
- `diagnosis`・`soap_note`・`insurance_number` 等の高感度フィールドにアプリケーションレベルの暗号化（列レベル暗号化等）の採否を明確に設計判断として記述する
- AWS KMS を活用したフィールドレベル暗号化の検討を推奨する

---

### [M-04] 依存ライブラリの脆弱性管理方針の欠如

**対象箇所:** セクション 8.2「サードパーティ依存関係」

**問題:**
> 脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定である。

Twilio Video SDK v2.27.0・Express 4.18・React 18 等の固定バージョンに対して、脆弱性監視の設計が存在しない。

**対策:**
- `npm audit` または Snyk・Dependabot 等の自動脆弱性スキャンをCI/CDパイプラインに組み込む設計を明記する
- 重大度 Critical/High の脆弱性については自動アラートを設定する設計を追加する

---

## Positive Aspects

- **bcrypt コスト係数12**: 適切なパスワードハッシュ設計
- **マルチスキーマ方式によるテナント分離**: スキーマレベルでのデータ分離は良好
- **AWS Secrets Manager**: 機密設定値の適切な管理方式
- **RDS Multi-AZ・ECS マルチタスク**: 可用性設計は適切
- **JWTへのtenant_idクレーム**: テナント識別の基本設計は存在する
- **Redis によるリフレッシュトークン管理とログアウト時削除**: 基本的なセッション管理は設計されている
- **S3へのウイルススキャン**: アップロードファイルへの基本的な保護

---

## STRIDE 評価サマリ

| 脅威カテゴリ | 評価 | 主な問題 |
|---|---|---|
| Spoofing | 要改善 | localStorage保存・ブルートフォース無防備 |
| Tampering | 要改善 | フロントエンド検証依存・バックエンド検証欠如 |
| Repudiation | 要改善 | 監査ログの不完全性（リソースID欠落等） |
| Information Disclosure | 要改善 | VPC内平文通信・PIIログ管理不備 |
| Denial of Service | 要改善 | 認証エンドポイントのレート制限なし |
| Elevation of Privilege | 危険 | Doctor による全患者データアクセス（IDOR設計） |
