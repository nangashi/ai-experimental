# Security Design Review: MediConnect システム設計書

## Executive Summary

MediConnect は医療機関向けの電子カルテ・遠隔診療プラットフォームであり、患者の医療情報・PII・保険情報といった極めて高感度なデータを扱う。本レビューでは、設計書に記述された（または欠落している）セキュリティ対策を、重大度順に報告する。

---

## Critical Issues

### CRIT-01: 医療機密情報がアプリケーション層暗号化なしに平文でDBに保存されている

**設計書箇所**: 6.2 保存データの暗号化

**問題詳細**

設計書は以下のように明示している:

> 診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している。

**暗号化レイヤー分析**

採用している保護は「ストレージ層暗号化（RDS暗号化 / AES-256）」のみである。この方式の限界を以下に整理する:

| 暗号化レイヤー | 保護対象 | 保護されない脅威 |
|---|---|---|
| ストレージ層（RDS暗号化・TDE） | 物理メディア盗難、ストレージへの不正アクセス | アプリケーション経由の論理アクセス、DBユーザー権限での直接クエリ、アプリケーションレイヤー侵害後のデータ読み取り |
| アプリケーション層（フィールドレベル暗号化） | 上記すべて + DB管理者・インサイダー脅威・DB直接アクセス | （暗号鍵管理の問題のみ） |

MediConnect が扱うデータは以下のとおり高感度 PII・医療情報に分類される:

- `medical_records.diagnosis`（診断内容）
- `medical_records.soap_note`（SOAPノート）
- `prescriptions.medications`（処方薬情報）
- `patients.insurance_number`（保険証番号）
- `patients.full_name`, `date_of_birth`, `phone_number`, `email`（患者基本PII）

これらは、攻撃者がアプリケーション経由でSQLインジェクションを成功させた場合、DBユーザー権限を奪取した場合、またはインサイダー（DBA）がクエリを実行した場合に、RDS暗号化は一切の防護を提供しない。

**影響**

- 医療情報の大規模漏洩リスク（患者の診断内容・処方内容が平文で取得可能）
- 厚生労働省の医療情報ガイドライン（三省二ガイドライン等）への非準拠
- マルチテナント設計においてテナント間のデータ分離がDBレベルでは暗号化により担保されていない

**対策**

1. `diagnosis`, `soap_note`, `medications`, `insurance_number` 等の高感度フィールドにアプリケーション層フィールドレベル暗号化を実装する（例: AES-256-GCM をアプリケーションで適用）
2. 暗号化鍵は AWS KMS（Customer Managed Key）で管理し、テナントごとに鍵を分離する
3. 検索が必要なフィールド（`email`等）はブラインドインデックス（HMACハッシュ）と組み合わせる

---

### CRIT-02: JWTアクセストークンの localStorage 保存による XSS 脆弱性

**設計書箇所**: 5.1 認証フロー（手順4）

**問題詳細**

> クライアントはアクセストークンを `localStorage` に保存し、以降のAPIリクエストに `Authorization: Bearer` ヘッダーで付与する

`localStorage` はJavaScriptから完全にアクセス可能であるため、XSS攻撃が成立した場合にトークンが即座に窃取される。医療情報を扱うアプリケーションにおいて、アクセストークン窃取はそのまま全患者データへのアクセスに直結する。

**対策**

- アクセストークンを `HttpOnly; Secure; SameSite=Strict` Cookie に保存する
- アクセストークンの有効期限を24時間から15〜30分程度に短縮する
- リフレッシュトークンも同様に HttpOnly Cookie で管理する

---

### CRIT-03: doctor ロールが全患者データに無制限アクセス可能

**設計書箇所**: 5.2 認可モデル

**問題詳細**

> doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする

医師は「担当患者の診療記録の閲覧・記録」が権限として定義されているが、実装上は全患者データに無制限アクセスできる設計となっている。これは「必要最小権限の原則」に違反し、以下のリスクをもたらす:

- 医師が担当外の著名人・関係者の医療情報を参照可能
- 悪意ある内部者（医師）による大規模データ漏洩
- マルチテナント設計においてテナント間での患者データ参照が可能になる危険性

**API Endpoint Authorization Checklist 照合**

`GET /api/v1/patients/{id}` において「担当医師かどうか」の ownership 検証が設計されていない。

**対策**

- 医師と患者の担当関係（assignment）テーブルを設計し、`GET /api/v1/patients/{id}` および `POST /api/v1/patients/{id}/records` に担当関係の検証を必須化する
- patient-service に `doctor_id` フィルタを設ける

---

## Significant Issues

### SIG-01: VPC内部通信が平文（内部通信の暗号化欠如）

**設計書箇所**: 6.1 通信の暗号化

**問題詳細**

> VPC 内部の通信については内部ネットワークであるため平文で行う

マイクロサービス間（auth-service, patient-service, consultation-service, prescription-service）の通信、およびアプリケーション層〜RDS・Redisへの通信が平文である。VPC内でのネットワーク侵害（横展開、パケットキャプチャ）が発生した場合、医療情報が傍受される。

**Transit Encryption Checklist 照合**

- 内部通信（バックエンド〜DB間、マイクロサービス間）: 暗号化設計なし（不備）

**対策**

- RDS への接続に TLS を強制する（`rds.force_ssl=1` および接続文字列に `sslmode=require`）
- Redis 接続に TLS を有効化する（ElastiCache in-transit encryption）
- マイクロサービス間通信に mTLS またはサービスメッシュ（AWS App Mesh）を採用する

---

### SIG-02: CORS ワイルドカード設定

**設計書箇所**: 7.3 CORS設定

**問題詳細**

> `Access-Control-Allow-Origin: *` を設定する。本番環境では必要に応じて絞り込みを検討する

「必要に応じて」という表現は、本番リリース時に設定が残存するリスクを内包する。医療情報を扱うAPIに対してワイルドカードCORSを許可すると、任意のオリジンからの認証済みリクエストが可能となる（ただしCookieを使用しない場合）。また、XSS経由でのAPIアクセスが容易になる。

**対策**

- 本番環境の許可オリジンをホワイトリストで明示的に定義する（設計書に記載する）
- `Access-Control-Allow-Credentials: true` を使用する場合はワイルドカードは禁止（RFC 6454）

---

### SIG-03: ログイン・リフレッシュエンドポイントにレートリミットなし

**設計書箇所**: 8.5 認証エンドポイント保護

**問題詳細**

> `/api/v1/auth/login` エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計とする

ブルートフォース攻撃・クレデンシャルスタッフィング攻撃に対して無防備であり、医師・患者アカウントが侵害されるリスクが高い。`POST /api/v1/auth/refresh` についても制限が言及されていない。

**Authentication Endpoint Protection Checklist 照合**

- ログインエンドポイントのレートリミット: 設計なし（不備）
- リフレッシュエンドポイントのレートリミット: 設計なし（不備）
- パスワードリセットのレートリミット: 設計に記載なし（不備）

**対策**

- IP単位・アカウント単位でのレートリミットを設計する（例: 5回失敗でN分間ロック）
- AWS WAF または API Gateway スロットリングを活用する
- ログイン失敗の監査ログを記録し、異常検知を設計する

---

### SIG-04: CSRF保護の欠如

**設計書箇所**: 7.4 セッション系 API の保護

**問題詳細**

> 現フェーズのスコープ外とする

処方箋発行（`POST /api/v1/prescriptions`）・患者情報更新（`PUT /api/v1/patients/{id}`）等のstate-changingな操作にCSRF保護がない。トークンを Cookie で管理する場合（CRIT-02の対策後）はCSRF保護が必須となる。

**Web Security Controls Checklist 照合**

- CSRFトークンまたは SameSite Cookie 属性の設計: なし（不備）

**対策**

- `SameSite=Strict` Cookie 属性を設定することで CSRF を防止する（または CSRF トークンを実装する）
- `Authorization: Bearer` ヘッダー方式（CRIT-02対策後）に移行する場合は CSRF リスクは低減されるが、Cookie 方式では必須

---

## Moderate Issues

### MOD-01: ファイルアップロードのセキュリティ制限が未定義

**設計書箇所**: 7.2 ファイルアップロード

**問題詳細**

> ファイル種別・サイズの制限は実装フェーズで決定する

ウイルススキャンは記述されているが、ファイル種別（MIME type）・サイズ制限が設計段階で未定義である。悪意あるファイル（WebShell、巨大ファイル）のアップロードによるDoS・リモートコード実行リスクがある。

**File Upload Restrictions Checklist 照合**

- ファイル種別バリデーション: 設計なし（不備）
- サイズ制限: 設計なし（不備）
- ストレージ分離: S3への保存は記述あり

**対策**

- 許可ファイル形式を設計書で明示する（例: JPEG/PNG/DICOM/PDF のみ）
- ファイルサイズ上限を設計する（例: 画像 10MB、PDF 5MB）
- S3バケットをユーザー公開アクセスなしに設定し、署名付きURLで提供する

---

### MOD-02: バックエンドが入力検証をフロントエンドに依存

**設計書箇所**: 7.1 入力検証方針

**問題詳細**

> フロントエンドで入力検証が完了した状態でAPIに送信される設計とする。バックエンドでは基本的な型チェック（JSONスキーマバリデーション）のみ実施する

フロントエンドの検証は攻撃者によって容易にバイパスされる。SQLインジェクション・コマンドインジェクション・XSSペイロードの直接送信が可能となる。

**対策**

- バックエンドで入力サニタイゼーションと検証を実施することを設計書に明記する
- ORMのパラメータ化クエリ使用を必須化する（設計書への明記）
- 医療記録の `diagnosis`, `soap_note` 等のフリーテキストフィールドに対するXSS防止のためのサニタイゼーション設計を追加する

---

### MOD-03: PII ログ出力をエンジニア判断に委任

**設計書箇所**: 6.3 個人情報の取り扱い

**問題詳細**

> 患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする

PII ログ管理のポリシーが存在しない。エンジニアの判断次第で患者の氏名・診断内容・保険番号等がアクセスログ・エラーログに平文で記録される可能性がある。

**PII Handling Checklist 照合**

- PIIのログ出力ポリシー: 設計なし（不備）

**対策**

- PII フィールドをログに出力しない旨を設計書に明示する
- ログのマスキングルールを定義する（例: 氏名は先頭1文字のみ、電話番号は下4桁のみ）

---

### MOD-04: リフレッシュトークンのキー設計による競合リスク

**設計書箇所**: 5.3 セッション管理

**問題詳細**

> リフレッシュトークンは Redis に保存し、ユーザーIDをキーとしてトークン値を管理する

ユーザーIDをキーとする場合、複数デバイスからのログインで後のリフレッシュトークンが前のものを上書きし、旧デバイスのセッションが即座に無効化される。また、トークンローテーション（使用済みトークンの無効化）の設計が記述されていない。

**対策**

- Redis キーを `user_id:device_id` または `token_id` に変更し、マルチデバイスセッションを適切に管理する
- リフレッシュトークンローテーション（使用後に即座に新トークンへ置き換え）を設計する

---

### MOD-05: サードパーティ依存関係の脆弱性管理が未設計

**設計書箇所**: 8.2 サードパーティ依存関係

**問題詳細**

> 脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定である

Twilio Video SDK v2.27.0 を含む依存ライブラリの脆弱性スキャンポリシーが設計段階で定義されていない。医療情報を扱うシステムとして運用開始前に定義が必要である。

**対策**

- CI/CD パイプラインへの `npm audit` / Dependabot / Snyk 統合を設計書に明記する
- 重大脆弱性の対応 SLA を定義する（例: Critical は72時間以内にパッチ適用）

---

## Positive Aspects

- bcrypt（コスト係数12）によるパスワードハッシュ化は適切である
- AWS Secrets Manager によるシークレット管理は良い設計である
- マルチスキーマ方式によるテナント分離は適切である
- RDS/Redis の VPC プライベートサブネット配置は適切である
- S3 へのウイルススキャン実施は評価できる
- 医療法施行規則第22条に基づく5年保持の言及は適切である

---

## Summary Table

| ID | 重大度 | 問題 | 設計書セクション |
|---|---|---|---|
| CRIT-01 | Critical | 医療機密情報がアプリケーション層暗号化なし（ストレージ層のみ） | 6.2 |
| CRIT-02 | Critical | JWTトークンの localStorage 保存（XSS脆弱性） | 5.1 |
| CRIT-03 | Critical | 医師ロールが全患者データに無制限アクセス | 5.2 |
| SIG-01 | Significant | VPC内部通信が平文 | 6.1 |
| SIG-02 | Significant | CORS ワイルドカード設定 | 7.3 |
| SIG-03 | Significant | 認証エンドポイントにレートリミットなし | 8.5 |
| SIG-04 | Significant | CSRF保護の欠如 | 7.4 |
| MOD-01 | Moderate | ファイルアップロード制限が未定義 | 7.2 |
| MOD-02 | Moderate | バックエンド入力検証がフロントエンド依存 | 7.1 |
| MOD-03 | Moderate | PII ログ出力ポリシーなし | 6.3 |
| MOD-04 | Moderate | リフレッシュトークンのキー設計問題 | 5.3 |
| MOD-05 | Moderate | 依存関係脆弱性管理が未設計 | 8.2 |
