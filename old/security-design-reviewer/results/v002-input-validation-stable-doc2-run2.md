# セキュリティ設計レビュー: Nexamart プラットフォーム システム設計書

**対象文書**: Nexamart プラットフォーム システム設計書 v1.4.0
**レビュー観点**: アーキテクチャ・設計レベルのセキュリティ評価

---

## Critical Issues（重大な問題）

### C-01: 本番シークレットのリポジトリへの保存（8.1節）

**問題**:
`config/secrets.prod.yaml` に本番環境のシークレット値を記録し、アクセス制限を設けた上でリポジトリに含めるとされている。

**影響**:
Gitリポジトリに機密情報が含まれると、リポジトリへのアクセス権を持つ全員（過去・現在の開発者、CI/CDシステム、ミラーリング先）が機密情報にアクセス可能になる。リポジトリのクローン、バックアップ、ログ、PRレビュー環境を通じた漏洩リスクが極めて高い。

**推奨対策**:
- `config/secrets.prod.yaml` をリポジトリから完全に除外し、`.gitignore` に追加する
- AWS Secrets Manager のみをシングルソースオブトゥルースとして運用する
- シークレットの参照が必要なデプロイ担当者には、AWS IAMロールベースのアクセス権を付与する

---

### C-02: アクセストークンの localStorage 保存によるXSSリスク（4.1節）

**問題**:
JWTアクセストークンをブラウザの `localStorage` に保存する設計としている。

**影響**:
XSS脆弱性（例：サードパーティスクリプト、DOM Injection）が発生した場合、`localStorage` に保存されたJWTは `document.cookie` にアクセスできないスクリプトからも読み取り可能であり、トークン窃取によるアカウント乗っ取りが成立する。CSP設定（`default-src 'self'`）はある程度のXSSを防ぐが、Next.jsの依存ライブラリや動的コンテンツ経由のXSSを完全には防がない。

**推奨対策**:
- アクセストークンも `HttpOnly` Cookie として保存する（または短命にしてメモリ内のみで保持）
- Cookie の `Secure` 属性と `SameSite=Strict` または `Lax` 属性を設定する
- アクセストークン有効期限を15分以下に短縮する

---

### C-03: CSRF対策の不完全設計 — JWT単独依存（6.3節）

**問題**:
state-changingな操作のCSRF対策として「Authorizationヘッダー経由のJWTが必須」としているが、これのみをCSRF対策として十分と判断している。

**影響**:
この設計はAuthorizationヘッダー経由（XHRリクエスト）でのCSRFを防ぐが、以下の条件で不完全となる:
- リフレッシュトークンは `HttpOnly` Cookie として保存されており、Cookie認証フローが存在する。Cookie認証フローはCSRF攻撃の対象となる
- ブラウザが自動的にCookieを添付するリクエスト（Stripe Webhookの応答処理など）に対してはJWTヘッダーが不在でありCSRF防御が効かない
- 将来的にCookie認証を拡張した場合、CSRF対策が根本的に欠如したまま拡大するリスクがある

**推奨対策**:
- Cookieベースの認証フローには、SameSite=Strict/LaxのCookie属性を明示的に設計する
- 必要に応じてDouble Submit Cookie パターンまたはCSRFトークンを追加する
- `Origin` / `Referer` ヘッダー検証をCookie利用APIに追加する

---

### C-04: CORS設定の正規表現による許可オリジン検証の脆弱性（6.4節）

**問題**:
```javascript
const allowedOrigin = /\.nexamart\.com$/;
```
この正規表現は文字列の末尾にマッチするが、前方は検証していない。

**影響**:
`evilnexamart.com` や `attackernexamart.com` といったドメインも `\.nexamart\.com$` にはマッチしない（ドット `\.` でエスケープ済み）ため、本ケースは直接悪用されないが、`evil.nexamart.com.attacker.com` のようなサブドメイン偽装が文字列操作の観点でリスクを生む設計パターンである。さらに `Access-Control-Allow-Credentials: true` と組み合わせていることで、オリジン検証に欠陥があった場合のリスクが最大化する。

加えて、ワイルドカードの `*.nexamart.com` を許可していることで、XSSが存在する任意のサブドメイン（例：テナントのサブドメイン）を踏み台にして認証済みリクエストを発行できる。

**推奨対策**:
- 許可オリジンを明示的なリストで管理する（ホワイトリスト方式）
- 正規表現を使う場合は `^https://[a-z0-9-]+\.nexamart\.com$` のように完全修飾で検証する
- 特にcredentialed requestsに対してはワイルドカードサブドメイン許可を避ける

---

## Significant Issues（重要な問題）

### S-01: マルチテナント分離のアプリケーション層依存（3.2節）

**問題**:
テナント分離は「アプリケーション層でのクエリフィルタリング」に依存しており、Kong が付与する `X-Tenant-ID` ヘッダーを信頼済みとして処理している。

**影響**:
- 内部ネットワークや Kong バイパスが可能な攻撃者が、`X-Tenant-ID` ヘッダーを任意の値に変更することで、他テナントのデータにアクセスできるリスクがある
- クエリ漏れ（フィルタ適用忘れ）が一件発生するだけで、テナント間データ漏洩が発生する
- `tenant_id` フィルタリングの一貫した適用を保証する仕組みが設計上明示されていない

**推奨対策**:
- Row Level Security (RLS) をPostgreSQL側に設定し、アプリケーション層の漏れを防ぐ多層防御を採用する
- 内部APIエンドポイントに対しても `X-Tenant-ID` の検証を多重化する（mTLSなど）
- 全クエリでの `tenant_id` 適用を静的解析またはORMミドルウェアで自動化する

---

### S-02: アクセストークンの即時無効化不可（4.2節）

**問題**:
アクセストークン（有効期限60分）のサーバーサイドブロックリストが存在せず、権限変更・不正検知時の即時無効化ができない。

**影響**:
- アカウント侵害が発覚しても、最大60分間は攻撃者がアクセストークンを使い続けられる
- `tenant_admin` から `tenant_staff` へのダウングレードなど権限変更が即時反映されない

**推奨対策**:
- アクセストークンの有効期限を短縮（15分以下）する
- 重要な権限変更時のトークン失効メカニズム（Redisを使ったブロックリスト）を設計に含める

---

### S-03: Stripe Webhook エンドポイントの認証設計が未記載（7.3節）

**問題**:
`/api/webhooks/stripe` エンドポイントへのWebhook受信について、Stripeの署名検証（`stripe-signature` ヘッダー検証）の実施が設計書に記載されていない。

**影響**:
Webhook署名検証がない場合、攻撃者が任意の決済完了イベントを送信して注文ステータスを不正に更新できる（支払い不履行の注文を「支払い済み」にする等）。

**推奨対策**:
- Stripe Webhook受信時にStripe提供の署名検証ライブラリを使用することを設計書に明示する
- Webhookエンドポイントは認証不要だが、署名検証を必須とすることを明示する

---

### S-04: 認証エンドポイントのレート制限設計が未記載（4.4節）

**問題**:
`POST /api/auth/login`、`POST /api/auth/register`、`POST /api/auth/refresh` に対するブルートフォース攻撃・乱用防止のレート制限設計が記載されていない。

**影響**:
- ログインエンドポイントへのブルートフォース攻撃によるアカウント侵害
- トークンリフレッシュエンドポイントの過剰利用によるサービス負荷
- アカウント登録の大量作成（スパム・不正利用）

**推奨対策**:
- Kong ゲートウェイのレート制限プラグインを使用し、IPベース・ユーザーベースのレート制限を設計する
- ログインはIPあたり5回/分、リフレッシュはユーザーあたり10回/分などの制限値を設計書に明示する
- アカウントロックアウトまたは指数バックオフの設計を含める

---

## Moderate Issues（中程度の問題）

### M-01: ファイルアップロードのMIME型チェック不十分（6.5節）

**問題**:
ファイルアップロードのMIME型検証が `Content-Type` ヘッダーのみで行われており、拡張子検証・実際のファイル内容（マジックバイト）検証が実施されていない。

**影響**:
- `Content-Type: image/jpeg` を付与したPHPスクリプト等のファイルをアップロードできる
- S3上でのファイル実行は通常できないが、CloudFront経由で配信された場合に意図しないコンテンツタイプで提供されるリスクがある
- ウイルススキャン未導入と組み合わせることでマルウェア配布の踏み台になるリスクがある

**推奨対策**:
- Presigned URL生成時に許可するContent-Typeを明示的に制限する
- バックエンドでのマジックバイト検証（`file-type` ライブラリなど）を設計に追加する
- 将来対応とされているウイルススキャン（AWS Macie / Lambda @ S3イベント）の導入計画を具体化する

---

### M-02: 個人情報フィールドの平文保存（5.1節）

**問題**:
氏名・住所・電話番号の個人情報を「RDS TDEで保護されているため」としてフィールドレベルの暗号化なしで平文保存している。

**影響**:
- DBアクセス権を持つ内部者（DBA、開発者）が全テナントの個人情報を平文で参照できる
- SQLインジェクション等でDBへの直接アクセスが成立した場合、全個人情報が即座に漏洩する
- マルチテナント構成では全テナントの顧客情報が単一DBに集中しており、インシデント時の影響範囲が最大

**推奨対策**:
- メールアドレス等の検索不要フィールドはAES-256によるフィールドレベル暗号化を設計する
- 鍵をテナントごとに分離することでテナント間の情報隔離を強化する

---

### M-03: データ保持期間・削除ポリシー未定義（5.3節）

**問題**:
個人情報の保持期間・削除方針が「未定義」「今後設計する」とされている。

**影響**:
- 個人情報保護法・GDPRの「忘れられる権利」への対応が不可能な状態で本番稼働するリスクがある
- テナントやユーザーの退会後も個人情報が無期限に保持され続ける可能性がある

**推奨対策**:
- ユーザー退会時の個人情報削除・匿名化フローを設計書に明記する
- データ保持期間の上限（例：退会後6ヶ月）を定義する

---

### M-04: 監査ログの分離不備（8.4節）

**問題**:
セキュリティ監査ログ（認証失敗、ロール変更等）をアプリケーションの通常ログと同一CloudWatch Logsストリームに出力する設計としている。

**影響**:
- 監査ログと通常ログが混在することで、インシデント調査時に不正操作の追跡が困難になる
- 通常ログへのアクセス権を持つオペレーターが認証失敗情報（アカウント名・IPアドレス等）を意図せず参照できる
- ログの改ざん・削除を防ぐ設計が明示されていない

**推奨対策**:
- セキュリティイベントログを専用の CloudWatch Logs ストリームまたは S3バケットに分離する
- 監査ログへのアクセス制御（書き込み専用、削除不可）を設計に含める

---

### M-05: multer@1.4.4 の既知脆弱性（8.2節）

**問題**:
`multer@1.4.4` はメンテナンスが停滞しており、既知のセキュリティ問題がある古いバージョンである（現在の安定版は1.4.5-lts.1以降）。

**影響**:
マルチパートフォーム処理ライブラリの脆弱性はファイルアップロード処理全体に影響し、DoSやパストラバーサル攻撃のリスクがある。ただし設計上ファイルアップロードはPresigned URL経由でクライアントが直接S3に行う方式のため、multerの実際の利用範囲の明確化が必要。

**推奨対策**:
- multerの利用用途を設計書に明記し、Presigned URL方式への完全移行が済んでいればmulterの除去を検討する
- 利用継続の場合は最新のltsバージョンへの更新計画を明示する

---

## Minor Issues（軽微な問題）

### N-01: セキュリティ要件7.4節の参照先が存在しない（8.4節）

**問題**:
監査ログの説明に「セキュリティ要件（7.4節）に従い実施する」と記載されているが、7.4節は設計書に存在しない（7章はAPI設計の7.1〜7.3のみ）。

**影響**:
認証失敗・ロール変更の監査ログ要件が参照先なしとなり、実装時の要件が不明確になる。

**推奨対策**:
- 9.4節「セキュリティ要件」への参照を修正するか、監査ログの詳細要件を8.4節内に明記する

---

### N-02: KMSキーローテーション周期が1年（5.1節）

**問題**:
AWS KMSのキーローテーション周期が年1回と設定されている。

**影響**:
業界標準（NIST推奨）ではより短いローテーション周期が推奨される。年1回でも自動ローテーション機能を利用する限りAWSが管理するが、長期間同一キーを使用し続けるリスクがある。

**推奨対策**:
- AWSマネージドキーの自動ローテーション（90日周期）への移行を検討する

---

## ポジティブな設計要素

以下の設計は適切に実装されており、評価できる:

- bcrypt（cost factor: 12）によるパスワードハッシュ化
- リフレッシュトークンの HttpOnly Cookie 保存とサーバーサイドブロックリスト（Redis）
- Prisma ORMのパラメータ化クエリによるSQLインジェクション防止
- DOMPurifyによるリッチテキストサニタイズ
- CSP設定（`default-src 'self'`）
- AWS Secrets Manager によるシークレット管理（ただしC-01の問題あり）
- Stripe への決済情報委譲によるPCI-DSS scope削減
- プライベートサブネット配置・VPN必須の管理コンソールアクセス
- 内部通信もHTTPS使用

---

## 優先対応サマリ

| 優先度 | ID | 問題 | 対応期限 |
|-------|-----|------|---------|
| Critical | C-01 | 本番シークレットのリポジトリ保存 | 即時 |
| Critical | C-02 | アクセストークンのlocalStorage保存 | リリース前 |
| Critical | C-03 | JWT単独CSRF対策の不完全設計 | リリース前 |
| Critical | C-04 | CORS正規表現+credentialed requestsの危険な組み合わせ | リリース前 |
| Significant | S-01 | テナント分離のアプリケーション層単独依存 | リリース前 |
| Significant | S-02 | アクセストークン即時無効化不可 | リリース前 |
| Significant | S-03 | Stripe Webhook署名検証未記載 | リリース前 |
| Significant | S-04 | 認証エンドポイントのレート制限未設計 | リリース前 |
