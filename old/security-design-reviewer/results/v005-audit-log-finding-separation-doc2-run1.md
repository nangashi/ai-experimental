# Security Design Review: Nexamart プラットフォーム システム設計書 v1.4.0

**Reviewer**: security-design-reviewer (v005-variant-audit-log-finding-separation)
**Document**: test-document-2.md
**Run**: doc2-run1

---

## Critical Findings

### CRITICAL-1: 本番シークレット値のリポジトリ保存

**対象セクション**: 8.1 シークレット管理

**問題詳細**:
設計書に「本番環境のシークレット値はデプロイ担当者の参照用に `config/secrets.prod.yaml` へも記録し、アクセス制限を設けたうえでリポジトリに含める」と明記されている。AWS Secrets Manager を使用しているにもかかわらず、同じシークレット値をリポジトリ内ファイルにも保存する設計となっている。

**影響分析**:
- リポジトリへのアクセス権を持つ全員（開発者、CI/CDシステム、外部コントリビューター）がDBパスワード・JWT署名鍵・外部APIキーを参照可能になる
- リポジトリのバックアップ・ミラー・git履歴にシークレットが永続的に残存する
- アクセス制限の設定ミスで即座に全シークレットが漏洩するリスクがある
- DBパスワード漏洩はマルチテナントデータ全件の直接アクセスにつながる

**対策**:
- `config/secrets.prod.yaml` の設計を廃止し、AWS Secrets Manager のみを信頼できるシークレット管理基盤として維持する
- デプロイ担当者の参照ニーズはAWS Secrets Manager コンソールのIAMアクセス制御で対応する
- 既存リポジトリのgit履歴から当該ファイルを完全に削除し、全シークレットをローテーションする

---

### CRITICAL-2: テナント分離の設計的欠陥 — アプリケーション層のみの分離依存

**対象セクション**: 3.2 マルチテナント分離方式

**問題詳細**:
テナント分離は「アプリケーション層でのクエリフィルタリング」のみに依存している。Kong ゲートウェイが付与した `X-Tenant-ID` ヘッダーをコアAPIサービスが信頼し、各クエリに `tenant_id` フィルターを手動で付与する設計となっている。Row-Level Security（RLS）等のデータベースレベルの分離は設計されていない。

**影響分析**:
- 単一のクエリでの `tenant_id` フィルター漏れ（実装バグ）が他テナントデータの全件漏洩に直結する
- `X-Tenant-ID` ヘッダーがコアAPIサービスに到達する経路で改ざんされた場合、テナント分離が完全に崩壊する
- マルチテナントSaaSにおいてアプリケーション層のみの分離はOWASP等で高リスクとして分類される

**対策**:
- PostgreSQL Row-Level Security (RLS) をデータベースレベルの分離レイヤーとして追加設計し、アプリケーション層のフィルタリングと多層防御を構成する
- コアAPIサービス側でも `X-Tenant-ID` ヘッダーの正当性を独自に検証する仕組みを設計する（JWTの `tenantId` クレームとの厳密な突合など）

---

### CRITICAL-3: アクセストークンのXSS経由窃取リスク — localStorage保存

**対象セクション**: 4.1 認証フロー

**問題詳細**:
JWTアクセストークンを `localStorage` に保存する設計となっている。リフレッシュトークンは HttpOnly Cookie で保護されているが、アクセストークンは JavaScript から直接読み取り可能な領域に保存される。

**影響分析**:
- XSS脆弱性（DOMPurifyのバイパス、サードパーティスクリプト汚染、Next.js依存の脆弱性等）が発生した場合、攻撃者はアクセストークンを窃取し60分間有効な認証セッションを取得できる
- アクセストークンのサーバーサイドブロックリストが存在しないため（4.2節）、窃取後のトークンを即座に無効化できない
- `tenant_admin` や `platform_admin` ロールのトークンが窃取された場合の影響は甚大

**対策**:
- アクセストークンも HttpOnly Cookie（SameSite=Strict）での保存に変更することを検討する
- または、アクセストークンをメモリ内（Reactのstate等）にのみ保持し、ページリロード時にリフレッシュトークンから再取得するパターンを採用する
- アクセストークンの有効期限短縮（60分→15分以下）を合わせて検討する

---

## Significant Findings

### SIGNIFICANT-1: 監査ログ — 認証失敗・権限変更の記録要件が未定義

**対象セクション**: 8.4 監査ログ、9.4 セキュリティ要件

**問題詳細**:
8.4節では監査ログとしてテナント登録・停止、商品公開切り替え、注文ステータス変更、ユーザーデータエクスポートの4種類を明示している。しかし、セキュリティ上最重要な以下のイベントについて、記録要件が具体的に設計されていない:

- **認証失敗**: 記録されるべきIPアドレス、試行ユーザー、失敗回数等のフィールドが未定義
- **権限変更（ロール変更）**: ロールの付与・剥奪イベントとその変更者・対象者の記録設計がない
- **機密データアクセス**: 管理者による全テナントデータアクセスの記録設計がない

9.4節には「認証失敗・権限変更等の重要イベントをアプリケーションログに記録する」と要件として記載されているが、8.4節の監査ログ設計にはこれらが反映されていない。要件と設計の間に乖離がある。

さらに、監査ログを「アプリケーションの通常ログと同一のCloudWatch Logsストリーム」に出力する設計となっており、監査証跡として必要な完全性・不可否認性が担保されない。

**影響分析**:
- セキュリティインシデント発生時（不正アクセス、内部犯行）に攻撃者の行動追跡が困難になる
- ログとアプリケーションログが混在することで、監査ログの改ざん・削除がアプリケーション管理者によって可能になる
- GDPR・個人情報保護法のもとで個人データアクセスの記録要件が満たされない可能性がある

**対策**:
- 認証失敗（失敗時刻・対象ユーザーID・送信元IP・失敗回数）、権限変更（変更者・対象者・変更前後ロール・タイムスタンプ）、機密データアクセス（アクセス者・対象データ種別・操作内容）を監査ログの明示的な記録対象として設計書に追記する
- 監査ログを通常アプリケーションログと分離した専用ストリームに出力し、アクセス制御を独立させる

---

### SIGNIFICANT-2: 認証失敗ログの独立記録設計の欠如

**対象セクション**: 8.4 監査ログ、4.4 認証エンドポイント

**問題詳細**:
認証エンドポイント（`/api/auth/login`、`/api/auth/refresh`、`/api/auth/register`）における認証失敗イベントについて、監査ログへの記録フィールド・記録トリガー・保存先が設計されていない。SIGNIFICANT-1と一部重複するが、ここでは特に「認証失敗の独立した検出・対応フロー」の欠如を指摘する。

**影響分析**:
- ブルートフォース攻撃・クレデンシャルスタッフィング攻撃の検出が困難になる
- リフレッシュトークンエンドポイントへの乱用（トークン窃取後の継続使用試行）が記録されない

**対策**:
- 認証失敗イベントを、関連するIPアドレスおよびアカウント識別子とともに記録する設計を追加する
- 異常な失敗頻度を検出してアラートを発するフローを設計に含める

---

### SIGNIFICANT-3: CORS設定の正規表現マッチによるサブドメイン汚染リスク

**対象セクション**: 6.4 CORS設定

**問題詳細**:
許可オリジンを `*.nexamart.com` の正規表現マッチ（`/\.nexamart\.com$/`）で判定しており、`credentials: true` との組み合わせで使用している。この正規表現は `evil.nexamart.com` 等の任意のサブドメインを許可する。Nexamartではテナントごとにサブドメインを発行する設計（`{tenant-slug}.nexamart.com`）であり、悪意のあるテナントが登録されると、そのサブドマインから他テナントのエンドユーザーのCookieを含むクレデンシャルリクエストを発行可能になる。

**影響分析**:
- 悪意のあるテナントが作成したコンテンツ（例: XSSペイロードを含む商品説明）を通じて、他のエンドユーザーのリフレッシュトークンCookieを含むAPIリクエストが発行される恐れがある
- マルチテナント環境では信頼できないサブドメインを許可することは、クロステナント攻撃の起点となりうる

**対策**:
- 許可オリジンを明示的な許可リスト（`admin.nexamart.com`、`app.nexamart.com` 等のプラットフォームドメイン）に限定する
- テナントサブドメインからのAPIアクセスが必要な場合は、許可するサブドメインをKYC審査済みのテナントスラッグに限定した動的ホワイトリストで管理する設計を検討する

---

### SIGNIFICANT-4: アクセストークン即時無効化不能 — 権限変更・不正検知時

**対象セクション**: 4.2 セッション管理

**問題詳細**:
「不正検知や権限変更が発生した場合のトークン即時無効化は、リフレッシュトークンの期限切れに依存する設計」と明記されている。アクセストークン（有効期限60分）のサーバーサイドブロックリストは存在しない。

**影響分析**:
- ユーザーのロールを `tenant_admin` から `buyer` に降格しても、既発行アクセストークンは最大60分間旧権限で有効であり続ける
- 不正アクセスが検知されてアカウントを無効化しても、攻撃者は最大60分間操作を継続できる
- プラットフォーム管理者が `tenant_admin` を停止させた場合でも、既存セッションが60分残存する

**対策**:
- 権限変更・アカウント停止イベント発生時にアクセストークンを即時無効化するサーバーサイドのブロックリスト（Redisでリフレッシュトークンのブラックリストと同様）を設計する、またはアクセストークンの有効期限を大幅に短縮（5〜15分）する

---

### SIGNIFICANT-5: Stripe Webhookエンドポイントの署名検証設計の欠如

**対象セクション**: 7.3 外部サービス連携

**問題詳細**:
Stripe Webhookエンドポイント `/api/webhooks/stripe` についての記述があるが、Stripe-Signatureヘッダーを用いたWebhookペイロードの署名検証設計が記載されていない。

**影響分析**:
- 署名検証なしでは、攻撃者が任意のJSONペイロードを `/api/webhooks/stripe` に送信することで、決済済みイベントを偽造し、支払いなしに注文を「支払い完了」状態に更新できる可能性がある
- これは重大な金融詐欺リスクである

**対策**:
- Stripeが提供する署名検証機能（`stripe.webhooks.constructEvent()`）を使用し、全Webhookリクエストの署名を検証する設計を明示する

---

## Moderate Findings

### MODERATE-1: ファイルアップロードのMIMEタイプ検証欠陥

**対象セクション**: 6.5 ファイルアップロード

**問題詳細**:
MIME型チェックが `Content-Type` ヘッダーのみで行われており、拡張子検証およびファイルコンテンツのマジックバイト検証が設計されていない。ウイルススキャンも「将来対応」とされており未導入。

**影響分析**:
- 攻撃者は `Content-Type: image/jpeg` ヘッダーを設定しながらPHPスクリプト等を含むファイルをアップロードできる
- S3を経由した場合でも、CloudFrontでファイルが配信される際に実行可能ファイルが一般公開される恐れがある（パブリックバケットに保存される商品画像の場合）
- multer@1.4.4 は既知の脆弱性が存在するバージョンである（後述）

**対策**:
- サーバーサイドでマジックバイトによるファイルタイプ検証を実施する設計を追加する
- 許可する拡張子のホワイトリスト（`.jpg`, `.jpeg`, `.png`, `.webp`等）を設計に明示する
- S3へのアップロード後にAWS Lambda等でウイルススキャン（Amazon Malware Protection for S3）を実施する設計を検討する

---

### MODERATE-2: 依存ライブラリの脆弱性 — multer@1.4.4

**対象セクション**: 8.2 依存ライブラリ管理、6.5 ファイルアップロード

**問題詳細**:
multer@1.4.4 が使用されているが、このバージョンには既知の脆弱性が存在する。また、Presigned URL経由でのクライアント直接アップロードを採用しているにもかかわらず、multer（サーバーサイドのマルチパート処理ライブラリ）が依然として依存関係に含まれている設計となっており、使用箇所が不明確である。

**影響分析**:
- 脆弱なバージョンのmulterを使用することで、マルチパートリクエスト処理における既知の攻撃ベクターにさらされる
- 四半期ごとのセキュリティアップデート計画では対応が遅れる恐れがある

**対策**:
- Presigned URLによる直接アップロードを採用している場合、multerの使用箇所を設計で明確化し、不要であれば依存を除去する
- 使用が必要な場合はmulterを最新バージョンにアップグレードし、継続的な自動脆弱性スキャン（Dependabot、Snyk等）を設計に組み込む

---

### MODERATE-3: 個人情報フィールドレベル暗号化の未実施

**対象セクション**: 5.1 保存データの暗号化

**問題詳細**:
氏名・住所・電話番号等のPIIを平文で保存し、RDSのTDE（Transparent Data Encryption）のみで保護する設計となっている。設計書では「RDS暗号化により保護されているため、フィールドレベルでの追加暗号化は不要」と判断されている。

**影響分析**:
- TDEはAWSインフラ侵害（KMSキー漏洩等）に対しては保護されるが、アプリケーションの脆弱性経由でDBに直接アクセスされた場合（SQLインジェクション、接続情報漏洩）には全PII平文が露出する
- マルチテナント環境では、アプリケーションバグで他テナントのユーザーPIIが平文で取得される可能性がある

**対策**:
- 高感度PII（電話番号、住所）については、アプリケーション層でのフィールドレベル暗号化（AWS KMS Data Key等）を検討する
- 少なくとも、TDEのみで十分とする根拠（脅威モデル上の想定）を設計書に明記する

---

### MODERATE-4: データ保持期間・削除方針の未定義

**対象セクション**: 5.3 個人情報（PII）管理

**問題詳細**:
データ保持期間および削除方針が「現時点では未定義」「今後設計する」とされており、本設計書には記載がない。

**影響分析**:
- 退会ユーザーのPIIが無期限に保存され続けるリスクがある
- GDPR（忘れられる権利）、個人情報保護法等のコンプライアンス要件を満たさない可能性がある
- テナント契約終了後のデータ扱いも未定義であり、テナントデータの不正な残存リスクがある

**対策**:
- 退会申請時のデータ削除フロー（即時削除or猶予期間後削除）、テナント契約終了時のデータ扱い、法的保存義務のある期間の定義を設計書に追記する

---

### MODERATE-5: 認証エンドポイントのレート制限設計の欠如

**対象セクション**: 4.4 認証エンドポイント

**問題詳細**:
ログインエンドポイント（`/api/auth/login`）、パスワードリセット相当フロー、リフレッシュトークンエンドポイント（`/api/auth/refresh`）に対するレート制限設計が記載されていない。

**影響分析**:
- ブルートフォース攻撃によるパスワードクラッキングが制限なく実行できる
- クレデンシャルスタッフィング攻撃（漏洩したパスワードリストの自動試行）に対する防御がない
- リフレッシュトークンへの繰り返しアクセスで不正なセッション延長が試みられる恐れがある

**対策**:
- Kong ゲートウェイのレート制限プラグインを認証エンドポイントに適用し、IPアドレスまたはアカウント単位での試行回数制限を設計に明示する
- アカウントロックアウトポリシー（N回連続失敗でアカウント一時ロック）を認証フロー設計に含める

---

## Minor Findings / Positive Aspects

### MINOR-1: 署名付きURLの有効期限が過長

**対象セクション**: 5.4 S3ストレージセキュリティ

**問題詳細**:
請求書・契約書類の署名付きURLの有効期限が7日間と設定されている。機密性の高い文書としては長すぎる有効期限であり、URLが第三者に漏洩した場合の露出時間が長い。

**対策**: 有効期限を1時間〜24時間に短縮することを検討する。

---

### Positive Aspects

- **入力検証**: バックエンド全体でZodスキーマ検証とPrisma ORMのパラメータ化クエリを採用しており、SQLインジェクション対策が適切に設計されている
- **XSS対策**: JSXによる自動エスケープ、CSPヘッダー設定、DOMPurifyによるリッチテキストサニタイズの多層防御が設計されている
- **パスワード保護**: bcrypt cost factor 12 という適切な設定でパスワードをハッシュ化している
- **シークレット管理基盤**: AWS Secrets Managerを基本とするシークレット管理基盤は適切（ただし `config/secrets.prod.yaml` の問題はCRITICAL-1として別途指摘）
- **ネットワーク分離**: ECSコンテナのプライベートサブネット配置、VPN必須の管理コンソールアクセス、Security Groupによる最小権限設計が適切
- **リフレッシュトークン保護**: リフレッシュトークンのHttpOnly Cookie保存とログアウト時のRedisブラックリスト登録は適切な設計

---

## Summary

| 深刻度 | 件数 |
|--------|------|
| Critical | 3 |
| Significant | 5 |
| Moderate | 5 |
| Minor | 1 |

最優先で対処すべき問題は、本番シークレットのリポジトリ保存（CRITICAL-1）、テナント分離のアプリケーション層のみへの依存（CRITICAL-2）、アクセストークンのlocalStorage保存（CRITICAL-3）の3点である。また、監査ログにおける認証失敗・権限変更の記録要件が設計から欠落している点（SIGNIFICANT-1、SIGNIFICANT-2）は、セキュリティ要件（9.4節）と設計（8.4節）の間の乖離として早急に解消が必要である。
