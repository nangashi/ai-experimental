# Security Design Review: Nexamart プラットフォーム システム設計書 v1.4.0

**Reviewer**: security-design-reviewer (v003-variant-input-validation-independence)
**Document**: test-document-2.md
**Run**: doc2-run1

---

## Critical Issues

### C-01: アクセストークンのlocalStorage保存によるXSS窃取リスク（第4.1節）

**Issue**: JWTアクセストークンをブラウザの `localStorage` に保存する設計になっている。XSS攻撃が成立した場合、`localStorage` の内容はJavaScriptから完全に読み取り可能であり、攻撃者がトークンを窃取してなりすましを行える。

**Impact**: アクセストークン窃取によるセッションハイジャック。60分間の有効期間中、被害者のすべての権限を攻撃者が行使できる。特に `tenant_admin` や `platform_admin` のトークンが窃取された場合、テナントデータへの不正アクセスや全システム管理権限の奪取につながる。

**Countermeasures**:
- アクセストークンも `HttpOnly; Secure; SameSite=Strict` のCookieに保存する
- あるいはインメモリ（変数）のみで保持し、ページリロード時はリフレッシュトークンで再発行する設計に変更する

---

### C-02: CSRF対策の独立性欠如 ― JWT-in-Authorization-Header方式の前提依存（第6.3節）

**Issue**: 「AuthorizationヘッダーにJWTを付与することを必須とするため、CSRF対策として十分」と設計されているが、この評価は防御の独立性を欠いている。

**Defense Layer Independence Assessment**:
- **JWT-in-Authorization-Header方式はCSRFを防止できる**という判断は、アクセストークンが `localStorage` に保存されている（第4.1節）ことを前提にしている
- しかし本設計ではアクセストークンを `localStorage` に保存しているため、XSSが成立するとトークン窃取とCSRF相当の攻撃が同時に可能になる
- さらに重要なのは: リフレッシュトークンは `HttpOnly Cookie` に保存されており、もしリフレッシュエンドポイント（`POST /api/auth/refresh`）がCookieから自動的にトークンを読み取る設計であれば、そのエンドポイント自体がCSRF攻撃の対象になりうる
- **CSRF保護がJWTのストレージ場所に依存している**という点で、これは独立した防御制御ではない。アクセストークンのストレージ方式が変わった時点でCSRF保護が崩壊する設計

**Impact**: リフレッシュエンドポイントへのCSRF攻撃によるセッション延長の強制、または将来的な設計変更時の保護喪失。

**Countermeasures**:
- state-changing APIエンドポイントに対してCSRFトークン（Synchronizer Token Pattern）または `SameSite=Strict` Cookie属性を独立した制御として明示的に設計する
- リフレッシュエンドポイントに対してCSRF保護を別途設計する
- CSRF保護の設計は、トークンのストレージ場所に依存しない独立した制御として記述する

---

### C-03: 本番シークレットのリポジトリ格納（第8.1節）

**Issue**: 「本番環境のシークレット値はデプロイ担当者の参照用に `config/secrets.prod.yaml` へも記録し、アクセス制限を設けたうえでリポジトリに含める」と設計されている。

**Impact**: gitリポジトリへのアクセス権を持つすべての開発者・CI/CDシステム・外部コントリビューターがJWT署名鍵・DBパスワード・外部APIキーにアクセスできる。AWS Secrets Managerを使用しているにもかかわらずその保護を無効化している。リポジトリへの不正アクセスや意図しない公開（publicリポジトリへの誤変更等）により全シークレットが漏洩する。

**Countermeasures**:
- `config/secrets.prod.yaml` をリポジトリから即時削除し、`.gitignore` に追加する
- デプロイ担当者はAWS Secrets Managerのコンソールまたは `aws secretsmanager get-secret-value` CLI経由でシークレットを参照する運用に変更する
- CI/CDパイプラインはIAMロールベースでSecrets Managerから動的取得する

---

### C-04: テナントIDの信頼モデルにおけるヘッダーインジェクションリスク（第3.2節）

**Issue**: 「Kong ゲートウェイが付与する `X-Tenant-ID` ヘッダーはエンドユーザーのリクエストでは検証済みの値として扱われ、コアAPIサービスはこの値を信頼してデータアクセスの絞り込みに使用する」と設計されている。コアAPIサービスは「ゲートウェイを通過したリクエストを信頼済みとして処理する」（第3.3節）とも記述されている。

**Impact**: コアAPIサービスが直接呼び出せる（ゲートウェイをバイパスできる）場合、攻撃者は任意の `X-Tenant-ID` を付与して別テナントのデータにアクセスできる。ECSコンテナがプライベートサブネットに配置されているが（第8.3節）、内部ネットワーク上の攻撃者や誤設定によるバイパスが生じた際の影響が最大となる設計。マルチテナント分離の根幹が単一ヘッダーの信頼に依存している。

**Authorization Checklist**:
- コアAPIサービス側でJWTクレームとX-Tenant-IDの照合を行う設計は記述されているが（第4.3節）、この照合が確実に全エンドポイントで実施されるかが設計書から不明確

**Countermeasures**:
- コアAPIサービスはX-Tenant-IDヘッダーに加え、JWT内の `tenantId` クレームとの一致確認を必須とし、不一致の場合は403を返す設計を明示する
- テナント分離の確認をミドルウェアレベルで一元化し、全エンドポイントに自動適用する設計を記述する
- コアAPIサービスへの直接アクセスをネットワークレベル（Security Group）でゲートウェイからのみに制限することを明示する

---

## Significant Issues

### S-01: アクセストークン即時失効機能の欠如（第4.2節）

**Issue**: 「アクセストークンの失効管理はトークン有効期限のみで実施（サーバーサイドのブロックリストなし）」「不正検知や権限変更が発生した場合のトークン即時無効化は、リフレッシュトークンの期限切れに依存する」と設計されている。

**Impact**: テナント管理者を降格させた場合や、アカウント侵害を検知した場合でも、アクセストークン（60分有効）が有効期間中は引き続き全権限で動作する。`tenant_admin` ロールの剥奪後も60分間、管理操作が継続できる。

**Countermeasures**:
- Redis等を用いたトークンブロックリストをアクセストークンにも適用する
- または有効期限を5〜15分に短縮し、リフレッシュフローを頻繁にする設計に変更する

---

### S-02: 認証エンドポイントのレートリミット未設計（第4.4節、第6節）

**Issue**: `/api/auth/login`、`/api/auth/register`、`/api/auth/refresh` に対するレートリミットが設計されていない。

**Authentication Endpoint Protection Checklist**:
- Login: レートリミット設計なし（ブルートフォース対策なし）
- Register: レートリミット設計なし（アカウント大量生成対策なし）
- Token refresh: 乱用防止機構の設計なし
- Password reset: エンドポイント自体が設計書に存在しない（将来追加時のリスク）

**Impact**: パスワードのブルートフォース攻撃、大量アカウント生成によるリソース枯渇、リフレッシュトークン総当たりによるセッション乗っ取り試行。

**Countermeasures**:
- KongゲートウェイのRate Limitingプラグインで各認証エンドポイントにリクエスト制限を設ける（例: ログインは同一IPから60秒間に10回）
- ログイン失敗回数によるアカウントロックアウト機能を設計する

---

### S-03: ファイルアップロードのMIME型チェックがContent-Typeヘッダーのみに依存（第6.5節）

**Issue**: 「MIME型チェック: `Content-Type` ヘッダーによる判定のみ（拡張子検証なし）」と設計されている。Content-Typeヘッダーはクライアントが任意に設定できるため、独立した検証制御として機能しない。

**Defense Layer Independence Assessment**:
- Content-TypeヘッダーはHTTPリクエスト中にクライアントが設定する値であり、攻撃者は `Content-Type: image/jpeg` を付与しながら実際にはPHPスクリプトやHTMLファイルをアップロードできる
- この検証は「独立して有効」ではなく、クライアントの正直さに依存した検証であり、設計上の弱点

**Impact**: 悪意のあるファイル（スクリプト、HTML等）のアップロードによるサーバーサイドの攻撃（S3経由での配信を通じたXSS/フィッシング）。multer@1.4.4には既知の脆弱性（ReDoS等）が報告されており、バージョンアップデートも必要。

**Countermeasures**:
- ファイルの実際のバイナリシグネチャ（マジックバイト）を検証するサーバーサイドチェックを追加する（`file-type` ライブラリ等）
- 拡張子の許可リスト検証を独立したサーバーサイド制御として追加する
- multerを最新バージョンへアップデートする
- S3アップロード後のウイルススキャン（AWS Macie、ClamAV等）を設計に組み込む

---

### S-04: CORS設定の正規表現による許可オリジン判定の脆弱性（第6.4節）

**Issue**: 許可オリジンの判定に `/\.nexamart\.com$/` を使用している。この正規表現は末尾マッチであり、`evil-nexamart.com` や `attackernexamart.com` は弾けるが、ドットのエスケープが正しく行われているため一見問題ないように見える。しかし実装方針のコードでは `allowedOrigin.test(origin)` を使用しており、`origin` が `null` または空文字の場合の処理が明記されていない。

**Impact**: Originヘッダーが `null`（サンドボックスiframe等）の場合に意図しない許可が発生するリスク。`Access-Control-Allow-Credentials: true` と組み合わせているため、不正なオリジンからのCookieを含むクロスオリジンリクエストが許可される可能性がある。

**Countermeasures**:
- originが `null`、空文字、または `undefined` の場合はデフォルトで拒否する処理を明示する
- 許可オリジンをホワイトリスト（Set）で管理し、完全一致で判定する方式を推奨する
- `Access-Control-Allow-Credentials: true` を設定する際は、オリジン検証の厳密性を特に高める

---

### S-05: Stripe Webhookエンドポイントの署名検証が未記述（第7.3節）

**Issue**: `/api/webhooks/stripe` エンドポイントについて、「イベント受信後、支払いステータスを注文に反映する」とあるが、Stripe Webhookの署名検証（`stripe-signature` ヘッダーの検証）の設計が記述されていない。

**Impact**: 攻撃者が `/api/webhooks/stripe` に偽のWebhookイベントを送信することで、支払い未完了の注文を支払い済みに変更できる。これは直接的な詐欺行為につながる重大な財務リスク。

**Countermeasures**:
- Stripeが提供する `stripe.webhooks.constructEvent()` を用いた署名検証を必須として設計書に明示する
- WebhookエンドポイントへのレートリミットとIPホワイトリスト（Stripeの公開IPレンジ）を設計に追加する

---

## Moderate Issues

### M-01: 監査ログの認証失敗・ロール変更イベントが参照先と実装内容で不整合（第8.4節・第9.4節）

**Issue**: 第8.4節の監査ログ対象イベントに「認証失敗」「ロール変更」が含まれていないが、第9.4節のセキュリティ要件では「認証失敗・権限変更等の重要イベントをアプリケーションログに記録する」と記述されている。また「セキュリティ要件（7.4節）に従い実施する」という参照先が存在しない（設計書に7.4節はない）。

**Impact**: セキュリティ監査に必要なイベントが実際に記録されるかが不明確。インシデント発生時の追跡不能。

**Countermeasures**:
- 監査ログ対象イベントを第8.4節に一元化し、認証失敗・ロール変更・テナント管理者の重要操作を明示的に追加する
- 監査ログ専用のCloudWatch Logsストリームを分離し、通常ログと混在させない設計を検討する

---

### M-02: 個人情報フィールドのRDS暗号化のみへの依存（第5.1節）

**Issue**: 「個人情報（氏名・住所・電話番号等）は平文で保存する。RDS暗号化により保護されているため、フィールドレベルでの追加暗号化は不要」と設計されている。

**Defense Layer Independence Assessment**:
- RDS TDEはディスク盗難から保護するが、DBへの正規アクセス権を持つプロセス・ユーザー（アプリケーションサービス、DBAdminロール）からはデータが平文で見える
- SQLインジェクション攻撃が成立した場合、TDEは完全に無効化される
- この保護は「独立した制御」ではなく、RDS暗号化という単一レイヤーのみに依存している

**Impact**: アプリケーション層でのSQLインジェクション、内部不正、DBアクセス権限の侵害により全PII（数百万ユーザー分の氏名・住所・電話番号）が平文で流出するリスク。

**Countermeasures**:
- 特に住所・電話番号等の高感度PIIについてはアプリケーションレベルの暗号化（AES-256-GCM等）を追加する
- フィールドレベル暗号化の採否判断をリスク評価とともに設計書に明示する

---

### M-03: データ保持期間・削除方針が未定義（第5.3節）

**Issue**: 「データ保持期間・削除方針: 現時点では未定義。退会申請があった場合の対応フローは今後設計する」と記述されている。

**Impact**: GDPR・個人情報保護法等のコンプライアンス違反リスク。退会ユーザーのPIIが無期限に保持される状態になる。マルチテナントプラットフォームとして複数のテナントが扱うエンドユーザーデータが対象となるため、法的リスクが高い。

**Countermeasures**:
- 保持期間（例: 退会後6ヶ月）と削除フロー（論理削除 → 物理削除スケジュール）を設計書に追加する
- テナントが退会した場合のテナントデータの扱いも明示する

---

## Minor Issues / Positive Aspects

### Minor: 依存ライブラリの脆弱性スキャン頻度（第8.2節）

四半期ごとの確認は最低限の基準であり、高リスクなWebアプリケーションには不十分。`npm audit`またはDependabotによる継続的な自動スキャンの導入を推奨する。multer@1.4.4は既知の脆弱性があるため早急なアップデートが必要。

### Positive: バックエンドでのZodスキーマ検証（第6.1節）

バックエンドAPIがすべてのリクエストパラメータをZodで検証する設計は、サーバーサイドでの独立した入力検証として適切に機能する。クライアントサイドの検証に依存せず、バックエンドで独立して動作する点は正しい設計。

### Positive: シークレット管理の基本設計（第8.1節 ― `secrets.prod.yaml` を除く）

AWS Secrets Managerを用いたシークレット管理とECSタスク定義での環境変数注入は適切な設計。ただし `config/secrets.prod.yaml` のリポジトリ格納（C-03）により、この保護が無効化されている点は重大問題として対処が必要。

### Positive: 境界セキュリティの基本設計

ECSプライベートサブネット配置、VPN必須の管理コンソールアクセス、Security Groupによる最小権限通信制御は適切なネットワーク境界設計。

---

## STRIDE Threat Modeling Summary

| 脅威カテゴリ | 評価 | 主要所見 |
|------------|------|---------|
| Spoofing（なりすまし） | 要改善 | localStorageトークン窃取リスク（C-01）、即時失効なし（S-01） |
| Tampering（改ざん） | 要改善 | Webhook署名検証未記述（S-05）、テナントID偽装リスク（C-04） |
| Repudiation（否認） | 要改善 | 監査ログの不整合（M-01）、認証失敗ログが確実でない |
| Information Disclosure（情報漏洩） | 要改善 | シークレットのリポジトリ格納（C-03）、PII平文保存（M-02） |
| Denial of Service（サービス妨害） | 要改善 | 認証エンドポイントのレートリミットなし（S-02） |
| Elevation of Privilege（権限昇格） | 要改善 | テナントID信頼モデルの脆弱性（C-04）、アクセストークン即時失効なし（S-01） |
