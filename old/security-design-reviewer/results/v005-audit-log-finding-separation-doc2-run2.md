# Security Design Review: Nexamart プラットフォーム システム設計書 v1.4.0

**Reviewer**: security-design-reviewer (v005-variant-audit-log-finding-separation)
**Document**: test-document-2.md
**Run**: doc2-run2

---

## Critical Findings

### CRITICAL-01: 本番環境シークレットのリポジトリへの格納

**対象箇所**: §8.1 シークレット管理

**問題内容**: 本番環境のシークレット値（DBパスワード、外部APIキー、JWT署名鍵）を `config/secrets.prod.yaml` として「アクセス制限を設けたうえでリポジトリに含める」と設計している。AWS Secrets Manager で管理するとしながら、その実際の値をリポジトリにも格納する設計は、シークレット管理の二重管理を招き、リポジトリへの不正アクセスがあった場合に全シークレットが漏洩するリスクがある。

**影響**: リポジトリ権限を持つ開発者・CI/CDシステム等が本番シークレットへアクセス可能となる。JWT署名鍵の漏洩は任意の認証トークン偽造に直結する。

**対策**: `config/secrets.prod.yaml` をリポジトリから除外し、シークレットはAWS Secrets Managerのみで管理する。デプロイ担当者の参照が必要な場合はSecrets ManagerのコンソールまたはIAM権限制御で対応する。

---

### CRITICAL-02: マルチテナント分離のアプリケーション層依存による横断アクセスリスク

**対象箇所**: §3.2 マルチテナント分離方式

**問題内容**: テナント分離を「アプリケーション層でのクエリフィルタリング」のみで実現している。全テーブルで `tenant_id` カラムを共有スキーマに格納し、クエリフィルタリングに依存する構造では、フィルタリングの実装漏れや`X-Tenant-ID`ヘッダー操作が起きた場合に他テナントデータへのアクセスが可能となる。

**影響**: テナントAの従業員がテナントBの商品・注文・ユーザーデータを閲覧・改ざんできる可能性がある。マルチテナントプラットフォームとして最も深刻なデータ漏洩リスク。

**対策**: Row Level Security (RLS) をPostgreSQLで設定し、DBレイヤーでもテナント分離を強制する。アプリケーション層とDB層の二重チェックを設計に明示する。

---

### CRITICAL-03: アクセストークンの即時無効化不能設計

**対象箇所**: §4.2 セッション管理

**問題内容**: アクセストークン（有効期限60分）の失効管理をトークン有効期限のみで実施し、サーバーサイドのブロックリストが存在しない。不正検知や権限変更時のトークン即時無効化をリフレッシュトークンの期限切れに依存すると明記しており、権限変更後最大60分間は旧権限でのアクセスが継続可能となる。

**影響**: テナント管理者の権限剥奪後も60分間は管理者権限でAPIを呼び出し可能。アカウント侵害を検知しても即座の遮断ができない。

**対策**: アクセストークンをRedisのブロックリストで管理し、強制ログアウト・権限変更時に即時無効化できる設計を追加する。または有効期限を5〜10分に短縮し、リフレッシュトークンのブラックリスト管理と組み合わせる。

---

## Significant Findings

### SIGNIFICANT-01: アクセストークンのlocalStorage保存によるXSSリスク

**対象箇所**: §4.1 認証フロー

**問題内容**: JWTアクセストークンをブラウザの `localStorage` に保存する設計となっている。XSS脆弱性が存在した場合、`localStorage` はJavaScriptから完全にアクセス可能であり、攻撃者がトークンを窃取できる。

**影響**: XSSと組み合わせることでセッションハイジャックが成立する。CSP設定（§6.2）があるが、XSS完全防止は困難であり、トークンストレージの安全性が前提となる。

**対策**: アクセストークンも `HttpOnly` Cookie として保存し、JavaScriptからアクセス不可能にする。Authorizationヘッダー方式を維持するならService WorkerやIn-Memoryストレージを検討する。

---

### SIGNIFICANT-02: CSRF対策としてのJWT単独依存の不十分性

**対象箇所**: §6.3 CSRF対策

**問題内容**: CSRF対策をAuthorizationヘッダーへのJWT付与のみに依存している。アクセストークンが `localStorage` に保存される場合、悪意あるサイトからのフォーム送信ではAuthorizationヘッダーを付与できないためCSRF防止効果があるが、Cookie保存に切り替えた場合や将来の設計変更時に保護が完全に失われる。また、JWTがCSRF対策として「十分」と判断する根拠が設計書に明示されていない。

**影響**: 設計変更時の安全性が保証されない。CSRF専用の対策層が存在しないため、単一ポイントの障害となる。

**対策**: SameSite=Strict/Lax Cookie属性を明示的に設計するか、CSRFトークンを独立した対策として追加する。JWTのCSRF防止効果への依存を文書化し、前提条件（localStorage保存）を明記する。

---

### SIGNIFICANT-03: CORS設定の正規表現マッチによるサブドメインテイクオーバーリスク

**対象箇所**: §6.4 CORS設定

**問題内容**: 許可オリジンを `*.nexamart.com` の正規表現マッチ（`/\.nexamart\.com$/`）で実装している。この実装はサブドメインのすべてを許可するため、未使用または攻撃者がコントロール可能なサブドメイン（例: `attacker.nexamart.com`）からのリクエストも認証情報付きで許可される。また `Access-Control-Allow-Credentials: true` と組み合わせており、クロスオリジンからのCookie送信も可能となる。

**影響**: サブドメインテイクオーバー攻撃が成立した場合、攻撃者のサブドメインから認証情報付きのAPIリクエストが可能となる。

**対策**: 許可するオリジンを明示的な許可リスト（ホワイトリスト）方式に変更する。`nexamart.com`、`admin.nexamart.com`、`*.nexamart.com`（テナントサブドメイン）のいずれかをパターンマッチではなく列挙または動的サブドメイン検証で管理する。

---

### SIGNIFICANT-04: 認証ログイン・登録エンドポイントへのレートリミット未設計

**対象箇所**: §4.4 認証エンドポイント

**問題内容**: `/api/auth/login`、`/api/auth/register`、`/api/auth/refresh` エンドポイントに対してレートリミットの設計が存在しない。ブルートフォース攻撃やパスワードスプレー攻撃に対する防御が設計されていない。

**影響**: エンドユーザーおよびテナント管理者アカウントへのブルートフォース攻撃が無制限に実行可能。トークンリフレッシュエンドポイントへの大量リクエストによるDoSも可能。

**対策**: Kong ゲートウェイまたはアプリケーション層でIPベースおよびアカウントベースのレートリミットを設計する。ログインエンドポイントには一定回数失敗後のアカウントロックアウトまたは指数バックオフを設計する。

---

### SIGNIFICANT-05: ファイルアップロードのMIME型検証不足

**対象箇所**: §6.5 ファイルアップロード

**問題内容**: ファイルアップロードの検証を `Content-Type` ヘッダーのみに依存している。`Content-Type` ヘッダーはクライアントが自由に設定可能であり、拡張子検証もなく、ウイルススキャンも「将来対応」とされている。S3への直接アップロード（Presigned URL）のため、バックエンドはアップロード後のファイル内容を検証していない。

**影響**: 悪意あるファイル（実行可能ファイル、スクリプト等）をMIME型を偽って画像としてアップロード可能。パブリックバケットに格納される商品画像は公開URLで配信されるため、マルウェア配布の踏み台となりうる。

**対策**: S3アップロード後にAWS Lambda等でサーバーサイドのファイルマジックバイト検証を実施する。ウイルススキャン（Amazon Macie、ClamAV等）を早期に導入する設計を追加する。Presigned URL生成時に許可するContent-Typeを厳格に制限し、拡張子との整合性チェックをバックエンドで設計する。

---

### SIGNIFICANT-06: Stripe Webhookエンドポイントの署名検証設計の欠如

**対象箇所**: §7.3 外部サービス連携

**問題内容**: `/api/webhooks/stripe` エンドポイントについて、Stripeからのリクエストの正当性を検証する設計（Stripe-Signature ヘッダーによるHMAC検証）が記載されていない。

**影響**: 攻撃者がStripe Webhookを偽装して任意の支払いステータスを注文に反映させることが可能となり、未払い注文を支払い済みに変更するなどの不正が成立しうる。

**対策**: StripeのWebhook署名検証（`stripe.webhooks.constructEvent`）を実装することを設計書に明示する。Webhookエンドポイントへの認証チェックを設計に追加する。

---

## Moderate Findings

### MODERATE-01: 個人情報フィールドのフィールドレベル暗号化未実施

**対象箇所**: §5.1 保存データの暗号化

**問題内容**: 氏名・住所・電話番号等の個人情報を平文で保存し、「RDS暗号化により保護されているため、フィールドレベルでの追加暗号化は不要」と判断している。RDS TDEはストレージレイヤーの暗号化であり、DBへのアクセス権限を持つユーザー（DBA、侵害されたアプリケーション等）には平文で見える。

**影響**: DBアクセス権限を持つ内部者または侵害されたアプリケーションサービスから全ユーザーの個人情報が平文で参照可能。マルチテナント環境ではテナント横断的な個人情報漏洩リスクがある。

**対策**: 氏名・住所・電話番号等の機密フィールドにAES-256等によるアプリケーションレベルの暗号化を追加し、AWS KMSで鍵管理する設計を検討する。

---

### MODERATE-02: PII保持期間・削除ポリシーの未定義

**対象箇所**: §5.3 個人情報（PII）管理

**問題内容**: データ保持期間と削除方針が「現時点では未定義」とされており、退会申請時の対応フローも未設計となっている。

**影響**: GDPRや個人情報保護法（日本）における「忘れられる権利」への対応が設計段階で未考慮。退会ユーザーの個人情報が無期限に保存され続ける。マルチテナントプラットフォームとして規制対応のリスクが高い。

**対策**: 保持期間（例: 退会後N年）と削除方針（物理削除/匿名化）を設計に定義する。退会申請受信から実行までのフローを設計書に追加する。

---

### MODERATE-03: 依存ライブラリの脆弱性スキャン頻度不足

**対象箇所**: §8.2 依存ライブラリ管理

**問題内容**: セキュリティアップデートを「四半期ごとに確認・適用」と計画しており、`multer@1.4.4` を使用している。四半期ごとのスキャンでは重大な脆弱性が3ヶ月間未対応となりうる。`multer@1.4.4` はすでに古いバージョンであり既知の脆弱性が存在する可能性がある。

**影響**: 新たに発見された重大脆弱性（CVSSスコア高）への対応が最大90日間遅延する。

**対策**: GitHub DependabotやSnykによる継続的な自動脆弱性スキャンを導入し、重大度に応じて即時対応のポリシーを設計する（Critical: 即日、High: 1週間以内等）。

---

### MODERATE-04: S3署名付きURLの有効期限（7日）の過長設定

**対象箇所**: §5.4 S3ストレージセキュリティ

**問題内容**: 請求書・契約書類のプライベートバケットへの署名付きURLの有効期限が7日に設定されている。URLが漏洩した場合、7日間はアクセス可能な状態が継続する。

**影響**: URLが外部に漏洩した場合（メール誤送信、ログへの出力等）、最大7日間機密文書への不正アクセスが可能となる。

**対策**: 署名付きURLの有効期限を用途に応じて短縮する（例: 閲覧用は1時間、ダウンロード用は15分）。URLの使用回数制限やIPアドレス制限も検討する。

---

## FINDING: 監査ログの記録要件未定義（認証失敗・権限変更・機密データアクセス）

**対象箇所**: §8.4 監査ログ、§9.4 セキュリティ要件

**問題内容**: §8.4で監査ログとして記録されるイベントは「テナント登録・停止」「商品公開・非公開切り替え」「注文ステータス変更」「ユーザーデータエクスポート」の4種類である。§9.4では「認証失敗・権限変更等の重要イベントをアプリケーションログに記録する」と言及しているが、「セキュリティ要件（7.4節）に従い実施する」と参照された §7.4節は設計書に存在せず、実際の記録要件（フォーマット、保存場所、保持期間、アクセス制御）は定義されていない。

また、監査ログと通常のアプリケーションログが同一のCloudWatch Logsストリームに出力される設計では、監査ログの改ざん防止・分離保管・アクセス制御が実現できない。

**影響**:
- 認証失敗の記録がなければ、ブルートフォース攻撃やアカウント侵害の事後調査が不可能となる。
- ロール変更の記録がなければ、権限昇格の不正操作を検知・証明できない。
- 機密データ（ユーザーデータエクスポート以外）へのアクセスが追跡不可能となる。
- 監査ログと通常ログの混在により、コンプライアンス監査への対応が困難となる。

**対策**:
1. 認証失敗、権限変更（ロール付与・剥奪）、機密データアクセス（個人情報参照・エクスポート）の記録要件を独立したセクションとして設計書に明示する。
2. 監査ログ専用のCloudWatch Logsストリームを設け、通常のアプリケーションログと分離する。
3. 監査ログへのアクセス権限を限定し、ログの改ざん防止（CloudTrail等との連携）を設計する。
4. 各記録イベントに含めるべきフィールド（タイムスタンプ、アクターID、テナントID、操作内容、対象リソース、結果）を定義する。

---

## Minor Findings

### MINOR-01: 商品更新・削除APIの所有権チェック設計の不明確さ

**対象箇所**: §7.1 商品API

**問題内容**: `PUT /api/products/:id`（`tenant_admin, tenant_staff`）および `DELETE /api/products/:id`（`tenant_admin`）の認可設計において、操作対象の商品が自テナントのものであることを確認する所有権チェックの設計が明示されていない。JWTの `tenantId` クレームと対象商品の `tenant_id` の照合ロジックが設計書から読み取れない。

**対策**: 商品更新・削除APIの認可チェックに「対象商品の `tenant_id` がJWT `tenantId` クレームと一致することを検証」する旨を設計書に明示する。

---

### MINOR-02: 注文詳細APIの横断アクセス制御設計の不明確さ

**対象箇所**: §7.2 注文API

**問題内容**: `GET /api/orders/:id`（`buyer, tenant_admin`）において、buyerが自分の注文のみ参照可能であることを保証するオーナーシップチェックの設計が明示されていない。buyerが他のユーザーの注文IDを指定した場合の制御が不明確。

**対策**: 注文詳細取得APIの認可に「buyerは自分のユーザーIDと注文の `buyer_id` が一致する場合のみアクセス可能」であることを設計書に明示する。

---

### MINOR-03: CSP設定の`default-src 'self'`のみでは不十分な可能性

**対象箇所**: §6.2 XSS対策

**問題内容**: CSPが `default-src 'self'` のみ設定されている。CDN（CloudFront）や外部サービス（Stripe.js、SendGrid等）からのリソース読み込みが必要な場合、実運用で `unsafe-inline` や外部オリジンの追加が必要となりCSPが弱体化する可能性がある。

**対策**: 実際に使用する外部リソース（Stripe.js等）のオリジンをCSPに明示的に追加した完全なCSPポリシーを設計書に記載する。

---

## Positive Aspects

- bcrypt（cost factor: 12）によるパスワードハッシュ化は適切な強度設定である。
- リフレッシュトークンのHttpOnly Cookie保存とサーバーサイドブラックリスト管理は適切な設計である。
- Prisma ORMのパラメータ化クエリによるSQLインジェクション対策は堅実である。
- AWS Secrets Managerによるシークレット管理の基本方針は適切である（`config/secrets.prod.yaml` のリポジトリ格納を除く）。
- DOMPurifyによるリッチテキストサニタイズは適切な対策である。
- プライベートサブネット配置、VPN経由管理コンソールアクセス、Security Groupによる最小権限設定はネットワーク分離として適切である。
- Stripeへのクレジットカード情報委譲はPCI DSS対応として正しいアプローチである。
