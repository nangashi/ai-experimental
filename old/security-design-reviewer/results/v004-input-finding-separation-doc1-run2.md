# Security Review: MediConnect システム設計書

**Reviewer:** security-design-reviewer v004 (input-finding-separation variant)
**Document:** test-document-1.md (MediConnect システム設計書)
**Run:** run2

---

## Critical Issues

### [CRITICAL-01] JWTアクセストークンのlocalStorage保存

**Issue:** セクション5.1において、アクセストークンを `localStorage` に保存する設計が明記されている。

**Impact:** `localStorage` はXSS攻撃によって完全にアクセス可能であり、攻撃者がスクリプトインジェクションに成功した場合、医療機密データへのアクセストークンが窃取される。医療情報システムにおいては患者の診断結果・処方箋・保険情報が漏洩する最大リスクとなる。

**Countermeasure:**
- アクセストークンを `HttpOnly; Secure; SameSite=Strict` 属性のCookieで管理する
- リフレッシュトークンも同様にHttpOnly Cookieで管理する
- XSS対策としてCSPヘッダーを設定し、インラインスクリプトを禁止する

**Reference:** セクション5.1「クライアントはアクセストークンをlocalStorageに保存し」

---

### [CRITICAL-02] フロントエンド依存の入力検証（サーバーサイド検証の欠如）

**Issue:** セクション7.1において「フロントエンドで入力検証が完了した状態でAPIに送信される設計」とされ、バックエンドでは型チェックのみ実施する設計となっている。

**Impact:** APIクライアントを直接操作することでフロントエンドバリデーションを完全に迂回できる。SQLインジェクション、NoSQLインジェクション、XSSペイロードが医療カルテ（`diagnosis`、`soap_note`フィールド等）に直接挿入される可能性がある。医療情報システムとして極めて高リスクな設計欠陥である。

**Countermeasure:**
- すべてのAPIエンドポイントでサーバーサイドの入力バリデーションを必須とする
- OWASPの入力検証ガイドラインに従い、許可リスト方式での検証を実装する
- ORMのパラメータ化クエリを使用してSQLインジェクションを防止する
- XSS対策として出力エスケープ処理をサーバーサイドで実施する

**Reference:** セクション7.1「フロントエンドで入力検証が完了した状態でAPIに送信される設計とする」

---

### [CRITICAL-03] フロントエンド検証に依存するXSS/インジェクション対策の欠如（出力エスケープ未設計）

**Issue:** CRITICAL-02と関連するが独立した問題として報告する。サーバーサイドでの出力エスケープ設計が設計書に存在しない。バックエンドが「基本的な型チェックのみ」を実施する設計では、格納型XSSに対する防御レイヤーが完全に欠如している。

**Impact:** 悪意あるスクリプトが医療記録（`diagnosis`、`soap_note`等）に保存された場合、他の医師や事務員がそのデータを参照する際にスクリプトが実行される格納型XSSが成立する。マルチテナント環境であるため、クロステナント攻撃の起点にもなりうる。

**Countermeasure:**
- サーバーサイドでのHTML/JS出力エスケープをAPIレスポンス生成時に必須化する
- Content-Security-Policy (CSP) ヘッダーを設定し、インラインスクリプト実行を禁止する
- データ保存時と出力時の両フェーズでサニタイズを実施する

**Reference:** セクション7.1（入力検証方針）、セクション4.1（`diagnosis`、`soap_note`フィールド）

---

### [CRITICAL-04] CSRF保護の完全な未設計

**Issue:** セクション7.4において、処方箋発行（`POST /api/v1/prescriptions`）や患者情報更新（`PUT /api/v1/patients/{id}`）などのstate-changing操作に対する保護が「現フェーズのスコープ外」と明記されている。

**Impact:** CSRF攻撃により、認証済みユーザーが意図しない処方箋発行・患者情報変更・診療記録作成を行わされる可能性がある。医療行為に直結する操作であり、誤った処方箋が発行された場合は患者の生命・健康に影響する。

**Countermeasure:**
- すべてのstate-changing APIエンドポイントにCSRFトークン検証を実装する
- SameSite=StrictまたはSameSite=LaxのCookie属性を設定する（CRITICAL-01の修正と合わせて実施）
- Double Submit Cookieパターンまたはカスタムリクエストヘッダー検証を採用する

**Reference:** セクション7.4「現フェーズのスコープ外とする」

---

### [CRITICAL-05] JWTのみに依存したCSRF緩和の不十分性（独立Finding）

**Issue:** CRITICAL-04とは独立した問題として報告する。設計書にCSRF保護がスコープ外と明記されており、JWTのBearerトークン方式がCSRF防御として機能するという前提が設計上存在しうるが、CRITICAL-01でlocalStorageに保存する設計が採用されている。localStorageからのトークン送信はJavaScriptに依存するため、XSSとCSRFの複合攻撃に対して無防備となる。

**Impact:** XSS（CRITICAL-02/03）とCSRF（CRITICAL-04）の複合攻撃時に、localStorage内のトークンを窃取したうえで不正リクエストを送信するシナリオが成立する。単一のJWT実装がCSRFを自動的に防御するという誤った前提を設計書が示唆している。

**Countermeasure:**
- CSRFとXSSの防御を独立した層として設計する（トークンCookie化 + CSRFトークン）
- JWTがCSRF防御を代替するという前提を設計書から除去する
- 各state-changing操作に明示的なCSRFトークン検証を設計する

**Reference:** セクション5.1（JWT認証設計）、セクション7.4（CSRF保護未設計）

---

## Significant Issues

### [SIGNIFICANT-01] VPC内部通信の平文送信

**Issue:** セクション6.1において「VPC内部の通信については内部ネットワークであるため平文で行う」と明記されている。

**Impact:** 内部ネットワーク侵害（ラテラルムーブメント）発生時に、マイクロサービス間で送受信される患者の医療情報が平文で傍受される。ECSタスク間通信、API Gateway〜バックエンド間、バックエンド〜RDS間で電子カルテが平文転送されるリスクがある。医療情報の機密性要件（厚生労働省ガイドライン）に抵触する可能性がある。

**Countermeasure:**
- バックエンドサービス間通信にTLS（mTLSを推奨）を設定する
- RDS接続にSSL/TLSを強制する（`require_ssl=1`パラメータ）
- Redis接続もTLS暗号化を有効にする
- AWS PrivateLink またはService Meshを使用したサービス間通信の暗号化を設計する

**Reference:** セクション6.1「VPC内部の通信については内部ネットワークであるため平文で行う」

---

### [SIGNIFICANT-02] 認証エンドポイントのレートリミット未設定

**Issue:** セクション8.5において、`/api/v1/auth/login` エンドポイントについて「高可用性を優先するため呼び出し制限は設けない設計」と明記されている。

**Impact:** ブルートフォース攻撃・クレデンシャルスタッフィング攻撃に対して無防備となる。医療従事者アカウントが不正アクセスされた場合、患者の全医療情報への不正アクセスが可能になる。

**Countermeasure:**
- API Gatewayレベルでのレートリミット（例: IPアドレスあたり5回/分）を設定する
- 連続失敗時の指数バックオフまたは一時ロックアウト機能を設計する
- WAF（AWS WAF）でIPベースのブルートフォース検知・ブロックを実装する
- アカウントロック後の解除フローを設計する

**Reference:** セクション8.5「呼び出し制限は設けない設計とする」

---

### [SIGNIFICANT-03] リフレッシュトークンエンドポイントの乱用防止設計の欠如

**Issue:** `POST /api/v1/auth/refresh` エンドポイントにおけるレートリミットや乱用防止機構の設計が設計書に存在しない。

**Impact:** リフレッシュトークンを窃取した攻撃者がトークンを無制限に更新し続けることで、実質的に無期限のセッションを維持できる。30日間有効なリフレッシュトークンと組み合わさると、侵害検知が困難になる。

**Countermeasure:**
- リフレッシュトークンのローテーション（使用ごとに新トークン発行・旧トークン無効化）を設計する
- トークン再利用検知（リプレイ攻撃検知）機能を設計する
- リフレッシュエンドポイントへのレートリミットを設定する

**Reference:** セクション3.3（`POST /api/v1/auth/refresh`）、セクション5.3（セッション管理）

---

### [SIGNIFICANT-04] doctorロールによる全患者データへの無制限アクセス

**Issue:** セクション5.2において「doctorロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計」と明記されている。

**Impact:** 担当外の患者の医療記録に医師がアクセス可能となる。マルチテナント環境における他テナントへのアクセス（テナント分離不足と組み合わさった場合）や、担当外患者の個人情報・医療情報への不正アクセスが設計上許容されている。医療法・個人情報保護法上の問題となりうる。

**Countermeasure:**
- doctorロールに対して「担当患者」の概念を実装し、patient-doctor関係テーブルでアクセス制御を行う
- 担当外患者へのアクセスは監査ログに記録し、アラートを発生させる設計にする
- Need-to-Knowの原則に基づきアクセス範囲を最小化する

**Reference:** セクション5.2「patient_idパラメータによるフィルタリングなしに全患者データを参照できる設計」

---

### [SIGNIFICANT-05] CORS設定のワイルドカード使用

**Issue:** セクション7.3において「`Access-Control-Allow-Origin: *` を設定する」と明記されており、本番環境での絞り込みも「検討」に留まっている。

**Impact:** クレデンシャルを含むリクエスト（Cookieや認証ヘッダー）とワイルドカードCORSの組み合わせはブラウザによりブロックされるが、ワイルドカード設定が本番に適用された場合、クロスサイトリクエストが許可される。医療情報APIへの不正クロスオリジンアクセスのリスクがある。

**Countermeasure:**
- 許可するオリジンを明示的に列挙する（例: `https://app.mediconnect.example.jp`）
- 本番環境でのワイルドカード使用を設計レベルで禁止する旨を明記する
- `Access-Control-Allow-Credentials: true` とワイルドカードの組み合わせを禁止する設計を明示する

**Reference:** セクション7.3「Access-Control-Allow-Origin: * を設定する」

---

### [SIGNIFICANT-06] ファイルアップロードの種別・サイズ制限の未設計

**Issue:** セクション7.2において「ファイル種別・サイズの制限は実装フェーズで決定する」とされており、設計段階での制約が未定義である。

**Impact:** 悪意あるファイル（実行可能ファイル、マクロ付きOfficeドキュメント等）のアップロードが可能となる。ウイルススキャンはあるものの、ファイル種別検証なしでは検査画像に偽装したファイルのアップロードが可能である。また、サイズ制限がない場合はDoSのベクターとなりうる。

**Countermeasure:**
- 許可ファイル種別（DICOM、JPEG、PNG、PDF等）をMIMEタイプとファイル拡張子の両方で検証する設計を明記する
- ファイルサイズ上限（例: 検査画像50MB、書類10MB）を設計段階で定義する
- アップロード先S3バケットをアプリケーション配信から分離し、直接実行不可能な設計にする
- S3のプリサインドURL生成前にバックエンドで種別・サイズ検証を必須化する

**Reference:** セクション7.2「ファイル種別・サイズの制限は実装フェーズで決定する」

---

## Moderate Issues

### [MODERATE-01] 医療機密情報のアプリケーションレベル暗号化の欠如

**Issue:** セクション6.2において「診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している」と明記されている。

**Impact:** RDS暗号化はディスクレベルの保護であり、DBアクセス権限を持つ内部者や侵害されたサービスアカウントによる医療機密情報の平文アクセスを防げない。医療情報の最高機密分類データ（診断結果・処方内容）に対して多層防御が適用されていない。

**Countermeasure:**
- `diagnosis`、`soap_note`、`medications`（JSONB）フィールドにアプリケーションレベルの暗号化（AES-256-GCM）を実装する設計を追加する
- 暗号鍵をAWS KMSで管理し、サービスアカウントの鍵アクセスを最小権限に設計する
- フィールドレベル暗号化の設計をデータモデルに反映する

**Reference:** セクション6.2「アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している」

---

### [MODERATE-02] PII含有ログの非構造的管理

**Issue:** セクション6.3において「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用」とされている。

**Impact:** 診断結果・氏名・保険証番号等がCloudWatch Logsに出力される可能性があり、ログへのアクセス権限を持つ全エンジニアがPIIにアクセス可能となる。医療情報の機密保護要件に違反する可能性がある。

**Countermeasure:**
- PIIフィールドの明示的なマスキング・除外ルールを設計として定義する
- ログ出力前の自動マスキング処理（患者名はハッシュ化、保険証番号はマスク等）を設計する
- CloudWatch LogsへのアクセスをIAMポリシーで最小権限化する

**Reference:** セクション6.3「エンジニアの判断に委ねる運用とする」

---

### [MODERATE-03] サードパーティ依存関係の脆弱性管理方針の未定義

**Issue:** セクション8.2において「脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定」とされている。

**Impact:** Twilio Video SDK v2.27.0などの特定バージョンが固定されているが、既知脆弱性（CVE）の検知・対応フローがなく、重要なセキュリティパッチが適用されないリスクがある。

**Countermeasure:**
- 設計段階でSoftware Composition Analysis (SCA) ツール（Snyk、Dependabot等）の導入を決定する
- 重大脆弱性（CVSS 7.0以上）の修正SLAを設計に含める
- 依存関係の自動更新PR生成フローを設計する

**Reference:** セクション8.2「定期チェック方針は今後の運用フェーズで策定」

---

### [MODERATE-04] 監査ログの完全性・改ざん防止設計の欠如

**Issue:** セクション8.3において、監査ログはCloudWatch Logsに記録されるが、ログの改ざん防止・完全性保証の設計が存在しない。

**Impact:** 内部不正（医師による担当外患者の不正アクセス等）の事後調査において、ログが改ざん・削除された場合に証跡が失われる。医療機関での監査証跡として法的有効性が損なわれる可能性がある。

**Countermeasure:**
- CloudTrailのログファイル検証機能を有効化する
- CloudWatch Logsの保護のためにロックポリシーを設定する
- 機密操作（患者データアクセス・処方箋発行・ユーザー権限変更）の監査ログを専用の改ざん防止ストレージ（S3 Object Lock等）に転送する設計を追加する

**Reference:** セクション8.3（監査ログ設計）

---

## Minor Improvements

### [MINOR-01] アクセストークン有効期限の長さ

**Issue:** アクセストークンの有効期限が24時間に設定されている（セクション5.1）。

**Impact:** トークン窃取時の被害ウィンドウが24時間と長い。

**Recommendation:** アクセストークンを15〜60分程度に短縮し、リフレッシュトークンで定期更新する設計を推奨する。

---

### [MINOR-02] データ削除ポリシーの先送り

**Issue:** セクション4.2において「削除方針は今後のフェーズで定義する予定」とされており、診療録以外のデータの保持・削除ポリシーが未設計である。

**Impact:** GDPR・個人情報保護法の「忘れられる権利」に対応できない可能性がある。

**Recommendation:** 設計段階でデータ種別ごとの保持期間と削除手順を定義する。

---

## Positive Aspects

- AWS Secrets Manager によるシークレット管理は適切な設計である（セクション8.1）
- bcryptのコスト係数12でのパスワードハッシュ化は現時点で適切な強度である（セクション5.1）
- マルチスキーマ方式のマルチテナント設計はテナント分離の基盤として評価できる（セクション3.2）
- RDSおよびS3の保存時暗号化が有効化されている（セクション6.2）
- VPCプライベートサブネットへのRDS・Redis配置は適切なネットワーク分離設計である（セクション8.4）
- ウイルススキャン実施の明記は評価できる（セクション7.2）

---

## Summary

| Severity | Count |
|----------|-------|
| Critical | 5 |
| Significant | 6 |
| Moderate | 4 |
| Minor | 2 |

**最重要対応項目:**
1. [CRITICAL-01] localStorageからHttpOnly Cookieへのトークン保存方式変更
2. [CRITICAL-02/03] サーバーサイド入力検証・出力エスケープの必須化（独立した2件）
3. [CRITICAL-04/05] CSRF保護の明示的設計（JWTのみへの依存解消を含む独立2件）
4. [SIGNIFICANT-01] VPC内部通信のTLS暗号化
5. [SIGNIFICANT-02] 認証エンドポイントのレートリミット設計
