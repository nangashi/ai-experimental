# Security Design Review: Nexamart プラットフォーム システム設計書

**対象文書**: test-document-2.md (Nexamart Platform System Design v1.4.0)
**レビュアープロンプト**: v004-variant-pii-logical-access
**実行日**: 2026-02-18

---

## CRITICAL ISSUES

### [CRITICAL-1] PIIの平文保存とRDS TDEへの過信

**該当箇所**: セクション 5.1「個人情報フィールドの暗号化」

**問題の詳細**:
設計書は「氏名・住所・電話番号などの個人情報は平文で保存する。RDS暗号化により保護されているため、フィールドレベルでの追加暗号化は不要と判断する」と明示している。これはTDE（Transparent Data Encryption）の保護範囲に関する根本的な誤解を示している。

**なぜ危険か**:
RDS TDEはストレージ層の暗号化であり、**データベースへの正規の認証情報を持つユーザーに対しては保護を提供しない**。以下のシナリオでPIIが平文で露出する:

1. **内部者脅威**: DB接続権限を持つ内部スタッフや開発者が直接テーブルをクエリ可能
2. **SQLインジェクション**: Prisma ORMを使用しているが、ORMのバイパスや生クエリが混在する場合、攻撃者は正規のDB認証情報不要でPIIにアクセス可能
3. **侵害されたDBアカウント**: アプリケーションサービスアカウントのクレデンシャルが漏洩した場合、全テナントのPIIに無制限アクセス可能
4. **バックアップの露出**: スナップショットが誤って別アカウントや領域に複製された場合、TDEは自動的には保護しない

**影響範囲**:
マルチテナント構成のため、単一のDB侵害で全テナントの顧客PII（氏名・住所・電話番号）が一括流出するリスク。GDPR、個人情報保護法等の観点からも重大な違反となる。

**推奨対策**:
- 高感度フィールド（氏名、住所、電話番号）に対してアプリケーション層暗号化（AES-256-GCM等）またはフィールドレベル暗号化を実装
- AWS KMSのData Key を用いたエンベロープ暗号化でフィールドごとに暗号化
- 代替として、AWS RDS の列レベル暗号化またはPostgreSQLの `pgcrypto` 拡張を検討
- 少なくとも、特に高感度な住所・電話番号フィールドを優先的に暗号化

---

### [CRITICAL-2] 本番シークレットのリポジトリへの格納

**該当箇所**: セクション 8.1「シークレット管理」

**問題の詳細**:
「本番環境のシークレット値はデプロイ担当者の参照用に `config/secrets.prod.yaml` へも記録し、アクセス制限を設けたうえでリポジトリに含める」と記述されている。

**なぜ危険か**:
Gitリポジトリに本番シークレットを格納することは、以下の理由で根本的に危険である:
- Gitの履歴は削除が困難であり、一度コミットされたシークレットは事実上永続する
- リポジトリへのアクセス権を持つ全ての開発者・CI/CDシステムがシークレットに触れる
- リポジトリが誤ってパブリックになった場合の即座の全漏洩
- 「アクセス制限」はGit自体の仕組みでは実施困難（ブランチ保護ではファイル内容を保護できない）

**推奨対策**:
- `config/secrets.prod.yaml` のリポジトリへの格納を即時廃止
- デプロイ担当者はAWS Secrets Managerから直接参照する運用に統一
- 既にリポジトリに格納されている場合は全シークレットをローテーションし、git-filter-branchまたはBFG Repo Cleanerで履歴から削除

---

### [CRITICAL-3] アクセストークンのlocalStorage保存によるXSSリスク

**該当箇所**: セクション 4.1「トークン保存場所」

**問題の詳細**:
JWTアクセストークンを `localStorage` に保存する設計を採用している。

**なぜ危険か**:
`localStorage` はJavaScriptから完全にアクセス可能であるため、XSS攻撃が成功した場合にアクセストークンが窃取される。設計書ではCSP (`default-src 'self'`) やDOMPurifyによるサニタイズを実施しているが、これらは完全な保護ではない（サードパーティスクリプト、CDNの侵害、React/Next.jsの脆弱性等によりXSSが発生する可能性がある）。

**推奨対策**:
- アクセストークンも `HttpOnly` Cookie に格納する（CSRFリスクは `SameSite=Strict` または `SameSite=Lax` で軽減）
- 代替として、アクセストークンをメモリ（React state等）に保持し、ページ再読み込み時にリフレッシュトークンから再取得する方式を採用

---

## SIGNIFICANT ISSUES

### [SIGNIFICANT-1] トークン即時無効化の欠如

**該当箇所**: セクション 4.2「セッション管理」

**問題の詳細**:
「不正検知や権限変更が発生した場合のトークン即時無効化は、リフレッシュトークンの期限切れに依存する設計とする」と明記されている。アクセストークンの有効期限は60分。

**なぜ危険か**:
- ロール変更（例: `tenant_admin` → `buyer` への降格）後も最大60分間は旧権限でAPIアクセス可能
- アカウント停止・侵害検知後も60分間はアクセストークンが有効
- マルチテナント環境での権限昇格が発生した場合の影響が大きい

**推奨対策**:
- アクセストークンのブラックリスト（Redis）を実装（ログアウト時と同様の仕組みを拡張）
- または、アクセストークンの有効期限を5-15分に短縮し、リフレッシュトークンの頻繁な使用で対処
- 権限変更イベント発生時にRedisのブラックリストにJTI（JWT ID）を追加するメカニズムの設計

---

### [SIGNIFICANT-2] CORS設定の正規表現マッチングの危険性

**該当箇所**: セクション 6.4「CORS設定」

**問題の詳細**:
```javascript
const allowedOrigin = /\.nexamart\.com$/;
```
この正規表現は `*.nexamart.com` のみを許可するように見えるが、実際には `attacker-nexamart.com` や `evilnexamart.com` 等のドメインも `nexamart.com` で終わるため許可される。

**なぜ危険か**:
攻撃者が `evil-nexamart.com` のようなドメインを取得した場合、CORSバイパスが成立し、`Access-Control-Allow-Credentials: true` と組み合わさることでクロスオリジンからの認証済みリクエストが可能となる。

**推奨対策**:
正規表現を修正して完全なドットサフィックスを要求する:
```javascript
const allowedOrigin = /^https:\/\/([a-zA-Z0-9-]+\.)?nexamart\.com$/;
```
または、ホワイトリスト方式（許可ドメインの明示的なセット）に変更する。

---

### [SIGNIFICANT-3] StripeウェブフックのSignature検証の未記載

**該当箇所**: セクション 7.3「外部サービス連携」

**問題の詳細**:
`/api/webhooks/stripe` にてイベント受信後、支払いステータスを注文に反映するとあるが、StripeのWebhook署名検証（`stripe-signature` ヘッダーの検証）についての記載がない。

**なぜ危険か**:
署名検証なしでは、攻撃者が偽の支払い完了イベントを送信し、未払いの注文を「支払済」に変更できる。これは金銭的損害と全テナントへの影響をもたらす。

**推奨対策**:
- Stripe SDKの `stripe.webhooks.constructEvent()` を使用した署名検証を明示的に設計に含める
- Webhookエンドポイントのレート制限も設計する

---

### [SIGNIFICANT-4] 認証エンドポイントのレート制限の欠如

**該当箇所**: セクション 4.4「認証エンドポイント」および セクション 6.1

**問題の詳細**:
`/api/auth/login`、`/api/auth/register`、`/api/auth/refresh` に対するレート制限の設計記述がない。

**なぜ危険か**:
- ログインエンドポイントへのブルートフォース攻撃が無制限に実行可能
- リフレッシュトークンエンドポイントの乱用によるDDoS的負荷
- アカウント登録の乱用（スパムアカウント生成）

**推奨対策**:
- Kongゲートウェイにてエンドポイント単位でレート制限を設定（例: ログインは同一IPから5回/分）
- ログイン失敗の連続に対するアカウントロックアウトまたはCAPTCHA要件の設計

---

## MODERATE ISSUES

### [MODERATE-1] PIIのデータ保持・削除ポリシーの未定義

**該当箇所**: セクション 5.3「個人情報（PII）管理」

**問題の詳細**:
「データ保持期間・削除方針: 現時点では未定義。退会申請があった場合の対応フローは今後設計する」と明記されている。

**なぜ危険か**:
GDPRの「忘れられる権利」（Article 17）や個人情報保護法の要請に対応できない。特にマルチテナント構成では、あるテナントのユーザーが削除要求した場合の複数サービスにわたる一貫した削除が複雑になる。

**推奨対策**:
- データ保持期間（例: 退会後3年間保持 → 論理削除 → X年後に物理削除）の明示
- ユーザー削除要求に対する対応SLAの設計（例: 30日以内）
- 削除対象範囲（本番DB、バックアップ、ログ、S3等）の明示

---

### [MODERATE-2] ファイルアップロードのMIMEタイプ検証の不十分さ

**該当箇所**: セクション 6.5「ファイルアップロード」

**問題の詳細**:
「MIME型チェック: `Content-Type` ヘッダーによる判定のみ（拡張子検証なし）」と記述されている。さらに、`multer@1.4.4` を使用しているが、このバージョンには既知の脆弱性（CVE-2022-24434等）が存在する可能性がある。

**なぜ危険か**:
- `Content-Type` ヘッダーはクライアントが任意に設定できるため、悪意あるファイルを画像として偽装してアップロード可能
- Presigned URL方式でも、S3に格納された悪意あるファイルが後処理時に問題を引き起こす可能性がある
- ウイルススキャン未導入と組み合わさることでマルウェア配布の踏み台になるリスク

**推奨対策**:
- サーバーサイドでのマジックバイト（ファイルシグネチャ）検証を追加
- S3アップロード後にAWS Lambda + ClamAVによる非同期スキャンを実装
- `multer` を最新バージョンに更新し、脆弱性を解消

---

### [MODERATE-3] テナントID操作のリスク（マルチテナント分離の脆弱性）

**該当箇所**: セクション 3.2「マルチテナント分離方式」

**問題の詳細**:
`X-Tenant-ID` ヘッダーをKongゲートウェイが付与し、コアAPIサービスはこの値を信頼済みとして扱う設計。エンドユーザーのリクエストでは「検証済みの値として扱われる」とあるが、Kong内部での検証ロジックの詳細が不明確。

**なぜ危険か**:
内部ネットワーク（例: 侵害されたマイクロサービスや内部攻撃者）からコアAPIサービスに直接アクセスする場合、`X-Tenant-ID` を任意のテナントIDに設定して他テナントのデータにアクセスできる可能性がある。コアAPIサービスがKong経由でのみアクセスされることを保証するメカニズムが記載されていない。

**推奨対策**:
- コアAPIサービスはKongのIPアドレス/セキュリティグループからのみアクセスを受け付けるようネットワーク制御を明示的に設計
- または、Kong ↔ コアAPIサービス間に相互TLS（mTLS）認証を導入して内部リクエストを認証

---

### [MODERATE-4] 監査ログの分離とアクセス制御

**該当箇所**: セクション 8.4「監査ログ」

**問題の詳細**:
「ログはアプリケーションの通常ログと同一のCloudWatch Logsストリームに出力する」と記述されている。また、セクション 9.4では「認証失敗・権限変更等の重要イベントをアプリケーションログに記録する」とあるが、セクション 8.4の監査ログ対象に認証失敗・ロール変更が明示的に含まれていない。

**なぜ危険か**:
- 監査ログと通常ログが混在していると、インシデント調査時の追跡が困難
- ログへのアクセス権が広範に付与されている場合、内部攻撃者がログを改ざんして証跡を隠蔽できる
- 監査ログ対象の矛盾（8.4節 vs 9.4節）は実装漏れのリスク

**推奨対策**:
- セキュリティ監査ログを専用のCloudWatch Logsグループに分離し、書き込み専用ポリシーでアプリケーションからアクセス
- 監査対象イベントを一元的に定義（認証失敗、ロール変更、管理者操作、PIIアクセスを必須化）
- CloudTrailとの統合でAPIレベルの監査証跡を強化

---

## MINOR IMPROVEMENTS

### [MINOR-1] 署名付きURLの有効期限（7日間）の長さ

**該当箇所**: セクション 5.4「S3ストレージセキュリティ」

請求書・契約書類の署名付きURLの有効期限が7日間と長い。必要に応じて短縮（例: 1時間〜24時間）することで、URLが漏洩した場合の露出時間を限定できる。

### [MINOR-2] KMSキーローテーション周期

**該当箇所**: セクション 5.1「鍵管理」

年1回のキーローテーションは最低限の要件を満たしているが、高感度データの保護として四半期ローテーション（90日）への短縮を検討する価値がある。

### [MINOR-3] `multer@1.4.4` のメンテナンス状態

**該当箇所**: セクション 8.2「依存ライブラリ管理」

`multer@1.4.4` はメンテナンス状態が懸念されるバージョン。最新版への移行またはアクティブにメンテナンスされている代替ライブラリ（`busboy` 等）への切り替えを検討する。

---

## POSITIVE ASPECTS

- bcrypt（cost factor: 12）によるパスワードハッシュは適切
- リフレッシュトークンの `HttpOnly` Cookie 保存は正しい選択
- PrismaのパラメータBSクエリによるSQLインジェクション対策は有効
- AWS Secrets Managerによるシークレット管理（リポジトリ格納問題を除く）
- CSPの設定とDOMPurifyによるXSS多層防御
- クレジットカード情報のStripe委譲によるPCI DSS対象範囲の最小化
- ログへのPII出力禁止ポリシーは適切

---

## 優先対応サマリ

| 優先度 | 課題 | 対応コスト |
|--------|------|----------|
| Critical | PII平文保存（TDE限界の誤解） | 高（アプリ層暗号化の実装） |
| Critical | 本番シークレットのリポジトリ格納 | 低（即時削除・ローテーション） |
| Critical | アクセストークンのlocalStorage保存 | 中（Cookie方式への変更） |
| Significant | トークン即時無効化の欠如 | 中（Redisブラックリスト拡張） |
| Significant | CORS正規表現の脆弱性 | 低（正規表現修正） |
| Significant | Stripe Webhook署名検証の未記載 | 低（検証ロジック追加） |
| Significant | 認証エンドポイントのレート制限欠如 | 中（Kong設定追加） |
