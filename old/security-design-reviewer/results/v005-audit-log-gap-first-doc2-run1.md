# Security Review: Nexamart プラットフォーム システム設計書 v1.4.0

**Reviewer Prompt**: v005-variant-audit-log-gap-first
**Document**: test-document-2.md
**Run**: 1

---

## Critical Issues

### C-01: 本番シークレットのリポジトリ格納 (Section 8.1)

**Issue**: `config/secrets.prod.yaml` に本番環境のシークレット値（DBパスワード、外部APIキー、JWT署名鍵）を記録し、アクセス制限を設けたうえでリポジトリに含める設計となっている。

**Impact**: リポジトリへのアクセス権を持つ内部関係者（開発者・CI/CD系統）が本番シークレットに直接アクセスできる。リポジトリが漏洩した場合（Git履歴含む）、全シークレットが一括で流出しシステム全体の完全侵害につながる。AWS Secrets Manager を採用しているにもかかわらず、その保護を無効化している。

**Countermeasures**:
- `config/secrets.prod.yaml` をリポジトリから即刻除去し、Git履歴からも削除する（git filter-branch または BFG Repo Cleaner）
- シークレット参照はAWS Secrets Manager 経由のみに一本化し、アクセス記録はCloudTrailで取得する
- デプロイ担当者の参照ニーズはIAMロールによる Secrets Manager コンソールアクセスで代替する

---

### C-02: アクセストークンの localStorage 保管によるXSS窃取リスク (Section 4.1)

**Issue**: JWTアクセストークンを `localStorage` に保存している。

**Impact**: XSS脆弱性が一箇所でも存在すれば、悪意あるスクリプトが `localStorage` からアクセストークンを直接読み取り外部に送信できる。攻撃者は被害者のセッションを60分間完全に制御でき、マルチテナント環境においてはそのユーザーが所属するテナントの全リソースへのアクセス権を得る。

**Impact**: XSS → トークン窃取 → 完全なセッションハイジャックという攻撃チェーンが成立する。

**Countermeasures**:
- アクセストークンも `HttpOnly` Cookie として保存し、JavaScriptからのアクセスを遮断する
- もしくはメモリ内（React state / closure）に保持し、ページ遷移時はリフレッシュトークンで再取得するフローを設計する
- localStorage 保存を採用する場合はCSPを強化し、サードパーティスクリプトのインラインアクセスを完全排除する

---

### C-03: テナント分離のアプリケーション依存（shared schema方式）(Section 3.2)

**Issue**: 全テーブルに `tenant_id` カラムを持つ共有スキーマ方式で、アプリケーション層クエリフィルタリングのみでテナント間データアクセスを防止している。

**Impact**: `tenant_id` フィルタの付与を忘れたクエリ、バグ、SQLインジェクション（ORMバイパス含む）が発生した場合、他テナントのデータが直接露出する。マルチテナントプラットフォームにおいてテナント越えデータ漏洩は最も深刻な侵害に分類される。設計書上、アプリケーション層以外のフィルタ強制機構（Row Level Security等）は記述されていない。

**Countermeasures**:
- PostgreSQL の Row Level Security (RLS) を有効化し、`tenant_id` フィルタをデータベース層で強制する（アプリバグの安全網）
- PRISMAミドルウェアで全クエリに `tenant_id` を自動注入し、未設定クエリをブロックするグローバルフックを導入する
- テナント間アクセスを検出する統合テストスイートを整備する

---

## Significant Issues

### S-01: CORS 正規表現による許可オリジンの過剰許可 (Section 6.4)

**Issue**: 許可オリジンを `/\.nexamart\.com$/` の正規表現マッチで判定している。

**Impact**: `evil.nexamart.com` のようなドメインも正規表現にマッチするため、攻撃者が nexamart.com のサブドメインを登録または乗っ取ることで、クロスオリジンリクエストが許可される。`Access-Control-Allow-Credentials: true` と組み合わさっているため、認証情報付きリクエストが通過し、ユーザーデータが窃取可能になる。

**Countermeasures**:
- 許可オリジンを許可リスト（ホワイトリスト）方式に変更し、明示的に列挙する（例: `['https://nexamart.com', 'https://admin.nexamart.com', 'https://*.nexamart.com'` ではなく具体ドメイン列挙）
- テナントサブドメインを許可する場合は `^https://[a-z0-9-]+\.nexamart\.com$` のように先頭アンカーと文字クラスで制約する

---

### S-02: CSRF対策の単一レイヤー依存（JWTのみ）(Section 6.3)

**Issue**: CSRF対策をJWT（Authorizationヘッダー）のみに依存し、CSRFトークンやSameSite属性の追加対策が設計されていない。

**Impact**: アクセストークンが localStorage に保存されている現在の設計では、CSRF攻撃においてJWTはAuthorizationヘッダーに自動付与されないため一定の防御になるが、将来の設計変更（Cookie移行等）や特定フレームワーク動作でこの前提が崩れた場合、CSRF対策が全面的に無効化される。単一レイヤーの防御は多層防御の観点から不十分である。

**Countermeasures**:
- リフレッシュトークンCookie（HttpOnly）を使用するエンドポイントには SameSite=Strict または SameSite=Lax 属性を明示的に設定する
- state-changing操作にはCSRFトークン（Double Submit Cookie パターンまたはサーバー管理トークン）を追加する

---

### S-03: アクセストークン即時無効化不可 (Section 4.2)

**Issue**: アクセストークンの失効管理をトークン有効期限（60分）のみで実施し、権限変更・不正検知時のトークン即時無効化はリフレッシュトークンの期限切れに依存している。

**Impact**: 権限剥奪・アカウント停止・不正検知が発生しても、最大60分間はアクセストークンが有効であり、攻撃者または不正ユーザーがシステムを操作し続けられる。マルチテナント環境では `tenant_admin` ロールの剥奪遅延が重大なデータアクセスにつながる。

**Countermeasures**:
- アクセストークンもRedisブロックリストで管理し、権限変更・不正検知時に即時無効化できる設計を追加する
- アクセストークン有効期限を短縮（15分以下）してリスクウィンドウを縮小する
- ロール変更イベント発生時に該当ユーザーのアクティブセッションを強制終了するメカニズムを設計する

---

### S-04: Stripe Webhookエンドポイントの署名検証不明 (Section 7.3)

**Issue**: `/api/webhooks/stripe` でStripe Webhookを受信する設計があるが、Webhookリクエストの署名検証（`stripe-signature` ヘッダー検証）が設計書に明示されていない。

**Impact**: 署名検証が未実装の場合、攻撃者が任意の支払い完了イベントを偽造してPOSTし、未払い注文を「支払い済み」に変更できる。これは直接的な収益損失とデータ改ざんにつながる。

**Countermeasures**:
- Stripe公式SDKの `stripe.webhooks.constructEvent()` を使用し、全Webhookリクエストの署名を検証することを設計書に明記する
- Webhookエンドポイントへの認証なしアクセスを制限し、StripeのIPレンジのみを許可するオプションを検討する

---

### S-05: ファイルアップロードのMIMEタイプ検証不足 (Section 6.5)

**Issue**: ファイルアップロードのMIME型チェックを `Content-Type` ヘッダーのみで実施し、拡張子検証もファイル内容（マジックバイト）検証も行っていない。

**Impact**: 攻撃者は `Content-Type: image/jpeg` ヘッダーを付けながらマルウェア・スクリプトファイルをアップロード可能。Presigned URLによるS3直接アップロードの場合、バックエンドでの事後検証がないため、悪意あるファイルがそのまま公開バケットに配置される可能性がある。公開バケット（商品画像・ロゴ）に配置された場合、CDN経由で配信され他ユーザーに影響する。

**Countermeasures**:
- S3アップロード後にLambdaトリガーを使いファイルマジックバイト検証を実施する
- 許可する拡張子リストを設け、Content-Typeと拡張子の両方を検証する
- ウイルススキャン（将来対応）を早期に導入し、少なくとも設計上のタイムラインを確定する

---

### S-06: multer 1.4.4 の既知脆弱性 (Section 8.2)

**Issue**: `multer@1.4.4` を使用している（注: S3 Presigned URL方式と組み合わせているが、設計書ではmulterがマルチパートフォーム処理に使用されると明記されている）。multer 1.4.4 には DoS脆弱性（CVE-2022-24434 等）が報告されているバージョン範囲に含まれる可能性がある。

**Impact**: 古いバージョンの multer は大容量マルチパートリクエストによるDoSや、特定の設定下でのパストラバーサルリスクが指摘されている。

**Countermeasures**:
- multer を最新の安定版（2.x系）にアップグレードする
- 依存ライブラリ脆弱性スキャンを四半期ごとから継続的スキャン（GitHub Dependabot, npm audit CI統合）に変更する

---

## Moderate Issues

### M-01: 監査ログのセキュリティイベント記録ギャップ（Section 8.4 先行判定）

**Audit Log Coverage — 先行判定（存在有無チェック）:**

設計書 Section 8.4 の監査ログ対象イベント（テナント登録・停止、商品公開/非公開切替、注文ステータス変更、ユーザーデータエクスポート）および Section 9.4 の記述（「認証失敗・権限変更等の重要イベントをアプリケーションログに記録する」）を確認した。

以下のセキュリティイベントについて記録要件が不十分または未設計である:

**Gap-1: 認証失敗イベントの独立した監査ログ設計が未定義**

Section 9.4 に「認証失敗をアプリケーションログに記録する」と言及があるが、Section 8.4 の監査ログ設計には含まれていない。Section 8.4 の「認証失敗やロール変更の記録はセキュリティ要件（7.4節）に従い実施する」という記述は参照先が不整合（Section 7.4 は存在しない）であり、実際の記録内容・フォーマット・レベルが未設計である。

- **Impact**: ブルートフォース攻撃、クレデンシャルスタッフィング攻撃の検出基盤が不明確。SOC/SIEM連携時にアラートルール定義ができない。
- **Required**: 認証失敗イベントの記録項目（ユーザーID、IPアドレス、タイムスタンプ、失敗理由）、記録レベル（ERROR）、および監査ログストリームへの出力を明示的に設計する。

**Gap-2: ロール・権限変更イベントの記録設計が未定義**

同じくSection 9.4 に「権限変更を記録する」とあるが、具体的な記録設計（誰がいつどのロールをどのユーザーに付与/剥奪したか）がSection 8.4 の監査ログ設計に存在しない。

- **Impact**: 権限昇格攻撃（内部犯行含む）の事後追跡が不可能。コンプライアンス要件（SOC2, GDPR等）を満たせない可能性がある。
- **Required**: ロール変更イベントの記録項目（操作者ID、対象ユーザーID、変更前/後ロール、テナントID、タイムスタンプ）を監査ログ設計に追加する。

**Gap-3: 機密データアクセスイベントの記録が未設計**

センシティブな操作（ユーザーデータエクスポートは Section 8.4 に記載あり）のうち、以下が欠落している:
- `platform_admin` による全テナントデータへのアクセス
- 注文情報・個人情報（PII）への管理者アクセス

- **Impact**: 内部者による不正データアクセスを事後追跡できない。
- **Required**: platform_adminによる機密操作を監査ログ対象に追加する。

---

**Audit Log Quality 評価（Gapレポート後）:**

- **ログ分離**: Section 8.4 で「アプリケーションの通常ログと同一のCloudWatch Logsストリームに出力する」と明記されており、セキュリティ監査ログと一般アプリケーションログが混在している。SIEM連携やセキュリティ専用のアクセス制御が困難になる。
- **保持期間**: 監査ログの保持期間が未設定。コンプライアンス（PCI DSS: 12ヶ月、SOC2等）要件を満たすために明示的な保持ポリシーが必要。
- **アラート設計**: 監査ログに基づくリアルタイムアラート（例: 一定時間内の認証失敗N回）が設計されていない。

---

### M-02: 認証エンドポイントのレートリミット設計の不明示 (Section 4.4)

**Issue**: ログイン（`POST /api/auth/login`）、パスワードリセット、トークンリフレッシュ（`POST /api/auth/refresh`）エンドポイントのレートリミット設計が明示されていない。Kong ゲートウェイにレートリミットが設定されているかどうかが設計書から確認できない。

**Impact**: ブルートフォース攻撃、クレデンシャルスタッフィング、リフレッシュトークン乱用に対する防御が不明確。

**Countermeasures**:
- 認証エンドポイントのレートリミット値（例: ログイン: IPあたり5回/分、リフレッシュ: ユーザーあたり10回/時）をKong Gatewayプラグイン設定として設計書に明記する
- アカウントロックアウトポリシー（一定失敗後の一時ロック）を設計する

---

### M-03: PII データ保持期間・削除方針の未定義 (Section 5.3)

**Issue**: 「データ保持期間・削除方針は現時点では未定義」と明記されており、退会申請時の対応フローも未設計。

**Impact**: GDPR（忘れられる権利）、個人情報保護法（保有個人データの削除義務）への準拠が担保されていない。個人情報の無期限保持はデータ侵害時の影響範囲を最大化する。

**Countermeasures**:
- リリース前に保持期間（例: 退会後3年）と削除/匿名化フローを設計する
- 物理削除または仮名化（pseudonymization）の方針を決定し、実装計画を設計書に記載する

---

### M-04: 商品更新エンドポイントの所有権検証設計の不明示 (Section 7.1)

**Issue**: `PUT /api/products/:id`（tenant_admin, tenant_staff が実行可能）において、指定した商品IDが自テナントの商品であることを確認する所有権検証が設計書に明示されていない。

**Impact**: 設計書上の認可チェック（Section 4.3: 「JWTの `tenantId` クレームと `X-Tenant-ID` ヘッダーを照合する」）は認証には言及しているが、商品エンドポイントでの所有権照合が明示されていないため、テナントAの管理者がテナントBの商品IDを指定して更新できる可能性がある。

**Countermeasures**:
- 商品API設計に「リソース所有権確認: 商品の `tenant_id` とJWT `tenantId` クレームを照合する」を明示的に追記する

---

### M-05: 注文詳細APIのアクセス制御設計（buyer スコープ）(Section 7.2)

**Issue**: `GET /api/orders/:id` は `buyer` と `tenant_admin` が権限を持つが、buyerが他のbuyerの注文を取得できないことを保証する所有権検証が設計書に明示されていない。

**Impact**: buyerが任意の注文IDを指定して他ユーザーの注文（住所、支払い情報等）を取得できる可能性がある。

**Countermeasures**:
- 注文APIに「buyer は自分のユーザーIDに紐づく注文のみ取得可能」という所有権検証要件を明記する

---

### M-06: 個人情報フィールドへのフィールドレベル暗号化なし (Section 5.1)

**Issue**: 氏名・住所・電話番号を平文保存し、「RDS TDEにより保護されているため追加暗号化は不要」と判断している。

**Impact**: TDEはディスクレベルの暗号化であり、データベースへの論理アクセス権（SQLインジェクション、管理者権限の漏洩、クラウドコンソールアクセス）があれば平文でPIIが読み取られる。マルチテナント共有DBでは全テナントのユーザーPIIが単一の侵害で露出するリスクがある。

**Countermeasures**:
- 少なくとも住所・電話番号はアプリケーション層でのフィールドレベル暗号化（AWS KMS を使用したエンベロープ暗号化）を検討する
- フィールドレベル暗号化を採用しない場合は、リスク受容の判断根拠とリスクオーナーを明記する

---

## Minor Issues

### N-01: 署名付きURL有効期限（7日）の長さ (Section 5.4)

**Issue**: 請求書・契約書類の署名付きURL有効期限が7日と長い。

**Countermeasures**: センシティブ文書へのアクセスには1時間以内の短い有効期限を設定し、必要に応じて再生成するフローを設計することを推奨する。

---

### N-02: ローカル開発環境の .env ファイル管理 (Section 8.1)

**Issue**: `.env` ファイルを `.gitignore` に追加済みとしているが、`.env.example` の管理方針や開発者間でのシークレット共有方法が未定義。

**Countermeasures**: `.env.example` を提供し、開発用シークレットの配布にはAWS Secrets Manager の開発用名前空間またはチーム共有ボルト（1Password Team等）を利用する方針を明記する。

---

## Positive Aspects

- Prisma ORMによるパラメータ化クエリでSQLインジェクションを効果的に防止している
- リフレッシュトークンをHttpOnly Cookieに保存し、ログアウト時のRedisブラックリスト登録を設計している点は適切
- bcrypt（cost factor: 12）によるパスワードハッシュ化は適切
- Stripe委譲によるPCI DSS範囲の最小化は優れた設計判断
- ECSプライベートサブネット配置、VPN必須の管理コンソールアクセス、Security Groupによる最小権限設定は基本的なネットワークセキュリティを満たしている
- AWS Secrets Manager によるシークレット管理方針は適切（ただし本番値のリポジトリ格納がこれを無効化している）
- DOMPurifyによるリッチテキストサニタイズとCSP設定によるXSS多層防御は良好
