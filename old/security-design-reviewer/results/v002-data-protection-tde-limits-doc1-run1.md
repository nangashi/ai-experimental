# Security Design Review: MediConnect システム設計書

**Reviewer Prompt:** v002-variant-data-protection-tde-limits
**Target Document:** test-document-1.md (MediConnect システム設計書)
**Run:** 1

---

## CRITICAL ISSUES

### [CRITICAL-01] TDE/RDS暗号化のみによる医療PII保護 — フィールドレベル暗号化の欠如

**該当箇所:** セクション 6.2「保存データの暗号化」

**問題の詳細:**

設計書では以下の明示的な記述がある:

> 診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している。

これはセキュリティ設計上の重大な欠陥である。RDS TDE（Transparent Data Encryption）/ ディスクレベル暗号化は、物理メディア盗難に対する保護を提供するが、以下のシナリオでは無効である:

- **DBユーザーによる論理的アクセス**: PostgreSQLに接続できるユーザー（アプリケーションサービスアカウント、DBA、侵害されたDB認証情報を持つ攻撃者）は、TDE有効状態でも平文でデータを読み取れる
- **アプリケーション層の侵害**: patient-serviceやconsultation-serviceが侵害された場合、DBに接続できれば全患者データへのアクセスが可能
- **インサイダー脅威**: DBA権限を持つ内部関係者は全テナントの医療情報に無制限アクセス可能
- **マルチテナント漏洩**: スキーマ分離はRBACで管理するが、DBレベルの認証情報が共通であれば、テナント間の論理的分離はTDEでは保護されない

**対象データの機密性:**

patients テーブルには以下の高機密PIIが平文カラムとして設計されている:
- `full_name` (氏名)
- `date_of_birth` (生年月日)
- `phone_number` (電話番号)
- `email` (メールアドレス)
- `insurance_number` (保険証番号)

medical_records テーブルには:
- `diagnosis` (診断内容)
- `soap_note` (SOAPノート — 詳細な医療記録)

**規制要件との不整合:**

本設計書はセクション 1.3 で「日本の医療情報ガイドライン（厚生労働省）への準拠」を要件に挙げている。厚生労働省の「医療情報システムの安全管理に関するガイドライン」では、医療情報の適切な保護措置が求められており、インサイダー脅威対策としてのフィールドレベル保護が暗黙的に必要とされる。

**推奨対策:**

1. **フィールドレベル暗号化の設計**: 最高機密カテゴリ（`insurance_number`、`diagnosis`、`soap_note`）に対してアプリケーション層でのAES-256-GCM暗号化を設計し、DBには暗号化済みバイト列を保存する
2. **暗号鍵管理**: AWS KMS を使用し、テナントごとに異なるCMK（Customer Managed Key）を割り当てることでテナント間の論理的隔離を強化する
3. **アクセス最小化**: アプリケーションサービスアカウントのDB権限を最小化し、特定スキーマの特定テーブルへの読み書きのみに制限する
4. **段階的移行計画**: 全カラムの即時暗号化が困難な場合、`insurance_number`（保険証番号）を最優先に暗号化し、その後 `diagnosis`、`soap_note` の順に実装する

---

### [CRITICAL-02] VPC内部通信の平文通信

**該当箇所:** セクション 6.1「通信の暗号化」

**問題の詳細:**

> VPC 内部の通信については内部ネットワークであるため平文で行う。

医療情報を扱うシステムにおいて、VPC内のサービス間通信（auth-service、patient-service、consultation-service、prescription-serviceおよびPostgreSQL、Redisとの通信）を平文で行うことは重大な設計欠陥である。

**脅威シナリオ:**
- ECSコンテナや内部ネットワーク機器が侵害された場合、患者の医療情報が傍受可能
- VPC内での横移動（lateral movement）攻撃時に通信内容を盗聴できる
- Redisに保存されたリフレッシュトークンが平文通信で送受信される（セッション奪取リスク）

**推奨対策:**
- バックエンドサービス間通信: mTLS（相互TLS）認証の設計
- アプリケーション〜PostgreSQL間: SSL/TLS接続の強制（`sslmode=verify-full`）
- アプリケーション〜Redis間: TLS接続の有効化（Redis 6以降でサポート）

---

### [CRITICAL-03] JWT トークンの localStorage 保存

**該当箇所:** セクション 5.1「認証フロー」ステップ4

**問題の詳細:**

> クライアントはアクセストークンを `localStorage` に保存し

localStorage に保存されたJWTはXSS攻撃によって窃取可能である。医療情報システムにおいてこのリスクは特に深刻で、攻撃者がXSSを悪用してトークンを窃取した場合、患者の全医療記録へのアクセスが可能になる。

**推奨対策:**
- アクセストークン: `HttpOnly` + `Secure` + `SameSite=Strict` Cookie での保存に変更
- リフレッシュトークン: 同様に HttpOnly Cookie で管理し、JavaScriptからのアクセスを不可にする

---

### [CRITICAL-04] 医師ロールによる全患者データへの無制限アクセス

**該当箇所:** セクション 5.2「認可モデル」

**問題の詳細:**

> doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする。

これはマルチテナント医療システムにおいて重大な設計欠陥である。医師は自分の担当患者の情報のみにアクセスすべきであり、同一テナント内の全患者（担当外）の情報にアクセスできる設計は、医療倫理・法的要件（個人情報保護法、医療情報ガイドライン）に反する。

**脅威シナリオ:**
- 悪意ある医師が担当外の著名人や知人の医療記録を閲覧可能
- 侵害された医師アカウントによる全患者情報の大規模漏洩

**推奨対策:**
- `GET /api/v1/patients/{id}` および `GET /api/v1/patients/{id}/records` に対して、医師の担当患者リストとの照合（consultation-serviceまたはアクセス制御リスト参照）を必須とする
- 必要に応じてABAC（属性ベースアクセス制御）の導入を検討する

---

## SIGNIFICANT ISSUES

### [SIGNIFICANT-01] 認証エンドポイントのレート制限欠如

**該当箇所:** セクション 8.5「認証エンドポイント保護」

**問題の詳細:**

> `/api/v1/auth/login` エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計とする。

ログインエンドポイントへのレート制限なしは、ブルートフォース攻撃・クレデンシャルスタッフィング攻撃に対して脆弱である。`/api/v1/auth/refresh` エンドポイントのレート制限も設計されていない。

**推奨対策:**
- IPアドレスベースのレート制限（例: 5回失敗/分でスロットリング）
- アカウントベースのロックアウトポリシー（例: 10回失敗でアカウント一時ロック）
- AWS WAF の `AWSManagedRulesKnownBadInputsRuleSet` および `AWSManagedRulesBotControlRuleSet` の適用

---

### [SIGNIFICANT-02] CORS ワイルドカード設定

**該当箇所:** セクション 7.3「CORS設定」

**問題の詳細:**

> `Access-Control-Allow-Origin: *` を設定する。本番環境では必要に応じて絞り込みを検討する。

医療情報APIへのワイルドカードCORS設定は、認証情報（credentialed requests）を伴うAPIでは特に危険である。「必要に応じて」という曖昧な方針では本番環境でも設定漏れが発生するリスクがある。

**推奨対策:**
- 許可オリジンの明示的なホワイトリスト管理（`https://app.mediconnect.example.com` 等）
- 認証情報を伴うリクエストには `Access-Control-Allow-Credentials: true` と組み合わせた厳格なオリジン制限を設計フェーズで確定する

---

### [SIGNIFICANT-03] CSRF保護の欠如

**該当箇所:** セクション 7.4「セッション系 API の保護」

**問題の詳細:**

> 医師による処方箋発行（`POST /api/v1/prescriptions`）や患者情報更新（`PUT /api/v1/patients/{id}`）などのstate-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外とする。

処方箋発行・患者情報更新という医療上クリティカルな操作がCSRF保護なしに設計されている。`Authorization: Bearer` ヘッダーを使用するAPIでは通常CSRFリスクは低いが、Cookie認証への変更（CRITICAL-03の推奨対策）を採用した場合、CSRF保護が必須となる。

**推奨対策:**
- SameSite=Strict Cookie の採用（CSRF-TOKEN不要のアプローチ）
- または Double Submit Cookie パターンによるCSRFトークン設計

---

### [SIGNIFICANT-04] PIIを含むログの無制限出力

**該当箇所:** セクション 6.3「個人情報の取り扱い」

**問題の詳細:**

> 患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする。

「エンジニアの判断に委ねる」という設計は、個人情報保護法および医療情報ガイドラインへの準拠において容認できない。PIIがCloudWatch Logsに記録された場合、ログへのアクセス権を持つ全エンジニアが患者情報にアクセス可能となる。

**推奨対策:**
- ログ出力フィールドのホワイトリスト管理（PII除外リストを設計段階で定義）
- 氏名・生年月日・保険証番号のログへの出力を技術的に禁止するロガー設計
- 患者IDのみをログに記録し、PHI（Protected Health Information）は一切含めない方針の明文化

---

## MODERATE ISSUES

### [MODERATE-01] ファイルアップロードの種別・サイズ制限未定義

**該当箇所:** セクション 7.2「ファイルアップロード」

**問題の詳細:**

> ファイル種別・サイズの制限は実装フェーズで決定する。

ウイルススキャンの実施は評価できるが、ファイル種別（MIME type）とサイズ制限が設計段階で未定義であることは、設計上の欠陥である。悪意あるファイル（WebShell、巨大ファイルによるDos）のリスクが残る。

**推奨対策:**
- 許可するファイル種別の明示（例: JPEG/PNG/PDF のみ）
- ファイルサイズ上限の設計段階での定義（例: 画像 10MB、PDF 20MB）
- S3へのアップロード前にContent-Typeのサーバーサイド検証を必須とする

---

### [MODERATE-02] バックエンドのみフロントエンド依存検証

**該当箇所:** セクション 7.1「入力検証方針」

**問題の詳細:**

> フロントエンドで入力検証が完了した状態でAPIに送信される設計とする。バックエンドでは基本的な型チェック（JSONスキーマバリデーション）のみ実施する。

フロントエンドの入力検証は信頼できない。攻撃者は直接APIを呼び出すことができる。医療情報システムでのSQLインジェクション・NoSQLインジェクション対策はバックエンドで実装すべきである。

**推奨対策:**
- すべてのAPIエンドポイントでバックエンド側の厳格な入力検証を実施
- パラメータ化クエリ（Prepared Statement）の使用を設計で明示
- 入力値の許可リスト（allowlist）ベースのバリデーション方針を定義

---

### [MODERATE-03] サードパーティ依存関係の脆弱性管理方針の欠如

**該当箇所:** セクション 8.2「サードパーティ依存関係」

**問題の詳細:**

> 脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定である。

Twilio Video SDK v2.27.0 等の固定バージョンが使用されているが、脆弱性スキャンが運用フェーズまで先送りされている。設計段階でスキャン方針を定義すべきである。

**推奨対策:**
- CI/CDパイプラインへのSCA（Software Composition Analysis）ツール統合（Dependabot、Snyk等）の設計段階での確定

---

## POSITIVE ASPECTS

- bcrypt（コスト係数12）によるパスワードハッシュ化: 適切な実装方針
- JWT のリフレッシュトークンをRedisで管理し、ログアウト時に無効化: トークン失効設計として適切
- RDS・Redis のVPCプライベートサブネット配置: ネットワーク隔離の基本設計として適切
- AWS Secrets Manager によるシークレット管理: 環境変数ハードコーディングを回避する適切な設計
- マルチスキーマ方式によるテナント分離: テナント間論理分離の基本設計として評価できる
- S3 ウイルススキャンの実施: ファイルアップロードのリスク低減に貢献
- 監査ログへの操作ユーザーID・操作種別・タイムスタンプの記録: 基本的な監査ログ設計として適切

---

## 総括

MediConnect は患者の医療情報・保険情報という極めて機密性の高いデータを扱うシステムであるにもかかわらず、データ保護設計に根本的な問題がある。最も深刻なのは **[CRITICAL-01]** で、「RDS暗号化で十分」と明示的に記述された設計判断が、医療PIIを実質的にDBアクセス可能なすべてのアクターに対して平文で露出させる。フィールドレベル暗号化の設計は設計書策定フェーズで確定させる必要がある。

また、医師ロールによる全患者データへの無制限アクセス（[CRITICAL-04]）は、医療倫理・個人情報保護法・医療情報ガイドラインに直接抵触する可能性があり、アクセス制御設計の根本的な見直しが必要である。
