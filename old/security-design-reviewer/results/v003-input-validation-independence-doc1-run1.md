# Security Design Review: MediConnect システム設計書

## CRITICAL ISSUES

### [CRITICAL-1] サーバーサイド入力検証の欠如（フロントエンド検証への一方的依存）

**対象箇所**: セクション 7.1「入力検証方針」

**問題の詳細**:
設計書は「フロントエンドで入力検証が完了した状態でAPIに送信される設計とする」と明記しており、バックエンドでは「基本的な型チェック（JSONスキーマバリデーション）のみ実施する」としている。これはサーバーサイド検証がフロントエンド検証の正常動作を前提としており、**防御レイヤーの独立性が担保されていない**。

**独立性評価**:
フロントエンド検証は攻撃者がAPIを直接呼び出すことで完全にバイパス可能である。医療システムにおいてSQLインジェクション、NoSQLインジェクション、XSSペイロードが患者の診断内容（`diagnosis TEXT`）や処方情報（`medications JSONB`）に格納されるリスクが高い。サーバーサイド検証はフロントエンドの動作に依存せず、独立して機能する必要がある。

**影響**:
- 攻撃者がAPIクライアント（curl等）経由で悪意あるペイロードを直接送信可能
- 電子カルテデータへのSQLインジェクション攻撃
- XSSペイロードの保存による医師・患者へのクロスサイトスクリプティング攻撃
- 医療情報の改ざん・漏洩

**対策**:
- すべてのAPIエンドポイントにサーバーサイドバリデーション層を設計（フロントエンド検証とは独立して機能するものとして明示）
- express-validator等のライブラリを用いたサニタイゼーション・バリデーションルールの定義
- フリーテキストフィールド（diagnosis, soap_note）に対するインジェクション対策の明示

---

### [CRITICAL-2] CSRF保護の設計欠如（JWT単独での保護を想定）

**対象箇所**: セクション 7.4「セッション系 API の保護」

**問題の詳細**:
処方箋発行（`POST /api/v1/prescriptions`）や患者情報更新（`PUT /api/v1/patients/{id}`）などのstate-changing操作に対するCSRF保護が「現フェーズのスコープ外」とされている。また認証にJWTを使用しているが、アクセストークンが `localStorage` に保存される設計（セクション 5.1）のため、JWTはCSRF攻撃に対して防御を提供しない。

**独立性評価**:
JWTによる認証はCSRF防御として独立して機能しない。`localStorage` からJWTを読み取ってAuthorization Bearerヘッダーに付与する方式は正規クライアントの動作であり、攻撃者のサイトからのフォーム送信によるCSRFには脆弱でない（その点は正しい）。ただし、設計書はCSRF保護を「スコープ外」と明記しており、将来的にCookie方式への変更や混在が発生した場合に保護が存在しない状態となる。さらに、CSRF保護の設計が存在しないことで、本設計がCSRF脅威を十分に評価・分析した上でJWT+Bearerで対処済みとの根拠を確認できない。

**影響**:
- 医師への悪意あるサイトからの処方箋不正発行誘導
- 患者情報の不正更新
- 認証情報の設計変更時にCSRF脆弱性が顕在化

**対策**:
- CSRF対策の設計方針を明示する（Bearer Token + Authorization Headerのみを使用し、Cookieによる自動送信を行わない設計であることを文書化）
- SameSite属性の使用方針、またはCSRFトークンの採用を設計書に記載

---

### [CRITICAL-3] localStorageへのJWTアクセストークン保存によるXSS脆弱性

**対象箇所**: セクション 5.1「認証フロー」

**問題の詳細**:
アクセストークン（有効期限24時間）を `localStorage` に保存する設計となっている。`localStorage` に保存されたJWTはXSS攻撃によって窃取可能であり、攻撃者が長期間（最大24時間）にわたりなりすましが可能となる。

**独立性評価**:
XSS対策（CRITICAL-1で指摘）とトークン保管先の安全性は独立した制御であるべき。XSSがゼロである前提でlocalStorage保管が安全とする設計は、XSS対策に依存した設計であり防御レイヤーの独立性を欠く。

**影響**:
- XSS経由でのJWTトークン窃取
- 患者の医療情報への不正アクセス
- 医師アカウントの乗っ取りによる不正な処方箋発行

**対策**:
- アクセストークンをメモリ内（Reactのstate）に保持する設計への変更
- リフレッシュトークンのみHttpOnly Cookieで保持する設計を検討
- トークンの有効期限を短縮（例: 15分）してリスクを低減

---

### [CRITICAL-4] doctorロールによる全患者データ無制限アクセス

**対象箇所**: セクション 5.2「認可モデル」

**問題の詳細**:
設計書は「doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする」と明記している。これはマルチテナント環境において、担当外患者の医療情報へのアクセスを許可する設計であり、医療倫理・法規制（個人情報保護法、医療法）に反する可能性がある。

**独立性評価**:
認可チェックがロールのみで行われ、リソース所有権（担当患者であるか）の検証が行われていない。これはAPI Endpoint Authorization Checklistの「ownership/membership verification」が欠如した状態。

**影響**:
- 医師が担当外患者の電子カルテ・処方箋を参照可能
- クロステナント情報漏洩のリスク（tenant_idフィルタリングの実装依存）
- 医療情報の不正閲覧・内部脅威リスク

**対策**:
- doctorロールへのアクセス制御に担当患者フィルタリングを明示的に設計
- 患者と担当医師の関連テーブルを設計し、参照権限を担当関係に基づいて制御
- 監査ログに患者情報アクセス記録を含める設計

---

## SIGNIFICANT ISSUES

### [HIGH-1] VPC内部通信の平文通信

**対象箇所**: セクション 6.1「通信の暗号化」

**問題の詳細**:
「VPC 内部の通信については内部ネットワークであるため平文で行う」と設計されている。マイクロサービス間（auth-service、patient-service、consultation-service、prescription-service）の通信、およびバックエンドからRDS・Redisへの通信が平文となる。

**独立性評価**:
Encryption Coverage Checklistの「Internal communication」項目に対して、内部通信の暗号化が設計されていない。外部通信のTLS保護が内部通信に依存している設計ではないが、内部での侵害時に医療情報が盗聴可能となる。

**影響**:
- VPC内部での侵害時（コンテナ乗っ取り、内部不正者）に医療情報の盗聴が可能
- 診断結果・処方内容の平文通信

**対策**:
- サービス間通信にTLS/mTLSを導入する設計
- RDS・Redis接続のTLS強制化
- AWS Certificate Manager Private CAを用いた内部証明書の管理設計

---

### [HIGH-2] ファイルアップロードの種別・サイズ制限未定義

**対象箇所**: セクション 7.2「ファイルアップロード」

**問題の詳細**:
「ファイル種別・サイズの制限は実装フェーズで決定する」とされており、設計段階で制御が定義されていない。ウイルススキャンは設計されているが、ファイルタイプ・サイズの検証なしでは悪意あるファイルのアップロードが可能。

**影響**:
- 実行可能ファイル、スクリプトのアップロード
- 大容量ファイルによるストレージ・帯域幅の枯渇（DoS）
- S3上でのファイルタイプ混在によるコンテンツサービスリスク

**対策**:
- 許可するMIMEタイプの明示（例: image/jpeg, image/png, application/pdf）
- ファイルサイズ上限の定義（例: 50MB）
- Content-Typeヘッダーではなくファイルのマジックバイト検証の設計

---

### [HIGH-3] 認証エンドポイントのレート制限なし

**対象箇所**: セクション 8.5「認証エンドポイント保護」

**問題の詳細**:
`/api/v1/auth/login` について「高可用性を優先するため呼び出し制限は設けない設計とする」とされている。Authentication Endpoint Protection Checklistの「Login/authentication endpoints: Verify that rate limiting is explicitly designed to prevent brute force attacks」に対して明示的な対策が存在しない。

**独立性評価**:
ブルートフォース対策はbcrypt（コスト係数12）の計算コストに依存した暗黙的な制御となっており、独立したレート制限制御が欠如している。bcryptによる遅延は攻撃を困難にするが、大規模分散攻撃には不十分。

**影響**:
- 医師・管理者アカウントへのブルートフォース攻撃
- クレデンシャルスタッフィング攻撃
- アカウント列挙攻撃

**対策**:
- IP・アカウントベースのレート制限設計（例: 5回失敗で15分ロック）
- AWS WAFによるブルートフォース対策ルールの適用
- `POST /api/v1/auth/refresh` および `/api/v1/auth/login` への明示的なレート制限

---

### [HIGH-4] CORSワイルドカード設定

**対象箇所**: セクション 7.3「CORS設定」

**問題の詳細**:
`Access-Control-Allow-Origin: *` を設定し、「本番環境では必要に応じて絞り込みを検討する」とされている。医療情報を扱うシステムでのワイルドカードCORS設定は、任意のオリジンからのAPIアクセスを許可する。

**影響**:
- 悪意あるWebサイトからの医療API呼び出し
- 患者データの第三者サイトへの漏洩
- 本番環境でのワイルドカード設定が継続するリスク

**対策**:
- 許可オリジンを設計書に明示（例: `https://mediconnect.example.com`）
- 本番/開発環境での設定分離を設計に含める

---

## MODERATE ISSUES

### [MED-1] 患者情報を含むログ管理の非明示化

**対象箇所**: セクション 6.3「個人情報の取り扱い」

**問題の詳細**:
「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする」とされており、PIIのログ除外ルールが設計されていない。CloudWatch LogsにPIIが記録された場合、ログアクセス権限を持つエンジニアが患者情報に無制限にアクセス可能となる。

**影響**:
- 診断結果・処方内容のログへの意図しない記録
- ログ経由の患者情報漏洩

**対策**:
- PII・医療情報のログ出力禁止ルールを設計書に明記
- ログマスキング・フィルタリング設計の追加

---

### [MED-2] リフレッシュトークンのuserID単一キー管理

**対象箇所**: セクション 5.3「セッション管理」

**問題の詳細**:
「ユーザーIDをキーとしてトークン値を管理する」設計では、ユーザーが複数デバイスでログインした場合、後のログインが先のリフレッシュトークンを上書きする可能性がある。また、単一トークンの場合、デバイス別のセッション管理・失効が不可能。

**影響**:
- トークンリフレッシュ時の競合によるセッション強制終了
- デバイス別ログアウト機能の実装不可

**対策**:
- `user_id + device_id` または `token_id` をキーとする設計への変更
- リフレッシュトークンのローテーション（使用済みトークン失効）の設計

---

### [MED-3] テナント分離のJWTクレーム依存リスク

**対象箇所**: セクション 3.2「マルチテナント設計」

**問題の詳細**:
テナント識別が「JWTトークンに含まれる `tenant_id` クレームに基づく」設計となっている。JWTが適切に署名検証されることが前提であるが、署名アルゴリズム(`alg: none`攻撃)やキー混乱攻撃が設計書でカバーされていない。

**影響**:
- `tenant_id` 改ざんによるクロステナントデータアクセス
- 医療機関間の患者情報の混在・漏洩

**対策**:
- JWT署名アルゴリズムの明示（RS256推奨、HS256の場合は共有秘密の管理方針）
- `alg: none` および `alg` ヘッダー書き換え攻撃への対策の明示

---

### [MED-4] サードパーティ脆弱性管理の未策定

**対象箇所**: セクション 8.2「サードパーティ依存関係」

**問題の詳細**:
「脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定」とされている。Twilio Video SDK v2.27.0等の特定バージョンを採用しているが、脆弱性対応の仕組みが設計されていない。

**対策**:
- npm audit / Dependabotの継続的チェックを設計に含める
- CVSSスコアに基づく対応優先度の基準を定義

---

## MINOR NOTES / POSITIVE ASPECTS

### [LOW-1] 監査ログの不十分な対象定義

**対象箇所**: セクション 8.3「監査ログ」

「操作ユーザーID、操作種別、タイムスタンプ」を記録するとあるが、患者情報参照・医療記録アクセス・処方箋発行などの医療上重要な操作が監査対象として明示されていない。医療情報ガイドラインへの準拠を宣言しているため、アクセスログの詳細設計が必要。

---

### [POSITIVE-1] 適切なbcryptコスト係数

bcryptのコスト係数12は現在の推奨値（10-14）の範囲内であり、適切なパスワードハッシュ強度が設計されている。

### [POSITIVE-2] AWS Secrets Manager の採用

データベース接続情報・APIキーをSecrets Managerで管理する設計は、環境変数ハードコーディングや設定ファイルへの平文保存を避ける適切なアプローチである。

### [POSITIVE-3] RDS暗号化とS3 SSEの有効化

RDS（AES-256）とS3（SSE-S3）の保存時暗号化が設計されており、基本的なデータ保護が確保されている。

### [POSITIVE-4] マルチスキーマによるテナント分離

テナント（医療機関）ごとのスキーマ分離は、SQLレベルでのクロステナントデータアクセスに対する基本的な防護層を提供する。

---

## サマリー

| 重大度 | 件数 | 主要項目 |
|--------|------|---------|
| CRITICAL | 4 | サーバーサイド検証欠如、CSRF設計欠如、localStorage JWT保管、医師無制限アクセス |
| HIGH | 4 | VPC内平文通信、ファイル制限未定義、認証レート制限なし、CORSワイルドカード |
| MODERATE | 4 | PIIログ管理、リフレッシュトークン設計、テナント分離JWT依存、脆弱性管理未策定 |
| LOW | 1 | 監査ログ対象の不十分な定義 |

医療情報を扱うシステムとして、特にCRITICAL-1（サーバーサイド検証の独立性）とCRITICAL-2（CSRF保護）は優先的に設計を改定する必要がある。現設計はフロントエンド検証への依存とJWT単独保護の前提が複数箇所で確認され、防御レイヤーの独立性が設計原則として確立されていない。
