# Security Design Review: MediConnect システム設計書

## Executive Summary

MediConnect は医療機関向けの電子カルテ・遠隔診療プラットフォームであり、患者の医療情報（PHI）および個人情報（PII）を大量に扱う高リスクシステムである。設計書の全体的なセキュリティ成熟度は低く、複数の重大な設計欠陥が確認された。医療情報システムとして要求される厚生労働省ガイドラインへの準拠を謳いながら、基本的なセキュリティ設計が欠落している。

---

## Critical Issues（重大問題）

### CRIT-1: アクセストークンの localStorage 保存による XSS 脆弱性

**該当箇所**: 5.1 認証フロー（手順4）

**問題の詳細**:
設計書では「クライアントはアクセストークンを `localStorage` に保存する」と明示されている。`localStorage` はJavaScriptからアクセス可能であるため、XSS（クロスサイトスクリプティング）攻撃が成功した場合、攻撃者はトークンを完全に窃取できる。医療情報システムにおいてこれは致命的である。

**影響**:
- XSS攻撃によるセッションハイジャック
- 攻撃者が患者の医療記録・処方箋に完全アクセス
- マルチテナント環境での横断的な医療機関データ漏洩リスク

**対策**:
- アクセストークンを `HttpOnly` + `Secure` 属性を持つCookieに変更
- SameSite=Strict または SameSite=Lax を設定してCSRFリスクを緩和
- アクセストークンの有効期限を24時間から15〜30分程度に短縮

---

### CRIT-2: 認証エンドポイントへのレート制限なし（ブルートフォース攻撃無防備）

**該当箇所**: 8.5 認証エンドポイント保護

**問題の詳細**:
設計書に「`/api/v1/auth/login` エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計とする」と明記されている。これは医療情報システムに対するブルートフォース攻撃を無制限に許容する設計判断である。

**影響**:
- パスワードブルートフォース攻撃によるアカウント侵害
- クレデンシャルスタッフィング攻撃に対して無防備
- 医師・管理者アカウント侵害時の全患者データ漏洩

**対策**:
- IPベースのレート制限（例: 5回失敗/分）を設計に明示
- アカウントロックポリシー（例: 10回失敗で30分ロック）の設計
- `/api/v1/auth/refresh` にも同様のレート制限を適用
- CAPTCHA または多要素認証（MFA）の導入検討

---

### CRIT-3: CORS ワイルドカード設定（本番環境への持ち越しリスク）

**該当箇所**: 7.3 CORS設定

**問題の詳細**:
「開発効率を優先するため `Access-Control-Allow-Origin: *` を設定する。本番環境では必要に応じて絞り込みを検討する」という設計は、医療情報システムとして許容できない。「必要に応じて」という曖昧な表現は、本番展開時にそのまま残存するリスクが高い。

**影響**:
- 悪意あるサードパーティサイトからのクロスオリジンリクエストが可能
- Cookieベースの認証情報を持つリクエストの横断悪用
- 医療情報の不正取得

**対策**:
- 本番環境では許可オリジンを明示的にホワイトリスト化（例: `https://mediconnect.example.com`）
- 設計書に「本番では必ずオリジンを明示指定する」ことを必須要件として記載
- 開発・ステージング・本番で異なるCORS設定を管理する仕組みを設計に含める

---

### CRIT-4: 医師ロールによるテナント内全患者データへの無制限アクセス

**該当箇所**: 5.2 認可モデル（最終段落）

**問題の詳細**:
「doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計」と明記されている。これは最小権限原則に著しく違反し、医師が担当外患者の医療情報に無制限アクセスできることを意味する。

**影響**:
- 医師による担当外患者の医療情報への不正アクセス（内部脅威）
- 個人情報保護法・医療法違反のリスク
- 医療倫理上の重大問題

**対策**:
- 診察関係（担当関係）に基づくリソースレベルの認可チェックを設計
- `GET /api/v1/patients/{id}` では「医師が当該患者の担当医か、または今後の診察予約があるか」を検証
- 医師がアクセス可能な患者リストを明示的に管理するデータモデルの設計
- 例外ケース（緊急時アクセス）は別途承認フローを設計し、監査ログに記録

---

### CRIT-5: VPC 内部通信の平文化（内部通信暗号化なし）

**該当箇所**: 6.1 通信の暗号化

**問題の詳細**:
「VPC 内部の通信については内部ネットワークであるため平文で行う」と明記されている。医療情報を含むマイクロサービス間通信が暗号化されていないため、VPCへの侵入（クラウド設定ミス、コンテナエスケープ等）があった場合、全データが平文で取得可能である。

**影響**:
- 内部ネットワーク侵害時の全医療情報の平文取得
- 横移動攻撃（Lateral Movement）によるデータ窃取
- 厚生労働省医療情報ガイドラインへの非準拠リスク

**対策**:
- マイクロサービス間通信にTLS（mTLS推奨）を適用
- AWS Certificate Manager を用いたサービス間証明書管理の設計
- ECS サービスメッシュ（AWS App Mesh）や Service Connect の採用を検討
- 少なくとも auth-service、patient-service、prescription-service 間の通信は暗号化必須

---

## Significant Issues（重要問題）

### SIG-1: CSRF 保護の設計欠落

**該当箇所**: 7.4 セッション系 API の保護

**問題の詳細**:
「処方箋発行（`POST /api/v1/prescriptions`）や患者情報更新などのstate-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外」と明示されている。CSRF保護が欠落した状態で医師がフィッシングサイトにアクセスした場合、意図しない処方箋発行が発生しうる。

**影響**:
- 意図しない処方箋の発行
- 患者情報の不正更新
- 医師の意図しない操作による医療事故リスク

**対策**:
- CRIT-1でCookieへ変更した場合、SameSite=Strict で大部分のCSRFを防止
- Synchronizer Token Pattern（CSRFトークン）またはDouble Submit Cookie Patternを設計
- State-changing APIエンドポイント全件にCSRF保護を適用することを設計書に明記

---

### SIG-2: ファイルアップロードのバリデーション未定義

**該当箇所**: 7.2 ファイルアップロード

**問題の詳細**:
「ファイル種別・サイズの制限は実装フェーズで決定する」と記載されており、設計段階での制約が未定義。ウイルススキャン実施は言及されているが、種別・サイズ制限なしでは過大ファイルによるDoSや、危険なファイル形式のアップロードが可能。

**影響**:
- DoS攻撃（大容量ファイルの大量アップロード）
- 悪意あるファイル（HTMLファイル等）のS3経由での配信
- S3コスト爆発

**対策**:
- 設計書に許可ファイル形式を明示（例: JPEG, PNG, PDF, DICOM）
- ファイルサイズ上限を設計に記載（例: 画像50MB、PDF10MB）
- S3への保存パスをユーザー制御不可能なUUIDベースに固定
- Content-Typeヘッダーではなくファイルマジックバイトでの種別検証を設計

---

### SIG-3: アクセストークン有効期限が過大（24時間）

**該当箇所**: 5.1 認証フロー（手順3）

**問題の詳細**:
アクセストークンの有効期限が24時間であり、医療情報システムとして過長。トークン窃取時の被害期間が最大24時間となる。

**影響**:
- トークン漏洩時の長期間不正アクセス
- トークン失効機構なしでの即時ログアウトの困難さ

**対策**:
- アクセストークンを15〜30分に短縮
- リフレッシュトークンによる自動更新で利便性を維持
- トークンブラックリスト機能またはJTI（JWT ID）管理の設計

---

### SIG-4: リフレッシュトークンのユーザーIDキー管理方式の問題

**該当箇所**: 5.3 セッション管理

**問題の詳細**:
「ユーザーIDをキーとしてトークン値を管理する」設計では、1ユーザーにつき1つのリフレッシュトークンしか保持できない。複数デバイスでのログイン時に既存セッションが無効化される可能性がある。また、ユーザーIDをキーとすることで、旧トークンが新トークン発行後も有効な期間が生じる可能性がある。

**影響**:
- 複数デバイス利用時のセッション管理不整合
- リフレッシュトークンローテーション未設計によるトークン再利用攻撃リスク

**対策**:
- キーを `userId:deviceId` または `userId:tokenId` 形式に変更
- リフレッシュトークンローテーション（使用済みトークンの即時無効化）を設計
- 不審な再利用検知時の全セッション強制失効を設計

---

### SIG-5: サードパーティ依存関係の脆弱性管理未設計

**該当箇所**: 8.2 サードパーティ依存関係

**問題の詳細**:
「脆弱性情報の定期チェック方針は今後の運用フェーズで策定する」と記載。Twilio Video SDK v2.27.0 など具体的なバージョンが固定されているが、脆弱性発見時の対応プロセスが未設計。

**影響**:
- 既知脆弱性を持つライブラリの長期使用
- サプライチェーン攻撃リスク

**対策**:
- Dependabot または npm audit の CI/CD 組み込みを設計に含める
- 重大脆弱性（CVSS 7.0以上）発見時の緊急パッチポリシーを設計書に記載
- SBOM（Software Bill of Materials）生成の設計

---

## Moderate Issues（中程度の問題）

### MOD-1: PII ログ出力のエンジニア判断委任

**該当箇所**: 6.3 個人情報の取り扱い

**問題の詳細**:
「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする」という設計は、ヒューマンエラーによるPIIのログ混入を防止できない。医療情報の性質上、患者氏名・診断内容等がログに出力されるリスクが高い。

**影響**:
- CloudWatch Logs への医療情報の不用意な出力
- ログ参照権を持つ運用担当者によるPIIアクセス
- 個人情報保護法違反

**対策**:
- PIIマスキングライブラリの採用（例: `pino-noir`、カスタムロガー）を設計に含める
- ログ出力禁止フィールドリスト（full_name, date_of_birth, insurance_number 等）を設計書に明記
- CloudWatch Logs のアクセス権限を最小化（IAMポリシー設計）

---

### MOD-2: 監査ログの対象範囲が不十分

**該当箇所**: 8.3 監査ログ

**問題の詳細**:
「操作ユーザーID、操作種別、タイムスタンプ」のみで、アクセス対象リソース（患者ID等）・IPアドレス・失敗イベントが含まれていない。医療情報へのアクセス監査として不十分。

**影響**:
- 不正アクセスの事後追跡が困難
- コンプライアンス監査への対応不足
- インシデント時のフォレンジック困難

**対策**:
- 監査ログ必須フィールドの設計: `user_id`, `role`, `tenant_id`, `operation`, `resource_type`, `resource_id`, `client_ip`, `user_agent`, `result(success/fail)`, `timestamp`
- 認証失敗・権限エラー・機密データアクセスを必ずログ記録する設計
- ログの改ざん防止（CloudWatch Logs への書き込み専用権限、S3への別途アーカイブ）

---

### MOD-3: データ削除方針の未定義

**該当箇所**: 4.2 データ分類

**問題の詳細**:
「削除方針は今後のフェーズで定義する予定」と記載。保持期間（5年）は定義されているが、期間満了後の削除手順・対象データ範囲・バックアップからの削除が未設計。

**影響**:
- 保持期限超過データの無期限保存による個人情報保護法違反
- 退院・解約テナントデータの残存リスク

**対策**:
- データ削除フロー（論理削除→物理削除のタイムライン）を設計書に記載
- テナント解約時のデータエクスポートと削除手順を設計
- バックアップ（S3バージョニング・RDSバックアップ）からの削除ポリシーを明示

---

### MOD-4: prescriptions テーブルの pdf_url 設計リスク

**該当箇所**: 4.1 主要エンティティ（prescriptions テーブル）

**問題の詳細**:
`pdf_url` カラムに「PDF保存パス」として VARCHAR(500) が設定されている。これが公開URLである場合、URLを知る者が誰でも処方箋PDFにアクセスできる。署名付きURLの使用有無が不明。

**影響**:
- 処方箋PDFへの無認証アクセス
- URLの推測・漏洩による処方箋情報の不正取得

**対策**:
- S3オブジェクトを非公開（バケットACL: private）に設定
- アクセス時に署名付きURL（Presigned URL、有効期限付き）を動的生成する設計を明記
- pdf_url カラムに公開URLではなくS3オブジェクトキー（パス）を格納する設計を採用

---

### MOD-5: テナント分離の強制をアプリケーションのみに依存

**該当箇所**: 3.2 マルチテナント設計

**問題の詳細**:
テナント識別を「JWTトークンに含まれる `tenant_id` クレーム」に基づくとしているが、アプリケーション層でのtenantId検証が正しく実装されないと、クロステナントアクセスが発生する。スキーマ分離方式との整合性チェック設計も不明。

**影響**:
- アプリケーションバグによるクロステナントデータアクセス
- 医療機関間の患者情報漏洩

**対策**:
- 全クエリに `WHERE tenant_id = :tenant_id` を強制するORMレベルのミドルウェア設計を明記
- Row-Level Security（PostgreSQL RLS）の採用を検討し、DB層でのテナント分離を二重化
- テナント横断アクセスのインテグレーションテスト要件を設計書に含める

---

## Minor Issues & Positive Aspects

### 評価できる設計

- **bcrypt コスト係数12**: パスワードハッシュのコスト係数が適切（コスト12はOWASPの推奨範囲）
- **Secrets Manager 採用**: 機密情報を環境変数に直接埋め込まず、AWS Secrets Managerで管理する設計は適切
- **RDS + S3 暗号化**: ストレージレイヤーの暗号化（AES-256）が設計されている
- **プライベートサブネット配置**: RDS・Redis をVPCプライベートサブネットに配置する設計は適切
- **ウイルススキャン**: ファイルアップロード時のウイルススキャン実施が設計されている

### 軽微な改善点

- **TLS バージョン**: TLS 1.2 以上と記載されているが、TLS 1.3 推奨への言及があると良い
- **API バージョニング**: `/api/v1/` のバージョニングは将来の後方互換性維持に有効
- **S3 バージョニング**: 処方箋等の改ざん検知・復元に有効

---

## STRIDE 脅威モデル サマリー

| 脅威カテゴリ | 評価 | 主な問題 |
|------------|------|--------|
| Spoofing（なりすまし） | 不十分 | レート制限なし（CRIT-2）、MFA未設計 |
| Tampering（改ざん） | 不十分 | 内部通信平文（CRIT-5）、CSRF未設計（SIG-1） |
| Repudiation（否認） | 不十分 | 監査ログ範囲不足（MOD-2） |
| Information Disclosure（情報漏洩） | 不十分 | localStorage（CRIT-1）、平文内部通信（CRIT-5）、PIIログ（MOD-1） |
| Denial of Service（サービス妨害） | 不十分 | ファイルサイズ制限未定義（SIG-2）、認証エンドポイント無制限（CRIT-2） |
| Elevation of Privilege（権限昇格） | 不十分 | 医師の全患者アクセス（CRIT-4）、CORS ワイルドカード（CRIT-3） |

---

## 優先対応ロードマップ

### 即時対応（設計フェーズ完了前に必須）
1. CRIT-1: localStorage → HttpOnly Cookie 変更
2. CRIT-2: 認証エンドポイントへのレート制限設計
3. CRIT-3: CORS ワイルドカードの本番禁止を明記
4. CRIT-4: 医師ロールのリソースレベル認可設計

### 設計確定前に対応
5. CRIT-5: VPC 内部通信の TLS 化設計
6. SIG-1: CSRF 保護設計
7. SIG-2: ファイルアップロード制約の明示
8. MOD-4: 処方箋PDF の署名付きURL設計

### 実装フェーズ開始前に対応
9. SIG-3: トークン有効期限の短縮
10. SIG-4: リフレッシュトークンローテーション設計
11. MOD-1: PIIロギングポリシーの明文化
12. MOD-2: 監査ログ仕様の拡充
