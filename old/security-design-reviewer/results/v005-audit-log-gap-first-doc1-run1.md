# Security Design Review: MediConnect システム設計書

## Critical Issues

---

### [CRITICAL-1] JWTトークンの localStorage 保存によるXSS脆弱性

**Issue:** Section 5.1 において、アクセストークンを `localStorage` に保存する設計が明示されている。localStorageはJavaScriptから自由にアクセス可能であり、XSS攻撃が成功した場合、攻撃者はトークンを窃取してなりすましが可能になる。

**Impact:** 医療記録・処方箋・患者個人情報への不正アクセス。医療情報は高度な機密性を持ち、漏洩した場合の影響は極めて深刻。

**Countermeasures:**
- アクセストークンを `HttpOnly; Secure; SameSite=Strict` 属性付きCookieで管理する
- CookieベースのトークンはJavaScriptから読み取れないため、XSS経由の窃取リスクを排除できる
- リフレッシュトークンも同様にHttpOnly Cookieで管理すること

**Reference:** Section 5.1「クライアントはアクセストークンを `localStorage` に保存し」

---

### [CRITICAL-2] 認証失敗イベントの監査ログ記録要件が欠如

**Issue (Audit Log Gap — Priority Finding):** Section 8.3の監査ログ設計において、「操作ユーザーID、操作種別、タイムスタンプを含める」とされているが、**認証失敗（ログイン失敗）イベントを記録することが明示されていない**。セキュリティ監査において認証失敗の記録は最重要要件の一つである。

**Impact:** ブルートフォース攻撃・クレデンシャルスタッフィング攻撃の検知が不可能。インシデント発生時の事後追跡ができない。厚生労働省医療情報ガイドラインへの準拠にも影響する。

**Countermeasures:**
- 認証失敗ログに以下を含めて記録する設計を明示すること: タイムスタンプ、試行元IPアドレス、ユーザー識別子（メールアドレス等）、失敗理由コード
- 認証失敗の連続発生をアラートするSIEMルールを設計する

**Reference:** Section 8.3「監査ログ」、Section 5.1「認証フロー」

---

### [CRITICAL-3] 権限・ロール変更イベントの監査ログ記録要件が欠如

**Issue (Audit Log Gap — Priority Finding):** Section 8.3の監査ログ設計において、**ユーザーの権限変更・ロール変更イベントを記録することが明示されていない**。admin ロールによるユーザー管理操作（ロール付与・剥奪）の記録は、特権管理の観点で不可欠である。

**Impact:** 不正な権限昇格が発生した場合に発見が困難。内部不正行為（インサイダー脅威）の追跡ができない。コンプライアンス上の証跡が残らない。

**Countermeasures:**
- ロール変更・ユーザー有効化/無効化・管理操作について、変更前後の値・実施者・対象ユーザーを含む監査ログを記録する設計を追加する
- これらのログは一般的なアプリケーションログと分離し、改ざん防止措置（S3への別途保存、書き込み専用IAMポリシー等）を設計すること

**Reference:** Section 8.3「監査ログ」、Section 5.2「認可モデル」

---

### [CRITICAL-4] 機密データアクセスイベントの監査ログ記録要件が欠如

**Issue (Audit Log Gap — Priority Finding):** Section 8.3の監査ログ設計において、**機密データへのアクセスイベント（患者カルテ閲覧・処方箋参照・個人情報取得）を記録することが明示されていない**。電子カルテシステムにおいて、誰がいつどの患者情報を参照したかの追跡は法的・倫理的義務である。

**Impact:** 患者情報への不正アクセス（医師による担当外患者の閲覧等）が追跡不能。個人情報保護法・医療情報ガイドライン違反リスク。インシデント時の影響範囲特定が不可能。

**Countermeasures:**
- `GET /api/v1/patients/{id}` および `GET /api/v1/patients/{id}/prescriptions` の呼び出しごとに、アクセス者・アクセス対象患者ID・タイムスタンプ・アクセス元情報を記録する設計を明示する
- 患者データアクセスログは一般ログと分離し、保持期間（少なくとも診療録保持期間と同期間）を明示する

**Reference:** Section 8.3「監査ログ」、Section 4.2「データ分類」

---

### [CRITICAL-5] doctor ロールによる全患者データへの無制限アクセス

**Issue:** Section 5.2 において、「doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする」と明記されている。これは担当外患者の医療記録への無制限アクセスを許可するものであり、設計上の重大な認可欠陥である。

**Impact:** 医師が担当外患者の診断結果・処方内容・個人情報を自由に閲覧可能。マルチテナント設計においても、同一テナント内の全患者データが無防備に露出する。個人情報保護法・医療法違反リスク。

**Countermeasures:**
- doctor ロールのアクセス範囲を「当該医師が担当する患者」に限定する認可チェックを設計する
- `GET /api/v1/patients/{id}` において、リクエスト者が担当医師として割り当てられているかを検証するミドルウェアを設計する
- 緊急アクセス（担当外患者への一時的アクセス）が必要な場合は、承認フローと監査ログの組み合わせで設計すること

**Reference:** Section 5.2「doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする」

---

## Significant Issues

---

### [HIGH-1] VPC内部通信の平文設計

**Issue:** Section 6.1 において「VPC 内部の通信については内部ネットワークであるため平文で行う」と明示されている。マイクロサービス間通信（auth-service, patient-service, consultation-service, prescription-service）が暗号化されないため、VPC内部への侵入が成功した場合に医療情報が平文で傍受される。

**Impact:** 内部ネットワーク侵害時の横展開（ラテラルムーブメント）により、全サービス間通信の盗聴が可能。ゼロトラストアーキテクチャの原則に反する。

**Countermeasures:**
- サービス間通信にTLS（相互TLS: mTLS）を適用する設計を追加する
- ECS Fargate環境ではAWS App MeshまたはService Connect によるmTLS設計が実現可能

**Reference:** Section 6.1「VPC 内部の通信については内部ネットワークであるため平文で行う」

---

### [HIGH-2] ログイン・認証エンドポイントのレート制限欠如

**Issue:** Section 8.5 において、「高可用性を優先するため呼び出し制限は設けない設計とする」と明示されている。これはブルートフォース攻撃・クレデンシャルスタッフィング攻撃に対して完全に無防備な状態を設計上許容するものである。

**Impact:** 自動化された攻撃ツールによるパスワード総当たり攻撃が無制限に実行可能。医師・管理者アカウントの侵害リスクが極めて高い。

**Countermeasures:**
- IPアドレスごとのレート制限（例: 5回/分）をAPI GatewayまたはWAFで設計する
- 連続失敗後の一時的なアカウントロック機能を設計する（ただし、DoSによるアカウントロックのリスクも考慮してCAPTCHAとの組み合わせを推奨）
- リフレッシュトークンエンドポイント（`POST /api/v1/auth/refresh`）にも同様のレート制限を設計する

**Reference:** Section 8.5「高可用性を優先するため呼び出し制限は設けない設計とする」

---

### [HIGH-3] CORS設定のワイルドカード許可

**Issue:** Section 7.3 において `Access-Control-Allow-Origin: *` の設定が明示されており、「本番環境では必要に応じて絞り込みを検討する」と留保されている。医療情報を扱うシステムにおいてワイルドカードCORS設定は許容されない。

**Impact:** 任意のオリジンからのクロスオリジンリクエストが許可される。クレデンシャル付きリクエスト（Cookie認証への移行後）と組み合わさった場合、CSRF的な攻撃面が生じる。

**Countermeasures:**
- 許可するオリジンを明示的なホワイトリスト（本番ドメイン、モバイルアプリのスキーム等）で設計する
- 本番環境での適用を設計書に明記し、「今後検討」とする記述を削除する

**Reference:** Section 7.3「`Access-Control-Allow-Origin: *` を設定する」

---

### [HIGH-4] CSRF保護の設計欠如

**Issue:** Section 7.4 において、処方箋発行・患者情報更新などの状態変更操作に対するCSRF保護が「現フェーズのスコープ外」とされている。これらは医療行為に直結する重大な操作であり、CSRF脆弱性は許容できない。

**Note (Defense Layer Separation):** JWTによるAuthorizationヘッダー認証はCSRF緩和効果を持つが、localStorageからのトークン取得を前提とした設計のため、Cookie認証への移行（CRITICAL-1対応）後は独立したCSRF対策が必須となる。これらは別個の問題として扱う。

**Impact:** 攻撃者が悪意あるWebページを通じて、ログイン済み医師・管理者に意図しない処方箋発行・患者データ変更を実行させることが可能。

**Countermeasures:**
- Cookie認証採用時は `SameSite=Strict` 属性の設定を設計に明示する
- Double Submit Cookie パターンまたはCSRFトークンの設計を追加する
- 「スコープ外」とせず、現フェーズで設計決定を行うこと

**Reference:** Section 7.4「現フェーズのスコープ外とする」

---

### [HIGH-5] PIIを含むログ出力の制御欠如

**Issue:** Section 6.3 において「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする」とされている。個々のエンジニアの判断に委ねることは、誤操作による個人情報のログへの混入を防げない。

**Impact:** 患者の氏名・保険証番号・診断内容などがCloudWatch Logsに平文で記録される。ログにアクセスできる開発者・運用者に機密医療情報が露出する。

**Countermeasures:**
- PIIをログに記録することを原則禁止とし、必要な場合は仮名化・マスキング処理を必須とする設計ポリシーを明記する
- ログ出力ライブラリレベルでのフィルタリング機能（フィールド除外・マスキング）の採用を設計に含める

**Reference:** Section 6.3「エンジニアの判断に委ねる運用とする」

---

### [HIGH-6] 監査ログと一般ログの未分離

**Issue (Audit Log Quality):** Section 8.3 において、「システムの操作履歴はアプリケーションログとして CloudWatch Logs に記録する」とされており、セキュリティ監査ログが一般的なアプリケーションログと統合されている。分離されていない場合、監査ログの完全性保証・保持期間管理・アクセス制御が困難になる。

**Impact:** 監査ログの改ざん・削除が一般的なアプリケーション操作の権限で可能になる。監査目的のログ検索が困難。保持期間を診療録と同期させる管理ができない。

**Countermeasures:**
- セキュリティ監査ログ専用のCloudWatch Logs Groupを設計し、一般ログと分離する
- 監査ログの保持期間を診療録保持期間（5年以上）に合わせて明示する
- 監査ログへの書き込みは許可するが読み取り・削除は制限するIAMポリシーを設計する

**Reference:** Section 8.3「アプリケーションログとして CloudWatch Logs に記録する」

---

## Moderate Issues

---

### [MEDIUM-1] ファイルアップロードのファイル種別・サイズ制限の未定義

**Issue:** Section 7.2 において「ファイル種別・サイズの制限は実装フェーズで決定する」とされている。設計フェーズでの制限定義の欠如は、実装時に不十分な制限が設定されるリスクを高める。

**Impact:** 悪意あるファイル（実行可能ファイル、巨大ファイル）のアップロードによるサービス妨害・コード実行リスク。

**Countermeasures:**
- 許可するMIMEタイプ（例: image/jpeg, image/png, application/pdf）を設計書に明示する
- ファイルサイズの上限（例: 10MB）を設計段階で定義する
- S3への保存経路においてContent-Typeのサーバーサイド検証を設計に含める

**Reference:** Section 7.2「ファイル種別・サイズの制限は実装フェーズで決定する」

---

### [MEDIUM-2] バックエンドサーバーサイド入力検証の不足

**Issue:** Section 7.1 において「フロントエンドで入力検証が完了した状態でAPIに送信される設計」とされており、バックエンドでは「基本的な型チェック（JSONスキーマバリデーション）のみ」としている。フロントエンド検証のみに依存した設計は、APIを直接呼び出す攻撃に対して無防備である。

**Note (Defense Layer Separation):** フロントエンドバリデーションとサーバーサイドバリデーションは独立した防御層であり、一方の欠如は独立した問題として扱う。

**Impact:** SQLインジェクション・NoSQLインジェクション・コマンドインジェクション等の攻撃に対して脆弱。攻撃者はフロントエンドをバイパスしてAPIに直接悪意ある入力を送信できる。

**Countermeasures:**
- バックエンドでの完全な入力検証（型・長さ・形式・ビジネスロジック）を設計に明記する
- フロントエンド検証はUX目的に限定し、セキュリティの根拠としないことを設計方針に記載する

**Reference:** Section 7.1「フロントエンドで入力検証が完了した状態でAPIに送信される設計とする」

---

### [MEDIUM-3] サードパーティ依存関係の脆弱性管理の未定義

**Issue:** Section 8.2 において「脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定」とされている。特にTwilio Video SDK v2.27.0など特定バージョンが明記されており、既知脆弱性の存在確認が未実施の状態で採用されている可能性がある。

**Impact:** 既知脆弱性を持つライブラリの本番環境への展開。医療データを扱うシステムでのサプライチェーン攻撃リスク。

**Countermeasures:**
- CI/CDパイプラインへのSCA（Software Composition Analysis）ツール（Dependabot、OWASP Dependency-Check等）の統合を設計に含める
- 採用ライブラリの初期CVEスキャンを設計フェーズで実施し、結果を記録する

**Reference:** Section 8.2「脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定」

---

### [MEDIUM-4] アクセストークンの有効期限が過長

**Issue:** Section 5.1 において、アクセストークンの有効期限が「24時間」と設計されている。医療情報を扱うシステムにおいて、このような長時間有効なアクセストークンはトークン漏洩時のリスクを増大させる。

**Impact:** トークン窃取後、24時間にわたって患者医療情報への不正アクセスが継続する。

**Countermeasures:**
- アクセストークンの有効期限を15〜30分に短縮し、リフレッシュトークンによる再発行を設計する
- 医療情報システムのセキュリティガイドラインを参照し、適切な有効期限を定義する

**Reference:** Section 5.1「アクセストークン（有効期限: 24時間）」

---

### [MEDIUM-5] 医療機密情報のアプリケーションレベル暗号化の欠如

**Issue:** Section 6.2 において、「診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断」とされている。RDS暗号化（ストレージレベル）は、データベースへの論理的なアクセス権を持つユーザー（SQLクエリ権限を持つ開発者・DBA）からは保護されない。

**Impact:** データベースへのアクセス権を持つ内部関係者が、全患者の診断結果・処方内容に平文でアクセス可能。データベース侵害時に医療情報が直接露出する。

**Countermeasures:**
- 特に機密性の高いカラム（diagnosis, soap_note, medications等）に対してアプリケーションレベルの暗号化（フィールドレベル暗号化）を設計する
- 暗号化キーはAWS KMSで管理し、データベースアクセス権限とキー利用権限を分離する

**Reference:** Section 6.2「アプリケーションレベルでの追加暗号化は行わず」、Section 4.1（medical_records.diagnosis, soap_note, prescriptions.medications）

---

## Minor Improvements & Positive Aspects

---

### [MINOR-1] Redisセッション管理の設計

Section 5.3 において、リフレッシュトークンをRedisで管理しログアウト時に削除する設計は、トークン失効の即時性を確保するポジティブな設計である。ただし、Redisキーの設計として「ユーザーIDをキー」とする場合、1ユーザーが複数デバイスからログインする際のセッション管理（複数トークンの並存、デバイス単位の失効）を設計に追加することを推奨する。

---

### [MINOR-2] bcryptのコスト係数

Section 5.1 においてbcryptのコスト係数12の採用は適切である。現時点のハードウェア性能を考慮すると十分な強度であり、適切な設計決定として評価できる。

---

### [MINOR-3] マルチスキーマによるテナント分離

Section 3.2 においてスキーマ分離によるマルチテナント設計は、テナント間データ混在リスクを低減する良い設計判断である。ただし、JWTの `tenant_id` クレームの検証が全エンドポイントで確実に実施されることを実装仕様で明確にすることを推奨する。

---

### [MINOR-4] シークレット管理

Section 8.1 においてAWS Secrets Managerによるシークレット管理は適切な設計である。ECSタスクロールへのシークレット取得権限の最小権限設計（特定シークレットのみ許可）についても明示することを推奨する。

---

## Summary

| Severity | Count | Key Issues |
|----------|-------|------------|
| Critical | 5 | 監査ログ3件（認証失敗・権限変更・機密データアクセスの記録欠如）、localStorage JWTトークン保存、医師による全患者データ無制限アクセス |
| High | 6 | VPC内部平文通信、レート制限欠如、CORS wildcard、CSRF未設計、PII ログ制御欠如、監査ログ・一般ログ未分離 |
| Moderate | 5 | ファイル制限未定義、サーバーサイドバリデーション不足、脆弱性管理未定義、トークン有効期限過長、フィールド暗号化欠如 |
| Minor | 4 | Redisマルチセッション、bcrypt評価、テナント分離評価、シークレット管理評価 |

医療情報を扱うシステムとして、特に監査ログの記録要件（認証失敗・権限変更・機密データアクセス）の完全な欠如と、医師による全患者データへの無制限アクセス設計は最優先で対処が必要である。厚生労働省の医療情報ガイドラインへの準拠を謳う設計として、これらの欠如は重大な適合性リスクを招く。
