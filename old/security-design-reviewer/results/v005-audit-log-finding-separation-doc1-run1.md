# Security Design Review: MediConnect システム設計書

**Reviewer Prompt:** v005-variant-audit-log-finding-separation
**Document:** test-document-1.md
**Run:** 1

---

## Executive Summary

MediConnect は医療機関向けの電子カルテ・遠隔診療プラットフォームであり、患者の機密医療情報を扱う高リスクシステムである。設計書の評価を通じて、複数の重大なセキュリティ欠陥が確認された。これらは放置すると患者データの漏洩、不正アクセス、規制違反を招く可能性がある。

---

## Critical Issues

### FINDING-001: JWTアクセストークンのlocalStorage保存によるXSS脆弱性

**該当箇所:** セクション5.1「認証フロー」

**問題詳細:**
設計書は「クライアントはアクセストークンを `localStorage` に保存する」と明示している。`localStorage` はJavaScriptから直接アクセス可能なため、XSS攻撃が成立した場合にトークンが窃取され、攻撃者がセッションを乗っ取ることができる。

**影響:**
- XSS脆弱性との連鎖で認証済みユーザーのセッション完全掌握
- 医師・管理者権限の不正取得による患者全データへのアクセス
- 医療情報漏洩・改ざんリスク

**対策:**
- アクセストークンを `HttpOnly` フラグ付きSecure Cookieに変更する
- CSRF対策を同時に設計する（SameSite=Strict またはCSRFトークン）

---

### FINDING-002: アクセストークン有効期限24時間の過剰な長さ

**該当箇所:** セクション5.1「認証フロー」

**問題詳細:**
アクセストークンの有効期限が24時間に設定されている。医療情報システムにおいて、これはトークン漏洩時の被害期間として過大であり、リスクが適切に管理されていない。

**影響:**
- トークン盗取後、最大24時間にわたり不正アクセスが継続可能
- 医療情報の長時間にわたる不正閲覧・取得リスク

**対策:**
- アクセストークン有効期限を15〜30分程度に短縮する
- リフレッシュトークンによるサイレント再発行フローを設計する

---

### FINDING-003: 医師ロールの患者データ横断アクセス（認可設計の欠陥）

**該当箇所:** セクション5.2「認可モデル」

**問題詳細:**
設計書は「doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする」と明示している。これは担当患者以外の医療情報への無制限アクセスを許容する設計であり、需要を知る権利（Need-to-Know）原則に反する。

**影響:**
- 医師による担当外患者の診療記録・処方内容・保険情報への不正閲覧
- 日本の個人情報保護法・医療情報ガイドライン違反のリスク
- 内部不正・情報漏洩の温床

**対策:**
- doctor ロールのアクセスを「担当患者」に限定する認可設計を追加する
- `GET /api/v1/patients/{id}` および `GET /api/v1/patients/{id}/records` に担当医師検証ロジックを明示設計する

---

### FINDING-004: VPC内部通信の平文通信設計

**該当箇所:** セクション6.1「通信の暗号化」

**問題詳細:**
「VPC 内部の通信については内部ネットワークであるため平文で行う」と明記されている。マイクロサービス間・サービスとデータストア間の通信は、患者の診断情報・処方内容・保険情報を含む医療機密情報を搬送するため、「内部だから安全」という前提は成立しない。

**影響:**
- VPC内侵入（ラテラルムーブメント）が発生した場合、全医療情報が平文で傍受可能
- ECS Fargate コンテナ間・RDS接続での機密データ平文露出
- マルチテナント環境での複数医療機関データの同時漏洩リスク

**対策:**
- サービス間通信（ECS間・ECS-RDS間・ECS-Redis間）にTLS暗号化を適用する
- AWS Certificate Manager + Application Load Balancerまたはサービスメッシュ（AWS App Mesh）の採用を検討する

---

### FINDING-005: CORS ワイルドカード設定による認証情報漏洩リスク

**該当箇所:** セクション7.3「CORS設定」

**問題詳細:**
「`Access-Control-Allow-Origin: *` を設定する」と明記されており、本番環境での絞り込みが「必要に応じて検討」という任意対応に留まっている。ワイルドカード設定では任意オリジンからの認証情報付きリクエストのクロスオリジン利用を許容する。

**影響:**
- 悪意あるWebサイトからのクロスオリジンリクエストによる認証済みAPIの不正利用
- 医療情報APIへの不正な横断アクセス
- CSRF攻撃と組み合わせた患者データ窃取

**対策:**
- 許可オリジンを本番環境で使用するドメインに明示的に制限する設計を確定する
- クレデンシャルを伴うリクエストに対してワイルドカードを使用しない設計とする

---

## Significant Issues

### FINDING-006: 認証エンドポイントのレート制限未設計

**該当箇所:** セクション8.5「認証エンドポイント保護」

**問題詳細:**
「`/api/v1/auth/login` エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計とする」と明示されている。これはブルートフォース攻撃・クレデンシャルスタッフィング攻撃への完全な無防備を意味する。

**影響:**
- 医師・管理者アカウントへの自動化ブルートフォース攻撃が無制限に実行可能
- 全患者データへの不正アクセス起点となる

**対策:**
- APIゲートウェイレベルでのレート制限（IPアドレスベース、例：10回/分）を設計する
- bcryptコスト係数12と組み合わせても、並列・分散攻撃への対策としてレート制限は必須

---

### FINDING-007: state-changing APIのCSRF保護未設計

**該当箇所:** セクション7.4「セッション系APIの保護」

**問題詳細:**
「医師による処方箋発行（`POST /api/v1/prescriptions`）や患者情報更新などのstate-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外とする」と明記されている。医療上の重要操作（処方箋発行・患者情報更新）に対するCSRF保護が設計から除外されている。

**影響:**
- CSRF攻撃による医師権限での不正処方箋発行
- 患者情報の不正改ざん
- 医療ミスや患者被害に直結するリスク

**対策:**
- SameSite=Strict Cookie設定またはCSRFトークン機構を設計フェーズで確定する
- JWT+Bearerヘッダー方式のみではCSRF対策として不十分（FINDING-001との相互作用に注意）

---

### FINDING-008: 認証失敗・権限変更・機密データアクセスの監査ログ記録要件未定義（独立Finding）

**該当箇所:** セクション8.3「監査ログ」

**問題詳細:**
設計書は「ログには操作ユーザーID、操作種別、タイムスタンプを含める」と記載しており、監査ログの存在自体は設計されている。しかし以下のセキュリティ重要イベントに対する記録要件が明示的に定義されていない：

- **認証失敗**: ログイン失敗の記録要件（回数・IP・アカウント情報）
- **権限変更**: ロール変更・管理者権限付与の記録要件
- **機密データアクセス**: 患者の診断情報・処方内容・保険情報へのアクセス記録要件

「ログに操作ユーザーID・操作種別・タイムスタンプを含める」という設計は、これら重要イベントの記録を保証するものではない。

**影響:**
- 不正アクセスの事後検知・フォレンジック分析が不可能
- 内部不正・特権悪用の追跡手段の欠如
- 日本の医療情報ガイドライン（厚生労働省）のアクセスログ要件への不適合リスク
- セキュリティインシデント発生時の原因特定・証拠保全の失敗

**対策:**
- 認証失敗イベントの記録要件を明示的に設計する（失敗ユーザーID/メール、IPアドレス、タイムスタンプ、失敗理由）
- 権限変更イベントの記録要件を設計する（変更実行者、対象ユーザー、変更前後のロール、タイムスタンプ）
- 機密データアクセスの記録要件を設計する（アクセス者、対象患者ID、操作種別、タイムスタンプ）
- 上記ログの改ざん防止・保持期間・アクセス制御を設計に含める

---

### FINDING-009: フロントエンド検証のみに依存したサーバーサイド検証の不備

**該当箇所:** セクション7.1「入力検証方針」

**問題詳細:**
「フロントエンドで入力検証が完了した状態でAPIに送信される設計とする。バックエンドでは基本的な型チェック（JSONスキーマバリデーション）のみ実施する」と明記されている。フロントエンド検証はバイパス可能であり、インジェクション攻撃への根本的な防御にならない。

**影響:**
- SQLインジェクション攻撃による患者全データへの不正アクセス・削除
- NoSQLインジェクション、コマンドインジェクションのリスク
- 医療情報システムとして規制要件上重大な問題

**対策:**
- サーバーサイドでの完全なビジネスロジック検証・インジェクション対策を設計に追加する
- フロントエンド検証はUX向上目的に留め、セキュリティ保証はサーバーサイドで行う設計方針を明示する

---

## Moderate Issues

### FINDING-010: 患者PIIのログ出力ポリシーの不定義

**該当箇所:** セクション6.3「個人情報の取り扱い」

**問題詳細:**
「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする」と記載されている。医療情報システムにおいて、PIIのログ出力をエンジニア個人の判断に委ねることは、設計レベルでの制御の欠如を意味する。

**影響:**
- 患者氏名・保険番号・診断内容がCloudWatch Logsに平文記録されるリスク
- ログアクセス権限を持つ関係者への意図せぬ情報露出
- 個人情報保護法違反リスク

**対策:**
- PIIをログに出力しないルールを設計レベルで明示する
- ログの構造化・マスキングポリシーをアプリケーション設計に組み込む

---

### FINDING-011: ファイルアップロードの種別・サイズ制限未定義

**該当箇所:** セクション7.2「ファイルアップロード」

**問題詳細:**
「ファイル種別・サイズの制限は実装フェーズで決定する」とされており、設計段階での制限が定義されていない。ウイルススキャンは実施されるが、種別・サイズ制限なしでは他のリスクが残存する。

**影響:**
- 悪意あるファイル形式（実行ファイル等）のアップロードによるサーバーサイド攻撃
- 大容量ファイルによるDoS攻撃
- S3ストレージの意図しない消費

**対策:**
- 許可するMIMEタイプ（画像・PDF等）を設計段階で明示する
- ファイルサイズ上限をAPIゲートウェイ・アプリケーション双方で設計する

---

### FINDING-012: サードパーティ依存関係の脆弱性管理方針の欠如

**該当箇所:** セクション8.2「サードパーティ依存関係」

**問題詳細:**
「脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定」とされており、設計段階での依存関係管理が計画されていない。Twilio Video SDK v2.27.0等の外部ライブラリを使用しており、既知の脆弱性を含む可能性がある。

**影響:**
- 既知の脆弱性を持つライブラリが本番稼働するリスク
- 医療情報を扱うシステムへの既知攻撃手法の適用

**対策:**
- CI/CDパイプラインへのSCA（ソフトウェア構成分析）ツール組み込みを設計に含める
- 定期的なdependency audit（週次・月次）の自動化を設計に明示する

---

## Positive Aspects

- bcryptコスト係数12による適切なパスワードハッシュ設計
- AWS Secrets Managerによるシークレット管理
- RDS Multi-AZ・マルチスキーマによるテナント分離設計
- VPCプライベートサブネットへのデータストア配置
- S3バージョニングによるデータ保護

---

## Summary Table

| Finding | Severity | Category |
|---------|----------|----------|
| FINDING-001: localStorageトークン保存 | Critical | 認証設計 |
| FINDING-002: トークン有効期限24時間 | Critical | 認証設計 |
| FINDING-003: 医師の患者全件アクセス | Critical | 認可設計 |
| FINDING-004: VPC内部平文通信 | Critical | データ保護 |
| FINDING-005: CORSワイルドカード | Critical | API セキュリティ |
| FINDING-006: 認証エンドポイントレート制限なし | Significant | 入力検証 |
| FINDING-007: CSRF保護未設計 | Significant | API セキュリティ |
| FINDING-008: 監査ログ記録要件未定義 | Significant | インフラ・監査 |
| FINDING-009: サーバーサイド検証不備 | Significant | 入力検証 |
| FINDING-010: PIIログポリシー不定義 | Moderate | データ保護 |
| FINDING-011: ファイルアップロード制限未定義 | Moderate | 入力検証 |
| FINDING-012: 依存関係管理方針欠如 | Moderate | インフラ |
