# Security Design Review: MediConnect システム設計書

## Review Metadata
- Prompt: v004-variant-input-finding-separation
- Document: test-document-1.md (MediConnect)
- Run: 1

---

## Critical Issues

### [CRITICAL-01] JWTアクセストークンのlocalStorage保存によるXSS脆弱性

**該当箇所**: セクション 5.1 認証フロー（ステップ4）

**問題詳細**:
アクセストークンを `localStorage` に保存する設計は、XSS攻撃が成立した場合にトークンの完全な窃取を許す。MediConnectは医療機密情報・保険情報・処方データを扱うシステムであり、トークン窃取はすべてのデータへの不正アクセスに直結する。localStorage はJavaScriptから制限なくアクセス可能であり、HttpOnly Cookieのような保護機構がない。

**影響分析**:
- XSS脆弱性（別途存在する入力検証不備により誘発されやすい）と組み合わさると、攻撃者はトークンを窃取し、患者の電子カルテ・処方箋・保険情報に自由にアクセス可能
- アクセストークンの有効期限が24時間と長期設定されているため、窃取後の被害持続時間が大きい
- 厚生労働省医療情報ガイドライン準拠の観点からも、医療情報の不正流出は重大なコンプライアンス違反

**対策**:
- トークン保存を HttpOnly + Secure + SameSite=Strict の Cookie に変更する
- アクセストークンの有効期限を15〜30分程度に短縮し、リフレッシュトークンによるサイレント更新を実装する
- メモリ内保持（変数）を検討するが、ページリロード時の再認証フローを設計する必要がある

---

### [CRITICAL-02] フロントエンド依存の入力検証（サーバーサイド検証の欠如）

**該当箇所**: セクション 7.1 入力検証方針

**問題詳細**:
「フロントエンドで入力検証が完了した状態でAPIに送信される設計とする。バックエンドでは基本的な型チェック（JSONスキーマバリデーション）のみ実施する」という方針は、フロントエンドの検証をバイパスした直接APIリクエストに対して無防備である。攻撃者はブラウザの開発者ツールやcurlなどのツールを使い、フロントエンドの検証を完全に迂回してAPIを直接呼び出すことができる。

**影響分析**:
- SQLインジェクション、NoSQLインジェクション、コマンドインジェクションの攻撃面が拡大する
- `POST /api/v1/patients/{id}/records` への悪意ある入力により、診療記録データベースへの不正操作が可能
- `POST /api/v1/prescriptions` への不正な処方薬データ注入により、処方箋の改ざん・偽造が成立しうる
- XSS攻撃のペイロードをAPIから挿入し、他のユーザーが閲覧する際に実行させることが可能

**対策**:
- バックエンドで完全な入力検証を必須とする（フロントエンド検証は UX 補助目的のみ）
- express-validatorやZodなどのサーバーサイドバリデーションライブラリを導入する
- すべての文字列フィールドにサニタイズ処理を実装する
- SQLクエリはパラメータ化クエリ（プリペアドステートメント）を必須とする

---

### [CRITICAL-03] サーバーサイドでの注入攻撃対策の欠如（フロントエンド検証バイパス後の後段防御不在）

**該当箇所**: セクション 7.1 入力検証方針

**問題詳細**:
CRITICAL-02がフロントエンド検証の欠如を指摘するのに対し、本Findingはバックエンド側において注入攻撃専用の防御レイヤー（ORM強制、出力エスケープ、SQLパラメータ化）が設計書に明示されていない点を独立した問題として報告する。型チェック（JSONスキーマバリデーション）はデータ型の妥当性を検証するが、型が正しい悪意あるペイロード（例: 正しいVARCHAR型のSQLインジェクション文字列）を遮断しない。

**影響分析**:
- PostgreSQLへの直接SQLインジェクションにより、全テナントの患者データ・医療記録が漏洩する可能性がある
- マルチスキーマ方式のテナント分離が、SQLインジェクションによってスキーマを横断される危険がある
- `soap_note`（TEXT型）や `diagnosis`（TEXT型）などの自由記述フィールドは特に高リスク

**対策**:
- PostgreSQLアクセスにはORMを必須とし、生のSQLクエリを禁止する設計方針を明示する（SequelizeまたはPrismaの採用を設計書に記載する）
- HTMLを返すエンドポイントでは出力エスケープの実装を明示する
- SOAP Noteなどのリッチテキストフィールドには許可リスト方式のサニタイズを設計する

---

### [CRITICAL-04] CSRF保護の完全な欠如

**該当箇所**: セクション 7.4 セッション系 API の保護

**問題詳細**:
「state-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外とする」と明記されており、CSRF保護が設計されていない。対象となる操作には処方箋発行（`POST /api/v1/prescriptions`）、患者情報更新（`PUT /api/v1/patients/{id}`）が含まれる。CORSがワイルドカード設定（CRITICAL-05参照）であることと組み合わさると、攻撃者が作成した悪意あるWebページからのクロスサイトリクエストが成立しやすくなる。

**影響分析**:
- 医師がログイン状態で悪意あるサイトを閲覧した場合、医師の権限で偽の処方箋が発行される
- 患者が悪意あるリンクをクリックした場合、患者本人の情報が書き換えられる
- 医療システムとしての信頼性・完全性が根本から損なわれる

**対策**:
- CSRFトークン（Double Submit Cookie パターンまたはSynchronizer Token Pattern）を設計する
- Cookie保存に移行した場合（CRITICAL-01の対策）は SameSite=Strict を設定することで緩和できる
- state-changingなすべてのエンドポイントにCSRF保護を適用する対象リストを設計書に明示する

---

### [CRITICAL-05] JWTステートレス性によるCSRF緩和への過度な依存（独立Finding）

**該当箇所**: セクション 5.1 認証フロー、セクション 7.4

**問題詳細**:
JWTをAuthorizationヘッダーで送信するケースではCSRFが成立しにくいという前提があるが、本設計ではこの前提が脆弱である。現在、トークンはlocalStorageに保存されておりAuthorizationヘッダー送信を想定しているが、CRITICAL-01の対策でCookieに移行した場合にCSRF保護が完全に欠落することになる。また、「JWTによるCSRF緩和」は明示的なCSRFトークンやSameSite属性と同等の保護を提供するものではなく、設計書に独立したCSRF対策として記載されていない。

**影響分析**:
- トークン保管方法の変更（将来的な改善）がCSRF脆弱性を新たに導入するリスクがある
- 設計上の防御根拠が暗黙的であり、レビューやセキュリティ監査で見落とされやすい

**対策**:
- CSRFトークン または SameSite Cookie を独立した対策として設計書に明記する（JWTの副作用として記述しない）
- CORSとCSRF保護を連携した多層防御として設計する

---

## Significant Issues

### [HIGH-01] CORSワイルドカード設定（クレデンシャルリクエストとの組み合わせリスク）

**該当箇所**: セクション 7.3 CORS設定

**問題詳細**:
`Access-Control-Allow-Origin: *` を設定し「本番環境では必要に応じて絞り込みを検討する」という記述は、本番適用リスクが高い。医療情報APIにワイルドカードCORSが適用された場合、任意のオリジンからのリクエストが許可される。クレデンシャル付きリクエスト（CookieやAuthorizationヘッダー）との組み合わせは技術的に制限されるが、設計書にその認識が示されていない。

**影響分析**:
- 本番環境でのワイルドカードCORS維持は、悪意ある第三者サイトからのAPIアクセスを許容する
- クロスオリジンからの情報読み取りが可能になるケースがある
- 「必要に応じて検討」という記述では本番リリース前の実施が保証されない

**対策**:
- 許可オリジン（医療機関の管理ドメイン、患者向けアプリのドメイン）を明示的に設計書に列挙する
- 環境別（開発・ステージング・本番）のCORS設定方針を明記する
- クレデンシャル付きリクエストを許可する場合はワイルドカードが使用できない点を設計に反映する

---

### [HIGH-02] VPC内部通信の平文化（内部ネットワーク信頼の過信）

**該当箇所**: セクション 6.1 通信の暗号化

**問題詳細**:
「VPC内部の通信については内部ネットワークであるため平文で行う」という設計は、内部ネットワークが完全に安全であるという前提に依存している。ECS FargateとRDS間、各マイクロサービス間の通信が平文であれば、VPC内のネットワーク盗聴（横展開した攻撃者、誤設定されたセキュリティグループ、クラウドプロバイダ内部の問題）により医療情報が露出する。

**影響分析**:
- マイクロサービス間を流れる診断内容・処方箋データが平文で観測可能
- Zero Trust原則に反する設計であり、医療情報ガイドライン準拠の観点から問題がある
- コンテナ侵害が成功した場合、横展開によりVPC内トラフィックのスニッフィングが可能

**対策**:
- サービス間通信にTLS（mTLS）を適用する設計を採用する
- AWS内部でのservice meshやAWS PrivateLinkの活用を検討する
- 最低限、RDS接続にはSSL/TLS証明書を要求する設定を明示する

---

### [HIGH-03] doctorロールによる全患者データ無制限参照

**該当箇所**: セクション 5.2 認可モデル

**問題詳細**:
「doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする」と明記されている。これは最小権限の原則に反し、医師が担当していない患者の医療情報にアクセスできる状態を設計上許容している。

**影響分析**:
- 悪意ある医師が他の患者（有名人、知人等）の医療情報を閲覧できる
- 内部不正のリスクが高く、患者のプライバシー権が侵害される
- 個人情報保護法・医療情報ガイドライン上の問題となる

**対策**:
- `GET /api/v1/patients/{id}` へのアクセス時に、要求医師と患者の診療関係（担当医師・予約・過去診療記録）の存在を検証する設計を追加する
- 緊急アクセス（Break Glass）として全患者参照が必要な場合は、専用の監査ログ付き緊急アクセス機構として設計する

---

### [HIGH-04] ファイルアップロードのファイル種別・サイズ制限の未設計

**該当箇所**: セクション 7.2 ファイルアップロード

**問題詳細**:
「ファイル種別・サイズの制限は実装フェーズで決定する」と記載されており、設計段階で制限が未定義である。ウイルススキャンは実装されているが、種別・サイズ制限がなければ、悪意あるファイル（偽装されたスクリプト、過大なファイルによるDoS）のアップロードを防げない。

**影響分析**:
- 実行可能ファイルやWebShellをアップロードされた場合、サーバーサイドでの実行リスク（設定ミスがあった場合）
- 大容量ファイルの連続アップロードによるストレージ枯渇・コスト増大
- S3への保存ファイルが患者に対して適切に隔離されていない可能性

**対策**:
- 許可するMIMEタイプ（image/jpeg, image/png, application/pdf など）を設計書に明示する
- ファイルサイズ上限（例: 50MB）を設計段階で定義する
- アップロードしたファイルはユーザーが提供したファイル名をそのまま使用しない（UUIDにリネーム）
- S3の公開設定を明示し、患者データは署名付きURLでのみアクセス可能とする設計を明記する

---

### [HIGH-05] ログインエンドポイントのレート制限なし（ブルートフォース攻撃への無防備）

**該当箇所**: セクション 8.5 認証エンドポイント保護

**問題詳細**:
「高可用性を優先するためログイン呼び出し制限は設けない設計とする」と明記されており、ブルートフォース攻撃・クレデンシャルスタッフィング攻撃に対して無防備である。医療システムとして医師・患者アカウントの不正ログインは重大な影響をもたらす。

**影響分析**:
- アカウント総当たり攻撃によるログイン成功リスク
- 漏洩した認証情報リスト（クレデンシャルスタッフィング）を利用した大規模不正アクセス
- リフレッシュトークンエンドポイントへの同様の攻撃

**対策**:
- IPアドレスベースのレート制限（例: 10回/分）をAPI Gatewayまたはミドルウェアで実装する設計を追加する
- アカウントベースのロックアウト（例: 連続5回失敗で一時ロック）を設計する（アカウント列挙保護と組み合わせること）
- AWS WAFのマネージドルール（ブルートフォース保護）の活用を検討する
- `POST /api/v1/auth/refresh` にも同様のレート制限を設計する

---

### [HIGH-06] アクセストークン有効期限の過長設定（24時間）

**該当箇所**: セクション 5.1 認証フロー

**問題詳細**:
アクセストークンの有効期限が24時間と設定されている。JWTはステートレスであり、有効期限内は発行後に無効化できない（Redisでのリフレッシュトークン管理はあるが、アクセストークンは対象外）。

**影響分析**:
- トークン窃取が発生した場合、最大24時間にわたって攻撃者がAPIを呼び出せる
- 医療従事者のアカウント侵害時に即時無効化が困難

**対策**:
- アクセストークンの有効期限を15〜60分に短縮する
- 強制ログアウト機能のために、トークンのブラックリスト（Redis）または jti クレームによる無効化機構を設計する

---

## Moderate Issues

### [MED-01] PIIを含むログ出力方針の未定義

**該当箇所**: セクション 6.3 個人情報の取り扱い

**問題詳細**:
「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする」と記載されている。医療情報を含む個人情報のログ出力は個人情報保護法・医療情報ガイドラインで厳格に規制されており、エンジニアの個別判断に依存することはポリシー違反を招くリスクがある。

**対策**:
- PIIを含むデータのログ出力禁止方針を設計書に明記する
- ログに含めてよい情報（ユーザーID、テナントID、操作種別、タイムスタンプ）の許可リストを定義する
- 自動的なPII検出・マスキングの仕組み（ログパイプライン）を検討する

---

### [MED-02] テナント分離の検証設計が不明瞭

**該当箇所**: セクション 3.2 マルチテナント設計

**問題詳細**:
テナント識別をJWTの `tenant_id` クレームに基づくと記述されているが、各サービスでテナント分離の検証がどのように行われるかが明示されていない。doctorロールが全患者データを参照できる設計（HIGH-03）と組み合わさると、テナントを跨いだデータアクセスのリスクがある。

**対策**:
- テナント分離を強制するミドルウェアの設計を明示する
- すべてのデータクエリに `tenant_id` フィルタを必須とする設計方針を記載する
- テナント間データアクセスを試みた場合のエラーレスポンスと監査ログ出力を設計する

---

### [MED-03] サードパーティ脆弱性管理の後回し

**該当箇所**: セクション 8.2 サードパーティ依存関係

**問題詳細**:
Twilio Video SDK v2.27.0 など特定のバージョンが記載されているが、「脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定」と後回しにされている。リリース時点での既知脆弱性が未検証のままシステムが稼働するリスクがある。

**対策**:
- リリース前にSBOM（ソフトウェア部品表）を作成し、既知脆弱性スキャン（npm audit、Snyk等）を実施する方針を設計に盛り込む
- CI/CDパイプラインに脆弱性スキャンを組み込む設計を追加する

---

### [MED-04] アプリケーションレベルの医療機密情報の追加暗号化なし

**該当箇所**: セクション 6.2 保存データの暗号化

**問題詳細**:
「診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している」と記載されている。RDS暗号化はディスクレベルの保護であり、データベース権限を持つ内部者による読み取りを防げない。

**対策**:
- 特に機密度の高い診断内容（`diagnosis`、`soap_note`）については、アプリケーションレベルでの追加暗号化（AWS KMSキーを用いた列暗号化）の要否を検討し、設計書に判断根拠を明記する
- DBアクセス権限を最小化するIAMロール設計を明記する

---

## Minor Improvements & Positive Aspects

### [INFO-01] Secrets Managerの採用（良好な設計）
セクション 8.1 にてAWS Secrets Managerによる機密設定値の管理が設計されており、環境変数への直接ハードコードを避けている点は適切である。

### [INFO-02] bcryptのコスト係数12（良好な設計）
パスワード検証にbcrypt（コスト係数12）を使用しており、ブルートフォース耐性のあるパスワードハッシュが設計されている点は適切である。

### [INFO-03] 監査ログの基本設計
セクション 8.3 にて操作ユーザーID・操作種別・タイムスタンプを含む監査ログが設計されている点は良好である。ただし、認証失敗・権限昇格・患者データアクセスなどセキュリティイベントに特化したログ項目の明示が推奨される。

### [INFO-04] リフレッシュトークンのRedis管理によるログアウト対応
リフレッシュトークンをRedisで管理しログアウト時に削除する設計は、セッション無効化の観点から適切である。アクセストークンの無効化機構（HIGH-06）の補完として維持・強化すべきである。

### [INFO-05] データ保持期間の法令準拠記載
医療法施行規則第22条に基づく診療録5年保持が明記されている点は適切である。ただし、削除方針（「今後のフェーズで定義」）は設計段階で基本方針を確立することが推奨される。

---

## Summary

| 重大度 | 件数 | 主要テーマ |
|--------|------|-----------|
| Critical | 5件 | localStorage JWT保存、フロントエンド依存検証（入力検証欠如・注入対策欠如を分離）、CSRF保護欠如（一般・JWT依存を分離） |
| High | 6件 | CORSワイルドカード、内部通信平文、全患者参照権限、ファイルアップロード未設計、レート制限なし、トークン有効期限過長 |
| Moderate | 4件 | PIIログ方針未定義、テナント分離検証不明、依存関係管理後回し、医療情報追加暗号化なし |
| Minor/Positive | 5件 | Secrets Manager採用、bcrypt適切設定、監査ログ基本設計、リフレッシュトークン管理、法令準拠記載 |

**最優先対応事項**: CRITICAL-01（localStorage JWT）、CRITICAL-04（CSRF保護欠如）、CRITICAL-02/03（入力検証・注入対策の二層不備）、HIGH-05（ログインレート制限なし）は医療情報システムとして設計フェーズで必ず解決すべき問題である。
