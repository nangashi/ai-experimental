# Security Design Review: MediConnect システム設計書

## Executive Summary

MediConnect は医療機関向けの電子カルテ・遠隔診療プラットフォームであり、患者の医療情報・保険情報・個人情報といった高感度データを扱う。本レビューでは、設計書に明示されていないセキュリティ上の欠缺を特定し、重大度順に報告する。

---

## Critical Issues

### C1. 医療機密情報のアプリケーション層暗号化欠如（暗号化レイヤー分析）

**該当箇所**: セクション 6.2「保存データの暗号化」

**問題の詳細**:

設計書は以下のように明示している:

> 「診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している。」

暗号化レイヤー分析の観点から評価すると：

| データカテゴリ | 保管場所 | 指定された暗号化レイヤー | 十分性 |
|---|---|---|---|
| 患者氏名・生年月日・電話番号・メールアドレス | PostgreSQL (patients テーブル) | ストレージ層のみ（RDS AES-256） | **不十分** |
| 保険証番号 (`insurance_number`) | PostgreSQL (patients テーブル) | ストレージ層のみ（RDS AES-256） | **不十分** |
| 診断内容 (`diagnosis`)・SOAPノート (`soap_note`) | PostgreSQL (medical_records テーブル) | ストレージ層のみ（RDS AES-256） | **不十分** |
| 処方薬情報 (`medications` JSONB) | PostgreSQL (prescriptions テーブル) | ストレージ層のみ（RDS AES-256） | **不十分** |
| 検査画像・処方箋 PDF | S3 | ストレージ層のみ（SSE-S3） | **要検討** |

**なぜ不十分か**:

- **ストレージ層暗号化（RDS暗号化/TDE）の保護範囲**: 物理メディアの盗難や、AWSインフラレベルでの不正アクセスから保護する。しかし、アプリケーション資格情報やデータベース資格情報を持つ攻撃者に対しては保護を提供しない。RDS暗号化が有効であっても、データベースに接続できる権限を持つユーザー（DBA、バックドアを仕掛けた攻撃者、内部不正者）からは平文でデータが見える。
- **アプリケーション層暗号化の必要性**: 医療情報（診断内容、SOAPノート、処方情報）・保険証番号は高感度PIIであり、コンプライアンス要件（日本の医療情報ガイドライン）および内部不正脅威に対応するため、フィールドレベル暗号化が求められる。
- **マルチテナント環境のリスク**: 本設計はマルチスキーマ方式を採用しているが、DB管理者は全テナントのデータに平文でアクセス可能であり、テナント間の論理分離のみでは医療情報の保護として不十分である。

**影響**:
- 内部不正者またはデータベース資格情報を取得した攻撃者が、全患者の医療情報・保険証番号・連絡先を平文で参照・窃取できる。
- 日本の医療情報ガイドライン（厚生労働省）への非準拠リスク。

**推奨対策**:
1. `insurance_number`、`diagnosis`、`soap_note`、`medications` カラムに対してアプリケーション層フィールドレベル暗号化を実装する（例: AWS KMS + アプリケーション内での暗号化/復号）。
2. 暗号化キーはRDSインスタンスとは独立したKMSキーで管理し、キーへのアクセス制御を最小権限で設計する。
3. PII（氏名・電話番号・メール）についても暗号化対象として検討し、データ分類に基づく暗号化ポリシーを策定する。

---

### C2. VPC内部通信の平文化

**該当箇所**: セクション 6.1「通信の暗号化」

**問題の詳細**:

> 「VPC 内部の通信については内部ネットワークであるため平文で行う。」

マイクロサービス間（auth-service, patient-service, consultation-service, prescription-service）およびサービスとデータストア（PostgreSQL, Redis）間の通信が暗号化されない。

**なぜ危険か**:
- VPC内でのネットワーク盗聴（SSRF攻撃による内部トラフィックキャプチャ、EC2/ECSコンテナのサイドチャネル攻撃）により医療情報が平文で露出する。
- Redisには認証トークン（リフレッシュトークン）が保存されており、平文通信ではトークン窃取が可能。

**推奨対策**:
- サービス間通信にはTLSを適用する（ECS間のサービスメッシュ、またはTLS終端の明示的設計）。
- RDS・Redis接続にはTLS/SSL接続を必須化する（RDS SSL証明書検証、Redis TLS設定）。

---

### C3. アクセストークンのlocalStorage保存

**該当箇所**: セクション 5.1「認証フロー」ステップ4

**問題の詳細**:

> 「クライアントはアクセストークンを `localStorage` に保存し、以降のAPIリクエストに `Authorization: Bearer` ヘッダーで付与する」

**なぜ危険か**:
- `localStorage` はJavaScriptから読み取り可能であり、XSS攻撃によってトークンが窃取されるリスクがある。
- 医療情報を扱うシステムでXSSによるトークン窃取は患者の全医療情報へのアクセスにつながる。
- アクセストークン有効期限が24時間と長く、窃取された場合の被害期間が大きい。

**推奨対策**:
- アクセストークンはHttpOnly属性付きCookieに保存する（JavaScriptからアクセス不可）。
- アクセストークンの有効期限を15分〜1時間に短縮し、リフレッシュトークンで継続的な認証を行う設計に変更する。
- CSRFトークンの設計と組み合わせて保護する（C4参照）。

---

## Significant Issues

### S1. ロールによる患者データへの過剰アクセス（IDOR/アクセス制御設計不備）

**該当箇所**: セクション 5.2「認可モデル」

**問題の詳細**:

> 「doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする。」

**なぜ危険か**:
- 医師が担当外の患者（他のクリニックの患者を含む）の医療情報にアクセスできる。
- マルチテナント設計においてこの設計は、テナント間のデータ分離原則と矛盾する可能性がある。
- 不正アクセスの検出が困難（誰でもアクセスできるため、異常なアクセスパターンを定義できない）。

**推奨対策**:
- `GET /api/v1/patients/{id}` に対して、doctorロールは「担当患者のみ」または「自テナント内の患者のみ」に制限する認可チェックを明示的に設計する。
- `GET /api/v1/patients/{id}/prescriptions` 等も同様に所有権/関係性の検証を要求する。

---

### S2. CSRF保護の欠如

**該当箇所**: セクション 7.4「セッション系 API の保護」

**問題の詳細**:

> 「医師による処方箋発行（`POST /api/v1/prescriptions`）や患者情報更新（`PUT /api/v1/patients/{id}`）などのstate-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外とする。」

処方箋発行・患者情報更新・診療記録作成（`POST /api/v1/patients/{id}/records`）といった医療システムの核心的操作にCSRF保護がない。

**なぜ危険か**:
- 悪意あるWebページに医師がアクセスするだけで、医師の認証情報を使った偽の処方箋発行・患者情報の不正更新が可能になる。
- アクセストークンをlocalStorageに保存する場合でも、CSRF攻撃の対策は必要（SameSite Cookieを使わない場合）。

**推奨対策**:
- state-changingなAPI（POST/PUT/DELETE）にCSRFトークンを実装するか、Cookieベースの場合はSameSite=Strictを設定する。
- 現フェーズのスコープ外とせず、認証・認可設計と同時に設計する。

---

### S3. ログイン・認証エンドポイントへのレート制限欠如

**該当箇所**: セクション 8.5「認証エンドポイント保護」

**問題の詳細**:

> 「`/api/v1/auth/login` エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計とする。」

**なぜ危険か**:
- 無制限のログイン試行が可能であり、パスワードブルートフォース攻撃・クレデンシャルスタッフィング攻撃に対して無防備。
- bcryptコスト係数12は適切だが、レート制限なしでは並列攻撃を緩和できない。
- リフレッシュエンドポイント（`POST /api/v1/auth/refresh`）についても制限の記述がない。

**推奨対策**:
- ログインエンドポイントにIPベースおよびアカウントベースのレート制限を実装する（例: 5回失敗後に一時ロックまたはCAPTCHA）。
- 高可用性とセキュリティを両立するため、API Gatewayレベルでのスロットリング設計を追加する。

---

### S4. CORS設定のワイルドカード許可

**該当箇所**: セクション 7.3「CORS設定」

**問題の詳細**:

> 「API Gateway の CORS 設定は、開発効率を優先するため `Access-Control-Allow-Origin: *` を設定する。本番環境では必要に応じて絞り込みを検討する。」

**なぜ危険か**:
- `*` はCredentialed Request（Cookie/Authorizationヘッダー付き）とは組み合わせられないが、設計の曖昧さにより実装ミスが発生しやすい。
- 「本番環境では必要に応じて」という表現は、本番リリース時に設定が残るリスクを示している。
- 特に医療情報APIに対してワイルドカードCORSが残存した場合、クロスオリジンからのデータ取得が可能になる。

**推奨対策**:
- 設計書に許可するオリジンを明示する（例: `https://app.mediconnect.example.com`）。
- 本番環境では必ずオリジンを限定することを設計として確定させ、「検討する」という表現を使わない。

---

## Moderate Issues

### M1. PII含むログの管理不備

**該当箇所**: セクション 6.3「個人情報の取り扱い」

**問題の詳細**:

> 「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする。」

**なぜ問題か**:
- 各エンジニアの判断に委ねることで、医療情報・個人情報がCloudWatch Logsに平文で記録されるリスクが高い。
- ログは多くの担当者がアクセスでき、適切な機密管理がなければ情報漏洩の温床になる。

**推奨対策**:
- PIIおよび医療情報のログ出力を禁止するポリシーを設計書に明記する。
- ログに出力可能なフィールドを列挙し、患者ID（UUID）のみ記録するなど具体的なガイドラインを設ける。
- CloudWatch Logsへのアクセス制御ポリシーを設計する。

---

### M2. ファイルアップロードの種別・サイズ制限未定義

**該当箇所**: セクション 7.2「ファイルアップロード」

**問題の詳細**:

> 「ファイル種別・サイズの制限は実装フェーズで決定する。」

ウイルススキャンは設計されているが、ファイル種別・サイズ制限が設計フェーズで未定義。

**推奨対策**:
- 設計書に許可するMIMEタイプ（例: `image/jpeg`, `image/png`, `application/pdf`）と最大サイズを明記する。
- S3保存前のサーバーサイドバリデーションを必須化する（フロントエンド検証のみに依存しない）。

---

### M3. 削除方針・データライフサイクルの未定義

**該当箇所**: セクション 4.2「データ分類」

**問題の詳細**:

> 「削除方針は今後のフェーズで定義する予定である。」

5年保持の法令要件は記載されているが、保持期間終了後の安全な削除プロセスが未定義。

**推奨対策**:
- 設計フェーズで削除ポリシー（論理削除/物理削除の方針、暗号化データのキー廃棄）の骨格を定義する。
- 特にアプリケーション層暗号化を導入した場合、暗号鍵の廃棄によるデータの実質的な削除（Crypto Shredding）を検討する。

---

### M4. リフレッシュトークンの管理設計の脆弱性

**該当箇所**: セクション 5.3「セッション管理」

**問題の詳細**:

> 「リフレッシュトークンは Redis に保存し、ユーザーIDをキーとしてトークン値を管理する。」

ユーザーIDをキーとすると、ユーザーごとに1つのリフレッシュトークンしか管理できない設計になる。

**なぜ問題か**:
- 複数デバイスからのログインが想定される場合（患者がモバイルとWebを使う）、新しいログインで既存デバイスのセッションが無効化される（または上書きされる）。
- トークンのローテーション（Refresh Token Rotation）が設計されていない場合、漏洩したリフレッシュトークンの無効化が困難。

**推奨対策**:
- リフレッシュトークンのキーを `userId:tokenId` の複合キーまたはトークンハッシュをキーとして設計する。
- リフレッシュトークンローテーション（使用ごとに新トークン発行、旧トークン無効化）を設計に明記する。

---

## Minor Issues / Positive Aspects

### Positive Aspects

- bcryptコスト係数12の使用は適切な選択である。
- AWS Secrets ManagerによるシークレットのマネージドなライフサイクルはDevSecOpsのベストプラクティスに沿っている。
- RDS・Redis のVPCプライベートサブネット配置は適切なネットワーク分離設計である。
- マルチテナントのスキーマ分離方式（マルチスキーマ）は、行レベル分離よりも強いテナント間分離を提供する。
- S3へのサーバーサイド暗号化（SSE-S3）とバージョニングの有効化は適切な設計である。

### Minor Improvements

- **依存関係脆弱性管理**: バージョン固定のみで定期チェック方針が未定義。Dependabot等の自動脆弱性スキャンを設計に組み込むことを推奨する（セクション 8.2）。
- **監査ログの完全性**: セクション 8.3では操作ユーザーID・操作種別・タイムスタンプが記録されるが、対象リソースID（どの患者のデータにアクセスしたか）の記録が明示されていない。医療情報システムでは患者IDをログに含めることが重要である。
- **Twilio Video SDK バージョン**: v2.27.0の利用が記載されているが、ビデオ通話セッションに含まれる医療情報の保護方針（録画の可否、Twilioへのデータ提供範囲）が設計書に記載されていない。

---

## Summary

| 重大度 | 件数 | 主要課題 |
|---|---|---|
| Critical | 3 | 医療情報のアプリケーション層暗号化欠如、VPC内通信平文化、トークンlocalStorage保存 |
| Significant | 4 | 医師の全患者アクセス、CSRF保護欠如、レート制限なし、CORSワイルドカード |
| Moderate | 4 | PIIログ管理、ファイル制限未定義、削除方針未定義、トークン管理設計 |
| Minor | 3 | 依存関係管理、監査ログ完全性、ビデオ通話データ方針 |

医療システムとして最も優先すべき対応は **C1（暗号化レイヤー不備）** であり、RDS暗号化のみでは不十分な医療機密情報・保険証番号に対してアプリケーション層フィールドレベル暗号化の設計を追加することが必須である。
