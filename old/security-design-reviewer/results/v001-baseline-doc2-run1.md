# Security Design Review: Nexamart プラットフォーム システム設計書 v1.4.0

**レビュー対象**: test-document-2.md (Nexamart マルチテナント型マーケットプレイス)
**プロンプトバージョン**: v001-baseline
**実行日**: 2026-02-18

---

## Critical Issues (重大な問題)

### C-1: 本番シークレットのリポジトリ保存

**セクション**: 8.1 シークレット管理

**問題**:
`config/secrets.prod.yaml` に本番環境のシークレット値（DBパスワード、APIキー、JWT署名鍵）を記録し、リポジトリに含めている。アクセス制限を設けているとしても、Git履歴はあらゆる過去コミットを保持するため、シークレットのローテーション後も漏洩リスクが継続する。

**影響**:
- リポジトリへのアクセス権を持つ全員（開発者、CI/CDシステム、外部コントリビューター）がシークレットを取得可能
- Git履歴上に残るため、シークレットローテーション後も過去の値を参照可能
- CI/CDパイプラインやGitHubのシークレットスキャンをバイパスした内部脅威リスク
- マルチテナント環境のため、DB接続情報の漏洩は全テナントの全データに対するアクセスに直結する

**対策**:
- `config/secrets.prod.yaml` をリポジトリから即時削除し、Git履歴からも `git filter-branch` または `BFG Repo-Cleaner` で除去する
- AWS Secrets Manager を唯一の真実の源とし、シークレット値はリポジトリに記録しない
- デプロイ担当者向けのシークレット参照手順書はWikiやSecrets Managerのコンソールへの案内のみとする

---

### C-2: アクセストークンのlocalStorage保存によるXSS脆弱性

**セクション**: 4.1 認証フロー

**問題**:
JWTアクセストークン（有効期限60分）を `localStorage` に保存している。`localStorage` はJavaScriptから自由に読み取り可能であり、XSS攻撃が成功した場合、攻撃者はアクセストークンを窃取してAPIを直接叩くことができる。

**影響**:
- CSPが設定されているが（`default-src 'self'`）、DOM-based XSSやサードパーティスクリプト経由での攻撃は完全には防げない
- DOMPurifyの誤設定やバイパスが発生した場合、テナントの商品・注文データへの不正アクセスが可能
- マルチテナント環境では、一人のユーザーのトークン窃取がそのテナントのデータ侵害に直結する
- アクセストークンの即時無効化機能がない（C-3参照）ため、窃取後60分間は検知・無効化できない

**対策**:
- アクセストークンを `HttpOnly` Cookie に変更する（SameSite=Strict または Lax）
- Authorizationヘッダー方式を維持する場合は、インメモリ（Reactのstate/Redux等）に保持し、ページリロード時はリフレッシュトークンで再取得する設計に変更する
- CSRF対策との整合性を合わせて再設計する（Cookie化した場合はCSRFトークンが必要）

---

### C-3: アクセストークンの即時無効化不可

**セクション**: 4.2 セッション管理

**問題**:
「不正検知や権限変更が発生した場合のトークン即時無効化は、リフレッシュトークンの期限切れに依存する設計とする」と明記されている。これは意図的な設計判断として記述されているが、セキュリティ上の重大な欠陥である。

**影響**:
- テナント管理者のロール剥奪後も、最大60分間は管理者権限で操作を継続できる
- アカウント侵害を検知した場合に即座にアクセスを遮断できない
- `platform_admin` アカウントが侵害された場合、60分間は全テナントデータへのアクセスが継続される
- ブルートフォース攻撃でリフレッシュトークンを奪取された場合、30日間は検知後もアクセス可能

**対策**:
- アクセストークンのブラックリストをRedisに実装する（短いTTL: 60分）か、アクセストークンの有効期限を5〜15分に短縮する
- 権限変更・アカウント停止時のイベントをJWT `jti` (JWT ID) のブラックリスト追加と連動させる
- または、ステートフルなセッション管理（サーバーサイドセッション）に切り替える

---

### C-4: CORSの正規表現マッチにおける脆弱なオリジン検証

**セクション**: 6.4 CORS設定

**問題**:
`/\.nexamart\.com$/` という正規表現は末尾マッチのみであり、`evilnexamart.com` や `attacker-nexamart.com` のようなドメインを許可してしまう。さらに、`Access-Control-Allow-Credentials: true` と組み合わせているため、攻撃者が制御するオリジンからのCookieを含むリクエストを許可することになる。

**影響**:
- 攻撃者が `evil-nexamart.com` を登録し、被害者にアクセスさせることで、被害者のCookieを使ったリクエストを攻撃者のサイトから実行できる
- リフレッシュトークン（`HttpOnly` Cookie）を利用した操作が可能になる
- マルチテナント環境では、テナントデータの横断的な不正アクセスに繋がる

**対策**:
```javascript
// 修正版: ホワイトリスト方式に変更
const allowedOrigins = new Set([
  'https://nexamart.com',
  'https://admin.nexamart.com',
  // 動的テナントサブドメインは別途検証
]);

// テナントサブドメインの場合は厳密なパターン検証
const tenantSubdomainPattern = /^https:\/\/[a-z0-9-]+\.nexamart\.com$/;

if (allowedOrigins.has(origin) || tenantSubdomainPattern.test(origin)) {
  // ホワイトリストから取得した値をセット（変数をそのまま返さない）
}
```
- 正規表現に `^` アンカーを追加する最低限の対策も実施する: `/^https:\/\/[a-z0-9-]+\.nexamart\.com$/`

---

### C-5: Stripe Webhookエンドポイントの署名検証未記述

**セクション**: 7.3 外部サービス連携

**問題**:
`/api/webhooks/stripe` エンドポイントについて、Stripeの署名検証（`Stripe-Signature` ヘッダーの検証）に関する設計が記述されていない。

**影響**:
- 攻撃者が偽の支払い完了イベントをWebhookエンドポイントに送信することで、支払いなしに注文を「支払い完了」状態に変更できる
- `platform_admin` 認証のないパブリックエンドポイントとして公開されるため、インターネット上の誰でも攻撃可能
- 電子商取引詐欺の直接的なベクターとなる

**対策**:
- Stripeが提供するSDKの `stripe.webhooks.constructEvent()` を使い、`Stripe-Signature` ヘッダーのHMAC署名を検証する設計を明示する
- Webhookシークレットは AWS Secrets Manager で管理する
- 署名検証失敗時は400エラーを返し、監査ログに記録する

---

## Significant Issues (重要な問題)

### S-1: テナント分離の脆弱性 — X-Tenant-IDヘッダーの信頼

**セクション**: 3.2 マルチテナント分離方式

**問題**:
Kong ゲートウェイが付与する `X-Tenant-ID` ヘッダーをコアAPIサービスが信頼済みとして扱うとあるが、ゲートウェイをバイパスして内部エンドポイントに直接アクセスできる場合（例: ECSコンテナへの直接アクセス、内部ネットワーク侵害）、任意の `X-Tenant-ID` を指定して他テナントのデータにアクセスできる。

**影響**:
- 内部ネットワーク侵害時に全テナントデータが横断的に参照・変更可能
- JWTの `tenantId` クレームと `X-Tenant-ID` の照合（4.3節）が実施される設計ではあるが、認証なしリクエストがどう扱われるかが不明確

**対策**:
- コアAPIサービスはゲートウェイからのリクエストのみを受け付けるよう、ネットワーク層（Security Group）での制限を明示的に設計する
- ゲートウェイ由来のリクエストであることを検証するための内部認証（mTLSまたは共有シークレット）を設計する
- Security Groupの設定で、ECSコンテナへの直接アクセスをKongからのみに制限することを明記する

---

### S-2: ログインエンドポイントのレートリミット未記述

**セクション**: 4.4 認証エンドポイント / 9.4 セキュリティ要件

**問題**:
`/api/auth/login`、`/api/auth/register`、`/api/auth/refresh` エンドポイントに対するレートリミット設計が記述されていない。Kongゲートウェイにレートリミット機能はあるが、認証エンドポイントへの適用が明示されていない。

**影響**:
- ブルートフォース攻撃によるパスワード総当たりが可能
- クレデンシャルスタッフィング攻撃（他サービスから流出したパスワードリストの使用）が防御されない
- テナント管理者アカウントへのブルートフォースは全テナントデータへのアクセスに直結する

**対策**:
- Kong ゲートウェイのレートリミットプラグインで認証エンドポイントに対して IPベースの制限を設計する（例: ログインは10回/分/IP）
- アカウントロックアウトポリシー（例: 5回失敗後に15分ロック）またはCAPCHAの設計を追加する
- 認証失敗時のレスポンスは一定時間（例: 1秒）遅延させる設計（タイミング攻撃対策）

---

### S-3: 注文APIの認可チェック不備 — 注文の所有者確認

**セクション**: 7.2 注文API

**問題**:
`GET /api/orders/:id` は `buyer` と `tenant_admin` が参照可能とされているが、`buyer` が他の `buyer` の注文IDを指定して参照できないかの設計（所有者確認）が明記されていない。

**影響**:
- IDOR（Insecure Direct Object Reference）脆弱性の可能性
- 他のユーザーの注文情報（氏名、住所、購入商品、金額）を参照できる可能性
- マルチテナント環境では、異なるテナントの `buyer` 同士でも同一エンドポイントを使用するため影響範囲が広い

**対策**:
- `buyer` ロールの場合、注文取得時に `order.userId === jwtPayload.userId` を検証する設計を明示する
- `tenant_admin` の場合は `order.tenantId === jwtPayload.tenantId` の検証を明示する
- API設計表に「所有者確認」列を追加する

---

### S-4: multer 1.4.4 の既知脆弱性

**セクション**: 8.2 依存ライブラリ管理

**問題**:
`multer@1.4.4` が使用されているが、このバージョンには既知のDoS脆弱性（CVE-2022-24434等）が存在する。また、ファイルアップロードは Presigned URL 経由のクライアント直接アップロード（6.5節）とされているにもかかわらず、multerが使用される箇所が不明確である。

**影響**:
- 古いバージョンのmulterが使用される経路でDoS攻撃が可能
- multerの使用箇所が特定されていないため、セキュリティレビューの盲点となる

**対策**:
- multerを最新版（1.4.5-lts.1以上）にアップデートする
- multerの使用箇所を設計書に明記し、Presigned URL方式との関係を整理する
- セキュリティアップデートを四半期ごとではなく、CVE公開後30日以内に適用するポリシーに変更する

---

## Moderate Issues (中程度の問題)

### M-1: PIIデータ保持期間・削除方針の未定義

**セクション**: 5.3 個人情報（PII）管理

**問題**:
「データ保持期間・削除方針: 現時点では未定義」と明記されている。日本のプライバシー法（個人情報保護法）やGDPR（EU向けサービスの場合）では、適切な保持期間と削除手続きの設計が求められる。

**影響**:
- 退会済みユーザーの個人情報が無期限に保存されるリスク
- データ漏洩時の影響範囲が無制限に拡大する
- 法的コンプライアンス違反のリスク

**対策**:
- 退会申請フローの設計（論理削除→一定期間後の物理削除）を早期に追加する
- 注文データ等で法的要件（例: 消費税法に基づく7年保存）がある場合は、PII部分を匿名化する方針を設計する

---

### M-2: 署名付きURLの有効期限7日間

**セクション**: 5.4 S3ストレージセキュリティ

**問題**:
請求書・契約書類の署名付きURLの有効期限が7日間に設定されている。この期間は長すぎる可能性があり、URLが漏洩した場合（メール転送、ログ出力等）に長期間アクセス可能になる。

**影響**:
- URLをメールやチャットで共有した場合、意図しない第三者がアクセス可能
- ロードバランサーやCDNのアクセスログにURLが記録された場合、ログアクセス権を持つ者が文書を取得できる

**対策**:
- 有効期限を用途に応じて短縮する（ダウンロード操作用: 1時間以内、表示用: 15分以内）
- URLをユーザーに返す前に、ダウンロードアクセスを監査ログに記録する

---

### M-3: CSPの不足設定

**セクション**: 6.2 XSS対策

**問題**:
CSPが `default-src 'self'` のみ記述されており、`script-src`、`connect-src`（Stripe等の外部JS）、`frame-ancestors`（クリックジャッキング対策）等の詳細なディレクティブが設計されていない。また、`report-uri` / `report-to` による違反レポート収集も未設計。

**対策**:
- 使用する外部リソース（Stripe.js、SendGrid等）を考慮した詳細なCSP設計を追加する
- `frame-ancestors 'none'` または `'self'` を追加してクリックジャッキングを防止する
- `X-Frame-Options: DENY` もフォールバックとして設定する

---

### M-4: 商品更新APIのテナント所有権確認未記述

**セクション**: 7.1 商品API

**問題**:
`PUT /api/products/:id` と `DELETE /api/products/:id` において、`tenant_admin` / `tenant_staff` ロールのユーザーが他テナントの商品IDを指定して操作できないかの所有権確認が明記されていない。

**対策**:
- 商品更新・削除時に `product.tenantId === jwtPayload.tenantId` を検証する設計を明示する

---

### M-5: 監査ログと通常ログの混在

**セクション**: 8.4 監査ログ

**問題**:
監査ログを「アプリケーションの通常ログと同一のCloudWatch Logsストリームに出力する」とされている。これにより、監査ログの改ざん・削除が通常のログ運用と区別されず、コンプライアンス上の問題が発生する可能性がある。

**影響**:
- 通常のログローテーション処理で監査ログが削除される可能性
- ログアクセス権を持つエンジニアが監査ログを改ざんできる

**対策**:
- 監査ログは専用のCloudWatch Logsグループに出力し、CloudTrail + S3へのアーカイブとS3 Object Lockで改ざん防止を設計する
- 監査ログのアクセス権は通常ログより厳しく制限する

---

## Minor Issues and Positive Aspects

### 評価できる点

- **bcrypt cost factor 12**: 適切なハッシュ強度であり、推奨される設定
- **Prisma ORM のパラメータ化クエリ**: SQLインジェクション対策として適切
- **クレジットカード情報のStripe委譲**: PCI DSS対応として正しいアプローチ
- **AWS Secrets Manager + KMS**: シークレット管理の基本設計は適切（C-1の問題を除く）
- **CloudFront → ECS間のHTTPS**: 内部通信の暗号化が設計されている
- **DOMPurifyによるリッチテキストサニタイズ**: 適切なXSS対策
- **リフレッシュトークンのブラックリスト**: ログアウト時の即時無効化は設計されている

### 軽微な改善点

- **KMSローテーション周期**: 年1回は最低限の基準であり、高感度データには半年ごとが推奨
- **セキュリティアップデート四半期ごと**: CVE公開から適用まで最大3ヶ月のウィンドウが開くため、重大CVEには緊急対応フローを追加することを推奨
- **ウイルススキャン「将来対応」**: ロードマップへの追加時期を明確化することを推奨

---

## STRIDE評価サマリー

| 脅威カテゴリ | 評価 | 主な問題 |
|------------|------|---------|
| Spoofing (なりすまし) | 要改善 | ログインレートリミット未設計 (S-2)、アクセストークンXSS窃取リスク (C-2) |
| Tampering (改ざん) | 重大欠陥 | Stripe Webhook署名検証未記述 (C-5) |
| Repudiation (否認) | 要改善 | 監査ログ混在 (M-5)、認証失敗ログの詳細未設計 |
| Information Disclosure (情報漏洩) | 重大欠陥 | シークレットのリポジトリ保存 (C-1)、IDOR脆弱性 (S-3, M-4) |
| Denial of Service (DoS) | 要改善 | レートリミット未設計 (S-2)、multer脆弱性 (S-4) |
| Elevation of Privilege (権限昇格) | 要改善 | アクセストークン即時無効化不可 (C-3)、テナント分離ヘッダー信頼 (S-1) |

---

## 優先対応推奨順序

1. **即時対応**: C-1 (シークレットリポジトリ保存の除去)
2. **リリース前必須**: C-2, C-3, C-4, C-5 (認証・CORS・Webhook)
3. **リリース前推奨**: S-1, S-2, S-3, S-4 (テナント分離・レートリミット・IDOR・脆弱ライブラリ)
4. **近期対応**: M-1〜M-5 (PII管理・監査ログ・CSP等)
