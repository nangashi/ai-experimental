# Security Design Review: MediConnect システム設計書

**Prompt version:** v002-variant-data-protection-tde-limits
**Target document:** test-document-1.md
**Run:** 2

---

## CRITICAL Issues

### C-01: RDS TDE のみによる医療機密情報保護は不十分（フィールドレベル暗号化の欠如）

**該当箇所:** セクション 6.2「保存データの暗号化」

**問題の詳細:**
設計書に以下の記述がある。

> 「診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している。」

RDS暗号化（AES-256 TDE）はディスクレベルの透過的暗号化であり、物理メディア盗難には有効だが、以下のシナリオに対しては無効である。

- **DBユーザーによる論理的アクセス:** アプリケーションが接続するDBユーザーは暗号化されていない平文データを読める。DB認証情報が漏洩した場合、攻撃者は全患者の診断結果・処方内容・保険証番号に平文でアクセスできる。
- **内部不正（インサイダー脅威）:** DBAやインフラ担当者はRDS上のデータに平文でアクセス可能。
- **アプリケーション層の侵害:** バックエンドサービスが侵害された場合、DBへの接続権限を持つアタッカーは全医療データを平文で取得できる。

**影響分析:**
MediConnect は医療情報（診断内容、SOAPノート）、保険証番号、氏名・生年月日・連絡先などの高感度PII、処方内容を扱う。これらは日本の医療情報ガイドライン（厚生労働省）の対象であり、また医療情報の性質上インサイダー脅威・DB侵害シナリオでの保護が必須となる。TDEのみの設計はこれらのシナリオで完全に無防備であり、**大規模な医療情報漏洩リスク**が存在する。

**具体的な対策:**
1. 以下の高感度フィールドにフィールドレベル暗号化（アプリケーション層での暗号化・復号）を適用すること:
   - `patients.insurance_number`（保険証番号）
   - `patients.full_name`, `date_of_birth`, `phone_number`, `email`（PII）
   - `medical_records.diagnosis`, `medical_records.soap_note`（医療機密情報）
   - `prescriptions.medications`（処方内容）
2. 暗号鍵は AWS KMS で管理し、アプリケーションはKMS経由でデータキーを取得する（Envelope Encryption）。
3. DBユーザーの権限を最小化し、暗号化フィールドへのアクセスはアプリケーション層でのみ復号可能な設計とする。

---

### C-02: VPC内部通信の平文化

**該当箇所:** セクション 6.1「通信の暗号化」

**問題の詳細:**
> 「VPC 内部の通信については内部ネットワークであるため平文で行う。」

アプリケーション層（ECS Fargate）からPostgreSQLおよびRedisへの通信が平文である。

**影響分析:**
VPCは境界防御であり内部が安全という前提は不適切。以下のリスクがある。
- VPC内の横展開（Lateral Movement）によるトラフィック盗聴
- ECSタスクや他AWSリソースが侵害された場合の通信内容傍受
- Redisには認証トークン（リフレッシュトークン）が保存されており、平文通信によるトークン漏洩が発生しうる

**対策:**
- バックエンド〜RDS間はSSL/TLS接続を必須化（PostgreSQL SSL接続設定）
- バックエンド〜Redis間はTLS暗号化を有効化（Redis 7はTLS対応）

---

### C-03: localStorage へのトークン保存（XSS攻撃による漏洩リスク）

**該当箇所:** セクション 5.1「認証フロー」

**問題の詳細:**
> 「クライアントはアクセストークンを `localStorage` に保存し…」

localStorageはJavaScriptから自由に読み取れるため、XSS脆弱性が存在する場合にトークンが完全に窃取される。

**影響分析:**
医療情報を扱うシステムで認証トークンが漏洩した場合、攻撃者は正規ユーザーとして全診療記録・処方内容にアクセスできる。アクセストークンの有効期限が24時間と長い点も被害拡大のリスクを高める。

**対策:**
- アクセストークンはHttpOnly Cookie（SameSite=Strict または Lax）に保存する
- アクセストークンの有効期限を短縮（15〜60分）
- リフレッシュトークンも同様にHttpOnly Cookieで管理する

---

### C-04: CORS ワイルドカード設定

**該当箇所:** セクション 7.3「CORS設定」

**問題の詳細:**
> 「`Access-Control-Allow-Origin: *` を設定する。本番環境では必要に応じて絞り込みを検討する。」

本番へのデプロイ予定がある設計書として、ワイルドカードCORSは深刻な問題である。Credentialed Request（Cookie付き）との組み合わせで、任意のオリジンからのリクエストが通過するリスクがある。医療情報APIへの不正オリジンからのアクセスを許容することは設計上許容できない。

**対策:**
- 許可オリジンを明示的に列挙（本番ドメインのみ）
- `Access-Control-Allow-Credentials: true` を使用する場合はワイルドカード不可

---

## SIGNIFICANT Issues

### S-01: CSRF保護の未定義

**該当箇所:** セクション 7.4「セッション系 API の保護」

**問題の詳細:**
> 「state-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外とする。」

処方箋発行（`POST /api/v1/prescriptions`）、患者情報更新（`PUT /api/v1/patients/{id}`）などの重要操作のCSRF保護が設計されていない。

**影響分析:**
Cookieベース認証に移行した場合（C-03対策後）、CSRF保護が必須となる。現設計でもXSS→CSRF連鎖攻撃のリスクが存在する。医師の操作として悪意ある処方箋発行が行われる可能性がある。

**対策:**
- CSRF トークン（Synchronizer Token Pattern）またはSameSite Cookie属性の設計を明示する
- state-changing APIへのDouble Submit Cookie等のCSRF保護を設計フェーズで決定する

---

### S-02: doctorロールの患者データ無制限アクセス（認可設計の欠陥）

**該当箇所:** セクション 5.2「認可モデル」

**問題の詳細:**
> 「doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする。」

医師が担当外患者の診療記録・個人情報・処方箋に無制限でアクセスできる。

**影響分析:**
医療情報の不正参照（担当外患者カルテの閲覧）はプライバシー侵害であり、日本の医療情報ガイドライン違反にもなりうる。マルチテナント構成において別テナントの患者データへのアクセスが発生した場合、その影響は極めて深刻。

**対策:**
- doctorロールは担当患者のみアクセス可能とする（担当関係テーブルによる所有権検証）
- 患者データアクセス時に `doctor_id` と `patient_id` の担当関係を検証するミドルウェアを設計する

---

### S-03: ログイン・リフレッシュエンドポイントへのレート制限なし

**該当箇所:** セクション 8.5「認証エンドポイント保護」

**問題の詳細:**
> 「`/api/v1/auth/login` エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計とする。」

ブルートフォース攻撃に対して無防備。リフレッシュエンドポイント（`POST /api/v1/auth/refresh`）も同様に保護設計が記述されていない。

**影響分析:**
認証情報を総当たり攻撃で突破される可能性。医療機関システムは標的型攻撃リスクが高く、特定医師・患者アカウントへの不正アクセス試行が行われうる。

**対策:**
- IP単位・アカウント単位のレート制限を設計する（例: 5回失敗で15分ロック）
- アカウントロック or progressiveなレート制限の設計
- AWS WAF や API Gatewayのスロットリング機能の活用

---

### S-04: 個人情報ログ出力のエンジニア任せ

**該当箇所:** セクション 6.3「個人情報の取り扱い」

**問題の詳細:**
> 「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする。」

医療情報・PIIのログマスキングが個人の判断に依存しており、設計・ポリシーレベルで制御されていない。

**影響分析:**
診断内容・保険証番号・氏名がCloudWatch Logsに平文出力されるリスク。CloudWatchログへのアクセス権を持つ関係者（開発者・運用者）全員が医療機密情報を閲覧できる状態になりうる。

**対策:**
- ログ出力ポリシーとしてPIIマスキング必須ルールを設計書に明記する
- 構造化ログにおいてPIIフィールドをシステムレベルでマスクする仕組みを設計する（フィールドリスト管理）

---

## MODERATE Issues

### M-01: バックエンドのみでの入力検証欠如

**該当箇所:** セクション 7.1「入力検証方針」

**問題の詳細:**
> 「フロントエンドで入力検証が完了した状態でAPIに送信される設計とする。バックエンドでは基本的な型チェック（JSONスキーマバリデーション）のみ実施する。」

フロントエンド検証はバイパス可能（Burp Suite等のプロキシツール使用）。SQLインジェクション、NoSQLインジェクション、コマンドインジェクション等の対策がバックエンドで不十分。

**対策:**
- バックエンドで全入力の業務ロジックバリデーションを必須化
- ORM（Prisma等）を使用したパラメータ化クエリの明示
- 入力サニタイズ方針の設計明示

---

### M-02: ファイルアップロードの種別・サイズ制限未定義

**該当箇所:** セクション 7.2「ファイルアップロード」

**問題の詳細:**
> 「ファイル種別・サイズの制限は実装フェーズで決定する。」

ウイルススキャンは実施するものの、ファイル種別・サイズ制限が未設計。

**影響分析:**
悪意あるファイル形式（実行ファイル偽装、SVG XSS等）のアップロードリスク。DoS（大容量ファイルアップロード）のリスク。

**対策:**
- 許可ファイル形式を許可リスト（whitelist）で設計書に明示（例: JPEG, PNG, PDF のみ）
- 最大ファイルサイズの上限を設計段階で決定する

---

### M-03: マルチテナントでのtenant_idクレーム検証の設計明示不足

**該当箇所:** セクション 3.2「マルチテナント設計」

**問題の詳細:**
> 「各リクエストのテナント識別は、JWTトークンに含まれる `tenant_id` クレームに基づく。」

JWTの `tenant_id` クレーム検証がどこで・どのように行われるか設計書に記述がない。クレームのバリデーションが不十分な場合、テナント間データ越境アクセスが発生する。

**対策:**
- tenant_idクレーム検証ミドルウェアの設計を明示する
- 全DBクエリに `tenant_id` フィルタを必須化する設計パターンを記述する

---

### M-04: 監査ログの対象操作の不明確さ

**該当箇所:** セクション 8.3「監査ログ」

**問題の詳細:**
セキュリティ上重要な操作（認証失敗、権限変更、患者データへのアクセス）の監査ログが明示されておらず、「アプリケーションログ」として一般ログと混在している。

**対策:**
- 医療情報アクセスログ（誰がいつどの患者データを参照したか）を専用監査ログとして設計する
- 認証失敗・権限昇格・設定変更のセキュリティイベントを明示的に監査ログ対象とする

---

## Minor Issues / Positive Aspects

### Positive

- bcryptコスト係数12でのパスワードハッシュ化（5.1）: 適切な設定
- AWS Secrets Managerによるシークレット管理（8.1）: 適切
- RDS・Redisのプライベートサブネット配置（8.4）: 適切なネットワーク分離
- RDS Multi-AZ構成（9.1）: 可用性設計は良好
- VPC内部のサービス間通信設計（3.2）: 内部エンドポイント使用は良い方向性

### Minor

- **依存ライブラリの脆弱性管理ポリシー未定義（8.2）:** バージョン固定のみでは継続的な脆弱性対応が不明。Dependabot等の自動監視の設計を推奨。
- **データ削除ポリシーの未定義（4.2）:** 「今後のフェーズで定義」とあるが、医療情報の安全な削除（NIST SP 800-88準拠等）の方針を設計段階で決定すべき。
- **バックアップの暗号化明示不足（9.3）:** RDS自動バックアップの暗号化については、RDS暗号化が有効であれば継承されるが、設計書での明示を推奨。

---

## Summary

| 重要度 | 件数 | 主要項目 |
|--------|------|----------|
| Critical | 4 | TDE限界/フィールド暗号化欠如、VPC内平文通信、localStorage、CORSワイルドカード |
| Significant | 4 | CSRF未設計、doctor権限過剰、レート制限なし、PIIログ制御なし |
| Moderate | 4 | バックエンド検証不足、ファイル制限未定義、テナント検証設計不足、監査ログ不明確 |
| Minor | 3 | 依存管理、削除ポリシー、バックアップ暗号化明示 |

最も優先度の高い問題はC-01（RDS TDEのみへの依存）である。MediConnectは医療機密情報・保険証番号等の高感度PIIを大量に保持するシステムであり、TDEは論理的アクセスシナリオ（DBユーザー侵害、インサイダー脅威）に対して完全に無効である。フィールドレベル暗号化とKMSによる鍵管理を設計に組み込むことが最優先事項である。
