# Security Design Review: MediConnect システム設計書

## Executive Summary

MediConnect は医療機関向けの電子カルテ・遠隔診療プラットフォームであり、患者の極めて機密性の高い医療情報を扱うシステムである。本レビューでは、設計書に記載された複数の重大なセキュリティ上の欠陥を特定した。医療情報の性質上、これらの問題は早急な対応が必要である。

---

## Critical Issues（重大な問題）

### C-01: CORS設定にワイルドカード（`*`）を使用 — 医療APIへの無制限クロスオリジンアクセス

**該当箇所**: セクション 7.3 CORS設定

**問題の詳細**:
設計書には「API Gateway の CORS 設定は、開発効率を優先するため `Access-Control-Allow-Origin: *` を設定する」と明記されている。ワイルドカード (`*`) を使用した CORS 設定は、任意のオリジンからのクロスオリジンリクエストを許可する。

医療情報を扱うシステムにおいて、`Access-Control-Allow-Origin: *` の設定は以下の危険を招く:
- 攻撃者が制御する任意のドメイン（例: `evil.example.com`、`attacker.io`）からのJavaScriptコードが、認証済みユーザーのセッションを利用して患者データ取得APIを呼び出せる状態になる
- JWTをAuthorizationヘッダーで付与する設計でも、ブラウザの same-origin policy 回避が可能となり、認証済みセッションからの情報漏洩リスクが生じる

なお、`Access-Control-Allow-Origin: *` はcredentials（`Authorization`ヘッダー、Cookie等）と同時には使用できない（ブラウザ仕様）が、ワイルドカードのままでは設計の意図が不明確であり、本番移行時の設定ミスリスクが高い。「本番環境では必要に応じて絞り込みを検討する」という記述は実施を保証しておらず、設計上の欠陥として扱うべきである。

**影響**:
- 悪意あるWebサイトへのアクセスを誘導されたユーザーのセッションが侵害される
- 患者の診療記録・処方箋・保険情報などの機密医療情報が第三者に漏洩する
- 医師になりすました処方箋発行など、改ざん操作が可能となる

**対策**:
- 許可するオリジンを明示的に列挙する（例: `https://app.mediconnect.example.com`）
- パターンベース（正規表現・サフィックスマッチ等）のオリジン検証を採用する場合は、攻撃者が制御可能なサブドメインによるバイパスを防ぐため、完全一致検証を実装する
  - 例: `.mediconnect.example.com` へのサフィックスマッチは `evil.mediconnect.example.com` などの攻撃者制御ドメインに悪用される
- 開発環境・本番環境で CORS 設定を明示的に分離し、本番設定を設計段階で確定する

---

### C-02: JWTアクセストークンを `localStorage` に保存 — XSSによるトークン窃取

**該当箇所**: セクション 5.1 認証フロー（手順4）

**問題の詳細**:
「クライアントはアクセストークンを `localStorage` に保存する」と設計されている。`localStorage` はJavaScriptから完全にアクセス可能であるため、XSS（クロスサイトスクリプティング）攻撃が発生した場合、攻撃者はJWTトークンを窃取し、セッションハイジャックを実行できる。

医療情報システムにおける24時間有効なJWTが窃取された場合、攻撃者は長時間にわたって患者の医療記録・処方箋・保険情報への不正アクセスを継続できる。

**影響**:
- XSS経由でのJWT窃取によるセッションハイジャック
- 患者医療情報への長期間（最大24時間）の不正アクセス

**対策**:
- JWTをHttpOnly属性付きCookieに保存し、JavaScriptからのアクセスを不可能にする
- または、メモリ（変数）にのみトークンを保持し、ページリロード時はリフレッシュトークンで再取得する設計を採用する
- アクセストークンの有効期限を24時間から大幅に短縮する（15〜60分が一般的）

---

### C-03: CSRF保護の設計欠如 — 処方箋発行・患者情報更新の改ざんリスク

**該当箇所**: セクション 7.4 セッション系 API の保護

**問題の詳細**:
「医師による処方箋発行（`POST /api/v1/prescriptions`）や患者情報更新（`PUT /api/v1/patients/{id}`）などのstate-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外とする」と記載されている。

JWTをAuthorizationヘッダーで付与する設計では一般にCSRF耐性があると誤解されることがあるが、C-01のCORS設定問題（ワイルドカード）と組み合わさると、クロスオリジンからのリクエストが意図せず成功するリスクが生じる。また、将来的にCookieベースの認証に変更された場合、CSRF保護が未設計のままでは即座に脆弱になる。

**影響**:
- 攻撃者が誘導したページから医師の権限で不正な処方箋が発行される
- 患者情報が改ざんされる

**対策**:
- 設計段階でCSRF対策を明示的に設計する
- HttpOnly CookieでJWTを管理する場合は、同期トークン（Synchronizer Token Pattern）またはDouble Submit Cookieパターンを採用する
- SameSite=Strict または SameSite=Lax Cookie属性を設定する
- これら2つの対策は独立した防御層として設計し、それぞれを別個のセキュリティ制御として文書化する

---

### C-04: 医師ロールが全患者データを無制限に参照可能 — 水平権限昇格リスク

**該当箇所**: セクション 5.2 認可モデル

**問題の詳細**:
「doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする」と明記されている。

マルチテナント医療システムにおいて、医師が担当外の患者（同一テナント内の他患者、または他テナントの患者）の医療記録を参照できる設計は、プライバシー侵害・医療情報の不正アクセスを許容するものである。個人情報保護法および医療情報ガイドラインへの違反リスクがある。

**影響**:
- 担当外患者の診療記録・処方箋・保険情報への不正アクセス
- 個人情報保護法違反・医療情報漏洩インシデント
- テナント間の患者情報が漏洩する可能性（テナント分離の実効性に依存）

**対策**:
- 医師の患者アクセスを「担当患者のみ」に制限する認可チェックを設計する
- `GET /api/v1/patients/{id}` に対して、リクエスト医師と患者の関係性（担当医師であるか）を検証する処理を設計する
- 担当関係を管理するデータモデル（例: `doctor_patient_assignments` テーブル）を追加する

---

## Significant Issues（重要な問題）

### S-01: ログインエンドポイントにレート制限なし — ブルートフォース攻撃の許容

**該当箇所**: セクション 8.5 認証エンドポイント保護

**問題の詳細**:
「`/api/v1/auth/login` エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計とする」と記載されている。医療システムの認証情報に対するブルートフォース攻撃・クレデンシャルスタッフィング攻撃を無制限に許容する設計である。

**影響**:
- 患者・医師のアカウントへの不正アクセス
- 医療情報の大規模な漏洩

**対策**:
- IP単位・アカウント単位でのレート制限を設計する（例: 5回失敗でのロックアウト）
- API Gatewayレベルでのスロットリングを設定する
- CAPTCHA等の追加認証要素の検討

---

### S-02: リフレッシュトークンエンドポイントの保護設計なし

**該当箇所**: セクション 3.3 API設計方針、セクション 5.1 認証フロー

**問題の詳細**:
`POST /api/v1/auth/refresh` エンドポイントについて、レート制限・乱用防止の設計が記述されていない。リフレッシュトークン（有効期限: 30日）が窃取された場合、このエンドポイントを繰り返し呼び出すことで長期的な不正アクセスが可能になる。

**影響**:
- 窃取されたリフレッシュトークンによる長期的セッション維持
- リフレッシュトークンを用いた認証バイパス

**対策**:
- リフレッシュトークンのローテーション（使用時に新トークンを発行し旧トークンを無効化）を設計する
- リフレッシュエンドポイントにもレート制限を設ける
- リフレッシュトークンの検出・失効機能を設計する

---

### S-03: VPC内部通信が平文 — 内部ネットワーク侵害時のデータ漏洩

**該当箇所**: セクション 6.1 通信の暗号化

**問題の詳細**:
「VPC 内部の通信については内部ネットワークであるため平文で行う」と設計されている。VPCが信頼境界として機能するという前提は、内部脅威・ラテラルムーブメント攻撃・クラウド設定ミスによるリスクを考慮していない。医療情報を扱うシステムでは、内部通信においても暗号化が求められる。

特に、application layer（ECS Fargate）からRDS/RedisへのSegment（診断記録・処方内容・患者情報を含む）が平文で流れる設計は、ネットワーク盗聴リスクを内包する。

**影響**:
- 内部ネットワーク侵害時の医療情報・認証情報の傍受
- コンプライアンス要件（厚生労働省ガイドライン）への不適合リスク

**対策**:
- サービス間通信にもTLS（相互TLS/mTLS）を採用する設計を明示する
- RDS接続にSSL/TLSを強制する設定を明記する
- Redis接続にTLS（AWS ElastiCache のin-transit encryption）を有効化する

---

### S-04: ファイルアップロードのファイル種別・サイズ制限が未定義

**該当箇所**: セクション 7.2 ファイルアップロード

**問題の詳細**:
「ファイル種別・サイズの制限は実装フェーズで決定する」と記載されており、設計段階でのセキュリティ要件が未定義である。ウイルススキャンは実施されるが、ファイル種別の検証なしではMIMEタイプ偽装による悪意あるファイルのアップロードが可能になる。

**影響**:
- 悪意あるファイル（WebShell、スクリプトファイル）のアップロード
- ストレージ枯渇攻撃（大容量ファイルの繰り返しアップロード）

**対策**:
- 設計段階で許可するファイル形式（例: JPEG, PNG, PDF のみ）を明示する
- MIMEタイプ検証（Content-Typeヘッダーではなくマジックバイト検証）を設計する
- ファイルサイズ上限（例: 単一ファイル50MB以下）を設計段階で定義する
- アップロードされたファイルのS3保存パスが推測困難になるよう（UUIDベース等）設計する

---

## Moderate Issues（中程度の問題）

### M-01: 患者情報を含むログ出力がエンジニアの裁量に委ねられている — PII漏洩リスク

**該当箇所**: セクション 6.3 個人情報の取り扱い

**問題の詳細**:
「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする」と記載されている。医療情報・PIIのログ出力を個人の判断に委ねることは、氏名・診断内容・保険情報などの機密情報がCloudWatch Logsに平文で記録されるリスクを生む。

**影響**:
- 医療情報がログに平文出力され、ログアクセス権限を持つ者（開発者・運用者）が患者情報を閲覧可能になる
- 厚生労働省ガイドライン・個人情報保護法への違反リスク

**対策**:
- PIIおよび医療情報のログ出力を原則禁止とするポリシーを設計文書に明記する
- ログ出力前のマスキング処理（例: 患者IDのみ記録、氏名・診断内容は除外）を設計する
- ログアクセスに対するアクセス制御設計を追加する

---

### M-02: 削除ポリシー・データ保持期間の詳細が未定義

**該当箇所**: セクション 4.2 データ分類

**問題の詳細**:
「削除方針は今後のフェーズで定義する予定である」と記載されており、医療情報の適切な廃棄手順が設計段階で未定義である。法定保持期間終了後のデータ削除手順が不明確なままでは、不要なデータの蓄積と漏洩リスクが増大する。

**対策**:
- 法定保持期間（診療録: 5年以上）経過後の削除プロセスを設計段階で定義する
- S3の医療文書（処方箋PDF・検査画像）の保持・削除ポリシーを明示する
- 論理削除vs物理削除の方針と、物理削除の実行タイミングを設計する

---

### M-03: サードパーティ依存関係の脆弱性管理が未定義

**該当箇所**: セクション 8.2 サードパーティ依存関係

**問題の詳細**:
「脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定である」と記載されている。Twilio Video SDK v2.27.0、Node.js 18、React 18等のライブラリに既知の脆弱性が発見された場合の対応フローが未設計である。

**対策**:
- 脆弱性スキャン（npm audit、Snyk、AWS Inspector等）の自動実行をCI/CDに組み込む設計を追加する
- 重大な脆弱性（CVSSスコア7.0以上）への対応SLAを設計段階で定義する
- バージョン固定ポリシーとアップデート検討の定期サイクルを明示する

---

### M-04: 監査ログが操作対象リソースIDを含まない設計

**該当箇所**: セクション 8.3 監査ログ

**問題の詳細**:
監査ログに含める情報として「操作ユーザーID、操作種別、タイムスタンプ」が列挙されているが、操作対象リソース（患者ID、診療記録ID等）が含まれていない。医療情報システムにおいて誰がいつ何の情報にアクセスしたかを追跡するには、対象リソースIDが必須である。

**対策**:
- 監査ログに対象リソースID（patient_id, record_id等）を必須フィールドとして追加する
- 認証失敗・権限違反のログを明示的に設計する
- 監査ログの改ざん防止（CloudWatch Logs への書き込み後の変更不可設定等）を設計する

---

## Positive Aspects（適切に設計された点）

- bcryptによるパスワードハッシュ（コスト係数12）: 適切な設定
- RDS暗号化（AES-256）およびS3 SSE-S3による保存データの暗号化: 基本的な保護が設計されている
- AWS Secrets Managerによるシークレット管理: 適切なアプローチ
- マルチスキーマ方式によるテナント分離: テナント間データ分離の基本設計が存在する
- S3へのウイルススキャン実施: ファイルアップロードへの一定の対策
- RDSのMulti-AZ構成: 可用性の確保

---

## Summary of Critical Findings

| 優先度 | ID | 問題 | 該当箇所 |
|--------|-----|------|----------|
| Critical | C-01 | CORS ワイルドカード設定による無制限クロスオリジンアクセス | §7.3 |
| Critical | C-02 | JWTをlocalStorageに保存 — XSSによるトークン窃取 | §5.1 |
| Critical | C-03 | CSRF保護の設計欠如（処方箋発行・患者情報更新） | §7.4 |
| Critical | C-04 | 医師ロールが全患者データを無制限参照可能 | §5.2 |
| Significant | S-01 | ログインエンドポイントのレート制限なし | §8.5 |
| Significant | S-02 | リフレッシュトークンエンドポイントの保護設計なし | §3.3, §5.1 |
| Significant | S-03 | VPC内部通信が平文 | §6.1 |
| Significant | S-04 | ファイルアップロード制限が未定義 | §7.2 |
| Moderate | M-01 | PIIログ出力がエンジニア裁量 | §6.3 |
| Moderate | M-02 | データ削除ポリシー未定義 | §4.2 |
| Moderate | M-03 | サードパーティ脆弱性管理未定義 | §8.2 |
| Moderate | M-04 | 監査ログに対象リソースID欠如 | §8.3 |
