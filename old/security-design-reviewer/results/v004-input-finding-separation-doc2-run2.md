# Security Design Review: Nexamart プラットフォーム システム設計書

**Reviewer**: security-design-reviewer (v004-variant-input-finding-separation)
**Target**: test-document-2.md (Nexamart v1.4.0)
**Run**: doc2-run2

---

## Critical Issues

### [CRITICAL-01] アクセストークンの localStorage 保存による XSS 脆弱性

**該当箇所**: セクション 4.1 — トークン保存場所

**問題の詳細**:
アクセストークンを `localStorage` に保存する設計は、XSS攻撃が成立した場合にトークンが完全に盗取されるリスクを持つ。`localStorage` はJavaScriptから自由にアクセス可能であり、悪意あるスクリプトが実行された場合、`localStorage.getItem('accessToken')` のような単純な操作でトークンを外部サーバーへ送信できる。

**影響**:
攻撃者はXSS経由でアクセストークンを取得し、被害者になりすましてAPIを呼び出せる。60分の有効期限内で商品の不正購入、他テナントデータへのアクセス（認可バイパスと組み合わせた場合）、個人情報の閲覧が可能となる。マルチテナント環境であるため、テナント管理者のトークン盗取はテナント全体の管理権限を失う事態に直結する。

**推奨対策**:
- アクセストークンを `HttpOnly` Cookie に移行する。リフレッシュトークンと同様の保護を適用する
- 移行が困難な場合は、メモリ（JavaScriptの変数）にのみ保持し、ページリロード時はリフレッシュトークンで再発行する
- CSPの強化（`script-src` の厳格化）と組み合わせるが、これはlocalStorage保護の代替にはならない

---

### [CRITICAL-02] 本番シークレットのリポジトリ管理による機密情報漏洩リスク

**該当箇所**: セクション 8.1 — シークレット管理

**問題の詳細**:
`config/secrets.prod.yaml` に本番環境のシークレット値を記録し、アクセス制限を設けた上でリポジトリに含める設計は根本的に誤りである。Gitリポジトリはすべての変更履歴を保持するため、一度コミットされたシークレットは削除操作後もgit logやgit reflogで復元可能である。また「アクセス制限」の範囲が設計書で明示されていないことから、リポジトリへのアクセス権を持つ開発者全員（本番シークレットへのアクセス権を持たないメンバーを含む）が閲覧できる可能性がある。

**影響**:
DBパスワード、JWT署名鍵、外部APIキー（Stripe, SendGrid）が漏洩した場合、攻撃者はデータベースへの直接接続、任意のJWT偽造による認証バイパス、Stripe不正請求、SendGridを使ったフィッシングメール送信が可能となる。これはシステム全体の完全な侵害につながる。

**推奨対策**:
- `config/secrets.prod.yaml` をリポジトリから即座に除外し、gitの履歴からも削除する（`git filter-repo` 等を使用）
- 本番シークレットの参照は AWS Secrets Manager のコンソールまたはCLI経由に限定する
- 既に存在するシークレットはすべてローテーションする
- `.gitignore` にシークレットファイルパターンを追加し、CI/CDでgit-secretsやtrivyによる検出を導入する

---

### [CRITICAL-03] X-Tenant-ID ヘッダーの不適切な信頼によるテナント間データアクセス

**該当箇所**: セクション 3.2 — マルチテナント分離方式

**問題の詳細**:
Kongゲートウェイが付与する `X-Tenant-ID` ヘッダーを「検証済みの値として信頼する」設計において、コアAPIサービスがこのヘッダーを直接信頼してデータアクセスの絞り込みに使用することは危険である。Kongをバイパスしてコアサービスに直接アクセスできる経路が存在する場合（内部ネットワークからのアクセス、ゲートウェイ設定ミス等）、攻撃者は任意の `X-Tenant-ID` を設定して他テナントのデータを取得・操作できる。設計書はコアAPIサービスへの直接アクセスを防止する仕組みを明示していない。

**影響**:
全テナントのデータが同一スキーマで管理されているため、`X-Tenant-ID` の偽造が成功した場合、テナントの注文情報・顧客情報・商品情報すべてへの横断的アクセスが可能となる。マルチテナントプラットフォームとしての信頼が根本から失われる。

**推奨対策**:
- コアAPIサービスへの直接アクセスをSecurity GroupでKong以外から完全に遮断する
- さらに、コアAPIサービス側でもJWTの `tenantId` クレームを主たるテナント識別子とし、`X-Tenant-ID` ヘッダーはセカンダリ検証にとどめる
- テナントスコープリソースへのアクセスはJWTクレームとの一致確認を必須とする（4.3節の設計を明示的に実装仕様に落とす）

---

### [CRITICAL-04] Stripe Webhook エンドポイントの署名検証未定義

**該当箇所**: セクション 7.3 — 外部サービス連携

**問題の詳細**:
`/api/webhooks/stripe` エンドポイントについて、Stripeからの正規リクエストであることを検証するための署名検証（`Stripe-Signature` ヘッダーとWebhook Signing Secretを使った検証）が設計書に明示されていない。Webhookエンドポイントが誰でもアクセス可能な状態では、攻撃者が任意のペイロードを送信して支払いステータスを操作できる。

**影響**:
攻撃者が偽造したWebhookイベント（`payment_intent.succeeded` 等）を送信することで、実際には決済が完了していない注文のステータスを「支払い済み」に変更できる。これはプラットフォーム全体の決済整合性を破壊し、直接的な金銭的損失をもたらす。

**推奨対策**:
- Stripe公式ライブラリ（`stripe.webhooks.constructEvent`）を使用してすべてのWebhookリクエストの署名を検証する
- 署名検証失敗時は 400 を返し、処理を一切行わない
- Webhook Signing SecretはAWS Secrets Managerで管理する

---

## Significant Issues

### [SIGNIFICANT-01] 認証エンドポイントのレートリミット設計欠如（ログインエンドポイント）

**該当箇所**: セクション 4.4 — 認証エンドポイント（POST /api/auth/login）

**問題の詳細**:
ログインエンドポイント `/api/auth/login` に対するレートリミットが設計書に明示されていない。Kongゲートウェイでの認証トークン検証は記載されているが、ログイン前のエンドポイント保護については言及がない。

**影響**:
レートリミットが存在しない場合、ブルートフォース攻撃またはクレデンシャルスタッフィング攻撃により、弱いパスワードを持つアカウントが侵害される。bcryptのcost factor 12はサーバー側の計算コストを高めるが、攻撃者がAPIを並列で叩くことを防がない。

**推奨対策**:
- Kongゲートウェイまたはアプリケーション層でIPアドレスとアカウント単位の試行回数制限を実装する（例: IPあたり10回/分、アカウントあたり5回の失敗で一定時間ロック）
- アカウントロック時はエラーメッセージでアカウント存在の有無を推測させない（アカウント列挙対策）

---

### [SIGNIFICANT-02] 認証エンドポイントのレートリミット設計欠如（トークンリフレッシュエンドポイント）

**該当箇所**: セクション 4.4 — 認証エンドポイント（POST /api/auth/refresh）

**問題の詳細**:
トークンリフレッシュエンドポイント `/api/auth/refresh` に対するレートリミットおよび乱用防止機構が設計書に明示されていない。これはログインエンドポイントとは独立した問題である。

**影響**:
リフレッシュトークンが盗取された場合（Cookie盗取等）、攻撃者がリフレッシュエンドポイントを繰り返し呼び出して長期間アクセストークンを取得し続けることができる。また、大量リクエストによるサービス負荷攻撃にも利用される可能性がある。

**推奨対策**:
- リフレッシュエンドポイントへのアクセス頻度を制限する（例: 同一トークンによるリフレッシュは1分間隔以上を強制）
- リフレッシュトークンのローテーション（使用後に新しいリフレッシュトークンを発行し、旧トークンを無効化）を導入する

---

### [SIGNIFICANT-03] 認証エンドポイントのレートリミット設計欠如（ユーザー登録エンドポイント）

**該当箇所**: セクション 4.4 — 認証エンドポイント（POST /api/auth/register）

**問題の詳細**:
ユーザー登録エンドポイント `/api/auth/register` に対するレートリミットが設計書に明示されていない。

**影響**:
レートリミットが存在しない場合、攻撃者が大量の偽アカウントを自動生成できる（アカウントファーミング）。これによりスパム注文の生成、プラットフォームリソースの枯渇、プラットフォームの信頼性低下が生じる。

**推奨対策**:
- IPアドレス単位での登録試行回数を制限する
- メールアドレス検証フロー（確認メールのクリック）を設計に組み込む

---

### [SIGNIFICANT-04] CORS設定における正規表現マッチングの実装リスク

**該当箇所**: セクション 6.4 — CORS設定

**問題の詳細**:
`/\.nexamart\.com$/` という正規表現では `evil-nexamart.com` や `attacker.com?nexamart.com` のようなドメインは防げるが、`evilnexamart.com` が許可される可能性がある（`.` がエスケープされているため本例では防げるが）。より本質的な問題として、`Access-Control-Allow-Credentials: true` を設定しながらオリジンを動的に反映する実装は、正規表現の実装ミスが生じた際に認証情報付きのクロスオリジンリクエストを許可するリスクがある。また `nexamart.com` 自体（サブドメインなし）が許可されるかが不明確である。

**影響**:
`allow-credentials: true` 環境での誤ったCORS設定は、悪意あるサイトからの認証情報付きリクエスト（CSRFに類似）を可能にする。アクセストークンがCookieで保存される設計に移行した場合（CRITICAL-01対策後）、この問題の影響が増大する。

**推奨対策**:
- 許可オリジンを正規表現ではなく明示的なホワイトリスト（文字列完全一致）で管理する
- `Access-Control-Allow-Credentials: true` が必要なオリジンを最小限に絞る
- CORSポリシーをKongゲートウェイで一元管理し、アプリケーション側での実装を排除する

---

### [SIGNIFICANT-05] CSRF対策: JWTのみへの依存（独立した発見）

**該当箇所**: セクション 6.3 — CSRF対策

**問題の詳細**:
設計書は「JWTをAuthorizationヘッダーに付与することでCSRF対策として十分」と判断しているが、この判断はアクセストークンが `localStorage` に保存される前提に依存する。CRITICAL-01で指摘した通り、アクセストークンを `HttpOnly` Cookie に移行した場合（セキュリティ観点での必要な改善）、Authorizationヘッダーへの自動付与はJavaScriptが必要となるため、JWTによるCSRF防止の前提が崩れる。

なお、現状の `localStorage` 保存設計においてもJWTベースのCSRF防止が有効であるためには「XSSがない」という前提が必要であり、この前提自体が脆弱性（CRITICAL-01）であることを認識する必要がある。

**影響**:
トークン保存方式の変更（セキュリティ強化）を行った際に、CSRF脆弱性が顕在化するリスクがある。設計の依存関係が明示されていないため、将来の実装変更時に見落とされやすい。

**推奨対策**:
- `SameSite=Strict` または `SameSite=Lax` Cookie属性を明示的に設計する（リフレッシュトークンCookieへの適用を確認、アクセストークンをCookieに移行した場合も同様）
- state-changing APIに対してCSRFトークンを実装するか、Double Submit Cookie パターンを採用する
- CSRFとトークン保存方式の設計依存関係を設計書に明記する

---

### [SIGNIFICANT-06] アクセストークンの即時無効化不能設計

**該当箇所**: セクション 4.2 — セッション管理

**問題の詳細**:
アクセストークンはサーバーサイドのブロックリストを持たず、有効期限（60分）のみで失効管理を行う設計である。不正検知や権限変更時のトークン即時無効化はリフレッシュトークンの期限切れに依存するとされているが、これは最長60分間不正アクセスを許容することを意味する。

**影響**:
- テナント管理者のロールが剥奪された場合、最長60分間は管理者として操作を継続できる
- アカウント不正利用が検知されてもセッションを即座に終了できない
- パスワード変更後もアクセストークンが有効であり、不正者がアクセスを継続できる

**推奨対策**:
- Redisを用いたアクセストークンの短期ブロックリスト（トークンJTIによる管理）を導入する
- または、アクセストークンの有効期限を大幅に短縮（例: 5〜15分）し、リフレッシュトークンとの組み合わせで実質的なセッション制御を実現する
- 権限変更・強制ログアウト操作時はリフレッシュトークンと短期ブロックリストの両方を更新する

---

## Moderate Issues

### [MODERATE-01] ファイルアップロード: MIME型チェックがContent-Typeヘッダーのみ（独立した発見1）

**該当箇所**: セクション 6.5 — ファイルアップロード

**問題の詳細**:
MIME型チェックを `Content-Type` ヘッダーのみで行う設計は、ファイル実体の検証を行わない。クライアントは `Content-Type: image/jpeg` を指定しながら実際にはPHPスクリプトや実行可能ファイルをアップロードできる。

**影響**:
悪意あるファイルがS3に保存される。パブリックバケット経由でCloudFrontから配信された場合、悪意あるコンテンツがプラットフォームのドメイン下で提供されることになる。S3はデフォルトでスクリプトを実行しないが、悪意あるHTMLファイルの配信による格納型XSSや、他の脆弱性と組み合わせたサーバーサイドスクリプト実行のリスクがある。

**推奨対策**:
- ファイルのマジックバイト（バイナリシグネチャ）を検証してファイル実体の種別を確認する
- 許可する拡張子を明示的にホワイトリスト化する

---

### [MODERATE-02] ファイルアップロード: 拡張子検証の欠如（独立した発見2）

**該当箇所**: セクション 6.5 — ファイルアップロード

**問題の詳細**:
拡張子検証が明示的に「なし」と設計書に記載されている。Content-Type検証とは独立したバリデーション層として拡張子検証が設計されていない点は、それ自体が独立したセキュリティギャップである。

**影響**:
`.php.jpg`、`.html`、`.svg` 等の二重拡張子や特殊拡張子を持つファイルを許可することになり、CDNや将来のインフラ変更によってはスクリプト実行が可能となるリスクがある。SVGファイルはXSSペイロードを含めることができ、ブラウザで直接開いた場合に実行される。

**推奨対策**:
- 許可する拡張子（`.jpg`, `.jpeg`, `.png`, `.webp` 等）を明示的にホワイトリストで定義する
- Presigned URL生成時に許可拡張子を検証し、拒否する

---

### [MODERATE-03] 監査ログと通常ログの混在

**該当箇所**: セクション 8.4 — 監査ログ

**問題の詳細**:
監査ログをアプリケーションの通常ログと同一のCloudWatch Logsストリームに出力する設計では、監査証跡の完全性を保証できない。通常ログは開発上の理由でフィルタリング・削除されることがあり、また権限を持つ開発者がアプリケーションログを操作することで監査ログの改ざんが可能となる。

**影響**:
監査証跡が改ざん・削除された場合、インシデント調査、規制対応（GDPR等）、および法的証拠としての信頼性が失われる。特に「テナント管理者によるユーザーデータエクスポート」のような重要操作の記録が消去されるリスクは高い。

**推奨対策**:
- 監査ログ専用のCloudWatch Logsストリームを分離し、アプリケーション開発者による削除を防ぐ別権限（例: CloudTrailとの統合）を設ける
- 監査ログのS3エクスポートとObject Lock（WORM）を組み合わせて改ざん防止を実現する

---

### [MODERATE-04] PII保持期間・削除方針の未定義

**該当箇所**: セクション 5.3 — 個人情報（PII）管理

**問題の詳細**:
データ保持期間と退会時の削除フローが「現時点では未定義」とされている。GDPRをはじめとするプライバシー法規制は、個人情報の保持期間と削除権（忘れられる権利）の実装を要求する。設計段階での未定義は、後付けで対応する際の実装コストが非常に高くなるリスクを持つ。

**影響**:
規制違反リスク（GDPR違反は最大グローバル売上の4%または2000万ユーロの制裁）。また、退会したユーザーのデータが無期限に保持されることで、データ侵害時の影響範囲が拡大する。

**推奨対策**:
- データ保持期間ポリシー（例: 退会後90日でPII削除、注文履歴は会計要件で5年保持等）を設計段階で定義する
- 削除フローを設計書の当該リリース前に実装計画に含める

---

### [MODERATE-05] 個人情報フィールドの平文保存（フィールドレベル暗号化なし）

**該当箇所**: セクション 5.1 — 保存データの暗号化

**問題の詳細**:
氏名・住所・電話番号をRDS TDE保護下で平文保存する設計は、TDEが保護するのはディスクレベルであり、データベースにアクセスできる権限を持つ内部者・侵害されたDBクレデンシャルからは平文で閲覧可能であることを認識する必要がある。

**影響**:
DBアクセス権を持つ開発者・DBAが全ユーザーのPIIを平文で閲覧できる。DBクレデンシャルが漏洩した場合（CRITICAL-02が実現した場合等）、全ユーザーのPIIが即座に漏洩する。

**推奨対策**:
- 氏名・住所・電話番号に対してアプリケーションレベルの暗号化（フィールドレベル暗号化）を導入することを検討する
- 最低限、アクセスできる人員を最小化するDB権限設計と、PIIへのアクセスを監査ログで記録する仕組みを設ける

---

## Minor Issues / Positive Aspects

### [MINOR-01] `multer@1.4.4` の既知脆弱性リスク

**該当箇所**: セクション 8.2 — 依存ライブラリ管理

**問題の詳細**:
`multer@1.4.4` は既知のセキュリティ問題（ReDoSなど）を持つバージョンである可能性がある。また、Presigned URL経由のクライアント直接アップロードを採用しているにもかかわらず、multerがバックエンドに存在する理由が設計書から明確でない（サーバー経由のアップロードパスが残存している可能性）。

**推奨対策**:
- multerの最新安定版への更新を次回の四半期セキュリティアップデートに含める
- multerの使用箇所を明確にし、Presigned URLのみを使用する場合はmulterの除去を検討する

### [POSITIVE-01] 良好なセキュリティ設計要素

以下の点は適切に設計されており、評価できる:
- bcrypt cost factor 12によるパスワードハッシュ化
- リフレッシュトークンのHttpOnly Cookie保存とRedisブラックリスト
- Prisma ORM のパラメータ化クエリによるSQLインジェクション対策
- クレジットカード情報のStripe委譲（本システムでのPCI DSS対象外化）
- AWS Secrets Manager によるシークレット管理（ただし secrets.prod.yaml の問題を除く）
- ECSコンテナのプライベートサブネット配置
- CSP設定の導入

---

## Summary

| 深刻度 | 件数 | 主要項目 |
|-------|------|---------|
| Critical | 4件 | アクセストークンlocalStorage保存、本番シークレットリポジトリ管理、X-Tenant-IDヘッダー信頼、StripeWebhook署名検証欠如 |
| Significant | 6件 | 認証エンドポイントレートリミット（login/refresh/register各独立）、CORS実装リスク、CSRF設計依存、トークン即時無効化不能 |
| Moderate | 5件 | ファイルアップロードMIME検証（2件独立）、監査ログ混在、PII保持期間未定義、フィールドレベル暗号化なし |
| Minor | 1件 | multerバージョンリスク |

最優先で対処すべきは CRITICAL-02（本番シークレットのリポジトリ管理）であり、既に漏洩が発生している可能性があるため即座に調査とシークレットローテーションを実施することを推奨する。次いで CRITICAL-01（localStorage）とCRITICAL-04（Webhook署名検証）の対応を進めること。
