# Security Design Review: MediConnect システム設計書

## Executive Summary

MediConnect は医療機関向けの電子カルテ・遠隔診療プラットフォームであり、患者の医療情報・PII・保険情報を扱う高感度システムである。本レビューでは、設計書に記載された内容を対象に、アーキテクチャ・設計レベルのセキュリティ評価を実施した。複数の重大な問題を検出した。

---

## Critical Issues（重大な問題）

### CRIT-01: CORS設定でワイルドカード（`*`）を使用

**対象セクション:** 7.3 CORS設定

**問題の詳細:**
設計書には「`Access-Control-Allow-Origin: *` を設定する」と明記されている。この設定は、あらゆるオリジンからのクロスオリジンリクエストを許可する。

医療情報・PII・認証情報を扱うAPIに対してワイルドカードCORSを適用することで、以下のリスクが生じる：

- 攻撃者が制御する任意のドメイン（例: `evil.com`）からスクリプトを実行し、認証済みユーザーのブラウザ経由でAPIを呼び出せる
- ただし `Access-Control-Allow-Origin: *` と `Access-Control-Allow-Credentials: true` の組み合わせはブラウザ仕様上禁止されているが、クレデンシャルなしのリクエスト（例: 公開API、またはCORS設定が誤ってCredentials不要として扱われるエンドポイント）では情報漏洩が成立しうる
- 本番環境でも「必要に応じて絞り込みを検討」とあり、制限が適用されないまま稼働するリスクが高い

**追加評価（パターンベースCORS設定の観点）:**
今回の設定はワイルドカード `*` を使用した明示的な全許可パターンである。これは最も危険なCORS設定のひとつであり、特定のドメインやサフィックスに基づくパターンマッチングよりもリスクが高い（サフィックスマッチ等の場合は `evil.example.com` がバイパスできるが、本件はそもそも全オリジンを許可している）。「本番環境では必要に応じて絞り込みを検討」という記述は、本番稼働時もワイルドカードが残存するリスクを内包している。

**影響:**
- 患者の医療情報・個人情報への不正アクセス
- CSRF攻撃の成立条件の一部を満たす

**推奨する対処:**
- 許可するオリジンを明示的に列挙する（例: `https://app.mediconnect.example.com`）
- 本番環境では絶対にワイルドカードを使用しない。設計書に「本番では明示的オリジン指定を必須とする」と明記する
- 開発環境でもワイルドカードを使用する場合は、本番とは別のCORS設定管理フローを設ける

---

### CRIT-02: JWTアクセストークンをlocalStorageに保存

**対象セクション:** 5.1 認証フロー（手順4）

**問題の詳細:**
「クライアントはアクセストークンを `localStorage` に保存する」と明記されている。localStorageに保存されたトークンはXSSによる窃取が容易であり、XSS攻撃が成功した場合にセッションハイジャックが成立する。

**影響:**
- XSS経由での認証トークン窃取
- 患者・医師・管理者アカウントの完全な乗っ取り
- 電子カルテ・処方箋への不正アクセス

**推奨する対処:**
- アクセストークンはメモリ（JavaScriptの変数）上にのみ保持し、永続化しない
- リフレッシュトークンはHttpOnly + Secure + SameSite=Strictのcookieに保存する

---

### CRIT-03: CSRF保護が未設計

**対象セクション:** 7.4 セッション系APIの保護

**問題の詳細:**
「state-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外とする」と明記されている。処方箋発行（`POST /api/v1/prescriptions`）、患者情報更新（`PUT /api/v1/patients/{id}`）などはstate-changingな操作であり、CSRF保護が不在の場合、正規ユーザーが悪意のあるサイトを閲覧するだけでこれらの操作が実行される。

**影響:**
- 攻撃者による不正な処方箋発行
- 患者情報の改ざん
- 医療安全への直接的な影響

**推奨する対処:**
- CSRFトークン（Double Submit CookieまたはSynchronizer Token Pattern）を設計に組み込む
- SameSite=Strict cookieをセッション管理に採用する
- JWTがAuthorizationヘッダーで送信されるケースはCSRF耐性があるが、cookieを併用する場合は別途対策が必要

---

### CRIT-04: ログイン・リフレッシュエンドポイントにレート制限なし

**対象セクション:** 8.5 認証エンドポイント保護

**問題の詳細:**
「`/api/v1/auth/login` エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計とする」と明記されている。これにより、ブルートフォース攻撃・クレデンシャルスタッフィング攻撃が無制限に実行できる。

リフレッシュトークンエンドポイント（`POST /api/v1/auth/refresh`）についてもレート制限の記述がない。

**影響:**
- 医師・患者アカウントへのブルートフォース攻撃が成立
- 認証システムの完全な突破

**推奨する対処:**
- ログインエンドポイントにIPベースおよびアカウントベースのレート制限を設計する（例: 5回失敗で15分ロックアウト）
- AWS WAFのレート制限ルールを活用する
- リフレッシュトークンエンドポイントにも同様の保護を設計する

---

### CRIT-05: doctorロールが全患者データに無制限アクセス可能

**対象セクション:** 5.2 認可モデル

**問題の詳細:**
「doctorロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする」と明記されている。マルチテナント医療システムにおいて、医師が自身の担当患者以外の患者データに無制限アクセスできることは、プライバシー侵害・不正閲覧の重大なリスクである。

**影響:**
- 医師が無関係な患者の医療情報・個人情報を閲覧できる
- 医療情報の不正利用・漏洩
- 日本の個人情報保護法・医療情報ガイドライン違反

**推奨する対処:**
- 医師は担当患者（診療関係が存在する患者）のデータのみアクセス可能とする
- `GET /api/v1/patients/{id}` において、doctor_idとpatient_idの関係検証を必須とする
- Break-the-glass（緊急アクセス）が必要な場合は専用の監査ログ付き承認フローを設計する

---

## Significant Issues（重要な問題）

### SIG-01: VPC内部通信が平文

**対象セクション:** 6.1 通信の暗号化

**問題の詳細:**
「VPC内部の通信については内部ネットワークであるため平文で行う」と明記されている。ECSサービス間通信（auth-service、patient-service、consultation-service、prescription-service間）、ECS〜RDS間、ECS〜Redis間が暗号化されない設計である。

**影響:**
- VPC内へのアクセスを得た攻撃者（侵害されたコンテナ、横断侵害等）が医療情報を平文で盗聴できる
- マルチテナント環境では他テナントのデータが平文でネットワーク上に流れる

**推奨する対処:**
- サービス間通信にTLS（mTLS）を適用する
- RDS接続にssl-mode=requireを設定する
- Redis接続にTLS（ElastiCache in-transit encryption）を有効化する

---

### SIG-02: 医療機密情報のアプリケーションレベル暗号化なし

**対象セクション:** 6.2 保存データの暗号化

**問題の詳細:**
「診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している」と明記されている。RDS暗号化はディスクレベルの保護であり、DBMSへのアクセス権を持つ者（DBA、侵害されたサービスアカウント等）に対してはデータが平文で見える。

**影響:**
- 内部不正・特権ユーザーによる患者の医療情報への無制限アクセス
- RDS認証情報が漏洩した場合の全データ露出

**推奨する対処:**
- `diagnosis`、`soap_note`、`medications` カラム等の医療機密情報にアプリケーションレベルの暗号化を適用する
- 暗号化キーはAWS KMS等で管理し、アプリケーションとDBのアクセス制御を分離する

---

### SIG-03: 患者情報のPIIログ出力管理が個人判断任せ

**対象セクション:** 6.3 個人情報の取り扱い

**問題の詳細:**
「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする」と明記されている。これは医療情報という最高感度のデータについて、ログ管理方針を個人の裁量に委ねるものであり、意図せざるPII漏洩が高確率で発生する。

**影響:**
- 診断内容・保険番号等がCloudWatch Logsに平文で記録される
- ログへのアクセス権を持つ者が患者情報を参照できる
- 個人情報保護法・医療情報ガイドライン違反

**推奨する対処:**
- PIIおよび医療情報のログ出力を禁止するポリシーをシステム設計に明記する
- PIIが含まれうるフィールドはマスキング・匿名化処理を実装する
- ログの保持期間とアクセス制御を設計に含める

---

### SIG-04: ファイルアップロードのファイル種別・サイズ制限が未定義

**対象セクション:** 7.2 ファイルアップロード

**問題の詳細:**
「ファイル種別・サイズの制限は実装フェーズで決定する」と明記されている。ウイルススキャンは実施されるが、ファイル種別とサイズ制限が設計段階で未定義であることは、実装時にこれらが省略されるリスクを生む。

**影響:**
- 悪意あるファイル形式（実行可能ファイル、SVG（XSS）等）のアップロード
- 大容量ファイルによるストレージ枯渇・DoS

**推奨する対処:**
- 設計書に許可するファイル形式（例: JPEG, PNG, PDF）とサイズ上限（例: 最大10MB）を明記する
- S3へのアップロード前にMIMEタイプ検証とマジックバイト検証を設計に含める

---

## Moderate Issues（中程度の問題）

### MOD-01: アクセストークン有効期限が24時間と長すぎる

**対象セクション:** 5.1 認証フロー（手順3）

**問題の詳細:**
アクセストークンの有効期限が24時間に設定されている。これは医療システムとして適切ではなく、トークンが窃取された場合の被害継続時間が長くなる。

**推奨する対処:**
- アクセストークンの有効期限を15〜60分程度に短縮する
- リフレッシュトークンによる再発行フローで使い勝手を補う

---

### MOD-02: リフレッシュトークンのユーザーID単位管理による多重ログインリスク

**対象セクション:** 5.3 セッション管理

**問題の詳細:**
「ユーザーIDをキーとしてトークン値を管理する」設計では、ユーザーが複数デバイスからログインした場合に最後のトークンのみが有効となり、また漏洩したトークンによる不正ログインと正規ログインの区別が困難になる。

**推奨する対処:**
- トークンID（JTI）単位でのリフレッシュトークン管理に変更する
- 各デバイス・セッションごとに個別のエントリを持つ設計とし、特定セッションの失効を可能にする

---

### MOD-03: サードパーティ依存関係の脆弱性チェック方針が未定義

**対象セクション:** 8.2 サードパーティ依存関係

**問題の詳細:**
「脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定」とあり、現設計では方針が存在しない。Twilio Video SDK v2.27.0 等の具体的なバージョンが固定されているが、脆弱性が発見された場合の対応フローが不明である。

**推奨する対処:**
- CI/CDパイプラインへのnpm audit / Snyk等のSCA（Software Composition Analysis）ツール統合を設計に明記する
- 重大な脆弱性検出時のパッチ適用SLAを定義する

---

### MOD-04: バックアップデータの暗号化と保護方針の記述なし

**対象セクション:** 9.3 バックアップ

**問題の詳細:**
RDS自動バックアップとS3バージョニングが記述されているが、バックアップデータの暗号化、保持期間、アクセス制御の設計が明記されていない。

**推奨する対処:**
- RDS自動バックアップがRDS暗号化設定を継承することを明記する
- バックアップデータへのアクセス制御（最小権限IAMポリシー）を設計に含める

---

## Positive Aspects（評価できる点）

- **Secrets Manager採用:** DBパスワード・APIキーをAWS Secrets Managerで管理する設計は適切である（セクション8.1）
- **bcrypt コスト係数12:** パスワードハッシュにbcryptコスト係数12を採用しており、適切な強度設定である（セクション5.1）
- **マルチスキーマによるテナント分離:** テナントごとのスキーマ分離は、SQLインジェクション等によるクロステナントデータアクセスのリスクを低減する（セクション3.2）
- **RDS・Redisのプライベートサブネット配置:** データストアが外部から直接アクセスできない構成は適切である（セクション8.4）
- **ウイルススキャン:** ファイルアップロード時のウイルススキャン実施は評価できる（セクション7.2）

---

## Summary Table

| ID | 重大度 | 問題 | セクション |
|----|--------|------|-----------|
| CRIT-01 | Critical | CORS wildcard設定（`*`） | 7.3 |
| CRIT-02 | Critical | JWTをlocalStorageに保存 | 5.1 |
| CRIT-03 | Critical | CSRF保護が未設計 | 7.4 |
| CRIT-04 | Critical | 認証エンドポイントにレート制限なし | 8.5 |
| CRIT-05 | Critical | doctorロールが全患者データに無制限アクセス | 5.2 |
| SIG-01 | Significant | VPC内部通信が平文 | 6.1 |
| SIG-02 | Significant | 医療機密情報のアプリケーション暗号化なし | 6.2 |
| SIG-03 | Significant | PIIログ出力がエンジニア判断任せ | 6.3 |
| SIG-04 | Significant | ファイルアップロード制限が未定義 | 7.2 |
| MOD-01 | Moderate | アクセストークン有効期限24時間 | 5.1 |
| MOD-02 | Moderate | リフレッシュトークンのユーザーID単位管理 | 5.3 |
| MOD-03 | Moderate | 依存関係の脆弱性チェック方針なし | 8.2 |
| MOD-04 | Moderate | バックアップデータ保護の記述なし | 9.3 |
