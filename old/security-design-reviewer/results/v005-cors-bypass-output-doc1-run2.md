# Security Design Review: MediConnect システム設計書

## Executive Summary

MediConnect は医療機関向けの電子カルテ・遠隔診療プラットフォームであり、患者の機微情報（PII・医療情報）を大量に扱うシステムである。本レビューでは、設計書に記載されたセキュリティ設計上の問題点を重大度順に報告する。

---

## 重大な問題（Critical）

### [CRITICAL-01] CORS設定: ワイルドカードオリジンと認証情報の組み合わせによるバイパスリスク

**対象箇所:** §7.3 CORS設定

**問題の詳細:**

設計書には以下の記述がある。

> API Gateway の CORS 設定は、開発効率を優先するため `Access-Control-Allow-Origin: *` を設定する。本番環境では必要に応じて絞り込みを検討する。

この設定は以下の具体的な攻撃シナリオを許容する。

1. **ワイルドカード+認証情報の矛盾**: RFC 6454 および Fetch Spec により、`Access-Control-Allow-Origin: *` と `Access-Control-Allow-Credentials: true` は同時に有効化できない。しかし、設計書では JWT を `localStorage` に保存し、`Authorization: Bearer` ヘッダーで送信する設計（§5.1）が採用されている。攻撃者が悪意あるページから XMLHttpRequest/fetch を発行した場合、ブラウザはヘッダーを含むリクエストを送信できる。

2. **任意オリジンからのAPI呼び出し**: `Access-Control-Allow-Origin: *` が本番環境にそのまま適用された場合、`https://attacker.example.com` を含む任意のオリジンから API エンドポイントへのクロスオリジンリクエストが許可される。患者情報取得エンドポイント（`GET /api/v1/patients/{id}`）や処方箋取得（`GET /api/v1/patients/{id}/prescriptions`）が攻撃対象となり得る。

3. **「本番環境では必要に応じて検討」は設計上の欠陥**: 本番移行前に CORS ポリシーを確定させることは設計フェーズの責任である。この記述は本番環境でのリスクを先送りにしており、設計不備として扱う必要がある。

**影響:**
- 任意の悪意あるウェブサイトから患者の医療情報・処方箋・PII への不正アクセスが可能
- HIPAA/個人情報保護法・医療情報ガイドラインへの違反リスク

**推奨対策:**
- 許可オリジンを明示的なホワイトリスト（例: `https://app.mediconnect.jp`, `https://admin.mediconnect.jp`）で指定する
- ワイルドカード `*` の本番環境での使用を設計上明示的に禁止する
- CORS ポリシーを環境ごと（開発/ステージング/本番）に明確に定義する

---

### [CRITICAL-02] JWTトークンのlocalStorage保存によるXSS経由の認証情報窃取

**対象箇所:** §5.1 認証フロー

**問題の詳細:**

> クライアントはアクセストークンを `localStorage` に保存し、以降のAPIリクエストに `Authorization: Bearer` ヘッダーで付与する

`localStorage` はJavaScriptから直接アクセス可能であるため、XSS脆弱性が存在した場合にアクセストークンおよびリフレッシュトークンが完全に窃取される。アクセストークンの有効期限が24時間、リフレッシュトークンが30日であるため、攻撃者は長期間にわたって患者の医療情報へのアクセスを維持できる。

**影響:**
- XSS一発で認証情報が完全に窃取され、長期間の不正アクセスが可能
- 医療機密情報・PII の大規模漏洩リスク

**推奨対策:**
- アクセストークンはメモリ（JavaScriptの変数）にのみ保持し、ページリロード時はリフレッシュトークンで再取得する
- リフレッシュトークンは `HttpOnly; Secure; SameSite=Strict` Cookie で管理する
- アクセストークンの有効期限を15〜60分程度に短縮する

---

### [CRITICAL-03] doctorロールによる全患者データへの無制限アクセス

**対象箇所:** §5.2 認可モデル

**問題の詳細:**

> doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする

この設計は、担当患者外の患者情報への横断的アクセスを医師に許可しており、最小権限原則（Principle of Least Privilege）に違反する。マルチテナント設計（§3.2）と組み合わせると、テナント内の全患者（他医師の担当患者を含む）に対する無制限閲覧が可能となる。

**影響:**
- 医師による担当外患者の診療情報・処方内容への不正閲覧
- 医師法・個人情報保護法・医療情報ガイドライン違反リスク
- 内部脅威（不正な医師による患者情報の大量取得）への無防備

**推奨対策:**
- doctor ロールには「担当患者のみ」アクセス可能なフィルタリングを実装する（診療予約・担当関係に基づく）
- 患者情報取得 API に担当医師の関係チェックを必須化する
- 管理者のみが承認した場合に限り、他担当患者情報へのアクセスを許可する緊急アクセスフローを設計する

---

### [CRITICAL-04] CSRFトークン・SameSite属性の未設計

**対象箇所:** §7.4 セッション系APIの保護

**問題の詳細:**

> 医師による処方箋発行（`POST /api/v1/prescriptions`）や患者情報更新（`PUT /api/v1/patients/{id}`）などのstate-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外とする

処方箋発行・患者情報更新といった医療行為に直結する操作に対して、CSRF保護が設計されていない。`Authorization: Bearer` ヘッダーによる JWT は CSRF 攻撃に対する部分的な緩和にはなるが（単純なフォームPOSTでは付与されない）、以下のシナリオでは不十分である。

- XMLHttpRequest/fetch を用いた CSRF 攻撃（CORS が `*` の場合）
- JWT がCookieで送信される場合の攻撃

**独立した発見として報告（Defense Layer Separation ルールに基づく）:**

1. **CSRFトークンの未設計**: State-changing エンドポイントに対するCSRFトークン検証が設計されていない
2. **SameSite Cookie属性の未設計**: Cookie使用時のSameSite属性設定が設計に含まれていない

**影響:**
- 悪意あるウェブサイトからの偽造リクエストによる不正な処方箋発行
- 患者情報の不正変更（住所・連絡先・保険番号）

**推奨対策:**
- State-changing な全 API に CSRF トークン検証を設計する
- Cookie 使用時は `SameSite=Strict` 属性を必須とする

---

## 重大な問題（Significant）

### [SIGNIFICANT-01] 認証エンドポイントのレート制限未実装

**対象箇所:** §8.5 認証エンドポイント保護

**問題の詳細:**

> `/api/v1/auth/login` エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計とする

ログインエンドポイントにレート制限がない場合、ブルートフォース攻撃・クレデンシャルスタッフィング攻撃が無制限に実行可能である。医療情報システムという高リスク環境での設計として重大な問題である。

**独立した発見として報告（Defense Layer Separation ルールに基づく）:**

1. **ログインエンドポイントのレート制限未設計**: `/api/v1/auth/login` に対するレート制限が高可用性を理由に意図的に除外されている
2. **パスワードリセット・トークンリフレッシュへのレート制限未設計**: `/api/v1/auth/refresh` に対する乱用防止機構の設計が存在しない（§3.3に記載があるが保護設計なし）

**影響:**
- パスワードブルートフォース攻撃による不正ログイン
- クレデンシャルスタッフィング（他サービスから流出したID/PW一覧での攻撃）
- リフレッシュトークン乱用による DoS

**推奨対策:**
- ログインエンドポイントにIPアドレス・アカウントベースのレート制限を設ける（例: 5回失敗で15分ロック）
- アカウントロックアウト + 管理者通知の設計を追加する
- リフレッシュトークンエンドポイントにも独立したレート制限を設ける

---

### [SIGNIFICANT-02] VPC内部通信の平文通信

**対象箇所:** §6.1 通信の暗号化

**問題の詳細:**

> VPC 内部の通信については内部ネットワークであるため平文で行う

ECS Fargate サービス間通信（auth-service, patient-service, consultation-service, prescription-service 間）およびサービス〜RDS/Redis 間の通信が平文である。VPC内であっても、以下のリスクがある。

- 内部不正アクセス（悪意ある従業員・侵害されたコンテナからのスニッフィング）
- クラウド設定ミスによるVPC内通信の意図せぬ露出
- 医療情報ガイドライン（厚生労働省）が要求する通信保護要件への非準拠リスク

**影響:**
- 患者の医療情報・PII が内部ネットワーク上で平文で流れる
- セキュリティ規制への非準拠リスク

**推奨対策:**
- サービス間通信にTLS（相互TLS）を採用する
- RDS・Redis への接続にTLSを強制する（AWS RDS SSL接続強制、Redis TLS設定）

---

### [SIGNIFICANT-03] サーバーサイド入力検証の実質的な欠如

**対象箇所:** §7.1 入力検証方針

**問題の詳細:**

> すべてのAPIリクエストにおいて、フロントエンドで入力検証が完了した状態でAPIに送信される設計とする。バックエンドでは基本的な型チェック（JSONスキーマバリデーション）のみ実施する。

**独立した発見として報告（Defense Layer Separation ルールに基づく）:**

1. **フロントエンド単体での入力検証**: フロントエンドの検証はAPIクライアント（curl, Postman等）で容易にバイパス可能
2. **サーバーサイドでの実質的な検証欠如**: JSONスキーマバリデーション（型チェックのみ）は、SQLインジェクション・NoSQLインジェクション・XSSペイロードに対する防御として不十分

**影響:**
- APIを直接呼び出すことで、フロントエンド検証を完全バイパスしたSQLインジェクション攻撃が可能
- 処方箋情報・診断内容への不正なデータ注入

**推奨対策:**
- サーバーサイドでの包括的な入力バリデーション（型・フォーマット・ビジネスルール）を必須化する
- ORM（Sequelize/Prisma等）のパラメータバインディングを徹底する
- 入力値のサニタイゼーションポリシーをサーバーサイドで定義する

---

## 中程度の問題（Moderate）

### [MODERATE-01] ファイルアップロードのセキュリティ制限の未確定

**対象箇所:** §7.2 ファイルアップロード

**問題の詳細:**

> ファイル種別・サイズの制限は実装フェーズで決定する

ウイルススキャンは設計されているが、ファイル種別・サイズの制限が設計フェーズで未確定である。これは実装フェーズで制限が漏れるリスクを生む。

**影響:**
- 悪意あるファイル（実行可能ファイル、SVGを用いたXSS）のアップロード
- 大容量ファイルによるDoS

**推奨対策:**
- 許可するファイル種別（JPEG/PNG/PDF等）をMIMEタイプおよび拡張子でホワイトリスト定義する
- 最大ファイルサイズ制限を設計書に明示する（例: 画像10MB, PDF5MB）
- ファイル名のサニタイゼーション方針を設計に含める

---

### [MODERATE-02] 患者PII含むログ出力のエンジニア裁量運用

**対象箇所:** §6.3 個人情報の取り扱い

**問題の詳細:**

> 患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする

医療情報システムにおいてPIIのログ出力をエンジニア個人の判断に委ねることは、個人情報保護法・医療情報ガイドラインへの違反リスクを高める。

**影響:**
- 患者氏名・保険証番号・診断内容がCloudWatch Logsに平文で残存するリスク
- セキュリティインシデント時に調査コストが増大

**推奨対策:**
- PIIをログに含めることを明示的に禁止するポリシーを設計書に記載する
- PIIのマスキング・ハッシュ化ルールを定義する（例: メールアドレスは`user@***`に変換）

---

### [MODERATE-03] アプリケーションレベル暗号化の未適用（医療機密情報）

**対象箇所:** §6.2 保存データの暗号化

**問題の詳細:**

> 診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している

RDS暗号化はディスクレベルの暗号化（at-rest）であり、データベースへのアクセス権限を持つユーザーには平文で表示される。医療機密情報に対しては、アプリケーションレベルでのカラム暗号化を検討する必要がある。

**影響:**
- DBアクセス権限を持つ内部者による医療情報の大量閲覧
- DBバックアップファイル（スナップショット）を取得した攻撃者による情報解読

**推奨対策:**
- `diagnosis`・`soap_note`・`medications` カラムにアプリケーションレベルの暗号化（AES-256-GCM等）を適用する
- 暗号化キーをAWS KMSで管理し、アクセス権限をアプリケーションロールに限定する

---

### [MODERATE-04] サードパーティ依存関係の脆弱性管理方針未確定

**対象箇所:** §8.2 サードパーティ依存関係

**問題の詳細:**

> 脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定である

Twilio Video SDK v2.27.0、Express 4.18 等の具体的なバージョンが設計書に記載されているが、脆弱性スキャンのスケジュール・対応プロセスが未定義である。

**推奨対策:**
- Dependabot / Snyk 等の自動脆弱性スキャンをCI/CDパイプラインに組み込む設計を追加する
- 重大な脆弱性（CVSSスコア7.0以上）に対するSLAを設計段階で定義する

---

## 軽微な問題（Minor）

### [MINOR-01] テナント間分離の検証設計が不明確

**対象箇所:** §3.2 マルチテナント設計

**問題の詳細:**

JWT の `tenant_id` クレームによるテナント識別は、JWT改ざんがなければ有効だが、「テナントIDのAPIレイヤーでの検証」が設計として明示されていない。`GET /api/v1/patients/{id}` において、別テナントの `patient_id` を指定した際の拒否設計が確認できない。

**推奨対策:**
- 全 patient-service API において、`patient.tenant_id == jwt.tenant_id` の検証を設計として明示する
- テナント間アクセス試行を監査ログに記録する

---

### [MINOR-02] 監査ログの完全性・改ざん防止設計の欠如

**対象箇所:** §8.3 監査ログ

**問題の詳細:**

CloudWatch Logs への記録は適切だが、以下が未設計である。
- ログの改ざん防止（CloudWatch Log Integrity等）
- 処方箋発行・患者情報変更などの医療行為に特化した監査イベントの定義

**推奨対策:**
- 医療行為イベント（処方箋発行・診療記録作成・患者情報変更）を専用の監査ログストリームに記録する
- CloudTrailとの統合による改ざん検知を設計に含める

---

## ポジティブな評価点

- AWS Secrets Manager によるシークレット管理（§8.1）は適切
- bcrypt コスト係数12 によるパスワードハッシュ化（§5.1）は適切
- RDS Multi-AZ + ECS最小タスク数2による可用性設計（§9.1）は良好
- Redis によるリフレッシュトークン管理とログアウト時の明示的削除（§5.3）は適切
- VPCプライベートサブネットへのRDS/Redis配置（§8.4）は基本的なネットワーク分離として適切

---

## 優先対応マトリクス

| 優先度 | 項目 | 対応工数（概算） |
|--------|------|-----------------|
| 最優先 | CRITICAL-01: CORS設定の即時修正 | 低（設定変更） |
| 最優先 | CRITICAL-03: doctorロールのアクセス制御設計変更 | 中（設計変更） |
| 最優先 | CRITICAL-04: CSRF保護設計の追加 | 中（設計変更） |
| 高 | CRITICAL-02: JWTトークン保存場所の変更 | 中（設計変更） |
| 高 | SIGNIFICANT-01: レート制限設計の追加 | 低（設計追記） |
| 高 | SIGNIFICANT-03: サーバーサイド検証の強化 | 中（実装変更） |
| 中 | SIGNIFICANT-02: 内部通信TLS化 | 中（インフラ変更） |
| 中 | MODERATE-01〜04 | 各種設計追記 |
| 低 | MINOR-01〜02 | 設計書への明示 |
