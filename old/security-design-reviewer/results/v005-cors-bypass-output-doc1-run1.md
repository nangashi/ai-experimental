# Security Design Review: MediConnect システム設計書

## 評価サマリー

MediConnect は医療情報を扱う高感度システムであるが、設計書には複数の重大なセキュリティ欠陥が認められる。以下、重大度順に報告する。

---

## CRITICAL（重大）

### C-01: CORS ワイルドカード設定 — 認証情報漏洩リスク

**該当箇所:** §7.3 CORS設定

**問題詳細:**

```
Access-Control-Allow-Origin: *
```

設計書は API Gateway に `Access-Control-Allow-Origin: *` を設定することを明示しており、「本番環境では必要に応じて絞り込みを検討する」と先送りにしている。

ワイルドカード設定における具体的なバイパス可能性:

1. **クレデンシャル付きリクエストとの組み合わせ問題**: RFC 6454 / Fetch 仕様上、`Access-Control-Allow-Origin: *` と `Access-Control-Allow-Credentials: true` を同時に設定することはブラウザが拒否する。しかし、本設計では JWT を `localStorage` に保存し（§5.1）、`Authorization: Bearer` ヘッダーで送信する。`Authorization` ヘッダーは `withCredentials` なしでも攻撃者がスクリプト経由で設定できるため、ワイルドカード CORS 配下では任意の攻撃者ドメイン（`https://evil.com`）からのクロスオリジンリクエストが JWT を `Authorization` ヘッダーに付けて送信可能となる。

2. **攻撃シナリオ**: 医師が `https://evil.com` にアクセスした状態で、攻撃者のスクリプトが医師の `localStorage` から JWT を読み取り（XSS 経由、またはサブドメイン汚染）、`GET /api/v1/patients/{id}` にリクエストを送信する。ワイルドカード CORS のため API Gateway はレスポンスを返し、患者の医療情報が取得される。

**影響:** 患者の医療情報（診断結果、処方内容、保険証番号）の第三者漏洩。医療情報漏洩は厚生労働省ガイドライン違反に直結する。

**対策:**
- 本番環境では `Access-Control-Allow-Origin` を許可ドメインホワイトリスト（例: `https://app.mediconnect.example.com`）に限定すること。ワイルドカードは開発環境に限定し、IaC（Terraform）で環境別に分離する。
- 設計フェーズの段階で許可オリジンリストを確定し、設計書に明記すること。

---

### C-02: doctor ロールの患者データ全件アクセス — 水平権限昇格

**該当箇所:** §5.2 認可モデル

**問題詳細:**

> doctor ロールは `patient_id` パラメータによるフィルタリングなしに patient-service の全患者データを参照できる設計とする。

この設計では、ある医療機関（テナント）に所属する医師が、自身の担当患者以外の全患者の診療記録・処方箋・個人情報にアクセスできる。

**影響:** 担当外患者の医療情報への不正アクセス。日本医師法・医療法における守秘義務違反、および厚生労働省の医療情報ガイドライン違反。不正アクセス禁止法の適用可能性もある。

**対策:**
- `GET /api/v1/patients/{id}` および `GET /api/v1/patients/{id}/records` の authorization ミドルウェアにおいて、doctor ロールは担当患者（`medical_records.doctor_id = 認証済みユーザーID`）のみにアクセスを制限すること。
- 担当医師の定義（診療関係の開始・終了）を明示的に設計すること。

---

### C-03: JWT を localStorage に保存 — XSS によるトークン窃取

**該当箇所:** §5.1 認証フロー（ステップ4）

**問題詳細:**

> クライアントはアクセストークンを `localStorage` に保存し

`localStorage` は JavaScript から読み取り可能であるため、XSS 脆弱性が発生した場合、攻撃者はトークンを完全に窃取できる。医師のトークンが窃取されると、そのテナントの全患者データへのアクセスが可能になる（C-02 と組み合わせると影響が拡大する）。

**影響:** XSS 攻撃による長期的なセッション乗っ取り（アクセストークン24時間、リフレッシュトークン30日）。

**対策:**
- アクセストークンをメモリ（React state / module変数）に保持し、`localStorage` には保存しないこと。
- リフレッシュトークンは `HttpOnly; Secure; SameSite=Strict` Cookie に格納し、JavaScript からアクセス不能にすること。

---

### C-04: 認証エンドポイントのレート制限なし — ブルートフォース攻撃

**該当箇所:** §8.5 認証エンドポイント保護

**問題詳細:**

> `/api/v1/auth/login` エンドポイントについては、高可用性を優先するため呼び出し制限は設けない設計とする。

医療システムにおいて、ログインエンドポイントにレート制限がない場合、攻撃者は無制限にパスワードを試行できる。bcryptのコスト係数12はサーバー側の負荷を増やすが、クライアント側（攻撃者）の並列試行には無力である。

同様に `POST /api/v1/auth/refresh` にも乱用防止設計が言及されていない。

**影響:** ブルートフォース攻撃による患者・医師アカウントの侵害。医療情報への不正アクセス。

**対策:**
- ログインエンドポイントに IP ベース・アカウントベースのレート制限を設計すること（例: 5回失敗で15分ロックアウト、または AWS WAF の rate-based rule）。
- リフレッシュトークンエンドポイントにも per-token のレート制限を設計すること。

---

## SIGNIFICANT（重要）

### S-01: VPC 内部通信の平文化 — 内部脅威・横断侵害リスク

**該当箇所:** §6.1 通信の暗号化

**問題詳細:**

> VPC 内部の通信については内部ネットワークであるため平文で行う。

ECS Fargate 上のマイクロサービス（auth-service, patient-service, consultation-service, prescription-service）間の通信、および Application Layer から PostgreSQL（RDS）・Redis への通信が平文で行われる。

医療情報（診断内容、処方内容）がこれらの経路を通る場合、VPC 内の侵害（コンテナエスケープ、サイドカー注入、マルウェア感染した別サービス）により患者データが傍受される。

**影響:** 内部ネットワーク侵害時の患者医療情報の平文傍受。STRIDE モデルの Information Disclosure 脅威に直接対応する。

**対策:**
- サービス間通信に TLS（mTLS 推奨）を使用すること。AWS App Mesh または ECS Service Connect による mTLS を設計に含めること。
- RDS 接続に TLS を強制すること（`require_ssl` オプション）。
- Redis 接続に TLS（Redis 6.0以降の TLS サポート）を有効化すること。

---

### S-02: フロントエンド入力検証への依存 — サーバーサイド検証の欠如

**該当箇所:** §7.1 入力検証方針

**問題詳細:**

> フロントエンドで入力検証が完了した状態でAPIに送信される設計とする。バックエンドでは基本的な型チェック（JSONスキーマバリデーション）のみ実施する。

フロントエンド検証は攻撃者が容易にバイパスできる（curl, Burp Suite 等によるリクエスト直接送信）。「基本的な型チェック」がインジェクション攻撃（SQLインジェクション、NoSQLインジェクション、XSS ペイロード）を防止できるかが設計書に明記されていない。

**影響:** SQLi/XSS ペイロードがバックエンドに到達し、患者医療情報の漏洩・改ざんが発生する可能性。

**対策:**
- バックエンドで全入力値に対してホワイトリストベースのバリデーションを実施することを設計書に明記すること。
- ORM（Sequelize, Prisma 等）のパラメータ化クエリを必須化し、raw SQL の使用を禁止するポリシーを設計に含めること。
- XSS 対策として出力エスケープポリシー（Content-Security-Policy ヘッダー）を設計すること。

---

### S-03: CSRF 保護の欠如 — state-changing API への攻撃

**該当箇所:** §7.4 セッション系 API の保護

**問題詳細:**

> 医師による処方箋発行（`POST /api/v1/prescriptions`）や患者情報更新（`PUT /api/v1/patients/{id}`）などのstate-changingな操作に対するリクエスト保護の設計は現フェーズのスコープ外とする。

CSRF 保護の設計先送りは、医療行為に直結する操作（処方箋発行）が保護なしで設計される状態を意味する。

`Authorization: Bearer` ヘッダーで JWT を送信する場合、単純な CSRF（form-based）は防げるが、攻撃者が XSS を悪用して `localStorage` から JWT を取得した場合（C-03 参照）、CSRF 攻撃が成立する。

**影響:** 不正な処方箋発行、患者情報の改ざん。医療安全に直接影響する操作が攻撃対象となる。

**対策:**
- CSRF 保護を現フェーズのスコープに含めること。
- `SameSite=Strict` Cookie（C-03 対策と組み合わせ）または Double Submit Cookie パターンを採用すること。
- state-changing API ごとに CSRF 対策の適用を設計書に明記すること。

---

### S-04: ファイルアップロードの型・サイズ制限未定義

**該当箇所:** §7.2 ファイルアップロード

**問題詳細:**

> ファイル種別・サイズの制限は実装フェーズで決定する。

ウイルススキャンは設計されているが、ファイル種別・サイズの制限が未定義である。制限なしでは、悪意あるファイル（WebShell として機能する PHP ファイル、実行可能ファイル）のアップロードや、大容量ファイルによるストレージ枯渇（DoS）が可能となる。

**影響:** 不正ファイルによるサーバーサイド実行リスク（S3 からの直接 URL アクセスが可能な場合）、DoS。

**対策:**
- 許可ファイル種別（DICOM, JPEG, PNG, PDF 等）のホワイトリストを設計フェーズで確定し、設計書に記載すること。
- ファイルサイズ上限（例: 50MB/ファイル）を設計書に明記すること。
- S3 バケットの公開アクセスを禁止し、署名付き URL（pre-signed URL）経由のみでアクセスを許可すること。
- ファイル保存時にオリジナルファイル名・拡張子を破棄し、UUID ベースのファイル名に変換すること。

---

## MODERATE（中程度）

### M-01: 医療機密情報のアプリケーションレベル暗号化なし

**該当箇所:** §6.2 保存データの暗号化

**問題詳細:**

> 診断結果・処方内容などの医療機密情報については、アプリケーションレベルでの追加暗号化は行わず、RDS暗号化で十分と判断している。

RDS 暗号化（AES-256）はディスクレベルの暗号化であり、RDS インスタンスへの正規アクセス（DB 管理者、アプリケーション接続）に対しては平文でデータが見える。DB 管理者による内部不正、または RDS への不正アクセスが発生した場合、全患者の医療情報が平文で漏洩する。

**影響:** 内部不正者（DBA）または RDS 侵害時の全患者医療情報の漏洩。

**対策:**
- `diagnosis`, `soap_note`, `medications` 等の高感度フィールドにアプリケーションレベルの暗号化（AWS KMS を用いたフィールド暗号化）を検討すること。
- 少なくとも、医療機密フィールドへのアクセスポリシー（DB ユーザーの権限分離）を設計書に明記すること。

---

### M-02: 個人情報ログ出力をエンジニア判断に委任

**該当箇所:** §6.3 個人情報の取り扱い

**問題詳細:**

> 患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする。

医療システムにおける PII のログ出力ポリシーが個人の判断に依存しており、設計レベルでの制御がない。CloudWatch Logs にアクセス可能な者（運用担当者）が患者の個人情報を参照できる状態が生じる可能性がある。

**影響:** ログ経由での PII 漏洩、コンプライアンス違反（個人情報保護法、厚生労働省ガイドライン）。

**対策:**
- PII を含むデータ（氏名、生年月日、保険証番号、診断内容）のログ出力を禁止するポリシーを設計書に明記すること。
- ログの構造化（患者IDのみ記録し、PII は記録しない）を API 設計の標準として定義すること。
- CloudWatch Logs への IAM アクセス制限を設計に含めること。

---

### M-03: サードパーティ依存関係の脆弱性管理未定義

**該当箇所:** §8.2 サードパーティ依存関係

**問題詳細:**

> 脆弱性情報の定期チェック方針は今後の運用フェーズで策定する予定である。

Twilio Video SDK v2.27.0 等、バージョンが固定されたライブラリの脆弱性が発見された場合の対応フローが未定義である。医療システムの稼働期間中に脆弱性が発見される可能性は高く、対応計画なしでの稼働は容認できないリスクとなる。

**影響:** 既知の脆弱性を持つライブラリが本番稼働し続けるリスク。

**対策:**
- 設計フェーズで脆弱性スキャン（npm audit, Dependabot, Snyk 等）のポリシーを確定すること。
- CVSS スコアに基づく対応優先度（Critical: 即時対応、High: 2週間以内等）を設計書に記載すること。

---

### M-04: 監査ログの改ざん防止・保全設計の欠如

**該当箇所:** §8.3 監査ログ

**問題詳細:**

> ログには操作ユーザーID、操作種別、タイムスタンプを含める。

監査ログの保存先が CloudWatch Logs のみであり、ログの完全性（改ざん防止）、保持期間、医療ガイドラインへの対応が明記されていない。また、認証失敗・権限変更・機密データアクセスなどのセキュリティ上重要なイベントが監査対象として明示されていない。

**影響:** インシデント発生時の証跡不足、ガイドライン違反。

**対策:**
- 監査ログの保持期間を設計書に明記すること（最低5年以上、医療法施行規則に準拠）。
- 監査対象イベントを明示すること（認証失敗、ロール変更、患者データアクセス、処方箋発行等）。
- CloudTrail による API 操作ログとの統合、S3 + オブジェクトロックによる改ざん防止保管を設計すること。

---

### M-05: テナント分離の JWT 依存リスク

**該当箇所:** §3.2 マルチテナント設計

**問題詳細:**

> 各リクエストのテナント識別は、JWTトークンに含まれる `tenant_id` クレームに基づく。

JWT の `tenant_id` クレームを信頼してスキーマルーティングを行う設計は、JWT 署名検証の確実な実施が前提となる。JWT 検証をバイパスされた場合（アルゴリズム混乱攻撃: `alg: none`）、`tenant_id` を偽造することで別テナントの患者データにアクセスできる。また、サービス間通信での JWT 再検証ポリシーが明記されていない。

**影響:** テナント境界の突破による他医療機関の患者データへの不正アクセス。

**対策:**
- JWT 検証において `alg` ヘッダーを強制的に RS256/ES256 に固定し、`none` アルゴリズムを拒否することを設計書に明記すること。
- サービス間通信での tenant_id 検証ポリシーを明示すること。
- テナント間クエリをアプリケーション層で防止する Row Level Security（RLS）または追加チェックを設計に含めること。

---

## ポジティブな評価点

- bcrypt コスト係数12の採用は適切である（§5.1）。
- リフレッシュトークンの Redis 管理によるログアウト即時無効化は設計されている（§5.3）。
- AWS Secrets Manager によるシークレット管理は適切である（§8.1）。
- RDS Multi-AZ・S3 バージョニングによる可用性・データ保護の基盤は整っている（§9.3）。
- RDS・Redis をプライベートサブネットに配置するネットワーク分離は適切である（§8.4）。

---

## 優先対応ロードマップ

| 優先度 | 項目 | 該当 |
|--------|------|------|
| 即時（設計フェーズ内） | CORS ワイルドカード廃止 | C-01 |
| 即時（設計フェーズ内） | doctor の全患者アクセス制限 | C-02 |
| 即時（設計フェーズ内） | JWT ストレージを localStorage から変更 | C-03 |
| 即時（設計フェーズ内） | ログインエンドポイントへのレート制限設計 | C-04 |
| 実装フェーズ前 | VPC 内部通信の TLS 化 | S-01 |
| 実装フェーズ前 | サーバーサイド入力検証の明示 | S-02 |
| 実装フェーズ前 | CSRF 保護設計 | S-03 |
| 実装フェーズ前 | ファイルアップロード制限の確定 | S-04 |
