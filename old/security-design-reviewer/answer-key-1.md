# 正解キー

## 実行条件
- **観点**: セキュリティ（設計レビュー）
- **入力型**: 設計書
- **埋め込み問題数**: 10問

---

## 埋め込み問題一覧

### P01: JWTアクセストークンのlocalStorage保存
- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **検出難易度**: easy
- **該当箇所**: セクション5.1（認証フロー）手順4
- **問題の説明**: アクセストークンを `localStorage` に保存する設計となっている。XSS脆弱性が発生した場合、localStorage のトークンは悪意あるスクリプトから読み取り可能であり、セッションハイジャックにつながる。医療情報システムにおいては特に深刻なリスクである。httpOnly Cookie への変更が必要。
- **検出判定基準**:
  - ○: localStorage へのトークン保存のXSSリスクを明示し、httpOnly CookieやメモリのみへのAccessToken保存など代替手段に言及している
  - △: 関連するXSS・セッション管理の問題に言及はあるが、localStorage という具体的な保存方式のリスクに触れていない
  - ×: 認証フローの問題を未検出、またはトークン保存方式を問題なしと評価している

---

### P02: doctor ロールによるテナント横断患者データ参照
- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **検出難易度**: medium
- **該当箇所**: セクション5.2（認可モデル）後半
- **問題の説明**: doctor ロールが `patient_id` によるフィルタリングなしに patient-service 全患者データを参照できる設計となっている。担当患者以外の医療記録への無制限アクセスを許容しており、プライバシー違反・情報漏洩リスクがある。担当医師と患者の紐付け（リレーション）による認可チェックが必要。
- **検出判定基準**:
  - ○: doctor ロールが患者との紐付けなく全患者データにアクセスできる問題を指摘し、属性ベース（ABAC）またはリレーション紐付けによる制御を提案している
  - △: RBACの認可設計に課題があると言及しているが、doctor の横断アクセス問題を具体的に指摘していない
  - ×: 認可モデルを適切と評価している、または問題を検出していない

---

### P03: VPC内部通信の平文化
- **カテゴリ**: データ保護
- **深刻度**: 中
- **検出難易度**: medium
- **該当箇所**: セクション6.1（通信の暗号化）
- **問題の説明**: 「VPC 内部の通信については内部ネットワークであるため平文で行う」と明記されている。電子カルテ・処方箋等の高度機密医療情報がサービス間通信で平文伝送される設計であり、VPC内への侵入時や内部脅威（Insider Threat）が発生した際に情報漏洩リスクがある。サービスメッシュ（TLS）や相互TLS（mTLS）の適用を検討すべき。
- **検出判定基準**:
  - ○: VPC内部通信の平文化を明示的に問題として指摘し、内部TLSまたはmTLSの必要性を述べている
  - △: 暗号化の範囲について懸念を示しているが、VPC内部通信の平文化を具体的に指摘していない
  - ×: 「VPC内部は安全」として問題視していない、または未検出

---

### P04: 個人情報ログ出力方針の未定義
- **カテゴリ**: データ保護
- **深刻度**: 軽微
- **検出難易度**: medium
- **該当箇所**: セクション6.3（個人情報の取り扱い）
- **問題の説明**: 「患者情報（PII）を含むログ出力については、エンジニアの判断に委ねる運用とする」と記載されており、PIIのログ出力方針が未定義である。医療情報システムでは患者氏名・診断内容・保険証番号などの高度PII が誤ってログに出力されるリスクがあるが、ログ閲覧者は権限保有者に限られるため直接的なリスクは低い。改善としてマスキング・サニタイゼーション方針の設計が望ましい。
- **検出判定基準**:
  - ○: PIIログ出力方針がエンジニア任せであることを問題として指摘し、マスキング方針や出力禁止フィールドの定義を求めている
  - △: ログ設計に関する懸念を述べているが、PII含有ログの未定義方針を具体的に指摘していない
  - ×: ログ設計をスコープ外として扱っている、または問題なしと評価している

---

### P05: CORSワイルドカード設定（本番環境適用）
- **カテゴリ**: 入力検証・攻撃防御
- **深刻度**: 中
- **検出難易度**: easy
- **該当箇所**: セクション7.3（CORS設定）
- **問題の説明**: API Gateway の CORS 設定に `Access-Control-Allow-Origin: *` を設定し、「本番環境では必要に応じて絞り込みを検討する」と記載されている。ワイルドカード設定のまま本番リリースされるリスクがある。悪意あるオリジンからのクロスサイトリクエストが許可される状態であり、医療情報へのアクセスが可能になる危険性がある。
- **検出判定基準**:
  - ○: CORSワイルドカード設定のリスクを明示し、本番環境での許可オリジン明示設定の必要性を指摘している
  - △: CORS設定に言及はあるが、ワイルドカード設定の危険性または本番未確定状態の問題を具体的に指摘していない
  - ×: CORS設定を問題なしと評価している、または未検出

---

### P06: state-changing APIへのCSRF対策未設計
- **カテゴリ**: 入力検証・攻撃防御
- **深刻度**: 中
- **検出難易度**: medium
- **該当箇所**: セクション7.4（セッション系 API の保護）
- **問題の説明**: 処方箋発行・患者情報更新などのstate-changing操作に対するリクエスト保護（CSRF対策）が「現フェーズのスコープ外」とされている。医療情報システムにおいてCSRF脆弱性は、悪意あるサイトからの不正な処方箋発行等を引き起こす可能性があり、設計段階での対策設計が必須である。
- **検出判定基準**:
  - ○: CSRF対策がスコープ外とされていることを重大な設計上の欠陥として指摘し、CSRFトークンまたはSameSite Cookie等の対策設計を要求している
  - △: state-changing APIの保護に懸念を示しているが、CSRFというカテゴリを明示していない
  - ×: スコープ外の判断を妥当と評価している、または未検出

---

### P07: 認証エンドポイントへのレート制限未設計
- **カテゴリ**: 脅威モデリング（DoS/ブルートフォース）
- **深刻度**: 中
- **検出難易度**: easy
- **該当箇所**: セクション8.5（認証エンドポイント保護）
- **問題の説明**: `/api/v1/auth/login` エンドポイントに「高可用性を優先するため呼び出し制限は設けない設計」とされている。ブルートフォース攻撃やクレデンシャルスタッフィング攻撃に対して無防備であり、医療情報システムの認証が突破されるリスクがある。レート制限・アカウントロックアウト・CAPTCHA等の設計が必要。
- **検出判定基準**:
  - ○: 認証エンドポイントのレート制限未設計をブルートフォース攻撃リスクとして指摘し、具体的な対策（レート制限、アカウントロック等）を求めている
  - △: 認証保護に懸念を示しているが、ブルートフォース攻撃またはレート制限の欠如を具体的に指摘していない
  - ×: 高可用性優先の判断を妥当と評価している、または未検出

---

### P08: セキュリティ監査ログの欠如
- **カテゴリ**: インフラ・依存関係・監査
- **深刻度**: 軽微
- **検出難易度**: hard
- **該当箇所**: セクション8.3（監査ログ）
- **問題の説明**: 「操作ユーザーID、操作種別、タイムスタンプ」を記録するとしているが、セキュリティ監査ログとして必須の認証失敗・権限変更・機密データアクセスの特定記録設計が明記されていない。一般的なアプリケーションログと区別されたセキュリティ監査ログの設計が医療情報システムでは望ましいが、現時点での直接的なリスクは限定的である。
- **検出判定基準**:
  - ○: 一般ログとセキュリティ監査ログが区別されていない問題を指摘し、認証失敗・機密データアクセス・権限変更等のセキュリティイベント記録設計の必要性を述べている
  - △: 監査ログに言及があるが、セキュリティイベント特有の記録要件（認証失敗等）への言及がない
  - ×: 監査ログ設計を十分と評価している、または未検出

---

### P09: バックエンド入力検証の省略
- **カテゴリ**: 入力検証・攻撃防御
- **深刻度**: 重大
- **検出難易度**: medium
- **該当箇所**: セクション7.1（入力検証方針）
- **問題の説明**: 「フロントエンドで入力検証が完了した状態でAPIに送信される設計とする。バックエンドでは基本的な型チェックのみ実施する」と記載されている。フロントエンドのバリデーションはクライアント側で容易にバイパス可能であり、SQLインジェクション・コマンドインジェクション・XSS等への対策がバックエンドに存在しない設計となっている。フロントエンドへの過剰な信頼であり、バックエンドでの入力検証設計が必要。
- **検出判定基準**:
  - ○: フロントエンド検証依存をセキュリティ上の欠陥（フロントエンドバイパス、インジェクション攻撃リスク）として指摘し、バックエンドでの独立した入力検証設計を求めている
  - △: 入力検証に懸念を示しているが、フロントエンド検証への依存という根本問題を明示していない
  - ×: フロントエンド検証で十分と評価している、または未検出

---

### P10: 依存ライブラリの脆弱性管理方針の未確立
- **カテゴリ**: インフラ・依存関係・監査
- **深刻度**: 軽微
- **検出難易度**: hard
- **該当箇所**: セクション8.2（サードパーティ依存関係）+ セクション2.2（Twilio Video SDK v2.27.0）
- **問題の説明**: 「開発時点でのバージョンを固定する」とし、「脆弱性情報の定期チェック方針は今後の運用フェーズで策定予定」とされている。Twilio Video SDK v2.27.0 のような具体的バージョン固定が行われる一方で、脆弱性スキャン（Dependabot・OWASP Dependency-Check 等）の継続的実施方針が設計段階で欠如している。医療情報システムでは既知CVEを持つライブラリの継続使用が重大リスクとなる。
- **検出判定基準**:
  - ○: 脆弱性管理方針が「運用フェーズで策定」に先送りされていることを問題として指摘し、設計段階での定義（自動スキャン、更新ポリシー等）を求めている
  - △: ライブラリ管理や依存関係リスクに言及はあるが、設計段階での方針未確立という問題を具体的に指摘していない
  - ×: バージョン固定を十分な対策として評価している、または未検出

---

## ボーナス問題リスト

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | データ保護 | PIIデータ削除方針の不完全性（「今後のフェーズで定義」と先送りされている） | 患者データの削除権（忘れられる権利）や保持期間終了後の安全削除手順の設計が必要と指摘した場合 |
| B02 | 脅威モデリング（Repudiation） | 否認防止設計の欠如（処方箋発行・医師サイン等の不可否認性の担保が設計されていない） | 医療行為の否認防止（デジタル署名・改ざん不可の監査証跡）の必要性を指摘した場合 |
| B03 | 認証・認可設計 | リフレッシュトークンのユーザーIDキー保管リスク（Redisキー衝突またはキー予測可能性） | リフレッシュトークンをユーザーIDキーで単一値保存すると複数デバイスでのセッション管理が困難で、強制無効化の粒度が粗い問題を指摘した場合 |
| B04 | インフラ・依存関係・監査 | アプリケーションレベル暗号化の欠如（医療機密情報がRDS暗号化のみ） | アプリケーションレベルでのフィールド暗号化（特に診断結果・処方内容等の高感度フィールド）の設計がないことを指摘した場合 |
| B05 | 入力検証・攻撃防御 | ファイルアップロードのファイル種別・サイズ制限が未設計 | 「実装フェーズで決定」とされているファイル制限の設計段階での未定義を指摘した場合 |
