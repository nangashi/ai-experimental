# 正解キー

## 実行条件
- **観点**: reliability
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: サーキットブレーカーのフォールバック戦略が不明確
- **カテゴリ**: 障害回復設計
- **深刻度**: 重大
- **該当箇所**: セクション6「エラーハンドリング方針」
- **問題の説明**: 外部API障害時に「代替プロバイダーへフォールバック（可能な場合）」と記載されているが、フォールバック条件（何を持って「可能」と判断するか）、代替プロバイダーの選定ロジック、代替先も利用不可の場合の最終的なフォールバック戦略（部分応答返却、エラー返却、キャッシュ応答等）が未定義。全プロバイダー障害時のグレースフルデグラデーション戦略がないと、ユーザー体験が著しく低下する。
- **検出判定基準**:
  - ○（検出）: フォールバック条件の曖昧さ、または全プロバイダー障害時の最終的なフォールバック戦略（キャッシュ応答、エラーメッセージ、機能縮退等）の欠如を明確に指摘している
  - △（部分検出）: サーキットブレーカーの必要性やフォールバック戦略に言及しているが、条件の曖昧さや全障害時の最終戦略について具体的な指摘がない
  - ×（未検出）: フォールバック戦略について言及なし

### P02: 予約確定フローにおけるトランザクション整合性が未保証
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 重大
- **該当箇所**: セクション3「データフロー」、セクション5「POST /api/v1/bookings/{id}/confirm」
- **問題の説明**: 予約確定フロー（決済成功 → PostgreSQL更新 → Kafkaイベント発行）において、決済成功後のPostgreSQL更新失敗、またはKafkaイベント発行失敗時のロールバック戦略が未定義。決済が成功したにも関わらず予約がCONFIRMEDにならない、あるいはItinerary Serviceに通知されない場合、ユーザーは決済済みだが旅程が作成されない状態になる。分散トランザクションの整合性保証（Sagaパターン、補償トランザクション等）が必要。
- **検出判定基準**:
  - ○（検出）: 決済成功後のPostgreSQL更新失敗またはKafkaイベント発行失敗時の整合性問題、または分散トランザクションの補償戦略の欠如を明確に指摘している
  - △（部分検出）: トランザクション整合性やSagaパターンの必要性に言及しているが、決済と予約状態の不整合リスクについて具体的な指摘がない
  - ×（未検出）: 分散トランザクション整合性について言及なし

### P03: 決済リトライのべき等性が未設計
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 重大
- **該当箇所**: セクション5「POST /api/v1/payments」、セクション6「エラーハンドリング方針」
- **問題の説明**: 決済実行（POST /api/v1/payments）においてStripe API呼び出しが成功したが、レスポンスの受信前にネットワーク障害やタイムアウトが発生した場合、クライアントは決済成功を確認できず再試行する可能性がある。しかし、べき等キー（Idempotency Key）の使用が明記されていないため、同一決済が重複実行されるリスクがある。Stripe APIはべき等性をサポートしているが、設計書に実装方針が記載されていない。
- **検出判定基準**:
  - ○（検出）: 決済リトライ時の重複実行リスク、またはべき等キー（Idempotency Key）の未使用を明確に指摘している
  - △（部分検出）: 決済のべき等性やリトライ戦略に言及しているが、具体的な重複決済リスクやべき等キーの必要性について明示的な指摘がない
  - ×（未検出）: 決済のべき等性について言及なし

### P04: 外部プロバイダーAPIのタイムアウト設定が不十分
- **カテ�ゴリ**: 障害回復設計
- **深刻度**: 中
- **該当箇所**: セクション5「POST /api/v1/search」、セクション7「パフォーマンス目標」
- **問題の説明**: 検索API全体のタイムアウトは30秒と定義されているが、個々の外部プロバイダーAPI（Amadeus, Expedia等）に対する接続タイムアウト、読み取りタイムアウト、リトライポリシーが未定義。「5秒でタイムアウト」の記載はあるが、接続確立時間と読み取り時間の内訳、リトライ回数とバックオフ戦略が不明。1プロバイダーの遅延が全体の検索時間に影響する設計では、ユーザー体験が低下する。
- **検出判定基準**:
  - ○（検出）: 個々の外部APIへの接続/読み取りタイムアウトの未定義、またはリトライポリシー（回数、バックオフ）の欠如を明確に指摘している
  - △（部分検出）: タイムアウト設定の必要性やリトライ戦略に言及しているが、接続/読み取りの内訳やバックオフ戦略の具体性について指摘がない
  - ×（未検出）: 外部APIタイムアウト設計について言及なし

### P05: Kafkaイベント消費の障害回復戦略が未定義
- **カテゴリ**: 障害回復設計
- **深刻度**: 中
- **該当箇所**: セクション3「データフロー」
- **問題の説明**: Itinerary ServiceがKafkaイベント（BookingConfirmed, FlightDelayed）を消費する際の障害回復戦略が未定義。イベント処理中のItinerary Service障害、Notification Service呼び出し失敗時のリトライ戦略、DLQ（Dead Letter Queue）設計、処理済みイベントの重複検出メカニズムが記載されていない。イベント消費失敗時にユーザーが確認メールを受信できない、または重複受信する可能性がある。
- **検出判定基準**:
  - ○（検出）: Kafkaイベント消費失敗時のリトライ戦略、DLQの欠如、または重複イベント処理のリスクを明確に指摘している
  - △（部分検出）: イベント処理の信頼性やリトライに言及しているが、DLQや重複検出について具体的な指摘がない
  - ×（未検出）: Kafkaイベント消費の障害回復について言及なし

### P06: RDS Multi-AZフェイルオーバー時のアプリケーション側対応が未定義
- **カテ�ゴリ**: 可用性・冗長性・災害復旧
- **深刻度**: 中
- **該当箇所**: セクション7「可用性・スケーラビリティ」
- **問題の説明**: RDS Multi-AZ構成で自動フェイルオーバー（60秒以内）が有効だが、フェイルオーバー中の接続エラーに対するアプリケーション側の対応が未定義。フェイルオーバー中はDNS切り替えが発生し、一時的に接続が失敗するため、アプリケーションは接続リトライロジック（エクスポネンシャルバックオフ、最大リトライ回数）を実装する必要がある。また、フェイルオーバー前に実行中だったトランザクションのロールバック処理が必要。
- **検出判定基準**:
  - ○（検出）: RDSフェイルオーバー時のアプリケーション側接続リトライ、または実行中トランザクションの整合性対応の欠如を明確に指摘している
  - △（部分検出）: データベースフェイルオーバーやリトライに言及しているが、アプリケーション側の具体的な対応（接続リトライ、トランザクション整合性）について明示的な指摘がない
  - ×（未検出）: RDSフェイルオーバーへの対応について言及なし

### P07: バックグラウンドジョブ（フライトステータスポーリング）の障害回復が未設計
- **カテゴリ**: 障害回復設計
- **深刻度**: 中
- **該当箇所**: セクション3「フライト遅延対応フロー」
- **問題の説明**: バックグラウンドジョブ（5分間隔でAmadeus Flight Status APIをポーリング）の障害回復設計が未定義。ジョブ実行中の障害（API呼び出し失敗、処理中のサービスクラッシュ等）時の再試行ロジック、処理済みフライトの追跡（重複チェック）、ジョブ実行の冪等性保証が記載されていない。ジョブが失敗した場合、遅延通知がユーザーに届かず、顧客体験が低下する。
- **検出判定基準**:
  - ○（検出）: バックグラウンドジョブの障害時リトライ戦略、重複処理防止、または冪等性設計の欠如を明確に指摘している
  - △（部分検出）: バックグラウンドジョブの信頼性や監視に言及しているが、リトライ戦略や冪等性について具体的な指摘がない
  - ×（未検出）: バックグラウンドジョブの障害回復について言及なし

### P08: SLO監視に対応するアラート戦略の詳細が不足
- **カテゴリ**: 監視・アラート設計
- **深刻度**: 軽微
- **該当箇所**: セクション7「監視・アラート」
- **問題の説明**: SLO（API可用性 > 99.9%, p95レイテンシ < 500ms, 決済成功率 > 99%）が定義されているが、これらをどのように測定し、閾値違反時にどうアラートするかの詳細が不足。例えば「API可用性 > 99.9%」を達成するためには、エラー率の時系列監視とバーンレート（SLO消費速度）ベースのアラート設定が推奨されるが、設計書には「エラー率 > 5%」の単純な閾値アラートのみ記載。SLOベースのアラート戦略（error budget、multi-window multi-burn-rate等）が未設計。
- **検出判定基準**:
  - ○（検出）: SLOに基づくアラート戦略の不足、またはエラーバジェット/バーンレートベースの監視の欠如を明確に指摘している
  - △（部分検出）: SLO監視やアラートに言及しているが、バーンレートやエラーバジェットの具体的な戦略について指摘がない
  - ×（未検出）: SLOアラート戦略について言及なし

### P09: データベースマイグレーションのロールバック互換性が未考慮
- **カテ�ゴリ**: デプロイ・ロールバック
- **深刻度**: 軽微
- **該当箇所**: セクション6「デプロイメント方針」
- **問題の説明**: Blue-Greenデプロイメントでロールバック可能とあるが、データベーススキーマ変更（Flywayマイグレーション）のロールバック互換性が未考慮。新バージョンがカラム追加した後に旧バージョンにロールバックする場合、旧バージョンのコードが新カラムを認識せずエラーになるリスクがある。Expand-Contractパターン（新カラムをNULL許容で追加→新バージョンデプロイ→旧バージョン廃止後に制約強化）のような後方互換性を保つマイグレーション戦略が必要。
- **検出判定基準**:
  - ○（検出）: データベースマイグレーションのロールバック互換性、またはExpand-Contractパターンの欠如を明確に指摘している
  - △（部分検出）: スキーマ変更の影響やマイグレーション戦略に言及しているが、ロールバック互換性について具体的な指摘がない
  - ×（未検出）: マイグレーションのロールバック互換性について言及なし

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 可用性・冗長性 | MongoDB (DocumentDB) の冗長性設計が未記載（シングルノード構成ではSPOFになる） | DocumentDB/MongoDBの冗長性設計（レプリカセット、クラスター構成）の欠如を指摘している |
| B02 | 監視・アラート | 外部プロバイダーAPI障害の検知と運用対応手順（ランブック、エスカレーションパス）が未定義 | 外部API障害時のインシデント対応手順やランブックの欠如を指摘している |
| B03 | 障害回復設計 | Redis (ElastiCache) クラスターのフェイルオーバー時のセッション喪失リスク | Redisクラスターのフェイルオーバーによるセッション喪失または再接続戦略の欠如を指摘している |
| B04 | データ整合性 | 検索結果キャッシュ（MongoDB, 30分TTL）と実際の在庫の不整合リスク | キャッシュTTL中の在庫変動による予約失敗リスク、またはキャッシュ無効化戦略の欠如を指摘している |
| B05 | デプロイ・ロールバック | Blue-Greenデプロイメント中の新旧バージョン間のKafkaイベントスキーマ互換性が未考慮 | Kafkaイベントスキーマの前方/後方互換性、またはスキーマレジストリの必要性を指摘している |
| B06 | 可用性・冗長性 | ECS Auto Scalingのスケールアウト速度と突発的なトラフィック増加への対応 | Auto Scalingの反応速度の遅さ、またはウォームアップ時間による一時的な過負荷リスクを指摘している |
| B07 | 監視・アラート | 決済成功率のSLO（> 99%）に対する測定方法とアラート基準が曖昧 | 決済成功率の計算方法（分母にタイムアウトを含めるか等）の明確化、またはアラート閾値の具体化が必要と指摘している |
| B08 | 障害回復設計 | Kafka プロデューサーの送信失敗時のリトライ設定とアプリケーション側のエラーハンドリング | Kafkaプロデューサーのacks設定、リトライ回数、送信失敗時の補償処理の欠如を指摘している |
| B09 | データ整合性 | 予約の自動キャンセル（30分後）とバッチ処理の冪等性、障害時の再実行戦略 | バッチ処理の冪等性設計、または処理済み予約の重複キャンセル防止策の欠如を指摘している |
| B10 | 可用性・冗長性 | 関連予約の整合性チェック（ホテルチェックイン日 < フライト到着日）における分散トランザクションの実現方法 | 複数予約間の整合性制約を分散環境でどう保証するか（eventual consistency, Saga等）の戦略が未定義と指摘している |
