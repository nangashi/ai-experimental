# 正解キー - Round 004

## 実行条件
- **観点**: reliability
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: プロバイダーAPI呼び出しのサーキットブレーカー欠如
- **カテゴリ**: 障害回復設計
- **深刻度**: 重大
- **該当箇所**: セクション7.4（障害回復設計）
- **問題の説明**: 外部プロバイダーAPI呼び出しにリトライ処理は実装されているが、サーキットブレーカーパターンが欠如している。プロバイダー側の障害が長期化した場合、リトライによりシステム全体のスレッドプールが枯渇し、他の正常なプロバイダーへのリクエストも処理できなくなるカスケード障害のリスクがある。
- **検出判定基準**:
  - ○（検出）: プロバイダーAPI呼び出しにサーキットブレーカーの欠如を指摘し、カスケード障害やスレッドプール枯渇のリスクに言及している
  - △（部分検出）: リトライ処理の存在を確認しているが、サーキットブレーカーの必要性には言及していない、または障害分離の観点から一般的な指摘にとどまる
  - ×（未検出）: 指摘なし

### P02: トランザクション境界の不明確さ（決済-Webhook通知の整合性）
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 重大
- **該当箇所**: セクション3.3（データフロー）、セクション6.1（エラーハンドリング方針）
- **問題の説明**: トランザクションステータス更新と加盟店へのWebhook通知の間にトランザクション境界が明示されていない。ステータス更新後、Webhook送信前にシステム障害が発生した場合、トランザクションは完了しているが加盟店が通知を受け取れないという不整合が発生する。また、Webhook送信の失敗時のリトライ戦略も未定義。
- **検出判定基準**:
  - ○（検出）: トランザクションステータス更新とWebhook通知の境界が不明確であることを指摘し、失敗時のリトライ戦略や補償トランザクション（Outbox Pattern等）の必要性に言及している
  - △（部分検出）: Webhook送信の失敗ハンドリングの欠如を指摘しているが、トランザクション境界の整合性問題には触れていない
  - ×（未検出）: 指摘なし

### P03: 返金処理のべき等性保証欠如
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 重大
- **該当箇所**: セクション5.1（エンドポイント一覧）、セクション7.6（データ整合性設計）
- **問題の説明**: 返金APIのリクエストが重複送信された場合のべき等性保証が設計されていない。ネットワークタイムアウト後のリトライにより、同一金額の返金が複数回実行されるリスクがある。べき等キー（idempotency key）の導入や返金リクエストの重複検出メカニズムが必要。
- **検出判定基準**:
  - ○（検出）: 返金API（POST /v1/payments/{transaction_id}/refund）のべき等性欠如を指摘し、重複返金のリスクやidempotency keyの必要性に言及している
  - △（部分検出）: 返金処理の重複チェック（金額検証）について言及しているが、べき等性の観点からの設計欠如には触れていない
  - ×（未検出）: 指摘なし

### P04: 分散環境でのトランザクション整合性保証の欠如
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 中
- **該当箇所**: セクション3.3（データフロー）、セクション7.6（データ整合性設計）
- **問題の説明**: データフローのステップ2-6において、PostgreSQLへのトランザクションレコード作成、プロバイダーAPI呼び出し、Webhook送信の各ステップが独立しており、分散トランザクションの整合性保証が設計されていない。Sagaパターンや補償トランザクションの導入が必要。PostgreSQLのACID特性のみでは、外部API呼び出しを含むフロー全体の整合性は保証できない。
- **検出判定基準**:
  - ○（検出）: PostgreSQL内部トランザクションとプロバイダーAPI呼び出し・Webhook送信を含む分散処理全体の整合性保証が欠如していることを指摘し、Sagaパターンや補償トランザクションの必要性に言及している
  - △（部分検出）: 外部API呼び出しの失敗時のロールバック戦略について一般的な指摘はあるが、分散トランザクション全体の整合性保証メカニズムの欠如には触れていない
  - ×（未検出）: 指摘なし

### P05: プロバイダー別タイムアウト設計の未定義
- **カテゴリ**: 障害回復設計
- **深刻度**: 中
- **該当箇所**: セクション7.4（障害回復設計）
- **問題の説明**: 「タイムアウトは、プロバイダーごとに異なる値を設定する予定だが、具体的な値は実装フェーズで決定する」という記述があり、設計時点でタイムアウト値が未定義。プロバイダーのSLA（Stripe: 95th percentile < 500ms、PayPal: 平均応答時間1-2秒等）を考慮した具体的なタイムアウト値を設計段階で定義すべき。
- **検出判定基準**:
  - ○（検出）: プロバイダー別のタイムアウト値が未定義であることを指摘し、各プロバイダーのSLA/応答時間特性に基づく具体的な値の設計必要性に言及している
  - △（部分検出）: タイムアウト設計の重要性には言及しているが、プロバイダー別の具体的な値の定義欠如には触れていない
  - ×（未検出）: 指摘なし

### P06: 日次バッチ処理の中断・再開設計欠如
- **カテゴリ**: 可用性・冗長性・災害復旧
- **深刻度**: 中
- **該当箇所**: セクション7.7（バッチ処理設計）
- **問題の説明**: 日次決済確定バッチは「処理中に障害が発生した場合は、アラートを発報し、翌朝手動でリカバリを行う」とあり、自動リカバリ機能が欠如している。大量データ処理中の障害では、チェックポイント機構を導入し、処理済みレコードをスキップして再実行する設計が必要。また、処理時間の見積もりとタイムアウト設定も未定義。
- **検出判定基準**:
  - ○（検出）: バッチ処理の中断・再開設計（チェックポイント、処理済みレコードのスキップ等）の欠如を指摘し、手動リカバリの運用負荷やデータ整合性リスクに言及している
  - △（部分検出）: バッチ処理の障害ハンドリング不足を一般的に指摘しているが、具体的な中断・再開メカニズムの必要性には触れていない
  - ×（未検出）: 指摘なし

### P07: SLO/SLA定義と監視の不整合
- **カテゴリ**: 監視・アラート設計
- **深刻度**: 中
- **該当箇所**: セクション7.1（パフォーマンス目標）、セクション7.3（可用性・スケーラビリティ）、セクション7.5（監視・アラート設計）
- **問題の説明**: 可用性目標（99.9%）、API応答時間（p95 < 500ms）、スループット（1000 TPS）といったSLO/SLAが定義されているが、セクション7.5の監視設計にこれらのSLOを追跡するメトリクスやアラート閾値の設計が欠如している。また、SLOに対するアラートルールやエスカレーション手順が未定義。
- **検出判定基準**:
  - ○（検出）: 定義済みSLO（可用性99.9%、p95 < 500ms、1000 TPS）に対応する監視・アラート設計が欠如していることを指摘し、SLOベースのアラート閾値やエスカレーション手順の必要性に言及している
  - △（部分検出）: 監視項目が不足していることを一般的に指摘しているが、SLO定義との整合性やSLOベースのアラート設計の欠如には触れていない
  - ×（未検出）: 指摘なし

### P08: デプロイ時のデータベーススキーマ変更の後方互換性欠如
- **カテゴリ**: デプロイ・ロールバック
- **深刻度**: 軽微
- **該当箇所**: セクション6.4（デプロイメント方針）
- **問題の説明**: ローリングアップデート時のデータベーススキーマ変更の後方互換性戦略が未定義。新旧バージョンのPodが同時稼働する期間に、スキーマ変更（カラム追加・削除、型変更等）を行う場合、旧バージョンとの互換性が必要だが、その戦略（expand-contract パターン等）が設計されていない。
- **検出判定基準**:
  - ○（検出）: ローリングアップデート中のスキーマ変更の後方互換性問題を指摘し、expand-contractパターンや段階的マイグレーション戦略の必要性に言及している
  - △（部分検出）: デプロイ時のデータベース変更のリスクに一般的に言及しているが、ローリングアップデート中の互換性問題には触れていない
  - ×（未検出）: 指摘なし

### P09: ヘルスチェックエンドポイントの設計欠如
- **カテゴリ**: 監視・アラート設計
- **深刻度**: 軽微
- **該当箇所**: セクション5.1（エンドポイント一覧）
- **問題の説明**: Kubernetes環境でのliveness/readiness probeに使用するヘルスチェックエンドポイントが設計されていない。データベース接続、Redis接続、外部プロバイダーAPI到達性を確認するヘルスチェックが必要。特にreadinessプローブがない場合、起動途中のPodにトラフィックが流れ、エラーが増加するリスクがある。
- **検出判定基準**:
  - ○（検出）: Kubernetesのliveness/readinessプローブ用のヘルスチェックエンドポイントの欠如を指摘し、依存リソース（DB、Redis、外部API）の確認必要性に言及している
  - △（部分検出）: ヘルスチェックの必要性を一般的に指摘しているが、Kubernetesプローブや起動時のトラフィック制御には触れていない
  - ×（未検出）: 指摘なし

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 障害回復設計 | Redis障害時のレート制限機能のフォールバック戦略欠如（Redis障害時にレート制限を無効化するか、デフォルト制限値を適用するか） | Redis障害時のレート制限の挙動について具体的に指摘している |
| B02 | 可用性・冗長性・災害復旧 | Cloud SQLのフェイルオーバー時のアプリケーション側の再接続戦略・接続プールの設定が未定義 | マネージドサービスのフェイルオーバー時のアプリケーション側対応を指摘している |
| B03 | 監視・アラート設計 | 決済プロバイダーとの通信における分散トレーシング（correlation_id の伝播）設計の欠如 | 分散トレーシングやcorrelation_idの外部API呼び出しへの伝播を指摘している |
| B04 | データ整合性・べき等性 | Webhook受信エンドポイント（POST /webhooks/providers/{provider}）の重複受信対策（プロバイダーからの同一イベントの複数回送信）が未設計 | Webhook受信のべき等性や重複検出を指摘している |
| B05 | デプロイ・ロールバック | ロールバック時の手順・判断基準（何を持って失敗とするか、ロールバック判断の自動化）が未定義 | ロールバック手順の具体性や自動化について指摘している |
