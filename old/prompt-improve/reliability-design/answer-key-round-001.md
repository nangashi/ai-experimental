# 正解キー

## 実行条件
- **観点**: reliability
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: 外部サービス呼び出しの障害回復設計が未定義
- **カテゴリ**: 障害回復設計
- **深刻度**: 重大
- **該当箇所**: セクション3（アーキテクチャ設計）、Notification Service の外部サービス連携（FCM、SendGrid）
- **問題の説明**: Notification Service が外部サービス（FCM、SendGrid）に依存しているが、これらのサービスが一時的に利用不可になった場合の対策が設計されていない。サーキットブレーカー、リトライ戦略、タイムアウト設定のいずれも言及がなく、外部サービスの障害が通知機能全体の停止につながる可能性がある。
- **検出判定基準**:
  - ○（検出）: 外部サービス（FCM/SendGrid）呼び出しに対してサーキットブレーカー、リトライ戦略、またはタイムアウト設計の欠如を指摘している
  - △（部分検出）: 外部サービス連携に関する懸念に言及しているが、具体的な障害回復メカニズム（サーキットブレーカー、リトライ、タイムアウト）には触れていない
  - ×（未検出）: 外部サービス連携の障害回復について指摘がない

### P02: WebSocket接続の障害回復とタイムアウト設計が未定義
- **カテゴリ**: 障害回復設計
- **深刻度**: 重大
- **該当箇所**: セクション3（アーキテクチャ設計）、Message Service の WebSocket 接続管理
- **問題の説明**: 最大50,000同時接続を想定しているが、WebSocket接続の切断時の自動再接続戦略、接続タイムアウト、Ping/Pongによるコネクション維持設計が記載されていない。ネットワーク一時断やロードバランサーのタイムアウトによって大量の接続が失われるリスクがある。
- **検出判定基準**:
  - ○（検出）: WebSocket接続の切断時の再接続戦略、接続タイムアウト、またはPing/Pongメカニズムの欠如を指摘している
  - △（部分検出）: WebSocket接続の安定性に関する懸念を示しているが、具体的な再接続・タイムアウト設計には触れていない
  - ×（未検出）: WebSocket接続の障害回復について指摘がない

### P03: メッセージ配信のべき等性設計が未定義
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 重大
- **該当箇所**: セクション3（データフロー）、メッセージ送信フロー
- **問題の説明**: メッセージ送信フローにおいて、ネットワーク障害や再送時に同一メッセージが重複保存・重複配信される可能性がある。MongoDB保存とRedis Pub/Subの間で障害が発生した場合、整合性が失われる。メッセージIDによる重複検出や冪等キーの設計が必要だが、記載がない。
- **検出判定基準**:
  - ○（検出）: メッセージ送信・保存処理のべき等性欠如、または重複検出メカニズムの欠如を指摘している
  - △（部分検出）: メッセージの重複配信リスクに言及しているが、べき等性設計や重複検出メカニズムには触れていない
  - ×（未検出）: メッセージ配信のべき等性について指摘がない

### P04: データベース間の整合性保証戦略が未設計
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 中
- **該当箇所**: セクション3（データフロー）、セクション4（データモデル）
- **問題の説明**: PostgreSQL（メタデータ）とMongoDB（メッセージ履歴）の2つのデータベースを使用しているが、これらの間の整合性保証戦略が設計されていない。例えば、チャンネル削除時にPostgreSQLのchannelsテーブルは削除されるが、MongoDBのmessagesコレクションの該当データが残る可能性がある。分散トランザクションやSagaパターンなどの整合性保証メカニズムが必要。
- **検出判定基準**:
  - ○（検出）: PostgreSQLとMongoDB間のデータ整合性保証戦略の欠如を指摘している（分散トランザクション、Saga、イベントソーシング等への言及を含む）
  - △（部分検出）: 複数データベース利用時の整合性に懸念を示しているが、具体的な整合性保証メカニズムには触れていない
  - ×（未検出）: データベース間整合性について指摘がない

### P05: Redis Pub/Subの単一障害点と可用性設計が未対策
- **カテゴリ**: 可用性・冗長性・災害復旧
- **深刻度**: 中
- **該当箇所**: セクション3（データフロー）、Redis Pub/Sub の利用
- **問題の説明**: メッセージ配信の中核として Redis Pub/Sub を使用しているが、Redisノードの障害時のフェイルオーバー設計やメッセージ配信の継続性について言及がない。Redis クラスタモードの記載はあるが、Pub/Sub はクラスタモードでの動作に制限があり、単一障害点となる可能性がある。WebSocketセッションの再接続やメッセージ再配信の設計も不足している。
- **検出判定基準**:
  - ○（検出）: Redis Pub/Sub の単一障害点リスク、またはRedis障害時のメッセージ配信継続性について指摘している
  - △（部分検出）: Redisの可用性に関する懸念を示しているが、Pub/Sub特有の制約やメッセージ配信継続性には触れていない
  - ×（未検出）: Redis Pub/Sub の障害時設計について指摘がない

### P06: 監視・アラート設計とSLO/SLAの対応が不十分
- **カテゴリ**: 監視・アラート設計
- **深刻度**: 中
- **該当箇所**: セクション7（非機能要件）、可用性・スケーラビリティ
- **問題の説明**: 目標稼働率99.5%を掲げているが、これを達成するための監視指標（SLI）、アラート戦略、インシデント対応手順が定義されていない。メッセージ配信遅延、エラー率、接続失敗率などのREDメトリクスの監視設計、アラート閾値、エスカレーションパスの記載がない。
- **検出判定基準**:
  - ○（検出）: SLO/SLAに対応する監視指標（SLI）、アラート戦略、またはインシデント対応手順の欠如を指摘している
  - △（部分検出）: 監視の必要性に言及しているが、SLO/SLAとの対応や具体的なアラート戦略には触れていない
  - ×（未検出）: 監視・アラート設計について指摘がない

### P07: データマイグレーションの後方互換性とロールバック計画が未定義
- **カテゴリ**: デプロイ・ロールバック
- **深刻度**: 中
- **該当箇所**: セクション6（デプロイメント方針）
- **問題の説明**: Blue/Greenデプロイの記載はあるが、データベーススキーマ変更を伴うデプロイ時の後方互換性戦略、ロールバック計画が定義されていない。例えば、新カラム追加時に旧バージョンのアプリケーションが動作し続けられるか、スキーマ変更失敗時のロールバック手順が不明。
- **検出判定基準**:
  - ○（検出）: データベースマイグレーションの後方互換性、またはスキーマ変更時のロールバック計画の欠如を指摘している
  - △（部分検出）: デプロイ時のデータベース変更リスクに言及しているが、後方互換性やロールバック計画には触れていない
  - ×（未検出）: データマイグレーションの後方互換性について指摘がない

### P08: レート制限の実装詳細とバックプレッシャー設計が不明確
- **カテゴリ**: 障害回復設計（バックプレッシャー）
- **深刻度**: 軽微
- **該当箇所**: セクション3（API Gateway Service）、レート制限 1000 req/min
- **問題の説明**: レート制限の数値（1000 req/min）は記載されているが、制限超過時の挙動（429エラー、待機、段階的制限）やバックプレッシャーのメカニズムが不明。また、WebSocket接続数50,000を想定しているが、接続数制限や負荷過多時の新規接続拒否設計がない。システム過負荷時の自己保護メカニズムが不足している。
- **検出判定基準**:
  - ○（検出）: レート制限超過時の挙動、バックプレッシャー設計、またはWebSocket接続数制限の欠如を指摘している
  - △（部分検出）: レート制限の設定に言及しているが、超過時の挙動やバックプレッシャーメカニズムには触れていない
  - ×（未検出）: レート制限やバックプレッシャー設計について指摘がない

### P09: ヘルスチェックエンドポイントの詳細設計が不足
- **カテゴリ**: 監視・アラート設計
- **深刻度**: 軽微
- **該当箇所**: セクション6（デプロイメント方針）、ヘルスチェック
- **問題の説明**: デプロイ時にヘルスチェックで新バージョンの起動を確認すると記載されているが、ヘルスチェックの具体的な内容（エンドポイント、チェック項目、依存サービスの疎通確認）が不明。単純な/healthエンドポイントだけでは、データベース接続やRedis接続の異常を検知できない可能性がある。
- **検出判定基準**:
  - ○（検出）: ヘルスチェックの具体的な実装内容（依存サービスの疎通確認、深いヘルスチェック）の欠如を指摘している
  - △（部分検出）: ヘルスチェックの必要性に言及しているが、具体的なチェック内容や深度には触れていない
  - ×（未検出）: ヘルスチェック設計について指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 可用性・冗長性 | ECSタスクのAuto Scaling設定はあるが、DocumentDB/ElastiCacheのスケーリング戦略が未定義 | DocumentDBやElastiCacheのスケーリング設計の欠如を指摘している |
| B02 | 監視・アラート | リクエストIDによる追跡可能性は記載されているが、分散トレーシング（X-Ray等）の設計がない | 分散トレーシングやオブザーバビリティツールの必要性を指摘している |
| B03 | 災害復旧 | RPO 24時間、RTO 12時間の目標があるが、実際の復旧手順書（ランブック）や訓練計画がない | 災害復旧手順書（ランブック）や復旧訓練の欠如を指摘している |
| B04 | データ整合性 | MongoDBのインデックス設計やトランザクション利用の記載がない | MongoDBのトランザクション利用やインデックス設計の欠如を指摘している |
| B05 | 障害回復設計 | ALBのヘルスチェック設定（間隔、閾値）が未定義 | ALBヘルスチェックの詳細設定（間隔、閾値、タイムアウト）の欠如を指摘している |
