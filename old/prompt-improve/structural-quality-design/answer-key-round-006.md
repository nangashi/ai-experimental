# 正解キー

## 実行条件
- **観点**: structural-quality
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: BuildingServiceの単一責務原則違反
- **カテゴリ**: SOLID原則・構造設計
- **深刻度**: 重大
- **該当箇所**: セクション3.2「BuildingService」
- **問題の説明**: BuildingServiceが「ビル設備の統合管理」「センサーデータ集約」「異常検知」「制御指示生成」「外部API呼び出し」「トランザクション管理」の6つの異なる責務を持つ。単一のクラスが複数の変更理由（ビジネスルール変更、外部API仕様変更、トランザクション戦略変更）を抱えており、SRP違反。責務を「ビル設備管理（BuildingService）」「センサーデータ集約・異常検知（SensorDataAnalyzer）」「外部連携（WeatherAPIClient, PredictionAPIClient）」に分離すべき。
- **検出判定基準**:
  - ○（検出）: BuildingServiceが複数の責務を持つこと、またはSRP違反を指摘している（「ビジネスロジック」「外部API呼び出し」「データ集約」等の異なる責務が混在していることへの言及）
  - △（部分検出）: BuildingServiceの責務が広すぎることに言及しているが、SRP違反の観点からの指摘でない、または具体的な分離提案がない
  - ×（未検出）: BuildingServiceの責務に関する指摘がない

### P02: Application LayerからInfrastructure Layerへの直接依存
- **カテゴリ**: SOLID原則・構造設計
- **深刻度**: 重大
- **該当箇所**: セクション3.2「BuildingService」
- **問題の説明**: BuildingServiceが外部API（気象API、AI予測API）を直接呼び出す設計は、依存性逆転原則（DIP）違反。Application Layerがインフラストラクチャ詳細に依存し、テスト困難性とベンダーロックインのリスクを生む。`WeatherDataProvider`, `PredictionService`等のインターフェースをDomain/Application Layerに定義し、Infrastructure Layerで実装すべき。
- **検出判定基準**:
  - ○（検出）: BuildingServiceが外部APIに直接依存していることのDIP違反、またはレイヤー境界の侵害を指摘している（「依存方向の逆転」「抽象への依存」「インターフェース分離」等の言及）
  - △（部分検出）: 外部API依存のテスタビリティ問題やモック困難性を指摘しているが、DIP違反の観点からの指摘でない
  - ×（未検出）: 外部API依存の設計に関する指摘がない

### P03: SensorDataテーブルの複合主キー設計の冗長性リスク
- **カテゴリ**: API・データモデル品質
- **深刻度**: 重大
- **該当箇所**: セクション4.1「SensorData」
- **問題の説明**: `SensorData`テーブルの複合主キー(time, device_id, metric_type)は、同一デバイス・同一時刻に複数メトリックが存在する前提だが、各metric_typeを個別のカラム（temperature, humidity, power_consumption）にする設計が一般的。現行設計は柔軟性があるが、データ冗長性（timeとdevice_idが繰り返し保存される）とクエリ複雑化（メトリック横断集計時にPIVOT処理が必要）を招く。EAV（Entity-Attribute-Value）パターンの一種で、TimescaleDBのような時系列DBではカラム型の方が圧縮効率とクエリ性能が高い。
- **検出判定基準**:
  - ○（検出）: SensorDataの複合主キー設計がデータ冗長性やクエリ複雑化を招くこと、またはEAVパターンの欠点を指摘している（「カラム型設計への変更推奨」「メトリック別カラム化」等の言及）
  - △（部分検出）: SensorDataのデータモデル設計に改善余地があることを指摘しているが、具体的な冗長性やクエリ性能の観点からの指摘でない
  - ×（未検出）: SensorDataのデータモデル設計に関する指摘がない

### P04: エラーハンドリング戦略におけるリトライ可能/不可能エラーの区別不足
- **カテゴリ**: エラーハンドリング・オブザーバビリティ
- **深刻度**: 中
- **該当箇所**: セクション6.1「エラーハンドリング方針」
- **問題の説明**: 外部API呼び出し失敗時のCircuit BreakerとフォールバックのみでErrorハンドリングを記述しており、リトライ可能なエラー（一時的ネットワーク障害、503 Service Unavailable）とリトライ不可能なエラー（認証失敗、400 Bad Request）の分類・戦略が未定義。無差別リトライは外部サービスへの負荷増加、無意味なレイテンシを引き起こす。エラー分類体系とリトライ戦略をアプリケーションレベルで設計すべき。
- **検出判定基準**:
  - ○（検出）: エラーハンドリング戦略においてリトライ可能/不可能なエラーの区別が欠如していること、またはエラー分類体系の必要性を指摘している
  - △（部分検出）: エラーハンドリングの改善を指摘しているが、リトライ戦略の観点からの指摘でない
  - ×（未検出）: エラーハンドリング戦略に関する指摘がない

### P05: API設計における動詞ベースURLとHTTPメソッド不一致
- **カテゴリ**: API・データモデル品質
- **深刻度**: 中
- **該当箇所**: セクション5.2「PUT /devices/{id}/control」
- **問題の説明**: デバイス制御エンドポイント`PUT /devices/{id}/control`は、URLに動詞「control」を含み、RESTful設計原則に反する。PUTは通常「リソース全体の置換」を意味するが、ここでは「制御指示の送信（アクション実行）」であり、セマンティクス不一致。制御指示を`ControlCommand`リソースとして扱い、`POST /devices/{id}/control-commands`とすべき。または、デバイスの状態（`desired_state`）をPUTで更新する設計に変更すべき。
- **検出判定基準**:
  - ○（検出）: `/control`エンドポイントのRESTful原則違反、またはHTTPメソッドとセマンティクスの不一致を指摘している（「動詞ベースURL」「PUTの誤用」「リソース指向設計への変更」等の言及）
  - △（部分検出）: API設計の改善を指摘しているが、RESTful原則の観点からの具体的指摘でない
  - ×（未検出）: `/control`エンドポイントの設計に関する指摘がない

### P06: APIバージョニング戦略の欠如
- **カテゴリ**: API・データモデル品質
- **深刻度**: 中
- **該当箇所**: セクション5.2「エンドポイント一覧」
- **問題の説明**: 全エンドポイントにバージョニング戦略（URL path versioning `/v1/buildings`, header versioning, content negotiation等）が存在しない。API仕様変更時に後方互換性を保つメカニズムがなく、既存クライアント（モバイルアプリ、外部連携システム）の破壊的変更リスクがある。初期設計段階からバージョニング戦略を組み込むべき。
- **検出判定基準**:
  - ○（検出）: APIバージョニング戦略の欠如を指摘し、後方互換性リスクや破壊的変更の問題に言及している
  - △（部分検出）: APIのバージョン管理に言及しているが、後方互換性の観点からの具体的指摘でない
  - ×（未検出）: APIバージョニングに関する指摘がない

### P07: テスト戦略における統合テスト境界の曖昧さ
- **カテゴリ**: テスト設計・テスタビリティ
- **深刻度**: 中
- **該当箇所**: セクション6.3「テスト方針」
- **問題の説明**: 統合テストが「Testcontainersでインフラ依存をモック」とあるが、何を統合テスト範囲とするか（Controller→Service→Repository, Controller→Service, Service→Repository等）が未定義。単体テストとの境界も曖昧（Serviceの単体テストで外部依存をモックするのか、統合テストでテストするのか）。テスト戦略の役割分担が不明確で、重複テストや漏れが発生しやすい。
- **検出判定基準**:
  - ○（検出）: 単体テストと統合テストの境界・役割分担の曖昧さを指摘している（「統合テスト範囲の定義が不足」「テストレイヤーの責務不明確」等の言及）
  - △（部分検出）: テスト戦略の改善を指摘しているが、単体/統合テストの境界の観点からの具体的指摘でない
  - ×（未検出）: テスト戦略の境界に関する指摘がない

### P08: 環境固有設定の管理戦略不足
- **カテゴリ**: 拡張性・運用設計
- **深刻度**: 中
- **該当箇所**: セクション2.3「インフラ・デプロイ環境」、セクション6.4「デプロイメント方針」
- **問題の説明**: Spring Cloud Configの採用は明記されているが、開発・ステージング・本番環境の設定差分（DB接続先、Kafka Broker URL、外部APIエンドポイント、ログレベル、Feature Flag等）をどう管理するか、また環境毎の設定値の検証（本番DBを開発環境で参照しない保証）の戦略が未定義。設定ミスによる本番障害リスクが高い。
- **検出判定基準**:
  - ○（検出）: 環境固有設定の管理戦略または差分管理方針の不足を指摘している（「環境別設定の検証戦略」「Feature Flagの管理」「設定値の誤適用防止」等の言及）
  - △（部分検出）: 設定管理に言及しているが、環境差分や検証戦略の観点からの具体的指摘でない
  - ×（未検出）: 環境固有設定管理に関する指摘がない

### P09: JWT保存先の未定義とセキュリティリスク
- **カテゴリ**: 変更容易性・モジュール設計（状態管理）
- **深刻度**: 軽微
- **該当箇所**: セクション5.1「認証・認可方式」
- **問題の説明**: JWTトークンの保存先（localStorage, sessionStorage, Cookie等）が設計書に未記載。localStorageに保存する実装は一般的だが、XSS攻撃時のトークン窃取リスクがあり、HttpOnly Cookieの方が推奨される。モバイルアプリの場合はSecure Storageを使用すべき。認証状態管理の設計方針としてトークン保存戦略を明示すべき。
- **検出判定基準**:
  - ○（検出）: JWT保存先の未定義、またはフロントエンド/モバイルアプリの認証状態管理戦略の不足を指摘している（「localStorage vs Cookie」「Secure Storage」「トークン保存のセキュリティリスク」等の言及）
  - △（部分検出）: JWT認証に関する改善を指摘しているが、保存先や状態管理戦略の観点からの具体的指摘でない
  - ×（未検出）: JWT保存先や認証状態管理に関する指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | SOLID原則・構造設計 | AlertManagerの責務が広すぎる（異常検知ルール評価、アラート生成、通知、エスカレーション）。AlertDetector, AlertNotifier, EscalationManagerに分離すべき | AlertManagerのSRP違反または責務分離を提案している |
| B02 | 変更容易性・モジュール設計 | SensorDataCollectorがKafka Consumer実装に密結合（`@KafkaListener`等のアノテーションが直接実装クラスに存在すると想定）。メッセージング抽象化レイヤー（MessageReceiver interface）でKafka依存を隠蔽すべき | SensorDataCollectorのメッセージング基盤依存の抽象化不足を指摘 |
| B03 | 拡張性・運用設計 | デバイスタイプ（HVAC, LIGHTING, SECURITY, POWER_METER）がハードコード想定。新デバイスタイプ追加時にコード変更が必要。デバイスタイププラグインメカニズムまたは設定駆動設計を推奨 | デバイスタイプのハードコード問題または拡張メカニズム不足を指摘 |
| B04 | エラーハンドリング・オブザーバビリティ | センサーデータ受信・デバイス制御・アラート生成の分散トレーシング戦略（コンテキスト伝播、trace IDの連携）が未定義 | 分散トレーシング設計の不足を指摘 |
| B05 | テスト設計・テスタビリティ | E2Eテストがログイン→ビル一覧→デバイス制御のみで、主要フロー（センサーデータ可視化、アラート対応等）が不足 | E2Eテストカバレッジの不足を指摘 |
| B06 | API・データモデル品質 | Deviceテーブルにstatus（ACTIVE, INACTIVE, MAINTENANCE）があるが、Alertテーブルのstatusと名前が重複し、紛らわしい。`device_status`, `alert_status`に明示的に命名すべき | カラム命名の曖昧さまたは紛らわしさを指摘 |
| B07 | 変更容易性・モジュール設計 | BuildingとTenantの関係が1:Nだが、将来的に複数ビルにまたがるテナント（大企業のフロア分散利用）が必要になる可能性。M:N設計を検討すべき | Building-Tenant関係のスケーラビリティ問題を指摘 |
| B08 | API・データモデル品質 | Device, Alert, SensorDataにcreated_at, updated_atがあるが、データ監査（誰が変更したか）のための`created_by`, `updated_by`カラムが欠如 | 監査ログ設計の不足を指摘 |
| B09 | エラーハンドリング・オブザーバビリティ | ログレベル戦略が「DEBUG（開発）, INFO（本番）」のみで、WARNやERRORのガイドラインが未定義。アラート連携の基準も不明 | ログレベル戦略の詳細不足を指摘 |
| B10 | テスト設計・テスタビリティ | カバレッジ目標80%の根拠が不明。クリティカルパス（センサーデータ処理、制御指示）は100%、ユーティリティは60%等の戦略的カバレッジ設定を推奨 | カバレッジ目標の戦略不足を指摘 |
