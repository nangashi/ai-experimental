# 正解キー

## 実行条件
- **観点**: structural-quality
- **対象**: design
- **埋め込み問題数**: 10問

## 埋め込み問題一覧

### P01: LibraryServiceの単一責務原則違反
- **カテゴリ**: SOLID原則
- **深刻度**: 重大
- **該当箇所**: セクション3（アーキテクチャ設計）- LibraryServiceの説明
- **問題の説明**: LibraryServiceが貸出・返却、蔵書管理、予約処理、レポート生成、利用者認証という5つの異なる責務を持っている。これは単一責務原則に違反しており、変更理由が複数存在するため保守性が低下する。
- **検出判定基準**:
  - ○（検出）: LibraryServiceが複数の責務を持っていることを指摘し、サービス分割（例: LoanService, BookManagementService, ReservationService, ReportService等への分割）を提案している
  - △（部分検出）: LibraryServiceが大きすぎる/複雑すぎるという指摘はあるが、具体的な責務分離や単一責務原則への言及がない
  - ×（未検出）: 指摘なし

### P02: 外部依存の直接結合
- **カテゴリ**: 外部依存
- **深刻度**: 重大
- **該当箇所**: セクション3（アーキテクチャ設計）- LibraryServiceの説明
- **問題の説明**: LibraryServiceがBookRepository、LoanRepository、UserRepository、ReservationRepositoryに直接アクセスしている。これによりデータアクセス層への強い結合が生じ、テスト時のモック化が困難になり、将来のデータストア変更時の影響範囲が大きくなる。
- **検出判定基準**:
  - ○（検出）: サービス層がRepositoryに直接依存していることの問題を指摘し、抽象化層（例: インターフェース経由でのアクセス、Repositoryパターンの適切な適用）の導入を提案している
  - △（部分検出）: レイヤー間の結合について言及しているが、Repository直接参照の問題や抽象化の必要性について具体的に触れていない
  - ×（未検出）: 指摘なし

### P03: loansテーブルのデータ冗長性
- **カテゴリ**: データモデル設計
- **深刻度**: 重大
- **該当箇所**: セクション4（データモデル）- loansテーブル
- **問題の説明**: loansテーブルにuser_name、book_titleといった冗長データが含まれている。これらはusersテーブル、booksテーブルから取得可能な情報であり、正規化原則に違反している。データ不整合のリスクがあり、users/booksテーブルの更新時に同期が必要になる。
- **検出判定基準**:
  - ○（検出）: loansテーブルのuser_name、book_titleが冗長データであることを指摘し、正規化の観点から削除またはJOINでの取得を提案している
  - △（部分検出）: データの冗長性について一般的な言及はあるが、loansテーブルの具体的なカラムに言及していない
  - ×（未検出）: 指摘なし

### P04: API設計のRESTful原則違反
- **カテゴリ**: API・データモデル品質
- **深刻度**: 中
- **該当箇所**: セクション5（API設計）- エンドポイント一覧
- **問題の説明**: エンドポイントが動詞ベースのURL（/api/borrowBook, /api/updateBook, /api/deleteBook, /api/getUser等）を使用しており、RESTful設計原則に反している。RESTではリソースを名詞で表現し、HTTPメソッド（GET, POST, PUT, DELETE）で操作を表現するべきである。
- **検出判定基準**:
  - ○（検出）: 動詞ベースのエンドポイント設計がRESTful原則に反していることを指摘し、リソースベースの設計（例: POST /api/loans, PUT /api/books/{id}, DELETE /api/books/{id}, GET /api/users/{id}）を提案している
  - △（部分検出）: API設計について何らかの指摘はあるが、RESTful原則違反や具体的な改善案に触れていない
  - ×（未検出）: 指摘なし

### P05: テスト戦略におけるDI設計の欠如
- **カテゴリ**: テスト設計・テスタビリティ
- **深刻度**: 中
- **該当箇所**: セクション6（実装方針）- テスト方針
- **問題の説明**: テスト方針でMockitoの使用が言及されているが、アーキテクチャ設計でDI（依存性注入）の設計方針が明示されていない。LibraryServiceの説明では複数のRepositoryへの直接アクセスが記載されており、テスト時のモック化が困難になる可能性がある。
- **検出判定基準**:
  - ○（検出）: DI設計の欠如またはコンストラクタインジェクション等の明示的な依存注入パターンの必要性を指摘し、テスタビリティ向上のための設計改善を提案している
  - △（部分検出）: テストのしやすさについて言及しているが、DI設計や依存注入の具体的な必要性に触れていない
  - ×（未検出）: 指摘なし

### P06: エラーハンドリング戦略の不明瞭さ
- **カテゴリ**: エラー・可観測性
- **深刻度**: 中
- **該当箇所**: セクション6（実装方針）- エラーハンドリング方針
- **問題の説明**: エラーハンドリング方針で「データベース接続エラー、バリデーションエラー、業務ロジックエラーなど、エラーの種類に応じて異なる処理を行う」と記載されているが、各エラー種別の具体的な分類基準、リカバリー戦略（リトライ可否、トランザクションロールバック方針等）、クライアントへの通知方法が定義されていない。
- **検出判定基準**:
  - ○（検出）: エラー分類・リカバリー戦略・クライアント通知方法が不明瞭であることを指摘し、具体的なエラーハンドリングポリシーの定義を提案している
  - △（部分検出）: エラーハンドリングについて何らかの指摘はあるが、分類・リカバリー戦略の具体性欠如に触れていない
  - ×（未検出）: 指摘なし

### P07: APIバージョニング戦略の欠如
- **カテゴリ**: インターフェース契約
- **深刻度**: 中
- **該当箇所**: セクション5（API設計）- エンドポイント一覧
- **問題の説明**: すべてのエンドポイントが/apiプレフィックスのみで、バージョン情報が含まれていない。API仕様変更時の後方互換性を維持する戦略が欠如しており、将来の破壊的変更時にクライアントが影響を受けるリスクがある。
- **検出判定基準**:
  - ○（検出）: APIバージョニング戦略の欠如を指摘し、URLベースまたはヘッダーベースのバージョニング導入を提案している
  - △（部分検出）: API設計の改善に言及しているが、バージョニングの具体的な必要性に触れていない
  - ×（未検出）: 指摘なし

### P08: 変更影響範囲の広さ
- **カテゴリ**: 変更影響・DRY
- **深刻度**: 中
- **該当箇所**: セクション3（アーキテクチャ設計）全体、セクション5（API設計）
- **問題の説明**: 通知機能の変更（例: メール送信からSMS送信への切り替え）を行う場合、NotificationServiceの実装変更だけでなく、LibraryService、UserService、および複数のAPIエンドポイントで通知呼び出し箇所の修正が必要になる可能性がある。インターフェース抽象化や設定管理の設計が不十分で、変更影響が複数コンポーネントに波及する。
- **検出判定基準**:
  - ○（検出）: 通知機能など横断的機能の変更時に複数コンポーネントへの影響が波及する設計上の問題を指摘し、インターフェース抽象化や疎結合化を提案している
  - △（部分検出）: コンポーネント間の結合について言及しているが、具体的な変更影響範囲の問題や横断的関心事の扱いに触れていない
  - ×（未検出）: 指摘なし

### P09: 環境別設定管理の不十分さ
- **カテゴリ**: 設定管理
- **深刻度**: 軽微
- **該当箇所**: セクション6（実装方針）- デプロイメント方針
- **問題の説明**: 環境別設定を環境変数で管理すると記載されているが、DATABASE_URL、REDIS_URLのみが例示されており、その他の設定（ログレベル、JWT有効期限、メール送信設定、外部API URL等）の管理方針や設定値のバージョン管理手法が明示されていない。
- **検出判定基準**:
  - ○（検出）: 環境別設定の管理範囲が限定的であることを指摘し、設定項目の網羅的な管理方針（設定ファイル、ConfigMap、Secrets等の使い分け）を提案している
  - △（部分検出）: 環境設定について言及しているが、管理範囲の不十分さや具体的な改善策に触れていない
  - ×（未検出）: 指摘なし

### P10: ロギング設計の詳細不足
- **カテゴリ**: エラー・可観測性
- **深刻度**: 軽微
- **該当箇所**: セクション6（実装方針）- ロギング方針
- **問題の説明**: ロギング方針で「すべてのAPIリクエスト/レスポンスをログに記録」と記載されているが、個人情報（パスワード、メールアドレス等）のマスキング方針、ログローテーション設定、構造化ログ（JSON形式等）の採用有無、分散トレーシング（トレースID等）の設計が明示されていない。
- **検出判定基準**:
  - ○（検出）: ロギング設計において個人情報マスキング、構造化ログ、トレーシング等の重要な要素が欠如していることを指摘し、具体的な改善策を提案している
  - △（部分検出）: ロギング設計について何らかの指摘はあるが、マスキング・構造化・トレーシング等の具体的な要素に触れていない
  - ×（未検出）: 指摘なし

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | SOLID原則 | UserServiceも認証とプロフィール管理という複数の責務を持っている可能性（単一責務原則違反） | UserServiceの責務分離を提案している |
| B02 | 外部依存 | NotificationServiceがJavaMailSenderに直接依存しており、テストやメール送信方式の変更が困難 | NotificationServiceの抽象化を提案している |
| B03 | データモデル設計 | booksテーブルのtotal_copiesとavailable_copiesが冗長（loansテーブルから集計可能） | booksテーブルの冗長カラムを指摘している |
| B04 | YAGNI・パターン誤用 | レポート生成機能がLibraryServiceに含まれているが、現時点でシンプルなクエリで済む場合、別サービス化は過剰設計の可能性 | 現在の要件に対する過剰な抽象化を指摘している |
| B05 | テスト戦略 | E2Eテストの具体的なスコープ（どのシナリオをカバーするか）が未定義 | E2Eテストのスコープ明確化を提案している |
| B06 | インターフェース契約 | リクエスト/レスポンス形式のスキーマ定義（OpenAPI/Swagger等）が明示されていない | APIスキーマ定義の必要性を指摘している |
