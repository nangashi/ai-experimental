# 正解キー

## 実行条件
- **観点**: performance
- **対象**: design
- **埋め込み問題数**: 10問

## 埋め込み問題一覧

### P01: パフォーマンス要件/SLA定義の欠如
- **カテゴリ**: レイテンシ・スループット設計（パフォーマンス要件/SLA定義）
- **深刻度**: 重大
- **該当箇所**: セクション7 非機能要件 - パフォーマンス
- **問題の説明**: 「3秒以内のレスポンス」「秒間1000メッセージ処理」という目標値は記載されているが、以下の点が不明確でありパフォーマンスSLAとして不十分:
  - 負荷条件（同時接続ユーザー数、データ量）が未定義
  - センサーデータ収集の「100センサー同時接続」は記載されているが、ダッシュボード表示の負荷条件が不明
  - パーセンタイル値（p50/p95/p99）の定義がなく、外れ値の扱いが曖昧
  - 収穫予測APIのレスポンスタイム目標値が未定義
  - レポート生成の完了時間目標が未定義
- **検出判定基準**:
  - ○（検出）: パフォーマンス目標値に対して「負荷条件が不明確」「パーセンタイル値（p95/p99）が未定義」「主要API（収穫予測/レポート生成）のレスポンスタイム目標欠如」のいずれか2つ以上を具体的に指摘している
  - △（部分検出）: パフォーマンス目標値の不明確さに言及しているが、上記の具体的要素が1つのみ
  - ×（未検出）: パフォーマンス目標値に関する指摘がない

### P02: ダッシュボードデータ取得におけるN+1問題
- **カテゴリ**: I/O・ネットワーク効率（N+1問題）
- **深刻度**: 重大
- **該当箇所**: セクション5 API設計 - ダッシュボードデータ取得の実装
- **問題の説明**: `/api/farms/:farmId/dashboard` エンドポイントの実装でN+1問題が発生している。センサー一覧を取得後、各センサーに対して個別にMongoDBクエリを実行する `for (const sensor of sensors.rows)` ループにより、センサー数に比例したデータベースアクセスが発生する。大規模農業法人（50-200センサー/圃場）では50-200回のMongoDBクエリが逐次実行され、レスポンスタイムが大幅に増加する。
- **検出判定基準**:
  - ○（検出）: ダッシュボードAPIの `for` ループによるセンサー単位のMongoDBクエリがN+1問題を引き起こすことを明確に指摘し、センサー数増加時のパフォーマンス劣化リスクに言及している
  - △（部分検出）: ダッシュボードAPIのループ処理に問題があることは指摘しているが、N+1問題としての特定や代替策（一括クエリ/aggregation）への言及がない
  - ×（未検出）: ダッシュボードAPIのN+1問題に関する指摘がない

### P03: センサーデータのキャッシュ戦略欠如
- **カテゴリ**: キャッシュ・メモリ管理（キャッシュ対象の選定）
- **深刻度**: 重大
- **該当箇所**: セクション5 API設計 - ダッシュボードデータ取得、セクション3 アーキテクチャ設計
- **問題の説明**: ダッシュボードで頻繁にアクセスされる「各センサーの最新値」に対するキャッシュ戦略が未定義。センサーデータは1分間隔で更新されるため、毎回MongoDBにクエリする必要はなく、適切なTTL（例: 60秒）でキャッシュすることでデータベース負荷とレスポンスタイムを大幅に改善できる。特に複数ユーザーが同時にダッシュボードを閲覧する場合、キャッシュなしでは同じデータに対する重複クエリが発生する。
- **検出判定基準**:
  - ○（検出）: センサー最新値のキャッシュ欠如を指摘し、「頻繁にアクセスされるが変更頻度が低い（1分間隔）」というキャッシュ適合性の根拠を示している
  - △（部分検出）: キャッシュ導入の必要性に言及しているが、対象データ（センサー最新値）やキャッシュ適合性の根拠が曖昧
  - ×（未検出）: キャッシュ戦略に関する指摘がない

### P04: センサー履歴データの無制限クエリ
- **カテゴリ**: I/O・ネットワーク効率（バッチ処理設計）、レイテンシ・スループット設計
- **深刻度**: 中
- **該当箇所**: セクション5 API設計 - センサー履歴データ取得
- **問題の説明**: `/api/farms/:farmId/sensor-history/:sensorId` エンドポイントで日付範囲を指定してセンサー履歴を取得する際、取得件数の上限が設定されていない。1年分のデータ（1分間隔で約52万レコード）を一度に取得するとMongoDBの負荷増大とメモリ消費、ネットワーク転送量増加によりレスポンスタイムが数十秒に達する可能性がある。limit や pagination による取得件数制限が必要。
- **検出判定基準**:
  - ○（検出）: センサー履歴APIに「取得件数制限（limit/pagination）がない」ことを明確に指摘し、長期間指定時のパフォーマンス劣化リスクに言及している
  - △（部分検出）: センサー履歴クエリの最適化が必要とは述べているが、無制限クエリの具体的問題点（件数制限欠如）への言及がない
  - ×（未検出）: センサー履歴APIの無制限クエリに関する指摘がない

### P05: 収穫予測の同期処理設計
- **カテゴリ**: レイテンシ・スループット設計（非同期処理）
- **深刻度**: 中
- **該当箇所**: セクション5 API設計 - エンドポイント一覧（`GET /api/farms/:farmId/harvest-prediction`）
- **問題の説明**: 収穫予測APIがリアルタイム同期処理として設計されている。収穫予測は過去の環境データ集計と外部気象APIの取得を伴うため、計算コストが高く5-10秒以上かかる可能性がある。ユーザーリクエストの度に同期計算するとタイムアウトリスクがあり、スケーラビリティも低い。事前計算+キャッシュ、または非同期ジョブ化が望ましい。
- **検出判定基準**:
  - ○（検出）: 収穫予測APIが「同期処理である点」を指摘し、計算コストの高さ（過去データ集計/外部API）から「非同期処理または事前計算が必要」と具体的に提案している
  - △（部分検出）: 収穫予測の計算負荷を指摘しているが、同期/非同期の設計選択に関する言及がない
  - ×（未検出）: 収穫予測APIの処理方式に関する指摘がない

### P06: 時系列センサーデータの長期増大対策欠如
- **カテゴリ**: スケーラビリティ設計、キャッシュ・メモリ管理
- **深刻度**: 中
- **該当箇所**: セクション4 データモデル - MongoDB sensor_readings コレクション
- **問題の説明**: センサーデータは1分間隔で永続的に蓄積される。100センサー × 1440レコード/日 × 365日 = 年間約5200万レコードが無制限に増加する。データライフサイクルポリシー（古いデータのアーカイブや削除）が未定義のため、MongoDBのストレージ容量不足とクエリパフォーマンス劣化（インデックス肥大化）が発生する。パーティショニング、古いデータの集約（時間粒度変更）、アーカイブストレージへの移行戦略が必要。
- **検出判定基準**:
  - ○（検出）: センサーデータの時系列増大に対して「データライフサイクルポリシー（アーカイブ/削除）欠如」を指摘し、具体的な対策（パーティショニング/集約/アーカイブ）に言及している
  - △（部分検出）: センサーデータの増大リスクを指摘しているが、データライフサイクルポリシーや具体的対策への言及がない
  - ×（未検出）: 時系列データの長期増大対策に関する指摘がない

### P07: MongoDBインデックス設計の欠如
- **カテゴリ**: レイテンシ・スループット設計（インデックス設計）
- **深刻度**: 中
- **該当箇所**: セクション4 データモデル - MongoDB sensor_readings コレクション、セクション5 API設計
- **問題の説明**: センサー履歴データ取得クエリ（`sensor_id` + `timestamp` 範囲検索）に対する複合インデックスが設計書に記載されていない。データ量増加に伴いフルスキャンが発生し、クエリ時間が数秒から数十秒に劣化する。適切なインデックス（`{ sensor_id: 1, timestamp: 1 }`）が必要。
- **検出判定基準**:
  - ○（検出）: MongoDBのセンサーデータクエリに対して「インデックス（sensor_id + timestamp）が未定義」であることを明確に指摘している
  - △（部分検出）: インデックス設計の重要性には言及しているが、具体的な対象コレクションやフィールドの指摘がない
  - ×（未検出）: MongoDBインデックス設計に関する指摘がない

### P08: MQTTブローカーのスケーラビリティ設計欠如
- **カテゴリ**: スケーラビリティ設計（水平/垂直スケーリング方針）
- **深刻度**: 軽微
- **該当箇所**: セクション3 アーキテクチャ設計 - 全体構成
- **問題の説明**: MQTTブローカーの接続数スケーラビリティ方針が未定義。現在の設計では単一MQTTブローカーを前提としているが、農業法人の拡大やセンサー数増加（数千台）に対応する場合、MQTTブローカーの水平スケーリングまたはクラスタリング方針が必要。接続数上限やスケールアウト戦略が記載されていない。
- **検出判定基準**:
  - ○（検出）: MQTTブローカーの「接続数スケーラビリティ方針（水平スケーリング/クラスタリング）が未定義」であることを明確に指摘し、センサー数増加時のスケールアウト要件に言及している
  - △（部分検出）: MQTTブローカーのスケーラビリティに言及しているが、具体的な設計要素（水平スケーリング/クラスタリング）への指摘がない
  - ×（未検出）: MQTTブローカーのスケーラビリティに関する指摘がない

### P09: 灌水制御の並行実行競合状態
- **カテゴリ**: スケーラビリティ設計、レイテンシ・スループット設計
- **深刻度**: 軽微
- **該当箇所**: セクション5 API設計 - `/api/farms/:farmId/irrigation/execute`、セクション4 データモデル - irrigation_schedules テーブル
- **問題の説明**: 灌水実行APIで `last_executed_at` を更新する際の並行制御設計が未定義。自動灌水スケジュールと手動実行リクエストが同時発生した場合、競合状態により重複実行や `last_executed_at` の更新順序不整合が発生する可能性がある。楽観的ロック（version カラム）またはトランザクション分離レベルの設計が必要。
- **検出判定基準**:
  - ○（検出）: 灌水実行APIまたは `last_executed_at` 更新に対して「並行実行の競合制御（楽観的ロック/トランザクション分離レベル）が未定義」であることを明確に指摘している
  - △（部分検出）: 灌水制御の並行実行リスクに言及しているが、具体的な競合制御メカニズムへの指摘がない
  - ×（未検出）: 灌水制御の並行実行競合に関する指摘がない

### P10: パフォーマンス監視メトリクスの収集設計欠如
- **カテゴリ**: レイテンシ・スループット設計
- **深刻度**: 軽微
- **該当箇所**: セクション6 実装方針 - ロギング、セクション7 非機能要件
- **問題の説明**: ロギング方針として「リクエストID、ユーザーID、エンドポイント、レスポンス時間」の記録は定義されているが、パフォーマンス固有のメトリクス収集設計が不足している。以下の項目が未定義:
  - APIエンドポイント別のレスポンスタイム分布（p50/p95/p99）
  - MongoDB/PostgreSQLクエリ実行時間の計測
  - MQTTメッセージ処理スループット（メッセージ/秒）
  - メモリ使用率・CPU使用率の監視
これらのメトリクスがないとパフォーマンス劣化の早期検知やボトルネック特定が困難。
- **検出判定基準**:
  - ○（検出）: パフォーマンス監視メトリクス（レスポンスタイム分布p95/p99、DBクエリ時間、スループット、リソース使用率）のうち2つ以上が欠如していることを具体的に指摘している
  - △（部分検出）: パフォーマンス監視の重要性には言及しているが、具体的なメトリクス項目への指摘が1つのみ
  - ×（未検出）: パフォーマンス監視メトリクスに関する指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | I/O効率 | 気象データAPI呼び出しの効率化（キャッシュ/バッチ取得）欠如 | 外部API呼び出し効率化（キャッシュTTL設定やバッチリクエスト）の提案がある |
| B02 | リソース管理 | PostgreSQL/MongoDBのコネクションプール設定が未定義 | データベース接続プールの設定（最大接続数、タイムアウト）に関する指摘がある |
| B03 | スケーラビリティ | 単一EC2インスタンス構成による水平スケーリング困難 | アプリケーションサーバーのスケールアウト設計（ロードバランサー、ステートレス化）への言及がある |
| B04 | キャッシュ | 圃場情報・センサー情報のキャッシュ戦略欠如 | 圃場メタデータやセンサー設定情報のキャッシュ提案がある |
| B05 | I/O効率 | レポート一覧取得のページネーション欠如 | `/api/reports/:farmId` エンドポイントのページネーション設計の必要性を指摘している |
| B06 | 並行処理 | レポート生成の非同期実行時のステータス管理・重複実行防止設計欠如 | RabbitMQジョブの冪等性やステータス管理（実行中/完了/失敗）の設計に言及している |
| B07 | データ構造 | MongoDB時系列データの集約クエリ最適化（aggregation pipeline）欠如 | MongoDBのaggregation pipelineや時系列コレクション（time series collection）の活用提案がある |
| B08 | スケーラビリティ | アラート通知の大量送信時のレート制限・バッチ送信設計欠如 | メール/SMS送信のレート制限やバッチ処理の必要性を指摘している |
| B09 | I/O効率 | ダッシュボードAPIの複数リソース取得の並列化欠如 | PostgreSQLとMongoDBのクエリを並列実行（Promise.all）する提案がある |
| B10 | リソース管理 | 長時間実行ジョブ（レポート生成）のメモリリーク防止設計欠如 | RabbitMQワーカープロセスのメモリ管理やタイムアウト設計に言及している |
