# 正解キー - Round 004

## 実行条件
- **観点**: performance
- **対象**: design
- **埋め込み問題数**: 10問

## 埋め込み問題一覧

### P01: ダッシュボードポーリングによる不要なDB負荷
- **カテゴリ**: I/O・ネットワーク効率
- **深刻度**: 重大
- **該当箇所**: セクション3（データフロー）5番、セクション5（API）ダッシュボードエンドポイント
- **問題の説明**: ダッシュボードが5秒間隔でREST APIをポーリングする設計は、WebSocketで既にリアルタイム接続が確立されているにもかかわらず、不要なHTTPリクエストとDB読み取りを発生させる。監視中患者数が100人の場合、1分間に1200回のAPI呼び出しが発生し、データベース負荷が増大する。
- **検出判定基準**:
  - ○（検出）: ダッシュボードのポーリング設計について、WebSocketによるプッシュ通知への置き換えを提案している、または既存WebSocket接続の活用による効率化を指摘している
  - △（部分検出）: API呼び出し頻度の削減やキャッシュの導入を提案しているが、WebSocket活用には言及していない
  - ×（未検出）: ポーリング設計の問題に言及していない

### P02: バイタルデータ取得時のN+1問題
- **カテゴリ**: I/O・ネットワーク効率
- **深刻度**: 重大
- **該当箇所**: セクション4（データモデル）、セクション5（API）バイタルデータエンドポイント
- **問題の説明**: `GET /api/patients/{patientId}/vitals`のエンドポイント設計において、患者IDベースのクエリで大量のバイタルデータを取得する際、デバイス情報やアラートルールの関連データを個別に取得する実装になる可能性が高い。vital_dataテーブルにはdevice_id外部キーがあり、各レコードごとにdevicesテーブルへの参照が発生するN+1問題のリスクがある。
- **検出判定基準**:
  - ○（検出）: バイタルデータ取得時のN+1問題を明示的に指摘し、JOINやバッチ読み込み（eager loading）を提案している
  - △（部分検出）: クエリ最適化やインデックス設計に言及しているが、N+1パターンに具体的に触れていない
  - ×（未検出）: バイタルデータ取得のクエリ効率に言及していない

### P03: バイタルデータテーブルの容量増加対策の欠如
- **カテゴリ**: スケーラビリティ、データベース設計
- **深刻度**: 重大
- **該当箇所**: セクション4（データモデル）vital_dataテーブル
- **問題の説明**: バイタルデータは1秒間隔で送信され、1台のデバイスから1日で86,400レコード、5000台で年間1,576億レコードが蓄積される。vital_dataテーブルには時系列データのパーティショニング戦略やアーカイブ設計が示されておらず、長期運用でクエリパフォーマンスが劣化し、ストレージコストが増大する。
- **検出判定基準**:
  - ○（検出）: バイタルデータの長期蓄積による容量増加を指摘し、テーブルパーティショニング（時間ベース）またはホット/コールドデータ分離戦略を提案している
  - △（部分検出）: データアーカイブやストレージ最適化に言及しているが、パーティショニング戦略には触れていない
  - ×（未検出）: 時系列データの容量増加問題に言及していない

### P04: レポート生成の同期処理によるタイムアウトリスク
- **カテゴリ**: 並行処理、レイテンシ設計
- **深刻度**: 中
- **該当箇所**: セクション5（API）レポートエンドポイント、セクション1（主要機能）レポート生成
- **問題の説明**: `POST /api/reports/generate`が同期的なリクエスト・レスポンス形式で設計されている。日次・週次レポートは大量のバイタルデータ集計を伴うため、処理時間が長期化し、HTTPタイムアウトやクライアント側の待機時間が発生する。
- **検出判定基準**:
  - ○（検出）: レポート生成の非同期処理化（ジョブキュー、バックグラウンドワーカー）を提案している、または処理完了通知の仕組み（Webhook、ポーリング）を提案している
  - △（部分検出）: 処理時間の最適化やタイムアウト設定の調整に言及しているが、非同期化には触れていない
  - ×（未検出）: レポート生成の処理時間問題に言及していない

### P05: デバイス一覧取得のページネーション欠如
- **カテゴリ**: データベース設計、I/O効率
- **深刻度**: 中
- **該当箇所**: セクション5（API）デバイス管理エンドポイント
- **問題の説明**: `GET /api/devices`エンドポイントにページネーションが設計されていない。病院が5000台のデバイスを管理する場合、全レコードをメモリ展開し、JSONシリアライズすることで、APIサーバーのメモリ使用量が増大し、ネットワーク転送量も肥大化する。
- **検出判定基準**:
  - ○（検出）: デバイス一覧取得のページネーション（limit/offset、カーソルベース）の必要性を指摘している
  - △（部分検出）: APIレスポンスサイズの最適化に言及しているが、ページネーション実装には触れていない
  - ×（未検出）: デバイス一覧取得のデータ量問題に言及していない

### P06: データベースインデックスの設計欠如
- **カテゴリ**: データベース設計
- **深刻度**: 中
- **該当箇所**: セクション4（データモデル）vital_dataテーブル
- **問題の説明**: vital_dataテーブルのクエリパターン（patient_id + timestamp範囲検索、device_id + timestamp範囲検索）に対するインデックスが明示されていない。数億レコード規模での範囲検索が頻発するため、適切なインデックス設計がなければフルテーブルスキャンが発生する。
- **検出判定基準**:
  - ○（検出）: vital_dataテーブルへの複合インデックス（patient_id + timestamp、device_id + timestamp）の必要性を指摘している
  - △（部分検出）: インデックスの重要性に言及しているが、具体的なカラム組み合わせを提案していない
  - ×（未検出）: インデックス設計に言及していない

### P07: WebSocket接続の再接続ストーム対策の欠如
- **カテゴリ**: スケーラビリティ、ネットワーク効率
- **深刻度**: 中
- **該当箇所**: セクション6（実装方針）エラーハンドリング
- **問題の説明**: デバイスの自動再接続にexponential backoffが記載されているが、サーバー側のメンテナンスやネットワーク障害で5000台のデバイスが同時に切断された場合、全デバイスが一斉に再接続を試みる「再接続ストーム」が発生するリスクがある。ジッター（ランダム遅延）やレート制限の設計が示されていない。
- **検出判定基準**:
  - ○（検出）: 大量デバイスの同時再接続によるサーバー負荷を指摘し、ジッター追加またはレート制限の必要性を提案している
  - △（部分検出）: 再接続戦略の改善に言及しているが、同時再接続問題には触れていない
  - ×（未検出）: 再接続ストーム問題に言及していない

### P08: アラート通知の処理遅延リスク
- **カテゴリ**: レイテンシ設計、並行処理
- **深刻度**: 中
- **該当箇所**: セクション3（アーキテクチャ）Alert Service、セクション1（主要機能）異常値アラート通知
- **問題の説明**: Alert Serviceが「異常値を検知し、Pub/Sub経由で通知」と記載されているが、WebSocket Serverがバイタルデータを受信してから通知が医療スタッフに届くまでのレイテンシ要件が定義されていない。5000台のデバイスから同時にデータが到着する場合、Alert Serviceの処理がボトルネックとなり、緊急性の高いアラートが遅延する可能性がある。
- **検出判定基準**:
  - ○（検出）: アラート処理のレイテンシ要件の欠如を指摘し、優先度キューまたはストリーム処理の導入を提案している
  - △（部分検出）: アラート処理の高速化に言及しているが、具体的な設計提案はない
  - ×（未検出）: アラート処理の遅延リスクに言及していない

### P09: バイタルデータ書き込みの並行制御欠如
- **カテゴリ**: 並行処理、データベース設計
- **深刻度**: 軽微
- **該当箇所**: セクション3（データフロー）3番、セクション7（非機能要件）パフォーマンス目標
- **問題の説明**: 5000レコード/秒の書き込みスループット要件があるが、WebSocket Serverからの同時書き込みに対する並行制御戦略（バッチ挿入、バルクインサート、コネクションプール設定）が明示されていない。単純な個別INSERTでは、データベースへのコネクション数が枯渇し、スループット目標を達成できない可能性がある。
- **検出判定基準**:
  - ○（検出）: バイタルデータのバッチ挿入またはバルクインサートの必要性を指摘し、コネクションプール設計を提案している
  - △（部分検出）: データベース書き込みの最適化に言及しているが、バッチ処理やコネクションプール設計には触れていない
  - ×（未検出）: バイタルデータ書き込みの並行制御に言及していない

### P10: CloudWatch監視メトリクスの設計欠如
- **カテゴリ**: 監視、パフォーマンス要件
- **深刻度**: 軽微
- **該当箇所**: セクション6（実装方針）ロギング、セクション7（非機能要件）パフォーマンス目標
- **問題の説明**: ログ出力方針は記載されているが、パフォーマンス目標（API応答時間95パーセンタイル500ms以下、スループット5000レコード/秒）を継続的に監視するためのメトリクス収集設計が欠如している。SLO達成状況の可視化やアラート設定ができず、パフォーマンス劣化の早期検知が困難。
- **検出判定基準**:
  - ○（検出）: パフォーマンスメトリクス（レイテンシ、スループット、エラー率）の収集・監視の必要性を指摘し、CloudWatch Metricsやカスタムメトリクス設計を提案している
  - △（部分検出）: 監視の重要性に言及しているが、具体的なメトリクス項目を提案していない
  - ×（未検出）: パフォーマンス監視に言及していない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | キャッシュ | デバイス情報やアラートルールのキャッシュ戦略の提案 | Redis等のキャッシュ導入を具体的に提案している |
| B02 | API設計 | バイタルデータ取得APIのGraphQL化またはフィールド選択機能の提案 | 不要なデータ転送の削減を目的とした柔軟なクエリ設計を提案 |
| B03 | データベース設計 | 読み取り専用クエリのリードレプリカ活用の明示的提案 | セクション7で言及されているリードレプリカの具体的な活用シナリオを提案 |
| B04 | 並行処理 | WebSocketメッセージ処理の非同期化（メッセージキュー活用） | KafkaやRabbitMQを用いたメッセージバッファリング設計を提案 |
| B05 | スケーラビリティ | WebSocket Serverのステートレス化とセッション管理戦略 | Redisベースのセッションストアやスティッキーセッション設計を提案 |
| B06 | レイテンシ設計 | CloudFrontエッジロケーションの活用によるダッシュボード配信高速化 | 静的アセットのCDN配信戦略を提案 |
| B07 | データベース設計 | vital_dataテーブルのHypertable化（TimescaleDB拡張）の提案 | 時系列データ専用の最適化手法を提案 |
| B08 | 並行処理 | ECSタスク数の自動スケーリング基準の詳細化 | CPU以外のメトリクス（WebSocket接続数、キュー長）に基づくスケーリング戦略を提案 |
| B09 | I/O効率 | レポート生成のプリコンピューテーション（集計テーブル）戦略 | マテリアライズドビューや集計テーブルによる事前計算を提案 |
| B10 | データベース設計 | データベースコネクションプールのサイジング計算の提案 | スループット要件からの理論値計算や監視項目を提案 |
