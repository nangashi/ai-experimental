# 正解キー

## 実行条件
- **観点**: performance
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: N+1問題の発生
- **カテゴリ**: I/O・ネットワーク効率
- **深刻度**: 重大
- **該当箇所**: セクション5（API設計） - GET /api/dashboard/floor/{floor_id}
- **問題の説明**: ダッシュボードAPIでフロア情報とセンサー情報を取得する際、フロアに対して個別にセンサーをループ取得する設計になっている。センサー数が多いフロアでは、1フロアあたりN回のクエリが発生し、レスポンスタイムが劣化する。
- **検出判定基準**:
  - ○（検出）: ダッシュボードAPIまたはフロア別データ取得において「N+1問題」または「JOIN/EAGER LOADINGの欠如」を指摘し、センサー情報の一括取得（JOIN、サブクエリ、バッチロード）を提案している
  - △（部分検出）: データ取得の非効率性を指摘しているが、N+1問題の具体的な言及がなく、一括取得の提案がない
  - ×（未検出）: 指摘なし

### P02: 時系列データのインデックス設計の欠如
- **カテゴリ**: データベース設計
- **深刻度**: 重大
- **該当箇所**: セクション4（データモデル） - SensorDataテーブル
- **問題の説明**: SensorDataテーブルは1分間隔でデータが蓄積され、大量データとなる。timestampやsensor_idでの絞り込みクエリが頻発するが、インデックス設計が明記されていない。特に時系列データのレンジクエリに対する最適化（複合インデックス、パーティショニング）が考慮されていない。
- **検出判定基準**:
  - ○（検出）: SensorDataテーブルに対して「インデックス設計の欠如」または「(sensor_id, timestamp)の複合インデックスの必要性」を指摘し、時系列データのクエリ最適化（インデックス、パーティショニング、TimescaleDB等の時系列DB検討）を提案している
  - △（部分検出）: インデックスの必要性を指摘しているが、時系列データの特性に触れていない、またはパーティショニング戦略の言及がない
  - ×（未検出）: 指摘なし

### P03: キャッシュ戦略の欠如
- **カテゴリ**: キャッシュ戦略
- **深刻度**: 重大
- **該当箇所**: セクション3（アーキテクチャ設計） - ダッシュボードAPI
- **問題の説明**: ダッシュボード表示は頻繁にアクセスされ、かつ1分間隔でデータ更新されるため、毎回DBクエリを実行するとDB負荷が高まる。Redisはセッション管理とCeleryブローカーにのみ使われており、センサーデータやダッシュボード表示用のキャッシュ戦略が設計されていない。
- **検出判定基準**:
  - ○（検出）: ダッシュボードAPIまたはセンサーデータ取得において「キャッシュ戦略の欠如」を指摘し、Redisを活用したキャッシング（TTL設定、無効化戦略）を提案している
  - △（部分検出）: キャッシュの必要性を指摘しているが、具体的なキャッシュ対象データやTTL戦略の言及がない
  - ×（未検出）: 指摘なし

### P04: データ量増加に対する容量設計の欠如
- **カテゴリ**: スケーラビリティ
- **深刻度**: 中
- **該当箇所**: セクション7（非機能要件） - データ保持期間
- **問題の説明**: センサーデータは1分間隔で蓄積され、1年間保持する。センサー数が100台、データポイントが4種（温度、湿度、CO2、占有）とすると、年間約2億レコードとなる。このデータ増加に対する容量見積もり（ストレージサイズ、クエリパフォーマンスへの影響）が設計書に含まれていない。
- **検出判定基準**:
  - ○（検出）: データ保持期間とセンサーデータ量に対して「データ量増加の容量見積もりの欠如」を指摘し、ストレージ容量計画、古いデータのアーカイブ戦略、またはデータ圧縮を提案している
  - △（部分検出）: データ量増加の懸念を指摘しているが、具体的な容量見積もりやアーカイブ戦略の提案がない
  - ×（未検出）: 指摘なし

### P05: レポート生成の同期処理リスク
- **カテゴリ**: 並行処理
- **深刻度**: 中
- **該当箇所**: セクション3（アーキテクチャ設計） - レポート生成サービス
- **問題の説明**: レポート生成はCeleryタスクで非同期化されているが、Celeryタスク内でのデータ集計処理（PostgreSQL集計、PDF生成）が同期的に実行される設計。月次レポートなど大量データを集計する場合、タスク実行時間が長時間化し、Celeryワーカーのリソースを長時間占有する。
- **検出判定基準**:
  - ○（検出）: レポート生成処理において「大量データ集計の同期処理によるタスク長時間化」を指摘し、バッチ処理の分割、並列集計、またはプリ集計テーブルの活用を提案している
  - △（部分検出）: レポート生成の負荷を指摘しているが、具体的な処理分割や並列化の提案がない
  - ×（未検出）: 指摘なし

### P06: 大量データテーブルの読み書き分離設計の欠如
- **カテゴリ**: データベース設計
- **深刻度**: 中
- **該当箇所**: セクション2（技術スタック） - データベース
- **問題の説明**: SensorDataテーブルは書き込みが頻繁（1分間隔×全センサー）で、かつダッシュボード表示やレポート生成で読み込みも多い。PostgreSQL単一インスタンスで読み書きを処理する設計では、書き込み負荷と読み込み負荷が競合し、レスポンスタイムが劣化する可能性がある。
- **検出判定基準**:
  - ○（検出）: データベース構成において「読み書き分離の欠如」を指摘し、リードレプリカの活用、CQRS、またはレポート用データウェアハウスの検討を提案している
  - △（部分検出）: データベース負荷を指摘しているが、読み書き分離の具体的な提案がない
  - ×（未検出）: 指摘なし

### P07: スケーリング方針の限定性
- **カテゴリ**: スケーラビリティ
- **深刻度**: 中
- **該当箇所**: セクション7（非機能要件） - スケーリング方針
- **問題の説明**: スケーリング方針が垂直スケーリング（インスタンスサイズ拡大）のみで、水平スケーリング（インスタンス数増加）が考慮されていない。ビル数やセンサー数が増加した際、垂直スケーリングには限界があり、将来的なスケールアウトの設計指針がないとシステムのボトルネックとなる。
- **検出判定基準**:
  - ○（検出）: スケーリング方針において「水平スケーリングの欠如」または「ステートレス設計の必要性」を指摘し、ロードバランサーの活用、セッション外部化、またはステートレスアーキテクチャを提案している
  - △（部分検出）: スケーリングの限界を指摘しているが、水平スケーリングの具体的な提案がない
  - ×（未検出）: 指摘なし

### P08: データバリデーション処理のパフォーマンス考慮不足
- **カテゴリ**: アルゴリズム・データ構造の効率性
- **深刻度**: 軽微
- **該当箇所**: セクション3（アーキテクチャ設計） - データ収集API
- **問題の説明**: POST /api/sensors/dataで複数センサー分のデータを一括受信するが、バリデーション処理（Pydantic）を各レコードに個別適用する実装の場合、大量データ投入時にCPU負荷が高まる。バリデーションの並列化やバッチバリデーションの考慮がない。
- **検出判定基準**:
  - ○（検出）: データ収集APIのバリデーション処理において「大量データのバリデーションによるCPU負荷」を指摘し、バリデーションの並列化、バッチ処理、またはスキーマ検証の最適化を提案している
  - △（部分検出）: バリデーションの負荷を指摘しているが、具体的な最適化手法の提案がない
  - ×（未検出）: 指摘なし

### P09: パフォーマンス監視設計の欠如
- **カテゴリ**: 監視
- **深刻度**: 軽微
- **該当箇所**: セクション7（非機能要件） - パフォーマンス目標
- **問題の説明**: パフォーマンス目標（API応答時間500ms以下、ダッシュボード初期表示2秒以内）が定義されているが、これらを継続的に監視・測定する仕組みが設計されていない。APM（Application Performance Monitoring）ツールやメトリクス収集の設計が欠如している。
- **検出判定基準**:
  - ○（検出）: パフォーマンス目標に対して「パフォーマンス監視設計の欠如」を指摘し、APMツール（DataDog, New Relic, Prometheus等）、メトリクス収集、アラート設定を提案している
  - △（部分検出）: 監視の必要性を指摘しているが、具体的なAPMツールやメトリクスの提案がない
  - ×（未検出）: 指摘なし

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | スケーラビリティ | センサーデータ登録のバッチAPI設計がないことの指摘 | センサーデータ登録APIにおいて、複数センサーの一括登録の最適化（バルクインサート、トランザクション最適化）を提案している |
| B02 | キャッシュ戦略 | フロア情報やセンサーマスタのキャッシュ欠如 | 頻繁に参照されるマスタデータ（floors, sensors）に対するキャッシュ戦略を提案している |
| B03 | データベース設計 | SensorDataテーブルのパーティショニング戦略の提案 | SensorDataテーブルに対して、日次または月次パーティショニング、またはTimescaleDBのようなハイパーテーブルの活用を提案している |
| B04 | レイテンシ・スループット設計 | API応答時間目標の妥当性検証不足の指摘 | API応答時間500ms以下の目標が、予想されるデータ量やクエリ複雑度に対して現実的かどうかの検証が不足していることを指摘している |
| B05 | メモリ・リソース管理 | コネクションプール設定の未記載 | PostgreSQLコネクションプールの設計（最大接続数、タイムアウト設定）が設計書に含まれていないことを指摘している |
