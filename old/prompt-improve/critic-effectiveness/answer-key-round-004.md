# 正解キー - Round 004

## 実行条件
- **観点**: critic-effectiveness（有効性評価）
- **対象**: design（システム設計書）
- **埋め込み問題数**: 10問

---

## 埋め込み問題一覧

### P01: JWT認証トークンのlocalStorage保存
- **カテゴリ**: Security / Credential Management
- **深刻度**: 重大
- **該当箇所**: セクション5.2（認証・認可）、行118
- **問題の説明**: JWTトークンをlocalStorageに保存している。localStorageはJavaScriptから自由にアクセス可能であり、XSS攻撃によってトークンが盗まれるリスクが高い。金融取引を扱うシステムでは、不正アクセスによる送金や決済の被害が発生する可能性がある。httpOnly・Secure属性付きCookieの使用が推奨される。
- **検出判定基準**:
  - ○（検出）: JWTのlocalStorage保存がXSS脆弱性を引き起こすことを指摘し、httpOnly Cookieなどの代替策を提案している
  - △（部分検出）: localStorageの使用リスクに言及しているが、具体的な攻撃シナリオや代替策が不明確
  - ×（未検出）: JWT保存方法の問題を指摘していない

### P02: SMS OTPの再送回数制限欠如
- **カテゴリ**: Security / Authentication
- **深刻度**: 中
- **該当箇所**: セクション5.2（認証・認可）、行117
- **問題の説明**: SMS OTPの実装で「6桁、有効期限3分」と記載されているが、再送回数の制限が明記されていない。無制限に再送可能な場合、攻撃者がブルートフォース攻撃（総当たり）でOTPを推測するリスクがある（6桁=100万通り）。1時間あたりの再送回数制限（例: 3回まで）の設定が必要。
- **検出判定基準**:
  - ○（検出）: SMS OTP再送回数の制限欠如を指摘し、ブルートフォース攻撃リスクへの言及がある
  - △（部分検出）: OTPのセキュリティ強化に言及しているが、再送制限の具体的な必要性が不明確
  - ×（未検出）: SMS OTPの問題を指摘していない

### P03: 決済キャンセルAPIの認可設計不明瞭
- **カテゴリ**: Security / Authorization
- **深刻度**: 重大
- **該当箇所**: セクション5.1（エンドポイント一覧）、行110
- **問題の説明**: `POST /payments/cancel` の認可設計が明記されていない。誰が（ユーザー本人のみか、加盟店も可能か、管理者のみか）どの条件でキャンセル可能かが不明確。不適切な実装の場合、第三者が他人の決済をキャンセルする権限昇格攻撃（Privilege Escalation）のリスクがある。
- **検出判定基準**:
  - ○（検出）: 決済キャンセルAPIの認可設計が不明確であることを指摘し、権限昇格リスクや本人確認の必要性に言及している
  - △（部分検出）: APIの認可に関する改善提案があるが、キャンセル操作の具体的なリスクへの言及がない
  - ×（未検出）: 決済キャンセルAPIの問題を指摘していない

### P04: 決済リトライの冪等性保証欠如
- **カテゴリ**: Reliability / Data Consistency
- **深刻度**: 重大
- **該当箇所**: セクション6.1（エラーハンドリング）、行125
- **問題の説明**: 外部API呼び出しに3回リトライを実施するとあるが、冪等性（Idempotency）の保証手段が明記されていない。ネットワークタイムアウト後のリトライで同一決済が重複実行され、ユーザーから二重請求される可能性がある。Idempotency Key（一意キー）を用いた重複防止機構が必須。
- **検出判定基準**:
  - ○（検出）: リトライ処理における冪等性保証の欠如を指摘し、Idempotency Keyなどの重複防止手段を提案している
  - △（部分検出）: リトライの問題に言及しているが、冪等性や二重決済リスクへの言及がない
  - ×（未検出）: リトライ処理の問題を指摘していない

### P05: 楽観的ロックの競合検出後処理が不明確
- **カテゴリ**: Reliability / Concurrency Control
- **深刻度**: 中
- **該当箇所**: セクション4.2（データ整合性）、行92
- **問題の説明**: 「楽観的ロック（version列）を使用」とあるが、バージョン競合が発生した場合の処理方針が明記されていない。自動リトライするのか、ユーザーにエラーを返すのか、最大リトライ回数はいくつかが不明。残高更新の競合が頻発する場合、ユーザー体験が悪化する可能性がある。
- **検出判定基準**:
  - ○（検出）: 楽観的ロックの競合発生時の処理方針が不明確であることを指摘し、リトライ戦略やユーザー体験への影響に言及している
  - △（部分検出）: 楽観的ロックの課題に言及しているが、具体的な処理方針の必要性が不明確
  - ×（未検出）: 楽観的ロックの問題を指摘していない

### P06: 災害復旧の手動切り替えとSLA目標の矛盾
- **カテゴリ**: Reliability / Disaster Recovery
- **深刻度**: 中
- **該当箇所**: セクション7.3（可用性・スケーラビリティ）、行145、セクション8.3（災害復旧計画）、行157
- **問題の説明**: 「SLA 99.9%（月間ダウンタイム43分以内）」と「災害復旧RTO 2時間（手動切り替え）」が矛盾している。手動切り替えで2時間のダウンタイムが発生すると、月間SLAを大幅に超過する。Multi-Region自動フェイルオーバーの導入、またはSLA目標値の再検討が必要。
- **検出判定基準**:
  - ○（検出）: 手動DR切り替えとSLA目標の定量的矛盾を指摘し、自動フェイルオーバーの必要性を提案している
  - △（部分検出）: DR方式の改善に言及しているが、SLA目標との定量的矛盾への言及がない
  - ×（未検出）: 災害復旧とSLAの矛盾を指摘していない

### P07: エラーメッセージの過度な情報隠蔽
- **カテゴリ**: Consistency / User Experience
- **深刻度**: 軽微
- **該当箇所**: セクション6.1（エラーハンドリング）、行127
- **問題の説明**: 「ユーザーへのエラーメッセージは詳細情報を含めず」とあるが、全てのエラーを「エラーが発生しました」で統一するのは過度な情報隠蔽。ユーザーが自己解決可能なエラー（残高不足、カード期限切れ、入力形式エラー）は具体的なメッセージを返すべき。セキュリティリスクのあるエラー（認証失敗の詳細等）のみを隠蔽する方針が適切。
- **検出判定基準**:
  - ○（検出）: エラーメッセージの過度な隠蔽がユーザー体験を損なうことを指摘し、エラー種別に応じた情報公開レベルの使い分けを提案している
  - △（部分検出）: エラーメッセージの改善に言及しているが、過度な隠蔽の問題やユーザー体験への影響が不明確
  - ×（未検出）: エラーメッセージ方針の問題を指摘していない

### P08: 監査ログのフィールド不足
- **カテゴリ**: Consistency / Audit Logging
- **深刻度**: 中
- **問題の説明**: セクション6.2（ロギング方針）、行130-131
- **該当箇所**: 監査ログに「トランザクションID、ユーザーID、金額、タイムスタンプ」のみが記録され、セキュリティ調査に必要な情報が不足している。具体的には、IPアドレス、User-Agent、取引元/取引先（送金の場合）、承認/拒否理由、API呼び出し元（Web/Mobile/API）が欠けている。不正取引の事後調査で情報不足により原因特定が困難になる可能性がある。
- **検出判定基準**:
  - ○（検出）: 監査ログに不足している具体的なフィールド（IPアドレス、取引先情報等）を列挙し、不正調査への影響を説明している
  - △（部分検出）: 監査ログの改善に言及しているが、具体的な不足フィールドが不明確
  - ×（未検出）: 監査ログの問題を指摘していない

### P09: パフォーマンステスト方針の欠如
- **カテゴリ**: Best Practices / Testing Strategy
- **深刻度**: 軽微
- **該当箇所**: セクション6.3（テスト方針）、行136-138
- **問題の説明**: 単体テスト、統合テスト、E2Eテストは定義されているが、負荷テスト・ストレステストの方針が明記されていない。セクション7.1で「500 TPS」「5000同時接続」という性能目標が定義されているにもかかわらず、これらを検証するテスト計画がない。本番リリース前にパフォーマンスボトルネックを発見できないリスクがある。
- **検出判定基準**:
  - ○（検出）: パフォーマンステストの欠如を指摘し、性能目標（TPS、同時接続数）との関連を説明している
  - △（部分検出）: テスト種別の追加に言及しているが、性能目標との紐付けが不明確
  - ×（未検出）: テスト方針の不足を指摘していない

### P10: Auto Scalingのスケールイン条件欠如
- **カテゴリ**: Performance / Resource Optimization
- **深刻度**: 軽微
- **該当箇所**: セクション7.3（可用性・スケーラビリティ）、行144
- **問題の説明**: 「CPU使用率70%でPod数を増加」というスケールアウト条件は明記されているが、スケールイン（縮小）条件が定義されていない。負荷が減少してもPod数が減らない場合、過剰なリソース確保によるコスト増大が発生する。スケールイン条件（例: CPU 30%を10分間下回る）の設定が必要。
- **検出判定基準**:
  - ○（検出）: スケールイン条件の欠如を指摘し、コスト最適化の観点から縮小ポリシーの必要性を説明している
  - △（部分検出）: Auto Scalingの改善に言及しているが、スケールイン欠如の具体的な問題への言及がない
  - ×（未検出）: Auto Scalingの問題を指摘していない

---

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | Security / Encryption | 通信時暗号化（TLS 1.3）の記載はあるが、PostgreSQL内の保存時暗号化（Encryption at Rest）への言及がない。クレジットカードトークンや個人情報の暗号化保存が推奨される | 保存時暗号化の欠如を指摘し、RDS暗号化やKMS利用を提案している |
| B02 | Security / Rate Limiting | レート制限は設定されているが、送金APIの「10 req/min」が妥当か検証が必要。正当な利用でも超過する可能性がある。また、IPベース制限の追加が望ましい | レート制限値の妥当性検証やIP制限の追加を提案している |
| B03 | Reliability / Circuit Breaker | Resilience4jでサーキットブレーカーを使用する記載があるが、具体的な閾値（失敗率、タイムアウト時間）が定義されていない | サーキットブレーカーの設定値（閾値、タイムアウト等）の明記を推奨している |
| B04 | Reliability / Monitoring | 「DB接続プールの枯渇」をアラート条件に含めているが、接続プールの初期サイズ・最大サイズの設計値が記載されていない | DB接続プールの設計パラメータの明記を推奨している |
| B05 | Performance / Database Indexing | transactionsテーブルのwallet_id、type、statusはクエリで頻繁に使用されるが、インデックス設計への言及がない | トランザクション検索のためのインデックス設計の必要性を指摘している |
| B06 | Consistency / API Versioning | APIエンドポイントにバージョニング戦略（/v1/payments等）への言及がない。将来的なAPI変更時の後方互換性維持が困難 | APIバージョニング戦略の欠如を指摘している |
| B07 | Security / Session Management | Refresh Token有効期限7日間の記載はあるが、無効化（ログアウト、パスワード変更時）の処理方針が不明確 | Refresh Tokenの無効化処理の明記を推奨している |
| B08 | Best Practices / Feature Flags | Blue-Green Deploymentは記載されているが、段階的リリース（Feature Flags、カナリアリリース）への言及がない | 段階的リリース戦略の追加を提案している |
