# 正解キー - Round 003

## 実行条件
- **観点**: critic-effectiveness（有効性評価）
- **対象**: design（システム設計書）
- **埋め込み問題数**: 10問

---

## 埋め込み問題一覧

### P01: JWT認証トークンの脆弱な保存方法
- **カテゴリ**: Security / Credential Management
- **深刻度**: 重大
- **該当箇所**: セクション5.2（認証・認可）、行89-91
- **問題の説明**: JWTトークンをlocalStorageに保存している。localStorageはJavaScriptから自由にアクセス可能であり、XSS攻撃によってトークンが盗まれるリスクが高い。医療データを扱うシステムでは致命的なセキュリティホール。
- **検出判定基準**:
  - ○（検出）: JWTのlocalStorage保存がXSS脆弱性を引き起こすことを指摘し、httpOnly Cookieなどの代替策を提案している
  - △（部分検出）: localStorageの使用に言及しているが、具体的なリスクや代替策が不明確
  - ×（未検出）: JWT保存方法の問題を指摘していない

### P02: 患者データの暗号化欠如
- **カテゴリ**: Security / Encryption
- **深刻度**: 重大
- **該当箇所**: セクション7.2（セキュリティ要件）、行174-175
- **問題の説明**: 「患者データは暗号化せずにRDS上に保存（VPC内なので問題ない）」という誤った設計判断。VPCは外部からの不正アクセスを防ぐが、内部者による不正アクセスや設定ミス、バックアップデータの漏洩には無力。HIPAA等の医療情報保護規制では保存時の暗号化（Encryption at Rest）が必須。
- **検出判定基準**:
  - ○（検出）: 保存時暗号化の欠如を指摘し、RDS暗号化やKMS利用などの対策を提案している
  - △（部分検出）: 暗号化の必要性に言及しているが、VPC内保存の誤謬や法令要件への言及がない
  - ×（未検出）: データ暗号化の問題を指摘していない

### P03: 手動スケーリングの非効率性
- **カテゴリ**: Performance / Scalability
- **深刻度**: 中
- **該当箇所**: セクション7.3（可用性・スケーラビリティ）、行185
- **問題の説明**: 「CPU使用率が70%を超えたら手動でタスク数を増やす」は、リアルタイムバイタルモニタリングシステムとして不適切。急激な負荷増加時に手動対応では遅延が発生し、患者の緊急アラートが遅れる可能性がある。ECS Auto Scalingによる自動スケーリング設定が必須。
- **検出判定基準**:
  - ○（検出）: 手動スケーリングのリスクを指摘し、Auto Scalingポリシーの設定を推奨している
  - △（部分検出）: スケーリングの改善に言及しているが、リアルタイム性要件との関連が不明確
  - ×（未検出）: スケーリング方式の問題を指摘していない

### P04: 手動フェイルオーバーの可用性リスク
- **カテゴリ**: Reliability / Fault Tolerance
- **深刻度**: 重大
- **該当箇所**: セクション7.3（可用性・スケーラビリティ）、行184
- **問題の説明**: 「障害時は手動でフェイルオーバー実施」という設計は、SLA 99.5%の目標と矛盾。手動フェイルオーバーは検知から復旧まで30分〜数時間を要するため、年間ダウンタイム目標43.8時間を達成できない。RDS Multi-AZの自動フェイルオーバー（1〜2分）を活用すべき。
- **検出判定基準**:
  - ○（検出）: 手動フェイルオーバーとSLA目標の矛盾を指摘し、自動フェイルオーバーの必要性を提案している
  - △（部分検出）: フェイルオーバー方式の改善に言及しているが、SLA目標との定量的矛盾に触れていない
  - ×（未検出）: フェイルオーバー方式の問題を指摘していない

### P05: 不十分なデバイス通信途絶検知
- **カテゴリ**: Reliability / Monitoring
- **深刻度**: 中
- **該当箇所**: セクション7.4（監視・アラート）、行190
- **問題の説明**: 「デバイスの通信途絶は5分後に検知」は、バイタルモニタリングシステムとして遅すぎる。心停止などの緊急事態では1分以内の検知が必要。デバイスハートビート間隔を短縮（15〜30秒）し、2回連続失敗で即座にアラートを発報すべき。
- **検出判定基準**:
  - ○（検出）: 5分検知の遅延リスクを指摘し、より短い間隔（1分以内）の推奨や緊急性との関連を説明している
  - △（部分検出）: 検知時間の短縮に言及しているが、具体的な推奨値や医療要件への言及がない
  - ×（未検出）: 通信途絶検知時間の問題を指摘していない

### P06: InfluxDBバックアップの頻度不足
- **カテゴリ**: Reliability / Data Consistency
- **深刻度**: 中
- **該当箇所**: セクション8.2（データバックアップ）、行199
- **問題の説明**: InfluxDBの週次手動バックアップは、RPO 24時間の要件（セクション8.3）を満たせない。週次バックアップではデータ損失が最大7日分発生する。また、手動運用はヒューマンエラーのリスクが高い。日次自動バックアップへの変更が必要。
- **検出判定基準**:
  - ○（検出）: 週次バックアップとRPO要件の矛盾を指摘し、日次自動バックアップを推奨している
  - △（部分検出）: バックアップ頻度の改善に言及しているが、RPO要件との矛盾に触れていない
  - ×（未検出）: InfluxDBバックアップの問題を指摘していない

### P07: 監査ログフォーマットの不完全性
- **カテゴリ**: Consistency / Documentation Completeness
- **深刻度**: 中
- **該当箇所**: セクション8.1（監査ログ）、行193-194
- **問題の説明**: 監査ログフォーマット `{timestamp, userId, action, resource, result}` には、セキュリティ監査に必要な情報が不足している。具体的には、IPアドレス、User-Agent、セッションID、変更前後の値（データ変更の場合）、失敗理由（エラー時）などが欠けている。医療情報システムの監査要件（HIPAA等）を満たせない。
- **検出判定基準**:
  - ○（検出）: 監査ログに不足している具体的なフィールド（IPアドレス、変更履歴等）を列挙し、法令要件への言及がある
  - △（部分検出）: ログフォーマットの改善に言及しているが、具体的な不足フィールドが不明確
  - ×（未検出）: 監査ログフォーマットの問題を指摘していない

### P08: エラーハンドリング方針の曖昧性
- **カテゴリ**: Consistency / Error Handling
- **深刻度**: 軽微
- **該当箇所**: セクション6.1（エラーハンドリング方針）、行130-132
- **問題の説明**: 「共通のエラーレスポンス形式を使用」と記載されているが、具体的な形式（ステータスコード体系、エラーコード、メッセージ構造）が定義されていない。また、IoTゲートウェイ（FastAPI）側のエラーハンドリング方針も明記されていない。サービス間で一貫性のあるエラー処理の実装が困難。
- **検出判定基準**:
  - ○（検出）: エラーレスポンス形式の具体化不足と、複数サービス間の整合性が取れていない点を指摘している
  - △（部分検出）: エラーハンドリングの不明瞭さに言及しているが、サービス間整合性への言及がない
  - ×（未検出）: エラーハンドリング方針の問題を指摘していない

### P09: テスト方針におけるパフォーマンステストの欠如
- **カテゴリ**: Best Practices / Testing Strategy
- **深刻度**: 軽微
- **該当箇所**: セクション6.3（テスト方針）、行138-140
- **問題の説明**: 単体テスト、統合テスト、E2Eテストは定義されているが、パフォーマンステストと負荷テストの方針が明記されていない。セクション7.1で「APIレスポンス95%ile < 200ms」「同時接続500人」という性能要件が定義されているにもかかわらず、これらを検証するテスト計画がない。
- **検出判定基準**:
  - ○（検出）: パフォーマンステストの欠如を指摘し、性能要件との関連を説明している
  - △（部分検出）: テスト種別の追加に言及しているが、性能要件との紐付けが不明確
  - ×（未検出）: テスト方針の不足を指摘していない

### P10: DR環境未構築とRTO/RPO目標の矛盾
- **カテゴリ**: Reliability / Disaster Recovery
- **深刻度**: 軽微（設計時点では制約として許容される場合がある）
- **該当箇所**: セクション8.3（災害復旧計画）、行201-203
- **問題の説明**: RTO 4時間、RPO 24時間という災害復旧目標が定義されているが、「DR環境は未構築（予算制約）」と記載されており、目標達成が不可能。予算制約が実在する場合でも、代替策（マルチリージョンバックアップの検討、復旧手順書の整備等）やリスク受容の明示が必要。
- **検出判定基準**:
  - ○（検出）: DR環境未構築による目標未達成を指摘し、代替策やリスク受容の明示を推奨している
  - △（部分検出）: DR環境の必要性に言及しているが、リスク管理の観点が不明確
  - ×（未検出）: DR計画の矛盾を指摘していない

---

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | Security | デバイス認証にX.509証明書を使用しているが、証明書の更新・失効管理（CRL/OCSP）の方針が未定義 | 証明書ライフサイクル管理の欠如を指摘 |
| B02 | Performance | Kafka Streamsによるリアルタイム処理が記載されているが、ストリーム処理の状態管理やウィンドウサイズが未定義 | ストリーム処理の詳細設計不足を指摘 |
| B03 | Consistency | PostgreSQLとInfluxDBの2つのDBを使用しているが、トランザクション境界やデータ整合性の保証方法が不明 | 分散データ整合性の考慮不足を指摘 |
| B04 | Security | API認証にロールベース制御（RBAC）を使用しているが、細かいリソースレベルのアクセス制御（患者ごとのアクセス権限等）が未定義 | きめ細かいアクセス制御の欠如を指摘 |
| B05 | Reliability | メッセージキューとしてKafkaを使用しているが、メッセージ配信保証（at-least-once/exactly-once）やパーティション設計が未定義 | メッセージング信頼性設計の不足を指摘 |
| B06 | Structural Quality | アーキテクチャ図に複数サービスが記載されているが、サービス間通信の失敗時のリトライ戦略やタイムアウト設定が未定義 | サービス間通信の堅牢性考慮不足を指摘 |
| B07 | Performance | InfluxDBへの書き込みがバッチ処理と記載されているが、バッチサイズやフラッシュ間隔が未定義で性能影響が不明 | バッチ処理の詳細設計不足を指摘 |
| B08 | Consistency | ログ出力に「患者IDや医療データはマスキング」と記載されているが、マスキングルールやPII（個人識別情報）の定義が不明確 | データマスキング方針の不明瞭さを指摘 |
