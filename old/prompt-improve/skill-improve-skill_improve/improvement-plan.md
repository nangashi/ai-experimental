# 改善計画: skill_improve

## 変更対象ファイル
| # | ファイル | 変更種別 | 変更概要 | 対応フィードバック |
|---|---------|---------|---------|------------------|
| 1 | SKILL.md | 修正 | Phase 2の{perspective}変数を明示列挙に変更、Phase 3/6の処理フロー明確化、ユーザー向け説明拡充 | S-C1, S-C2, S-C4, S-C5, S-I5, S-I6, S-I7, U-I1, U-I2, U-I3, U-I4, U-I5, U-I6, U-I7, E-I1, A-I2 |
| 2 | templates/verify-improvements.md | 修正 | details フィールドの書式を具体化 | S-C2 |
| 3 | templates/analyze-skill-structure.md | 修正 | ファイル読み込み優先順位の基準を改善 | S-I1 |
| 4 | templates/apply-improvements.md | 修正 | 「現在の記述」未記載時の処理を明記 | S-I4 |

## 各ファイルの変更詳細

### 1. SKILL.md（修正）

**対応フィードバック**:
- S-C1: 未定義の{perspective}変数
- S-C4: Phase 3 Step 2の未検出分岐が暗黙的
- S-C5: Phase 3 Step 3の判定不能時処理が不明確
- S-I5: {perspective}変数の値の明記
- S-I6: Phase 4「修正要望あり」時のEdit/Write明示
- S-I7: Phase 6「追加修正」時の既存セクション処理
- U-I1: Phase 4の一括承認パターン
- U-I2: Phase 2の失敗情報提示タイミング
- U-I3: Phase 6の再試行上限の数値明示
- U-I4: Phase 6のNEEDS_ATTENTION時の影響説明
- U-I5: Phase 5のStandard mode詳細出力
- U-I6: 使い方ドキュメントの概要不足
- U-I7: Phase 0のFast mode説明不足
- E-I1: Phase 3 Step 1の不要なファイル読み込み
- A-I2: Phase 3のレビューファイルRead失敗時の処理

**変更内容**:

- **変更箇所1（Line 5-16）**: 使い方セクションに期待される動作の概要を追加
  - 現在の記述:
```markdown
指定されたスキルを4つの品質観点（安定性・効率性・UX・アーキテクチャ）で並列レビューし、コンフリクト解決を経て改善を適用します。

## 使い方

```
/skill_improve <skill_path>
```

- `skill_path`: スキルディレクトリの絶対パスまたは相対パス（SKILL.md を含むディレクトリ）

未指定の場合は `AskUserQuestion` で確認してください。
```
  - 改善後の記述:
```markdown
指定されたスキルを4つの品質観点（安定性・効率性・UX・アーキテクチャ）で並列レビューし、コンフリクト解決を経て改善を適用します。

## 使い方

```
/skill_improve <skill_path>
```

- `skill_path`: スキルディレクトリの絶対パスまたは相対パス（SKILL.md を含むディレクトリ）

未指定の場合は `AskUserQuestion` で確認してください。

## 期待される動作

1. **Phase 0-1**: スキル構造を自動分析（約30秒）
2. **Phase 2**: 4つの観点で並列レビュー実行（約60秒）
3. **Phase 3**: コンフリクト検出・解決、フィードバック統合
4. **Phase 4**: 改善計画生成後、ユーザーが承認/修正要望/キャンセルを選択
5. **Phase 5-6**: 改善適用・検証（自動実行）
6. **Phase 7**: 完了サマリ出力

完了時に得られるもの:
- 分類済みフィードバック（`{work_dir}/findings.md`）
- 改善計画（`{work_dir}/improvement-plan.md`）
- 検証レポート（`{work_dir}/verification.md`）
- 変更が適用されたスキルファイル群
```

- **変更箇所2（Line 46-48）**: Fast mode の説明を具体化
  - 現在の記述:
```markdown
10. `AskUserQuestion` で実行モードを選択する:
   - **Standard（推奨）**: Phase 3 で全フィードバック詳細を確認できます
   - **Fast**: Phase 3 で全フィードバック詳細出力をスキップ（サマリのみ表示）。改善計画の承認は必須
```
  - 改善後の記述:
```markdown
10. `AskUserQuestion` で実行モードを選択する:
   - **Standard（推奨）**: Phase 3 で全フィードバック（重大な問題、改善提案、良い点）の詳細を確認できます
   - **Fast**: Phase 3 で全フィードバック詳細出力をスキップし、サマリのみ表示します（例: 重大3件、改善5件）。コンフリクトがある場合のみトレードオフ情報を提示します。Phase 4の改善計画承認は必須です
```

- **変更箇所3（Line 90-99）**: Phase 2のレビューアー列挙を明示化（{perspective}変数を展開）
  - 現在の記述:
```markdown
各レビューアーへのプロンプト:
```
`{skill_improve_path}/templates/reviewer-{perspective}.md` を Read で読み込み、その内容に従って処理を実行してください。
パス変数:
- {skill_path}: {値}
- {analysis_path}: {work_dir}/analysis.md の絶対パス
- {quality_criteria_path}: {skill_improve_path}/quality-criteria.md の絶対パス
- {findings_save_path}: {work_dir}/review-{perspective}.md の絶対パス
- {skill_name}: {値}
```
```
  - 改善後の記述:
```markdown
各レビューアーへのプロンプト（perspective の値: stability, efficiency, ux, architecture）:
```
`{skill_improve_path}/templates/reviewer-{perspective}.md` を Read で読み込み、その内容に従って処理を実行してください。
パス変数:
- {skill_path}: {値}
- {analysis_path}: {work_dir}/analysis.md の絶対パス
- {quality_criteria_path}: {skill_improve_path}/quality-criteria.md の絶対パス
- {findings_save_path}: {work_dir}/review-{perspective}.md の絶対パス
- {skill_name}: {値}
```

注: 4つのレビューアーそれぞれで上記プロンプトを使用し、{perspective} を stability, efficiency, ux, architecture に置き換える
```

- **変更箇所4（Line 106-109）**: Phase 2失敗時の情報提示を強化
  - 現在の記述:
```markdown
成功数が4未満の場合:
- 失敗したレビューアー名と失敗理由をテキスト出力する（Taskツールのエラー内容を含める）
- 成功数 ≥3 の場合: 「最低基準（3件）を満たしているため、続行します。」と出力し、Phase 3 へ進む
- 成功数 ≤2 の場合: AskUserQuestion で「レビューが{成功数}/4件のみ完了しました（失敗: {失敗レビューアー名}）。続行しますか？」と確認し、「続行」/「中止」の選択肢を提供する
```
  - 改善後の記述:
```markdown
成功数が4未満の場合:
- **必ず先に**失敗したレビューアー名と失敗理由をテキスト出力する（Taskツールのエラー内容を含める）
- 成功数 ≥3 の場合: 「最低基準（3件）を満たしているため、続行します。」と出力し、Phase 3 へ進む
- 成功数 ≤2 の場合: AskUserQuestion で「レビューが{成功数}/4件のみ完了しました（失敗: {失敗レビューアー名}）。続行しますか？」と確認し、「続行」/「中止」の選択肢を提供する
```

- **変更箇所5（Line 117-119）**: Phase 3 Step 1のファイル読み込み条件を最適化
  - 現在の記述:
```markdown
#### Step 1: フィードバック分類

Phase 2で保持されたサブエージェント返答サマリ（critical, improvement, positive の件数）から統計を構築する。コンフリクト検出が必要な場合のみ `{work_dir}/review-*.md` を Read で読み込む
```
  - 改善後の記述:
```markdown
#### Step 1: フィードバック分類

Phase 2で保持されたサブエージェント返答サマリ（critical, improvement, positive の件数）から統計を構築する。

**Read条件**: 重大な問題 + 改善提案の合計が2件以上の場合のみ、`{work_dir}/review-*.md` を Read で読み込む（コンフリクト検出のため）。0-1件の場合はStep 2-3をスキップしてStep 4へ進む。

**Read失敗時**: いずれかのレビューファイルのReadに失敗した場合は、コンフリクト検出をスキップしてStep 4へ進む。警告をテキスト出力: 「警告: レビューファイル読み込みに失敗したため、コンフリクト検出をスキップしました。」
```

- **変更箇所6（Line 126-137）**: Phase 3 Step 2のコンフリクト検出フローを明確化
  - 現在の記述:
```markdown
#### Step 2: コンフリクト検出

4件のレビュー結果を比較し、コンフリクトを検出する:
1. 各レビュー結果の「重大な問題」「改善提案」を対象ファイル:セクション でグループ化する
2. 同一箇所（ファイル+セクション/行番号が一致）に対する指摘を抽出する
3. 以下の相反パターンを検出する:
   - 削除 vs 追加
   - 簡略化 vs 詳細化
   - インライン化 vs テンプレート化
   - 確認削減 vs 確認追加
4. 検出したコンフリクト（あれば）を次ステップで解決する
5. 1-4の手順でコンフリクトが1件も検出されなかった場合、コンフリクト解決済みと判定する
```
  - 改善後の記述:
```markdown
#### Step 2: コンフリクト検出

4件のレビュー結果を比較し、コンフリクトを検出する:
1. 各レビュー結果の「重大な問題」「改善提案」を対象ファイル:セクション でグループ化する
2. 同一箇所（ファイル+セクション/行番号が一致）に対する指摘を抽出する
3. 以下の相反パターンを検出する:
   - 削除 vs 追加
   - 簡略化 vs 詳細化
   - インライン化 vs テンプレート化
   - 確認削減 vs 確認追加
4. 検出したコンフリクト（あれば）を次ステップで解決する
5. 1-4の手順でコンフリクトが1件も検出されなかった場合、コンフリクト解決済みと判定し、Step 4へ進む

**コンフリクトが1件以上検出された場合、Step 3でコンフリクト解決を実行する**
```

- **変更箇所7（Line 145-147）**: Phase 3 Step 3のユーザー選択後の処理を明記
  - 現在の記述:
```markdown
#### Step 3: コンフリクト解決（コンフリクトがある場合のみ）

判定基準ヒントに基づいて親が直接解決する。判定基準で解決できない場合のみ `AskUserQuestion` でユーザーにトレードオフを提示し選択してもらう。
```
  - 改善後の記述:
```markdown
#### Step 3: コンフリクト解決（コンフリクトがある場合のみ）

判定基準ヒントに基づいて親が直接解決する。判定基準で解決できない場合のみ `AskUserQuestion` でユーザーにトレードオフを提示し選択してもらう。

**ユーザー選択後の処理**: ユーザーが選択した提案を採用、競合する提案を却下した形で分類結果（重大な問題・改善提案）を更新し、Step 4へ進む。
```

- **変更箇所8（Line 183-188）**: Phase 4の承認プロセスを個別承認方式に変更
  - 現在の記述:
```markdown
**必須承認ポイント（Fast mode でも省略不可）**:

`{work_dir}/improvement-plan.md` を Read し全内容をテキスト出力後、`AskUserQuestion` で承認確認:
- **「全て承認」**: Phase 5 へ
- **「修正要望あり」**: AskUserQuestion で修正内容をテキスト入力で受け取り、improvement-plan.md の末尾に「## ユーザー追加修正」セクションを追加（Edit）し、修正内容と修正日時（YYYY-MM-DD HH:MM 形式）を記録した後、Phase 5 へ
- **「キャンセル」**: Phase 7 へ直行
```
  - 改善後の記述:
```markdown
**必須承認ポイント（Fast mode でも省略不可）**:

`{work_dir}/improvement-plan.md` を Read し全内容をテキスト出力後、以下の手順で承認を取得する:

1. 改善計画の「変更対象ファイル」セクションから各改善項目を抽出
2. 各改善項目に対して `AskUserQuestion` で個別承認:
   - 質問: 「改善 #{番号}: {ファイル名} - {変更概要}。この改善を適用しますか？」
   - 選択肢: 「承認」/「却下」/「修正要望」
   - 「修正要望」選択時: AskUserQuestion で修正内容をテキスト入力で受け取る
3. 全項目の確認完了後、却下された項目を改善計画から削除、修正要望があった項目は `improvement-plan.md` の末尾に「## ユーザー追加修正」セクションを追加（Edit）し、修正内容と修正日時（YYYY-MM-DD HH:MM 形式）を記録
4. 全項目が却下された場合: 「全ての改善が却下されました。」とテキスト出力し、Phase 7 へ直行
5. 1件以上承認された場合: Phase 5 へ進む

**スキップオプション**: 最初の個別承認確認時に「全て承認」/「キャンセル」の選択肢も提供:
- **「全て承認」**: 個別確認をスキップし、全項目を承認してPhase 5 へ
- **「キャンセル」**: Phase 7 へ直行
```

- **変更箇所9（Line 196-197）**: Phase 5の出力を実行モード別に明確化
  - 現在の記述:
```markdown
サブエージェント完了後、テキスト出力: `## Phase 5: 改善適用完了` + 返答内容。失敗時は AskUserQuestion で「Phase 5 が失敗しました: {エラー内容}。リトライしますか？」と確認し、「リトライ」/「中止」の選択肢を提供する。
```
  - 改善後の記述:
```markdown
サブエージェント完了後、以下をテキスト出力:
- テキスト出力: `## Phase 5: 改善適用完了`
- Standard mode: サブエージェント返答の全内容（modified, created, skipped, delete_recommended の詳細リスト）を出力
- Fast mode: サブエージェント返答のサマリのみ出力（件数のみ）

失敗時は AskUserQuestion で「Phase 5 が失敗しました: {エラー内容}。リトライしますか？」と確認し、「リトライ」/「中止」の選択肢を提供する。
```

- **変更箇所10（Line 212-216）**: Phase 6のNEEDS_ATTENTION時の処理を拡充
  - 現在の記述:
```markdown
- `verdict: NEEDS_ATTENTION`:
  - `{retry_count}` が 0: サブエージェント返答の details フィールドから未解決項目の全件（not_addressed + partial の詳細）を抜粋出力。AskUserQuestion で「このまま受け入れる」/「追加修正を実施」/「全変更を取り消す」を確認
    - 「追加修正」→ AskUserQuestion で「追加修正の方針を入力してください:」を確認、`{retry_count} = 1` とし improvement-plan.md に方針を追記後 Phase 5 に戻る
    - 「全変更取消」→ 「git checkout -- {skill_path} で復元可能」と出力し Phase 7 へ
  - `{retry_count}` ≥1: サブエージェント返答の details フィールドから未解決項目の全件を抜粋出力し Phase 7 へ（再試行上限に達しました）
```
  - 改善後の記述:
```markdown
- `verdict: NEEDS_ATTENTION`:
  - `{retry_count}` が 0:
    1. 影響説明をテキスト出力: 「未解決項目: {not_addressed + partial の件数}件、新規問題: {new_issues の件数}件」
    2. サブエージェント返答の details フィールドから未解決項目の全件（not_addressed + partial の詳細）とリグレッション（あれば）を抜粋出力
    3. AskUserQuestion で「このまま受け入れる」/「追加修正を実施」/「全変更を取り消す」を確認
       - 「追加修正」→ AskUserQuestion で「追加修正の方針を入力してください:」を確認、`{retry_count} = 1` とし、improvement-plan.md の末尾に「## 追加修正（retry #{retry_count}）」セクションを追加（Edit。既存の「追加修正」セクションがある場合は新規エントリとして番号付きで追記）し、方針と日時を記録後、Phase 5 に戻る
       - 「全変更取消」→ 「git checkout -- {skill_path} で復元可能」と出力し Phase 7 へ
  - `{retry_count}` ≥1:
    1. テキスト出力: 「再試行上限（1回）に達しました。」
    2. サブエージェント返答の details フィールドから未解決項目の全件を抜粋出力
    3. Phase 7 へ進む
```

### 2. templates/verify-improvements.md（修正）

**対応フィードバック**: S-C2: Phase 6返答フォーマット不明確

**変更内容**:

- **変更箇所1（Line 63-71）**: details フィールドの書式を具体化
  - 現在の記述:
```markdown
6. 以下のフォーマットで**サマリのみ**返答する:
```
resolved: {N}/{total}
partial: {N}
not_addressed: {N}
new_issues: {N}
verdict: PASS / NEEDS_ATTENTION
details: {未対応項目またはリグレッションがある場合にカンマ区切りで列挙（例: "C-1未対応, I-5部分的解決, リグレッション1件"）。なければ「none」}
```
```
  - 改善後の記述:
```markdown
6. 以下のフォーマットで**サマリのみ**返答する:
```
resolved: {N}/{total}
partial: {N}
not_addressed: {N}
new_issues: {N}
verdict: PASS / NEEDS_ATTENTION
details: {未対応項目またはリグレッションがある場合の詳細。書式: 項目ID（例: S-C1, E-I2）をカンマ区切りで列挙。部分的解決の場合は "(partial)" を付加。リグレッションがある場合は "regression:{N}件({概要})" を追加。なければ "none"}

例:
- details: S-C1未対応, E-I2(partial), regression:1件(外部参照追加)
- details: none
```
```

### 3. templates/analyze-skill-structure.md（修正）

**対応フィードバック**: S-I1: Phase 1の優先順位基準

**変更内容**:

- **変更箇所1（Line 15）**: ファイル読み込み優先順位の基準を改善
  - 現在の記述:
```markdown
2. 手順0で取得したファイルパスリストの各ファイルを Read で読み込む（20ファイル超の場合は SKILL.md を優先、templates/ ディレクトリが存在する場合はその内容を次に優先、残りはアルファベット順で先頭5ファイルのみ読み込む）
```
  - 改善後の記述:
```markdown
2. 手順0で取得したファイルパスリストの各ファイルを Read で読み込む（20ファイル超の場合は以下の優先順位で制限:
   1. SKILL.md（必須）
   2. templates/ ディレクトリ内の全ファイル（ワークフロー定義が多いため）
   3. 残りのファイルをファイルサイズ降順でソートし、上位5ファイルのみ読み込む）
```

### 4. templates/apply-improvements.md（修正）

**対応フィードバック**: S-I4: 二重適用チェックで「現在の記述」未記載時

**変更内容**:

- **変更箇所1（Line 29-30）**: 「現在の記述」未記載時の処理を追加
  - 現在の記述:
```markdown
## 変更適用ルール
- **二重適用チェック**: Edit 前に対象箇所の現在の内容が改善計画の「現在の記述」と一致するか確認する。一致しない場合（既に改善済みまたは別の変更あり）はその変更をスキップし、skipped リストに理由を記録する
```
  - 改善後の記述:
```markdown
## 変更適用ルール
- **二重適用チェック**: Edit 前に対象箇所の現在の内容が改善計画の「現在の記述」と一致するか確認する。
  - 改善計画に「現在の記述」が記載されていない場合: 警告をskippedリストに記録し、変更をスキップする（理由: 「改善計画に現在の記述なし、二重適用チェック不可」）
  - 一致しない場合（既に改善済みまたは別の変更あり）: その変更をスキップし、skipped リストに理由を記録する
```

## 新規作成ファイル
（なし）

## 削除推奨ファイル
（なし）

## 実装順序

1. **templates/verify-improvements.md**: 他ファイルから参照されるテンプレートのため先に修正
2. **templates/analyze-skill-structure.md**: 他ファイルから参照されるテンプレートのため先に修正
3. **templates/apply-improvements.md**: 他ファイルから参照されるテンプレートのため先に修正
4. **SKILL.md**: 全テンプレート修正後に親の制御フローを更新

依存関係の理由:
- SKILL.md はテンプレートファイルを参照しているため、テンプレートの変更が先に適用されている必要がある
- テンプレートファイル間には依存関係がないため、1-3は順不同でも可

## 注意事項

- **S-C3（Phase 0のファイル削除）**: 実装見送り。理由: 再実行時の成果物保持は別途タイムスタンプ管理が必要で、現状の削除方式は「常にクリーンな状態から開始」という明確な意図がある。ユーザーが成果物を保持したい場合は手動でバックアップ可能
- **S-I2（Phase 3 Step 1のコンフリクト検出基準）**: 変更箇所5で「2件以上」の数値基準を追加済み
- **E-I1（Phase 3の不要なファイル読み込み）**: 変更箇所5で最適化済み（2件以上の場合のみRead）
- **E-I2（Phase 4のサブエージェント返答行数拡張）**: 実装見送り。理由: ユーザーが詳細確認する場合は結局全Readが必要なため、効果が限定的
- **E-I3（Phase 6のリトライループの重点チェック）**: 実装見送り。理由: verify-improvements.md の変更が大規模になり、現状の全件再検証でも1回のリトライのみのためコスト増は許容範囲
- **A-I1（Phase 3のテンプレート化検討）**: 実装見送り。理由: Phase 3は親が直接実行する判断ロジック（コンフリクト解決）のため、現状のインライン配置が適切
- **A-I3（ナレッジ蓄積の仕組み）**: 実装見送り。理由: 現状の1回実行で完結する設計では不要。将来的な拡張として検討可能
- **A-I4（サブエージェントモデル指定の最適化）**: 実装見送り。理由: Phase 5は二重適用チェック等の解釈が必要なため、現状のsonnetが適切
- **A-I5（Phase 5の自己検証追加）**: 実装見送り。理由: Phase 6で包括的な検証を実施しているため、Phase 5での軽量検証は冗長
- **U-I1（Phase 4の一括承認パターン）**: 変更箇所8で個別承認方式に変更し、スキップオプションも提供
- Phase 4の個別承認方式は、改善項目が多い場合（10件以上等）にユーザー体験が低下する可能性があるが、品質基準「提案ごとの個別承認」を満たすために実装
- 変更箇所8（Phase 4の承認プロセス）は広範囲の変更となるため、既存のワークフローが壊れないよう慎重に適用すること
