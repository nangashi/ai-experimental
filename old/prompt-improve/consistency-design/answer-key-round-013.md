# 正解キー

## 実行条件
- **観点**: consistency
- **対象**: design
- **埋め込み問題数**: 10問

---

## 埋め込み問題一覧

### P01: テーブル命名規約の混在（単数形/複数形）
- **カテゴリ**: 命名規約の既存パターンとの一致（データモデル）
- **深刻度**: 重大
- **該当箇所**: セクション4 データモデル — hotel_bookings, car_rentals, user_review
- **問題の説明**: 既存FlightBookerシステムではテーブル名は複数形（`flight_bookings`, `passengers`）を採用しているが、新設計では`hotel_bookings`（複数形）、`car_rentals`（複数形）、`user_review`（単数形）が混在している。これにより、開発者がテーブル名を推測する際の一貫性が損なわれ、JOIN句やクエリ作成時に誤ったテーブル名を参照するリスクが増大する。
- **検出判定基準**:
  - ○（検出）: `user_review`テーブル名が既存の複数形命名規約と不一致であることを指摘し、`user_reviews`への変更を推奨している
  - △（部分検出）: テーブル命名規約の不統一に言及しているが、具体的にどのテーブルが問題かを特定していない、または複数形/単数形の統一性のみに言及して既存パターンとの比較がない
  - ×（未検出）: 指摘なし

---

### P02: タイムスタンプカラム命名規約の混在
- **カテゴリ**: 命名規約の既存パターンとの一致（データモデル）
- **深刻度**: 中
- **該当箇所**: セクション4 データモデル — hotel_bookings（created/updated）、car_rentals（createdAt/modifiedAt）、user_review（created/updated）
- **問題の説明**: 既存FlightBookerシステムではタイムスタンプカラムは`created_at`, `updated_at`（スネークケース）を採用しているが、新設計では`hotel_bookings`が`created/updated`、`car_rentals`が`createdAt/modifiedAt`（キャメルケース）と混在している。この不一致により、ORM設定やマイグレーションスクリプト作成時に混乱が生じ、データベース一貫性チェックツールが正常に機能しない可能性がある。
- **検出判定基準**:
  - ○（検出）: タイムスタンプカラム命名が既存の`created_at/updated_at`パターンと不一致であることを指摘し、`car_rentals`の`createdAt/modifiedAt`および`hotel_bookings/user_review`の`created/updated`の両方を既存パターンに統一することを推奨している
  - △（部分検出）: タイムスタンプカラム命名の不統一に言及しているが、既存の`created_at/updated_at`パターンとの比較がない、または一部のテーブルのみ指摘している
  - ×（未検出）: 指摘なし

---

### P03: 主キー命名規約の混在（AUTO INCREMENT vs UUID）
- **カテゴリ**: 命名規約の既存パターンとの一致（データモデル）
- **深刻度**: 中
- **該当箇所**: セクション4 データモデル — hotel_bookings（booking_id UUID）、car_rentals（id BIGSERIAL）、user_review（review_id UUID）
- **問題の説明**: 既存FlightBookerシステムでは主キーは`id BIGSERIAL`（AUTO INCREMENT）を採用しているが、新設計では`hotel_bookings`が`booking_id UUID`、`car_rentals`が`id BIGSERIAL`、`user_review`が`review_id UUID`と混在している。この不一致により、異なるテーブル間での結合クエリやレプリケーション設定が複雑化し、開発者がシーケンス管理とUUID生成の2つのアプローチを並行して理解する必要が生じる。
- **検出判定基準**:
  - ○（検出）: 主キーの型と命名（UUID vs BIGSERIAL、カラム名の不統一）が既存の`id BIGSERIAL`パターンと不一致であることを指摘し、全テーブルで`id BIGSERIAL`に統一することを推奨している
  - △（部分検出）: 主キーの型や命名の不統一に言及しているが、既存の`id BIGSERIAL`パターンとの比較がない、またはUUIDとBIGSERIALの混在のみ指摘してカラム名（booking_id/review_id vs id）の不統一に触れていない
  - ×（未検出）: 指摘なし

---

### P04: 外部キーカラム命名規約の混在（スネークケース vs キャメルケース）
- **カテゴリ**: 命名規約の既存パターンとの一致（データモデル）
- **深刻度**: 軽微
- **該当箇所**: セクション4 データモデル — hotel_bookings（user_id）、car_rentals（userId）
- **問題の説明**: 既存FlightBookerシステムでは外部キーカラムは`user_id`, `flight_id`（スネークケース）を採用しているが、新設計では`hotel_bookings`が`user_id`（スネークケース）、`car_rentals`が`userId`（キャメルケース）と混在している。この不一致により、SQLクエリ作成時に開発者が混乱し、JOIN句で誤ったカラム名を参照するリスクがある。
- **検出判定基準**:
  - ○（検出）: `car_rentals`テーブルの外部キーカラム`userId`が既存の`user_id`（スネークケース）パターンと不一致であることを指摘し、`user_id`への変更を推奨している
  - △（部分検出）: 外部キーカラム命名の不統一に言及しているが、既存のスネークケースパターンとの比較がない、または一般的なキャメルケース/スネークケースの混在として指摘しているのみ
  - ×（未検出）: 指摘なし

---

### P05: API HTTPメソッド選択の不統一
- **カテゴリ**: API/インターフェース設計・依存関係の既存パターンとの一致
- **深刻度**: 中
- **該当箇所**: セクション5 API設計 — レンタカー予約API（GET /search, DELETE /reservations/{id}）
- **問題の説明**: 既存FlightBookerシステムでは更新系操作に主にPOSTを使用している（例: `/api/v1/bookings/cancel` POST）が、新設計ではレンタカーキャンセルに`DELETE /api/v1/cars/reservations/{id}`（RESTful DELETE）を採用している。また、検索操作で既存は`POST /search`だが新設計は`GET /search`を混在させている。この不一致により、フロントエンド開発者が既存APIと新APIでHTTPメソッドの使い分けを覚える必要が生じ、APIクライアントコードの統一性が損なわれる。
- **検出判定基準**:
  - ○（検出）: レンタカーキャンセルAPI（`DELETE /reservations/{id}`）および検索API（`GET /search`）のHTTPメソッドが既存の`POST`パターンと不一致であることを指摘し、既存パターンに統一することを推奨している
  - △（部分検出）: HTTPメソッドの不統一に言及しているが、既存の`POST`中心パターンとの比較がない、または一部のエンドポイント（キャンセルまたは検索）のみ指摘している
  - ×（未検出）: 指摘なし

---

### P06: APIエンドポイント動詞命名規約の不統一
- **カテゴリ**: API/インターフェース設計・依存関係の既存パターンとの一致
- **深刻度**: 中
- **該当箇所**: セクション5 API設計 — ホテル予約API（/book）、レンタカー予約API（/reserve）、レビューAPI（/create）
- **問題の説明**: 既存FlightBookerシステムではエンドポイントに動詞を含む命名（例: `/book`, `/cancel`）を採用しているが、新設計では`/book`（ホテル）、`/reserve`（レンタカー）、`/create`（レビュー）と、同じ「予約作成」操作に対して異なる動詞を使用している。この不一致により、APIクライアント開発者がエンドポイント名を推測しづらくなり、APIドキュメントの参照頻度が増加する。
- **検出判定基準**:
  - ○（検出）: 予約作成操作に対して`/book`と`/reserve`の2つの動詞が混在していることを指摘し、既存の`/book`パターンに統一することを推奨している
  - △（部分検出）: エンドポイント動詞の不統一に言及しているが、既存の`/book`パターンとの比較がない、または`/create`のみ指摘して`/reserve`に触れていない
  - ×（未検出）: 指摘なし

---

### P07: HTTP通信ライブラリ選定の不一致（情報欠落）
- **カテゴリ**: 実装パターンの既存パターンとの一致（情報欠落）
- **深刻度**: 重大
- **該当箇所**: セクション2 技術スタック — 主要ライブラリ（RestTemplate記載）、セクション8 既存システムとの統合（WebClient記載）
- **問題の説明**: セクション2では新システムのHTTP通信に`RestTemplate`を採用すると記載されているが、セクション8では既存FlightBookerシステムが`WebClient（Spring WebFlux）`を使用していると記載されている。この不一致についての明示的な説明や統一方針が設計書に欠落しており、既存システムとの技術スタック一貫性が検証できない。また、`RestTemplate`は非推奨（deprecated）であり、既存の`WebClient`パターンに統一すべきかの判断基準が不明である。
- **検出判定基準**:
  - ○（検出）: 新システムのHTTP通信ライブラリ（RestTemplate）が既存システムの`WebClient`と不一致であることを指摘し、既存パターンとの一貫性検証の必要性または統一方針の明記を推奨している
  - △（部分検出）: HTTP通信ライブラリの選定に言及しているが、既存の`WebClient`パターンとの比較がない、または`RestTemplate`の非推奨性のみ指摘して一貫性の観点に触れていない
  - ×（未検出）: 指摘なし

---

### P08: エラーハンドリングパターンの不一致（情報欠落）
- **カテゴリ**: 実装パターンの既存パターンとの一致（情報欠落）
- **深刻度**: 重大
- **該当箇所**: セクション6 実装方針 — エラーハンドリング方針（個別try-catch）、セクション8 既存システムとの統合（GlobalExceptionHandler記載）
- **問題の説明**: セクション6では各Controllerメソッドで個別にtry-catchを実装する方針が記載されているが、セクション8では既存FlightBookerシステムが`GlobalExceptionHandler（@RestControllerAdvice）`による集中管理を採用していると記載されている。この不一致について、なぜ異なるパターンを採用するのか、または既存パターンに統一すべきかの判断基準が設計書に明記されておらず、エラーハンドリングの一貫性が検証できない。
- **検出判定基準**:
  - ○（検出）: 新システムのエラーハンドリングパターン（個別try-catch）が既存システムの`GlobalExceptionHandler`パターンと不一致であることを指摘し、既存パターンとの一貫性検証の必要性または統一方針の明記を推奨している
  - △（部分検出）: エラーハンドリングパターンの不統一に言及しているが、既存の`GlobalExceptionHandler`パターンとの比較がない、またはグローバルハンドラの利点のみ指摘して一貫性の観点に触れていない
  - ×（未検出）: 指摘なし

---

### P09: ログ形式の不一致（情報欠落）
- **カテゴリ**: 実装パターンの既存パターンとの一致（情報欠落）
- **深刻度**: 中
- **該当箇所**: セクション6 実装方針 — ロギング方針（平文ログ）、セクション8 既存システムとの統合（JSON構造化ログ記載）
- **問題の説明**: セクション6では新システムのログ形式として平文ログ（`2024-03-15 10:30:45 INFO [HotelBookingService] ...`）が記載されているが、セクション8では既存FlightBookerシステムがJSON構造化ログ（`{"timestamp": "...", "level": "INFO", "message": "..."}`）を採用していると記載されている。この不一致について、ログ形式の統一方針が設計書に明記されておらず、ログ集約・分析ツールの設定や運用の一貫性が検証できない。
- **検出判定基準**:
  - ○（検出）: 新システムのログ形式（平文）が既存システムのJSON構造化ログと不一致であることを指摘し、既存パターンとの一貫性検証の必要性または統一方針の明記を推奨している
  - △（部分検出）: ログ形式の不統一に言及しているが、既存のJSON構造化ログパターンとの比較がない、またはJSON構造化ログの利点のみ指摘して一貫性の観点に触れていない
  - ×（未検出）: 指摘なし

---

### P10: 環境変数命名規則の不一致（情報欠落）
- **カテゴリ**: API/インターフェース設計・依存関係の既存パターンとの一致（情報欠落）
- **深刻度**: 軽微
- **該当箇所**: セクション8 既存システムとの統合 — 環境変数命名（既存: 小文字スネークケース `database_url`, `jwt_secret`）
- **問題の説明**: 既存FlightBookerシステムでは環境変数命名に小文字スネークケース（`database_url`, `jwt_secret`）を採用しているが、新システムの設計書では環境変数の命名規則が一切記載されていない。この欠落により、新システムの環境変数命名が既存パターンと一貫しているかが検証できず、デプロイスクリプトや設定管理ツールで命名規則が混在するリスクがある。
- **検出判定基準**:
  - ○（検出）: 新システムの環境変数命名規則が設計書に明記されていないこと、および既存の小文字スネークケースパターンとの一貫性検証の必要性を指摘している
  - △（部分検出）: 環境変数命名規則の欠落に言及しているが、既存の小文字スネークケースパターンとの比較がない、または一般的な命名規則の推奨のみ
  - ×（未検出）: 指摘なし

---

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | データモデル | `car_rentals`テーブルのカラム命名がキャメルケース（`userId`, `carId`, `pickupDate`等）で統一されているが、他のテーブルはスネークケース（`user_id`, `hotel_id`, `checkin_date`等）であり、テーブル間でカラム命名パターンが不統一 | テーブル間でのカラム命名規約の不統一（キャメルケース vs スネークケース）を指摘している |
| B02 | 依存管理 | 既存FlightBookerシステムが`application.properties`を使用しているが、新システムで異なる設定ファイル形式（例: YAML）を採用する可能性について言及がない | 設定ファイル形式の統一方針の明記を推奨している |
| B03 | アーキテクチャ | 各Serviceクラスのトランザクション境界（`@Transactional`のスコープ）が設計書に明記されておらず、既存システムとの一貫性が検証できない | トランザクション境界の設計方針の明記を推奨している |
| B04 | API設計 | 既存APIのレスポンス形式`{ "data": ..., "error": ... }`と新APIのレスポンス形式が一致しているが、エラーコード体系（`ERROR_CODE`, `VALIDATION_ERROR`, `INTERNAL_ERROR`）の定義が既存システムと統一されているかの確認が必要 | エラーコード体系の統一性検証の必要性を指摘している |
| B05 | セキュリティ | JWTトークンのlocalStorage保存が既存システムと同じかの確認、およびXSS脆弱性リスクの評価が設計書に欠落している | JWTトークン保存方式の既存パターンとの一貫性検証の必要性を指摘している |
| B06 | データモデル | `car_rentals.status`と`hotel_bookings.booking_status`でステータスカラム名が不統一（`status` vs `booking_status`） | ステータスカラム命名の不統一を指摘している |
| B07 | 依存管理 | `car_rentals`のカラム命名（`totalPrice`, `createdAt`等）がJavaエンティティクラスの命名規約（キャメルケース）に従っているように見えるが、データベーススキーマとしては既存のスネークケースに統一すべき | データベーススキーマとアプリケーションレイヤーの命名規約の混同を指摘している |
