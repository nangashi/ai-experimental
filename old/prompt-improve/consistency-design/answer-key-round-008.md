# 正解キー

## 実行条件
- **観点**: consistency
- **対象**: design
- **埋め込み問題数**: 10問

## 埋め込み問題一覧

### P01: テーブル名の命名規約混在（単数形/複数形）
- **カテゴリ**: 命名規約（データモデル）
- **深刻度**: 重大
- **該当箇所**: セクション4.1（データモデル）
- **問題の説明**: 既存システムはテーブル名を単数形で統一しているが、新設計では `user` (単数形) と `chat_rooms`, `messages`, `room_members` (複数形) が混在している。設計書には「既存システムのユーザーテーブルに倣い、単数形で命名」とあるが、他のテーブルは複数形になっており一貫性がない。
- **検出判定基準**:
  - ○（検出）: テーブル名の単数形/複数形混在を指摘し、既存の単数形パターンとの不一致を明示している
  - △（部分検出）: テーブル命名規則の不統一は指摘しているが、既存パターン（単数形）との比較に言及していない
  - ×（未検出）: テーブル命名規則の問題を指摘していない

### P02: カラム名の命名規約混在（snake_case/camelCase）
- **カテゴリ**: 命名規約（データモデル）
- **深刻度**: 重大
- **該当箇所**: セクション4.1（データモデル）の各テーブル定義
- **問題の説明**: 同一テーブル内でカラム命名規則が混在している（例: `user` テーブルで `user_name` (snake_case) と `displayName` (camelCase)、`chat_rooms` テーブルで `room_id` (snake_case) と `roomName` (camelCase)）。既存システムのカラム命名規則が設計書に明記されておらず、一貫性の検証ができない。
- **検出判定基準**:
  - ○（検出）: 同一テーブル内のカラム命名規則混在を指摘し、既存パターンとの一貫性検証が必要であることを明示している
  - △（部分検出）: カラム命名規則の不統一は指摘しているが、既存コードベースとの一貫性検証の観点に言及していない
  - ×（未検出）: カラム命名規則の問題を指摘していない

### P03: タイムスタンプ列の命名規約混在
- **カテゴリ**: 命名規約（データモデル）
- **深刻度**: 中
- **該当箇所**: セクション4.1（データモデル）の各テーブル定義
- **問題の説明**: タイムスタンプ列の命名が混在している。`user` テーブルは `created`/`updated`、`chat_rooms` テーブルは `createdAt`/`updatedAt`、`room_members` テーブルは `joinedAt`。既存システムのタイムスタンプ列命名パターンが設計書に明記されていないため、一貫性の検証ができない。
- **検出判定基準**:
  - ○（検出）: タイムスタンプ列の命名混在を指摘し、既存パターンとの一貫性検証が必要であることを明示している
  - △（部分検出）: タイムスタンプ列の命名不統一を指摘しているが、既存パターンとの比較に言及していない
  - ×（未検出）: タイムスタンプ列の命名問題を指摘していない

### P04: 外部キー列名の命名規約混在
- **カテゴリ**: 命名規約（データモデル）
- **深刻度**: 中
- **該当箇所**: セクション4.1（データモデル）
- **問題の説明**: 外部キー列の命名が混在している。`messages` テーブルは参照先カラム名をそのまま使用（`roomId`, `sender_id`）、`room_members` テーブルは `_fk` サフィックス付き（`room_id_fk`）と `_id` サフィックス（`user_id`）が混在。既存システムの外部キー命名規則が設計書に明記されていない。
- **検出判定基準**:
  - ○（検出）: 外部キー列の命名パターン混在を指摘し、既存パターンとの一貫性検証が必要であることを明示している
  - △（部分検出）: 外部キー命名の不統一を指摘しているが、既存コードベースとの一貫性に言及していない
  - ×（未検出）: 外部キー命名の問題を指摘していない

### P05: APIエンドポイントのパスプレフィックス混在
- **カテゴリ**: API設計
- **深刻度**: 中
- **該当箇所**: セクション5.2（RESTful APIエンドポイント）
- **問題の説明**: APIエンドポイントのパスプレフィックスが混在している（`/auth/*` と `/api/*`）。既存システムのAPIエンドポイント命名規則（パスプレフィックスの統一有無）が設計書に明記されていないため、一貫性の検証ができない。
- **検出判定基準**:
  - ○（検出）: パスプレフィックス混在を指摘し、既存APIエンドポイントのパターンとの一貫性検証が必要であることを明示している
  - △（部分検出）: パスプレフィックスの不統一を指摘しているが、既存パターンとの比較に言及していない
  - ×（未検出）: パスプレフィックスの問題を指摘していない

### P06: APIエンドポイント命名に動詞を使用（RESTfulでない命名）
- **カテゴリ**: API設計
- **深刻度**: 中
- **該当箇所**: セクション5.2（RESTful APIエンドポイント）
- **問題の説明**: `/auth/login`, `/auth/logout`, `/auth/refresh-token` のエンドポイント名が動詞を含む。既存システムのAPI命名パターン（動詞使用の有無）が設計書に明記されていないため、既存パターンとの一貫性が検証できない。
- **検出判定基準**:
  - ○（検出）: エンドポイント名に動詞が使用されていることを指摘し、既存APIの命名パターンとの一貫性検証が必要であることを明示している
  - △（部分検出）: 動詞使用の指摘はあるが、既存パターンとの一貫性検証の観点に言及していない
  - ×（未検出）: エンドポイント命名の問題を指摘していない

### P07: エラーハンドリングパターンの不整合
- **カテゴリ**: 実装パターン
- **深刻度**: 重大
- **該当箇所**: セクション6.1（エラーハンドリング）
- **問題の説明**: 設計書では「各Controllerメソッドで個別にtry-catchを実装」としているが、既存システムがグローバルExceptionHandlerを使用している場合、実装パターンが不一致となる。既存システムのエラーハンドリング方針が設計書に明記されておらず、一貫性の検証ができない。
- **検出判定基準**:
  - ○（検出）: 個別try-catchアプローチを指摘し、既存システムのエラーハンドリングパターンとの一貫性検証が必要であることを明示している
  - △（部分検出）: エラーハンドリング方針に言及しているが、既存パターンとの比較の必要性を指摘していない
  - ×（未検出）: エラーハンドリングパターンの問題を指摘していない

### P08: ログ出力形式の不整合
- **カテゴリ**: 実装パターン
- **深刻度**: 軽微
- **該当箇所**: セクション6.2（ロギング）
- **問題の説明**: 設計書では「ログ形式: 平文」としているが、既存システムが構造化ログ（JSON形式）を使用している場合、ログ出力パターンが不一致となる。既存システムのログ形式が設計書に明記されておらず、一貫性の検証ができない。
- **検出判定基準**:
  - ○（検出）: 平文ログ形式を指摘し、既存システムのログ形式（構造化ログの有無）との一貫性検証が必要であることを明示している
  - △（部分検出）: ログ形式に言及しているが、既存パターンとの比較の必要性を指摘していない
  - ×（未検出）: ログ形式の問題を指摘していない

### P09: アーキテクチャパターンの依存方向違反
- **カテゴリ**: アーキテクチャパターン
- **深刻度**: 中
- **該当箇所**: セクション3.1（全体構成）
- **問題の説明**: 「通知送信時にServiceからWebSocketControllerを直接参照する設計」は、通常の依存方向（Controller → Service → Repository）を逆転させている。設計書では「既存の社内システムでは、ServiceからControllerを直接呼び出す逆向き依存が一部で見られるが、本システムでも既存パターンに倣い」と明記されているが、この逆向き依存が既存システムの支配的パターンか（70%以上のモジュールで採用）、それとも一部の例外的ケースかが不明。
- **検出判定基準**:
  - ○（検出）: 逆向き依存を指摘し、既存システムでのこのパターンの採用範囲（支配的パターンか例外的ケースか）の確認が必要であることを明示している
  - △（部分検出）: 逆向き依存の存在を指摘しているが、既存システムでの採用範囲の検証の必要性に言及していない
  - ×（未検出）: アーキテクチャの依存方向の問題を指摘していない

### P10: JWTトークン保存場所のセキュリティリスク（隣接領域）
- **カテゴリ**: API設計（認証・認可）
- **深刻度**: 重大
- **該当箇所**: セクション5.1（認証・認可方式）
- **問題の説明**: 「トークンはlocalStorageに保存」としているが、localStorageはXSS攻撃に脆弱である。既存システムの認証トークン保存方式（Cookie/localStorage/sessionStorage）が設計書に明記されていないため、一貫性の検証ができない。また、このセキュリティリスクは security 観点のスコープだが、既存システムとの一貫性という観点では consistency でも検出すべき項目である。
- **検出判定基準**:
  - ○（検出）: localStorage使用を指摘し、既存システムの認証トークン保存方式との一貫性検証が必要であることを明示している（セキュリティリスクの評価は不要、一貫性検証の観点のみでよい）
  - △（部分検出）: トークン保存方式に言及しているが、既存パターンとの一貫性検証の観点が不明確
  - ×（未検出）: トークン保存方式の問題を指摘していない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 命名規約 | Boolean列の命名規約（`edited` vs 既存パターン `is_edited`/`has_*` 等） | Boolean列の命名パターンが既存と不一致の可能性を指摘 |
| B02 | 命名規約 | プライマリキー列のサフィックス混在（`userId`, `room_id`, `message_id`, `room_member_id` で `Id` と `_id` が混在） | プライマリキー列の命名規則混在を指摘し、既存パターンとの一貫性検証が必要であることを明示 |
| B03 | データモデル | 外部キー列と参照先主キー列の命名不整合（`messages.roomId` → `chat_rooms.room_id`、`messages.sender_id` → `user.userId`） | 外部キー列と参照先主キー列の命名が一致していないことを指摘 |
| B04 | API設計 | APIエンドポイントの複数形/単数形混在（`/users` vs `/chatrooms`：既存が `/chat-rooms` のようにハイフン区切りを使っている可能性） | エンドポイントパスの複数形表記の不統一（`chatrooms` vs 既存の可能性がある `chat-rooms`）を指摘 |
| B05 | 実装パターン | データアクセスパターンおよびトランザクション管理の方針が設計書に明記されていない | データアクセスパターン（Repository/直接ORM呼び出し等）およびトランザクション管理方針の文書化欠落を指摘 |
| B06 | 実装パターン | 非同期処理パターンが設計書に明記されていない（WebSocketの非同期通信、通知キューの処理等） | 非同期処理パターンの方針が設計書に明記されていないことを指摘 |
| B07 | ディレクトリ構造 | ファイル配置方針が設計書に明記されていない | ディレクトリ構造・ファイル配置の規則が設計書に明記されていないことを指摘 |
