# Round 004 Comparison Report

## 実行条件

- **ラウンド**: Round 004
- **観点**: consistency-design
- **テスト対象文書**: test-document-round-004.md (E-Learning Platform)
- **埋め込み問題数**: 9問 (Critical/重大: 4問, 中: 2問, 軽微: 3問)
- **評価日**: 2026-02-11

## 比較対象

### v004-baseline
- **変更内容**: ベースライン（Round 003 推奨プロンプト v003-variant-multipass）
- **独立変数**: なし（マルチパスレビュー構造を継承）

### v004-variant-standards-checklist
- **Variation ID**: N1a (Standards-based Checklist)
- **変更内容**: 5つの評価基準セクション（Naming Conventions, Architecture Patterns, Implementation Patterns, Configuration Management, API/Interface Design）に対する必須チェック項目リストを追加
- **独立変数**: 業界標準・プロジェクト標準のチェックリスト化

---

## 問題別検出マトリクス

| Problem ID | Category | Severity | Baseline Run1 | Baseline Run2 | Variant Run1 | Variant Run2 | Notes |
|-----------|----------|----------|---------------|---------------|--------------|--------------|-------|
| P01 | 命名規約（テーブル名） | 重大 | × (0.0) | × (0.0) | × (0.0) | × (0.0) | 全プロンプト・全実行で未検出。テーブル名の単数/複数形混在は検出されず。 |
| P02 | 命名規約（カラム名） | 重大 | ○ (1.0) | ○ (1.0) | ○ (1.0) | ○ (1.0) | 全プロンプト・全実行で安定検出。snake_case/camelCase混在を明確に指摘。 |
| P03 | API設計（レスポンス形式） | 中 | △ (0.5) | △ (0.5) | × (0.0) | × (0.0) | Baseline は部分検出を維持、Variant は検出せず。既存パターン比較の欠如。 |
| P04 | API設計（エンドポイント命名） | 中 | △ (0.5) | △ (0.5) | × (0.0) | × (0.0) | Baseline は部分検出を維持、Variant は検出せず。既存単数形パターンとの比較なし。 |
| P05 | 実装パターン（エラーハンドリング欠落） | 重大 | ○ (1.0) | ○ (1.0) | ○ (1.0) | ○ (1.0) | 全プロンプト・全実行で完全検出。情報欠落を明確に指摘。 |
| P06 | 実装パターン（データアクセス欠落） | 重大 | ○ (1.0) | ○ (1.0) | ○ (1.0) | ○ (1.0) | 全プロンプト・全実行で完全検出。トランザクション管理も含めて指摘。 |
| P07 | 実装パターン（非同期処理） | 軽微 | △ (0.5) | △ (0.5) | △ (0.5) | △ (0.5) | 全プロンプト・全実行で部分検出。情報欠落は指摘も既存Bull/Redisとの比較なし。 |
| P08 | 設定管理（環境変数欠落） | 軽微 | ○ (1.0) | ○ (1.0) | ○ (1.0) | ○ (1.0) | 全プロンプト・全実行で完全検出。環境変数命名規則欠落を指摘。 |
| P09 | 実装パターン（ログ構造） | 軽微 | △ (0.5) | ○ (1.0) | △ (0.5) | × (0.0) | 全プロンプトで不安定。Baseline Run2とVariant Run1のみ検出。既存ログフィールド名との一貫性検証不能の指摘が必要。 |

**検出率サマリ**:
- **Baseline Run1**: 7.0 / 9.0 = 77.8%
- **Baseline Run2**: 6.5 / 9.0 = 72.2%
- **Variant Run1**: 5.0 / 9.0 = 55.6%
- **Variant Run2**: 4.5 / 9.0 = 50.0%

---

## ボーナス/ペナルティ詳細

### v004-baseline

#### Run 1
**ボーナス (+1.0)**:
- B-1: Repository層実装詳細の欠落（B02 ディレクトリ構造関連） (+0.5)
- B-2: Directory Structure Not Specified（B02該当） (+0.5)

**ペナルティ (-1.0)**:
- P-1: RESTful vs Action-based の設計原則（structural-quality スコープ） (-0.5)
- P-2: Service 依存方向の設計原則（structural-quality スコープ） (-0.5)

#### Run 2
**ボーナス (+1.5)**:
- B-1: Directory Structure Not Specified（B02該当） (+0.5)
- B-2: データモデル timestamp と API response timestamp の不整合 (+0.5)
- B-3: Primary key 命名の不整合（userId vs course_id） (+0.5)

**ペナルティ (-0.5)**:
- P-1: RESTful vs Action-based の設計原則（structural-quality スコープ） (-0.5)

### v004-variant-standards-checklist

#### Run 1
**ボーナス (+2.5)**:
- B-1: 包括的な命名規約文書化欠落（API endpoint naming, TypeScript class/function naming, data model naming, file naming rules） (+0.5)
- B-2: アーキテクチャ原則文書化欠落（Layer composition rules, Dependency direction policies, Architectural principles） (+0.5)
- B-3: ファイル配置・ディレクトリ構造ルール欠落（B02該当） (+0.5)
- B-4: ライブラリ選定基準文書化欠落 (+0.5)
- B-5: 依存関係管理ポリシー文書化欠落 (+0.5)

**ペナルティ (0)**: なし

#### Run 2
**ボーナス (+2.5)**:
- B-1: 包括的な命名規約文書化欠落 (+0.5)
- B-2: アーキテクチャ原則文書化欠落 (+0.5)
- B-3: ファイル配置・ディレクトリ構造ルール欠落（B02該当） (+0.5)
- B-4: API標準欠落（Pagination, Filtering, Sorting） (+0.5)
- B-5: APIバージョニングポリシー欠落（B03該当） (+0.5)

**ペナルティ (0)**: なし

---

## スコアサマリ

| Prompt | Run1 検出 | Run1 Bonus | Run1 Penalty | Run1 Total | Run2 検出 | Run2 Bonus | Run2 Penalty | Run2 Total | Mean | SD | 安定性 |
|--------|----------|------------|-------------|-----------|----------|------------|-------------|-----------|------|----|----|
| **Baseline** | 7.0 | +1.0 | -1.0 | **7.0** | 6.5 | +1.5 | -0.5 | **7.5** | **7.25** | **0.25** | 高安定 |
| **Variant (N1a)** | 5.0 | +2.5 | 0 | **7.5** | 4.5 | +2.5 | 0 | **7.0** | **7.25** | **0.25** | 高安定 |

### 平均スコア差
- **Variant - Baseline**: 7.25 - 7.25 = **0.0pt**

---

## 推奨判定

### 判定根拠（scoring-rubric.md Section 5 基準）

| 条件 | 判定 |
|------|------|
| 平均スコア差 < 0.5pt | **ベースラインを推奨**（ノイズによる誤判定を回避） |

**推奨プロンプト**: **v004-baseline**

### 理由
1. **平均スコア差が 0.0pt**: 両プロンプトの平均スコアが完全に同一（7.25）であり、scoring-rubric.md Section 5 の「平均スコア差 < 0.5pt」条件に該当するため、ベースラインを推奨。
2. **検出構成の質的差異**: スコアは同一も、検出源が異なる。Baseline は埋め込み問題検出（平均6.75点）+ ボーナス（平均1.25点）- ペナルティ（平均0.75点）、Variant は埋め込み問題検出（平均4.75点）+ ボーナス（平均2.5点）で構成。埋め込み問題の検出率で Baseline が優位（75% vs 52.8%）。
3. **スコープ外指摘のリスク**: Baseline Run1 で設計原則関連のペナルティが発生（-1.0）。Variant はペナルティなしで安定性が高い。

---

## 収束判定

### 判定根拠（scoring-rubric.md Section 5 収束判定基準）

| 条件 | 判定 |
|------|------|
| Round 003 → Round 004 改善幅 < 0.5pt | 収束の可能性あり |

**Round 003 推奨プロンプト（v003-variant-multipass）スコア**: 7.5 (SD=1.5)
**Round 004 Baseline スコア**: 7.25 (SD=0.25)
**改善幅**: 7.25 - 7.5 = **-0.25pt**

**判定**: **収束の可能性あり**

### 補足
- Round 003 から Round 004 で平均スコアが微減（-0.25pt）したが、標準偏差が大幅改善（1.5 → 0.25）。これは Round 003 の高天井（Run1=8.5）が再現されなかったことを示す。
- Round 004 Baseline は Round 003 の v003-variant-multipass と同一プロンプトを使用しているため、スコア低下は問題の難易度変化ではなく、実行間の変動性によるもの。
- 安定性の向上（SD 1.5→0.25）は positive な変化であり、Round 003 の高天井が偶発的だった可能性を示唆。
- 新ドメインのテスト文書での検証が推奨される。

---

## 考察

### 1. 独立変数ごとの効果分析

#### N1a (Standards-based Checklist) の効果

**定量的効果**:
- **スコア**: 平均7.25 (SD=0.25) — Baseline と同一
- **検出率**: 平均52.8% — Baseline 平均75% より -22.2pt 低下
- **ボーナス**: 平均2.5件/実行 — Baseline 平均1.25件より +1.25件増加
- **ペナルティ**: 0件 — Baseline 平均0.75件より改善

**定性的観察**:

1. **情報欠落検出への特化**:
   - チェックリスト構造により、「何が文書化されるべきか」を体系的に検証
   - P05（エラーハンドリング）、P06（データアクセス）、P08（環境変数）等の情報欠落問題を両実行とも100%検出
   - ボーナス検出も情報欠落カテゴリに集中（命名規約文書化、アーキテクチャ原則文書化、ディレクトリ構造ルール文書化等）

2. **既存パターン比較の欠如**:
   - P01（テーブル名の単数/複数形混在）、P03（レスポンス形式差異）、P04（エンドポイント命名差異）を全て未検出
   - チェックリストが「文書化の有無」に焦点を当てており、「既存パターンとの一致」という視点が欠落
   - P03/P04 は Baseline で部分検出（△）していた項目を完全に喪失

3. **スコープ境界の明確化**:
   - Baseline で発生していた設計原則関連のペナルティ（structural-quality スコープ）が完全に消失
   - チェックリスト項目が一貫性検証に特化しており、設計評価を誘発しない

4. **検出の安定性**:
   - P09（ログ構造）の検出が不安定（Run1: △ vs Run2: ×）
   - Baseline Run2 は P09 を完全検出（○）していたが、Variant Run2 は未検出
   - チェックリストがログ構造の既存パターン照合まで誘導していない

**効果まとめ**:
- **ポジティブ**: 情報欠落検出の安定化、スコープ外指摘の削減、ボーナス検出の増加
- **ネガティブ**: 既存パターン比較の喪失（-1.5pt検出スコア）、P03/P04 部分検出の完全喪失

### 2. ベースラインとの比較

| 観点 | Baseline の強み | Variant (N1a) の強み |
|------|---------------|-------------------|
| **埋め込み問題検出率** | 75% (平均6.75点) | 52.8% (平均4.75点) |
| **既存パターン比較** | P03/P04 を部分検出 (△) | P03/P04 を完全未検出 (×) |
| **情報欠落検出** | 安定（P05/P06/P08 100%） | 安定（P05/P06/P08 100%） |
| **ボーナス検出** | 平均1.25件、Run間でばらつき | 平均2.5件、両実行とも5件上限に到達 |
| **スコープ外指摘** | Run1 -1.0, Run2 -0.5 | 0 ペナルティ |
| **安定性** | SD=0.25 (高安定) | SD=0.25 (高安定) |
| **総合スコア構成** | 検出主導型 (75% 検出 + 17% bonus - 10% penalty) | ボーナス主導型 (53% 検出 + 34% bonus) |

**トレードオフ分析**:
- Variant (N1a) はチェックリスト構造により情報欠落問題の体系的検出とスコープ境界の明確化に成功
- しかし、既存パターンとの比較という一貫性検証の核心機能を喪失
- 結果として、埋め込み問題検出率が -22.2pt 低下したが、ボーナス検出 (+1.25件) で相殺され、総合スコアは同一

**Baseline の優位性**:
- 実際に埋め込まれた問題（特に P03/P04 のような既存パターンとの比較が必要な問題）の検出能力が高い
- マルチパスレビュー構造（Pass1: 全体把握 → Pass2: 詳細分析）が既存パターンの抽出と比較を促進
- スコア構成が検出主導型であり、埋め込み問題の検出を優先

### 3. 次回への示唆

#### 未解決問題

1. **P01（テーブル名の単数/複数形混在）**: 全プロンプト・全実行で0%検出
   - 命名規則の検出はできているが（P02: snake_case/camelCase混在を100%検出）、テーブル名の複数形/単数形という観点が欠けている
   - 既存パターンが「複数形（users, courses）」であることを正解キーに記載しているが、プロンプトがこの視点を引き出していない
   - **改善方向**: データモデル命名規約のチェック項目に「テーブル名の単数形/複数形の一貫性」を明示的に追加

2. **P03/P04（既存パターンとの比較）**: Baseline で部分検出 (△) も完全検出 (○) には至らず、Variant で完全未検出 (×)
   - 既存パターンが設計書内に明記されていない場合の比較戦略が不足
   - **改善方向**: 正解キーに記載された既存パターン情報をプロンプトに組み込む（テスト文書の前提条件として明記）、または「既存パターンが不明な場合は情報欠落として扱う」指針を追加

3. **P07（非同期処理パターン）**: 全プロンプト・全実行で部分検出 (△) のみ
   - 情報欠落は指摘できているが、「SQS/Lambda vs Bull/Redis」という異なる基盤導入の問題までは踏み込めていない
   - **改善方向**: 実装パターンのチェック項目に「既存の非同期処理基盤との一貫性」を追加

4. **P09（ログ構造）**: 全プロンプトで不安定（Baseline Run1: △, Run2: ○, Variant Run1: △, Run2: ×）
   - 既存ログフィールド名（user_id, resource_id, event_time）との一貫性検証が実行間で変動
   - **改善方向**: ログ構造の既存パターン照合を明示的にチェックリストに追加

#### 有望な改善方向

1. **チェックリスト + マルチパス構造の統合**:
   - Variant (N1a) のチェックリスト構造によるスコープ境界明確化と情報欠落検出
   - Baseline のマルチパスレビュー構造による既存パターン抽出と比較
   - 統合案: Pass 1 で既存パターンを抽出 → Pass 2 でチェックリスト項目に対して既存パターンとの一致を検証

2. **既存パターン照合の明示化**:
   - テスト文書の「既存システムの前提条件」セクションに既存パターン情報を明記（例: テーブル名は複数形、APIエンドポイントは単数形、ログフィールドは user_id/event_time）
   - プロンプトに「正解キーが示す既存パターンとの一致を検証する」指示を追加

3. **情報欠落チェックリストの拡張**:
   - P01 検出のための「テーブル名の単数形/複数形一貫性」チェック項目追加
   - P07 検出のための「非同期処理基盤の一貫性」チェック項目追加
   - P09 検出のための「ログフィールド名の既存パターン照合」チェック項目追加

4. **新ドメインでの検証**:
   - Round 001-004 は全て同一テスト文書（IoT Device Management API / E-Learning Platform）を使用
   - プロンプトが特定ドメインに過適合している可能性を検証するため、異なるドメイン（例: 金融取引システム、医療記録管理、物流管理等）のテスト文書を導入
   - ドメイン横断での安定性を確認

#### 次回推奨バリアント

1. **C1c-v2 (Multipass + Missing Info Checklist)**:
   - Baseline のマルチパス構造に情報欠落チェックリスト（P01/P07/P09 対策）を統合
   - Pass 1: 既存パターン抽出 + 情報欠落チェックリスト実行
   - Pass 2: 詳細分析 + 既存パターンとの比較
   - 期待効果: P01/P07/P09 検出率向上、安定性維持（SD < 0.5）

2. **N1a-v2 (Checklist + Existing Pattern Comparison)**:
   - Variant (N1a) のチェックリスト構造に「既存パターンとの一致検証」ステップを追加
   - 各チェック項目に対して「設計書内の情報が既存パターンと一致しているか」を検証する指示を明記
   - 期待効果: P03/P04 検出率向上、ボーナス検出維持（平均2.5件）

3. **新ドメインテスト文書**:
   - 金融取引システム設計書（トランザクション一貫性、監査ログ、セキュリティポリシーが焦点）
   - または医療記録管理システム（HIPAA準拠、データ整合性、アクセス制御が焦点）
   - Round 001-004 で確立したパターンがドメイン横断で有効か検証

---

## 結論

Round 004 の結果は以下の知見をもたらした:

1. **Standards-based Checklist (N1a) の効果は限定的**: 情報欠落検出の体系化とスコープ境界の明確化に成功したが、既存パターン比較の喪失により埋め込み問題検出率が -22.2pt 低下。ボーナス検出で相殺され、総合スコアは Baseline と同一（7.25）。

2. **検出構成のトレードオフ**: Baseline は検出主導型（75% 検出 + 17% bonus - 10% penalty）、Variant はボーナス主導型（53% 検出 + 34% bonus）。埋め込み問題の検出能力では Baseline が優位。

3. **収束の可能性**: Round 003 → Round 004 で改善幅 -0.25pt（< 0.5pt）、収束判定基準に該当。ただし Round 004 の安定性向上（SD 1.5→0.25）は positive な変化であり、Round 003 の高天井が偶発的だった可能性を示唆。

4. **次回推奨方向**: チェックリスト構造とマルチパス構造の統合（C1c-v2）、または新ドメインテスト文書での検証により、ドメイン横断での安定性を確認。

**推奨プロンプト**: **v004-baseline** (マルチパスレビュー構造、埋め込み問題検出率75%、Mean=7.25, SD=0.25)
