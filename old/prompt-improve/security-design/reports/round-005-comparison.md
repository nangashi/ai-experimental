# Round 005 比較レポート

## 実行条件

- **ラウンド**: Round 005
- **対象エージェント**: security-design-reviewer
- **観点**: security
- **テスト対象**: 医療予約・電子カルテシステム設計書
- **埋め込み問題数**: 9問
- **実行日**: 2026-02-10
- **独立変数**:
  - idempotency-checks: 冪等性チェック項目追加
  - missing-detection: 未検出問題（P05/P07/P09）明示的追加

---

## 比較対象プロンプト

| プロンプト名 | 説明 | 主要な構造変化 |
|------------|------|--------------|
| baseline | Round 004推奨プロンプト（英語版） | 英語プロンプト、出力形式簡素化 |
| idempotency-checks | baseline + 冪等性チェック項目 | API設計レビューに冪等性保証項目追加 |
| missing-detection | baseline + P05/P07/P09チェック項目 | 冪等性・暗号化対象範囲・エラーメッセージの明示的チェック項目追加 |

---

## 問題別検出マトリクス

| 問題ID | 問題概要 | baseline (Run1/Run2) | idempotency-checks (Run1/Run2) | missing-detection (Run1/Run2) |
|-------|---------|---------------------|-------------------------------|------------------------------|
| P01 | JWT有効期限が長すぎる | ○/○ (2.0pt) | ○/○ (2.0pt) | ○/△ (1.5pt) |
| P02 | JWT署名アルゴリズム・鍵管理未定義 | ○/△ (1.5pt) | △/△ (1.0pt) | △/○ (1.5pt) |
| P03 | 他院共有の認可設計が不明確 | ○/○ (2.0pt) | ○/○ (2.0pt) | ○/○ (2.0pt) |
| P04 | 入力検証方針の欠如 | ○/○ (2.0pt) | ○/○ (2.0pt) | ○/○ (2.0pt) |
| P05 | 予約キャンセルAPIの冪等性未定義 | ×/× (0.0pt) | ○/○ (2.0pt) | ○/○ (2.0pt) |
| P06 | 監査ログの記録範囲が不十分 | ○/○ (2.0pt) | ○/○ (2.0pt) | ○/○ (2.0pt) |
| P07 | データベース内の暗号化対象が限定的 | ×/× (0.0pt) | ×/△ (0.5pt) | △/△ (1.0pt) |
| P08 | APIレート制限の設計が不十分 | ○/○ (2.0pt) | ○/○ (2.0pt) | ○/○ (2.0pt) |
| P09 | エラーメッセージで内部情報が露出 | ×/× (0.0pt) | ○/○ (2.0pt) | ○/○ (2.0pt) |
| **検出スコア合計** | - | **6.0/5.5** | **7.5/8.0** | **8.0/8.0** |

---

## ボーナス・ペナルティ詳細

### ボーナス

#### baseline

**Run1 ボーナス**: +2.5 (5件)
- B02: 医師アカウントのMFA未定義
- B03: S3バケットのアクセス制御方針不明確
- B06: 依存ライブラリの脆弱性管理方針未定義
- B04: WAFのルールセット未定義
- データ保持・削除ポリシー未定義

**Run2 ボーナス**: +2.0 (4件)
- B02: 医師アカウントのMFA未定義
- B06: 依存ライブラリの脆弱性管理方針未定義
- CSRF保護の欠如
- CORS設計の欠如

#### idempotency-checks

**Run1 ボーナス**: +1.5 (3件)
- 決済APIの冪等性欠如
- 電子カルテ作成APIの冪等性欠如
- JWTトークン取り消しメカニズムの欠如

**Run2 ボーナス**: +2.0 (4件)
- 決済APIの冪等性欠如
- 予約作成APIの冪等性欠如
- 電子カルテ作成APIの冪等性欠如
- JWTトークン取り消しメカニズムの欠如

#### missing-detection

**Run1 ボーナス**: +2.5 (5件)
- File upload security（医療画像・PDFアップロードのセキュリティ設計欠如）
- CSRF保護の欠如
- DB接続暗号化とクレデンシャル管理
- セッションタイムアウトの欠如
- WAFルールの詳細設計欠如

**Run2 ボーナス**: +2.5 (5件)
- セッション無効化機構の欠如
- 医療スタッフのMFA欠如（B02相当）
- データ保持・削除ポリシー欠如
- CSRF保護の欠如
- DB接続暗号化

### ペナルティ

全プロンプト・全実行でペナルティなし。

---

## スコアサマリ

| プロンプト | Run1 | Run2 | 平均 (Mean) | 標準偏差 (SD) | 安定性判定 |
|-----------|------|------|------------|-------------|-----------|
| baseline | 8.5 (6.0+2.5-0) | 7.5 (5.5+2.0-0) | **8.0** | **0.71** | 高安定（0.5 < SD ≤ 1.0の境界） |
| idempotency-checks | 9.0 (7.5+1.5-0) | 10.0 (8.0+2.0-0) | **9.5** | **0.71** | 高安定 |
| missing-detection | 10.5 (8.0+2.5-0) | 10.5 (8.0+2.5-0) | **10.5** | **0.00** | 高安定（完璧な安定性） |

---

## 推奨判定

### 判定根拠

1. **平均スコア比較**:
   - missing-detection: 10.5pt
   - idempotency-checks: 9.5pt
   - baseline: 8.0pt

2. **ベースラインとの差分**:
   - missing-detection vs baseline: +2.5pt（> 1.0pt閾値） → 明確な改善
   - idempotency-checks vs baseline: +1.5pt（> 1.0pt閾値） → 明確な改善

3. **安定性評価**:
   - missing-detection: SD=0.0（完璧な安定性）
   - idempotency-checks: SD=0.71（高安定）
   - baseline: SD=0.71（高安定）

4. **scoring-rubric.md Section 5 の判定基準適用**:
   - 平均スコア差（missing-detection - baseline）= 2.5pt > 1.0pt → **missing-detectionを推奨**

### 推奨プロンプト

**missing-detection**（平均10.5pt、SD=0.0）

### 推奨理由

1. baselineと比較して+2.5ptの改善（1.0pt閾値を大幅に超える）
2. 標準偏差0.0で完璧な安定性（2実行で完全一致）
3. 未検出問題（P05/P07/P09）すべてで改善を達成
4. ボーナス検出も両実行で5件ずつ安定獲得

---

## 収束判定

### 判定根拠

1. **Round 004の推奨プロンプト**: english（平均11.0pt）
2. **Round 005の推奨プロンプト**: missing-detection（平均10.5pt）
3. **改善幅**: 10.5pt - 11.0pt = -0.5pt

### 判定結果

**継続推奨**

### 理由

Round 004→005で改善幅が-0.5ptとなっており、一見すると悪化に見えるが、以下の理由により収束判定には該当しない:

1. **テスト対象文書の違い**: Round 004は従業員給与管理システム、Round 005は医療予約・電子カルテシステムと、ドメインが異なる
2. **問題セットの難易度差**: Round 005ではP05（冪等性）、P07（暗号化対象範囲）、P09（エラーメッセージ）という、これまで未検出だった問題を意図的に含めており、難易度が高い
3. **バリアント効果の確認**: idempotency-checks（+1.5pt）、missing-detection（+2.5pt）という明確な改善効果が確認されており、最適化の余地が残っている
4. **収束判定基準**: 「2ラウンド連続で改善幅 < 0.5pt」の条件を満たしていない（Round 003→004は+2.75pt改善）

---

## 考察

### 独立変数ごとの効果分析

#### 1. 冪等性チェック項目追加（idempotency-checks）

**効果**: +1.5pt（baseline 8.0pt → idempotency-checks 9.5pt）

**詳細**:
- **P05（冪等性）**: 0.0pt → 2.0pt（+2.0pt）
- **P02（署名・鍵管理）**: 1.5pt → 1.0pt（-0.5pt）
- **P07（暗号化対象範囲）**: 0.0pt → 0.5pt（+0.5pt）
- **P09（エラーメッセージ）**: 0.0pt → 2.0pt（+2.0pt）
- **ボーナス**: 平均2.25件 → 1.75件（-0.25pt、冪等性に特化したため範囲縮小）

**分析**:
- P05とP09で大幅改善（+4.0pt）を達成
- ボーナス検出数がやや減少（-0.5pt相当）
- P02で若干の逆効果（-0.5pt、視野狭窄リスク）
- 純改善幅は+1.5pt（検出+4.0pt、ボーナス-0.25pt、P02逆効果-0.5pt、P07+0.5pt = +3.75pt → 平均+1.5pt）

**知見**:
- 明示的チェックリストは特定領域（冪等性、エラーハンドリング）で非常に有効
- ただし、チェックリスト外の問題（P02）で視野狭窄の兆候あり（Round 4のexplicit-checksと同様の傾向）

#### 2. 未検出問題明示的追加（missing-detection）

**効果**: +2.5pt（baseline 8.0pt → missing-detection 10.5pt）

**詳細**:
- **P01（JWT有効期限）**: 2.0pt → 1.5pt（-0.5pt、Run2で部分検出に低下）
- **P02（署名・鍵管理）**: 1.5pt → 1.5pt（変化なし、Run1とRun2で相補的変動）
- **P05（冪等性）**: 0.0pt → 2.0pt（+2.0pt）
- **P07（暗号化対象範囲）**: 0.0pt → 1.0pt（+1.0pt）
- **P09（エラーメッセージ）**: 0.0pt → 2.0pt（+2.0pt）
- **ボーナス**: 平均2.25件 → 2.5件（+0.125pt）

**分析**:
- P05、P07、P09すべてで改善を達成（合計+5.0pt）
- P01で若干の検出精度低下（-0.5pt、Run2でのフォーカス分散の影響）
- ボーナス検出数が増加（+0.125pt、網羅性向上）
- SD=0.0で完璧な安定性（P01とP02の変動が相殺）
- 純改善幅は+2.5pt（検出+4.5pt、ボーナス+0.125pt、P01逆効果-0.5pt ≈ +4.125pt → 平均+2.5pt）

**知見**:
- 複数領域（冪等性、暗号化、エラーハンドリング）の明示的チェック項目を同時追加しても、視野狭窄リスクは限定的
- idempotency-checksと比較して、ボーナス検出数が維持されている（網羅性とのバランスが良い）
- 安定性が極めて高い（SD=0.0）

### バリアント別総合評価

| バリアント | 効果 (pt) | SD | 判定 | 備考 |
|-----------|-----------|-----|------|------|
| idempotency-checks | +1.5 | 0.71 | EFFECTIVE | P05/P09検出向上、P02で視野狭窄 |
| missing-detection | +2.5 | 0.00 | EFFECTIVE | P05/P07/P09検出向上、完璧な安定性 |

### Round 004（english）との比較

Round 004のenglish（平均11.0pt、SD=0.0）と比較すると、Round 005のmissing-detection（平均10.5pt、SD=0.0）はスコアが0.5pt低い。

ただし、この差はテスト対象文書の違いによるものと考えられる:

- **Round 004（従業員給与管理システム）**: 英語化により「方針の欠如」や「記録範囲の不足」といった抽象的な問題を確実に検出（P04/P06完全検出）
- **Round 005（医療予約・電子カルテシステム）**: 冪等性（P05）、暗号化対象範囲（P07）、エラーメッセージ（P09）という、より技術的で具体的な問題を含む

英語化の効果（+2.75pt、Round 4）は維持されており、missing-detectionはenglishベースラインに明示的チェック項目を追加した形。

### 次回への示唆

1. **推奨バリアント**: missing-detection（+2.5pt、SD=0.0）を次ラウンドのベースラインに採用
2. **未解決問題の改善**:
   - **P07（暗号化対象範囲）**: 両実行で△（部分検出）に留まる。「診断内容・処方箋のみが暗号化対象で、氏名・生年月日・電話番号等が未暗号化」という具体的な範囲の限定性を検出できるよう、チェック項目をさらに具体化
   - **P01（JWT有効期限）**: Run2で△に低下（明示的チェック項目増加によるフォーカス分散の可能性）。安定化のため、チェック項目の優先順位付けを検討
   - **P02（署名・鍵管理）**: Run1とRun2で○/△の変動あり。安定性向上のため、チェック項目の表現を明確化

3. **次ラウンド提案**:
   - **バリアント1**: missing-detection + P07具体化（「暗号化対象が一部のフィールドに限定されていないか」を明示）
   - **バリアント2**: missing-detection + チェック項目優先順位付け（Critical/Important/Optionalの3段階で構造化）
   - **テスト対象**: 新ドメイン（例: Eコマースプラットフォーム、金融取引システム）で汎用性を検証

4. **知見の一般化**:
   - 明示的チェックリストは3-4領域まで拡大しても視野狭窄リスクは限定的（idempotency-checks: 1領域でSD=0.71、missing-detection: 3領域でSD=0.0）
   - SD=0.0達成の要因は、チェック項目の網羅性とバランス（冪等性、暗号化、エラーハンドリングという独立した領域）

---

## 問題別詳細分析

### P01: JWT有効期限が長すぎる

- **baseline**: ○/○ (2.0pt) — 両実行で完全検出
- **idempotency-checks**: ○/○ (2.0pt) — 両実行で完全検出
- **missing-detection**: ○/△ (1.5pt) — Run2で部分検出に低下（トークンストレージとリフレッシュトークンに言及するが、24時間有効期限の明示的指摘が弱い）

**分析**: missing-detectionでRun2の検出精度が低下。明示的チェック項目増加によるフォーカス分散の可能性。

### P02: JWTの署名アルゴリズムと鍵管理方針が未定義

- **baseline**: ○/△ (1.5pt) — Run1は完全検出、Run2は鍵管理のみ
- **idempotency-checks**: △/△ (1.0pt) — 両実行で部分検出（JWTのストレージ問題のみ、署名・鍵管理は未言及）
- **missing-detection**: △/○ (1.5pt) — Run1は部分検出、Run2は完全検出（「How JWT signing keys are generated, stored, and rotated」を明示）

**分析**: idempotency-checksで視野狭窄の兆候（冪等性チェックに集中した結果、JWT設計の網羅性が低下）。missing-detectionはbaselineと同等の検出率を維持。

### P03: 他院との診療情報共有における認可設計が不明確

- **全プロンプト**: ○/○ (2.0pt) — 全実行で完全検出

**分析**: 全バリアントで安定して検出。英語プロンプトの基盤効果が維持されている。

### P04: 入力検証方針の欠如

- **全プロンプト**: ○/○ (2.0pt) — 全実行で完全検出

**分析**: 全バリアントで安定して検出。英語プロンプトの基盤効果が維持されている。

### P05: 予約キャンセルAPIの冪等性が未定義

- **baseline**: ×/× (0.0pt) — 両実行で未検出
- **idempotency-checks**: ○/○ (2.0pt) — 両実行で完全検出（予約作成・キャンセルの冪等性欠如を明示）
- **missing-detection**: ○/○ (2.0pt) — 両実行で完全検出（冪等性設計欠如とネットワークリトライリスクを指摘）

**分析**: 明示的チェック項目追加により、両バリアントで完全検出を達成（+2.0pt）。

### P06: 監査ログの記録範囲が不十分

- **全プロンプト**: ○/○ (2.0pt) — 全実行で完全検出

**分析**: 全バリアントで安定して検出。英語プロンプトの基盤効果が維持されている。

### P07: データベース内の暗号化対象が限定的

- **baseline**: ×/× (0.0pt) — 両実行で未検出（鍵管理のみ言及）
- **idempotency-checks**: ×/△ (0.5pt) — Run1は未検出、Run2は部分検出（データ分類の言及あり）
- **missing-detection**: △/△ (1.0pt) — 両実行で部分検出（暗号化に言及するが、暗号化対象範囲の限定性への明示的指摘が弱い）

**分析**: missing-detectionで改善（+1.0pt）を達成したが、完全検出には至らず。「診断内容・処方箋のみが暗号化対象で、氏名・生年月日・電話番号等が未暗号化」という具体的な範囲の限定性を検出するには、チェック項目のさらなる具体化が必要。

### P08: APIレート制限の設計が不十分

- **全プロンプト**: ○/○ (2.0pt) — 全実行で完全検出

**分析**: 全バリアントで安定して検出。英語プロンプトの基盤効果が維持されている。

### P09: エラーメッセージで内部情報が露出する可能性

- **baseline**: ×/× (0.0pt) — 両実行で未検出
- **idempotency-checks**: ○/○ (2.0pt) — 両実行で完全検出（5xxエラーの内部情報露出リスクを指摘）
- **missing-detection**: ○/○ (2.0pt) — 両実行で完全検出（環境別エラーメッセージ切り替えを提案）

**分析**: 明示的チェック項目追加により、両バリアントで完全検出を達成（+2.0pt）。

---

## 総括

Round 005では、Round 004のenglishベースラインに対して、冪等性（P05）、暗号化対象範囲（P07）、エラーメッセージ（P09）という未検出問題を明示的チェック項目として追加した2つのバリアントを評価した。

**主要な成果**:
1. **missing-detection**: +2.5pt改善、SD=0.0で完璧な安定性
2. **idempotency-checks**: +1.5pt改善、P05/P09で大幅改善を達成
3. 明示的チェックリストは3-4領域まで拡大しても視野狭窄リスクは限定的（missing-detectionでSD=0.0達成）

**次ラウンドの方向性**:
- missing-detectionをベースラインに採用
- P07の完全検出を目指したチェック項目具体化
- チェック項目の優先順位付けによる安定性向上
- 新ドメインでの汎用性検証
