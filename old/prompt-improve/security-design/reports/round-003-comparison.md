# Round 3 比較レポート: SmartHome IoTデバイス管理プラットフォーム

## 実行条件

- **対象エージェント**: security-design-reviewer
- **観点**: security
- **対象**: design
- **ラウンド**: Round 3
- **テスト対象文書**: SmartHome IoTデバイス管理プラットフォーム設計書
- **実行日**: 2026-02-10
- **埋め込み問題数**: 10問（重大3、中5、軽微2）
- **実行回数**: 各バリアント2回（Run1, Run2）

---

## 比較対象バリアント

| バリアント名 | 説明 | 主要な構造変化 |
|------------|------|---------------|
| baseline | 現行の推奨プロンプト | Round 2で推奨されたベースライン |
| critical-checks (S1b) | ドメイン特化Few-shot/クリティカルチェック | 出力例を6個に拡張し、ドメイン特化のクリティカルチェックリストを追加 |
| decomposition (M1a) | 事前分析+本レビュー分離 | セキュリティレビューを事前分析（脆弱性調査）と本レビュー（詳細分析）の2フェーズに分離 |

---

## 問題別検出マトリクス

### 検出記号の凡例
- **○**: 検出（1.0pt）- 正解キーの検出判定基準をすべて満たす指摘がある
- **△**: 部分検出（0.5pt）- 関連するカテゴリの指摘はあるが、核心的な問題点を正確に捉えていない
- **×**: 未検出（0.0pt）- 当該問題に関する指摘が全くない

### 問題一覧と検出状況

| ID | カテゴリ | 深刻度 | 問題概要 | baseline | critical-checks | decomposition |
|----|---------|--------|---------|----------|-----------------|---------------|
| P01 | 認証・認可設計 | 重大 | デバイス認証キーの漏洩リスク（平文保存・通信） | ○/○ | ×/× | ○/○ |
| P02 | 認証・認可設計 | 重大 | JWTトークンのセキュアな保存方法が不明 | ○/○ | ×/△ | ○/○ |
| P03 | 認証・認可設計 | 重大 | デバイス制御コマンドの認可チェックが不明確 | ○/○ | ×/× | ×/○ |
| P04 | データ保護 | 中 | OTA更新パッケージのS3 URL有効期限が不明 | ○/○ | ×/○ | ○/○ |
| P05 | 認証・認可設計 | 中 | リフレッシュトークンのローテーション戦略が欠如 | ○/○ | ○/× | ○/○ |
| P06 | 入力検証設計 | 中 | センサーデータAPIの入力検証が不明確 | ×/× | ×/× | ×/× |
| P07 | 入力検証設計 | 中 | デバイスコマンド送信時の冪等性保証が欠如 | ×/× | ×/○ | ×/× |
| P08 | データ保護 | 中 | ログ出力時のマスキング方針が不明 | ×/× | ○/○ | ×/○ |
| P09 | 認証・認可設計 | 軽微 | MQTTブローカーの認証・認可メカニズムが不明確 | ○/○ | ×/× | ○/○ |
| P10 | インフラ・依存関係 | 軽微 | APIレート制限がIPベースのみ | △/△ | ×/× | ×/○ |

### 検出率サマリ

| バリアント | 重大問題検出率 | 中問題検出率 | 軽微問題検出率 | 総合検出率 |
|-----------|--------------|-------------|---------------|-----------|
| baseline | 100% (6/6) | 40% (4/10) | 50% (1/2) | 65% (13/20) |
| critical-checks | 0% (0/6) | 50% (5/10) | 0% (0/2) | 27.5% (5.5/20) |
| decomposition | 83.3% (5/6) | 60% (6/10) | 75% (1.5/2) | 70% (14/20) |

---

## ボーナス・ペナルティ詳細

### ボーナス獲得状況（上限5件、+0.5/件）

| バリアント | Run1 | Run2 | 主なボーナス項目 |
|-----------|------|------|----------------|
| baseline | 5件 (+2.5) | 5件 (+2.5) | SQLインジェクション対策、機密データ暗号化保存、OTAロールバック機能、依存ライブラリ脆弱性管理、Socket.IOセキュリティ設定 |
| critical-checks | 5件 (+2.5) | 5件 (+2.5) | CSRF対策、MQTT通信ペイロード暗号化、JWTトークン署名アルゴリズム、データベース接続セキュリティ、ファイルアップロード対策、データ削除ポリシー |
| decomposition | 4件 (+2.0) | 5件 (+2.5) | 保存時データ暗号化、Socket.IO認証認可、依存関係脆弱性管理、パスワードリセット機能、シークレット管理、マイグレーション戦略 |

**全バリアント共通の傾向**: すべてのバリアントでボーナス件数が上限（5件）または上限付近（4件）に達しており、ボーナススコアは+2.0～+2.5の範囲に収束。検出スコアの差がそのまま総合スコアの差となる。

### ペナルティ発生状況

| バリアント | Run1 | Run2 | 備考 |
|-----------|------|------|------|
| baseline | 0件 (0.0) | 0件 (0.0) | スコープ外の指摘や事実に反する指摘は確認されず |
| critical-checks | 0件 (0.0) | 0件 (0.0) | スコープ外の指摘や事実に反する指摘は確認されず |
| decomposition | 0件 (0.0) | 0件 (0.0) | スコープ外の指摘や事実に反する指摘は確認されず |

---

## スコアサマリ

### 総合スコア一覧

| バリアント | Run1 | Run2 | Mean | SD | 安定性判定 |
|-----------|------|------|------|-----|----------|
| **baseline** | 9.0 | 9.0 | **9.0** | 0.0 | 高安定 (SD ≤ 0.5) |
| critical-checks | 4.5 | 6.0 | 5.25 | 0.75 | 中安定 (0.5 < SD ≤ 1.0) |
| decomposition | 7.0 | 10.5 | 8.75 | 1.75 | 低安定 (SD > 1.0) |

### スコア内訳

| バリアント | 検出スコア (Run1/Run2) | ボーナス (Run1/Run2) | ペナルティ (Run1/Run2) | 総合スコア (Run1/Run2) |
|-----------|---------------------|-------------------|---------------------|---------------------|
| baseline | 6.5 / 6.5 | +2.5 / +2.5 | -0.0 / -0.0 | 9.0 / 9.0 |
| critical-checks | 2.0 / 3.5 | +2.5 / +2.5 | -0.0 / -0.0 | 4.5 / 6.0 |
| decomposition | 5.0 / 8.0 | +2.0 / +2.5 | -0.0 / -0.0 | 7.0 / 10.5 |

---

## 推奨判定

### 判定結果

**推奨プロンプト**: baseline

### 判定根拠

#### 1. 最高スコア比較
- baseline: Mean=9.0
- decomposition: Mean=8.75（差: -0.25pt）
- critical-checks: Mean=5.25（差: -3.75pt）

#### 2. 推奨判定基準の適用

**ルール**: 最高スコアバリアントと他バリアントの平均スコア差が0.5pt未満の場合、ベースラインを推奨

- **baseline vs decomposition**: 差=0.25pt < 0.5pt → 有意差なし
- **baseline vs critical-checks**: 差=3.75pt > 0.5pt → 有意差あり（baselineが優位）

#### 3. 最終判定

- baselineは最高スコア
- decompositionとの差は0.25pt < 0.5ptのため有意差なし
- 安定性: baseline（SD=0.0）> decomposition（SD=1.75）
- **結論**: baselineを推奨（最高スコア + 高安定性）

---

## 考察

### 1. S1b（critical-checks）の効果分析: -3.75pt（大幅低下）

#### 問題点
1. **重大問題の検出率が0%に低下**: P01, P02, P03をすべて未検出
   - baseline: 100%（6/6）→ critical-checks: 0%（0/6）
   - 出力例6個への拡張が、かえって基本的な認証・認可問題の見落としを誘発

2. **認証・認可カテゴリの検出率が25%に低下**: P01, P02, P03, P05, P09のうちP05のみ部分検出
   - ドメイン特化のクリティカルチェックリストが、基本的な認証設計の問題を見逃す構造になっている

3. **安定性も低下**: SD=0.75（中安定）
   - Run1: 4.5pt、Run2: 6.0pt（1.5ptの変動）
   - Run2でP04（S3 URL有効期限）とP07（冪等性）、P08（ログマスキング）を検出したが、Run1では未検出

#### 原因分析
- **出力例の過剰な拡張（6個）**: モデルが出力例の形式に過度にフォーカスし、設計書の基本的な欠陥を見逃す
- **クリティカルチェックリストの焦点の偏り**: 特定の問題（CSRF、ログマスキング）に強くなる一方で、認証・認可の基本設計（device_key保存、JWT保存、権限チェック）を見落とす

#### 教訓
- S1b（ドメイン特化Few-shot/クリティカルチェック）は、出力例が3個以下かつチェックリストが10項目以下の場合に限定すべき
- 出力例の拡張は検出率向上に寄与しない（Round 2でS4a（サブ項目削減）が-1.0pt、今回S1bが-3.75pt）

---

### 2. M1a（decomposition）の効果分析: -0.25pt（有意差なし）

#### スコア分析
- Mean: 8.75pt（baselineより-0.25pt）
- SD: 1.75（低安定）
- Run1: 7.0pt、Run2: 10.5pt（3.5ptの大きな変動）

#### 問題点
1. **安定性が極めて低い**: SD=1.75 > 1.0
   - Run1とRun2で3.5ptの差（7.0pt → 10.5pt）
   - Run2ではbaselineを上回る（10.5pt > 9.0pt）が、Run1では大幅に下回る（7.0pt < 9.0pt）

2. **検出の一貫性が欠如**: Run1とRun2で検出問題が大きく異なる
   - P03（制御コマンド認可チェック）: Run1=×、Run2=○
   - P08（ログマスキング）: Run1=×、Run2=○
   - P10（APIレート制限）: Run1=×、Run2=○

#### 強み（Run2では高性能）
- **総合検出率70%**: baseline（65%）より高い
- **中程度問題の検出率60%**: baseline（40%）より大幅に高い
- **Run2では10.5pt**: baselineの9.0ptを上回る

#### 原因分析
- **2フェーズ分離のランダム性**: 事前分析フェーズと本レビューフェーズで異なる発見パスを取る
- **Run1は認証・認可に集中**: P01, P02, P04, P05, P09を検出したが、P03, P08, P10を見逃し
- **Run2は権限管理に集中**: P03, P08, P10を追加検出し、全体で8問を検出

#### 教訓
- M1a（事前分析+本レビュー分離）は、高い潜在能力（Run2で10.5pt）を持つが、安定性が低い（SD=1.75）
- 追加実行（Run3以降）で真の平均値を確認する必要があるが、現時点ではリスクが高い
- 差が0.5pt未満のため、ベースライン推奨のルールが適用される

---

### 3. baselineの特性（推奨プロンプト）

#### 強み
1. **完全な安定性**: SD=0.0
   - Run1とRun2で同一スコア（9.0pt）を達成
   - 検出パターンが完全に一致（P01, P02, P03, P04, P05, P09, P10=△）

2. **重大問題の検出率100%**: P01, P02, P03をすべて検出
   - デバイス認証キー（P01）: mTLS証明書ベース認証を提案
   - JWT保存方式（P02）: iOS Keychain / Android Keystoreを提案
   - 権限チェック（P03）: 権限昇格リスクを指摘

3. **認証・認可カテゴリの検出率100%**: P01, P02, P03, P05, P09を全検出
   - 認証・認可設計の基本的な欠陥を見逃さない

#### 弱み
1. **入力検証設計の検出率0%**: P06（センサーデータAPI入力検証）とP07（冪等性保証）を両方とも未検出
   - 日時パラメータの検証やDoSリスクの指摘が欠如
   - 冪等性キー（Idempotency Key）の欠如を見逃し

2. **データ保護カテゴリの部分的な弱み**: P08（ログマスキング）を未検出
   - ただし、P04（S3 URL有効期限）は100%検出

3. **APIレート制限の深掘り不足**: P10で部分検出（△）
   - IPベースの限界を明示的に指摘していない

#### 教訓
- baselineは認証・認可設計に強く、安定性が極めて高い
- 入力検証設計とログセキュリティを強化する余地がある（次回の改善ポイント）

---

### 4. 独立変数ごとの効果分析

#### S1b（ドメイン特化Few-shot/クリティカルチェック）
- **効果**: -3.75pt（大幅低下）
- **安定性**: SD=0.75（中安定）
- **結論**: 出力例6個への拡張は逆効果。基本的な認証・認可問題の見落としを誘発。

#### M1a（事前分析+本レビュー分離）
- **効果**: -0.25pt（有意差なし、<0.5pt）
- **安定性**: SD=1.75（低安定）
- **結論**: 高い潜在能力（Run2で10.5pt）を持つが、安定性が極めて低く、現時点では採用リスクが高い。

---

## 次回への示唆

### 1. 入力検証設計の検出強化（最優先）
- **問題**: P06（センサーデータAPI入力検証）とP07（冪等性保証）は全バリアントで未検出または部分検出
- **対策**: S1b（指示セクション展開）を用いて、以下を明示的に追加
  - 「APIパラメータの入力検証（日時範囲、期間制限、start < endチェック）の有無を確認せよ」
  - 「決済・金融取引・制御コマンドにおける冪等性保証（Idempotency Key等）の有無を確認せよ」

### 2. ログマスキングの検出強化
- **問題**: P08（ログマスキング）はbaselineとdecomposition Run1で未検出
- **対策**: S1b（指示セクション展開）を用いて、「ログ出力における機密データのマスキング」を明示的に強調

### 3. M1aの安定性改善は見送り
- **理由**: SD=1.75と極めて不安定であり、追加検証なしでの採用はリスクが高い
- **代替案**: baselineの弱点（入力検証、ログマスキング）をS1bで補強する方が安全

### 4. 次回バリアント提案
- **バリアントA**: baseline + S1b（入力検証・冪等性・ログマスキングのチェック項目追加、出力例は3個以下に制限）
- **バリアントB**: baseline + C1a（CoT段階的分析、Round 2で+0.25pt）の再検証
- **目標スコア**: 10.0pt以上（入力検証設計の検出率を50%→100%に改善）

---

## 収束判定への示唆

### 現状分析
- **Round 2**: baseline（10.25pt）→ Round 3: baseline（9.0pt）
  - 変化: -1.25pt（テスト対象文書の違いによる変動の可能性）
- **最高スコアバリアント**: Round 2: cot-analysis（10.5pt）→ Round 3: baseline（9.0pt）
  - 改善幅: -1.5pt

### 収束判定
**継続推奨** - 以下の理由により、最適化は収束していない:

1. **入力検証設計の明確な弱点**: P06, P07を全バリアントで未検出（検出率0%）
2. **明確な改善の方向性あり**: S1b（出力例3個以下、チェック項目10個以下）で入力検証を強化
3. **Round 2とRound 3のスコア差**: テスト対象文書の違いによる変動の可能性があり、安定した改善傾向を確認するにはさらなるラウンドが必要

### 次回ラウンドの戦略
- **テスト対象文書**: ヘルスケアデータ管理システム、金融決済プラットフォーム等の新ドメイン
- **検証バリアント**: baseline + S1b（入力検証特化）
- **目標**: 入力検証設計の検出率100% + 総合スコア10.0pt以上
