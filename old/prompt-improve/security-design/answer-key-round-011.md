# 正解キー: Round 011

## 実行条件
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: JWT トークンの安全でない保管方法
- **カテゴリ**: 認証設計（データ保護）
- **深刻度**: 重大
- **該当箇所**: セクション5「API設計」の認証・認可方式
- **問題の説明**: JWTトークンをlocalStorageに保存する設計になっている。localStorageはJavaScriptからアクセス可能なため、XSS攻撃によりトークンが窃取される危険性がある。httpOnlyクッキーを使用すべき。
- **検出判定基準**:
  - ○（検出）: JWTトークンをlocalStorageに保存するセキュリティリスク（XSS攻撃によるトークン窃取）を指摘し、httpOnlyクッキーなどの代替手段を提案している
  - △（部分検出）: JWTの保管方法にリスクがあることに言及しているが、具体的な攻撃シナリオ（XSS）や対策（httpOnlyクッキー）に触れていない
  - ×（未検出）: JWTの保管方法に関する指摘がない

### P02: パスワードリセットトークンの有効期限設計が欠如
- **カテゴリ**: 認証設計
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」の認証エンドポイント
- **問題の説明**: パスワードリセットエンドポイント (`POST /api/auth/password-reset`) は定義されているが、リセットトークンの有効期限設計が明記されていない。長すぎる有効期限はセキュリティリスクとなる。
- **検出判定基準**:
  - ○（検出）: パスワードリセットトークンの有効期限設計が欠如していることを指摘し、短時間（例: 1時間以内）の有効期限を推奨している
  - △（部分検出）: パスワードリセット機能のセキュリティに言及しているが、有効期限の具体的な設計に触れていない
  - ×（未検出）: パスワードリセット機能のセキュリティに関する指摘がない

### P03: 予約キャンセルAPIの認可チェック設計が欠如
- **カテゴリ**: 認可設計
- **深刻度**: 重大
- **該当箇所**: セクション5「API設計」の予約エンドポイント
- **問題の説明**: `DELETE /api/bookings/:id` エンドポイントで予約キャンセルを行う際、予約の所有者確認（user_idのチェック）に関する設計が明記されていない。他のユーザーの予約をキャンセルできる権限昇格の脆弱性につながる可能性がある。
- **検出判定基準**:
  - ○（検出）: 予約キャンセルAPIで予約所有者の確認（認可チェック）が欠如していることを指摘し、user_idの検証や所有者チェックの必要性を提案している
  - △（部分検出）: 予約APIの認可に関する懸念に言及しているが、具体的な所有者確認の設計について触れていない
  - ×（未検出）: 予約キャンセルAPIの認可に関する指摘がない

### P04: データベース接続文字列の保管方法が未定義
- **カテゴリ**: データ保護（シークレット管理）
- **深刻度**: 重大
- **該当箇所**: セクション2「技術スタック」とセクション7「非機能要件」
- **問題の説明**: データベース接続に関する記述はあるが、データベース接続文字列やクレデンシャルの安全な保管方法（例: AWS Secrets Manager、環境変数の暗号化）が明記されていない。平文での保存や設定ファイルへのハードコーディングのリスクがある。
- **検出判定基準**:
  - ○（検出）: データベース接続文字列やクレデンシャルの安全な保管方法（AWS Secrets Manager、KMS、環境変数の暗号化など）が設計されていないことを指摘している
  - △（部分検出）: シークレット管理の必要性に言及しているが、データベース接続情報の具体的な保管方法について触れていない
  - ×（未検出）: データベース接続情報の保管方法に関する指摘がない

### P05: 入力検証方針が未定義
- **カテゴリ**: 入力検証設計
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」とセクション6「実装方針」
- **問題の説明**: APIエンドポイントは定義されているが、外部入力（リクエストパラメータ、JSONボディ）に対する検証方針が明記されていない。SQLインジェクションやXSSなどの攻撃に対する防御策が不足している。
- **検出判定基準**:
  - ○（検出）: 外部入力の検証方針が欠如していることを指摘し、バリデーションルール（型チェック、長さ制限、ホワイトリスト）や出力エスケーピングの必要性を提案している
  - △（部分検出）: 入力検証の必要性に言及しているが、具体的な検証方針やSQLインジェクション/XSS対策について触れていない
  - ×（未検出）: 入力検証方針に関する指摘がない

### P06: ログ出力における個人情報の取り扱い方針が未定義
- **カテゴリ**: データ保護（プライバシー）
- **深刻度**: 中
- **該当箇所**: セクション6「実装方針」のロギング方針
- **問題の説明**: ログ出力方針は定義されているが、個人情報（メールアドレス、電話番号、決済情報）のマスキング方針が明記されていない。GDPRやプライバシー法令違反のリスクがある。
- **検出判定基準**:
  - ○（検出）: ログ出力時の個人情報マスキング方針が欠如していることを指摘し、PII（個人識別情報）や機密データのマスキング・フィルタリングの必要性を提案している
  - △（部分検出）: ログのプライバシー保護に言及しているが、具体的なマスキング方針について触れていない
  - ×（未検出）: ログの個人情報保護に関する指摘がない

### P07: Elasticsearch のアクセス制御設計が欠如
- **カテゴリ**: インフラ・依存関係のセキュリティ
- **深刻度**: 中
- **該当箇所**: セクション2「技術スタック」とセクション3「アーキテクチャ設計」
- **問題の説明**: Elasticsearchを検索エンジンとして使用しているが、アクセス制御やネットワーク制限の設計が明記されていない。未承認アクセスによるデータ漏洩のリスクがある。
- **検出判定基準**:
  - ○（検出）: Elasticsearchのアクセス制御（認証、ロールベースアクセス、VPC内配置、IPホワイトリスト）が設計されていないことを指摘している
  - △（部分検出）: Elasticsearchのセキュリティに言及しているが、具体的なアクセス制御の設計について触れていない
  - ×（未検出）: Elasticsearchのアクセス制御に関する指摘がない

### P08: 決済API のレート制限設計が欠如
- **カテゴリ**: 脅威モデリング（DoS防止）
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」の決済エンドポイント
- **問題の説明**: 決済APIエンドポイント（`POST /api/payments`）にレート制限の設計が明記されていない。不正利用や攻撃による過剰なリクエストを防ぐための対策が不足している。
- **検出判定基準**:
  - ○（検出）: 決済APIにレート制限の設計が欠如していることを指摘し、ユーザー単位またはIP単位のレート制限実装の必要性を提案している
  - △（部分検出）: レート制限の必要性に言及しているが、決済APIに特化した対策について触れていない
  - ×（未検出）: 決済APIのレート制限に関する指摘がない

### P09: サードパーティAPI（サプライヤーAPI）のタイムアウト設計が欠如
- **カテゴリ**: 脅威モデリング（DoS防止）
- **深刻度**: 軽微
- **該当箇所**: セクション3「アーキテクチャ設計」のデータフロー
- **問題の説明**: Search Serviceが複数サプライヤーAPIを並列呼び出しする設計になっているが、タイムアウト設定やリトライポリシーが明記されていない。遅延攻撃やサプライヤーAPIの障害により自システムのリソースが枯渇する可能性がある。
- **検出判定基準**:
  - ○（検出）: サードパーティAPIのタイムアウト設定やサーキットブレーカーの設計が欠如していることを指摘し、リソース枯渇のリスクと対策を提案している
  - △（部分検出）: サードパーティAPIの障害対策に言及しているが、タイムアウトやサーキットブレーカーの具体的な設計について触れていない
  - ×（未検出）: サードパーティAPIのタイムアウト設計に関する指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 監査ログ設計 | 重要操作（予約作成、決済、キャンセル）の監査ログ設計が欠如 | 監査ログやログ保全の必要性を指摘している |
| B02 | データ保護 | PostgreSQL/Redisの暗号化（保存時暗号化）設計が未定義 | データベースの暗号化（at-rest encryption）の必要性を指摘している |
| B03 | CSRF対策 | state-changingなAPI（POST/PUT/DELETE）にCSRF対策の記載がない | CSRF対策（CSRFトークン、SameSite属性）の必要性を指摘している |
| B04 | 認証設計 | SNSアカウント連携時のOAuth実装方針が未定義 | OAuth実装のセキュリティベストプラクティス（state parameter、PKCE）を指摘している |
| B05 | データ保護 | Stripe決済情報（カード番号）の保管方針が未定義 | 決済情報のPCI DSS準拠やトークン化の必要性を指摘している |
| B06 | 認可設計 | ビジネスアカウント向け出張管理機能のロールベースアクセス制御が不明確 | 企業管理者と一般社員の権限分離設計の必要性を指摘している |
| B07 | 入力検証設計 | レビュー投稿時のコンテンツフィルタリング方針が不明確 | 不適切コンテンツ検出のフィルタリングロジックやレート制限を指摘している |
