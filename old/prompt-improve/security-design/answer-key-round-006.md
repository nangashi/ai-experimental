# 正解キー - Round 006

## 実行条件
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 10問

## 埋め込み問題一覧

### P01: JWTトークンのlocalStorage保存によるXSS脆弱性
- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **該当箇所**: セクション5「API設計」→「認証・認可方式」（119-123行目）
- **問題の説明**: JWTトークンをlocalStorageに保存する設計は、XSS攻撃によってトークンが窃取されるリスクがある。localStorageはJavaScriptから自由にアクセスできるため、XSS脆弱性が存在する場合、攻撃者がトークンを盗むことができる。HttpOnly Cookieを使用すべきである。
- **検出判定基準**:
  - ○（検出）: JWTをlocalStorageに保存することのXSSリスクを指摘し、HttpOnly Cookie等の代替手段を推奨している
  - △（部分検出）: JWTの保存方法にセキュリティリスクがあると指摘しているが、具体的な攻撃手法（XSS）や代替手段に言及していない
  - ×（未検出）: JWTの保存方法について何も指摘していない

### P02: 認証なしのStripe Webhook受信
- **カテゴリ**: インフラ・依存関係のセキュリティ
- **深刻度**: 重大
- **該当箇所**: セクション5「API設計」→「決済」（110-111行目）
- **問題の説明**: Stripe Webhookエンドポイント（`POST /api/payments/webhook`）に署名検証の記述がない。Webhookリクエストの真正性を検証しないと、攻撃者が偽の決済完了通知を送信し、不正にコースへのアクセス権を取得できる可能性がある。Stripe署名検証（stripe.webhooks.constructEvent）が必須である。
- **検出判定基準**:
  - ○（検出）: Stripe Webhookの署名検証の欠如を指摘し、偽造リクエストのリスクを説明している
  - △（部分検出）: Webhook受信の認証・検証が必要と指摘しているが、Stripe固有の署名検証に具体的に言及していない
  - ×（未検出）: Webhookエンドポイントのセキュリティについて何も指摘していない

### P03: ファイルアップロードのContent-Type検証欠如
- **カテゴリ**: 入力検証設計
- **深刻度**: 重大
- **該当箇所**: セクション5「API設計」→「動画管理」（100-104行目）、セクション2「技術スタック」→「主要ライブラリ」（32行目）
- **問題の説明**: 動画アップロード（`POST /api/videos`）や課題提出（`POST /api/submissions`）でmulterを使用しているが、ファイルタイプの検証方針が記載されていない。Content-Typeヘッダーは容易に偽装可能であり、マジックバイト検証やファイル拡張子ホワイトリストによる検証が必要である。不正なファイル（実行可能ファイル、マルウェア）のアップロードを防ぐべきである。
- **検出判定基準**:
  - ○（検出）: ファイルアップロード時のContent-Type偽装リスクを指摘し、マジックバイト検証やホワイトリスト検証の必要性を説明している
  - △（部分検出）: ファイルタイプの検証が必要と指摘しているが、Content-Type偽装の具体的リスクやマジックバイト検証に言及していない
  - ×（未検出）: ファイルアップロードの検証について何も指摘していない

### P04: レート制限の具体的方針欠如
- **カテゴリ**: 脅威モデリング（DoS対策）
- **深刻度**: 中
- **該当箇所**: セクション3「アーキテクチャ設計」→「主要コンポーネントの責務と依存関係」（37行目）
- **問題の説明**: API Gatewayでレート制限を行うと記載されているが、具体的な制限値（リクエスト数/時間窓）、適用範囲（IP単位、ユーザー単位、エンドポイント別）、超過時の処理（429エラー、バックオフ）が明記されていない。特にログインエンドポイント（`POST /api/auth/login`）は、ブルートフォース攻撃のターゲットになりやすく、厳格なレート制限が必須である。
- **検出判定基準**:
  - ○（検出）: レート制限の具体的方針（制限値、適用範囲、超過時処理）の欠如を指摘し、特にログインエンドポイントのブルートフォース対策の重要性に言及している
  - △（部分検出）: レート制限が不十分または具体性が欠如していると指摘しているが、ブルートフォース攻撃や具体的なパラメータに言及していない
  - ×（未検出）: レート制限について何も指摘していない

### P05: 決済処理の冪等性保証欠如
- **カテゴリ**: 認証・認可設計（決済セキュリティ）
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」→「決済」（109-111行目）
- **問題の説明**: 決済セッション作成API（`POST /api/payments/create`）に冪等性キーの設計が記載されていない。ネットワークエラーやクライアント側のリトライにより、同一決済が重複して作成される可能性がある。Stripe APIはIdempotency-Keyヘッダーをサポートしているため、これを利用した冪等性保証の設計が必要である。
- **検出判定基準**:
  - ○（検出）: 決済APIの冪等性欠如を指摘し、Idempotency-Keyまたは類似の冪等性保証メカニズムの必要性を説明している
  - △（部分検出）: 決済の重複処理リスクを指摘しているが、冪等性キーの具体的な実装方法に言及していない
  - ×（未検出）: 決済処理の冪等性について何も指摘していない

### P06: パスワードリセット・メール検証フローの欠如
- **カテゴリ**: 認証・認可設計
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」→「認証関連」（89-93行目）
- **問題の説明**: 認証関連エンドポイントにパスワードリセット（`POST /api/auth/reset-password`）やメールアドレス検証（`POST /api/auth/verify-email`）のAPIが含まれていない。パスワードリセット機能がない場合、ユーザーがパスワードを忘れた際にアカウントが使用不能になる。また、メール検証がない場合、不正なメールアドレスでの登録や、他人のメールアドレスを使った登録が可能になり、スパムやなりすましのリスクがある。
- **検出判定基準**:
  - ○（検出）: パスワードリセット機能とメール検証機能の両方の欠如を指摘し、セキュリティリスクを説明している
  - △（部分検出）: パスワードリセットまたはメール検証のいずれか一方のみを指摘している
  - ×（未検出）: パスワードリセットやメール検証について何も指摘していない

### P07: 動画ストリーミングURLの署名付きURL方針欠如
- **カテゴリ**: データ保護
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」→「動画管理」（104行目）
- **問題の説明**: 動画ストリーミングURL取得API（`GET /api/videos/:id/stream`）で、S3の署名付きURL（Presigned URL）や有効期限の設計が明記されていない。署名なしの恒久的URLを返す場合、URLが漏洩すると無制限にコンテンツにアクセスできてしまう。有料コンテンツの不正アクセスを防ぐため、有効期限付きの署名付きURLを生成すべきである。
- **検出判定基準**:
  - ○（検出）: 動画ストリーミングURLに署名付きURL（Presigned URL）や有効期限の設定が必要であることを指摘している
  - △（部分検出）: 動画URLのアクセス制御が不十分と指摘しているが、署名付きURLや有効期限の具体的な実装に言及していない
  - ×（未検出）: 動画ストリーミングURLのセキュリティについて何も指摘していない

### P08: 課題評価時の権限検証の曖昧さ
- **カテゴリ**: 認証・認可設計
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」→「課題管理」（108行目）
- **問題の説明**: 課題評価API（`PUT /api/submissions/:id/grade`）が「教師のみ」と記載されているが、教師が他のコースの課題を評価できないようにする認可チェック（コース所有権検証）の設計が明記されていない。教師Aが教師Bのコースの課題を不正に評価できる可能性がある。リソースベースの認可（submission → assignment → course → teacher_id）の検証が必要である。
- **検出判定基準**:
  - ○（検出）: 課題評価APIで教師が他のコースの課題を評価できる可能性を指摘し、リソースベースの認可チェックの必要性を説明している
  - △（部分検出）: 課題評価の権限検証が不十分と指摘しているが、具体的なリソース所有権検証のロジックに言及していない
  - ×（未検出）: 課題評価の認可について何も指摘していない

### P09: エラーレスポンスでの情報漏洩リスク
- **カテゴリ**: 情報漏洩防止（Information Disclosure）
- **深刻度**: 軽微
- **該当箇所**: セクション6「実装方針」→「エラーハンドリング方針」（127-130行目）
- **問題の説明**: エラーレスポンスで「本番環境ではスタックトレースを含めない」と記載されているが、エラーメッセージ自体の情報漏洩リスク（DBスキーマ、内部パス、バージョン情報の露出）に対する方針が明記されていない。汎用的なエラーメッセージを返し、詳細なエラー情報はログにのみ記録すべきである。
- **検出判定基準**:
  - ○（検出）: エラーメッセージ内容の情報漏洩リスク（DBスキーマ、内部パス等の露出）を指摘し、汎用メッセージの使用を推奨している
  - △（部分検出）: エラーレスポンスのセキュリティリスクを指摘しているが、具体的な情報漏洩の種類や汎用メッセージの必要性に言及していない
  - ×（未検出）: エラーレスポンスの情報漏洩について何も指摘していない

### P10: ログ記録範囲の不足（監査ログ・認可失敗ログ）
- **カテゴリ**: 情報漏洩防止（監査証跡）
- **深刻度**: 軽微
- **該当箇所**: セクション6「実装方針」→「ロギング方針」（132-136行目）
- **問題の説明**: ロギング方針にアクセスログの記録は記載されているが、認可失敗（403エラー）や異常なアクセスパターンの記録が明記されていない。また、機密操作（課題評価、決済処理、ユーザー削除等）の監査ログ（Who, What, When）の設計が欠如している。セキュリティインシデント発生時の調査や、内部不正の検知に監査ログは不可欠である。
- **検出判定基準**:
  - ○（検出）: 認可失敗ログや機密操作の監査ログ（Who, What, When）の欠如を指摘し、セキュリティインシデント調査の重要性を説明している
  - △（部分検出）: ログ記録範囲が不十分と指摘しているが、監査ログや認可失敗ログの具体的な必要性に言及していない
  - ×（未検出）: ログ記録範囲について何も指摘していない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 認証・認可設計 | JWT有効期限（24時間）が長すぎることによるトークン窃取時の影響拡大リスク | 短い有効期限とリフレッシュトークンの組み合わせを推奨している |
| B02 | 入力検証設計 | SQLインジェクション対策としてパラメータ化クエリのみに依存し、入力値の型・形式検証（バリデーション）が記載されていない | 入力値のホワイトリスト検証やサニタイゼーションの必要性を指摘している |
| B03 | データ保護 | HTTPS通信の記載はあるがTLSバージョンの最小値（TLS 1.2以上）が明記されていない | TLS 1.0/1.1の無効化を推奨している |
| B04 | インフラ・依存関係 | 依存ライブラリの脆弱性スキャン（npm audit, Snyk等）やアップデート方針が記載されていない | 定期的な脆弱性スキャンとパッチ適用プロセスの必要性を指摘している |
| B05 | 認証・認可設計 | アカウントロックアウト機能（連続ログイン失敗時の一時ロック）の記載がない | ブルートフォース対策としてアカウントロックアウトの実装を推奨している |
| B06 | データ保護 | S3バケットのアクセス制御（バケットポリシー、IAMロール）の設計が明記されていない | S3バケットのパブリックアクセス禁止設定や最小権限の原則を推奨している |
| B07 | 脅威モデリング | CSRF対策の記載がない（JWTをlocalStorageに保存する場合、通常CSRFトークンは不要だが、その判断根拠が説明されていない） | CSRF対策の必要性判断とその理由を明示的に説明している |
| B08 | データ保護 | 個人情報（PII）や機密データの暗号化範囲が明確でない（DB保存時の暗号化、特に課題提出ファイルやフィードバック） | DB保存時の暗号化（Encryption at Rest）の必要性を指摘している |
