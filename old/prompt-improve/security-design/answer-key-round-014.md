# 正解キー

## 実行条件
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: JWTトークンの有効期限が長すぎる
- **カテゴリ**: 認証設計
- **深刻度**: 中
- **該当箇所**: セクション5 API設計 - 認証
- **問題の説明**: JWTトークンの有効期限が24時間に設定されており、トークンが漏洩した場合に長時間悪用される可能性がある。一般的には短い有効期限（15分～1時間）を設定し、リフレッシュトークンで更新する設計が推奨される。
- **検出判定基準**:
  - ○（検出）: JWTトークンの有効期限24時間が長すぎることを指摘し、短縮（1時間以内など）を推奨している
  - △（部分検出）: トークン有効期限に言及しているが、具体的な推奨値や24時間が長すぎる理由を説明していない
  - ×（未検出）: JWTトークン有効期限に関する指摘がない

### P02: パスワードリセットトークンのセキュリティ仕様が不明確
- **カテゴリ**: 認証設計
- **深刻度**: 重大
- **該当箇所**: セクション5 API設計 - 認証・認可
- **問題の説明**: `/auth/password-reset` エンドポイントの設計でパスワードリセットトークンの有効期限、使用回数制限、安全な配信方法（HTTPSリンク、短命トークン等）が明記されていない。
- **検出判定基準**:
  - ○（検出）: パスワードリセットトークンの有効期限、使用回数制限（ワンタイムトークン）、または安全な配信方法のいずれかの欠如を指摘している
  - △（部分検出）: パスワードリセット機能のセキュリティに言及しているが、トークン管理の具体的な問題点を特定していない
  - ×（未検出）: パスワードリセット機能のセキュリティに関する指摘がない

### P03: 注文ステータス更新APIの認可設計が不十分
- **カテゴリ**: 認可設計
- **深刻度**: 重大
- **該当箇所**: セクション5 API設計 - 注文管理
- **問題の説明**: `PATCH /api/v1/orders/{orderId}/status` エンドポイントに誰がどのステータスに更新できるかの認可ルール（店舗スタッフのみ PREPARING に更新可能、配達パートナーのみ DELIVERING/COMPLETED に更新可能等）が設計されていない。
- **検出判定基準**:
  - ○（検出）: 注文ステータス更新APIにおいて、ロール別の認可制御（店舗・配達パートナー・顧客の権限分離）が不明確または欠如していることを指摘している
  - △（部分検出）: 注文APIの認可に言及しているが、ステータス更新の権限分離の具体的な問題に触れていない
  - ×（未検出）: 注文ステータス更新の認可に関する指摘がない

### P04: 決済APIにおける冪等性とリプレイ攻撃対策の欠如
- **カテゴリ**: 入力検証設計
- **深刻度**: 重大
- **該当箇所**: セクション5 API設計 - 決済
- **問題の説明**: `POST /api/v1/payments` において、同一リクエストの重複実行を防ぐ冪等性キー（Idempotency Key）やリプレイ攻撃対策（nonce、タイムスタンプ検証等）の設計が記載されていない。
- **検出判定基準**:
  - ○（検出）: 決済APIの冪等性キー、リプレイ攻撃対策（nonce/タイムスタンプ検証）のいずれかが欠如していることを指摘している
  - △（部分検出）: 決済の重複処理リスクに言及しているが、冪等性キーやリプレイ攻撃対策の具体的な仕組みに触れていない
  - ×（未検出）: 決済APIの冪等性またはリプレイ攻撃に関する指摘がない

### P05: データベースのカード情報保存がPCI DSS違反リスク
- **カテゴリ**: データ保護
- **深刻度**: 重大
- **該当箇所**: セクション4 データモデル - Payments
- **問題の説明**: Paymentsテーブルに `card_last4` が保存されているが、カード情報の保存方針（トークン化、外部決済サービス利用、PCI DSS準拠）が設計書に明記されていない。カード情報を自社DBに保存する場合、PCI DSS Level 1 準拠が必須となる。
- **検出判定基準**:
  - ○（検出）: カード情報の保存におけるPCI DSS準拠の欠如、またはトークン化・外部決済サービス利用の必要性を指摘している
  - △（部分検出）: カード情報の保護に言及しているが、PCI DSSやトークン化の具体的な対策に触れていない
  - ×（未検出）: カード情報の保存に関するセキュリティ指摘がない

### P06: 配達先住所の入力検証とインジェクション対策の欠如
- **カテゴリ**: 入力検証設計
- **深刻度**: 中
- **問題の説明**: Ordersテーブルの `delivery_address` (TEXT型) に対する入力検証ルール（文字数制限、特殊文字制限、SQLインジェクション対策）が設計されていない。
- **検出判定基準**:
  - ○（検出）: delivery_address フィールドの入力検証（文字数制限、特殊文字制限）またはSQLインジェクション対策の欠如を指摘している
  - △（部分検出）: 入力検証の一般的な必要性に言及しているが、delivery_address の具体的なリスクに触れていない
  - ×（未検出）: delivery_address の入力検証に関する指摘がない

### P07: API レート制限の仕様が不明確
- **カテゴリ**: 脅威モデリング (DoS)
- **深刻度**: 中
- **該当箇所**: セクション3 アーキテクチャ設計、セクション7 非機能要件
- **問題の説明**: API Gatewayにレート制限機能があることは記載されているが、具体的なレート制限値（例: 100 req/min per user）、適用範囲（エンドポイント別、ユーザー別）、レート制限超過時の挙動（HTTP 429返却等）が設計されていない。
- **検出判定基準**:
  - ○（検出）: API レート制限の具体的な値、適用範囲（エンドポイント別/ユーザー別）、または超過時の挙動が不明確であることを指摘している
  - △（部分検出）: レート制限の必要性に言及しているが、具体的な設計不足の指摘がない
  - ×（未検出）: レート制限に関する指摘がない

### P08: ログにクレジットカード情報や個人情報が記録されるリスク
- **カテゴリ**: データ保護
- **深刻度**: 中
- **該当箇所**: セクション6 実装方針 - ロギング方針
- **問題の説明**: ロギング方針に「アクセスログにはユーザーID、リクエストパス、レスポンスステータス、処理時間を記録」とあるが、リクエストボディやレスポンスボディに含まれる機密情報（カード情報、パスワード、個人情報）のマスキング・除外ルールが明記されていない。
- **検出判定基準**:
  - ○（検出）: ログ記録における機密情報（カード情報、パスワード、個人情報）のマスキングまたは除外ルールの欠如を指摘している
  - △（部分検出）: ログのセキュリティに言及しているが、機密情報マスキングの具体的な欠如に触れていない
  - ×（未検出）: ログにおける機密情報保護に関する指摘がない

### P09: S3バケットのアクセス制御とパブリック公開設定の未定義
- **カテゴリ**: インフラ・依存関係のセキュリティ
- **深刻度**: 中
- **該当箇所**: セクション6 実装方針 - デプロイメント方針
- **問題の説明**: 静的ファイル（画像、メニュー写真）をS3 + CloudFront経由で配信する設計だが、S3バケットのアクセス制御ポリシー（パブリック公開設定、IAMロール、バケットポリシー）が設計書に記載されていない。
- **検出判定基準**:
  - ○（検出）: S3バケットのアクセス制御（パブリックアクセスブロック、バケットポリシー、IAMロール）の設計欠如を指摘している
  - △（部分検出）: S3のセキュリティに言及しているが、アクセス制御の具体的な設計不足に触れていない
  - ×（未検出）: S3バケットのアクセス制御に関する指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 認証設計 | 2要素認証（MFA）の設計が欠如している | MFAまたは2FAの必要性を指摘 |
| B02 | 監査ログ設計 | 注文作成・決済・配達完了等の重要操作の監査ログ（変更履歴、操作者記録）設計が不足 | 監査ログまたは操作履歴の欠如を指摘 |
| B03 | データ保護 | RDS (PostgreSQL) の暗号化（保存時暗号化、転送時暗号化）の記載がない | データベース暗号化の欠如を指摘 |
| B04 | データ保護 | Redis セッションストアの暗号化またはアクセス制御の記載がない | Redis のセキュリティ設定（暗号化、認証）の欠如を指摘 |
| B05 | 認可設計 | 顧客が他の顧客の注文を閲覧できるIDOR脆弱性のリスク（GET /api/v1/orders での認可チェック不足） | IDOR脆弱性またはリソース所有者チェックの欠如を指摘 |
| B06 | 入力検証設計 | ファイルアップロード（メニュー写真等）のサイズ・拡張子・MIME type検証の設計がない | ファイルアップロード検証の欠如を指摘 |
| B07 | 脅威モデリング (CSRF) | state-changing API（POST /orders, PATCH /orders/{id}/status）にCSRF対策の記載がない | CSRF対策の欠如を指摘 |
| B08 | インフラ・依存関係 | Spring Security 6.1, Hibernate 6.2, Jackson 2.15 の脆弱性チェック方針（依存関係スキャン）の記載がない | 依存関係の脆弱性管理または自動スキャンツールの欠如を指摘 |
