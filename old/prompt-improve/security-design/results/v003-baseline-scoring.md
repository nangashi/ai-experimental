# 採点結果: v003-baseline

## 実行条件
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 10問
- **実行回数**: 2回（Run1, Run2）

---

## 検出マトリクス

| 問題ID | カテゴリ | 深刻度 | Run1 | Run2 | 判定根拠 |
|--------|---------|--------|------|------|---------|
| P01 | 認証・認可設計 | 重大 | ○ | ○ | Run1: 1-1でdevice_keyのみでの認証の危険性を指摘し、mTLS証明書ベース認証を提案。Run2: 1-1で同様の指摘とmTLS提案。 |
| P02 | 認証・認可設計 | 重大 | ○ | ○ | Run1: 2-2でJWTトークンの保存方式（Keychain/Keystore）が未記載であることを明示的に指摘。Run2: 2-1でトークン保存方式の未定義を指摘し、React Native Keychainを推奨。 |
| P03 | 認証・認可設計 | 重大 | ○ | ○ | Run1: 1-4で権限チェックロジックが不明瞭であり、read権限ユーザーがコマンド送信できるリスクを指摘。Run2: 1-2でデバイス制御コマンドのユーザー権限に応じた認可不足を指摘。 |
| P04 | データ保護 | 中 | ○ | ○ | Run1: 1-2でS3 URLのアクセス制御方法が未記載であり、署名付きURL（15分有効期限）を提案。Run2: 1-3でS3 URLの保護不足を指摘し、署名付きURL（15分有効期限）を推奨。 |
| P05 | 認証・認可設計 | 中 | ○ | ○ | Run1: 1-5でリフレッシュトークンローテーション未実装を指摘し、具体的な実装方法を提示。Run2: 2-1でリフレッシュトークンのローテーション戦略が未定義であることを指摘。 |
| P06 | 入力検証設計 | 中 | × | × | Run1: センサーデータAPIの日時パラメータ検証には触れていない（2-3はデータ保持期間の話）。Run2: 同様に未検出。 |
| P07 | 入力検証設計 | 中 | × | × | Run1: 冪等性キーの欠如には言及なし（1-2はパラメータ検証の一般論）。Run2: 同様に未検出。 |
| P08 | データ保護 | 中 | × | × | Run1: ログ出力時の機密情報マスキング方針には触れていない。Run2: 同様に未検出。 |
| P09 | 認証・認可設計 | 軽微 | ○ | ○ | Run1: 2-7でMQTT BrokerのACL設計が不足していることを指摘。Run2: 1-6でMQTT BrokerのACL不足を指摘。 |
| P10 | インフラ・依存関係 | 軽微 | △ | △ | Run1: 2-1でAPIレート制限の詳細設計不足を指摘しているが、ユーザーベース制限の必要性には明示的に触れていない（エンドポイント別・ユーザー別として言及）。Run2: 2-2でエンドポイントごとのレート制限を提案しているが、IPベースの限界については明示的に言及なし。 |

**検出スコア**:
- Run1: 6.5 (○×6 + △×1 = 6.0 + 0.5)
- Run2: 6.5 (○×6 + △×1 = 6.0 + 0.5)

---

## ボーナス判定

### Run1

| ID | カテゴリ | 指摘内容 | 判定 | 理由 |
|----|---------|---------|------|------|
| B01 | データ保護 | センサーデータ（カメラ映像）の保存・転送時の暗号化欠落（1-3） | ○ | 正解キーB01に該当。カメラ映像のE2E暗号化とS3 SSE-KMSを提案。 |
| B02 | 認証・認可 | セッション無効化とログアウト機能の設計欠落（2-6） | ○ | 正解キーに未掲載だがセキュリティスコープ内の有益な指摘。 |
| B03 | 監査・監視 | デバイスの異常接続パターン検知（Run2の2-6に類似だが未記載） | - | Run1には該当指摘なし。 |
| B04 | 入力検証 | SQLインジェクション対策の未記載（1-5） | ○ | セキュリティスコープ内の重要な指摘。 |
| B05 | データ保護 | 機密データ（device_key）の暗号化保存（Run2の2-3に該当、Run1では未検出） | - | Run1には該当指摘なし。 |
| B06 | インフラ | OTA更新失敗時のロールバック機能（2-4） | ○ | 正解キーB03（署名アルゴリズム）ではないが、OTA更新のセキュリティ強化策として有益。 |
| B07 | 認証・認可 | Socket.IOのセキュリティ設定未記載（Run2の2-5に該当、Run1では記載なし） | - | Run1には該当指摘なし。 |
| B08 | インフラ | 依存ライブラリの脆弱性管理プロセス未設計（2-8） | ○ | 正解キーB07には該当しないが、インフラセキュリティの重要指摘。 |

**ボーナス合計**: 5件 → +2.5点（上限5件なので全カウント）

### Run2

| ID | カテゴリ | 指摘内容 | 判定 | 理由 |
|----|---------|---------|------|------|
| B01 | 入力検証 | SQLインジェクション対策の未記載（1-5） | ○ | セキュリティスコープ内の重要な指摘。 |
| B02 | データ保護 | 機密データ（device_key）の暗号化保存（2-3） | ○ | GDPRやPCI DSSの観点から暗号化at-restの欠如を指摘。 |
| B03 | インフラ | OTA更新失敗時のロールバック機能（2-4） | ○ | OTA更新のセキュリティ強化策として有益。 |
| B04 | 認証・認可 | Socket.IOのセキュリティ設定（CORS、認証）未記載（2-5） | ○ | 正解キーB09に該当。WebSocket認証とCORS設定を指摘。 |
| B05 | 監査・監視 | デバイスの最終接続日時を用いた異常検知（2-6） | ○ | セキュリティスコープ内の有益な追加指摘。 |

**ボーナス合計**: 5件 → +2.5点（上限5件なので全カウント）

---

## ペナルティ判定

### Run1

| 指摘内容 | 判定 | 理由 |
|---------|------|------|
| 2-3「センサーデータのアクセス制御とデータ保持期間」 | - | データ保持期間はDoS耐性（ストレージ無制限増加）の文脈で言及されており、セキュリティスコープ内と判断。 |
| 3-1「デバイス共有シナリオにおけるプライバシー設定」 | - | プライバシー要件の確認事項であり、スコープ内。 |
| 3-2「デバイスのオフライン時のコマンド処理方針」 | - | セキュリティリスク（古いコマンド実行）の文脈で言及されており、スコープ内。 |
| 3-3「GDPRおよびプライバシー規制への対応範囲」 | - | データ保護の一環としてスコープ内。 |

**ペナルティ合計**: 0件 → -0.0点

### Run2

| 指摘内容 | 判定 | 理由 |
|---------|------|------|
| 3-1「GDPRなどのプライバシー規制の適用範囲」 | - | データ保護の一環としてスコープ内。 |
| 3-2「デバイス証明書の発行・管理プロセス」 | - | 認証設計の実装詳細に関する確認事項でスコープ内。 |
| 3-3「インフラのネットワークセグメンテーション戦略」 | - | インフラセキュリティの一環としてスコープ内。 |

**ペナルティ合計**: 0件 → -0.0点

---

## スコア計算

### Run1
```
検出スコア: 6.5
ボーナス: +2.5 (5件)
ペナルティ: -0.0 (0件)
総合スコア: 9.0
```

### Run2
```
検出スコア: 6.5
ボーナス: +2.5 (5件)
ペナルティ: -0.0 (0件)
総合スコア: 9.0
```

### 統計
```
Mean: (9.0 + 9.0) / 2 = 9.0
SD: 0.0
安定性判定: 高安定 (SD ≤ 0.5)
```

---

## 総評

### 強み
1. **認証・認可設計の問題検出が強い**: P01, P02, P03, P05, P09を全て検出し、具体的な対策（mTLS、Keychain、ローテーション、ACL）を提示。
2. **OTA更新セキュリティに強い**: P04を検出し、署名付きURL（15分有効期限）という具体的な値まで提案。
3. **ボーナス指摘が豊富**: SQLインジェクション対策、Socket.IOセキュリティ、ログアウト機能、暗号化保存など、正解キー未掲載の重要問題を多数検出。
4. **完全安定**: 2回の実行で同一スコアを達成（SD=0.0）。

### 弱み
1. **入力検証設計の検出が弱い**: P06（センサーデータAPIの日時パラメータ検証）とP07（冪等性キー）を両方とも未検出。
2. **ログ出力のマスキング方針（P08）未検出**: データ保護カテゴリの問題だが、センサーデータの暗号化（B01）には言及している一方、ログマスキングには触れていない。
3. **APIレート制限の深掘り不足（P10）**: エンドポイント別やユーザー別の制限には言及しているが、IPベースの限界（複数IPによる回避、同一ネットワークからの誤検知）を明示的に指摘していない。

### 推奨改善策
1. **入力検証の網羅性向上**: APIのクエリパラメータ検証（日時範囲、期間制限）や冪等性保証を明示的にチェックリスト化。
2. **ログセキュリティの強化**: ログ出力時の機密情報マスキングを標準チェック項目に追加。
3. **レート制限の詳細化**: IPベースの限界を明示的に指摘し、ユーザーベース（JWT sub claim等）の制限を推奨。

---

## 検出パターン分析

### 高検出率カテゴリ（検出率 100%）
- **認証・認可設計**: P01, P02, P03, P05, P09を全検出
  - デバイス認証、JWT保存、権限チェック、トークンローテーション、MQTT ACL

### 中検出率カテゴリ（検出率 50-99%）
- **データ保護**: P04を検出、P08を未検出（検出率 50%）
  - OTA URL保護は検出したが、ログマスキングは未検出

### 低検出率カテゴリ（検出率 0-49%）
- **入力検証設計**: P06, P07を両方とも未検出（検出率 0%）
  - 日時パラメータ検証と冪等性キーの問題を見逃し

### 部分検出の特徴
- **P10（APIレート制限）**: エンドポイント別・ユーザー別の制限には言及しているが、IPベースの限界を明示的に指摘していないため△判定。
