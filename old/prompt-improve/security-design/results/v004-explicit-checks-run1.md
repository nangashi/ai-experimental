# セキュリティ設計レビュー結果

## レビュー対象
Enterprise HR & Payroll Management System - システム設計書

## スコアサマリ

| 観点 | スコア (1-5) | 主な理由 |
|-----|-------------|---------|
| 脅威モデリング（STRIDE） | 2 | STRIDE脅威の体系的な検討が欠落。Repudiation（否認防止）、DoS対策が未設計 |
| 認証・認可設計 | 2 | JWT有効期限24時間は長すぎ、リフレッシュトークン未実装、MFA未設計 |
| データ保護 | 1 | マイナンバー・口座番号が平文保存、JWT署名鍵が環境変数に平文保存 |
| 入力検証設計 | 2 | パラメータ検証方針が未設計、冪等性保証なし、ログに個人情報を出力 |
| インフラ・依存関係 | 3 | シークレット管理が不適切、依存関係の脆弱性管理は月次で実施 |
| **総合** | **2.0** | |

---

## 1. 重大な問題（設計の修正が必須）

### 1.1 マイナンバー・口座番号が平文でデータベースに保存されている

**問題の説明**:
- セクション4.1（データモデル）と7.2（セキュリティ要件）で、マイナンバー（`my_number`）と銀行口座番号（`bank_account`）を暗号化せずに保存する設計になっている
- 特にマイナンバーは個人番号法で厳格な安全管理措置が義務付けられており、平文保存は法令違反となる

**影響**:
- データベース侵害時に、全従業員のマイナンバーと口座番号が漏洩
- マイナンバー法違反により、個人情報保護委員会からの是正勧告や罰則の対象となる（法人：最大200万円の罰金）
- 顧客企業の信用失墜とサービス解約リスク

**推奨対策**:
- マイナンバーと口座番号をアプリケーション層で暗号化してから保存（AES-256-GCM推奨）
- 暗号鍵は AWS KMS で管理し、鍵のローテーションを実装
- データベースの`my_number`と`bank_account`カラムを`BYTEA`型に変更し、暗号化されたバイナリデータを保存
- 暗号化処理を行う専用の`EncryptionService`を実装し、Spring BootのコンバーターでEntity保存時に自動暗号化
- マイナンバーへのアクセスを監査ログに記録（個人番号法の安全管理措置として必須）

**該当箇所**:
- セクション4.1（`employees`テーブル定義）
- セクション7.2（セキュリティ要件 - 「暗号化なし」の記述）

---

### 1.2 JWT署名鍵とデータベースパスワードが環境変数に平文保存される

**問題の説明**:
- セクション6.5（デプロイメント方針）で、JWT署名鍵とデータベースパスワードを環境変数に平文で設定する設計になっている
- 環境変数は実行中のプロセスから`/proc/{pid}/environ`で読み取り可能であり、コンテナイメージにハードコードされるリスクもある

**影響**:
- JWT署名鍵が漏洩すると、攻撃者が任意のユーザーになりすました有効なトークンを生成可能（全アカウント乗っ取り）
- データベースパスワードが漏洩すると、全テナントの全データへの不正アクセスが可能

**推奨対策**:
- AWS Secrets Manager または AWS Systems Manager Parameter Store（SecureString）で秘密情報を管理
- アプリケーション起動時にAWS SDKでシークレットを取得し、メモリ上でのみ保持
- Spring Cloud AWS Secrets Manager Starter（v3.x）を使用して、`@Value`アノテーションで自動インジェクション
- シークレットのローテーション自動化（90日サイクル推奨）
- ECS Fargate の IAM Role for Tasks で最小権限原則を適用（特定のシークレットARNのみ読み取り許可）

**該当箇所**:
- セクション6.5（デプロイメント方針 - 「環境変数に平文で設定」の記述）

---

### 1.3 ログに個人情報を出力する設計

**問題の説明**:
- セクション6.3（ロギング方針）で「個人情報（氏名、メール、給与額）はログに出力する」と明記されている
- ログはDatadogに集約され、広範な開発者・運用担当者がアクセス可能となるため、個人情報保護法の利用目的逸脱に該当するリスク

**影響**:
- ログ経由で従業員の給与額や個人情報が開発者に閲覧される
- ログ管理システムの侵害時に、大量の個人情報が漏洩
- 個人情報保護法違反（利用目的の明示なくログに記録）により、個人情報保護委員会からの報告命令や公表のリスク

**推奨対策**:
- ログに個人情報（氏名、メール、給与額、マイナンバー、口座番号）を出力しない方針に変更
- ログには`employee_id`（UUID）のみを記録し、トラブルシューティング時に必要に応じてデータベースと突合
- Spring BootのLogback設定で、特定フィールドを自動マスキングする`MaskingPatternLayout`を実装
- 監査ログ（認証イベント、権限エラー、給与計算実行）は、個人を特定できない形式で記録（例: `employee_id`のみ、氏名は記録しない）
- Datadogのログアクセス権限を最小限に絞り、監査ログへのアクセスを別途管理

**該当箇所**:
- セクション6.3（ロギング方針 - 「個人情報はログに出力する」の記述）

---

### 1.4 JWT有効期限が24時間と長すぎる

**問題の説明**:
- セクション3.3（データフロー）と5.1（認証エンドポイント）で、JWTの有効期限を24時間に設定している
- リフレッシュトークンを発行せず、期限切れ時に再ログインを要求する設計（セクション6.1）

**影響**:
- トークンが窃取された場合（XSS、中間者攻撃、ログファイル漏洩など）、攻撃者は24時間にわたって被害者アカウントを乗っ取り可能
- ログアウト機能を実装してもトークン無効化ができないため、被害の即時停止が不可能

**推奨対策**:
- アクセストークンの有効期限を15分に短縮
- リフレッシュトークン（有効期限7日、ローテーション付き）を発行し、`POST /api/auth/refresh`でアクセストークンを更新
- リフレッシュトークンはRedisに保存し、ログアウト時やパスワード変更時に無効化できるようにする
- リフレッシュトークンのローテーション実装（RFC 6749推奨）：更新時に新しいリフレッシュトークンを発行し、古いトークンを無効化

**該当箇所**:
- セクション3.3（データフロー - 「JWT発行（有効期限24時間）」）
- セクション6.1（認証・認可方式 - 「リフレッシュトークンは発行せず」）

---

### 1.5 勤怠打刻APIに冪等性保証がない

**問題の説明**:
- セクション5.4の`POST /api/attendance/clock-in`および`clock-out`に、重複リクエスト防止の仕組みが設計されていない
- ネットワークタイムアウトやクライアントのリトライにより、同一従業員の出勤が2重に記録されるリスク

**影響**:
- 同一日に複数の勤怠記録が作成され、給与計算時に不正確なデータが使用される
- 勤怠データの整合性が損なわれ、手動での修正作業が必要になる

**推奨対策**:
- リクエストに`Idempotency-Key`ヘッダー（UUIDv4）の送信を必須化
- サーバー側でRedisに`Idempotency-Key`を24時間保存し、重複リクエストを検出して同一レスポンスを返す
- データベースに`attendance_records`テーブルの`(tenant_id, employee_id, record_date, type)`にユニーク制約を追加（type: CLOCK_IN/CLOCK_OUT）
- ユニーク制約違反時は409 Conflictを返し、既存の勤怠記録IDをレスポンスに含める

**該当箇所**:
- セクション5.4（勤怠管理エンドポイント）

---

## 2. 改善提案（設計の品質向上に有効）

### 2.1 APIエンドポイントにレート制限が未設計

**提案の説明**:
- 認証エンドポイント（`/api/auth/login`）や管理者エンドポイントにレート制限の記述がない
- ブルートフォース攻撃やアカウント列挙攻撃に対する防御が不十分

**理由**:
- HR・給与システムは機密性の高い個人情報を扱うため、不正アクセスの試行が多い
- 特にログインエンドポイントは、パスワードリストを使った自動化攻撃の標的になりやすい

**推奨対策**:
- Spring Boot Starter Actuator + Bucket4j（v8.x）で `/api/auth/login` に10回/分のレート制限を実装
- IPアドレス単位で5回失敗後、15分間のアカウントロック（`login_attempts`テーブルで管理）
- 管理者向けエンドポイント（`/api/admin/*`）に50回/分のレート制限を追加
- レート制限超過時は429 Too Many Requestsを返し、Retry-Afterヘッダーを含める
- Redisでレート制限カウンターを管理（Sliding Window Algorithm推奨）

**該当箇所**:
- セクション5.1（認証・認可エンドポイント）
- セクション3.2（主要コンポーネント）

---

### 2.2 多要素認証（MFA）が未設計

**提案の説明**:
- 認証設計にMFAの記述がなく、パスワードのみでログイン可能
- 管理者やHR担当者など、高権限ユーザーのアカウント乗っ取りリスクが高い

**理由**:
- 給与データやマイナンバーなど、極めて機密性の高い情報を扱うシステムでは、MFAは必須レベルのセキュリティ対策
- パスワード漏洩やフィッシング攻撃に対する追加の防御層が必要

**推奨対策**:
- 管理者（ADMIN）とHR担当者（HR_MANAGER）に対してMFAを必須化
- TOTP（Time-based One-Time Password）をサポート（Google Authenticator、Authyなど）
- MFA登録エンドポイント（`POST /api/auth/mfa/enroll`）でQRコード生成
- ログイン時にTOTPコード入力を要求（`POST /api/auth/mfa/verify`）
- バックアップコード（10個）を生成し、MFA端末紛失時のリカバリーパスを提供
- ライブラリ: java-totp（https://github.com/samdjstevens/java-totp）

**該当箇所**:
- セクション3.3（データフロー）
- セクション6.1（認証・認可方式）

---

### 2.3 APIリクエストのパラメータ検証方針が未設計

**提案の説明**:
- セクション6.2（エラーハンドリング方針）にバリデーションエラーの記述はあるが、具体的な検証ルールが設計されていない
- 従業員登録（`POST /api/employees`）などで、不正な入力値による攻撃やデータ不整合のリスク

**理由**:
- 入力検証の不備は、SQLインジェクション、XSS、ビジネスロジックのバイパスにつながる
- 給与額や社員番号などの重要フィールドで、範囲チェックや形式チェックが必要

**推奨対策**:
- Spring Boot Validation（Jakarta Bean Validation 3.0）で全APIリクエストにバリデーションを実装
- 従業員登録の検証ルール例:
  - `employee_code`: 正規表現 `^E[0-9]{3,6}$`（例: E001, E12345）
  - `email`: RFC 5322準拠のメールアドレス形式
  - `salary_amount`: 0 < amount ≤ 100,000,000（1億円以下）
  - `my_number`: 正規表現 `^[0-9]{12}$`
  - `phone_number`: 正規表現 `^0[0-9]{1,4}-[0-9]{1,4}-[0-9]{4}$`
- `@Valid`アノテーションをController引数に付与し、バリデーションエラー時は400 Bad Requestを返す
- カスタムバリデーター実装例: `@ValidBankAccount`（銀行口座番号のチェックディジット検証）

**該当箇所**:
- セクション5.2（従業員管理エンドポイント）
- セクション6.2（エラーハンドリング方針）

---

### 2.4 給与計算APIに再実行防止の仕組みがない

**提案の説明**:
- `POST /api/payroll/calculate`（セクション5.3）に、同一月の重複計算を防ぐ仕組みが設計されていない
- 誤操作やAPIの重複呼び出しで、給与が2重計算されるリスク

**理由**:
- 給与計算は従業員の収入に直結する重要な処理であり、重複実行は過払いや会計データの不整合を引き起こす
- 非同期処理（ジョブID返却）のため、ユーザーがリトライする可能性が高い

**推奨対策**:
- `payroll_records`テーブルの`(tenant_id, employee_id, payroll_month)`に複合ユニーク制約を追加
- 計算リクエスト時に、既存レコードのstatusを確認:
  - `DRAFT`または`APPROVED`: 409 Conflictを返し、既存のpayroll_record_idを通知
  - `PAID`: 403 Forbiddenを返し、「すでに支払い済み」のエラーメッセージ
- 給与計算ジョブ実行前に、Redisに`payroll_lock:{tenant_id}:{month}`キーで分散ロックを取得（TTL: 1時間）
- ジョブ完了時にロック解放。タイムアウト時は自動解放

**該当箇所**:
- セクション5.3（給与管理エンドポイント）
- セクション4.1（`payroll_records`テーブル定義）

---

### 2.5 データベース接続文字列に機密情報が含まれる可能性

**提案の説明**:
- セクション6.5で「データベース接続文字列」を環境変数で管理するとあるが、接続文字列にパスワードが含まれる形式（`postgresql://user:password@host/db`）の場合、環境変数経由で漏洩リスクがある

**理由**:
- 接続文字列の形式によっては、ログやエラーメッセージに出力される可能性
- AWS Secrets Managerで管理する場合、接続文字列全体ではなく、個別のパラメータ（ホスト、ユーザー、パスワード）に分離すべき

**推奨対策**:
- データベース接続情報をAWS Secrets Managerで以下のJSON形式で管理:
  ```json
  {
    "host": "mydb.region.rds.amazonaws.com",
    "port": 5432,
    "username": "hrapp",
    "password": "secure-random-password",
    "database": "hrdb"
  }
  ```
- Spring BootのDataSourceプロパティで個別に設定:
  ```yaml
  spring:
    datasource:
      url: jdbc:postgresql://${db.host}:${db.port}/${db.database}
      username: ${db.username}
      password: ${db.password}
  ```
- または、AWS RDS IAM Authentication を使用してパスワードレス認証を実装（推奨）

**該当箇所**:
- セクション6.5（デプロイメント方針）

---

### 2.6 SQLインジェクション対策の明示が不足

**提案の説明**:
- データベースアクセスにSpring Data JPAを使用する記述はあるが（セクション3.1）、SQLインジェクション対策の具体的な方針が設計書に明示されていない
- 動的クエリの扱い方が不明

**理由**:
- Spring Data JPAのJPQLやCriteria APIは基本的に安全だが、ネイティブクエリや動的クエリでは開発者が誤った実装をするリスクがある
- 特に検索機能（`GET /api/employees`のフィルタリング）で動的クエリを使う場合、SQLインジェクションのリスクが高い

**推奨対策**:
- すべてのデータベースアクセスでプリペアドステートメントまたはJPAのパラメータバインディングを使用することを明示
- ネイティブクエリ（`@Query(nativeQuery = true)`）の使用を原則禁止。必要な場合はコードレビューで承認を必須化
- 動的クエリは Spring Data JPA Specifications または QueryDSL を使用し、文字列連結を避ける
- 検索パラメータのホワイトリストチェック（許可されたカラム名のみ使用可能）

**該当箇所**:
- セクション3.1（全体構成）
- セクション5.2（従業員管理エンドポイント - クエリパラメータ）

---

### 2.7 依存関係の脆弱性管理が月次のみ

**提案の説明**:
- セクション7.2で「定期的な脆弱性スキャン（月次）」とあるが、重大な脆弱性（Log4Shell、Spring4Shellなど）への対応が遅れるリスク

**理由**:
- 広く利用されるライブラリの重大脆弱性は、公開から数時間で攻撃ツールが流通する
- 月次スキャンでは、最大30日間の脆弱性放置期間が発生

**推奨対策**:
- GitHub Dependabotまたは Snyk をCI/CDパイプラインに統合し、プルリクエスト時に自動脆弱性チェック
- CRITICAL / HIGH severity の脆弱性検出時は、Slackやメールでリアルタイム通知
- 脆弱性修正のSLA設定:
  - CRITICAL: 24時間以内にパッチ適用または緩和策実施
  - HIGH: 7日以内
  - MEDIUM: 30日以内
- 依存関係の自動更新（Renovate Bot推奨）で、安全なバージョンへの更新を自動化

**該当箇所**:
- セクション7.2（セキュリティ要件 - 「定期的な脆弱性スキャン（月次）」）

---

### 2.8 データベースバックアップの暗号化が未設計

**提案の説明**:
- セクション7.3で「日次フルバックアップ」の記述はあるが、バックアップデータの暗号化や保管方法が設計されていない

**理由**:
- バックアップファイルには全従業員のマイナンバー、給与額、口座番号が含まれる
- バックアップストレージへの不正アクセスやバックアップメディアの紛失時に、大量の個人情報が漏洩するリスク

**推奨対策**:
- AWS RDS の自動バックアップで暗号化を有効化（AES-256）
- バックアップの保管期間を35日に設定（RPO: 24時間を考慮）
- バックアップへのアクセス権限を最小限に制限（IAMポリシーで特定のロールのみ許可）
- バックアップのリストア訓練を四半期ごとに実施し、RPOを検証

**該当箇所**:
- セクション7.3（可用性・スケーラビリティ - 「データベースバックアップ: 日次フルバックアップ」）

---

## 3. 確認事項（ユーザーへの確認が必要）

### 3.1 Row-Level Securityの実装範囲

**確認理由**:
- セクション3.3で「Row-Level SecurityでテナントID自動フィルタ」とあるが、PostgreSQLのRLS機能を使うのか、アプリケーション層のフィルタリングなのか不明
- RLSの設定ミスは、テナント間のデータ漏洩という致命的な脆弱性につながる

**選択肢とトレードオフ**:
1. **PostgreSQL RLS（推奨）**:
   - メリット: データベース層で強制されるため、アプリケーションのバグでもテナント分離を保証
   - デメリット: 複雑なクエリでパフォーマンス劣化の可能性
2. **アプリケーション層フィルタリング**:
   - メリット: 実装が柔軟、パフォーマンスチューニングしやすい
   - デメリット: WHERE句の付け忘れでテナント漏洩リスク

**推奨確認事項**:
- PostgreSQL RLSを使用する場合、全テーブルにRLSポリシーを設定し、`ALTER TABLE ... ENABLE ROW LEVEL SECURITY`を実行
- Spring Securityの`@PreAuthorize`と組み合わせて、二重の防御層を構築
- 統合テストで、異なるテナントのデータが取得できないことを検証

---

### 3.2 S3バケットのアクセス制御方針

**確認理由**:
- セクション2.2で「Amazon S3（給与明細PDF、契約書類）」とあるが、S3バケットのアクセス制御方針が設計書に記載されていない
- 給与明細PDFには氏名、給与額、口座番号などの機密情報が含まれる

**選択肢とトレードオフ**:
1. **プライベートバケット + 署名付きURL**:
   - メリット: 最も安全。アプリケーションが発行した一時URLでのみアクセス可能
   - デメリット: URL生成の実装が必要
2. **パブリックバケット + オブジェクトキーの予測困難化**:
   - メリット: 実装が簡単
   - デメリット: オブジェクトキーが漏洩すると誰でもアクセス可能（非推奨）

**推奨確認事項**:
- S3バケットをプライベートに設定し、パブリックアクセスをすべてブロック
- 給与明細ダウンロードAPI（`GET /api/payroll/{id}/pdf`）で署名付きURL（有効期限5分）を生成
- S3オブジェクトキーを予測困難なUUIDで構成（例: `payroll/{tenant_id}/{employee_id}/{payroll_id}/{uuid}.pdf`）
- S3バケットでサーバーサイド暗号化（SSE-S3またはSSE-KMS）を有効化

---

## 4. 評価（良い点）

### 4.1 通信の暗号化が適切

- セクション7.2で「通信は全てHTTPSで暗号化」と明記されており、中間者攻撃に対する基本的な防御が設計されている

### 4.2 パスワードのハッシュ化にbcryptを使用

- セクション7.2で「パスワードはbcryptでハッシュ化（work factor 10）」とあり、レインボーテーブル攻撃に耐性のあるハッシュアルゴリズムを採用
- work factor 10は現在の標準的な設定として適切

### 4.3 マルチテナント構成でテナントIDによるデータ分離

- セクション3.1で「テナントIDによるデータ分離」が設計されており、SaaSアプリケーションとして適切なアーキテクチャ
- Row-Level Securityの実装により、データベース層でのテナント分離が強制される設計

### 4.4 監査ログの記録

- セクション6.3で「認証イベント、権限エラー、給与計算実行、従業員情報更新をすべて記録」とあり、インシデント調査やコンプライアンス対応に必要な監査証跡が確保されている

### 4.5 Spring Securityによる権限チェック

- セクション6.1で「Spring Securityの`@PreAuthorize`アノテーションで権限チェック」とあり、業界標準のフレームワークを使用した認可制御が設計されている

---

## まとめ

本設計書は、通信暗号化やパスワードハッシュ化など基本的なセキュリティ対策は含まれていますが、**以下の5つの重大な問題により、現状のままでは本番環境へのデプロイは推奨できません**:

1. マイナンバー・口座番号の平文保存（法令違反リスク）
2. JWT署名鍵とDBパスワードの平文保存（全アカウント乗っ取りリスク）
3. ログへの個人情報出力（データ漏洩リスク）
4. JWT有効期限24時間（トークン窃取時の被害拡大）
5. 勤怠打刻APIの冪等性欠如（データ整合性リスク）

これらの問題は、設計段階で修正することで大幅なコスト削減につながります。特に、マイナンバーの暗号化とシークレット管理の改善は、法令遵守とセキュリティの両面で必須の対策です。

また、8つの改善提案（レート制限、MFA、入力検証など）を実装することで、設計の品質を大幅に向上させることができます。
