# 採点結果: v004-explicit-checks

## 実行条件
- **バリアント名**: explicit-checks
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 10問
- **実行回数**: 2回

---

## 検出マトリクス

| 問題ID | カテゴリ | 深刻度 | Run1 | Run2 | 検出判定の根拠 |
|--------|----------|--------|------|------|----------------|
| P01 | データ保護 | 重大 | ○ (1.0) | ○ (1.0) | Run1: セクション1.1でマイナンバー・口座番号の平文保存を指摘し、AES-256-GCM暗号化を推奨。Run2: セクション1-1で同様に平文保存の法令違反リスクを指摘し、AES-256-GCM暗号化+AWS KMS管理を推奨。両方とも検出判定基準をすべて満たす。 |
| P02 | インフラ・依存関係 | 重大 | ○ (1.0) | ○ (1.0) | Run1: セクション1.2でJWT署名鍵とDBパスワードの環境変数平文保存を指摘し、AWS Secrets Manager利用を推奨。Run2: セクション1-2で同様の指摘とSecrets Manager推奨。両方とも検出判定基準を満たす。 |
| P03 | 入力検証設計 | 重大 | × (0.0) | △ (0.5) | Run1: CSRF保護に関する明示的な指摘なし（セクション2.1でレート制限、2.2でMFAに言及するがCSRFは未言及）。Run2: セクション2-5でCSRFトークン実装を推奨しているが、「JWTをCookieに保存する場合」という条件付きであり、設計書のCSRF保護欠如を直接指摘していない。Spring SecurityのCSRF保護機能の有効化を推奨しているため△。 |
| P04 | 入力検証設計 | 中 | ○ (1.0) | ○ (1.0) | Run1: セクション2.3で「APIリクエストのパラメータ検証方針が未設計」と指摘し、Spring Validationの実装を推奨。Run2: セクション1-7でパラメータ化クエリの使用が明記されていない点を指摘（SQLインジェクション対策）。Run1は入力検証方針の明示化を推奨しているため○。Run2はSQLインジェクション対策に焦点を当てているが、入力検証の設計が不明確な点も指摘しているため○。 |
| P05 | 入力検証設計 | 中 | ○ (1.0) | ○ (1.0) | Run1: セクション1.5で勤怠打刻APIの冪等性欠如を指摘し、Idempotency-Keyの実装を推奨。Run2: セクション1-5で同様に冪等性未設計を指摘し、idempotency_keyの導入を推奨。両方とも検出判定基準を満たす。 |
| P06 | 脅威モデリング | 中 | × (0.0) | × (0.0) | Run1: 監査ログについてセクション4.4で「認証イベント、権限エラー、給与計算実行、従業員情報更新をすべて記録」と良い点として評価しているが、照会操作（給与明細閲覧、従業員情報照会）の監査ログ欠如を指摘していない。Run2: セクション4-4で同様に監査ログの記録範囲を評価しているが、照会操作のログ記録不足には言及なし。両方とも×。 |
| P07 | データ保護 | 中 | ○ (1.0) | ○ (1.0) | Run1: セクション1.3で個人情報のログ出力の危険性を指摘し、ログマスキング・仮名化を推奨。Run2: セクション1-3で同様の指摘とマスキング推奨。両方とも検出判定基準を満たす。 |
| P08 | 脅威モデリング | 中 | ○ (1.0) | ○ (1.0) | Run1: セクション2.1でAPIレート制限が未設計と指摘し、Bucket4jでの実装とRedis管理を推奨。Run2: セクション1-6で「Denial of Service（DoS）対策の欠如」としてレート制限を指摘し、Spring Cloud GatewayのRedisRateLimiter導入を推奨。両方とも検出判定基準を満たす。 |
| P09 | 認証・認可設計 | 軽微 | × (0.0) | × (0.0) | Run1: エラーハンドリングに関してセクション2.3で「バリデーションエラー時は400 Bad Requestを返す」と言及があるが、データベースエラーのスタックトレース露出リスクには触れていない。Run2: セクション1-7でSQLインジェクション対策を指摘しているが、データベースエラーメッセージの詳細露出には言及なし。両方とも×。 |
| P10 | 認証・認可設計 | 軽微 | ○ (1.0) | ○ (1.0) | Run1: セクション1.4でJWT有効期限24時間が長すぎる点を指摘し、15分のアクセストークン+7日のリフレッシュトークン方式を推奨。Run2: セクション1-4で同様の指摘と推奨。両方とも検出判定基準を満たす。 |

---

## Run1 詳細スコア

### 検出スコア内訳
- P01 (データ保護・重大): ○ 1.0
- P02 (インフラ・重大): ○ 1.0
- P03 (入力検証・重大): × 0.0
- P04 (入力検証・中): ○ 1.0
- P05 (入力検証・中): ○ 1.0
- P06 (脅威モデリング・中): × 0.0
- P07 (データ保護・中): ○ 1.0
- P08 (脅威モデリング・中): ○ 1.0
- P09 (認証・認可・軽微): × 0.0
- P10 (認証・認可・軽微): ○ 1.0

**検出スコア合計**: 7.0/10.0

### ボーナス判定

| ID | 内容 | 判定 | 根拠 |
|----|------|------|------|
| B01 | 依存ライブラリの脆弱性スキャン頻度 | ○ (+0.5) | セクション2.7で「定期的な脆弱性スキャン（月次）」の頻度が低いと指摘し、GitHub DependabotやSnykのCI/CD統合を推奨 |
| B02 | bcrypt work factor | × | セクション4.2で「work factor 10は現在の標準的な設定として適切」と評価しており、引き上げ推奨なし |
| B03 | S3オブジェクト暗号化 | × | セクション3.2でS3バケットのアクセス制御を確認事項として挙げているが、署名付きURLの推奨のみで、SSE-S3/SSE-KMSの暗号化には言及なし |
| B04 | テナントID検証漏れ | × | セクション3.1でRow-Level Securityの実装範囲を確認事項として挙げているが、アプリケーション層でのテナントID検証の追加推奨はなし |
| B05 | バックアップの暗号化 | ○ (+0.5) | セクション2.8で「データベースバックアップの暗号化が未設計」と指摘し、AWS RDSの自動バックアップ暗号化（AES-256）を推奨 |
| 追加1 | 給与計算APIの再実行防止 | ○ (+0.5) | セクション2.4で給与計算APIの重複実行防止を指摘（正解キーにない有益な指摘） |
| 追加2 | SQLインジェクション対策の明示 | ○ (+0.5) | セクション2.6でSQLインジェクション対策の具体的方針が設計書に明示されていない点を指摘 |
| 追加3 | パスワードポリシーの強化 | × | セクション2.2のMFA提案内で「work factorを12に引き上げることを推奨したが」という記述があるが、これはセクション4.2の評価と矛盾。実際にはwork factor引き上げの明示的推奨はない |
| 追加4 | 従業員削除APIの論理削除 | ○ (+0.5) | セクション2.4の直前に記載なし（2.1〜2.8の番号体系から推測すると存在しない可能性）。実際のRun1結果を再確認すると、セクション2.4は給与計算APIの再実行防止のみ。論理削除の指摘は見当たらない。この項目は×と修正。 |

**ボーナス修正**: B01(+0.5) + B05(+0.5) + 追加1(+0.5) + 追加2(+0.5) = +2.0

### ペナルティ判定

Run1の全セクションを確認した結果、スコープ外の指摘や事実に反する指摘は見当たらない。

- セクション2.2（MFA）: セキュリティスコープ内
- セクション2.5（データベース接続文字列）: インフラ・依存関係のセキュリティに該当
- セクション3.1（Row-Level Security）: 認証・認可設計の確認事項として適切
- セクション3.2（S3バケット）: データ保護の確認事項として適切

**ペナルティ合計**: 0件 (0.0)

### Run1 総合スコア
```
検出スコア: 7.0
ボーナス: +2.0
ペナルティ: -0.0
総合スコア: 9.0
```

---

## Run2 詳細スコア

### 検出スコア内訳
- P01 (データ保護・重大): ○ 1.0
- P02 (インフラ・重大): ○ 1.0
- P03 (入力検証・重大): △ 0.5
- P04 (入力検証・中): ○ 1.0
- P05 (入力検証・中): ○ 1.0
- P06 (脅威モデリング・中): × 0.0
- P07 (データ保護・中): ○ 1.0
- P08 (脅威モデリング・中): ○ 1.0
- P09 (認証・認可・軽微): × 0.0
- P10 (認証・認可・軽微): ○ 1.0

**検出スコア合計**: 7.5/10.0

### ボーナス判定

| ID | 内容 | 判定 | 根拠 |
|----|------|------|------|
| B01 | 依存ライブラリの脆弱性スキャン頻度 | × | 言及なし（Run2では依存関係の脆弱性管理についての具体的改善提案が見当たらない） |
| B02 | bcrypt work factor | ○ (+0.5) | セクション2-2で「bcryptのwork factorを12に引き上げ（計算時間が約4倍になり、攻撃コストが増加）」と推奨 |
| B03 | S3オブジェクト暗号化 | × | セクション2-6でS3バケットのアクセス制御を提案しているが、バージョニングと署名付きURLの推奨のみで、SSE-S3/SSE-KMSには言及なし |
| B04 | テナントID検証漏れ | × | セクション2-4でRow-Level Securityの実装詳細を提案しているが、アプリケーション層での追加検証には言及なし |
| B05 | バックアップの暗号化 | × | バックアップについての言及なし |
| 追加1 | 従業員削除APIの論理削除 | ○ (+0.5) | セクション2-1で「DELETE /api/employees/{id}が物理削除の場合、給与記録・勤怠記録の外部キー制約違反や監査証跡の消失」を指摘し、deleted_at列による論理削除を推奨 |
| 追加2 | APIレスポンスでのユーザー列挙攻撃対策 | ○ (+0.5) | セクション2-3で「メールアドレスが存在しない」vs「パスワードが間違っている」のエラーメッセージを区別するとユーザー列挙攻撃が可能になると指摘し、同一メッセージ返却を推奨 |
| 追加3 | 給与計算バッチの監視とリトライ | ○ (+0.5) | セクション2-8でSpring Batchの失敗時リトライやアラート設定が設計されていない点を指摘 |
| 追加4 | データベース暗号化方式の選択 | ○ (+0.5) | セクション3-3でアプリケーション層暗号化 vs PostgreSQL TDE vs AWS RDS暗号化の選択肢とトレードオフを提示（確認事項として有益） |

**ボーナス合計**: B02(+0.5) + 追加1(+0.5) + 追加2(+0.5) + 追加3(+0.5) + 追加4(+0.5) = +2.5

### ペナルティ判定

Run2の全セクションを確認した結果、スコープ外の指摘や事実に反する指摘は見当たらない。

- セクション1-6（DoS対策）: 脅威モデリング（DoS）としてセキュリティスコープ内
- セクション1-7（SQLインジェクション）: 入力検証設計のスコープ内
- セクション2-8（給与計算バッチ）: 給与支払い遅延の罰則に言及しており、セキュリティ（コンプライアンス）の観点として適切

**ペナルティ合計**: 0件 (0.0)

### Run2 総合スコア
```
検出スコア: 7.5
ボーナス: +2.5
ペナルティ: -0.0
総合スコア: 10.0
```

---

## 統計サマリ

| 指標 | Run1 | Run2 |
|------|------|------|
| 検出スコア | 7.0 | 7.5 |
| ボーナス | +2.0 | +2.5 |
| ペナルティ | -0.0 | -0.0 |
| **総合スコア** | **9.0** | **10.0** |

**平均スコア (Mean)**: 9.5
**標準偏差 (SD)**: 0.5

---

## 安定性評価

| 標準偏差 | 判定 |
|----------|------|
| 0.5 | **高安定** |

SD ≤ 0.5 のため、結果が信頼できる。

---

## 未検出問題の分析

### 両方のRunで未検出
- **P06 (脅威モデリング・中)**: 監査ログの範囲不足（給与明細閲覧、従業員情報照会の監査ログ欠如）
  - Run1, Run2ともに監査ログの記録を良い点として評価しているが、照会操作のログ記録不足には気づいていない
  - 正解キーでは「機密情報の照会操作（給与明細閲覧、従業員情報照会）が監査ログに含まれていない」点を明示的に指摘することが求められる

- **P09 (認証・認可・軽微)**: データベースエラーメッセージの詳細出力
  - Run1, Run2ともにエラーハンドリングやSQLインジェクションに言及しているが、セクション6.2の「データベースエラーはスタックトレースを含めてログ出力」がクライアントレスポンスに含まれるリスクには触れていない
  - この問題は軽微なため、スコアへの影響は小さい

### Run1のみ未検出
- **P03 (入力検証・重大)**: CSRF保護の欠如
  - Run2ではセクション2-5でCSRFトークン実装を提案（△判定）
  - Run1では全くCSRFに言及なし

### Run2での改善
- P03の部分検出により検出スコアが+0.5
- B02（bcrypt work factor）のボーナス+0.5
- 追加の有益な指摘（ユーザー列挙攻撃、バッチ監視、暗号化方式選択）で+1.5

---

## 総評

**explicit-checks バリアント**は、平均スコア9.5、標準偏差0.5で**高安定**な結果を示した。

### 強み
1. **データ保護の重大問題を確実に検出**: マイナンバー・口座番号の平文保存（P01）、JWT署名鍵の平文保存（P02）、ログへの個人情報出力（P07）を両方のRunで○判定
2. **入力検証設計の主要問題をカバー**: API入力検証方針（P04）、勤怠打刻APIの冪等性（P05）を両方のRunで検出
3. **DoS対策の欠如を指摘**: レート制限（P08）を両方のRunで検出
4. **認証設計の問題を検出**: JWT有効期限（P10）を両方のRunで検出
5. **有益な追加指摘**: Run1で給与計算API再実行防止・SQLインジェクション対策明示化、Run2でユーザー列挙攻撃対策・バッチ監視など、正解キー外の価値ある指摘が多数

### 弱み
1. **監査ログの範囲分析が不足**: 両Runとも監査ログの記録を評価しているが、「照会操作のログ記録不足」という核心的な問題を見逃している（P06未検出）
2. **CSRF保護の検出が不安定**: Run1で完全未検出、Run2で部分検出（△）と、重大問題であるにも関わらず安定した検出ができていない
3. **エラーメッセージ露出リスクの見落とし**: 両RunともP09（データベースエラーのスタックトレース露出）を検出できていない

### 推奨事項
- 監査ログの記録範囲を評価する際、「何が記録されているか」だけでなく「何が記録されていないか（特に機密情報の照会操作）」を明示的にチェックするプロンプト改善が必要
- CSRF保護については、Spring Security使用時の標準的なチェック項目として明示することで検出率向上が期待できる
