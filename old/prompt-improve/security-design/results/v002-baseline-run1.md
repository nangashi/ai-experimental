# セキュリティ設計レビュー結果

**対象文書**: デジタルウォレット決済システム 設計書
**レビュー日時**: 2026-02-10
**レビュアー**: security-design-reviewer (v002-baseline)

---

## スコアサマリ

| 観点 | スコア (1-5) | 主な理由 |
|-----|-------------|---------|
| 脅威モデリング（STRIDE） | 2 | STRIDEの各脅威に対する体系的な対策が設計書に明示されていない |
| 認証・認可設計 | 1 | JWTのlocalStorage保存はXSS攻撃に脆弱であり、重大なセキュリティリスク |
| データ保護 | 2 | 機密データの暗号化方針、PII保護、データ削除ポリシーが未設計 |
| 入力検証設計 | 3 | 入力検証の具体的な実装方針が不明確で、インジェクション対策が不十分 |
| インフラ・依存関係 | 3 | シークレット管理とライブラリ脆弱性管理の方針が未定義 |
| **総合** | **2.2** | |

---

## 重大な問題（設計の修正が必須）

### 1. JWTトークンのlocalStorage保存によるXSSリスク

- **問題**: JWTトークン（Access Token、Refresh Token）をlocalStorageに保存する設計は、XSS攻撃に対して脆弱です
- **影響**: XSS脆弱性が1つでも存在すれば、攻撃者は悪意のあるJavaScriptでlocalStorageからトークンを窃取し、7日間有効なRefresh Tokenを使ってユーザーアカウントを完全に乗っ取ることが可能です。金融アプリケーションでは被害が甚大です
- **推奨対策**:
  - Access TokenはメモリのみでSessionStorage/localStorageに保存しない
  - Refresh TokenはHttpOnly + Secure + SameSite=Strict属性のCookieに保存
  - React Nativeアプリの場合は、セキュアストレージ（iOS Keychain、Android Keystore）を使用
  - CSRF対策としてSameSite属性に加えてカスタムヘッダー検証を実装
- **該当箇所**: セクション5「API設計」→「認証・認可方式」

### 2. 決済APIに対する認可制御の不足

- **問題**: 決済エンドポイント（`POST /api/v1/payments`、`POST /api/v1/payments/{id}/refund`）において、リクエスト元ユーザーがその決済を実行・操作する権限があるかの検証方針が設計書に記載されていません
- **影響**:
  - 他人のトランザクションIDを指定した返金リクエストを送信することで、不正な返金を実行できる可能性（IDOR脆弱性）
  - 加盟店側の決済受付において、別の加盟店のQRコードを不正に使用される可能性
- **推奨対策**:
  - 返金APIでは、リクエストユーザーがその決済の実行者（user_id）または加盟店オーナー（merchant.owner_user_id）であることを検証
  - 決済実行時にはQRコードに含まれるmerchant_idと実際の加盟店IDを照合
  - Spring Securityの`@PreAuthorize`アノテーションで権限チェックを実装
- **該当箇所**: セクション5「API設計」→「決済」「送金」

### 3. KYC書類の保存場所とアクセス制御が未定義

- **問題**: KYC（本人確認）書類の保存先、暗号化方針、アクセス制御が設計書に記載されていません。MongoDBに「KYC書類メタデータ」とありますが、実体ファイル（身分証明書画像など）の扱いが不明です
- **影響**: 個人情報保護法・GDPRに違反する可能性があり、情報漏洩時の法的リスクが高い。KYC書類には極めて機密性の高い個人情報（氏名、住所、顔写真、公的証明書番号）が含まれます
- **推奨対策**:
  - KYC書類はS3バケット（Private、バージョニング有効）に保存
  - S3オブジェクトは保存時にSSE-KMS（AWS KMS）で暗号化
  - アクセスポリシーでIAMロールを限定（管理者とKYC審査担当のみ）
  - 署名付きURLで一時的なアクセスを提供（有効期限5分）
  - MongoDBにはファイルパス・S3キーのみ保存（実体は保存しない）
- **該当箇所**: セクション2「技術スタック」→「データベース」、セクション4「データモデル」

### 4. P2P送金の不正防止対策が未設計

- **問題**: 個人間送金（P2P Transfer）において、マネーロンダリング対策、不正送金検出、送金限度額の設計が記載されていません
- **影響**:
  - 盗難アカウントによる大量送金でユーザー資産が流出
  - マネーロンダリングの温床となり、法的規制違反のリスク
  - 不正送金後の資金回収が困難
- **推奨対策**:
  - 送金限度額を設定（1回あたり10万円、1日あたり30万円、KYC未承認は1万円/日）
  - 高額送金（5万円以上）では追加認証（SMSワンタイムパスワード）を要求
  - FraudDetectionServiceで異常パターン検出（短時間の連続送金、初回送金先への高額送金など）
  - 疑わしい取引は自動凍結し、管理者承認フローを実装
- **該当箇所**: セクション1「主要機能」→「個人間送金」、セクション3「主要コンポーネント」→「TransferService」

### 5. パスワードリセットフローのセキュリティ設計が未記載

- **問題**: ユーザー登録・ログインAPIはあるが、パスワードリセット・変更フローのセキュリティ設計が記載されていません
- **影響**:
  - アカウント乗っ取りの入り口になる（例: メールアドレス列挙攻撃、リセットトークンの総当たり）
  - リセットメールの傍受でアカウント奪取が可能
- **推奨対策**:
  - リセットトークンは暗号学的に安全な乱数（256ビット）をハッシュ化してDB保存
  - トークン有効期限は1時間、使用後は即座に無効化
  - リセットリクエストのレート制限（同一メールアドレスに対して5回/時間）
  - メールアドレス列挙攻撃対策として、存在しないメールアドレスでも「送信しました」と表示
  - リセット完了時に登録メールアドレスへ通知を送信
- **該当箇所**: セクション5「API設計」→「認証」

### 6. 監査ログの改ざん防止策が未設計

- **問題**: MongoDBに監査ログを書き込む設計ですが、ログの改ざん防止・完全性検証の仕組みが記載されていません
- **影響**: 内部不正や侵害発生時に、攻撃者がログを改ざん・削除することで証跡が失われ、インシデント調査や法的対応が困難になります
- **推奨対策**:
  - 監査ログは追記専用（Append-Only）のコレクションに保存し、削除・更新を禁止
  - MongoDBのロール設計で監査ログコレクションへの書き込みは専用サービスアカウントのみ許可
  - 重要ログ（決済、送金、KYC承認）には署名（HMAC-SHA256）を付与して改ざん検出
  - AWS CloudWatch LogsやS3に二重化してバックアップ（クロスアカウント保存で権限分離）
- **該当箇所**: セクション3「アーキテクチャ設計」→「データフロー」、セクション2「データベース」

---

## 改善提案（設計の品質向上に有効）

### 7. レート制限の具体的な設計が不足

- **問題**: セクション7「非機能要件」に「APIには適切なレート制限を設定する」とありますが、具体的な設計が記載されていません
- **理由**: レート制限が不十分な場合、以下のリスクがあります
  - クレデンシャルスタッフィング攻撃やブルートフォース攻撃の成功率が上がる
  - DoS攻撃でサービスが停止する
  - 自動化ツールによる大量のアカウント作成・不正決済が実行される
- **推奨対策**:
  - Redis（既存スタック）でレート制限を実装
  - エンドポイント別の制限設計:
    - `/api/v1/auth/login`: 5回/15分（IPベース）+ 10回/時間（ユーザーベース）
    - `/api/v1/auth/register`: 3回/時間（IPベース）
    - `/api/v1/payments`: 10回/分（ユーザーベース）
    - `/api/v1/transfers`: 5回/分（ユーザーベース）
  - Spring Cloud Gateway（またはAPI Gateway側）でグローバル制限（1000リクエスト/分/IP）
  - レート制限超過時は`429 Too Many Requests`を返し、Retry-Afterヘッダーで待機時間を通知
- **該当箇所**: セクション7「非機能要件」→「セキュリティ要件」

### 8. トランザクションテーブルへのインデックス設計とアクセス制御

- **問題**: transactionsテーブルに対するクエリパターンとインデックス設計が記載されていません。また、全トランザクションへのアクセス制御が不明です
- **理由**:
  - インデックスがないとユーザーの取引履歴照会が遅延し、UXが低下
  - 他のユーザーのトランザクションを照会できる可能性（IDOR脆弱性）
- **推奨対策**:
  - インデックス設計:
    - `user_id, created_at DESC`（ユーザー別取引履歴照会）
    - `merchant_id, created_at DESC`（加盟店別売上照会）
    - `status, created_at`（未完了取引の監視クエリ）
  - アクセス制御:
    - `GET /api/v1/transactions` エンドポイントでは認証ユーザーのuser_idでフィルタリング
    - 管理者以外は他ユーザーのトランザクションを取得不可
    - Spring Data JPAのカスタムクエリで`WHERE user_id = :currentUserId`を強制
- **該当箇所**: セクション4「データモデル」→「transactions」

### 9. 依存ライブラリの脆弱性管理プロセス

- **問題**: 主要ライブラリ（Spring Security、Stripe SDK、Plaid SDKなど）の脆弱性管理とアップデート方針が記載されていません
- **理由**: 既知の脆弱性を放置すると、公開されたExploitコードで容易に攻撃されます。特に金融アプリは標的になりやすいです
- **推奨対策**:
  - GitHub Dependabot（またはRenovate）を有効化し、自動PRを週次で生成
  - CI/CDパイプラインにOWASP Dependency-Check（Gradle/Mavenプラグイン）を組み込み、CVSS 7.0以上の脆弱性検出時はビルド失敗
  - 重要度が高い脆弱性（CVSS 9.0以上）は24時間以内にホットフィックス適用
  - セキュリティアドバイザリの購読（Spring Security公式、Stripe/Plaidのセキュリティブログ）
- **該当箇所**: セクション2「技術スタック」→「主要ライブラリ」、セクション6「実装方針」

### 10. データベース暗号化（Encryption at Rest）の設計

- **問題**: RDS PostgreSQLとElastiCache Redisの保存時暗号化（Encryption at Rest）の設定が記載されていません
- **理由**: ストレージレベルでのデータ漏洩リスク（ディスク廃棄時、スナップショット流出時）を低減できます。PCI DSSやGDPRでも推奨されています
- **推奨対策**:
  - RDS PostgreSQL: 作成時にEncryption at Restを有効化（AWS KMS）
  - ElastiCache Redis: At-Rest EncryptionとIn-Transit Encryption（TLS）を両方有効化
  - MongoDBもEncryption at Restを有効化（MongoDB Atlas使用の場合はデフォルトで有効）
  - KMSキーのローテーションを年1回実施
- **該当箇所**: セクション2「技術スタック」→「データベース」、セクション7「非機能要件」→「セキュリティ要件」

### 11. 決済処理の冪等性保証

- **問題**: 決済API（`POST /api/v1/payments`）の冪等性設計が記載されていません
- **理由**: ネットワークタイムアウト時にクライアントがリトライすると、二重決済が発生する可能性があります
- **推奨対策**:
  - クライアントがリクエストに`Idempotency-Key`ヘッダー（UUID）を付与
  - サーバー側でRedisにキーと処理結果を保存（TTL 24時間）
  - 同一キーでの再リクエストには前回の結果をそのまま返却
  - Stripe APIも冪等性キーをサポートしているため、そのまま転送
- **該当箇所**: セクション5「API設計」→「決済」

### 12. QRコード生成時の署名検証

- **問題**: 加盟店QRコードの生成・検証ロジックが記載されていません。QRコードデータが単なる文字列の場合、偽造される可能性があります
- **理由**: 攻撃者が偽のQRコードを生成し、正規加盟店のIDを装って決済を横取りできます
- **推奨対策**:
  - QRコードに含めるデータ形式: `{merchant_id}:{timestamp}:{signature}`
  - signatureはHMAC-SHA256（秘密鍵はAWS Secrets Managerで管理）
  - 決済時にQRコードの署名を検証し、タイムスタンプが5分以内であることを確認
  - 署名が無効な場合は決済を拒否
- **該当箇所**: セクション3「主要コンポーネント」→「MerchantService」

### 13. エラーメッセージの情報漏洩対策

- **問題**: エラーレスポンスのサンプルに`"message": "Insufficient funds"`とありますが、詳細なエラー情報の露出範囲が設計されていません
- **理由**: スタックトレース、内部エラーコード、SQLクエリなどがエラーレスポンスに含まれると、攻撃者にシステム構造を推測されます
- **推奨対策**:
  - 本番環境ではスタックトレースを返さない（ログのみに記録）
  - エラーコードは汎用的なもの（`PAYMENT_FAILED`、`INVALID_REQUEST`）とし、詳細は内部ログで管理
  - バリデーションエラーは具体的に返す（例: `"field": "email", "message": "Invalid format"`）が、存在チェック（ユーザー名の有無など）は曖昧にする
  - 開発環境とステージング環境では詳細エラーを返す設定も可
- **該当箇所**: セクション5「API設計」→「リクエスト/レスポンス形式」、セクション6「実装方針」→「エラーハンドリング」

### 14. セッション管理とログアウト実装

- **問題**: ログアウトAPIの設計が記載されていません。JWTはステートレスなため、トークン無効化の仕組みが必要です
- **理由**: トークンが漏洩した場合、ログアウトしてもトークンの有効期限まで悪用される可能性があります
- **推奨対策**:
  - Redisにログアウト済みトークンのブラックリストを保存（キー: jti、TTL: トークン有効期限）
  - 認証フィルターでブラックリストをチェック
  - `POST /api/v1/auth/logout` エンドポイントを実装し、Refresh Tokenも無効化
  - 「全デバイスからログアウト」機能として、user_idベースのトークン無効化も検討
- **該当箇所**: セクション5「API設計」→「認証」

### 15. CORS設定の明確化

- **問題**: API GatewayとSpring BootでのCORS設定方針が記載されていません
- **理由**: 不適切なCORS設定（`Access-Control-Allow-Origin: *`）はCSRF攻撃や意図しないAPIアクセスを招きます
- **推奨対策**:
  - 許可するOriginを明示的にホワイトリスト化（本番: `https://app.example.com`、開発: `http://localhost:3000`）
  - `Access-Control-Allow-Credentials: true` と組み合わせて`*`を使用しない
  - Spring SecurityのCORS設定と統合
  - Preflightリクエストのキャッシュでパフォーマンス改善（`Access-Control-Max-Age: 3600`）
- **該当箇所**: セクション2「技術スタック」→「インフラ・デプロイ環境」

---

## 確認事項（ユーザーへの確認が必要）

### 16. 多要素認証（MFA）の導入要否

- **確認理由**: 金融アプリケーションではMFAの導入が推奨されますが、UX負荷とセキュリティレベルのトレードオフがあります
- **選択肢とトレードオフ**:
  - **オプションA: 全ユーザーにMFA必須**
    - メリット: セキュリティレベルが最高。アカウント乗っ取りリスクが大幅に低減
    - デメリット: ユーザー登録時の離脱率上昇、UX複雑化
  - **オプションB: 高額取引時のみMFA**
    - メリット: 通常利用の利便性を維持しつつ、重要操作のみ保護
    - デメリット: アカウント乗っ取り自体は防げない
  - **オプションC: オプトイン（ユーザー選択制）**
    - メリット: ユーザーの自由度が高い
    - デメリット: セキュリティ意識の低いユーザーが保護されない
- **推奨**: オプションBを初期実装し、将来的にオプションAに移行（段階的なMFA普及）

### 17. 不正検出サービスの内製 vs 外部SaaS

- **確認理由**: FraudDetectionServiceを内製するか、外部サービス（Sift、Stripe Radar、AWS Fraud Detectorなど）を利用するかの方針が不明です
- **選択肢とトレードオフ**:
  - **オプションA: 内製（ルールベース）**
    - メリット: 初期コスト低、カスタマイズ容易
    - デメリット: 機械学習モデルがなく、高度な不正には対応困難。メンテナンスコストが継続発生
  - **オプションB: 外部SaaS（Stripe Radar等）**
    - メリット: 高精度な機械学習モデル、グローバルな不正パターン共有、運用コスト削減
    - デメリット: 月額コストが高い（取引数に応じて変動）、カスタマイズ制約
  - **オプションC: AWS Fraud Detector（マネージドML）**
    - メリット: AWSエコシステム統合、カスタムモデル学習可能
    - デメリット: 初期セットアップが複雑、学習データが必要
- **推奨**: 初期はオプションA（シンプルなルールベース）で開始し、取引データが蓄積されたらオプションBに移行

### 18. データ保持期間とGDPR対応

- **確認理由**: EUユーザーが対象の場合、GDPR準拠が必要です。データ保持期間と削除ポリシーの設計が必要か確認してください
- **選択肢とトレードオフ**:
  - **オプションA: GDPR完全対応**
    - メリット: EU市場進出可能、ユーザープライバシー保護
    - デメリット: 実装コスト高（データポータビリティ、削除権、同意管理など）
  - **オプションB: 日本国内のみ（個人情報保護法準拠）**
    - メリット: 実装負荷が低い
    - デメリット: 将来の海外展開時に大幅な改修が必要
- **推奨**: サービスの対象地域を確認し、GDPR対応の要否を判断してください。対応する場合は以下を実装:
  - ユーザーデータのエクスポートAPI（`GET /api/v1/users/me/data-export`）
  - アカウント削除API（`DELETE /api/v1/users/me`）と関連データのカスケード削除
  - 取引データは会計法により7年保持が必要なため、匿名化（PII削除）で対応

---

## 評価（良い点）

### 19. PCI DSS準拠を意識したトークン化設計

- クレジットカード情報を自システムで保存せず、Stripeのトークン化を使用する設計は適切です。PCI DSS準拠の負荷を大幅に軽減し、カード情報漏洩リスクを回避できます

### 20. パスワードハッシュ化にbcryptを採用

- bcryptのストレッチング係数12は2026年時点でも適切です（OWASP推奨）。SHA-1やMD5ではなく、ソルト付きハッシュ関数を選択している点は評価できます

### 21. HTTPS通信とTLS 1.3の採用

- すべての通信をHTTPSで行い、TLS 1.3を採用する方針は最新のセキュリティ標準に準拠しています。中間者攻撃や盗聴のリスクを低減できます

### 22. Multi-AZ構成による可用性確保

- データベースのMulti-AZ構成とAuto Scalingにより、DoS攻撃や障害時の耐性が向上しています。セキュリティインシデント時のサービス継続性にも寄与します

### 23. JWT有効期限の適切な設定

- Access Tokenの有効期限を15分に設定している点は、トークン漏洩時の被害を限定できるため適切です（ただし、localStorage保存の問題は解消する必要があります）

---

## 総評

本設計書は、金融系アプリケーションとしての基本的なセキュリティ要件（HTTPS、パスワードハッシュ化、PCI DSS準拠）を押さえている点は評価できます。一方で、以下の重大なリスクが存在します:

1. **認証トークンの保存方式**: localStorageへのJWT保存はXSS攻撃に対して無防備であり、最優先で修正が必要です
2. **認可制御の不足**: 決済・返金APIでの権限チェック設計が不明確で、IDOR脆弱性のリスクがあります
3. **KYC書類の保護**: 個人情報保護の観点から、保存・暗号化・アクセス制御の設計が急務です
4. **P2P送金の不正防止**: マネーロンダリング対策と送金限度額の設計が欠如しています

これらの問題を解決しない場合、本番環境でのセキュリティインシデント（情報漏洩、不正送金、アカウント乗っ取り）が発生する可能性が高く、サービスの信頼性とビジネス継続性に深刻な影響を与えます。

**推奨アクション**:
1. 重大な問題（1〜6）を最優先で設計に反映してください
2. 改善提案（7〜15）のうち、レート制限、冪等性保証、監査ログ保護は早期実装を推奨します
3. 確認事項（16〜18）について、ビジネス要件と照らし合わせて方針を決定してください
