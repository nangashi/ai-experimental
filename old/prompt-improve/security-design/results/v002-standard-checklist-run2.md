# セキュリティ設計レビュー結果

**レビュー対象**: デジタルウォレット決済システム 設計書
**レビュー日時**: 2026-02-10
**バリアント**: v002-variant-standard-checklist (Run 2)

---

## スコアサマリ

| 観点 | スコア (1-5) | 主な理由 |
|-----|-------------|---------|
| 脅威モデリング（STRIDE） | 2 | STRIDE各脅威への対策が設計に明示されておらず、セッション固定化・リプレイ攻撃等の対策が不足 |
| 認証・認可設計 | 2 | JWTのlocalStorage保存は重大なXSSリスク、セッションタイムアウト・MFA・CSRF対策が未設計 |
| データ保護 | 3 | 暗号化方針が部分的（TLS, bcrypt）だが、保存時暗号化・鍵管理・データマスキングが不明 |
| 入力検証設計 | 3 | SQLインジェクション対策（JPA）は推測できるが、XSS・ファイルアップロード・ホワイトリスト検証の設計が欠落 |
| インフラ・依存関係 | 3 | レート制限言及はあるが実装詳細不明、セキュリティヘッダー・シークレット管理・依存関係脆弱性管理が未設計 |
| **総合** | **2.6** | |

---

## 1. 重大な問題（設計の修正が必須）

### 1.1 JWTトークンのlocalStorage保存によるXSSリスク

**問題の説明**:
設計書に「トークンはlocalStorageに保存（フロントエンド）」と明記されているが、localStorageはJavaScriptから直接アクセス可能であり、XSS攻撃でトークンが窃取される。Access Token（15分）とRefresh Token（7日）の両方が盗まれた場合、攻撃者は最大7日間ユーザーアカウントを乗っ取ることができる。

**影響**:
- React Nativeアプリ内でXSS脆弱性（サードパーティライブラリやWebView経由）が1つでも存在すれば、攻撃者は全ユーザーの認証情報を窃取可能
- 決済システムという性質上、不正送金・個人情報漏洩・金銭被害に直結

**推奨対策**:
- **モバイルアプリ**: React Nativeの場合、`react-native-keychain`（iOS Keychain/Android Keystore連携）などのセキュアストレージにトークンを保存
- **Webブラウザ（管理画面）**: HttpOnly, Secure, SameSite=Strict属性付きCookieに変更
- Refresh Tokenのローテーション機構（使用後に新しいRefresh Tokenを発行し、旧トークンを無効化）を追加

**該当箇所**: セクション5「API設計」→「認証・認可方式」

---

### 1.2 CSRF対策の欠落

**問題の説明**:
state-changingなAPI（決済実行、送金、決済手段削除等）に対するCSRF対策が設計に含まれていない。JWTをローカルストレージに保存し、Authorization HeaderでAPI呼び出しを行う設計では、悪意のあるサイトがユーザーのブラウザからAPIリクエストを発行できる可能性がある（特に管理画面がWebベースの場合）。

**影響**:
- 攻撃者が用意した悪意のあるページをユーザーが訪問した際、ユーザーの認証情報を使って不正な送金・決済を実行される可能性
- 決済システムでは金銭的損失が直接発生

**推奨対策**:
- SameSite Cookie属性（SameSite=Lax or Strict）を設定することで、クロスサイトからのCookie送信を制限
- CORSポリシーを厳格に設定（許可するOriginを明示的にホワイトリスト化）
- 重要な操作（送金、決済手段削除等）には追加の確認（PIN再入力、SMS OTP等）を要求

**該当箇所**: セクション5「API設計」全般（決済、送金、決済手段管理エンドポイント）

---

### 1.3 セッション管理の脆弱性（セッション固定化攻撃への未対策）

**問題の説明**:
JWT発行時のセッション固定化攻撃対策が設計に含まれていない。ログイン成功後に新しいセッションIDを発行する設計が明示されていないため、攻撃者が予めセッションIDを被害者に渡し、ログイン後にそのセッションを乗っ取ることが可能。

**影響**:
- 攻撃者が被害者のアカウントに不正アクセスし、決済・送金を実行可能

**推奨対策**:
- ログイン成功時に新しいJWTを発行（JTI claimにランダムなセッションIDを含める）
- ログアウト時にRefresh Tokenを無効化するブラックリスト機構（RedisでTTL付きで管理）を実装
- JWTにデバイス指紋（User-Agent, IPアドレス等のハッシュ）を埋め込み、検証時にチェック

**該当箇所**: セクション5「API設計」→「認証」エンドポイント

---

### 1.4 パスワードリセットフローのセキュリティ設計が欠落

**問題の説明**:
パスワードリセット機能の設計が文書に含まれていない。決済システムではアカウント乗っ取りのリスクが高いため、安全なパスワードリセットフローの設計は必須。

**影響**:
- 不適切なパスワードリセット実装（予測可能なトークン、トークンの有効期限なし等）は、アカウント乗っ取りの主要な攻撃経路となる

**推奨対策**:
- パスワードリセットトークンは暗号学的に安全な乱数（256bit以上）で生成
- トークンの有効期限を15分に設定
- トークンをハッシュ化してDBに保存（生トークンは保存しない）
- リセット完了後はトークンを即座に無効化
- リセット成功時に登録メールアドレスに通知メールを送信
- 連続したパスワードリセット試行を制限（レート制限: 同一メールアドレスに対し5回/時間）

**該当箇所**: 全体（設計書に記載なし）

---

### 1.5 横方向アクセス制御の未設計

**問題の説明**:
ユーザーが他ユーザーの決済履歴・決済手段・送金情報にアクセスできないことを保証する設計が明示されていない。例えば`GET /api/v1/payments/{id}`エンドポイントで、他ユーザーのpayment IDを指定した場合の挙動が不明。

**影響**:
- 攻撃者が他ユーザーの決済IDを推測（UUID列挙攻撃等）して、他人の取引情報・決済手段を閲覧・操作できる可能性

**推奨対策**:
- 全てのリソースアクセスAPIで、リクエストユーザー（JWT内のuser_id）とリソース所有者が一致することをService層で検証
- Spring Securityの`@PreAuthorize`アノテーションを使用し、認可ロジックを宣言的に実装（例: `@PreAuthorize("@paymentService.isOwner(#id, authentication.principal.id)")`）
- エラーレスポンスは403 Forbiddenではなく404 Not Foundを返す（リソース存在の情報漏洩防止）

**該当箇所**: セクション5「API設計」全般（決済、送金、決済手段管理エンドポイント）

---

### 1.6 監査ログの改ざん防止策が不明

**問題の説明**:
MongoDBに監査ログを保存する設計だが、ログの改ざん防止策が明示されていない。決済システムでは、不正取引の証跡として監査ログが法的要件を満たす必要があるが、攻撃者（または内部犯行）がログを改ざん・削除できる場合、証跡として無効。

**影響**:
- 不正取引の証拠隠滅が可能
- 規制当局への監査対応時に信頼性を証明できない

**推奨対策**:
- 監査ログはAppend-onlyに設計（削除・更新を許可しない）
- MongoDBのロール設定で、アプリケーションユーザーにはInsert権限のみ付与（Delete/Update権限を剥奪）
- ログエントリにHMAC署名を付与し、改ざん検知を可能にする（HMACキーはAWS Secrets Managerで管理）
- 長期保存が必要な場合、定期的にS3 Glacier（WORM: Write Once Read Many設定）にアーカイブ

**該当箇所**: セクション3「アーキテクチャ設計」→「データフロー」、セクション6「実装方針」→「ロギング」

---

## 2. 改善提案（設計の品質向上に有効）

### 2.1 多要素認証（MFA）の導入

**提案の説明**:
決済システムでは高額送金・決済手段変更時にMFA（SMS OTP, TOTP等）を要求することで、アカウント乗っ取り被害を大幅に削減できる。現在の設計にはMFAの言及がない。

**理由**:
- パスワード漏洩・フィッシング攻撃が成功した場合でも、MFAが攻撃を阻止
- 規制当局（PSD2等）が決済サービスに強力な顧客認証（SCA）を義務付けている地域も存在

**推奨対策**:
- ログイン時にMFAをオプションで有効化可能にする（初期はオプション、将来的に必須化）
- 高リスク操作（1万円以上の送金、決済手段削除、パスワード変更）時にステップアップ認証（SMS OTP, TOTP）を要求
- TOTP実装にはGoogle Authenticator互換のライブラリ（例: `java-totp`）を使用

**該当箇所**: セクション5「API設計」→「認証」

---

### 2.2 レート制限の詳細設計が不足

**提案の説明**:
セキュリティ要件に「APIには適切なレート制限を設定する」と記載されているが、具体的な制限値・対象エンドポイント・実装方法が不明。特にログインエンドポイント・P2P送金エンドポイントはブルートフォース・乱用のリスクが高い。

**理由**:
- ログインエンドポイントはクレデンシャルスタッフィング攻撃の標的になりやすい
- P2P送金エンドポイントは不正利用（マネーロンダリング等）のリスクがある

**推奨対策**:
- **ログイン**: 5回/15分/IPアドレス、3回連続失敗で5分間のアカウントロック
- **P2P送金**: 10回/時間/ユーザー、1日あたりの送金額上限（例: 10万円）
- **決済実行**: 20回/時間/ユーザー
- **加盟店API**: 100回/時間/加盟店オーナー
- 実装: Redisで`INCR`コマンド + `EXPIRE`を使用したスライディングウィンドウ方式、または`Bucket4j`ライブラリを使用

**該当箇所**: セクション7「非機能要件」→「セキュリティ要件」

---

### 2.3 APIレスポンスのタイミング攻撃対策

**提案の説明**:
ログイン失敗時のレスポンス時間が「ユーザーが存在しない場合」と「パスワードが間違っている場合」で異なると、攻撃者がユーザーの存在を列挙できる（タイミング攻撃）。現在の設計にこの対策が含まれていない。

**理由**:
- 攻撃者が登録済みのメールアドレスを特定できれば、標的型攻撃（フィッシング等）の成功率が上がる

**推奨対策**:
- ユーザー存在チェックとパスワード検証を常に両方実行し、レスポンス時間を一定にする
- 失敗時のエラーメッセージは「メールアドレスまたはパスワードが正しくありません」と統一（どちらが間違っているかを特定させない）
- bcrypt検証は固定時間アルゴリズムだが、ユーザー不在時もダミーハッシュと比較して時間を揃える

**該当箇所**: セクション3「アーキテクチャ設計」→「AuthService」

---

### 2.4 PIIの特定と保護方針が不明

**提案の説明**:
設計書にはメールアドレス・電話番号・KYC書類などの個人識別情報（PII）が含まれるが、これらのデータに対する保護方針（保存時暗号化、アクセス制御、データマスキング、保持期間）が明示されていない。

**理由**:
- GDPR、個人情報保護法等の規制対応が必要
- データ漏洩時の被害範囲を最小化するため、PIIは最小限のアクセス権限のみに制限すべき

**推奨対策**:
- **保存時暗号化**: PostgreSQLの透過的データ暗号化（TDE）またはカラムレベル暗号化（AES-256）を適用
- **アクセス制御**: 管理者でもPIIにアクセスできるロールを制限（監査ログに記録）
- **データマスキング**: 取引履歴画面では電話番号を`***-****-1234`形式で表示
- **保持期間**: KYC書類は本人確認完了後5年間保持、退会ユーザーのデータは90日後に匿名化
- **鍵管理**: 暗号化キーはAWS KMS（Key Management Service）で管理し、定期的にローテーション

**該当箇所**: セクション4「データモデル」、セクション7「非機能要件」→「セキュリティ要件」

---

### 2.5 QRコード生成時の署名検証が不足

**提案の説明**:
加盟店のQRコード（`merchants.qr_code_data`）が改ざんされた場合、攻撃者が偽のQRコードを生成し、ユーザーの決済を攻撃者の口座に振り向けることができる可能性がある。現在の設計にQRコードの署名検証が含まれていない。

**理由**:
- QRコードは物理的に印刷されて店舗に掲示されるため、攻撃者が偽のQRコードシールを上から貼り付ける物理的攻撃が可能

**推奨対策**:
- QRコード文字列に加盟店ID・タイムスタンプ・HMAC署名を含める（例: `merchantId|timestamp|HMAC(merchantId|timestamp, secret)`）
- 決済実行時にHMAC署名を検証し、改ざんされたQRコードを拒否
- QRコードの有効期限を設定（例: 発行から1年）し、定期的に再発行を促す

**該当箇所**: セクション3「アーキテクチャ設計」→「MerchantService」、セクション5「API設計」→「加盟店管理」

---

### 2.6 不正検出サービス（FraudDetectionService）の具体的設計が不明

**提案の説明**:
設計書に`FraudDetectionService`の言及はあるが、具体的な検出ルール・実装方法・外部サービス連携の詳細が不明。決済システムでは不正検出が重要な防御層となる。

**理由**:
- 高額取引・短時間の連続送金・異常な地理的移動などの異常パターンをリアルタイムで検出し、不正取引を未然に防ぐ必要がある

**推奨対策**:
- **ルールベース検出**:
  - 1時間に3回以上の異なる送金先への送金 → 要確認フラグ
  - 通常の10倍以上の金額 → 要確認フラグ
  - 登録直後（24時間以内）の高額送金 → 要確認フラグ
- **機械学習ベース検出**: AWS Fraud DetectorまたはStripe Radarを統合
- **リアルタイムスコアリング**: 各取引に不正スコア（0-100）を付与し、閾値以上は自動ブロックまたは管理者レビューキューに追加
- **ユーザー通知**: 不正の疑いがある取引を検出した場合、SMSまたはプッシュ通知でユーザーに確認

**該当箇所**: セクション3「アーキテクチャ設計」→「FraudDetectionService」

---

### 2.7 依存ライブラリの脆弱性管理プロセスが不明

**提案の説明**:
主要ライブラリ（Spring Security, Stripe API等）は記載されているが、依存関係の脆弱性スキャン・更新プロセスが設計に含まれていない。

**理由**:
- 既知の脆弱性を持つライブラリ（例: Log4Shell）は攻撃者に容易に悪用される
- 決済システムは攻撃対象として高価値であり、脆弱性の迅速なパッチ適用が必須

**推奨対策**:
- **CI/CDパイプラインに脆弱性スキャンを統合**:
  - Maven/Gradleの場合、OWASP Dependency-Check PluginまたはSnykを使用
  - GitHub Dependabotを有効化し、脆弱性が検出された場合は自動でPR作成
- **スキャン頻度**: 毎ビルド時 + 週1回の定期スキャン
- **Critical/High脆弱性の対応SLA**: 検出から72時間以内にパッチ適用またはリスク受容判断

**該当箇所**: セクション2「技術スタック」→「主要ライブラリ」、セクション6「実装方針」→「デプロイメント方針」

---

### 2.8 セキュリティヘッダーの設定が不明

**提案の説明**:
HTTPセキュリティヘッダー（HSTS, CSP, X-Frame-Options等）の設定が設計書に含まれていない。これらはクライアントサイド攻撃（XSS, Clickjacking等）の防御層として重要。

**理由**:
- セキュリティヘッダーは実装コストが低く、高い防御効果を得られる

**推奨対策**:
- **HSTS**: `Strict-Transport-Security: max-age=31536000; includeSubDomains; preload`
- **CSP**: `Content-Security-Policy: default-src 'self'; script-src 'self'; object-src 'none';`
- **X-Frame-Options**: `X-Frame-Options: DENY`（Clickjacking防止）
- **X-Content-Type-Options**: `X-Content-Type-Options: nosniff`
- **Referrer-Policy**: `Referrer-Policy: strict-origin-when-cross-origin`
- Spring Securityの`HttpSecurity`設定で宣言的に追加可能

**該当箇所**: セクション7「非機能要件」→「セキュリティ要件」

---

### 2.9 KYC書類のアップロード検証が不足

**提案の説明**:
KYC（本人確認）プロセスで書類をアップロードする機能があると推測されるが、ファイルアップロードの検証方針（ファイルタイプ、サイズ、マルウェアスキャン）が設計に含まれていない。

**理由**:
- 悪意のあるファイル（実行可能ファイル、スクリプト等）がアップロードされ、サーバーまたは管理者端末で実行されるリスク
- 大容量ファイルによるDoS攻撃のリスク

**推奨対策**:
- **ファイルタイプ検証**: MIMEタイプではなくファイルマジックバイト（先頭バイト列）で検証。許可形式: PDF, JPEG, PNG のみ
- **ファイルサイズ制限**: 5MB以下
- **ファイル名サニタイゼーション**: パストラバーサル攻撃防止のため、ファイル名から`../`等を除去
- **マルウェアスキャン**: ClamAV または AWS S3のマルウェアスキャンサービスを統合
- **保存先**: S3バケット（パブリックアクセス無効、署名付きURL経由でのみアクセス可能）

**該当箇所**: セクション1「概要」→「主要機能」（KYC）

---

### 2.10 IP制限・Geo-blocking の検討

**提案の説明**:
管理者APIエンドポイントやKYC承認機能など、特定の場所からのみアクセスすべき機能に対して、IP制限やGeo-blockingの検討が設計に含まれていない。

**理由**:
- 管理者機能は攻撃対象として高価値であり、許可されたIPアドレス範囲からのみアクセス可能にすることでリスクを低減

**推奨対策**:
- **管理者API**: AWS Security GroupまたはWAFで許可IPアドレス範囲（オフィスVPN等）を制限
- **Geo-blocking**: サービス提供地域外（例: 日本国外）からのアクセスをブロック（AWS CloudFront Geo Restriction）
- ただし、正当な海外出張時のアクセスも考慮し、VPN経由のアクセスを許可する設計にする

**該当箇所**: セクション2「技術スタック」→「インフラ・デプロイ環境」

---

## 3. 確認事項（ユーザーへの確認が必要）

### 3.1 Refresh Tokenの保存場所とローテーション方針

**確認理由**:
Access Token（15分）とRefresh Token（7日）の有効期限は適切だが、Refresh Tokenの保存場所（localStorage or セキュアストレージ）とローテーション機構の実装有無が不明。

**選択肢とトレードオフ**:
1. **Refresh TokenもlocalStorageに保存（現状の推測）**:
   - × XSS攻撃で7日間有効なトークンが窃取される
2. **Refresh TokenをHttpOnly Cookieに保存**:
   - ○ XSS攻撃から保護
   - △ CSRF対策が必要
3. **Refresh Tokenローテーション**:
   - ○ 窃取されたトークンの悪用期間を最小化
   - △ 実装複雑度が上がる

**推奨**: HttpOnly Cookie + ローテーション + リフレッシュ時に旧トークンを即座に無効化

---

### 3.2 KYC承認プロセスのアクセス制御

**確認理由**:
KYC承認は管理者のみが実行すべき操作だが、管理者の権限モデル（ロールベースアクセス制御）が設計に含まれていない。

**選択肢とトレードオフ**:
1. **全管理者が全機能にアクセス可能**:
   - × 内部犯行リスクが高い
2. **ロールベースアクセス制御（RBAC）**:
   - ○ 最小権限の原則に準拠
   - △ ロール設計・管理の複雑度が上がる
3. **属性ベースアクセス制御（ABAC）**:
   - ○ 細粒度の制御が可能
   - × 実装・運用コストが高い

**推奨**: RBAC（例: ADMIN_KYC_APPROVER, ADMIN_FRAUD_REVIEWER, ADMIN_SYSTEM_MONITOR）を導入し、各ロールに必要最小限の権限を付与

---

### 3.3 P2P送金の取引限度額と本人確認レベルの対応

**確認理由**:
P2P送金の1回あたりの限度額・1日あたりの限度額が設計に含まれていない。マネーロンダリング防止の観点から、取引額に応じた本人確認レベルの設定が必要。

**選択肢とトレードオフ**:
1. **一律で高額送金可能**:
   - × マネーロンダリングリスクが高い
2. **KYCレベルに応じた段階的制限**:
   - ○ 規制対応とユーザー利便性のバランス
   - 例:
     - KYC未完了: 送金不可
     - 基本KYC完了: 1万円/回、3万円/日
     - 拡張KYC完了: 10万円/回、30万円/日

**推奨**: KYCレベルに応じた段階的制限 + 高額送金時のステップアップ認証（MFA）

---

### 3.4 データ保持期間と削除ポリシー

**確認理由**:
GDPRや個人情報保護法では、利用目的を達成した個人データの削除が義務付けられている。退会ユーザーのデータ保持期間・削除方針が設計に含まれていない。

**選択肢とトレードオフ**:
1. **退会後即座に削除**:
   - ○ プライバシー保護に最適
   - × 監査・紛争対応時に証跡が残らない
2. **退会後N年間保持後に削除**:
   - ○ 監査対応可能
   - △ 保持期間の根拠が必要
3. **匿名化処理**:
   - ○ 統計分析に利用可能
   - △ 完全な匿名化は技術的に困難

**推奨**: 退会後90日間は完全保持（紛争対応期間）→ 個人識別情報を削除し取引データは5年間保持（金融規制対応）

---

## 4. 評価（良い点）

### 4.1 外部サービスへのトークン化によるPCI DSS準拠

クレジットカード情報を自システムに保存せず、Stripeのトークン化機構を使用する設計は優れている。これによりPCI DSSスコープを大幅に削減でき、カード情報漏洩リスクを外部に委譲できる。

---

### 4.2 パスワードハッシュ化にbcrypt（係数12）を採用

bcryptのストレッチング係数12は、現在の計算能力に対して適切な強度を持つ。ブルートフォース攻撃に対する防御として評価できる。ただし、将来的にArgon2への移行を検討することも推奨される。

---

### 4.3 通信の完全HTTPS化（TLS 1.3）

全ての通信をHTTPS（TLS 1.3）で暗号化する方針は適切。TLS 1.3は旧バージョンの脆弱性（POODLE, BEAST等）を解消し、高速な接続確立を実現する。

---

### 4.4 Multi-AZ構成による可用性確保

データベースのMulti-AZ構成により、単一AZの障害時でも自動フェイルオーバーで可用性を維持できる設計は評価できる。決済システムでは高可用性が重要であり、適切な設計。

---

### 4.5 トランザクション記録とログの分離

決済処理を専用ログファイルに分離し、監査ログをMongoDBに保存する設計は、セキュリティインシデント調査・監査対応の観点から優れている。ただし、ログの改ざん防止策（セクション1.6参照）の追加が必要。

---

## 総評

本設計書は基本的なセキュリティ対策（HTTPS, bcrypt, PCI DSS準拠）を含んでいるが、**認証・認可設計に複数の重大な脆弱性**（JWTのlocalStorage保存、CSRF対策欠落、セッション固定化対策欠落、横方向アクセス制御の未設計）が存在する。これらは決済システムとしてのリスクが極めて高く、**本番リリース前に必ず修正が必要**。

また、業界標準のセキュリティ要件（MFA、パスワードリセットフロー、監査ログの改ざん防止、PIIの保護方針、レート制限詳細、セキュリティヘッダー等）が設計に含まれておらず、これらの追加設計が強く推奨される。

**優先対応項目**（重大度順）:
1. JWTのセキュアストレージへの保存変更（セクション1.1）
2. CSRF対策の追加（セクション1.2）
3. 横方向アクセス制御の実装（セクション1.5）
4. パスワードリセットフローの設計追加（セクション1.4）
5. セッション管理の強化（セクション1.3）
6. 監査ログの改ざん防止（セクション1.6）
