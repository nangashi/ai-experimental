# 採点結果: v003-critical-checks

## 実行条件
- **バリアント名**: v003-critical-checks
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 10問

---

## 検出マトリクス

| 問題ID | 問題概要 | Run1 | Run2 | 検出基準 |
|--------|---------|------|------|---------|
| P01 | デバイス認証キーの漏洩リスク（平文保存・通信） | × | × | device_keyの平文保存/通信の危険性＋代替手段提案 |
| P02 | JWTトークンのセキュアな保存方法が不明 | × | △ | JWT保存方法（iOS Keychain等）の欠如を指摘 |
| P03 | デバイス制御コマンドの認可チェックが不明確 | × | × | 制御コマンドでの権限レベル認可チェック不明確を指摘 |
| P04 | OTA更新パッケージのダウンロードURL有効期限が不明 | × | ○ | S3署名付きURLの有効期限設計不明確を指摘 |
| P05 | リフレッシュトークンのローテーション戦略が欠如 | ○ | × | トークンローテーション（新トークン発行＋旧トークン無効化）欠如 |
| P06 | センサーデータAPIの入力検証が不明確 | × | × | 日時パラメータ（start/end）の検証不明確＋DoSリスク |
| P07 | デバイスコマンド送信時の冪等性保証が欠如 | × | ○ | 冪等性キー欠如＋重複実行リスク |
| P08 | ログ出力時のマスキング方針が不明 | ○ | ○ | 機密情報（センサーデータ、デバイス設定等）のマスキング欠如 |
| P09 | MQTTブローカーの認証・認可メカニズムが不明確 | × | × | MQTTブローカーの認証・認可（Username/Password、ACL）欠如 |
| P10 | APIレート制限がIPベースのみ | × | × | IPベースの限界＋ユーザーベース制限欠如 |

---

## 詳細評価

### Run1: v003-critical-checks-run1.md

#### 検出スコア詳細

| 問題ID | 判定 | スコア | 根拠 |
|--------|------|-------|------|
| P01 | × | 0.0 | P03でdevice_keyのライフサイクル管理（失効、ローテーション）を指摘しているが、平文保存や平文通信（クライアントIDとしての使用）の危険性やハッシュ化・チャレンジレスポンス認証等の代替手段には触れていない |
| P02 | × | 0.0 | P13でJWT署名アルゴリズム（RS256推奨）とシークレット管理を指摘しているが、モバイルアプリ側でのトークン保存方法（iOS Keychain、Android Keystore等のセキュアストレージ）には触れていない |
| P03 | × | 0.0 | P05でセンサーデータAPIのアクセス制御を指摘しているが、デバイス制御コマンド（POST /api/devices/:id/command）の認可チェックや権限レベル（owner/write/read）による制御には触れていない |
| P04 | × | 0.0 | P02でOTA更新パッケージの署名検証を詳細に指摘しているが、S3 URLの有効期限設計（署名付きURLの有効期限や動的取得メカニズム）には触れていない |
| P05 | ○ | 1.0 | P06でリフレッシュトークンのローテーション機能（新しいトークン発行＋古いトークン無効化）が未設計であることを明確に指摘し、具体的な実装方針も提案 |
| P06 | × | 0.0 | P05でセンサーデータAPIの時間範囲制限とデータ量制限の欠如を指摘しているが、start/endパラメータの入力検証（startがendより後、期間が異常に長い等）の具体的な検証不足には触れていない |
| P07 | × | 0.0 | デバイスコマンド送信時の冪等性保証（Idempotency Key）の欠如について指摘なし |
| P08 | ○ | 1.0 | P07で監査ログにおける機密データ（パスワード、デバイスキー、JWTトークン、センサーデータ等）のマスキング戦略が未設計であることを明確に指摘 |
| P09 | × | 0.0 | MQTTブローカーの認証・認可メカニズム（Username/Password、ACL等）やトピックレベルのアクセス制御について指摘なし |
| P10 | × | 0.0 | P10でAPIレート制限の粒度改善（エンドポイントごと、ユーザーIDベース）を提案しているが、現行のIPベースのみの問題点（複数IP使用時の効果低下、同一ネットワーク誤検知）には触れていない |

**検出スコア合計**: 2.0/10.0

#### ボーナス評価

| ID | カテゴリ | 内容 | 判定 | スコア |
|----|---------|------|------|-------|
| B01 | データ保護 | InfluxDBのセンサーデータ暗号化方針不明 | × | 0.0 |
| B02 | 認証・認可 | パスワードリセット機能の設計欠如 | × | 0.0 |
| B03 | データ保護 | OTA更新パッケージの署名検証アルゴリズム不明 | ○ | +0.5 |
| B04 | 監査・監視 | デバイスアクセス権限変更の監査ログ設計欠如 | × | 0.0 |
| B05 | 認証・認可 | デバイス登録APIの認証方式不明 | × | 0.0 |
| B06 | 入力検証 | デバイス制御コマンドのパラメータ検証不明 | ○ | +0.5 |
| B07 | インフラ | TLS証明書の管理方針不明 | × | 0.0 |
| B08 | データ保護 | PostgreSQLバックアップ暗号化方針不明 | × | 0.0 |
| B09 | 認証・認可 | Socket.IO認証方式不明 | ○ | +0.5 |
| B10 | 入力検証 | デバイステレメトリデータの検証方針不明 | × | 0.0 |
| B11 | インフラ | ECS Fargateセキュリティグループ設計不明 | × | 0.0 |
| B12 | データ保護 | RedisのTLS接続設定不明 | × | 0.0 |

**追加ボーナス**:
- **P01（CSRF対策未設計）**: +0.5 - 状態変更APIに対するCSRF対策の欠如を重大な問題として指摘（B03同等の重要性）
- **P04（MQTT通信のペイロード暗号化未設計）**: +0.5 - MQTTペイロード自体の暗号化（TLSとは別レイヤー）の欠如を指摘
- **P11（デバイス削除時のデータ保持ポリシー未設計）**: +0.5 - GDPRやCCPA対応のデータ削除要求処理の欠如を指摘
- **P12（管理者エンドポイントの認証・認可未設計）**: +0.5 - 管理者権限の定義とRBAC欠如を指摘
- **P13（JWTトークンの署名アルゴリズムとシークレット管理未設計）**: +0.5 - RS256推奨とKMS管理を含む詳細な設計提案
- **P14（Socket.IOのリアルタイム通信認証・認可未設計）**: +0.5 - WebSocket接続時のJWT認証とルームベースのアクセス制御欠如を指摘（B09と重複だが、より詳細）→ B09としてカウント済みのため除外
- **P15（データベース接続のセキュリティ設定未設計）**: +0.5 - IAM認証、TLS接続、Secrets Manager使用等の具体的提案
- **P16（ファイルアップロード機能のセキュリティ対策未設計）**: +0.5 - ファイルサイズ制限、形式検証、マルウェアスキャンの欠如を指摘

**ボーナス合計**: +1.5（カタログ） + 4.0（追加） = +5.5 → 上限5件で +2.5

#### ペナルティ評価

スコープ外の指摘や事実に反する指摘は確認されず。

**ペナルティ合計**: 0.0

#### Run1 総合スコア

```
Run1 = 検出スコア + ボーナス - ペナルティ
     = 2.0 + 2.5 - 0.0
     = 4.5
```

---

### Run2: v003-critical-checks-run2.md

#### 検出スコア詳細

| 問題ID | 判定 | スコア | 根拠 |
|--------|------|-------|------|
| P01 | × | 0.0 | #3でデバイス認証におけるブルートフォース対策を指摘しているが、device_keyの平文保存や平文通信（MQTT接続時のクライアントID使用）の危険性、ハッシュ化やチャレンジレスポンス認証等の代替手段には触れていない |
| P02 | △ | 0.5 | 改善提案#3でJWTトークンの保存方式が不明確と指摘し、react-native-keychainの使用を推奨しているが、設計書に欠如していることの問題点としては弱く、モバイルアプリの実装詳細として扱っている（設計レビューとしては部分的） |
| P03 | × | 0.0 | デバイス制御コマンド（POST /api/devices/:id/command）の認可チェックや権限レベル（owner/write/read）による制御の不明確さについて指摘なし |
| P04 | ○ | 1.0 | 改善提案#5でS3ファームウェアイメージへのアクセス制御が不明確と指摘し、署名付きURL（有効期限15分）の使用を推奨し、具体的な実装例も提示 |
| P05 | × | 0.0 | リフレッシュトークンのローテーション機能について指摘なし（改善提案#3でトークン失効機能に触れているが、ローテーション戦略の欠如には触れていない） |
| P06 | × | 0.0 | センサーデータAPI（GET /api/devices/:id/telemetry）のstart/endパラメータの入力検証不明確について指摘なし |
| P07 | ○ | 1.0 | 改善提案#2でデバイスコマンドAPIにおける冪等性保証（Idempotency Key）が未設計であることを明確に指摘し、具体的な実装方針（Redisキャッシュ、24時間保持）も提案 |
| P08 | ○ | 1.0 | 改善提案#1で監査ログにおける機密データ（パスワード、device_key、JWTトークン等）のマスキング戦略が未設計であることを明確に指摘 |
| P09 | × | 0.0 | MQTTブローカーの認証・認可メカニズム（Username/Password、ACL等）やトピックレベルのアクセス制御について指摘なし |
| P10 | × | 0.0 | 改善提案#4でAPIレート制限の粒度改善（エンドポイントごと、ユーザーIDベース）を提案しているが、現行のIPベースのみの問題点（複数IP使用時の効果低下、同一ネットワーク誤検知）には明確に触れていない |

**検出スコア合計**: 3.5/10.0

#### ボーナス評価

| ID | カテゴリ | 内容 | 判定 | スコア |
|----|---------|------|------|-------|
| B01 | データ保護 | InfluxDBのセンサーデータ暗号化方針不明 | ○ | +0.5 |
| B02 | 認証・認可 | パスワードリセット機能の設計欠如 | × | 0.0 |
| B03 | データ保護 | OTA更新パッケージの署名検証アルゴリズム不明 | ○ | +0.5 |
| B04 | 監査・監視 | デバイスアクセス権限変更の監査ログ設計欠如 | × | 0.0 |
| B05 | 認証・認可 | デバイス登録APIの認証方式不明 | × | 0.0 |
| B06 | 入力検証 | デバイス制御コマンドのパラメータ検証不明 | ○ | +0.5 |
| B07 | インフラ | TLS証明書の管理方針不明 | × | 0.0 |
| B08 | データ保護 | PostgreSQLバックアップ暗号化方針不明 | ○ | +0.5 |
| B09 | 認証・認可 | Socket.IO認証方式不明 | × | 0.0 |
| B10 | 入力検証 | デバイステレメトリデータの検証方針不明 | × | 0.0 |
| B11 | インフラ | ECS Fargateセキュリティグループ設計不明 | × | 0.0 |
| B12 | データ保護 | RedisのTLS接続設定不明 | × | 0.0 |

**追加ボーナス**:
- **#1（CSRF対策未設計）**: +0.5 - 状態変更APIに対するCSRF対策の欠如を重大な問題として指摘
- **改善提案#6（データベース接続情報とシークレット管理未設計）**: +0.5 - AWS Secrets ManagerとECS Fargate統合の具体的提案
- **改善提案#7（InfluxDBとPostgreSQLの保存データ暗号化未設計）**: すでにB01、B08でカウント済み
- **確認事項#1（センサーデータの保持期間とプライバシーポリシー）**: +0.5 - GDPRやCCPAに基づくデータ保持期間設計の欠如を指摘
- **確認事項#2（MQTT通信の認証方式選択）**: +0.5 - TLS相互認証やハイブリッド方式の選択肢を提示（設計の不明確さを指摘）
- **確認事項#3（Socket.IO認証戦略）**: +0.5 - WebSocket接続時の認証方式が明記されていない点を指摘

**ボーナス合計**: +2.0（カタログ） + 4.0（追加） = +6.0 → 上限5件で +2.5

#### ペナルティ評価

スコープ外の指摘や事実に反する指摘は確認されず。

**ペナルティ合計**: 0.0

#### Run2 総合スコア

```
Run2 = 検出スコア + ボーナス - ペナルティ
     = 3.5 + 2.5 - 0.0
     = 6.0
```

---

## 総合評価

### スコアサマリ

```
v003-critical-checks: Mean=5.25, SD=0.75
Run1=4.5 (検出2.0+bonus5-penalty0)
Run2=6.0 (検出3.5+bonus5-penalty0)
```

### 安定性評価

| 標準偏差 (SD) | 判定 | 該当 |
|--------------|------|------|
| SD ≤ 0.5 | 高安定 | |
| 0.5 < SD ≤ 1.0 | 中安定 | ✓ |
| SD > 1.0 | 低安定 | |

**判定**: 中安定 - 傾向は信頼できるが、個別の実行で変動がある

### 分析

#### 強み
1. **ログマスキング（P08）**: 両Run共に検出。機密情報のマスキング欠如を安定して指摘
2. **ボーナス問題検出**: 両Run共にOTA署名検証アルゴリズム（B03）、デバイスコマンドパラメータ検証（B06）、CSRF対策等の追加問題を検出
3. **詳細な代替手段提案**: 検出した問題に対して具体的な技術スタック（express-rate-limit、react-native-keychain、AWS KMS等）を提示

#### 弱み
1. **device_key平文保存・通信（P01）**: 両Run共に未検出。デバイス認証の周辺問題（ブルートフォース対策、ライフサイクル管理）を指摘するも、平文保存/通信の核心的問題を捉えていない
2. **制御コマンド認可チェック（P03）**: 両Run共に未検出。センサーデータAPIのアクセス制御は指摘するが、制御コマンドの認可チェック不明確には触れず
3. **センサーデータAPI入力検証（P06）**: 両Run共に未検出。時間範囲制限は指摘するが、start/endパラメータの具体的な検証ロジック欠如には触れず
4. **MQTTブローカー認証・認可（P09）**: 両Run共に未検出。MQTTペイロード暗号化やデバイス認証には触れるが、ブローカーレベルの認証・認可メカニズム欠如を指摘せず
5. **APIレート制限IPベースの限界（P10）**: 両Run共に未検出。エンドポイントごとの粒度改善は提案するが、IPベースのみの問題点（複数IP使用、同一ネットワーク誤検知）を明確に指摘せず
6. **実行間の変動**: Run1でP05（トークンローテーション）を検出したがRun2では未検出、Run2でP04（S3 URL有効期限）とP07（冪等性）を検出したがRun1では未検出。検出の一貫性に課題

#### 実行間変動の原因分析
- **P02（JWT保存方式）**: Run1では未検出、Run2では△（部分検出）
  - Run2で改善提案として言及したが、設計書の欠如としての指摘は弱い
- **P04（S3 URL有効期限）**: Run1では未検出、Run2では○（検出）
  - Run2で改善提案#5として明確に指摘、Run1ではOTA署名検証のみに焦点
- **P05（トークンローテーション）**: Run1では○（検出）、Run2では未検出
  - Run1でP06として明確に指摘、Run2では改善提案#3でトークン失効に触れるもローテーション戦略の欠如には言及せず
- **P07（冪等性）**: Run1では未検出、Run2では○（検出）
  - Run2で改善提案#2として明確に指摘、Run1では言及なし

### 推奨アクション
1. **device_key平文保存・通信の検出強化**: perspectives/security.mdに「認証キーの保存形式（平文/ハッシュ化）」「認証キーの通信時の保護方式」を評価項目として明記
2. **認可チェックの検出強化**: approach-catalog.mdまたはperspectives/security.mdに「エンドポイントごとの認可チェック実装方針の明示」を評価軸として追加
3. **入力検証の検出粒度向上**: 「時間範囲パラメータの具体的な検証ロジック（start < endチェック、最大期間制限）」を問題バンクに追加
4. **MQTTブローカーレイヤーの検出**: 「MQTTブローカーの認証・認可メカニズム（ACL、Username/Password）」を明示的に評価項目化
5. **APIレート制限の評価軸明確化**: 「IPベースレート制限の限界（複数IP使用、同一ネットワーク誤検知）とユーザーベース制限の必要性」を問題バンクに追加
6. **検出の一貫性向上**: critical-checks.mdのチェックリストにP05（トークンローテーション）、P07（冪等性）を明示的に追加し、実行間変動を低減

---

## 検出率サマリ

| カテゴリ | 検出数/総数 | 検出率 |
|---------|-----------|--------|
| 認証・認可設計（P01, P02, P03, P05） | 1/4 | 25% |
| データ保護（P04, P08） | 2/2 | 100% |
| 入力検証設計（P06, P07） | 1/2 | 50% |
| インフラ・依存関係（P09, P10） | 0/2 | 0% |
| **全体** | **4/10（Run1）～5.5/10（Run2）** | **40%～55%** |

**平均検出率**: 47.5%
