# 採点結果: v005-baseline

## 実行条件
- **バリアント**: baseline
- **観点**: security-design
- **埋め込み問題数**: 9問
- **実行回数**: 2回

---

## Run1 採点結果

### 検出マトリクス

| 問題ID | カテゴリ | 判定 | スコア | 検出根拠 |
|--------|----------|------|--------|----------|
| P01 | JWT有効期限が長すぎる | ○ | 1.0 | Section 1.1で「JWT tokens with 24-hour expiration」の問題を指摘し、「Reduce access token expiration to 15 minutes」「Implement refresh token mechanism」を提案 |
| P02 | JWTの署名アルゴリズムと鍵管理方針が未定義 | ○ | 1.0 | Section 1.5で「Undefined Secrets Management for Database Credentials and JWT Keys」として署名アルゴリズム未定義と鍵管理方針の欠如を指摘 |
| P03 | 他院との診療情報共有における認可設計が不明確 | ○ | 1.0 | Section 1.2で「Insufficient Authorization Controls for Medical Record Sharing」として患者同意、アクセス権限期限、アクセスログ記録の欠如を指摘 |
| P04 | 入力検証方針の欠如 | ○ | 1.0 | Section 1.3で「Missing SQL Injection Prevention Strategy」、Section 1.4で「No XSS Prevention Measures」として入力検証方針の欠如を指摘 |
| P05 | 予約キャンセルAPIの冪等性が未定義 | × | 0.0 | APIの冪等性や重複リクエスト処理に関する指摘なし |
| P06 | 監査ログの記録範囲が不十分 | ○ | 1.0 | Section 2.2で「Implement Audit Logging for Medical Record Access」として誰が、いつ、どの患者のカルテにアクセスしたかの記録欠如を指摘 |
| P07 | データベース内の暗号化対象が限定的 | × | 0.0 | 暗号化対象の拡大（氏名、生年月日、電話番号等）や鍵管理方針の欠如に関する指摘なし。Section 1.5で鍵管理は言及されているが、暗号化対象の限定性については触れていない |
| P08 | APIレート制限の設計が不十分 | ○ | 1.0 | Section 2.1で「Add Rate Limiting for Authentication Endpoints」として未認証ユーザーとログイン試行に対するレート制限の欠如を指摘 |
| P09 | エラーメッセージで内部情報が露出する可能性 | × | 0.0 | エラーメッセージの詳細度や情報露出リスクに関する指摘なし |

**検出スコア合計**: 6.0/9.0

### ボーナス

| ID | 内容 | スコア | 根拠 |
|----|------|--------|------|
| B02 | 医師アカウントの多要素認証（MFA）が未定義 | +0.5 | Section 3.1で医師・管理者アカウントに対するMFA要件の欠如を指摘（確認項目として） |
| B03 | S3バケットのアクセス制御方針が不明確 | +0.5 | Section 2.5で「Define S3 Bucket Security Configuration」としてS3のパブリックアクセス禁止、署名付きURL使用等の欠如を指摘 |
| B06 | 依存ライブラリの脆弱性管理方針が未定義 | +0.5 | Section 2.7で「Add Dependency Vulnerability Scanning」としてサードパーティライブラリの脆弱性スキャン方針の欠如を指摘 |
| B04 | WAFのルールセットが未定義 | +0.5 | Section 2.8で「Define WAF Rules for Common Attack Patterns」としてWAFの具体的保護ルールの欠如を指摘 |
| - | データ保持・削除ポリシーが未定義 | +0.5 | Section 2.3で「Add Data Retention and Deletion Policy」として医療記録の保持期間とGDPR削除権に関する方針の欠如を指摘（スコープ内） |

**ボーナス合計**: +2.5 (5件)

### ペナルティ

該当なし

**ペナルティ合計**: 0

### Run1 総合スコア

```
run1_score = 6.0 + 2.5 - 0 = 8.5
```

---

## Run2 採点結果

### 検出マトリクス

| 問題ID | カテゴリ | 判定 | スコア | 検出根拠 |
|--------|----------|------|--------|----------|
| P01 | JWT有効期限が長すぎる | ○ | 1.0 | Section 1.1で「JWT tokens with 24-hour expiration」の問題を指摘し、「Reduce access token expiration to 15 minutes」「Implement refresh token pattern」を提案 |
| P02 | JWTの署名アルゴリズムと鍵管理方針が未定義 | △ | 0.5 | Section 2.2で「Specify Secret Management Design」として鍵管理方針の欠如は指摘しているが、署名アルゴリズム未定義には具体的に触れていない |
| P03 | 他院との診療情報共有における認可設計が不明確 | ○ | 1.0 | Section 3.1で「Shared Medical Records (`is_shared` flag) Access Control」として認可フローの欠如を指摘（確認項目として） |
| P04 | 入力検証方針の欠如 | ○ | 1.0 | Section 1.2で「No Input Validation Design Against Injection Attacks」としてSQLインジェクション・XSS防止策と入力検証方針の欠如を指摘 |
| P05 | 予約キャンセルAPIの冪等性が未定義 | × | 0.0 | APIの冪等性や重複リクエスト処理に関する指摘なし |
| P06 | 監査ログの記録範囲が不十分 | ○ | 1.0 | Section 1.4で「No Audit Logging for Medical Data Access」として誰が、いつ、どの患者のカルテにアクセスしたかの記録欠如を指摘 |
| P07 | データベース内の暗号化対象が限定的 | × | 0.0 | 暗号化対象の拡大（氏名、生年月日、電話番号等）に関する指摘なし。Section 2.4で鍵管理は言及されているが、暗号化対象の限定性については触れていない |
| P08 | APIレート制限の設計が不十分 | ○ | 1.0 | Section 2.1で「Add Rate Limiting for Authentication Endpoints」として未認証ユーザーとログイン試行に対するレート制限の欠如を指摘 |
| P09 | エラーメッセージで内部情報が露出する可能性 | × | 0.0 | エラーメッセージの詳細度や情報露出リスクに関する指摘なし |

**検出スコア合計**: 5.5/9.0

### ボーナス

| ID | 内容 | スコア | 根拠 |
|----|------|--------|------|
| B02 | 医師アカウントの多要素認証（MFA）が未定義 | +0.5 | Section 2.3で「Add Multi-Factor Authentication (MFA) for Medical Staff」として医療従事者アカウントに対するMFA要件の欠如を指摘 |
| B06 | 依存ライブラリの脆弱性管理方針が未定義 | +0.5 | Section 2.6で「Specify Dependency Vulnerability Scanning」としてサードパーティライブラリの脆弱性スキャン方針の欠如を指摘 |
| - | CSRF保護の欠如 | +0.5 | Section 1.3で「Authorization Checks are Insufficient」としてIDOR脆弱性を指摘（スコープ内の認可設計問題） |
| - | CORS設計の欠如 | +0.5 | Section 2.5で「Add CORS Policy Design」としてCORS設定の欠如を指摘（スコープ内） |

**ボーナス合計**: +2.0 (4件)

### ペナルティ

該当なし

**ペナルティ合計**: 0

### Run2 総合スコア

```
run2_score = 5.5 + 2.0 - 0 = 7.5
```

---

## 統計サマリ

| 指標 | 値 |
|------|-----|
| Run1スコア | 8.5 (検出6.0 + bonus2.5 - penalty0) |
| Run2スコア | 7.5 (検出5.5 + bonus2.0 - penalty0) |
| **平均 (Mean)** | **8.0** |
| **標準偏差 (SD)** | **0.7** |
| 安定性判定 | 中安定 (0.5 < SD ≤ 1.0) |

---

## 問題別検出率

| 問題ID | Run1 | Run2 | 検出率 |
|--------|------|------|--------|
| P01 (JWT有効期限) | ○ | ○ | 100% |
| P02 (JWT署名・鍵管理) | ○ | △ | 75% |
| P03 (診療情報共有認可) | ○ | ○ | 100% |
| P04 (入力検証方針) | ○ | ○ | 100% |
| P05 (冪等性) | × | × | 0% |
| P06 (監査ログ) | ○ | ○ | 100% |
| P07 (暗号化対象範囲) | × | × | 0% |
| P08 (レート制限) | ○ | ○ | 100% |
| P09 (エラーメッセージ) | × | × | 0% |

---

## 分析

### 強み
- **認証・認可設計**: P01（JWT有効期限）、P03（診療情報共有認可）、P04（入力検証）、P06（監査ログ）、P08（レート制限）を安定して検出（5/9問）
- **ボーナス検出**: MFA、S3アクセス制御、依存ライブラリ脆弱性スキャン、WAFルールセットなど、正解キー外の問題を多数検出（Run1: 5件、Run2: 4件）
- **包括的レビュー**: Critical Issues、Improvement Suggestions、Confirmation Itemsの3層構造で多角的に指摘

### 弱み
- **P05（冪等性）**: 両Run共に未検出。APIの冪等性保証や重複リクエスト処理方針に関する指摘がない
- **P07（暗号化対象範囲）**: 両Run共に未検出。鍵管理方針は指摘しているが、暗号化対象が診断内容・処方箋に限定されている問題に触れていない
- **P09（エラーメッセージ）**: 両Run共に未検出。本番環境でのエラーメッセージの詳細度による情報露出リスクに触れていない
- **P02の変動**: Run1では○、Run2では△。Run2は鍵管理のみ言及で署名アルゴリズム未定義に触れず

### 実行間の変動要因
- **P02（JWT署名・鍵管理）**: Run1は署名アルゴリズムと鍵管理を明示的に指摘、Run2は鍵管理のみ → 0.5pt差
- **ボーナス検出数**: Run1は5件（S3、WAF含む）、Run2は4件（CSRF、CORS含む） → 0.5pt差
- **標準偏差0.7**: 中安定判定。結果にやや変動があるが、傾向は信頼できる

---

## 推奨事項

### 短期改善（次ラウンド）
1. **P05（冪等性）検出強化**: 予約キャンセルAPIのDELETEメソッドに対する冪等性保証や重複リクエスト処理方針の欠如を検出できるよう、API設計レビュー項目を強化
2. **P07（暗号化対象範囲）検出強化**: データ保護カテゴリで暗号化対象の限定性（個人情報の一部のみ暗号化）を検出できるよう、暗号化方針レビュー項目を追加
3. **P09（エラーメッセージ）検出強化**: Information Disclosure カテゴリでエラーメッセージの詳細度による情報露出リスクを検出できるよう、エラーハンドリング方針レビュー項目を追加

### 中期改善
- **P02の安定化**: JWT署名アルゴリズムと鍵管理方針の両方を一貫して検出できるよう、認証設計レビューの明確化
- **冪等性・データ保護の網羅性強化**: STRIDEのTampering（改ざん）カテゴリとの関連付けで、冪等性やデータ整合性の問題を検出しやすくする
