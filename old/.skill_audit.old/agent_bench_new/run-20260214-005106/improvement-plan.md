# 改善計画: agent_bench_new

## 変更対象ファイル
| # | ファイル | 変更種別 | 変更概要 | 対応フィードバック |
|---|---------|---------|---------|------------------|
| 1 | SKILL.md | 修正 | Phase 1A/1B ファイル重複時の上書き/削除/中断選択肢追加 | I-1 |
| 2 | SKILL.md | 修正 | Phase 0 Step 6 検証失敗時のエラー詳細表示と対応選択肢追加 | I-2 |
| 3 | SKILL.md | 修正 | Phase 0 Step 4c で user_requirements が空の場合の処理明記 | I-3 |
| 4 | SKILL.md | 修正 | Phase 3 再試行後も失敗継続時の自動中断処理明記 | I-4 |
| 5 | SKILL.md | 修正 | Phase 4 ベースライン失敗時の判定条件明記 | I-5 |
| 6 | SKILL.md | 修正 | Phase 0 Step 4 統合フィードバック参照をファイル読込形式に修正 | I-6 |
| 7 | SKILL.md | 修正 | Phase 6 Step 2 サブエージェント失敗時の処理フロー追加 | I-7 |
| 8 | SKILL.md | 修正 | Phase 1A user_requirements 空文字列時のテンプレート参照動作を明記 | I-8 |
| 9 | templates/phase1a-variant-generation.md | 修正 | ファイル重複時のエラー出力を上書き/削除/中断選択肢に変更 | I-1 |
| 10 | templates/phase1a-variant-generation.md | 修正 | user_requirements が空の場合の処理ガイド追記 | I-8 |
| 11 | templates/phase1b-variant-generation.md | 修正 | ファイル重複時の警告出力を上書き/削除/中断選択肢に変更 | I-1 |

## 各ファイルの変更詳細

### 1. SKILL.md（修正）
**対応フィードバック**: I-1, I-2, I-3, I-4, I-5, I-6, I-7, I-8

**変更内容**:

- **Phase 0 Step 4c (81-84行)**: user_requirements 空判定処理の明記
  - 現在: エージェント定義不足判定の条件が曖昧（user_requirements が空のまま perspective 生成に進む可能性）
  - 改善後: 「user_requirements が空の場合はエージェント定義を新規生成モードとみなし、AskUserQuestion でのヒアリング結果のみを使用する」旨を明記

- **Phase 0 Step 5 (121行)**: 統合フィードバック参照方法の修正
  - 現在: 「critic-completeness サブエージェントが統合済みフィードバックを返答する（`.agent_bench/{agent_name}/perspective-critique-completeness.md` に保存済み）」
  - 改善後: 「Read で `.agent_bench/{agent_name}/perspective-critique-completeness.md` を読み込み、統合済みフィードバックを取得する」

- **Phase 0 Step 6 (126-128行)**: 検証失敗時のユーザー通知強化
  - 現在: 「検証失敗 → エラー出力してスキルを終了する」
  - 改善後: 「検証失敗 → 欠落セクション名をエラー出力し、AskUserQuestion で以下の選択肢を提示する: (1) 手動でファイルを修正して再試行、(2) perspective-source.md を削除して自動生成を再実行、(3) スキルを中断」

- **Phase 1A 冒頭コメント (177行)**: user_requirements パラメータの扱い明記
  - 現在: 「`{user_requirements}`: Phase 0 で収集した要件テキスト（エージェント定義が既存の場合は空文字列）」
  - 改善後: 「`{user_requirements}`: Phase 0 で収集した要件テキスト（エージェント定義が既存の場合は空文字列。テンプレート側では空の場合にベースライン構築ガイドのみに従う）」

- **Phase 3 失敗時分岐 (244行)**: 再試行後も失敗継続時の処理追加
  - 現在: 「**再試行**: 失敗したタスクのみ再実行する（1回のみ）」
  - 改善後: 「**再試行**: 失敗したタスクのみ再実行する（1回のみ）。再試行後も失敗が継続する場合は自動的にスキルを中断し、エラー内容を出力する」

- **Phase 4 失敗時分岐 (272-273行)**: ベースライン失敗時の判定条件明記
  - 現在: 「**失敗プロンプトを除外して続行**: 成功したプロンプトのみで Phase 5 へ進む（ベースラインが失敗した場合は中断）」
  - 改善後: 「**失敗プロンプトを除外して続行**: 成功したプロンプトのみで Phase 5 へ進む。ただし、ベースライン（v{NNN}-baseline）の採点が失敗している場合は、比較基準が失われるため自動的にスキルを中断し、エラーを出力する」

- **Phase 6 Step 2 (337, 350, 354行)**: サブエージェント失敗時の処理追加
  - 現在: 「サブエージェントの完了を待つ」「A) と B) のサブエージェントタスクが正常に完了したことを Task ツールの返答で確認し」
  - 改善後:
    - 337行: 「サブエージェントの完了を待つ。失敗した場合は警告を出力し、knowledge.md の更新をスキップして B) へ進む」
    - 350行: 「サブエージェントの完了を待つ。失敗した場合は警告を出力し、proven-techniques.md の更新をスキップして C) へ進む」
    - 354行: 「A) と B) のサブエージェントタスクの完了を Task ツールの返答で確認する（いずれかが失敗した場合でも次アクション選択に進む）。その後 `AskUserQuestion` でユーザーに確認する」

### 2. templates/phase1a-variant-generation.md（修正）
**対応フィードバック**: I-1, I-8

**変更内容**:

- **Step 3 (10-13行)**: ファイル重複時の処理変更
  - 現在: 「Read で {prompts_dir}/v001-baseline.md の存在確認を行い、既に存在する場合はエラーを出力して終了する」
  - 改善後: 「Read で {prompts_dir}/v001-baseline.md の存在確認を行う。既に存在する場合、AskUserQuestion で以下の選択肢を提示する: (1) 既存ファイルを上書きして続行、(2) 既存ファイルを削除してから再実行、(3) スキルを中断。(1)または(2)を選択した場合は該当操作を実行してから保存に進む」

- **Step 9 (9行末尾)**: user_requirements が空の場合の処理ガイド追記
  - 現在: 「{user_requirements} を基に、proven-techniques.md の「ベースライン構築ガイド」に従って生成する」
  - 改善後: 「{user_requirements} を基に、proven-techniques.md の「ベースライン構築ガイド」に従って生成する（{user_requirements} が空の場合はベースライン構築ガイドのみに従う）」

### 3. templates/phase1b-variant-generation.md（修正）
**対応フィードバック**: I-1

**変更内容**:

- **Step 3-4 (22-24行)**: ファイル重複時の処理変更
  - 現在: 「ベースライン（比較用コピー）を保存する前に、{prompts_dir}/v{NNN}-baseline.md が既に存在するか確認する。存在する場合は警告を出力し、保存をスキップする。存在しない場合は {prompts_dir}/v{NNN}-baseline.md として保存する」
  - 改善後: 「ベースライン（比較用コピー）を保存する前に、{prompts_dir}/v{NNN}-baseline.md が既に存在するか確認する。既に存在する場合、AskUserQuestion で以下の選択肢を提示する: (1) 既存ファイルを上書きして続行、(2) 既存ファイルを削除してから再実行、(3) スキルを中断。(1)または(2)を選択した場合は該当操作を実行してから保存に進む。バリアント保存時も同様に、{prompts_dir}/v{NNN}-variant-{name}.md の存在確認と対応選択肢の提示を行う」

## 新規作成ファイル

なし

## 削除推奨ファイル

なし

## 実装順序

1. **templates/phase1a-variant-generation.md** の修正
   - 理由: SKILL.md から参照されるテンプレートファイルであり、Phase 1A の動作に直接影響する。先に修正することで、SKILL.md 更新時の整合性確認が容易になる

2. **templates/phase1b-variant-generation.md** の修正
   - 理由: 同様にテンプレートファイルであり、Phase 1B の動作に直接影響する

3. **SKILL.md** の修正
   - 理由: 全フェーズの統括ファイル。テンプレートファイルの修正完了後に更新することで、参照先の動作が確定した状態で記述を調整できる

依存関係の検出方法:
- テンプレートファイル（1-2）の修正内容をSKILL.md（3）が参照する形で整合性を保つ必要があるため、テンプレートを先に修正する

## 注意事項

- **既存ワークフローの保持**: ファイル重複時の選択肢追加により、既存のワークフローが壊れることはない。ユーザーが「中断」を選択することで従来通りのエラー終了も可能
- **エラーハンドリングの一貫性**: Phase 3, Phase 4, Phase 6 のサブエージェント失敗時の処理を統一的に記述し、スキル全体の安定性を向上させる
- **ユーザーインタラクションの増加**: 今回の改善により AskUserQuestion の呼び出し箇所が増えるが、全て異常系またはファイル競合時の対応であり、通常フローには影響しない
- **テンプレート参照の整合性**: SKILL.md からテンプレートに渡すパラメータ説明と、テンプレート内での使用方法の整合性を確認する（特に user_requirements の空文字列ケース）
