### 安定性レビュー結果

#### 重大な問題
- [出力フォーマット決定性: サブエージェント返答フォーマット検証の欠落]: [SKILL.md] [Phase 1 Line 139-156] [サブエージェント返答から件数を抽出する処理で「抽出失敗時は findings ファイル内の `### {ID_PREFIX}-` ブロック数から推定する」とあるが、推定処理の実装指示がない] → [推定処理の具体的手順を明示する: "サブエージェント返答から数値抽出を試行 → 失敗時は Grep で findings ファイル内の `^### {ID_PREFIX}-` パターンをカウント → 0件の場合はファイル存在確認とサイズ確認"] [impact: high] [effort: low]
- [条件分岐の完全性: Phase 0 Step 3 の処理継続条件が不明確]: [SKILL.md] [Phase 0 Step 3 Line 66] [frontmatter 欠落時に「処理は継続する」と記載されているが、後続ステップでの取り扱いが未定義（グループ分類に影響するか、Phase 2 検証で追加処理が必要か等）] → [継続時の動作を明示: "frontmatter が存在しない場合でもグループ分類と分析は実行する。Phase 2 検証ステップで frontmatter の欠落を critical finding として扱う"] [impact: high] [effort: medium]
- [冪等性: Phase 1 既存 findings 上書き動作の明示不足]: [SKILL.md] [Phase 1 Line 117] [「既存 findings ファイルが存在する場合、サブエージェントが Write で上書きする」とあるが、親コンテキストでの事前確認・警告出力の指示がない] → [Phase 1 冒頭に追加: "既存 findings ファイルを Glob で検索し、存在する場合は「既存の分析結果を上書きします: {ファイルリスト}」とテキスト出力する"] [impact: medium] [effort: low]
- [参照整合性: テンプレート内プレースホルダの定義欠落]: [templates/apply-improvements.md] [Line 4, 5, 17] [{approved_findings_path}, {agent_path}, {backup_path} の3つのプレースホルダが使用されているが、SKILL.md のパス変数リスト（Phase 2 Step 4 Line 214-217）でのみ定義され、テンプレート冒頭に変数定義セクションがない] → [テンプレート冒頭に「## パス変数」セクションを追加し、各プレースホルダの説明を記載する（agents/*.md と同様の形式）] [impact: high] [effort: low]
- [条件分岐の完全性: Phase 2 Step 2 Fast mode 分岐の実装指示不足]: [SKILL.md] [Phase 2 冒頭 Line 163] [「Fast mode が有効な場合、Step 2 の承認確認をスキップし、全 findings を自動承認として Step 3 へ進む」とあるが、Fast mode フラグの取得方法・判定条件が未記載] → [Phase 0 冒頭に追加: "引数から `--fast` フラグの有無を確認し、`{fast_mode} = true/false` として保持する"。Phase 2 冒頭に追加: "if {fast_mode} == true: 「Fast mode: 全 findings を自動承認します」とテキスト出力し、Step 2 をスキップして Step 3 へ進む"] [impact: high] [effort: medium]

#### 改善提案
- [指示の具体性: グループ分類の判定実装方法が未指定]: [SKILL.md] [Phase 0 Step 4 Line 70-80] [「エージェント定義の主たる機能に注目して分類する」とあるが、具体的な判定手順（group-classification.md の特徴リストとのマッチング方法）が記載されていない] → [Step 4 を詳細化: "Read で group-classification.md を読み込み、evaluator 特徴リスト・producer 特徴リストと {agent_content} を照合する。各特徴について該当有無を判定し、該当数をカウントする。判定ルールに従ってグループを決定する"] [impact: medium] [effort: medium]
- [出力フォーマット決定性: Phase 3 条件分岐時の出力形式が部分的に未定義]: [SKILL.md] [Phase 3 Line 259-262] [次のステップの条件分岐で「承認が 0 件の場合: 次のステップは表示しない」とあるが、Phase 2 スキップ時（対象 findings なし）と承認 0 件（ユーザーが全スキップ）の出力形式の違いが明示されていない] → [Phase 3 冒頭に条件分岐ルールを追加: "if Phase 2 スキップ（total == 0）: 「改善対象なし」セクションを出力。if Phase 2 実行かつ承認 0 件: 「承認: 0/{total}件」を出力し、次のステップは表示しない"] [impact: medium] [effort: low]
- [参照整合性: agents/*.md 内で言及されたファイルの存在確認欠落]: [SKILL.md] [Phase 1 Line 125] [各分析エージェント定義（agents/{dim_path}.md）が参照するファイル（パス変数で指定される {agent_path}, {findings_save_path} 等）の存在確認がサブエージェント側で必要だが、SKILL.md にその指示がない] → [各 agents/*.md テンプレートの Steps セクション冒頭に追加: "Read で {agent_path} を読み込む。読み込み失敗時は「エラー: {agent_path} が見つかりません」と返答して終了する"] [impact: low] [effort: low]
- [指示の具体性: Phase 2 Step 1 の "severity が critical または improvement" の抽出方法が未指定]: [SKILL.md] [Phase 2 Step 1 Line 170] [「severity が critical または improvement の finding（`###` ブロック単位）を抽出」とあるが、findings ファイルのフォーマットパターン（`### {ID}: {title} [severity: {level}]`）との照合方法が記載されていない] → [Step 1 を詳細化: "各 findings ファイルから Grep で `^### .+\\[severity: (critical|improvement)\\]` パターンにマッチする行とその後続行（description, 根拠, 推奨まで）を抽出する"] [impact: medium] [effort: low]
- [冪等性: Phase 2 Step 4 バックアップファイル名の衝突リスク]: [SKILL.md] [Phase 2 Step 4 Line 209] [「cp {agent_path} {agent_path}.backup-$(date +%Y%m%d-%H%M%S)」で秒単位のタイムスタンプを使用しているが、同一秒内の複数実行で衝突する可能性がある] → [バックアップコマンドを変更: "cp {agent_path} {agent_path}.backup-$(date +%Y%m%d-%H%M%S)-$$（プロセスIDを追加）"。または "if [ -f {backup_path} ]; then echo '⚠ バックアップファイルが既に存在します: {backup_path}'; fi" で事前警告を追加"] [impact: low] [effort: low]
- [条件分岐の完全性: Phase 2 Step 2a の "Other" 入力時の修正内容パース処理が未定義]: [SKILL.md] [Phase 2 Step 2a Line 197] [「ユーザーが "Other" で修正内容を入力した場合は「修正して承認」として改善計画に含める」とあるが、入力内容の検証・パース・エラーハンドリングが未記載] → [Step 2a に追加: "ユーザー入力が空の場合は「修正内容が入力されていません。この指摘をスキップしますか？（承認/スキップ）」と再確認する。入力が 1000 文字を超える場合は「修正内容が長すぎます（{N}文字）。要約してください」と警告する"] [impact: medium] [effort: medium]
- [出力フォーマット決定性: Phase 1 返答サマリの "分析失敗" 時のフォーマット不統一]: [SKILL.md] [Phase 1 Line 150-151] [成功時は "critical {N}, improvement {M}, info {K}" 形式だが、失敗時は "分析失敗（{エラー概要}）" 形式で件数フィールドがない] → [失敗時のフォーマットを統一: "critical -, improvement -, info - (分析失敗: {エラー概要})" のように件数フィールドを保持しつつエラー情報を付加する] [impact: low] [effort: low]

#### 良い点
- [冪等性: Phase 2 Step 4 バックアップ作成による変更前状態の保護]: Phase 2 Step 4 で改善適用前に必ずバックアップを作成し、エラー時・検証失敗時にロールバックコマンドを提示する設計は、再実行時のデータ破壊リスクを大幅に低減している
- [参照整合性: パス変数の一貫した命名規則]: SKILL.md およびテンプレート内で使用される全プレースホルダが `{variable_name}` 形式で統一されており、変数の識別が容易である
- [出力フォーマット決定性: サブエージェント返答の厳格な行数・フィールド制約]: Phase 1 サブエージェントに 4 行フォーマット（dim, critical, improvement, info）、Phase 2 Step 4 サブエージェントに 30 行以内のサマリ返答を義務付け、親コンテキストの肥大化を防止している
