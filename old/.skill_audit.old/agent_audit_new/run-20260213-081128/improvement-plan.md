# 改善計画: agent_audit_new

## 変更対象ファイル
| # | ファイル | 変更種別 | 変更概要 | 対応フィードバック |
|---|---------|---------|---------|------------------|
| 1 | SKILL.md | 修正 | 外部参照パスの修正（3箇所） | C-1 |
| 2 | SKILL.md | 修正 | Phase 2 Step 4 エラーハンドリング追加 | C-2 |
| 3 | SKILL.md | 修正 | Phase 2 Step 4 に改善適用前の確認追加 | C-3 |
| 4 | SKILL.md | 修正 | Phase 1 エラー抽出方法の明示化 | I-1 |
| 5 | SKILL.md | 修正 | Phase 1 返答バリデーション追加 | I-2 |
| 6 | SKILL.md | 修正 | Phase 2 Step 4 パス変数リストの追加 | I-3 |
| 7 | SKILL.md | 修正 | Phase 2 Step 2 全承認時の件数内訳表示追加 | I-4 |
| 8 | SKILL.md | 修正 | Phase 0 グループ分類基準参照のパス修正 | I-5 |
| 9 | SKILL.md | 修正 | Phase 1 部分成功の最低基準明示 | I-6 |
| 10 | SKILL.md | 修正 | Phase 2 Step 2a "Other" 分岐処理の明示化 | I-7 |
| 11 | SKILL.md | 修正 | Phase 2 Step 4 バックアップ重複生成防止 | I-8 |
| 12 | SKILL.md | 修正 | Phase 2 検証ステップの強化 | I-9 |

## 各ファイルの変更詳細

### 1. SKILL.md（修正）
**対応フィードバック**: C-1: 外部参照のパス不整合

**変更内容**:
- 64行目: `.claude/skills/agent_audit/group-classification.md` → `group-classification.md`（スキル内相対パス）
- 115行目: `.claude/skills/agent_audit/agents/{dim_path}.md` → `.claude/skills/agent_audit_new/agents/{dim_path}.md`
- 221行目: `.claude/skills/agent_audit/templates/apply-improvements.md` → `.claude/skills/agent_audit_new/templates/apply-improvements.md`

### 2. SKILL.md（修正）
**対応フィードバック**: C-2: Phase 2 Step 4 改善適用失敗時のフォールバック未定義

**変更内容**:
- 226行目以降: 「サブエージェント完了後、返答内容（変更サマリ）をテキスト出力する。」の後に以下を追加:

```
**サブエージェント完了確認**: 返答内容に `modified:` または `skipped:` が含まれているか検証する。検証失敗時は「✗ 改善適用に失敗しました。詳細: {サブエージェント返答の先頭200文字}」とテキスト出力し、「以下のコマンドでロールバックできます: `cp {backup_path} {agent_path}`」と表示してPhase 3へ進む。
```

### 3. SKILL.md（修正）
**対応フィードバック**: C-3: 不可逆操作のガード欠落: ファイル上書き前の確認なし

**変更内容**:
- 215行目: 「改善を適用しています...」テキスト出力の後、バックアップ作成の前に以下を追加:

```
**改善適用の確認**: `AskUserQuestion` で「{承認数}件の改善を {agent_path} に適用します。バックアップは自動作成されます。適用しますか？」と確認する。選択肢は以下の2つ:
- **「適用」**: 改善適用を開始する
- **「キャンセル」**: 改善適用をスキップし、Phase 3 へ進む

「キャンセル」選択時: 「改善の適用はスキップされました。」とテキスト出力し、Phase 3 へ直行する。
```

### 4. SKILL.md（修正）
**対応フィードバック**: I-1: Phase 1 エラーハンドリングの情報欠落

**変更内容**:
- 127行目: 「Task ツールの返答から例外情報（エラーメッセージの要約）を抽出し」を以下に置換:

```
Task ツールの返答テキスト全体を `{error_text}` として保持し、`{error_text}` の先頭100文字を `{エラー概要}` として表示する
```

### 5. SKILL.md（修正）
**対応フィードバック**: I-2: サブエージェント返答のバリデーション欠落

**変更内容**:
- 123行目: 「全サブエージェントの完了を待ち、各返答サマリを収集する。」の後に以下を追加:

```
**返答バリデーション**: 各サブエージェントの返答が `dim: {次元名}, critical: {N}, improvement: {M}, info: {K}` のフォーマットに準拠しているか検証する。フォーマット不正時は件数を「?」として表示し、後続の findings ファイル読み込み時にファイル内容から件数を推定する。
```

### 6. SKILL.md（修正）
**対応フィードバック**: I-3: 参照整合性: プレースホルダ不一致

**変更内容**:
- 219-224行目: 「Task ツールで以下を実行する」の直前に以下を追加:

```
**パス変数の定義**:
- `{agent_path}`: エージェント定義ファイルの絶対パス（Phase 0 で取得）
- `{approved_findings_path}`: 承認済み findings の絶対パス（`.agent_audit/{agent_name}/audit-approved.md`）
```

### 7. SKILL.md（修正）
**対応フィードバック**: I-4: 承認粒度の問題: 一括承認パターン

**変更内容**:
- 163行目: 「続けて `AskUserQuestion` で承認方針を確認:」の前に以下を追加:

```
**一括承認の注意表示**: 「全て承認」を選択肢として表示する際、「（critical {N}件, improvement {M}件を確認せずに適用します）」という注意文言を併記する。
```

### 8. SKILL.md（修正）
**対応フィードバック**: I-5: グループ分類基準の参照指示の曖昧性

**変更内容**:
- 64行目: 「分類基準の詳細は `.claude/skills/agent_audit/group-classification.md` を参照。」→「分類基準の詳細は `group-classification.md` を参照。」

（C-1 の変更内容と統合）

### 9. SKILL.md（修正）
**対応フィードバック**: I-6: 並列分析時の部分成功の判定基準の曖昧さ

**変更内容**:
- 129行目: 「全て失敗した場合: 「Phase 1: 全次元の分析に失敗しました。」とエラー出力して終了する。」を以下に置換:

```
**部分成功の判定**: 以下の基準でエラー終了を判定する:
- 全次元が失敗した場合 → エラー出力して終了
- IC（指示明確性）次元が失敗した場合 → 「⚠ IC 次元の分析に失敗しました: {エラー概要}」と警告表示し、他次元の結果で継続
- グループ固有次元（CE, SA, DC, WC, OF）が全て失敗した場合 → エラー出力して終了

成功次元が1つでもあればPhase 2へ継続する。
```

### 10. SKILL.md（修正）
**対応フィードバック**: I-7: 条件分岐の完全性: per-item 承認の "Other" 分岐処理が曖昧

**変更内容**:
- 181行目: 「続けて `AskUserQuestion` で方針確認（選択肢は以下の4つ。ユーザーが "Other" で修正内容をテキスト入力した場合は「修正して承認」として扱い、改善計画に含める）:」を以下に置換:

```
続けて `AskUserQuestion` で方針確認（選択肢は以下の4つ）:
- **「承認」**: この指摘を改善計画に含める。次の指摘へ進む
- **「修正して承認」**: ユーザーが修正内容を入力する（"Other" 入力）。入力テキストを `{user_modification}` として記録し、finding の recommendation を置き換えて改善計画に含める。入力が空の場合は「スキップ」として扱う
- **「スキップ」**: この指摘を改善計画から除外する。次の指摘へ進む
- **「残りすべて承認」**: この指摘を含め、未確認の全指摘を承認としてループを終了する
- **「キャンセル」**: 全指摘の確認を中止し、Phase 3 へ直行する
```

そして、181-185行目の選択肢リストを削除し、上記で置換する。

### 11. SKILL.md（修正）
**対応フィードバック**: I-8: 冪等性: バックアップファイルの重複生成

**変更内容**:
- 217行目: 「**バックアップ作成**: 改善適用前に Bash で `cp {agent_path} {agent_path}.backup-$(date +%Y%m%d-%H%M%S)` を実行し、`{backup_path}` を記録する。」を以下に置換:

```
**バックアップ作成**:
1. Bash で `ls {agent_path}.backup-* 2>/dev/null | tail -1` を実行し、既存バックアップの有無を確認する
2. 既存バックアップが存在する場合: そのパスを `{backup_path}` として記録し、「既存のバックアップを使用: {backup_path}」とテキスト出力
3. 既存バックアップが存在しない場合: `cp {agent_path} {agent_path}.backup-$(date +%Y%m%d-%H%M%S)` を実行し、新規作成したパスを `{backup_path}` として記録
```

### 12. SKILL.md（修正）
**対応フィードバック**: I-9: 成果物の構造検証の欠落

**変更内容**:
- 228-235行目: 「#### 検証ステップ」全体を以下に置換:

```
#### 検証ステップ

改善適用完了後、以下の検証を実行する:

1. Read で `{agent_path}` を再読み込み
2. YAML frontmatter の存在確認（ファイル先頭が `---` で始まり、`description:` を含む）
3. 承認済み findings の適用確認:
   - 各承認済み finding について、推奨されたセクション・キーワードがファイル内に存在するか確認する
   - 削除推奨の場合: 該当箇所が削除されているか確認
   - 追加推奨の場合: 該当箇所が追加されているか確認
   - 修正推奨の場合: 変更前後の diff を確認（全体を比較する必要はなく、finding で指摘された箇所のみ確認）
4. 検証成功時: 「✓ 検証完了: エージェント定義の構造は正常で、{N}件の改善が適用されています」とテキスト出力
5. 検証失敗時: 「✗ 検証失敗: {失敗内容}。以下のコマンドでロールバックできます: `cp {backup_path} {agent_path}`」とテキスト出力し、Phase 3 でも警告を表示
```

## 新規作成ファイル

（新規作成ファイルなし）

## 削除推奨ファイル

（削除推奨ファイルなし）

## 実装順序

1. **SKILL.md の外部参照パス修正（C-1, I-5）**: 他の変更の前提となるパス不整合を最初に解決。group-classification.md, agents/, templates/ への参照が正しく機能する必要がある
2. **SKILL.md の Phase 1 改善（I-1, I-2, I-6）**: エラーハンドリングとバリデーションの強化。Phase 2 の動作に影響しない独立した変更
3. **SKILL.md の Phase 2 Step 2 改善（I-4, I-7）**: ユーザー承認フローの改善。Phase 2 Step 4 に依存しない変更
4. **SKILL.md の Phase 2 Step 4 改善（C-2, C-3, I-3, I-8）**: 改善適用処理の安全性強化。他の Phase 2 変更の後に実施
5. **SKILL.md の Phase 2 検証ステップ改善（I-9）**: 最終的な検証ロジックの強化。Phase 2 Step 4 の完了後に実施

依存関係の理由:
- C-1, I-5（パス修正）は全ワークフローの前提となるため最優先
- I-1, I-2, I-6 は Phase 1 内で完結し、他フェーズに影響しない
- I-4, I-7 は Phase 2 Step 2 のみに影響し、Step 4 に依存しない
- C-2, C-3, I-3, I-8 は Phase 2 Step 4 の改善で、相互に関連するため一括実施
- I-9 は検証ステップの改善で、Phase 2 Step 4 の変更内容を前提とする

## 注意事項

- 全ての変更は SKILL.md のみに集中しており、テンプレートファイル（apply-improvements.md）への変更は不要
- C-1（外部参照パス修正）により、Phase 0, Phase 1, Phase 2 Step 4 の全てでファイル参照が正常に機能するようになる
- C-3（改善適用前の確認）により、ユーザーが不可逆操作を実行する前に最終確認の機会が提供される
- I-8（バックアップ重複生成防止）により、同一セッション内での複数回実行時にバックアップファイルが増殖しない
- I-9（構造検証の強化）により、改善適用後に実際に findings が反映されたか確認できる
- 既存のワークフロー構造（Phase 0-3）は維持され、各 Phase の役割は変更されない
