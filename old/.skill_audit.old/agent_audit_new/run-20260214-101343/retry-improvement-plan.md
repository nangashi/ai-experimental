# 改善計画: agent_audit_new

## 変更対象ファイル
| # | ファイル | 変更種別 | 変更概要 | 対応フィードバック |
|---|---------|---------|---------|------------------|
| 1 | SKILL.md | 修正 | Phase 2 Step 3 キャンセル時の承認メタデータ初期化とPhase 3のフォールバック処理追加 | REG-1 |

## 各ファイルの変更詳細

### 1. /home/toyama-ryosuke/ghq/github.com/nangashi/ai-experimental/.claude/skills/agent_audit_new/SKILL.md（修正）
**対応フィードバック**: REG-1: Phase 2 Step 3 キャンセル時の承認メタデータ未定義

**変更内容**:
- **Phase 2 Step 3 の既存ファイルチェック（行203-204）**: キャンセル時に承認数=0、スキップ数=0、total=全finding件数のメタデータを明示的に定義してからPhase 3へ直行する処理を追加
  - 現在: `「キャンセル」選択時は Phase 3 へ直行する`
  - 改善後: `「キャンセル」選択時は、承認メタデータ（{approved}=0, {skip}=0, {total}={Step 1で取得した全件数}）を設定し、Phase 3 へ直行する`

- **Phase 3 完了サマリ（行264-304）**: 承認結果ファイル不在時のフォールバック表示ロジックを追加
  - 現在: 承認数などのメタデータを無条件で使用（未定義時の処理なし）
  - 改善後: Phase 2が実行されたが承認結果ファイルが存在しない場合（Step 3でキャンセルされた等）は、「承認: なし（改善適用キャンセル）」を表示し、変更詳細・バックアップ情報をスキップする

- **具体的な変更箇所**:
  1. 行203-204: キャンセル分岐に `承認メタデータ設定: {approved}=0, {skip}=0, {total}={Step 1の全件数}` を追記
  2. 行279-292: Phase 3の「Phase 2 が実行された場合」ブロックの冒頭に条件分岐を追加:
     - 承認結果ファイル（`.agent_audit/{agent_name}/audit-approved.md`）が存在する場合: 現在の表示（承認数・変更詳細・バックアップ等）
     - 承認結果ファイルが存在しない場合: `- 承認: なし（改善適用キャンセル）` のみ表示し、変更詳細・バックアップ行はスキップ

## 新規作成ファイル
（該当なし）

## 削除推奨ファイル
（該当なし）

## 実装順序
1. SKILL.md の Phase 2 Step 3 のキャンセル時メタデータ初期化処理を追加（行203-204周辺）— メタデータ変数の定義を保証
2. SKILL.md の Phase 3 完了サマリのフォールバック表示ロジックを追加（行279-292周辺）— メタデータ未定義時の表示を整合性のあるものに

依存関係の検出方法:
- ステップ1で設定したメタデータをステップ2が参照するため、ステップ1を先に実施

## 注意事項
- Phase 2 の各分岐（Step 2でキャンセル、Step 2aでキャンセル、Step 3でキャンセル）全てで承認メタデータが定義されることを確認する
- Phase 3 の条件分岐は既存の「Phase 2 がスキップされた場合」（行268-277）と「Phase 2 が実行された場合」（行279-292）の2分岐構造を維持し、後者の内部にさらに「承認結果ファイルあり/なし」の分岐を追加する形とする
- 既存の変数名（`{approved}`, `{skip}`, `{total}`）を維持してテンプレート構造への影響を最小化する
