# 改善計画: agent_audit_new

## 変更対象ファイル
| # | ファイル | 変更種別 | 変更概要 | 対応フィードバック |
|---|---------|---------|---------|------------------|
| 1 | SKILL.md | 修正 | Phase 2 Step 3 承認結果保存の冪等性確保、Phase 2 Step 4 サブエージェント失敗時エラーハンドリング追加、Phase 2 Step 4 検証ステップの拡張、Phase 2 Step 2 承認粒度の明確化 | I-1, I-2, I-3, I-4 |

## 各ファイルの変更詳細

### 1. /home/toyama-ryosuke/ghq/github.com/nangashi/ai-experimental/.claude/skills/agent_audit_new/SKILL.md（修正）

**対応フィードバック**:
- I-1: Phase 2 Step 3 承認結果保存の冪等性違反
- I-2: Phase 2 Step 4 サブエージェント失敗時の処理未定義
- I-3: Phase 2 Step 4 検証ステップの不完全性
- I-4: Phase 2 Step 2 承認粒度の不明確性

**変更内容**:

#### 変更1: Phase 2 Step 2（行162-174）- 承認粒度の明確化
- 現在の記述:
  ```
  対象 findings の一覧をテキスト出力する:
  ```
  の後に以下を挿入し、critical findings の件数を明示的に表示する

- 改善後の記述:
  ```
  対象 findings の一覧をテキスト出力する:
  ```
  続けて以下を追加:
  ```

  **severity 別内訳**:
  - 🔴 Critical（重大な問題）: {N}件 — 機能不全やデータ損失のリスクがある問題
  - 🟡 Improvement（改善提案）: {M}件 — 品質向上や効率化のための提案
  ```

#### 変更2: Phase 2 Step 3（行195-219）- 承認結果保存の冪等性確保
- 現在の記述（行195-197）:
  ```
  #### Step 3: 承認結果の保存

  承認された指摘（ユーザー修正内容を含む）を `.agent_audit/{agent_name}/audit-approved.md` に Write で保存する。
  ```

- 改善後の記述:
  ```
  #### Step 3: 承認結果の保存

  **既存ファイルチェック**: Bash で `test -f .agent_audit/{agent_name}/audit-approved.md && echo 'EXISTS' || echo 'NEW'` を実行する。
  - 出力が `EXISTS` の場合: AskUserQuestion で「前回の承認結果ファイルが存在します。上書きしますか？（上書きすると前回の承認結果は失われます）」と確認し、「上書き」選択時のみ保存に進む。「キャンセル」選択時は Phase 3 へ直行する
  - 出力が `NEW` の場合: そのまま保存に進む

  承認された指摘（ユーザー修正内容を含む）を `.agent_audit/{agent_name}/audit-approved.md` に Write で保存する。
  ```

#### 変更3: Phase 2 Step 4（行221-238）- サブエージェント失敗時エラーハンドリング追加
- 現在の記述（行231-238）:
  ```
  `Task` ツールで以下を実行する（`subagent_type: "general-purpose"`, `model: "sonnet"`）:

  `.claude/skills/agent_audit_new/templates/apply-improvements.md` を Read で読み込み、その内容に従って処理を実行してください。
  パス変数:
  - `{agent_path}`: {実際の agent_path の絶対パス}
  - `{approved_findings_path}`: {実際の .agent_audit/{agent_name}/audit-approved.md の絶対パス}

  サブエージェント完了後、返答内容（変更サマリ）をテキスト出力する。
  ```

- 改善後の記述:
  ```
  `Task` ツールで以下を実行する（`subagent_type: "general-purpose"`, `model: "sonnet"`）:

  `.claude/skills/agent_audit_new/templates/apply-improvements.md` を Read で読み込み、その内容に従って処理を実行してください。
  パス変数:
  - `{agent_path}`: {実際の agent_path の絶対パス}
  - `{approved_findings_path}`: {実際の .agent_audit/{agent_name}/audit-approved.md の絶対パス}

  **エラーハンドリング**: サブエージェント実行後、以下の判定を行う:
  - 返答内容に "modified:" が含まれ、`{agent_path}` の最終更新時刻がバックアップ作成後の場合 → 成功。返答内容（変更サマリ）をテキスト出力する
  - 上記以外の場合 → 失敗。「✗ 改善適用に失敗しました。ロールバックしています...」とテキスト出力し、Bash で `cp {backup_path} {agent_path}` を実行してロールバックする。ロールバック後、「ロールバック完了。エラー詳細: {Task返答内容}」とテキスト出力し、Phase 3 へ直行する
  ```

#### 変更4: Phase 2 検証ステップ（行240-248）- 検証ステップの拡張
- 現在の記述（行240-248）:
  ```
  #### 検証ステップ

  改善適用完了後、以下の検証を実行する:

  1. Read で `{agent_path}` を再読み込み
  2. YAML frontmatter の存在確認（ファイル先頭が `---` で始まり、`description:` を含む）
  3. 検証成功時: 「✓ 検証完了: エージェント定義の構造は正常です」とテキスト出力
  4. 検証失敗時: 「✗ 検証失敗: エージェント定義が破損している可能性があります。以下のコマンドでロールバックできます: `cp {backup_path} {agent_path}`」とテキスト出力し、Phase 3 でも警告を表示
  ```

- 改善後の記述:
  ```
  #### 検証ステップ

  改善適用完了後、以下の検証を実行する:

  1. Read で `{agent_path}` を再読み込み
  2. YAML frontmatter の存在確認（ファイル先頭が `---` で始まり、`description:` を含む）
  3. Read で `.agent_audit/{agent_name}/audit-approved.md` を再読み込み、承認された各 finding の変更対象セクションを特定する（finding の `recommendation` や `修正内容` から見出し・フィールド名等のキーワードを抽出）
  4. 抽出したキーワードが `{agent_path}` の内容に存在するかを簡易チェックする（Grep または文字列検索）。全キーワードの 80% 以上が存在すれば変更適用成功とみなす
  5. 検証成功時: 「✓ 検証完了: エージェント定義の構造は正常です（変更対象 {N}/{M} 件確認）」とテキスト出力
  6. 検証失敗時: 「✗ 検証失敗: エージェント定義が破損しているか、変更が一部未適用の可能性があります（変更対象 {N}/{M} 件確認）。以下のコマンドでロールバックできます: `cp {backup_path} {agent_path}`」とテキスト出力し、Phase 3 でも警告を表示
  ```

## 新規作成ファイル

なし

## 削除推奨ファイル

なし

## 実装順序

1. **変更1（Phase 2 Step 2 の承認粒度明確化）** - 他の変更と独立しており、最もリスクが低い。severity 別内訳の表示を追加するだけ
2. **変更2（Phase 2 Step 3 の冪等性確保）** - 変更3・4より前に実施すべき。承認結果ファイルの保存処理を変更することで、後続の改善適用・検証ステップの前提条件を確立する
3. **変更3（Phase 2 Step 4 のエラーハンドリング追加）** - 変更4（検証ステップ拡張）の前に実施すべき。エラーハンドリング追加により、検証ステップに到達する前の段階で失敗を検出できるようになる
4. **変更4（Phase 2 検証ステップの拡張）** - 最後に実施。変更3のエラーハンドリングが実装された後、最終的な検証精度を向上させる

依存関係の理由:
- 変更2 → 変更3: 承認結果ファイルの保存処理が確実に完了することを前提に、改善適用のエラーハンドリングが機能する
- 変更3 → 変更4: 改善適用の失敗を早期検出できるようになった後、検証ステップで詳細な変更内容チェックを行う方が効率的

## 注意事項

- **Phase 2 Step 3 の既存ファイルチェック**: Bash の `test -f` コマンドを使用して既存ファイル有無を確認するため、ファイルパスの絶対パス化が必要
- **Phase 2 Step 4 のエラーハンドリング**: サブエージェント返答内容の解析に依存するため、apply-improvements.md テンプレートが "modified:" を含む返答フォーマットを維持していることを確認すること
- **検証ステップの拡張**: 承認済み finding から変更対象セクションのキーワード抽出は、`recommendation` や `修正内容` フィールドの自然言語解析に依存する。抽出失敗時のフォールバック処理（frontmatter チェックのみで検証成功とみなす）を考慮すること
- **ワークフロー互換性**: 全変更は既存のワークフロー（Phase 0 → 1 → 2 → 3）の構造を変更せず、各ステップの前後に検証・エラーハンドリングを追加するのみ。Phase 1 の並列分析や Phase 3 の完了サマリには影響しない
