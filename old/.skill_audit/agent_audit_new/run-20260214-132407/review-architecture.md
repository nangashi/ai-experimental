### アーキテクチャレビュー結果

#### 重大な問題
なし

#### 改善提案
- [SKILL.md Line 96: グループ分類基準の外部参照]: [group-classification.md] グループ分類の判定ロジック（4特徴 → 3つ以上カウント → 4グループ判定）は SKILL.md 内で直接実行されるため、参照先ファイルの内容は実行時に必要。しかし、現在のロジックはメインコンテキストで直接判定するため、サブエージェントに委譲されておらず、親エージェントが group-classification.md を Read する記述がない。実際には Line 94 で「分類基準の詳細は `.claude/skills/agent_audit_new/group-classification.md` を参照」と書かれているが、SKILL.md には Read 手順がなく、暗黙的に LLM が参照することを期待している。明示的な Read 手順を追加するか、グループ分類基準を SKILL.md にインライン化すべき [impact: low] [effort: low]
- [Phase 1 Line 165: サブエージェント成否判定の複雑性]: [成否判定ロジックの簡素化] findings ファイルの存在確認 → Summary セクション抽出 → 抽出失敗時は Finding ID Prefix ブロック数カウントという3段階のフォールバックは、1つの判定ロジックとしてやや複雑。サブエージェントの返答形式（`dim: {次元名}, critical: {N}, improvement: {M}, info: {K}`）が明確に定義されているため、返答抽出失敗時は findings ファイルの存在のみで成否判定を行い、件数は「不明（findings ファイルから再集計）」とする方がシンプル [impact: low] [effort: low]
- [Phase 2 Step 1 Line 189: collect-findings テンプレートの役割]: [テンプレート必要性の再評価] collect-findings.md テンプレートは58行あるが、実行内容は「audit-*.md ファイルを Glob → Read → critical/improvement の finding を抽出 → ソート → findings-summary.md に保存」という単純な処理。返答形式も3行（`total:`, `critical:`, `improvement:`）のみ。この処理は SKILL.md 内でインライン指示として記述可能（7行以下で十分）。テンプレート外部化の閾値（7行超）を満たしていない [impact: low] [effort: medium]
- [Phase 2 Step 4 Line 263: バックアップ作成の冪等性]: [バックアップファイル名の重複チェック] バックアップファイル名は `{agent_path}.backup-$(date +%Y%m%d-%H%M%S)` だが、同一秒内で複数回実行した場合にファイルが上書きされるリスクがある。冪等性を保証するため、既存バックアップの存在確認を追加するか、`-n` オプションで上書き回避を指定すべき [impact: medium] [effort: low]
- [Phase 2 Step 4 Line 274: エラーハンドリングの再試行回数]: [再試行ロジックの明示] 改善適用失敗時のリトライは「1回のみ」と記載されているが、再試行時のエラーハンドリング（2回目も失敗した場合）の動作が未定義。2回目失敗時は「ロールバックして終了」または「強制的に検証ステップへ進む」のいずれかをユーザーに確認する旨を明記すべき [impact: low] [effort: low]
- [Phase 2 検証ステップ Line 286: frontmatter 検証の精度]: [検証基準の具体化] 検証ステップで「ファイル先頭が `---` で始まり、`description:` を含む」を確認しているが、これは Phase 0 の frontmatter チェックと同じ基準。改善適用後の検証では、編集によって破損した可能性のある構造（YAML 終了マーカー `---` の存在、必須フィールドの形式等）をより詳細に確認すべき [impact: medium] [effort: low]
- [ナレッジ蓄積の欠落]: [知見蓄積ファイルの導入] agent_audit_new は反復的な最適化ループを持たない（1回の分析で完了）ため、ナレッジ蓄積は不要。しかし、複数エージェントを分析する際に横断的なパターン（頻出する問題、効果的な改善パターン）を蓄積する仕組みがあれば分析精度が向上する可能性がある。ただし、現在の設計では「ファイルパス指定のみのインターフェース」で外部データ依存を排除しているため、ナレッジ蓄積の導入は設計方針の変更を伴う。費用対効果を考慮すると、現状では不要と判定する [impact: low] [effort: high]

#### パターン準拠サマリ
| パターン | 状態 | 備考 |
|---------|------|------|
| テンプレート外部化 | 部分的 | collect-findings.md（58行）は7行以下でインライン化可能。apply-improvements.md（38行）は適切に外部化されている |
| サブエージェント委譲 | 準拠 | 全サブエージェントで「Read template + follow instructions + path variables」パターンを使用。モデル指定も適切（Phase 1: sonnet for analysis, Phase 2 Step 1: haiku for file collection, Step 4: sonnet for improvement application） |
| ナレッジ蓄積 | 不要 | 反復ループなし。単一エージェント分析のため横断的知見蓄積は設計外 |
| エラー耐性 | 準拠 | Phase 1 の部分失敗時の続行、Phase 2 Step 4 のリトライ/ロールバック/強制続行が定義されている。過剰なエラーハンドリングはない |
| 成果物の構造検証 | 準拠 | 検証ステップで frontmatter の存在確認を実施（ただし、検証基準は Phase 0 と同レベルで、編集破損の詳細検出は未実装） |
| ファイルスコープ | 準拠 | 全ファイル参照は `.claude/skills/agent_audit_new/` 配下に限定。スキル外への参照なし |

#### 良い点
- [明確な責務分離]: 次元エージェントをグループ別（evaluator/producer/hybrid/unclassified）に分類し、各グループに応じた分析次元セットを適用する設計は、エージェント種別ごとの特性に応じた深い分析を可能にしている。次元エージェント定義ファイルも `agents/{group}/{dimension}.md` に整理されており、スコープ境界が明確
- [コンテキスト節約の徹底]: 親コンテキストにはサブエージェントの返答サマリ（件数のみ）を保持し、詳細は全てファイルに保存する設計。3ホップパターン（親がサブエージェント結果を中継）を回避し、Phase 2 Step 1 で findings 収集をファイル経由で行う構造はベストプラクティス
- [並列実行の最適化]: Phase 1 で3～5次元のサブエージェントを同一メッセージ内で並列起動し、部分失敗時も成功した次元の結果で継続する設計は、実行速度と耐障害性のバランスが優れている
