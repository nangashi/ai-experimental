# レビュー観点の共有アーキテクチャ

マルチエージェントワークフローで、レビュー観点を実装エージェントとレビューエージェント間でどう共有するかの設計判断基準。

## 特化エージェントと観点注入エージェントの性能差

セクション「3層パターン」と合わせて、共有方式の設計根拠となる。

### 知見

- **全体性能差は小さいが、致命的問題の検出で大差が出る**: 専門エージェント vs 汎用エージェントの全体性能差は約4%（QWK（Quadratic Weighted Kappa、評価者間一致度）0.7453 vs 0.7165）。しかし致命的な問題の検出では26.6pt差（73.3% vs 46.7%）。差の源泉はveto判定（1つの観点でも致命的なら不合格とする判定ロジック）や観点間の重み付け・相互作用ロジックにあり、観点リストの共有だけでは再現できない
- **中間品質の判断は汎用エージェントが上回る**: 微妙なトレードオフの総合判断は、全体を俯瞰するエージェントの方が上手い（54-61% vs 52-57%）。観点を分離すると各観点内では精度が上がるが、観点をまたぐ判断が弱くなる

### 判断基準

- 致命的問題の見逃しが許されない → 専門レビューエージェント（veto等の判定ロジック込み）
- 微妙なトレードオフの総合判断が重要 → 汎用エージェントに観点の方向性だけ示す

## 3層パターン

エージェント間で観点を共有する際の推奨アーキテクチャ。

### 知見

- **実装エージェントに全観点を渡すと逆効果**: 情報過多によるcompound degradation（エージェント出力が後続エージェントの入力となる連鎖で、弱いプロンプトのエラーが複合的に増幅される現象）が発生する。個別最適化→トポロジー最適化→ワークフロー再最適化の段階的アプローチが必要
- **Negative Constraint Prompting が有効**: 各エージェントに無関係な観点を明示的に無視させる手法。観点の追加ではなく除外を指示することで、注意バジェット（LLMが1回の推論で割り当てられる注意リソースの総量）の浪費を防ぐ（詳細→prompt-engineering-findings.md セクション1「確認項目の列挙と満足化バイアス」）
- **Shift-left（レビュー観点を実装フェーズに前倒しする手法）の本質は「観点の転送」ではなく「成功基準の事前定義」**: 実装エージェントに必要なのは「何を避けるべきか（行動指針）」であり「どう検出するか（検出ロジック）」ではない。同じ観点でもフェーズで必要な情報粒度が異なる

### 判断基準

3層に分けて管理する:

| 層 | 用途 | 含める情報 | 例 |
|---|---|---|---|
| 観点マスタ | Single Source of Truth | 観点の定義と意図 | 「SQLインジェクション: パラメータ化されていないクエリは脆弱性リスク」 |
| 実装ガイドライン | 設計・実装エージェント向け | 当該タスクに関連する観点のみ、行動指針に変換 | 「SQLインジェクション → パラメータ化クエリを使え」 |
| レビューPrompt | レビューエージェント向け | 観点＋検出ロジック＋重み付け＋veto判定 | 「SQL文字列連結を検出 → 重大度:致命的 → veto」 |

- 実装エージェントへは全観点ではなく、タスクに関連するサブセットを行動指針形式で渡す
- レビューエージェントは観点マスタの全体を参照しつつ、検出・判定の固有ロジックを持つ
