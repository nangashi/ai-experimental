# Round 3 Comparison Report: agents/security-design-reviewer

## 実行条件

- **ラウンド**: Round 3
- **テスト文書**: 地域医療機関統合患者向けリアルタイム医療予約システム (287 lines, 15問)
- **比較対象**: v001-baseline (current best) vs v003-auth-ratelimit vs v003-priority-queue
- **評価回数**: N=3 runs per variant

---

## スコア比較テーブル

| Prompt | Mean | SD | Run1 | Run2 | Run3 | vs Current Best |
|--------|------|----|----- |------|------|-----------------|
| **v001-baseline** (current) | **11.7** | 0.5 | 12.0 | 11.5 | 11.5 | - |
| **v003-auth-ratelimit** | **12.8** | 0.5 | 13.0 | 12.5 | 13.0 | **+1.1** |
| **v003-priority-queue** | **9.7** | 0.5 | 10.0 | 10.0 | 9.0 | **-2.0** |

---

## カテゴリ別検出改善/悪化マトリクス

### v003-auth-ratelimit vs v001-baseline

| Category | v001 (○/△/×) | v003-auth-ratelimit (○/△/×) | Change |
|----------|--------------|----------------------------|--------|
| 認証・認可設計 | 2/0/0 | 2/0/0 | - |
| 入力検証・攻撃防御 | 2/2/1 | 2/1/2 | **悪化** (P02 ○→×, P03 △→×, P15 ○→△平均) |
| データ保護 | 3/0/2 | 2/1/1 | **改善** (P07 ×→△平均) |
| 脅威モデリング(I,R,T) | 2/1/1 | 2/0/1 | **改善** (P10 △→○) |
| インフラ・依存関係・監査 | 1/2/0 | 2/1/0 | **改善** (P12 △→○, P13 △→△維持) |

**純粋検出スコア比較**: v001=11.7 → v003-auth-ratelimit=11.5 (-0.2), ボーナス差: v001=0 → v003-auth-ratelimit=+3.0

### v003-priority-queue vs v001-baseline

| Category | v001 (○/△/×) | v003-priority-queue (○/△/×) | Change |
|----------|--------------|----------------------------|--------|
| 認証・認可設計 | 2/0/0 | 2/0/0 | - |
| 入力検証・攻撃防御 | 2/2/1 | 0/3/2 | **大幅悪化** (P02 ○→×, P04 ○→△, P15 ○→△) |
| データ保護 | 3/0/2 | 2/0/2 | - |
| 脅威モデリング(I,R,T) | 2/1/1 | 2/0/1 | **改善** (P10 △→○) |
| インフラ・依存関係・監査 | 1/2/0 | 2/1/0 | **改善** (P12 △→○平均, P13 △→○平均) |

**純粋検出スコア**: v001=11.7 → v003-priority-queue=9.7 (-2.0), ボーナス差: v001=0 → v003-priority-queue=0

---

## 推奨判定と根拠

### 推奨プロンプト: **v003-auth-ratelimit**

### 判定根拠

- **平均スコア差**: v003-auth-ratelimit vs v001-baseline = +1.1pt (閾値1.0pt超過)
- **安定性**: SD=0.5 (高安定)
- **推奨判定基準適用**: 平均スコア差 > 1.0pt → スコアが高い方を推奨

### 収束判定: **継続推奨**

- Round 2の改善幅: -1.1pt (v002-auth-ratelimitとv002-priority-queueの両方が悪化)
- Round 3の改善幅: +1.1pt (v003-auth-ratelimitが改善)
- 連続2ラウンドの改善幅 < 0.5pt の条件を満たさないため、継続推奨

---

## 戦略別効果分析

### v003-auth-ratelimit の戦略と効果

**採用戦略**:
1. **認証・レート制限の優先順位引き上げ**: 「DoS耐性（レート制限）」を入力検証より前に配置し、認証エンドポイントの脅威を最優先でチェック
2. **ボーナス獲得型の包括的カバレッジ**: 正解キー外の問題（パスワードポリシー、セッション管理、暗号化強度等）を積極的に検出

**効果分析**:
- **純粋検出スコア**: 11.7 → 11.5 (-0.2pt)
  - **悪化**: 入力検証・攻撃防御カテゴリで2問完全未検出化（P02 CSRF, P03 CORS）
  - **改善**: インフラカテゴリでP12(シークレット管理)が部分検出→完全検出、P10(監査ログ)が部分検出→完全検出
- **ボーナス効果**: +3.0pt (全Run平均、6件のボーナス指摘)
  - セッション管理、パスワードポリシー、データ保持・削除ポリシー、暗号化強度等の包括的指摘
- **純粋検出の悪化要因**: 認証・レート制限への注意集中により、CSRF/CORS等の入力検証問題への注意が分散
- **ボーナス獲得の要因**: 「セキュリティのベストプラクティス全般を広範に確認する」という指示が有効に機能

**因果分析**: 認証エンドポイント特化により認証周辺の深い問題を検出できたが、CSRF/CORS等の広範な入力検証問題への注意が低下。ただしボーナス獲得により純粋検出の損失を補填し、総合スコアで改善を達成。

### v003-priority-queue の戦略と効果

**採用戦略**:
1. **重大度ベースの優先順位付け**: 深刻度が高い問題（重大）を最優先でチェック
2. **識別力高問題への集中**: history.mdの識別力高問題（P02, P03, P04, P10, P15）を重点的に強化

**効果分析**:
- **純粋検出スコア**: 11.7 → 9.7 (-2.0pt)
  - **悪化**: 入力検証・攻撃防御カテゴリで3問悪化（P02 ○→×, P04 ○→△, P15 ○→△）
  - **改善**: インフラカテゴリでP10(監査ログ)が部分検出→完全検出、P12が部分検出→完全検出平均
- **ボーナス効果**: 0pt (全Run)
  - 正解キー外の問題をほぼ検出せず

**因果分析**: 重大度優先により重大問題（P01, P06, P09, P11）は維持できたが、中〜軽微問題への注意が低下し、識別力高問題（P02, P04, P15）で悪化。「重大度優先」という明示的な指示が、中〜軽微問題のチェック深度を低下させた可能性が高い。ボーナス獲得も皆無で、カバレッジの狭さが露呈。

---

## 考察

### v003-auth-ratelimit の成功要因

1. **純粋検出の微減 vs ボーナス大幅増**: 純粋検出スコアは-0.2ptと微減したが、ボーナス+3.0ptにより総合スコア+1.1ptを達成
2. **包括的カバレッジの効果**: 認証・レート制限を優先しつつ、「セキュリティのベストプラクティス全般を広範に確認する」という指示により、正解キー外の問題を積極的に検出
3. **インフラカテゴリの改善**: P12(シークレット管理)とP10(監査ログ)が部分検出→完全検出に改善し、純粋検出の損失を一部相殺

### v003-priority-queue の失敗要因

1. **重大度優先の副作用**: 重大問題への集中により中〜軽微問題への注意が低下し、識別力高問題（P02, P04, P15）で悪化
2. **ボーナス獲得の皆無**: カバレッジの狭さから正解キー外の問題を全く検出できず、純粋検出の損失を補填する要素が欠如
3. **識別力高問題への集中の失敗**: history.mdの識別力高問題（P02, P03, P04, P10, P15）を重点強化する戦略だったが、P02/P04/P15で悪化し、戦略が裏目に出た

### 次回への示唆

1. **ボーナス獲得型アプローチの有効性確認**: v003-auth-ratelimitの成功により、純粋検出の微減を許容しつつボーナス獲得でカバーするアプローチの有効性が実証された
2. **入力検証・攻撃防御カテゴリの改善余地**: CSRF/CORS問題（P02, P03）は依然として未検出。v003-auth-ratelimitの構造をベースに、CSRF/CORS検出を強化する方向性が有望
3. **重大度優先の危険性**: 重大度ベースの優先順位付けは中〜軽微問題の検出率低下を招くため、採用すべきではない
4. **次回の戦略候補**:
   - v003-auth-ratelimitをベースに、「CSRF対策（state-changing APIへのCSRFトークン、SameSite Cookie）」と「CORS設定（許可オリジン明示、ワイルドカード禁止）」を具体的なチェック項目として追加
   - 「入力検証・攻撃防御」カテゴリ内で「レート制限 → CSRF/CORS → インジェクション対策」という3層構造を明示する
