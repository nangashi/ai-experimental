# セキュリティ設計レビュー結果

## 評価対象
リアルタイム医療予約システム設計書

## 重大な問題（Critical Issues）

### C1. API認可設計の欠落による患者データアクセス制御不備
**問題**: 患者API (`GET /api/patients/{id}`, `PUT /api/patients/{id}`, `GET /api/patients/{id}/records`) およびカルテAPI (`GET /api/records/{id}`, `PUT /api/records/{id}`) において、リソース所有権の検証設計が明示されていない。

**影響**: 認証済みユーザーが任意の患者IDやカルテIDを指定することで、他人の個人医療情報（氏名、生年月日、住所、電話番号、保険証番号、診断内容、処方薬、検査結果）にアクセス可能。医療情報は最高レベルの機密性を要求されるため、この脆弱性は重大なプライバシー侵害とコンプライアンス違反（個人情報保護法、医療情報システムの安全管理に関するガイドライン）を引き起こす。

**対策**:
- 患者API: JWTから取得したユーザーIDと、リクエストされた患者IDの紐付け検証を設計に追加（patients.user_idとの照合）
- 医療従事者によるアクセス: 診察予約の存在確認（該当医療機関の担当医のみアクセス可能）をビジネスロジックに組み込む
- カルテAPI: 患者本人アクセスは上記患者ID検証経由、医療従事者アクセスは診察記録のappointment_id経由で医療機関所属確認を実施
- 設計書5.3節に「リソースベース認可ポリシー」セクションを追加し、各エンドポイントの認可ロジックを明記

**該当箇所**: 5.1節 患者API、カルテAPI

---

### C2. CSRF保護の未設計
**問題**: 設計書には状態変更API（予約作成・更新・キャンセル、患者情報更新、診察記録作成・更新）に対するCSRF対策が記載されていない。JWTトークンをlocalStorageに保存する方式（5.3節）では、XSS脆弱性が存在する場合にトークンが漏洩し、攻撃者が被害者ブラウザから悪意のあるリクエストを送信可能。

**影響**: 攻撃者が偽の診察予約を大量作成、患者情報を改ざん、既存予約をキャンセルするなど、医療サービスの可用性と整合性を損なう攻撃が可能。特に医療予約の不正キャンセルは患者の健康に直接的影響を及ぼす可能性がある。

**対策**:
- CSRFトークン方式: サーバー側で生成したランダムトークンをセッションに保存し、各状態変更リクエストに含めて検証
- または SameSite Cookie属性: JWTをHttpOnly, Secure, SameSite=Strict属性付きCookieに保存し、localStorageの使用を廃止（XSS対策も兼ねる）
- 設計書5.3節に「CSRF保護方式」を追加し、採用する対策方式と実装詳細を明記
- API設計（5.1節）の各状態変更エンドポイントにCSRF保護要件を記載

**該当箇所**: 5.3節 認証・認可方式

---

### C3. 内部通信の暗号化設計欠落
**問題**: 7.2節では「すべての通信をTLS 1.3で暗号化」と記載されているが、これは外部クライアント-API Gateway間のみを指すと推測される。アーキテクチャ図（3.1節）に記載されるバックエンド-PostgreSQL間、Spring Boot-Redis間、API Gateway-ECSバックエンド間の通信経路における暗号化設計が明示されていない。

**影響**: AWS内部ネットワークであっても、VPC内の不正アクセスや中間者攻撃により、患者個人情報、診察記録、認証トークンがネットワーク盗聴される可能性がある。特にPostgreSQLとの通信では、全患者データが平文で送信される場合、単一の侵害ポイントから全データベース内容が漏洩する。

**対策**:
- PostgreSQL: SSL/TLS接続を必須化（`sslmode=require`またはそれ以上のレベル）、証明書検証を有効化
- Redis: TLS in-transit暗号化を有効化（Amazon ElastiCache for Redisの場合）
- API Gateway-ECS間: VPC内プライベート接続であっても、機密性の高い医療データを扱う場合はTLS通信を推奨
- 3.1節の全体構成図および3.3節データフローに、各通信セグメントの暗号化方式を明記
- 7.2節セキュリティ要件に「内部通信の暗号化」項目を追加

**該当箇所**: 3.1節 全体構成、7.2節 セキュリティ要件

---

## 重要な問題（Significant Issues）

### S1. 認証エンドポイントのレート制限未設計
**問題**: API Gatewayのレート制限（1分あたり100リクエスト、3.2節）は全エンドポイント共通と思われるが、認証エンドポイント（`/api/auth/login`, `/api/auth/register`, `/api/auth/refresh`）に対する個別のレート制限設計がない。

**影響**: ブルートフォース攻撃により、弱いパスワードを持つアカウントが短時間で侵害される可能性が高い。特に医療システムでは、侵害されたアカウントを通じて患者の機密医療情報が漏洩するリスクがある。また、パスワードリセット機能が未設計のため、攻撃者が総当たり攻撃を継続しやすい。

**対策**:
- ログインエンドポイント: IPアドレスごとに5分間で5回までの失敗を許容、超過時は15分間ロック
- ユーザー名ベースのレート制限: 同一ユーザー名への攻撃を検出し、アカウントロックまたはCAPTCHA要求
- 登録エンドポイント: IPごとに1時間あたり3回までの登録試行を許可
- トークンリフレッシュ: IPごとに1分間に10回までの制限
- 設計書3.2節API Gatewayの責務に「エンドポイント別レート制限」を追加
- 5.1節認証APIの各エンドポイントにレート制限仕様を記載

**該当箇所**: 3.2節 API Gateway、5.1節 認証API

---

### S2. 監査ログ設計の不足
**問題**: 6.2節のロギング方針は一般的なアプリケーションログを対象としているが、セキュリティ監査に必要な重要イベント（認証失敗、権限エラー、患者データアクセス、診察記録の作成・更新、管理者操作）の明示的なログ設計がない。

**影響**: セキュリティインシデント発生時に、誰がいつどの患者データにアクセスしたか、不正な操作が行われたかを追跡できず、事後調査と法的対応が困難になる。医療情報システムでは監査証跡の保持が法的要件となる場合が多い。

**対策**:
- セキュリティ監査ログ項目: ユーザーID、アクション種別、対象リソースID、タイムスタンプ、IPアドレス、結果（成功/失敗）、失敗理由
- 記録対象イベント:
  - 認証: ログイン成功/失敗、ログアウト、トークンリフレッシュ失敗
  - 認可: 権限不足によるアクセス拒否
  - データアクセス: 患者情報取得、診察記録取得（特に医療従事者による他患者データアクセス）
  - データ変更: 患者情報更新、診察記録作成・更新、予約作成・キャンセル
  - 管理操作: 医療機関の追加・削除、システム設定変更
- 監査ログは改ざん防止のため、アプリケーションログとは別の保管先（CloudWatch Logs専用ロググループ、改ざん検出機能付きストレージ）に記録
- 6.2節に「セキュリティ監査ログ」セクションを追加
- 7.2節セキュリティ要件に「監査証跡の保持期間（推奨: 最低1年間）」を記載

**該当箇所**: 6.2節 ロギング方針、7.2節 セキュリティ要件

---

### S3. CORS設定の未設計
**問題**: Webブラウザからのクロスオリジンリクエストに対するCORS（Cross-Origin Resource Sharing）ポリシーが設計書に記載されていない。

**影響**: CORS設定が不適切な場合、以下のリスクがある:
- ワイルドカード(`*`)を許可した場合、悪意のあるサイトから患者データにアクセス可能（認証情報付きリクエストと組み合わせた場合）
- 逆に、許可オリジンが未設定の場合、正規のフロントエンドアプリケーションが動作しない

**対策**:
- 許可するオリジンを明示的にホワイトリスト化（例: `https://patient-app.example.com`, `https://admin.example.com`）
- 認証情報（Cookieやトークン）を含むリクエストに対してはワイルドカードを使用しない
- 許可するHTTPメソッド、ヘッダーを最小限に制限
- プリフライトリクエスト（OPTIONS）のキャッシュ時間を適切に設定
- 3.2節API Gatewayの責務、または5.3節認証・認可方式に「CORS設定」を追加
- 開発環境と本番環境で異なる許可オリジンを設定する方針を6.4節デプロイメント方針に記載

**該当箇所**: 3.2節 API Gateway、5.3節 認証・認可方式

---

## 中程度の問題（Moderate Issues）

### M1. 秘密情報管理の部分的設計
**問題**: 6.4節では環境変数をAWS Systems Manager Parameter Storeから取得すると記載されているが、具体的にどの秘密情報（データベース接続文字列、JWTシークレットキー、外部API認証情報など）を管理するか、アクセス制御やローテーション方針が明示されていない。

**影響**: 秘密情報の管理が不十分な場合、コードやログへのハードコーディング、不適切な権限設定によるアクセス、長期間同じ秘密鍵の使用などにより、認証の突破やデータベース侵害のリスクが高まる。

**対策**:
- Parameter Storeまたは AWS Secrets Manager に格納する秘密情報を列挙: DB認証情報、JWT署名鍵、暗号化鍵、外部サービスAPIキー
- IAMロールによるアクセス制御: ECSタスクロールに必要最小限の秘密情報アクセス権限のみ付与
- 秘密情報のローテーション計画: JWT署名鍵は3ヶ月ごと、DBパスワードは6ヶ月ごとなど
- CI/CDパイプライン内で秘密情報を平文で扱わない設計（GitHub Secretsの使用）
- 6.4節デプロイメント方針に「秘密情報管理とローテーション」セクションを追加

**該当箇所**: 6.4節 デプロイメント方針

---

### M2. JWTトークンの無効化機構の欠如
**問題**: 5.3節の認証設計では、JWTトークンの発行と検証について記載されているが、ログアウト時やセキュリティ侵害時にトークンを無効化する仕組みが設計されていない。JWTはステートレスであるため、一度発行されたトークンは有効期限まで使用可能。

**影響**: ユーザーがログアウトしても、盗まれたトークンが有効期限（1時間）まで悪用される可能性がある。アカウント侵害を検知した場合でも即座にアクセスを遮断できず、被害が拡大する。

**対策**:
- トークンブラックリスト方式: Redisにログアウトしたトークンのjti（JWT ID）を保存し、有効期限まで検証時にチェック
- または短命トークン+リフレッシュトークン無効化: アクセストークンの有効期限を5分程度に短縮し、リフレッシュトークンをデータベースまたはRedisで管理して即座に無効化可能にする
- セキュリティインシデント対応: 管理者が特定ユーザーの全トークンを一括無効化できる仕組み
- 5.3節に「トークン無効化とセッション管理」セクションを追加

**該当箇所**: 5.3節 認証・認可方式

---

### M3. 依存ライブラリの脆弱性管理方針の欠如
**問題**: 2.4節で主要ライブラリを列挙しているが、これらの脆弱性スキャンやアップデート方針が設計書に含まれていない。

**影響**: 既知の脆弱性を持つライブラリが使用され続け、攻撃者に悪用される可能性がある。特にSpring SecurityやHibernateなどセキュリティクリティカルなライブラリの脆弱性は深刻な影響をもたらす。

**対策**:
- 脆弱性スキャンツールの導入: DependabotやSnyk、OWASP Dependency-Checkを用いた継続的スキャン
- CIパイプラインに脆弱性チェックを組み込み、高・中レベルの脆弱性検出時はビルド失敗させる
- 定期的な依存ライブラリアップデート計画（月次または四半期ごと）
- 6.4節または新規セクション「セキュリティ運用」に「脆弱性管理とパッチ適用方針」を追加

**該当箇所**: 2.4節 主要ライブラリ、6.4節 デプロイメント方針

---

### M4. 入力検証の具体性不足
**問題**: 7.2節で「外部入力はSpring Validationで検証」と記載されているが、どのフィールドにどのような検証ルールを適用するかの設計が不明確。

**影響**: 不十分な入力検証により、SQLインジェクション（PreparedStatement使用で一定の防御はあるが完全ではない）、XSS、コマンドインジェクション、データ整合性の問題が発生する可能性がある。

**対策**:
- 各APIエンドポイントの入力パラメータに対する検証ルールを定義:
  - username: 英数字のみ、3-50文字
  - email: RFC準拠のメールアドレス形式
  - password: 最低8文字、大文字・小文字・数字・記号を含む
  - phone_number: 数字とハイフンのみ、10-15文字
  - appointment_time: 未来日時のみ許可、営業時間内チェック
- ファイルアップロード（設計書には未記載だが将来追加の可能性）: ファイルタイプ検証（MIMEタイプとマジックバイト）、サイズ制限、ウイルススキャン
- 5.2節に「入力検証ルール」サブセクションを追加、または別表として整理
- 7.2節セキュリティ要件に「入力検証基準」を明記

**該当箇所**: 5.2節 リクエスト/レスポンス形式、7.2節 セキュリティ要件

---

## 軽微な改善点（Minor Improvements）

### I1. パスワードポリシーの明示
**問題**: 7.2節でbcryptハッシュ化は記載されているが、パスワードの強度要件（最小文字数、複雑性）が明示されていない。

**対策**: ユーザー登録時に強制するパスワードポリシー（最低8文字、大文字・小文字・数字・記号の組み合わせ）を5.1節認証APIまたは7.2節セキュリティ要件に追加。

**該当箇所**: 5.1節 認証API、7.2節 セキュリティ要件

---

### I2. エラーメッセージの情報漏洩リスク
**問題**: 6.1節で「エラーメッセージには詳細なスタックトレースを含め、デバッグを容易にする」とあるが、これは本番環境では内部実装の詳細を露出させる情報漏洩リスクがある。

**対策**: 開発環境ではスタックトレース含む詳細エラー、本番環境ではユーザーフレンドリーな一般的エラーメッセージのみ返却し、詳細はサーバーログに記録する方針に変更。6.1節に環境別のエラーハンドリング方針を追加。

**該当箇所**: 6.1節 エラーハンドリング方針

---

### I3. データベースバックアップの暗号化とアクセス制御
**問題**: 7.3節でバックアップの頻度と保持期間は記載されているが、バックアップデータの暗号化やアクセス制御について触れられていない。

**対策**: RDS自動バックアップの暗号化を有効化（AES-256）、バックアップへのアクセスはIAMロールで厳格に制御、必要に応じてバックアップデータの別リージョンへの複製を設計に追加。

**該当箇所**: 7.3節 可用性・スケーラビリティ

---

## 肯定的な評価点

1. **TLS 1.3の採用**: 最新の暗号化プロトコルを採用している（7.2節）
2. **bcryptハッシュ化**: パスワードを適切な強度のハッシュアルゴリズム（コスト係数10）で保護（7.2節）
3. **PreparedStatementの使用**: SQLインジェクション対策の基本を実装予定（7.2節）
4. **ロールベースアクセス制御の導入**: RBACによる認可モデルの採用（5.3節）
5. **Multi-AZ構成**: データベースの高可用性設計（7.3節）
6. **レート制限の導入**: API Gatewayでの基本的なレート制限（3.2節）

---

## 総合所見

本設計書は基本的なセキュリティ対策（TLS、パスワードハッシュ化、RBAC）を含んでいるが、医療情報システムとして必須となる**リソースレベルの認可設計**、**CSRF保護**、**内部通信の暗号化**が欠落しており、重大な脆弱性が存在する。

特に、患者データへのアクセス制御不備（C1）は直ちに設計に追加すべき最優先事項である。また、認証エンドポイントのレート制限（S1）、監査ログ（S2）、CORS設定（S3）についても、セキュアなシステム運用に不可欠な要素として設計段階で明確化する必要がある。

医療情報は個人情報保護法および医療情報システムの安全管理に関するガイドラインの対象となるため、上記の脆弱性を放置した場合、法的・規制上のリスクが極めて高い。設計レビューの段階で指摘された全ての重大・重要問題に対処することを強く推奨する。
