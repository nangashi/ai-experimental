# セキュリティ評価結果

## 評価対象
リアルタイム医療予約システム設計書

---

## 1. 重大な問題 (Critical Issues)

### C1. 認証エンドポイントのブルートフォース保護が未設計
**問題**
認証APIエンドポイント（`POST /api/auth/login`, `/api/auth/register`, `/api/auth/refresh`）に対するブルートフォース攻撃への具体的な防御メカニズムが設計されていません。API Gatewayのレート制限（1分あたり100リクエスト）は全体的な制限であり、認証エンドポイント特有の保護としては不十分です。

**影響**
攻撃者が短時間に大量のログイン試行を実行し、パスワードクラッキングや辞書攻撃により患者アカウント、医療従事者アカウント、管理者アカウントへの不正アクセスが成立する可能性があります。医療データへの不正アクセスは患者プライバシーの重大な侵害、診療記録の改ざん、システム全体の信頼性喪失につながります。

**対策**
以下の多層防御を設計に含めてください：
- **認証エンドポイント専用のレート制限**: ユーザーアカウントごと、IPアドレスごとに、1分あたり5回までのログイン試行制限を設定
- **アカウントロックアウトメカニズム**: 5回連続で認証失敗した場合、該当アカウントを15分間ロックする仕組み
- **プログレッシブディレイ**: 失敗回数に応じてレスポンス時間を段階的に遅延（1回目: 即座、2回目: 1秒、3回目: 2秒、4回目以降: 5秒）
- **CAPTCHA導入**: 3回以上の失敗後にCAPTCHAチャレンジを要求
- **認証失敗モニタリング・アラート**: 異常な失敗パターン（同一IPからの大量試行、同一アカウントへの集中攻撃）を検知し、セキュリティチームに通知

**参照箇所**
5.1 認証API、5.3 認証・認可方式、3.3 データフロー

---

### C2. JWTトークンのlocalStorage保存によるXSS脆弱性リスク
**問題**
設計書では「JWTトークンはlocalStorageに保存」と明記されていますが、これはXSS（Cross-Site Scripting）攻撃に対して極めて脆弱です。JavaScriptからアクセス可能なlocalStorageにトークンを格納すると、XSS脆弱性が存在する場合、攻撃者がトークンを窃取し、なりすましログインが可能になります。

**影響**
医療システムでは患者の個人情報（氏名、生年月日、住所、電話番号、保険情報）、診察記録（診断内容、処方薬、検査結果）といった極めて機密性の高いデータを扱います。XSSによるトークン窃取は、攻撃者が正規ユーザーとして医療データにアクセス・改ざんできることを意味し、患者プライバシーの重大な侵害、医療過誤のリスク、法的責任（個人情報保護法、医療法違反）を引き起こします。

**対策**
以下のいずれかの対策を採用してください：
- **HttpOnly Cookie方式（推奨）**: JWTをHttpOnly, Secure, SameSite=Strict属性付きCookieに格納。JavaScriptからのアクセスを不可能にし、XSS攻撃によるトークン窃取を防止
- **メモリ内保存 + リフレッシュトークンのHttpOnly Cookie**: アクセストークンはメモリ内（JavaScriptの変数）に保存し、ページリロード時にリフレッシュトークンから再取得。リフレッシュトークンのみHttpOnly Cookieに格納
- **併せて実装すべき対策**:
  - 厳格なContent Security Policy (CSP)の設定（`script-src 'self'`など）
  - すべての外部入力に対するサニタイゼーション・エスケープ処理の設計
  - React DOMのデフォルトエスケープ機能に依存せず、dangerouslySetInnerHTMLの使用禁止ポリシー

**参照箇所**
5.3 認証・認可方式、2.1 フロントエンド技術スタック

---

### C3. データ整合性検証メカニズムの欠如（改ざん対策）
**問題**
診察記録（MedicalRecord）、処方薬情報、検査結果といった医療データの改ざん検知・防止メカニズムが設計に含まれていません。データ保存時のチェックサム、デジタル署名、ハッシュ検証などの整合性検証手段が明記されておらず、不正な変更を検知できません。

**影響**
医療記録の改ざんは患者の生命・健康に直結する重大リスクです。具体的には：
- 処方薬情報の改ざんによる誤投薬、薬剤アレルギーの見落とし
- 診断内容の改ざんによる誤診療、医療過誤
- 検査結果の改ざんによる重大疾患の見落とし
- 法的証拠性の喪失（医療訴訟時に記録の信頼性が否定される）
- コンプライアンス違反（医療法、個人情報保護法）

**対策**
以下の多層的な改ざん防止・検知メカニズムを設計に追加してください：
- **デジタル署名**: 診察記録作成・更新時に担当医師の電子署名を付与。署名検証により改ざんを検知
- **ハッシュチェーン**: 各医療記録にSHA-256ハッシュ値を付与し、前レコードのハッシュを含めることでブロックチェーン的な改ざん検知を実現
- **監査ログとの突合**: 医療記録の変更履歴を別テーブル（`medical_record_audit`）に記録し、データ整合性チェックバッチで定期的に突合
- **読み取り専用レプリカでの検証**: プライマリDBと読み取り専用レプリカのデータを定期的に比較し、不一致を検知
- **改ざん検知時の対応手順**: アラート送信、該当レコードのロック、管理者への通知、監査ログへの記録

**参照箇所**
4.1 主要エンティティ（MedicalRecord）、5.1 カルテAPI、3.3 データフロー

---

### C4. 患者データ分類ポリシーと保持期間設計の欠如
**問題**
患者の個人情報（PII）、診察記録、保険情報など、異なる機密レベルのデータが混在していますが、データ分類ポリシー（どのデータがどの機密レベルか）、保持期間、自動削除ポリシーが明示されていません。医療法では診療記録の保存義務期間が定められており、適切な管理が法的に求められます。

**影響**
- **法的コンプライアンス違反**: 医療法では診療記録を5年間保存する義務があります。保持期間管理の欠如は法令違反につながります
- **不要なデータ保持によるプライバシーリスク**: 法定期間経過後も患者データを保持し続けることは、GDPRや個人情報保護法の「データ最小化原則」に違反し、データ漏洩時の被害拡大につながります
- **データガバナンスの欠如**: どのデータをいつまで保持し、誰がアクセスできるかが不明確なため、監査対応や患者の情報開示請求に対応できません

**対策**
以下のデータガバナンス設計を追加してください：
- **PII分類ポリシーの明文化**:
  - レベル1（最高機密）: 診断内容、処方薬、検査結果、保険証番号
  - レベル2（高機密）: 氏名、生年月日、住所、電話番号
  - レベル3（中機密）: 予約履歴、メールアドレス
  - 各レベルに応じたアクセス制御ポリシー（RBAC）を設計
- **保持期間ポリシー**:
  - 診察記録: 最終診療日から5年間（医療法準拠）
  - 予約履歴: 予約日から3年間
  - ログイン履歴: 180日間
- **自動削除メカニズム**: バッチ処理により保持期間経過データを自動削除（論理削除フラグ付与、30日間のグレースピリオド後に物理削除）
- **データライフサイクル管理**: 収集→保存→アーカイブ→削除の各フェーズにおけるアクセス制御、暗号化レベル、監査要件を設計

**参照箇所**
4.1 主要エンティティ（Patient, MedicalRecord）、7.2 セキュリティ要件

---

## 2. 重要な問題 (Significant Issues)

### S1. APIエンドポイント認可チェックの設計不足
**問題**
設計書では「ロールベースアクセス制御（RBAC）により、エンドポイントごとに必要なロールを定義」と記載されていますが、具体的な認可チェックロジックが不明確です。特に以下のエンドポイントで詳細な認可設計が欠如しています：
- `GET /api/patients/{id}`: 患者本人または担当医師のみがアクセス可能か？
- `GET /api/patients/{id}/records`: 他患者の診察履歴への不正アクセス防止は？
- `PUT /api/records/{id}`: 診察記録の更新権限は担当医師のみか？作成者以外の医師も更新可能か？
- `GET /api/appointments`: ユーザーは自分の予約のみ取得できるか、全予約を取得できてしまうか？

**影響**
認可チェックの不備により、患者Aが患者Bの個人情報や診察記録にアクセスできる、医師Xが担当外の患者記録を閲覧・改ざんできる、といった権限昇格攻撃が成立します。医療システムでは患者間のデータ隔離が絶対要件であり、この不備は重大なプライバシー侵害、医療倫理違反、法的責任を引き起こします。

**対策**
各APIエンドポイントに対して以下の認可チェックを設計に明記してください：
- **リソース所有権検証**: `GET /api/patients/{id}`, `PUT /api/patients/{id}` では、リクエストユーザーのIDとパスIDが一致するか、またはリクエストユーザーがDOCTORロールかつ該当患者の担当医師であることを検証
- **診察記録アクセス制御**: `GET /api/patients/{id}/records`, `GET /api/records/{id}` では、患者本人、担当医師、または同一医療機関のDOCTORロールのみアクセス許可
- **更新権限の厳格化**: `PUT /api/records/{id}` では、記録作成者（担当医師）のみ更新可能とし、他の医師は閲覧のみ
- **テナント分離（医療機関単位）**: 医療機関Aの医師が医療機関Bの患者データにアクセスできないよう、`institution_id`ベースのフィルタリングを全クエリに適用
- **管理者権限の範囲明確化**: ADMINロールは医療機関登録・システム設定のみ可能とし、患者データへの直接アクセスは禁止（監査ログ経由のみ）

**参照箇所**
5.1 API設計全体、5.3 認証・認可方式

---

### S2. セッション管理とトークン無効化メカニズムの欠如
**問題**
JWTベースの認証を採用していますが、以下のセッション管理上の重要な要素が設計されていません：
- ログアウト時のトークン無効化メカニズム（JWTは通常ステートレスであり、サーバー側でトークンを無効化できない）
- トークン漏洩時の緊急無効化手段
- パスワード変更時の既存トークンの自動無効化
- 同時ログインセッション数の制限

**影響**
ログアウト後もトークンが有効なままのため、トークンを窃取した攻撃者は有効期限（1時間）まで不正アクセスを継続できます。また、医療従事者のアカウントが侵害された場合、パスワード変更だけでは既存トークンを無効化できず、攻撃者がアクセスを継続する可能性があります。

**対策**
以下のトークン管理メカニズムを設計に追加してください：
- **トークンブラックリスト（Redis）**: ログアウト時、トークンのJTI（JWT ID）をRedisのブラックリストに追加し、有効期限まで保持。各APIリクエストでブラックリスト確認を実行
- **トークンファミリー管理**: リフレッシュトークンにファミリーIDを付与し、パスワード変更やセキュリティイベント発生時に同一ファミリーの全トークンを無効化
- **強制ログアウトAPI**: 管理者が特定ユーザーの全アクティブセッションを無効化できるエンドポイント `POST /api/admin/users/{id}/revoke-sessions`
- **同時セッション制限**: 医療従事者アカウントは最大3セッションまで、患者アカウントは5セッションまでとし、超過時は最も古いセッションを自動無効化
- **セッション監視**: 異常な同時ログイン（異なる地域からの同時アクセス）を検知し、アラート送信

**参照箇所**
5.1 認証API、5.3 認証・認可方式、2.2 Redis

---

### S3. SQLインジェクション対策の不十分な設計
**問題**
設計書では「SQLインジェクション対策としてPreparedStatementを使用」と記載されていますが、Spring Data JPAを使用する場合、カスタムクエリ（`@Query`アノテーション）やネイティブSQL、動的クエリ構築時にPreparedStatementが適切に使用されない可能性があります。具体的な実装ガイドラインが欠如しています。

**影響**
SQLインジェクション脆弱性が存在すると、攻撃者がデータベースに任意のクエリを実行でき、全患者データの漏洩、データベースの改ざん・削除、バックエンドサーバーへのコマンド実行（PostgreSQLの`COPY`コマンド等）が可能になります。医療システムでは壊滅的な被害につながります。

**対策**
以下の多層的なSQLインジェクション対策を設計に明記してください：
- **Spring Data JPAのクエリメソッドを優先**: 可能な限りメソッド名ベースのクエリ生成（`findByUsernameAndRole`等）を使用し、カスタムクエリを最小化
- **`@Query`使用時の徹底したパラメータバインディング**: `:paramName`または`?1`形式のプレースホルダーを必須とし、文字列連結によるクエリ構築を禁止
- **ネイティブSQLの使用制限**: `nativeQuery=true`の使用は原則禁止。やむを得ず使用する場合はコードレビュー必須とし、パラメータバインディングを強制
- **動的クエリのセーフガード**: CriteriaAPIまたはQueryDSLを使用し、文字列ベースのクエリ構築を排除
- **入力検証の強化**: Spring Validationで型、長さ、パターン（正規表現）を検証。特にソート条件、検索キーワードなどクエリに直接影響するパラメータを厳格に検証
- **データベース権限の最小化**: アプリケーションDBユーザーにDROP, ALTER権限を付与せず、SELECT, INSERT, UPDATE, DELETEのみ許可

**参照箇所**
7.2 セキュリティ要件、2.4 ORM（Spring Data JPA）

---

### S4. 監査ログの設計不備とセキュリティイベント検知の欠如
**問題**
設計書ではすべてのAPIリクエストをログ出力するとしていますが、セキュリティ監査に必要な特定イベント（認証失敗、権限エラー、機密データアクセス、データ変更）の明示的なログ設計がありません。また、ログ改ざん防止、リアルタイムアラート、長期保存ポリシーが不明確です。

**影響**
セキュリティインシデント発生時に攻撃経路の追跡が困難になり、被害範囲の特定や法的証拠の確保ができません。また、攻撃のリアルタイム検知ができないため、被害が拡大します。医療システムでは患者データ漏洩時の影響範囲特定が法的義務であり、監査ログの不備はコンプライアンス違反です。

**対策**
以下のセキュリティ監査ログ設計を追加してください：
- **セキュリティイベントの明示的ログ記録**:
  - 認証失敗（ユーザー名、IP、タイムスタンプ、失敗理由）
  - 権限エラー（ユーザーID、アクセス試行エンドポイント、リソースID）
  - 機密データアクセス（患者ID、診察記録ID、アクセスユーザー、操作種別）
  - データ変更（変更前後の値、変更者、タイムスタンプ）
  - 管理者操作（ユーザー追加・削除、権限変更、設定変更）
- **ログ改ざん防止**: ログをCloudWatch Logsに即座に転送し、アプリケーションサーバーからの削除・変更を不可能にする。ログエントリにHMACを付与し改ざん検知を実現
- **リアルタイムアラート**: CloudWatch Logs Insightsで異常パターン（5分間に10回以上の認証失敗、深夜の管理者操作）を検知し、SNS経由でセキュリティチームに通知
- **ログ保存期間**: セキュリティログは最低1年間保存（コンプライアンス要件）、一般ログは90日間
- **ログアクセス制御**: セキュリティログへのアクセスはADMINロールのみ許可し、アクセス自体もログ記録

**参照箇所**
6.2 ロギング方針、5.1 API設計全体

---

## 3. 中程度の問題 (Moderate Issues)

### M1. CORS設定とCSRF保護の設計詳細不足
**問題**
設計書では「CORS/origin制御」「CSRF保護」が評価項目として挙げられていますが、具体的な設定内容（許可するオリジン、HTTPメソッド、CSRF トークンの実装方式）が明記されていません。

**影響**
過度に緩いCORS設定（`Access-Control-Allow-Origin: *`）により、悪意のあるサイトからのクロスオリジンリクエストを許可してしまい、患者データへの不正アクセスが可能になります。CSRF保護の不備により、攻撃者が患者に悪意のあるリンクをクリックさせることで、予約変更や個人情報更新を実行できます。

**対策**
- **CORS設定の厳格化**: 許可するオリジンを明示的にホワイトリスト化（例: `https://app.example.com`, `https://mobile.example.com`）。開発環境でも`*`を使用せず、具体的なローカルホストURLを指定
- **CSRF保護の実装**: Spring SecurityのCSRF保護を有効化し、Double Submit Cookie方式またはSynchronizer Tokenパターンを採用。CookieベースのJWT認証の場合はCSRF対策必須
- **Preflight リクエストの適切な処理**: OPTIONSメソッドに対するレスポンスで、許可するメソッド（GET, POST, PUT, DELETE）、ヘッダー（Authorization, Content-Type）を明示

**参照箇所**
7.2 セキュリティ要件、5.3 認証・認可方式

---

### M2. 機密データのログ出力によるデータ漏洩リスク
**問題**
ロギング方針では「すべてのAPIリクエスト・レスポンスをINFOレベルでログ出力」し、「requestBodyをログに含める」としていますが、患者の個人情報（氏名、生年月日、保険証番号）やパスワードがログに記録される危険があります。

**影響**
ログファイルから患者データが漏洩し、プライバシー侵害、法的責任（個人情報保護法違反）が発生します。ログは開発者、運用担当者、監視ツールなど多数のアクターがアクセスするため、データ漏洩リスクが高まります。

**対策**
- **機密フィールドのマスキング**: パスワード、トークン、保険証番号、クレジットカード情報など機密データをログ出力前にマスク（`***MASKED***`）
- **構造化ログでのフィールド制御**: JSON形式のログ出力時、機密フィールドをホワイトリスト方式で除外
- **ログレベルの適切な設定**: 本番環境ではリクエストボディのログ出力をWARNレベル以上に制限し、デバッグ目的のINFOログは開発環境のみ有効化
- **ログアクセス制御の強化**: CloudWatch Logsへのアクセス権限を最小限のIAMロールに制限

**参照箇所**
6.2 ロギング方針、5.1 API設計全体

---

### M3. 外部依存ライブラリの脆弱性管理ポリシー不足
**問題**
設計書では「vulnerability management policies for third-party libraries」が評価項目として挙げられていますが、具体的な脆弱性スキャンツール、更新ポリシー、緊急対応手順が明記されていません。

**影響**
Spring BootやReactなど依存ライブラリに脆弱性（例: Log4Shell, Spring4Shell）が発見された場合、迅速にパッチ適用できず、攻撃者に脆弱性を悪用される可能性があります。医療システムでは、脆弱性悪用による患者データ漏洩や診療業務停止が重大な社会的影響を持ちます。

**対策**
- **自動脆弱性スキャン**: GitHub DependabotまたはSnykをCIパイプラインに統合し、依存ライブラリの脆弱性を毎日スキャン
- **脆弱性重要度別の対応SLA**: Critical（24時間以内にパッチ適用）、High（1週間以内）、Medium（1ヶ月以内）
- **緊急パッチ適用プロセス**: Critical脆弱性発見時の緊急リリース手順（テスト短縮、承認プロセス簡略化）を事前に定義
- **ライブラリ更新ポリシー**: 四半期ごとにメジャーバージョンアップを評価、マイナーバージョンは月次で適用
- **SBOM（Software Bill of Materials）の管理**: 使用ライブラリのバージョンリストをリポジトリに記録し、脆弱性トレーサビリティを確保

**参照箇所**
2.4 主要ライブラリ、6.4 デプロイメント方針

---

### M4. シークレット管理とデプロイ時の漏洩防止策不足
**問題**
設計書では「環境変数はECS Task Definitionに記載し、AWS Systems Manager Parameter Storeから取得」としていますが、以下の点が不明確です：
- データベース接続パスワード、JWT署名鍵などのシークレット管理方法
- Git リポジトリへのシークレット誤コミット防止策
- ローカル開発環境でのシークレット管理
- シークレットローテーションポリシー

**影響**
シークレットがGitリポジトリにコミットされ、GitHubなどのコードホスティングサービスで公開されると、攻撃者がデータベースに直接アクセスできます。また、シークレットローテーションがないと、漏洩発生時の被害範囲が拡大します。

**対策**
- **AWS Secrets Managerの使用**: Parameter Storeではなく、暗号化と自動ローテーション機能を持つSecrets Managerを採用
- **シークレットローテーション**: データベースパスワード30日ごと、JWT署名鍵90日ごとに自動ローテーション
- **Git シークレットスキャン**: pre-commitフックでgit-secretsまたはtruffleHogを実行し、シークレットのコミットを防止
- **ローカル開発環境**: `.env.example`ファイルでテンプレートを提供し、実際の`.env`ファイルは`.gitignore`に追加
- **最小権限の原則**: ECSタスクロールにParameter Store/Secrets Managerへの読み取り権限のみ付与し、書き込み権限は除外

**参照箇所**
6.4 デプロイメント方針、2.3 インフラ

---

### M5. TLS設定の具体的な暗号スイート設計不足
**問題**
設計書では「すべての通信をTLS 1.3で暗号化」としていますが、具体的な暗号スイート、証明書管理ポリシー、TLS 1.2以下の無効化設定が明記されていません。

**影響**
弱い暗号スイート（RC4, DESなど）が有効なままの場合、中間者攻撃により通信内容が復号される可能性があります。TLS 1.0/1.1が有効な場合、ダウングレード攻撃のリスクがあります。

**対策**
- **TLS 1.3のみ許可**: TLS 1.2以下を無効化し、AWS API GatewayおよびALBの設定で`TLS_1_3`を強制
- **推奨暗号スイート**: `TLS_AES_128_GCM_SHA256`, `TLS_AES_256_GCM_SHA384`, `TLS_CHACHA20_POLY1305_SHA256`のみ許可
- **証明書管理**: AWS Certificate Manager（ACM）で証明書を自動更新。有効期限90日前にアラート送信
- **HSTS（HTTP Strict Transport Security）**: `Strict-Transport-Security: max-age=31536000; includeSubDomains; preload`ヘッダーを設定し、HTTP接続を完全に禁止

**参照箇所**
7.2 セキュリティ要件、2.3 API Gateway

---

## 4. 軽微な改善提案 (Minor Improvements)

### MI1. エラーメッセージでの詳細スタックトレース出力の削除
**問題**
エラーハンドリング方針で「エラーメッセージには詳細なスタックトレースを含め、デバッグを容易にする」としていますが、本番環境でスタックトレースをクライアントに返すことは、システムの内部構造（フレームワーク、ライブラリバージョン、ファイルパス）を攻撃者に漏洩させます。

**対策**
本番環境ではスタックトレースを除外し、エラーIDのみ返却。詳細はサーバー側ログに記録し、サポートチームがエラーIDで追跡可能にする。開発環境のみスタックトレースを含める。

**参照箇所**
6.1 エラーハンドリング方針

---

### MI2. パスワードポリシーの明文化
**問題**
パスワードのハッシュ化方式（bcrypt, コスト係数10）は記載されていますが、パスワード強度要件（最小文字数、複雑性要件）、パスワード変更ポリシーが不明確です。

**対策**
以下のパスワードポリシーを設計に追加：
- 最小12文字、大文字・小文字・数字・記号を各1文字以上含む
- 過去5回のパスワードの再利用禁止
- 90日ごとのパスワード変更推奨（医療従事者は強制）
- パスワードリセット時の本人確認強化（メール+SMS二要素認証）

**参照箇所**
7.2 セキュリティ要件、5.1 認証API

---

### MI3. リアルタイム通知のセキュリティ考慮
**問題**
通知サービス（メール・プッシュ通知）のセキュリティ設計（通知内容の暗号化、送信先の検証）が不明確です。

**対策**
- プッシュ通知には機密情報（診断内容、処方薬名）を含めず、「新しいメッセージがあります」などの汎用メッセージのみ送信
- メール送信時はTLS必須、DKIM/SPF/DMARCで送信元認証を強化
- 通知送信前に送信先（メールアドレス、デバイストークン）が最新のユーザー情報と一致するか検証

**参照箇所**
3.2 通知サービス、3.3 データフロー

---

## 5. 肯定的な評価 (Positive Aspects)

### P1. パスワードハッシュ化の適切な選択
bcryptアルゴリズム（コスト係数10）の採用は、ブルートフォース攻撃に対する適切な防御策です。現代の推奨アルゴリズムの一つであり、評価できます。

### P2. HTTPS通信の徹底
すべての通信をTLS暗号化するとしている点は、基本的なセキュリティ要件として適切です。

### P3. PreparedStatementの採用意識
SQLインジェクション対策としてPreparedStatementの使用を明記している点は、脆弱性対策の意識として評価できます（ただし実装ガイドラインの詳細化が必要）。

---

## 総括

本設計書は医療システムとして基本的なセキュリティ要素（暗号化、認証、ロール管理）を含んでいますが、**認証エンドポイントのブルートフォース保護、トークンストレージ方式、データ改ざん検知、データ分類ポリシー、API認可チェックの詳細設計**といった重大な欠陥が存在します。

特に、患者の生命・健康に直結する医療データを扱うシステムとして、**データ整合性検証（改ざん防止）、詳細な認可チェック、監査ログ、データガバナンス**は最優先で設計に組み込むべきです。

上記の対策を実装することで、患者プライバシーの保護、医療過誤の防止、法的コンプライアンスの確保が可能になります。
