# セキュリティ設計評価レポート: リアルタイム医療予約システム

## 評価サマリ

本設計書は医療情報という極めて機密性の高いデータを扱うシステムであり、データ漏洩や不正アクセスが患者の生命・健康に直結するリスクがあります。評価の結果、**複数の重大なセキュリティ欠陥**が発見されました。特に、医療記録へのアクセス制御の欠如、診療科を超えたデータアクセスの未対策、および本番環境でのスタックトレース露出は、直ちに是正すべき深刻な問題です。

---

## 1. 重大な問題（Critical Issues）

### C1. 医療記録アクセスの認可設計が完全に欠落

**問題の詳細:**
カルテAPI（`GET /api/records/{id}`, `POST /api/records`, `PUT /api/records/{id}`）において、医療記録へのアクセス権限チェックの設計が一切記載されていません。現状の設計では、ログイン済みユーザーであれば、任意の患者IDの診察記録にアクセスできてしまう可能性があります。

**影響分析:**
- 患者Aの診察記録を、無関係な患者Bや医師Cが閲覧・改ざん可能
- 医療情報の機密性が完全に失われ、個人情報保護法・医療法違反のリスク
- 訴訟リスク、行政処分、信用失墜による事業継続の危機

**対策:**
1. カルテAPIに以下の認可ロジックを明示的に設計:
   - 患者は自分自身のカルテのみ閲覧可能
   - 医師は担当患者かつ診療科が一致する場合のみアクセス可能
   - 管理者は監査目的で限定的にアクセス可能（すべてのアクセスをログ記録）
2. Spring Securityの`@PreAuthorize`アノテーションまたはカスタム認可フィルタで実装
3. データベースクエリレベルでも患者ID・医療機関IDによるフィルタリングを必須化（多層防御）

**該当箇所:**
- 5.1 エンドポイント一覧 - カルテAPI
- 5.3 認証・認可方式（ロールベースのみで、リソースレベルの認可が未設計）

---

### C2. 診療科・医療機関を超えた横断アクセスの未対策

**問題の詳細:**
設計書には、医療従事者が所属医療機関や担当診療科の範囲を超えてデータにアクセスできないようにする仕組みが記載されていません。例えば、A病院の医師がB病院の患者データや予約情報にアクセスできてしまう可能性があります。

**影響分析:**
- 医療機関間のデータ分離が実現できず、テナント分離違反
- 競合医療機関への情報漏洩リスク
- 医師が担当外の患者の機密情報（精神科・性病科など）にアクセス可能

**対策:**
1. データモデルに医療従事者と医療機関の関連を追加（`doctors` テーブルに `institution_id` を追加）
2. すべての患者情報・予約・カルテAPIに、以下の認可ルールを設計:
   - 医師は `institution_id` が一致する患者のみアクセス可能
   - 診療科横断アクセスが必要な場合は、明示的な権限設計（例: 総合診療科の医師）
3. APIレイヤーとデータアクセスレイヤーの両方で検証を実装

**該当箇所:**
- 4.1 主要エンティティと関連（医療従事者エンティティが未定義）
- 5.1 患者API、カルテAPI

---

### C3. 本番環境でのスタックトレース露出

**問題の詳細:**
6.1 エラーハンドリング方針に「エラーメッセージには詳細なスタックトレースを含め、デバッグを容易にする」と記載されています。この設計では、本番環境で内部実装の詳細（使用ライブラリ、ファイルパス、SQL文など）が攻撃者に露出します。

**影響分析:**
- 攻撃者がスタックトレースから既知の脆弱性を持つライブラリバージョンを特定
- SQL文の露出により、SQLインジェクション攻撃の糸口を提供
- 内部ディレクトリ構造の露出により、他の攻撃ベクトルの発見が容易化

**対策:**
1. 本番環境では汎用的なエラーメッセージのみをクライアントに返す
   ```json
   {
     "error": "Internal Server Error",
     "message": "An unexpected error occurred. Please contact support.",
     "timestamp": "2025-01-15T10:30:00Z",
     "trackingId": "uuid-xxx-yyy"
   }
   ```
2. 詳細なスタックトレースはサーバー側のログにのみ記録
3. 環境変数で本番/開発を切り替え、開発環境でのみ詳細エラーを返す設計

**該当箇所:**
- 6.1 エラーハンドリング方針

---

### C4. JWTトークンのlocalStorage保存

**問題の詳細:**
5.3 認証・認可方式に「JWTトークンはlocalStorageに保存し」と記載されていますが、localStorageはJavaScriptから自由にアクセス可能であり、XSS攻撃によるトークン窃取のリスクがあります。

**影響分析:**
- XSS脆弱性（例: サードパーティライブラリの脆弱性、入力検証の不備）が存在した場合、攻撃者がトークンを窃取し、なりすまし攻撃を実行
- 医療記録への不正アクセス、予約の改ざん、個人情報の大量流出

**対策:**
1. JWTトークンは `HttpOnly`, `Secure`, `SameSite=Strict` 属性を持つCookieに保存
2. CSRF対策としてDouble Submit Cookieパターンまたはカスタムヘッダーによる検証を併用
3. XSS対策として、以下を設計に明記:
   - Content Security Policy (CSP) の導入
   - すべてのユーザー入力のサニタイゼーション
   - DOMベースXSS対策（React のデフォルトエスケープに依存せず、`dangerouslySetInnerHTML` の禁止など）

**該当箇所:**
- 5.3 認証・認可方式

---

## 2. 重要な問題（Significant Issues）

### S1. API Gatewayのレート制限が不十分

**問題の詳細:**
3.2 に「レート制限（1分あたり100リクエスト）」と記載されていますが、この制限が全ユーザー共通なのか、ユーザーごとなのかが不明です。また、医療予約システムとしてこの値が適切かの検証が欠けています。

**影響分析:**
- DoS攻撃により、正規ユーザーが予約できなくなるリスク
- 全ユーザー共通の制限の場合、単一攻撃者が全帯域を消費可能
- ブルートフォース攻撃（ログインAPI、パスワードリセットAPI）への対策が不十分

**対策:**
1. レート制限の粒度を明確化:
   - 認証API: ユーザーIDごとに5回/分、IPアドレスごとに20回/分
   - 予約API: ユーザーごとに10回/分
   - 読み取りAPI: ユーザーごとに100回/分
2. 429 (Too Many Requests) レスポンスに `Retry-After` ヘッダーを含める
3. ログインAPIには追加で、3回連続失敗後にアカウントロックまたはCAPTCHA要求を設計

**該当箇所:**
- 3.2 主要コンポーネントの責務と依存関係 - API Gateway

---

### S2. セッションタイムアウトと不正トークン無効化の設計欠如

**問題の詳細:**
JWTの有効期限は記載されていますが、ログアウト時のトークン無効化、強制ログアウト（パスワード変更時、不正アクセス検知時）の仕組みが設計されていません。

**影響分析:**
- ログアウト後もトークンが1時間有効なため、盗まれたトークンの悪用を防げない
- パスワード変更後も古いトークンでアクセス可能
- 医療従事者の退職時に即座にアクセスを遮断できない

**対策:**
1. ログアウト時にトークンをブラックリストに追加（Redisに保存、有効期限を設定）
2. パスワード変更・権限変更時に、発行済みトークンをすべて無効化する設計
3. JWTに発行バージョン（`jti`）を含め、バージョン不一致時に拒否
4. 短命アクセストークン（15分）+ 長命リフレッシュトークン（30日）の組み合わせに変更し、リスクを低減

**該当箇所:**
- 5.1 認証API（ログアウトAPIの実装詳細が未記載）
- 5.3 認証・認可方式

---

### S3. 監査ログの設計が不十分

**問題の詳細:**
6.2 ロギング方針には一般的なアクセスログの記録が記載されていますが、セキュリティ監査に必要な以下のイベントが明示されていません:
- 認証失敗（ユーザー名、IPアドレス、タイムスタンプ）
- 権限変更（誰が、誰の、どの権限を変更したか）
- 機密データアクセス（医療記録の閲覧・更新、患者情報のエクスポート）

**影響分析:**
- セキュリティインシデント発生時に、攻撃経路や影響範囲の特定が困難
- 内部不正の検知・証拠保全ができない
- 医療法・個人情報保護法で求められる監査証跡の不足

**対策:**
1. セキュリティ監査ログの明示的な設計:
   - 認証失敗: ユーザー名、IPアドレス、ユーザーエージェント、失敗理由
   - 機密データアクセス: ユーザーID、患者ID、アクセスされたレコードID、操作種別（READ/UPDATE/DELETE）
   - 権限変更: 実行者ID、対象ユーザーID、変更前後のロール、変更理由
2. 監査ログは改ざん防止のため、別ストレージ（S3 + Object Lock）に書き込み専用で保存
3. ログ保持期間を最低3年間に設定（医療法に基づく）

**該当箇所:**
- 6.2 ロギング方針
- 5 インフラ、依存関係 & 監査（評価基準）

---

### S4. データ暗号化の設計が不完全

**問題の詳細:**
7.2 セキュリティ要件に「すべての通信をTLS 1.3で暗号化する」と記載されていますが、保存データ（Data at Rest）の暗号化設計が不十分です。特に、データベースやS3に保存される以下のデータの暗号化方針が未記載です:
- 患者の個人情報（氏名、住所、電話番号）
- 保険証番号
- 診察記録（診断内容、処方薬、検査結果）

**影響分析:**
- データベースバックアップの漏洩時に、患者情報が平文で露出
- S3バケットの誤公開時に、アップロードされた医療画像やドキュメントが流出
- ディスク廃棄時のデータ復元リスク

**対策:**
1. データベース暗号化:
   - PostgreSQL の Transparent Data Encryption (TDE) または AWS RDS暗号化を有効化
   - 特に機密性の高いカラム（保険証番号、診断内容）はアプリケーションレベルで個別暗号化（AES-256-GCM）
   - 暗号化キーはAWS KMSで管理し、定期的なローテーションを設計
2. S3暗号化:
   - デフォルト暗号化を有効化（SSE-KMS）
   - バケットポリシーで暗号化されていないオブジェクトのアップロードを拒否
3. データ分類に基づく暗号化ポリシーの策定（例: PII Level 1は必須暗号化、Level 2は推奨）

**該当箇所:**
- 7.2 セキュリティ要件
- 3 データ保護（評価基準）

---

### S5. シークレット管理の具体的設計が欠落

**問題の詳細:**
6.4 デプロイメント方針に「環境変数はECS Task Definitionに記載し、AWS Systems Manager Parameter Storeから取得」と記載されていますが、以下の重要な設計が欠けています:
- JWTの署名鍵の管理方法
- データベース接続パスワードのローテーション設計
- サードパーティAPI（メール送信、プッシュ通知）の認証情報管理
- シークレットへのアクセス権限制御

**影響分析:**
- JWTの署名鍵が漏洩すると、攻撃者が任意のトークンを発行可能
- データベースパスワードが長期間固定され、漏洩時の影響範囲が拡大
- Parameter Storeへの過度なアクセス権限により、開発者が本番環境のシークレットを閲覧可能

**対策:**
1. シークレット管理の階層化設計:
   - JWTの署名鍵: AWS Secrets Managerに保存し、90日ごとに自動ローテーション
   - データベースパスワード: RDS認証情報の自動ローテーション機能を有効化
   - サードパーティAPIキー: Secrets Managerに保存し、タグベースのアクセス制御
2. IAMロールによる最小権限の原則:
   - ECSタスクロールには、必要なシークレットのみへの読み取り権限を付与
   - 開発環境と本番環境でAWSアカウントを分離
3. シークレット漏洩検知:
   - GitHub ActionsにSecretScannerを統合し、コミット前にチェック
   - AWS Macieで定期的にS3をスキャン

**該当箇所:**
- 6.4 デプロイメント方針
- 5 インフラ、依存関係 & 監査（評価基準）

---

## 3. 中程度の問題（Moderate Issues）

### M1. 予約変更・キャンセルAPIの認可設計が不明確

**問題の詳細:**
`PUT /api/appointments/{id}` および `DELETE /api/appointments/{id}` において、予約の所有権検証の設計が記載されていません。現状では、患者Aが患者Bの予約をキャンセルできる可能性があります。

**対策:**
- 予約更新・削除時に、リクエストユーザーのIDと予約の `patient_id` が一致することを検証
- 医療機関側も、自施設の予約のみ操作可能にする制約を設計

**該当箇所:**
- 5.1 エンドポイント一覧 - 予約API

---

### M2. CORS設定の具体的な設計が欠落

**問題の詳細:**
3.1 に「HTTPS + JSON形式で通信」と記載されていますが、CORS (Cross-Origin Resource Sharing) の設定が未記載です。不適切なCORS設定は、悪意のあるサイトからのAPIアクセスを許可するリスクがあります。

**対策:**
1. CORS設定を明示的に設計:
   - `Access-Control-Allow-Origin`: 許可するドメインのみをホワイトリスト化（ワイルドカード `*` は禁止）
   - `Access-Control-Allow-Credentials`: `true` に設定（Cookie送信を許可）
   - `Access-Control-Allow-Methods`: 必要なHTTPメソッドのみ許可（GET, POST, PUT, DELETE）
2. プリフライトリクエスト（OPTIONS）のキャッシュ設定

**該当箇所:**
- 4 入力検証 & 攻撃防御（評価基準）

---

### M3. 入力検証の具体的な基準が不足

**問題の詳細:**
7.2 に「外部入力はSpring Validationで検証」と記載されていますが、具体的な検証ルールが未記載です。例えば:
- メールアドレス、電話番号のフォーマット検証
- 診断内容・処方薬フィールドの最大長、許可文字種別
- ファイルアップロード時のMIMEタイプ・サイズ制限

**対策:**
1. エンティティごとに検証ルールを設計:
   - `email`: RFC 5322準拠の正規表現 + ドメイン実在確認
   - `phone_number`: 国際電話番号形式（E.164）または国内形式
   - `diagnosis`, `prescription`: 最大10,000文字、HTMLタグ禁止
2. ファイルアップロード:
   - 許可するMIMEタイプのホワイトリスト（image/jpeg, image/png, application/pdf）
   - 最大ファイルサイズ: 10MB
   - ウイルススキャン（ClamAV）の統合

**該当箇所:**
- 7.2 セキュリティ要件
- 4 入力検証 & 攻撃防御（評価基準）

---

### M4. SQLインジェクション対策が不完全

**問題の詳細:**
7.2 に「SQLインジェクション対策としてPreparedStatementを使用する」と記載されていますが、Spring Data JPAを使用する場合、以下のリスクが考慮されていません:
- `@Query` アノテーションでのネイティブクエリ使用時の文字列結合
- 動的クエリ生成（Criteria API、Specifications）での不適切な使用

**対策:**
1. コーディング規約として以下を明記:
   - ネイティブクエリでは常に名前付きパラメータ（`:param`）を使用
   - 文字列結合によるクエリ生成を禁止
   - 動的ソート・フィルタには、許可された列名のホワイトリストチェックを必須化
2. 静的解析ツール（SpotBugs, SonarQube）でSQLインジェクションパターンを検出

**該当箇所:**
- 7.2 セキュリティ要件

---

### M5. 依存ライブラリの脆弱性管理が未設計

**問題の詳細:**
2.4 に主要ライブラリが列挙されていますが、これらの脆弱性管理ポリシーが記載されていません。特に、医療システムでは長期運用が前提であり、脆弱性対応の遅延が重大なリスクとなります。

**対策:**
1. 依存関係の脆弱性スキャンをCIパイプラインに統合:
   - `OWASP Dependency-Check` または `Snyk` を使用
   - CRITICALまたはHIGH評価の脆弱性が検出された場合、ビルドを失敗させる
2. 月次での依存ライブラリのアップデート計画を策定
3. セキュリティアドバイザリの監視（GitHub Dependabot、NVDフィード）

**該当箇所:**
- 2.4 主要ライブラリ
- 5 インフラ、依存関係 & 監査（評価基準）

---

## 4. 軽微な改善点（Minor Improvements）

### I1. パスワードポリシーの明示化

現状、パスワードはbcryptでハッシュ化されると記載されていますが、パスワードの複雑性要件（最小長、文字種別の組み合わせ）が未定義です。以下の基準を推奨:
- 最小長: 12文字
- 大文字、小文字、数字、記号のうち3種類以上を含む
- 過去3回分のパスワード再利用を禁止

---

### I2. セキュリティヘッダーの設計

Webアプリケーションのセキュリティを強化するため、以下のHTTPヘッダーの設定を推奨:
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `Content-Security-Policy: default-src 'self'; script-src 'self'`
- `Strict-Transport-Security: max-age=31536000; includeSubDomains`

---

### I3. 多要素認証（MFA）の導入検討

医療従事者および管理者向けに、多要素認証（TOTP、SMS、WebAuthn）の導入を推奨します。特に、カルテへのアクセス権限を持つアカウントには必須化することで、アカウント乗っ取りのリスクを大幅に低減できます。

---

## 5. 評価基準別のカバレッジ

| 評価基準 | カバレッジ状況 | 重大な欠陥数 |
|---------|-------------|------------|
| 1. 脅威モデリング (STRIDE) | 部分的 | 0 |
| 2. 認証・認可設計 | 不十分 | 3 (C1, C2, C4) |
| 3. データ保護 | 不十分 | 1 (S4) |
| 4. 入力検証・攻撃防御 | 部分的 | 1 (C3) |
| 5. インフラ・依存関係・監査 | 不十分 | 2 (S3, S5) |

---

## 6. 推奨アクション

### 最優先（リリース前に必須）
1. C1: 医療記録APIの認可ロジックを設計・実装
2. C2: 医療機関・診療科によるデータ分離を設計
3. C3: 本番環境でのエラーレスポンスを汎用メッセージに変更
4. C4: JWTトークンをHttpOnly Cookieに変更
5. S4: データベースとS3の暗号化を有効化

### 高優先（リリース後1ヶ月以内）
1. S1: レート制限の粒度を明確化し、ブルートフォース対策を追加
2. S2: ログアウト時のトークン無効化を実装
3. S3: セキュリティ監査ログの設計を追加
4. S5: シークレット管理の詳細設計を策定

### 中優先（リリース後3ヶ月以内）
1. M1-M5: 上記の中程度の問題をすべて対処
2. I1-I3: 軽微な改善点を実施

---

## 7. まとめ

本設計書は、基本的なアーキテクチャは適切ですが、**セキュリティ設計の具体性と網羅性に重大な欠陥**があります。特に、認可制御の欠落は医療システムとして致命的であり、即座の是正が必要です。上記の推奨アクションを実施し、セキュリティレビューを再度実施することを強く推奨します。
