# セキュリティ設計評価レポート: リアルタイム医療予約システム

## 評価サマリ

本設計書に対して、STRIDE脅威モデリング、認証・認可設計、データ保護、入力検証・攻撃防御、インフラ・依存関係・監査の観点から包括的なセキュリティ評価を実施しました。

医療情報を扱うシステムとして、いくつかの重大なセキュリティギャップと多数の重要な改善点が確認されました。以下、深刻度順に報告します。

---

## 重大な問題（Critical Issues）

### C1. JWTトークンのlocalStorage保存による窃取リスク

**問題点:**
設計書5.3節で「JWTトークンはlocalStorageに保存」と明記されています。localStorageはJavaScriptから自由にアクセス可能であり、XSS攻撃が成功した場合に認証トークンが即座に窃取されます。

**影響:**
- XSS脆弱性が存在した場合、攻撃者は任意のユーザーのJWTトークンを取得可能
- 窃取されたトークンで1時間（有効期限内）患者の医療記録へのフルアクセスが可能
- リフレッシュトークン（30日間有効）の窃取により長期間の不正アクセスが可能

**推奨対策:**
- JWTトークンをHttpOnly・Secure属性付きCookieで管理する
- リフレッシュトークンはさらに厳格に保護し、データベースでのホワイトリスト管理とローテーション戦略を導入する
- セッション管理にCSRF対策（SameSite属性、CSRFトークン）を組み合わせる

**参照:** 5.3節

---

### C2. エラーレスポンスによる情報漏洩リスク

**問題点:**
6.1節のエラーハンドリング方針で「エラーメッセージには詳細なスタックトレースを含め、デバッグを容易にする」と記載されています。本番環境でスタックトレースをクライアントに返却すると、システムの内部構造、ライブラリバージョン、ファイルパスなどが外部に露出します。

**影響:**
- 攻撃者がシステムのフレームワーク・ライブラリバージョンを特定し、既知の脆弱性を悪用可能
- 内部実装の詳細が露出することで、攻撃の精度が向上
- 情報漏洩（Information Disclosure）脅威の具体化

**推奨対策:**
- 本番環境ではクライアントに汎用的なエラーメッセージのみを返却する
- 詳細なスタックトレースはサーバー側のログシステムのみに記録する
- 環境変数で「開発環境のみ詳細エラーを返す」設定を可能にする

**参照:** 6.1節

---

### C3. API認可設計の不在（患者データアクセス制御）

**問題点:**
患者API（`GET /api/patients/{id}`）、カルテAPI（`GET /api/records/{id}`、`GET /api/patients/{id}/records`）において、リクエストユーザーが該当リソースにアクセスする権限を持つかの検証設計が明記されていません。

**影響:**
- 患者Aが患者BのIDをURLに指定することで、患者Bの個人情報・診察履歴を閲覧可能（IDOR脆弱性）
- 医療従事者が自施設外の患者情報に不正アクセス可能
- 権限昇格（Elevation of Privilege）および情報漏洩（Information Disclosure）の深刻な脅威

**推奨対策:**
- 各APIエンドポイントでリソースオーナーシップまたはアクセス権限の検証を明示的に設計する
  - 患者は自分のデータのみアクセス可能
  - 医療従事者は自施設で予約のある患者のデータのみアクセス可能
  - 管理者は全データアクセス可能
- Spring Securityのメソッドレベル認可（`@PreAuthorize`など）を活用する設計を追加

**参照:** 5.1節（患者API、カルテAPI）

---

### C4. 予約API認可設計の不在

**問題点:**
予約API（`PUT /api/appointments/{id}`、`DELETE /api/appointments/{id}`）において、予約の変更・キャンセル操作を実行できるユーザーの権限検証設計が明記されていません。

**影響:**
- 患者Aが患者Bの予約IDを指定して予約を変更・キャンセル可能
- 悪意あるユーザーによる大量の予約妨害（DoS）
- データ改ざん（Tampering）および否認防止（Repudiation）の脅威

**推奨対策:**
- 予約変更・キャンセルは予約作成者本人または医療機関スタッフのみが実行可能とする認可ロジックを設計する
- 予約変更・キャンセル操作を監査ログに記録する設計を追加

**参照:** 5.1節（予約API）

---

## 重要な問題（Significant Issues）

### S1. データベース暗号化設計の欠如

**問題点:**
7.2節では「すべての通信をTLS 1.3で暗号化」と記載されていますが、データベース保存時の暗号化（Encryption at Rest）に関する設計が記載されていません。

**影響:**
- データベースのバックアップファイルや物理ストレージが漏洩した場合、患者の氏名・生年月日・住所・電話番号・保険証番号・診察記録が平文で露出
- コンプライアンス違反（個人情報保護法、医療情報管理ガイドライン）

**推奨対策:**
- PostgreSQLの透過的データ暗号化（TDE）またはAWS RDS暗号化を有効化する
- 特に機微な個人情報（氏名、保険証番号、診断内容など）はアプリケーションレイヤーでのフィールドレベル暗号化を検討する
- 暗号化キーの管理にAWS KMSを使用し、キーローテーション戦略を設計する

**参照:** 4.2節（テーブル設計）、7.2節

---

### S2. 個人情報のデータ分類・保持期間・削除ポリシーの欠如

**問題点:**
患者の氏名、生年月日、住所、電話番号、保険証番号、診断内容などの機微な個人情報を扱うにもかかわらず、データ分類、保持期間、削除ポリシーが設計されていません。

**影響:**
- 不要になったデータが無期限に保存され、漏洩リスクが増大
- 個人情報保護法の「利用目的達成後の速やかな削除」義務に違反する可能性
- プライバシー侵害のリスク

**推奨対策:**
- データ分類スキーム（公開情報、内部情報、機密情報、最高機密情報）を定義する
- 各データカテゴリに対して保持期間を設計する（例: 診察記録は最終診察日から7年間保持）
- 保持期限到達時の自動削除またはアーカイブプロセスを設計する
- 患者からの削除要求（消去権）に対応する手順を設計する

**参照:** 4.1節、4.2節

---

### S3. CORS設定の欠如

**問題点:**
React SPAおよびReact NativeアプリからバックエンドAPIへのアクセスが想定されていますが、CORSポリシー設計が記載されていません。

**影響:**
- デフォルト設定で全オリジンからのアクセスを許可すると、悪意あるサイトからのAPI呼び出しが可能
- CSRF攻撃や認証情報の窃取リスク

**推奨対策:**
- 許可するオリジン（フロントエンドのドメイン）を明示的にホワイトリスト化する
- 認証情報を含むリクエストには`Access-Control-Allow-Credentials: true`を設定する
- プリフライトリクエストに対する適切なレスポンス設計を追加する

**参照:** 3.3節（データフロー）

---

### S4. レート制限の不足（認証エンドポイント）

**問題点:**
API Gateway層で「1分あたり100リクエスト」のレート制限が設計されていますが（3.2節）、認証エンドポイント（`POST /api/auth/login`）に対するブルートフォース攻撃への対策が不十分です。

**影響:**
- 攻撃者が1分間に100回のログイン試行を実行可能（パスワード推測攻撃）
- アカウント乗っ取りのリスク

**推奨対策:**
- 認証エンドポイントには個別にIPアドレスごとの厳格なレート制限（例: 5回/分）を設定する
- 連続ログイン失敗時のアカウント一時ロック機構を設計する
- ログイン試行失敗をセキュリティ監査ログに記録する

**参照:** 3.2節、5.1節（認証API）

---

### S5. セキュリティ監査ログ設計の欠如

**問題点:**
6.2節で一般的なアプリケーションログの設計は記載されていますが、セキュリティ監査に必要な以下のイベントのログ記録設計が明記されていません。

- 認証試行の成功・失敗（IPアドレス、タイムスタンプ）
- 権限変更（ロール付与・剥奪）
- 機微データ（患者情報、カルテ）へのアクセス
- データ削除・変更操作

**影響:**
- セキュリティインシデント発生時の原因特定が困難
- 不正アクセスの検知が遅延
- 否認防止（Repudiation）脅威への対策不足

**推奨対策:**
- セキュリティ監査ログを通常のアプリケーションログと分離して設計する
- 監査ログには最低限以下を記録:
  - イベント種別、タイムスタンプ、ユーザーID、IPアドレス、操作対象リソース、成功/失敗
- 監査ログは改ざん防止のため書き込み専用ストレージに保存し、長期保持（例: 1年間）する
- 異常検知のためのログ監視・アラート設計を追加する

**参照:** 6.2節

---

### S6. 内部通信の暗号化設計の欠如

**問題点:**
7.2節では「すべての通信をTLS 1.3で暗号化」と記載されていますが、これが外部クライアントとAPI Gateway間のみを指すのか、内部コンポーネント間（API GatewayとECS、ECSとRDS/Redis）も含むのか明確ではありません。

**影響:**
- 内部ネットワークで通信が平文の場合、ネットワーク侵害時にデータが盗聴可能
- 中間者攻撃のリスク

**推奨対策:**
- 内部通信（ECS↔RDS、ECS↔Redis）もTLSで暗号化する設計を明記する
- RDSへの接続はSSL/TLS必須とし、証明書検証を有効化する
- Redisへの接続もTLSを有効化する（Redis 6.0以降）

**参照:** 7.2節

---

### S7. 依存ライブラリの脆弱性管理プロセスの欠如

**問題点:**
主要ライブラリとして多数のOSSが列挙されていますが（2.4節）、これらの脆弱性管理プロセスが設計されていません。

**影響:**
- 既知の脆弱性を持つライブラリがそのまま運用される
- 脆弱性を悪用した攻撃により、システム全体が侵害されるリスク

**推奨対策:**
- 依存ライブラリの脆弱性スキャンをCIパイプラインに組み込む（OWASP Dependency-Check、Snyk、Trivy等）
- 重大な脆弱性が検出された場合はビルド失敗とする
- 定期的な依存ライブラリのバージョン更新プロセスを設計する
- CVE情報のモニタリングと緊急パッチ適用手順を確立する

**参照:** 2.4節、6.4節

---

## 中程度の問題（Moderate Issues）

### M1. JWTトークンの署名アルゴリズム・鍵管理設計の欠如

**問題点:**
5.3節でJWT認証を採用していますが、署名アルゴリズム（HS256/RS256など）、署名鍵の生成・ローテーション・アクセス制御に関する設計が記載されていません。

**影響:**
- 弱いアルゴリズム（HS256 + 短い秘密鍵）の場合、署名偽造のリスク
- 鍵が漏洩した場合、任意のJWTトークンが生成可能（権限昇格）

**推奨対策:**
- RS256（RSA署名）またはES256（楕円曲線署名）を使用する設計を明記する
- 秘密鍵はAWS Secrets Managerで管理し、定期的なローテーション戦略を設計する
- 鍵へのアクセスはアプリケーションサービスのみに制限する

**参照:** 5.3節

---

### M2. JWTトークンの失効メカニズムの欠如

**問題点:**
JWTはステートレスな設計のため、トークン発行後の失効が困難です。ログアウト処理（`POST /api/auth/logout`）が存在しますが、発行済みトークンの無効化設計が明記されていません。

**影響:**
- ユーザーがログアウトしても、盗まれたトークンは有効期限まで使用可能
- アカウント侵害時の緊急トークン失効ができない

**推奨対策:**
- トークン失効リスト（Blacklist）をRedisで管理する設計を追加する
- または、セッションIDベースの管理に移行し、サーバー側で即座に失効可能にする
- リフレッシュトークンはデータベースでホワイトリスト管理し、失効時に削除する

**参照:** 5.1節（認証API）

---

### M3. SQLインジェクション対策の詳細設計不足

**問題点:**
7.2節で「SQLインジェクション対策としてPreparedStatementを使用」と記載されていますが、Spring Data JPAを使用する場合（2.4節）、動的クエリや検索機能での対策が不十分になる可能性があります。

**影響:**
- 医療機関検索や患者検索など、ユーザー入力を含む動的クエリでSQLインジェクションのリスク
- データベース全体の情報漏洩や改ざん

**推奨対策:**
- すべてのデータベースアクセスでパラメータ化クエリまたはCriteria APIを使用することを設計方針として明記する
- ネイティブクエリを使用する場合は必ずパラメータバインディングを使用する
- コードレビューチェックリストにSQLインジェクション対策を含める

**参照:** 7.2節、2.4節

---

### M4. XSS対策の設計不足

**問題点:**
外部入力の検証について「Spring Validationで検証」と記載されていますが（7.2節）、出力時のエスケープ処理に関する設計が明記されていません。

**影響:**
- ユーザー入力がそのままHTML/JavaScriptコンテキストで出力される場合、XSS攻撃が成立
- 攻撃者が患者の氏名フィールドに悪意あるスクリプトを仕込み、医療従事者の画面で実行される可能性

**推奨対策:**
- フロントエンド（React）ではデフォルトのエスケープ機能（JSX）を利用し、`dangerouslySetInnerHTML`の使用を禁止する設計方針を明記する
- バックエンドからのJSON出力でもHTMLエスケープが必要な箇所を特定する
- Content Security Policy（CSP）ヘッダーの設定を追加する

**参照:** 7.2節

---

### M5. セッションタイムアウト設計の不足

**問題点:**
JWTトークンの有効期限は1時間と設計されていますが（5.3節）、ユーザーの無操作時の自動ログアウト（セッションタイムアウト）設計が明記されていません。

**影響:**
- 医療従事者が離席中にPCを放置した場合、第三者が患者情報にアクセス可能
- 物理的なセキュリティリスク

**推奨対策:**
- フロントエンドで無操作検知（例: 15分間操作なし）による自動ログアウト機能を設計する
- トークンのリフレッシュ処理にユーザーアクティビティを紐づける

**参照:** 5.3節

---

### M6. ファイルアップロード機能のセキュリティ設計欠如

**問題点:**
S3ストレージを使用してドキュメントを保存する記載がありますが（2.3節）、ファイルアップロード機能のセキュリティ対策が設計されていません。

**影響:**
- 悪意あるファイル（実行可能ファイル、巨大ファイル）のアップロードによるDoSまたはマルウェア配布
- ファイル名を利用したパストラバーサル攻撃

**推奨対策:**
- アップロード可能なファイルタイプをホワイトリスト化する（拡張子とMIMEタイプの両方検証）
- ファイルサイズ上限を設定する（例: 10MB）
- アップロードファイルのウイルススキャンを実施する
- ファイル名をランダムなUUIDにリネームし、元のファイル名はメタデータとして保存する
- S3バケットのパブリックアクセスを禁止し、署名付きURLでアクセス制御する

**参照:** 2.3節

---

### M7. パスワードポリシーの設計欠如

**問題点:**
パスワードはbcryptでハッシュ化されますが（7.2節）、パスワード要件（最小文字数、複雑性）が設計されていません。

**影響:**
- 弱いパスワード（"123456"など）が設定可能となり、ブルートフォース攻撃に脆弱

**推奨対策:**
- パスワードポリシーを設計する（最小8文字、英数字記号を含む等）
- パスワード強度チェックをユーザー登録時に実施する
- 定期的なパスワード変更を促す仕組みを検討する（ただし、過度な頻度要求は逆効果）

**参照:** 7.2節、4.2節（usersテーブル）

---

## 軽微な改善点（Minor Improvements）

### I1. API Gatewayレイヤーでの追加セキュリティヘッダー設定

**推奨対策:**
- API Gatewayまたはバックエンドでセキュリティヘッダーを設定する設計を追加:
  - `X-Content-Type-Options: nosniff`
  - `X-Frame-Options: DENY`
  - `Strict-Transport-Security: max-age=31536000`
  - `Content-Security-Policy`（適切なポリシー）

**参照:** 3.2節

---

### I2. データベース接続の最小権限原則

**推奨対策:**
- アプリケーションからのデータベース接続は、必要最小限の権限のみを持つ専用ユーザーを使用する設計を明記する
- DDL権限はアプリケーションアカウントに付与しない

**参照:** 2.2節

---

### I3. Redisへのアクセス制御設計

**推奨対策:**
- RedisへのアクセスにはACL（Access Control List）を設定し、パスワード認証を有効化する設計を追加する
- キャッシュに機微情報を含む場合は暗号化を検討する

**参照:** 2.2節

---

## ポジティブな評価点

以下の設計は適切なセキュリティ対策として評価できます:

1. **パスワードのbcryptハッシュ化（コスト係数10）**: 適切なハッシュアルゴリズムとコスト設定（7.2節）
2. **TLS 1.3の採用**: 最新の暗号化プロトコルの使用（7.2節）
3. **Multi-AZ構成**: 可用性を高める冗長化設計（7.3節）
4. **Blue/Greenデプロイメント**: 安全なリリースプロセス（6.4節）
5. **環境変数による設定管理**: コードにハードコードしない方針（6.4節）
6. **ロールベースアクセス制御（RBAC）の採用**: 基本的な認可モデルの導入（5.3節）

---

## 総合評価と優先対応事項

本設計書は医療情報を扱うシステムとして、以下の優先順位で対応すべきです:

### 最優先（即時対応）
1. **C3, C4**: API認可設計の追加（患者データ・予約の所有権検証）
2. **C1**: JWTトークンの保存方法変更（localStorageからHttpOnly Cookieへ）
3. **C2**: エラーハンドリングの見直し（本番環境でのスタックトレース非表示）

### 高優先（設計段階で対応）
4. **S1**: データベース暗号化設計の追加
5. **S2**: データ分類・保持期間・削除ポリシーの策定
6. **S4**: 認証エンドポイントのレート制限強化
7. **S5**: セキュリティ監査ログ設計の追加
8. **S7**: 依存ライブラリ脆弱性管理プロセスの確立

### 中優先（実装前に対応）
9. **S3, M4**: CORS設定とXSS対策の設計
10. **M1, M2**: JWT署名・失効メカニズムの詳細設計
11. **M6**: ファイルアップロードセキュリティ設計

医療情報システムとしてコンプライアンス要件も厳しいため、上記の重大・重要な問題への対応は必須です。
