# セキュリティ設計レビュー結果

## 重大な問題 (Critical Issues)

### C1. 認証エンドポイントのレート制限が未設計
**問題:**
ログイン・認証エンドポイント (`POST /api/auth/login`, `POST /api/auth/register`, `POST /api/auth/refresh`) に対する個別のレート制限が設計されていません。API Gateway レベルで「1分あたり100リクエスト」という全体的なレート制限は記載されていますが、これは認証エンドポイントに特化した保護ではなく、ブルートフォース攻撃やパスワード推測攻撃に対して不十分です。

**影響:**
- 攻撃者が自動化ツールを使用して大量のログイン試行を実行し、パスワードをブルートフォース攻撃で破る可能性
- アカウント列挙攻撃により、有効なユーザー名を特定されるリスク
- トークンリフレッシュエンドポイントの濫用により、不正なトークンの取得や DoS 攻撃の可能性

**対策:**
- ログインエンドポイントに対して、IP アドレス単位で「5分間に5回まで」などの厳格なレート制限を実装
- 連続した認証失敗時にアカウントロック機構（一定時間のロックまたはCAPTCHA要求）を設計
- パスワードリセットエンドポイントにも同様のレート制限を適用
- 認証失敗時のレスポンス時間を一定にし、アカウント列挙を困難にする設計を追加

**関連箇所:** セクション3.2 (API Gateway), セクション5.1 (認証API), セクション5.3 (認証・認可方式)

---

### C2. JWT トークンの localStorage 保存による XSS リスク
**問題:**
セクション5.3において、「JWTトークンはlocalStorageに保存し、各APIリクエストのAuthorizationヘッダーで送信する」と明記されています。localStorage は JavaScript から自由にアクセス可能であるため、XSS (クロスサイトスクリプティング) 攻撃が成功した場合、攻撃者がトークンを窃取できます。

**影響:**
- XSS 脆弱性が一つでも存在すれば、攻撃者が全ユーザーの認証トークンを取得可能
- 窃取されたトークンを使用して、患者の個人情報（診察記録、保険情報）への不正アクセス
- なりすましによる予約の不正操作やカルテの改ざん

**対策:**
- JWTトークンを HttpOnly, Secure, SameSite 属性付きの Cookie に保存する設計に変更
- CSRF 対策として、二重送信 Cookie パターンまたはトークンベースの CSRF 保護を併用
- Content Security Policy (CSP) を厳格に設定し、XSS 攻撃の成功確率を低減
- リフレッシュトークンはより厳格に保護（HttpOnly Cookie + ローテーション機構）

**関連箇所:** セクション5.3 (認証・認可方式)

---

### C3. API エンドポイントの認可チェック設計が不明確
**問題:**
各APIエンドポイントにおいて、リソースの所有権検証や権限チェックが明示的に設計されていません。例えば：
- `GET /api/patients/{id}`: 任意の患者が他の患者の情報にアクセスできないか
- `GET /api/patients/{id}/records`: 診察履歴が適切に認可制御されているか
- `PUT /api/appointments/{id}`: 予約の変更権限が予約者本人または医療従事者に限定されているか
- `GET /api/records/{id}`, `PUT /api/records/{id}`: カルテの閲覧・編集権限が担当医師または関係者に限定されているか

セクション5.3にはロールベースアクセス制御（RBAC）の記載はありますが、エンドポイントレベルでの具体的な認可ロジック（リソース所有者チェック、テナント分離）が欠如しています。

**影響:**
- 患者A が患者B の個人情報や診察記録を閲覧・変更できる重大なプライバシー侵害
- 医療機関間のデータ漏洩（別の医療機関の予約やカルテへの不正アクセス）
- 特権昇格攻撃により、一般ユーザーが管理者機能にアクセス可能

**対策:**
- 各エンドポイントで以下の認可チェックを明示的に設計：
  - `/api/patients/{id}`: ロールが PATIENT の場合、`{id}` が自分のIDと一致することを検証。DOCTOR/ADMIN の場合は医療機関の所属関係を検証
  - `/api/appointments/{id}`: 予約の所有者（patient_id）または予約先医療機関の医療従事者のみアクセス可能
  - `/api/records/{id}`: 対象患者本人、担当医師、または関連医療機関の医療従事者のみアクセス可能
- 医療機関間のテナント分離を設計（医療機関IDによるデータフィルタリング）
- 管理者機能には明示的な ADMIN ロールチェックを追加

**関連箇所:** セクション5.1 (API設計), セクション5.3 (認証・認可方式)

---

### C4. 機密情報のログ出力リスク
**問題:**
セクション6.2のロギング方針において、「すべてのAPIリクエスト・レスポンスをINFOレベルでログ出力する」および「requestBody」をログに含めると明記されています。これにより、パスワード、保険証番号、診断内容などの機密情報がログファイルに平文で記録される危険性があります。

**影響:**
- ログファイルへのアクセス権を持つ内部者または攻撃者が、患者の個人情報や認証情報を取得
- 医療情報（診断内容、処方薬、検査結果）の漏洩による重大なプライバシー侵害
- コンプライアンス違反（個人情報保護法、医療情報の適切な取り扱い規則）

**対策:**
- ログ出力前に機密フィールド（password, insurance_number, diagnosis, prescription, lab_results など）をマスキングまたは除外する設計を追加
- リクエストボディ全体のログ記録を廃止し、必要最小限のメタデータ（エンドポイント、ユーザーID、タイムスタンプ）のみ記録
- ログファイル自体のアクセス制御を厳格化（最小権限の原則、暗号化保存）
- セキュリティ監査ログは別途設計し、認証失敗、権限変更、機密データアクセスのみを記録

**関連箇所:** セクション6.2 (ロギング方針)

---

### C5. エラーメッセージによる情報漏洩リスク
**問題:**
セクション6.1において、「エラーメッセージには詳細なスタックトレースを含め、デバッグを容易にする」と記載されています。本番環境でスタックトレースを外部に公開すると、システムの内部構造（使用しているフレームワーク、ライブラリのバージョン、ファイルパス、SQLクエリなど）が攻撃者に露呈し、脆弱性の特定が容易になります。

**影響:**
- スタックトレースから使用ライブラリのバージョンを特定し、既知の脆弱性を悪用される
- データベーススキーマやSQLクエリの構造が漏洩し、SQLインジェクション攻撃の成功率が向上
- ファイルパスやクラス名から、システムの内部構造を推測されセキュリティ対策を回避される

**対策:**
- 本番環境では一般的なエラーメッセージのみを返却し、詳細なスタックトレースを含めない
- 開発環境と本番環境で異なるエラーハンドリング設定を適用（環境変数による切り替え）
- 詳細なエラー情報はサーバー側のログにのみ記録し、クライアントには公開しない
- エラーメッセージは攻撃者に有用な情報を与えないよう、曖昧かつ一貫した形式にする（例: "An error occurred. Please contact support."）

**関連箇所:** セクション6.1 (エラーハンドリング方針)

---

## 重要な問題 (Significant Issues)

### S1. 暗号化アルゴリズムと鍵管理の設計が不完全
**問題:**
セクション7.2では「すべての通信をTLS 1.3で暗号化する」と記載されていますが、以下の重要な暗号化設計が欠如しています：
- データベース内の機密データ（保険証番号、診断内容、検査結果など）の暗号化
- JWTの署名アルゴリズムと鍵管理方式の明示
- 暗号鍵のローテーション方針
- 鍵管理サービス（AWS KMS等）の使用設計

**影響:**
- データベースが侵害された場合、保存された医療情報や個人情報が平文で露呈
- JWT署名鍵が漏洩すると、攻撃者が任意のトークンを偽造可能
- 鍵のローテーションがないと、長期間の侵害リスクが増大

**対策:**
- 機密データカラム（insurance_number, diagnosis, prescription, lab_results など）にアプリケーションレベルまたはデータベースレベルの暗号化を適用
- JWT署名にはRS256（RSA公開鍵暗号）またはES256（楕円曲線暗号）を使用し、秘密鍵をAWS KMSで管理
- 暗号鍵の定期ローテーション方針を設計（例: 90日ごと）
- データ暗号化キー（DEK）とキー暗号化キー（KEK）のエンベロープ暗号化を採用

**関連箇所:** セクション7.2 (セキュリティ要件), セクション5.3 (認証・認可方式)

---

### S2. セッションタイムアウトと不活性タイムアウトの設計欠如
**問題:**
セクション5.3では「トークンの有効期限は1時間」と記載されていますが、ユーザーの不活性に基づくタイムアウト設計がありません。医療情報を扱うシステムでは、ユーザーが離席した際のセッションハイジャックリスクに対処する必要があります。

**影響:**
- 医療従事者が院内PCからログアウトせずに離席した場合、第三者が端末を操作して患者情報にアクセス可能
- 盗難されたデバイスからのセッション継続リスク

**対策:**
- 不活性タイムアウト（例: 15分間操作がない場合は自動ログアウト）を設計
- 医療従事者向けには特に短いタイムアウトを設定（例: 5分）
- セッション延長時の再認証要求（パスワード確認またはMFA）
- デバイスのロック検知と連動したセッション無効化

**関連箇所:** セクション5.3 (認証・認可方式)

---

### S3. 監査ログの設計が不十分
**問題:**
セクション6.2のロギング方針には一般的なアプリケーションログの記載はありますが、セキュリティ監査に必要な専用の監査ログ設計が明確ではありません。特に以下のイベントが記録されるべきです：
- 認証の成功・失敗（ユーザーID、IPアドレス、タイムスタンプ）
- 権限変更操作（ロール変更、医療機関の追加・削除）
- 機密データへのアクセス（カルテの閲覧・編集、患者情報の取得）
- 管理者操作（システム設定変更、ユーザーアカウントの管理）

**影響:**
- セキュリティインシデント発生時に、攻撃の経路や影響範囲を特定できない
- 内部不正の検知が困難
- コンプライアンス要件（医療情報の適切な取り扱い、監査証跡の保持）を満たせない

**対策:**
- セキュリティ監査専用のログストリームを設計し、改ざん防止のため別ストレージに保存
- 監査ログには以下の情報を含める：イベントタイプ、ユーザーID、IPアドレス、タイムスタンプ、操作対象（リソースID）、操作結果（成功/失敗）
- 監査ログの保持期間を明確化（例: 7年間、医療記録保存義務に準拠）
- CloudWatch Logs Insightsやセキュリティ情報・イベント管理（SIEM）ツールとの統合

**関連箇所:** セクション6.2 (ロギング方針), セクション7.2 (セキュリティ要件)

---

### S4. CORS・CSRFおよびセキュリティヘッダー設計の欠如
**問題:**
設計書にはCORS（Cross-Origin Resource Sharing）ポリシー、CSRF（クロスサイトリクエストフォージェリ）対策、セキュリティヘッダー（Content Security Policy, X-Frame-Options, HSTS など）の設計が記載されていません。

**影響:**
- 不適切なCORS設定により、悪意のあるサイトから医療予約システムのAPIへのリクエストが許可される
- CSRF攻撃により、ログイン中のユーザーが意図しない予約変更やアカウント設定変更を実行させられる
- クリックジャッキング攻撃により、ユーザーが偽装されたUIを通じて重要な操作を実行

**対策:**
- CORS設定を厳格化し、許可するオリジンを明示的にホワイトリスト化（ワイルドカード `*` は禁止）
- CSRF対策として、状態変更を伴うエンドポイント（POST/PUT/DELETE）にCSRFトークンまたはSameSite Cookie属性を適用
- 以下のセキュリティヘッダーを設定：
  - `Content-Security-Policy`: スクリプトやスタイルシートのソースを制限
  - `X-Frame-Options: DENY`: クリックジャッキング防止
  - `Strict-Transport-Security`: HTTPS強制
  - `X-Content-Type-Options: nosniff`: MIMEタイプスニッフィング防止

**関連箇所:** セクション3.1 (全体構成), セクション5.3 (認証・認可方式), セクション7.2 (セキュリティ要件)

---

## 中程度の問題 (Moderate Issues)

### M1. パスワードポリシーの設計欠如
**問題:**
セクション7.2では「パスワードはbcryptアルゴリズム（コスト係数10）でハッシュ化する」と記載されていますが、パスワードの強度要件（最小文字数、複雑性要件）やパスワード変更ポリシーが設計されていません。

**対策:**
- パスワード強度要件を明確化（最小12文字、大文字・小文字・数字・記号を含む）
- 共通パスワード辞書との照合によるブラックリストチェック
- パスワードの定期変更を推奨（ただし、強制変更は逆効果になる可能性があるため慎重に検討）
- 多要素認証（MFA）の導入を検討（特に医療従事者と管理者向け）

**関連箇所:** セクション7.2 (セキュリティ要件)

---

### M2. 依存ライブラリの脆弱性管理方針の具体性不足
**問題:**
設計書には「第三者ライブラリの脆弱性管理」の記載がありません。Spring Boot、React、PostgreSQL ドライバなどのライブラリに脆弱性が発見された場合の対応プロセスが不明確です。

**対策:**
- 依存ライブラリの脆弱性スキャンツール（Snyk, OWASP Dependency-Check, GitHub Dependabot）を CI/CD パイプラインに統合
- 脆弱性が発見された際の評価基準（CVSS スコア）と対応期限（Critical: 24時間以内、High: 7日以内など）を定義
- ライブラリの定期的なアップデート方針（四半期ごとなど）
- サポート終了（EOL）ライブラリの使用禁止ポリシー

**関連箇所:** セクション2.4 (主要ライブラリ), セクション6.4 (デプロイメント方針)

---

### M3. シークレット管理の設計詳細不足
**問題:**
セクション6.4では「環境変数はAWS Systems Manager Parameter Storeから取得」と記載されていますが、以下が不明確です：
- データベース認証情報、API キー、JWT署名鍵などのシークレットの保存方法
- シークレットのアクセス制御（どのサービスがどのシークレットにアクセス可能か）
- シークレットのローテーション方針

**対策:**
- 機密性の高いシークレット（データベース認証情報、JWT署名鍵）はAWS Secrets Managerに保存
- IAMロールによる最小権限アクセス制御を設計（ECSタスクロールごとに必要なシークレットのみアクセス可）
- RDSパスワードの自動ローテーション機能を有効化
- シークレットのバージョン管理とロールバック手順を設計

**関連箇所:** セクション6.4 (デプロイメント方針), セクション7.2 (セキュリティ要件)

---

### M4. データ保持・削除ポリシーの設計欠如
**問題:**
GDPR や個人情報保護法に準拠するため、患者データの保持期間と削除手順を設計する必要がありますが、設計書には記載がありません。

**対策:**
- 患者データの保持期間を定義（医療記録: 法定保存期間準拠、一般ユーザーデータ: 利用規約に基づく）
- 削除リクエスト（データポータビリティ権、削除権）への対応フローを設計
- 論理削除と物理削除の使い分け基準を明確化
- バックアップデータからの削除手順も含める

**関連箇所:** セクション4 (データモデル), セクション7.2 (セキュリティ要件)

---

## 軽微な改善提案 (Minor Improvements)

### I1. SQL インジェクション対策の具体化
**問題:**
セクション7.2には「SQLインジェクション対策としてPreparedStatementを使用する」と記載されていますが、Spring Data JPA（Hibernate）を使用する場合、より具体的な対策が必要です。

**対策:**
- Spring Data JPA のクエリメソッドまたは Criteria API を優先的に使用
- JPQL や Native Query を使用する際は、必ずパラメータバインディングを使用
- ユーザー入力を動的にSQLクエリに結合しない設計ルールを明記

**関連箇所:** セクション2.4 (主要ライブラリ), セクション7.2 (セキュリティ要件)

---

### I2. ファイルアップロード機能のセキュリティ対策
**問題:**
設計書には「ストレージ: Amazon S3（画像・ドキュメント）」と記載されていますが、ファイルアップロード機能のセキュリティ対策が設計されていません。

**対策:**
- ファイルタイプの厳格な検証（MIMEタイプとファイル拡張子の両方をチェック）
- ファイルサイズ制限（例: 最大10MB）
- ファイル名のサニタイゼーション（パストラバーサル攻撃防止）
- アップロードされたファイルのウイルススキャン（ClamAV や AWS Macie）
- S3バケットのパブリックアクセスを禁止し、署名付きURLでアクセス制御

**関連箇所:** セクション2.3 (インフラ・デプロイ環境)

---

### I3. レート制限の詳細設計
**問題:**
セクション3.2には「レート制限（1分あたり100リクエスト）」と記載されていますが、詳細が不明確です。

**対策:**
- レート制限の単位を明確化（IPアドレス単位、ユーザー単位、APIキー単位）
- エンドポイントごとに異なるレート制限を設計（認証エンドポイントはより厳格に）
- レート制限超過時のレスポンス（HTTP 429 Too Many Requests、Retry-After ヘッダー）
- バーストトラフィックへの対応（トークンバケットアルゴリズムなど）

**関連箇所:** セクション3.2 (主要コンポーネントの責務と依存関係)

---

## 評価サマリ

本設計書は医療予約システムの基本的なアーキテクチャとデータモデルを定義していますが、セキュリティ設計において複数の重大な欠陥があります。特に以下の5点は早急に対処が必要です：

1. **認証エンドポイントのブルートフォース対策不足**
2. **JWT の localStorage 保存による XSS リスク**
3. **API エンドポイントの認可チェック設計欠如**
4. **機密情報のログ出力リスク**
5. **エラーメッセージによる情報漏洩リスク**

また、暗号化設計、監査ログ、CORS/CSRF対策、依存ライブラリ管理などの重要な要素も追加設計が必要です。医療情報という高度に機密性の高いデータを扱うシステムとして、セキュリティ要件を包括的に見直し、設計に反映させることを強く推奨します。
