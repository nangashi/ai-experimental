# セキュリティ設計レビュー: リアルタイム医療予約システム

## 重大な問題（Critical Issues）

### C1. 機密医療データの暗号化設計が欠落
**問題:**
診察記録、患者カルテ、保険証番号などの機密医療情報を扱うにもかかわらず、データベース暗号化（at rest）の設計が明記されていない。PostgreSQLに格納される `medical_records`、`patients` テーブルには診断内容、処方薬、検査結果、保険証番号などの高度に機密性の高い個人医療情報が含まれるが、暗号化方式やキー管理の設計が存在しない。

**影響:**
- データベース侵害時に全患者の医療記録が平文で流出
- 医療情報保護法、GDPR、HIPAA等の規制要件違反
- 患者のプライバシー侵害と法的責任の発生

**対策:**
- PostgreSQL Transparent Data Encryption（TDE）またはAWS RDS暗号化を有効化
- 暗号化キーはAWS KMSで管理し、定期的なキーローテーション（90日）を設計
- カラムレベル暗号化を `insurance_number`、`diagnosis`、`prescription`、`lab_results` に適用
- 暗号化キーのアクセス制御をIAMポリシーで設計し、最小権限原則を適用

**参照:** セクション4.2（テーブル設計）、セクション7.2（セキュリティ要件）

---

### C2. API認可設計の欠落によるデータアクセス制御の不備
**問題:**
API設計（セクション5.1）で認証方式は記載されているが、個別エンドポイントの認可設計が欠落している。特に以下の重大な欠陥が存在する:

1. **患者データアクセス:** `GET /api/patients/{id}` で他の患者の情報を取得可能（患者IDの所有権検証なし）
2. **診察記録アクセス:** `GET /api/records/{id}` で任意の患者のカルテを閲覧可能
3. **予約操作:** `PUT /api/appointments/{id}`、`DELETE /api/appointments/{id}` で他の患者の予約を変更・キャンセル可能
4. **管理者機能:** 医療機関管理APIの設計が記載されておらず、管理者権限チェックの設計が不明

**影響:**
- 任意の患者が他の患者の医療記録、個人情報、予約情報を取得・操作可能
- 医療情報保護法違反、重大なプライバシー侵害
- 不正な予約操作による診療混乱

**対策:**
- リソースベース認可を各エンドポイントに設計:
  - `GET /api/patients/{id}`: リクエスト元ユーザーのuser_idとpatients.user_idの一致検証、またはDOCTOR/ADMINロールの検証
  - `GET /api/appointments`: 患者は自身の予約のみ、医師は担当医療機関の予約のみ取得可能
  - `GET /api/records/{id}`: 患者本人または担当医師のみアクセス可能（appointment.institution_idとの照合）
- Spring Security `@PreAuthorize` アノテーションで認可ロジックを実装する設計を明記
- テナント分離設計を追加し、医療機関IDによるデータ分離を明記

**参照:** セクション5.1（エンドポイント一覧）、セクション5.3（認証・認可方式）

---

### C3. JWTトークンのlocalStorage保存によるXSS脆弱性
**問題:**
セクション5.3で「JWTトークンはlocalStorageに保存」と明記されているが、これはXSS攻撃時にトークン窃取を許す重大な設計欠陥である。医療システムでは第三者による不正ログインは患者データへの不正アクセスに直結する。

**影響:**
- XSS攻撃によりJWTトークンが窃取され、攻撃者が患者や医師になりすまし可能
- 全患者データへのアクセス権限が奪取される
- XSS脆弱性はReactアプリケーションで発生しやすい（dangerouslySetInnerHTML、サードパーティライブラリの脆弱性）

**対策:**
- JWTトークンをHttpOnly Cookie（Secure, SameSite=Strict属性付き）で保存する設計に変更
- CSRFトークンを併用し、CSRF攻撃を防御
- リフレッシュトークンもHttpOnly Cookieで保存
- Content Security Policy（CSP）を設計し、inline scriptを禁止

**参照:** セクション5.3（認証・認可方式）

---

### C4. シークレット管理の不完全性（キーライフサイクル設計欠落）
**問題:**
セクション6.4で「環境変数はAWS Systems Manager Parameter Storeから取得」と記載されているが、以下の設計が欠落している:
- JWT署名キーのローテーション設計
- データベース認証情報のローテーション方針
- キーの生成、配布、失効、アクセス制御の設計
- 開発環境でのシークレット漏洩防止策

**影響:**
- JWT署名キーが漏洩した場合、任意のトークンを偽造可能（全システム侵害）
- キーローテーションが設計されていない場合、漏洩時の影響範囲が無制限
- 開発者のPCやGitリポジトリへのシークレット混入リスク

**対策:**
- JWT署名キーを AWS Secrets Manager で管理し、90日ごとの自動ローテーション設計を明記
- データベース認証情報もSecrets Managerで管理し、定期ローテーション（30日）
- IAMポリシーでシークレットアクセスを制限（本番環境のシークレットは本番ECSタスクロールのみ）
- git-secrets、TruffleHog等のシークレットスキャンツールをCI/CDパイプラインに組み込む設計
- 開発環境では別個のシークレットを使用し、本番シークレットへのアクセスを制限

**参照:** セクション6.4（デプロイメント方針）

---

## 重要な問題（Significant Issues）

### S1. セキュリティ監査ログ設計の欠落
**問題:**
セクション6.2でアプリケーションログの設計は記載されているが、セキュリティ監査ログの設計が欠落している。以下の重要操作のログが設計されていない:
- 認証失敗（ブルートフォース攻撃検知）
- 権限昇格の試行（403エラーの記録）
- 機密データアクセス（患者情報、診察記録の閲覧・更新）
- 管理者操作（医療機関の追加・削除）
- 異常なAPIアクセスパターン

**影響:**
- セキュリティインシデント発生時の原因調査が困難
- 内部不正アクセスの検知が不可能
- コンプライアンス監査で必要な証跡が不足

**対策:**
- セキュリティ監査ログを設計し、以下を記録:
  - 認証イベント（成功/失敗、ユーザーID、IPアドレス、タイムスタンプ）
  - 認可失敗（403エラー時のリクエストパス、ユーザーID）
  - 機密データアクセス（患者ID、医療記録ID、操作種別、アクセス元ユーザー）
  - 管理者操作の完全な監査証跡
- CloudWatch Logs Insightsで異常パターン検知クエリを設計
- ログ改ざん防止のため、CloudWatch Logsのログ保持期間を90日以上に設定
- 重要ログはS3にエクスポートし、AWS CloudTrailで改ざん検知

**参照:** セクション6.2（ロギング方針）

---

### S2. 認証エンドポイントのレート制限設計欠落
**問題:**
API Gatewayで「1分あたり100リクエスト」のレート制限が設計されているが、これは全体的な制限であり、認証エンドポイント特化の保護が設計されていない。`POST /api/auth/login` に対するブルートフォース攻撃を防ぐ設計が欠落している。

**影響:**
- ブルートフォース攻撃により患者・医師アカウントが侵害される
- 医療データへの不正アクセス
- アカウントロックアウト機能がない場合、攻撃が無制限に継続可能

**対策:**
- 認証エンドポイント特化のレート制限を設計:
  - IPアドレスごとに1分間10回、1時間100回の試行制限
  - ユーザーアカウントごとに10回連続失敗でアカウント一時ロック（15分間）
- AWS WAFでIPベースのレート制限を設定
- 認証失敗時のセキュリティ監査ログを設計（前述S1と連携）
- CAPTCHAを3回失敗後に要求する設計を検討

**参照:** セクション3.2（主要コンポーネントの責務と依存関係）、セクション5.1（認証API）

---

### S3. CORS設定の欠落
**問題:**
フロントエンドがReact SPA、React Nativeアプリとして設計されているが、CORS（Cross-Origin Resource Sharing）設定が明記されていない。不適切なCORS設定は任意のドメインからのAPIアクセスを許可し、CSRFやデータ窃取のリスクを生む。

**影響:**
- 悪意のあるサイトから患者の認証情報を使ったAPIリクエストが可能
- CSRF攻撃により予約作成・キャンセルが不正に実行される

**対策:**
- CORS設定を明示的に設計:
  - `Access-Control-Allow-Origin`: 本番フロントエンドドメインのみ許可（ワイルドカード `*` 禁止）
  - `Access-Control-Allow-Credentials: true` を設定（Cookie送信を許可）
  - `Access-Control-Allow-Methods`: GET, POST, PUT, DELETE のみ許可
  - `Access-Control-Allow-Headers`: Authorization, Content-Type のみ許可
- Spring SecurityのCORS設定をコード化する設計を明記

**参照:** セクション3.1（全体構成）、セクション5.3（認証・認可方式）

---

### S4. 依存ライブラリの脆弱性管理設計欠落
**問題:**
セクション2.4で主要ライブラリが列挙されているが、脆弱性管理ポリシーが設計されていない。医療システムでは第三者ライブラリの脆弱性が直接患者データ侵害につながる。

**影響:**
- Spring Security、Hibernate、React等の既知脆弱性を悪用した攻撃
- Log4Shell、Spring4Shell等の重大脆弱性への対応遅延
- コンプライアンス要件（脆弱性パッチ適用期限）違反

**対策:**
- 依存ライブラリの脆弱性スキャンをCI/CDパイプラインに組み込む:
  - OWASP Dependency-Check、Snyk、GitHub Dependabotを使用
  - 重大度High以上の脆弱性検出時はビルド失敗
- 脆弱性パッチ適用ポリシーを設計:
  - Critical: 7日以内、High: 30日以内、Medium: 90日以内
- 定期的な依存ライブラリ更新（四半期ごと）を設計

**参照:** セクション2.4（主要ライブラリ）、セクション6.4（デプロイメント方針）

---

## 中程度の問題（Moderate Issues）

### M1. データ保持期間・削除ポリシーの欠落
**問題:**
患者データ、診察記録の保持期間や削除ポリシーが設計されていない。医療記録の法定保存期間（日本では5年）や個人情報保護法の要件に対応する設計が必要。

**影響:**
- GDPR「忘れられる権利」への対応不可
- 不要データの長期保存による侵害時の影響拡大
- コンプライアンス違反

**対策:**
- データ保持ポリシーを設計:
  - 診察記録: 最終診察から5年間保持（医療法準拠）
  - 予約データ: 予約完了後1年間保持
  - ログデータ: 90日間保持
- 論理削除と物理削除の設計（deleted_atカラム追加）
- 定期的な古いデータの自動削除バッチ処理を設計

**参照:** セクション4.1（主要エンティティと関連）

---

### M2. 内部通信の暗号化設計欠落
**問題:**
「すべての通信をTLS 1.3で暗号化」と記載されているが、これは外部通信を指すと思われる。バックエンド内部（Spring Boot ↔ PostgreSQL、Spring Boot ↔ Redis）の通信暗号化が明記されていない。

**影響:**
- AWS VPC内での通信傍受時にデータベースクエリや機密データが平文で漏洩
- 横展開攻撃（Lateral Movement）時のデータ窃取

**対策:**
- PostgreSQL接続にSSL/TLSを強制（`sslmode=require`）
- Redis接続にTLSを有効化（Redis 6以降のTLS in-transit encryption）
- 接続文字列の設計を明記

**参照:** セクション7.2（セキュリティ要件）

---

### M3. エラーメッセージの情報漏洩
**問題:**
セクション6.1で「エラーメッセージには詳細なスタックトレースを含め、デバッグを容易にする」と記載されているが、これは本番環境で情報漏洩を引き起こす。

**影響:**
- スタックトレースから内部実装、ファイルパス、ライブラリバージョンが漏洩
- 攻撃者が脆弱性を特定しやすくなる

**対策:**
- 環境別エラーレスポンス設計を明記:
  - 本番環境: 汎用エラーメッセージのみ（詳細はログに記録）
  - 開発環境: スタックトレース含む詳細情報
- Spring Bootの `server.error.include-stacktrace=never` 設定を明記

**参照:** セクション6.1（エラーハンドリング方針）

---

### M4. セッションタイムアウトの不備
**問題:**
JWT有効期限は1時間と記載されているが、アクティビティベースのセッションタイムアウト設計が欠落している。長時間放置されたブラウザから不正アクセスされるリスクがある。

**影響:**
- 医療従事者が院内PCでログインしたまま離席した場合の不正アクセス
- 患者のスマートフォン紛失時の長期間アクセス可能性

**対策:**
- アクティビティベースのセッションタイムアウトを設計（15分間操作なしでログアウト）
- フロントエンドで最終操作時刻を追跡し、タイムアウト時に自動ログアウト
- 重要操作（診察記録更新、予約キャンセル）時の再認証を検討

**参照:** セクション5.3（認証・認可方式）

---

## 軽微な改善点（Minor Improvements）

### I1. パスワードポリシーの明記
**問題:**
bcryptハッシュ化は記載されているが、パスワード要件（長さ、複雑性）が設計されていない。

**対策:**
- パスワードポリシーを設計: 最小12文字、英大小数字記号を含む
- パスワード有効期限（90日）を検討

**参照:** セクション4.2（usersテーブル）

---

### I2. API仕様書のアクセス制御
**問題:**
springdoc-openapiでAPI文書化が設計されているが、本番環境でのSwagger UI公開が設計されていない。

**対策:**
- 本番環境ではSwagger UIを無効化、またはIP制限・認証保護を設計

**参照:** セクション2.4（主要ライブラリ）

---

## 評価サマリ

本設計書は基本的な認証機構とインフラ構成は記載されているが、**医療情報を扱うシステムとして必須のセキュリティ設計が複数欠落している**。特に以下の4点は実装前に必ず設計・解決すべき重大な欠陥である:

1. **機密データの暗号化設計欠落**（C1）
2. **API認可設計の欠落**（C2）
3. **JWT保存方式の脆弱性**（C3）
4. **シークレット管理の不完全性**（C4）

これらの問題を放置して実装した場合、患者データの大規模漏洩、医療情報保護法違反、システム全体の侵害につながる重大なリスクが存在する。セキュリティ設計の全面的な見直しと、各評価基準（STRIDE、認証・認可、データ保護、入力検証、インフラセキュリティ）の体系的な設計追加を強く推奨する。
