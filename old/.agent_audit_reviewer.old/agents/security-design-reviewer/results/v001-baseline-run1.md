# セキュリティ設計レビュー結果

## 重大な問題（Critical Issues）

### C-1: JWT トークンの localStorage 保存によるXSS脆弱性
**場所**: セクション 5.3 認証・認可方式

**問題**:
設計書では「JWTトークンはlocalStorageに保存し」と記載されているが、これはXSS攻撃に対して極めて脆弱である。JavaScriptからアクセス可能なlocalStorageにトークンを保存すると、XSS攻撃が成功した場合、攻撃者は認証トークンを窃取し、ユーザーになりすまして医療情報にアクセスできる。

**影響**:
医療予約システムでは患者の個人情報（氏名、生年月日、住所、電話番号、保険証番号）や診察記録（診断内容、処方薬、検査結果）など極めて機密性の高い医療情報を扱う。トークン窃取により、攻撃者は患者情報の閲覧、予約の改ざん、診察記録の不正取得が可能となり、プライバシー侵害と医療安全上の深刻な被害をもたらす。

**対策**:
- HttpOnly属性付きCookieでJWTを保存し、JavaScriptからのアクセスを不可能にする
- Secure属性を付与してHTTPS通信でのみCookieを送信
- SameSite属性（Strict または Lax）でCSRF保護を強化
- Content Security Policy (CSP) を実装してXSS攻撃面を縮小

### C-2: API エンドポイントの認可チェック設計の欠如
**場所**: セクション 5.1 エンドポイント一覧、3.3 データフロー

**問題**:
設計書では「Spring Securityが各エンドポイントでJWT検証」とあるが、認証（authentication）のみが記載され、認可（authorization）の詳細設計が不足している。特に以下のケースで患者間・医療機関間のデータ漏洩リスクがある：
- `GET /api/patients/{id}` - 患者Aが患者Bの情報を取得可能
- `GET /api/appointments/{id}` - 他人の予約詳細を閲覧可能
- `GET /api/records/{id}` - 他患者の診察記録へのアクセス
- `PUT /api/patients/{id}`, `PUT /api/records/{id}` - 他人のデータ改ざん

**影響**:
医療情報の不正閲覧・改ざんにより、医療法・個人情報保護法違反、患者のプライバシー権侵害、医療機関の信頼失墜を招く。特に診察記録の改ざんは医療事故につながる可能性がある。

**対策**:
各エンドポイントで以下の認可チェックを明示的に設計：
- 患者API: リクエストユーザーIDとリソース所有患者IDの一致確認、または医療従事者ロール＋同一医療機関所属の確認
- 予約API: 予約の患者IDまたは医療機関IDがリクエストユーザーと一致することを検証
- カルテAPI: 医療従事者ロールかつ患者が自医療機関で受診した記録のみアクセス許可
- アノテーションベース（@PreAuthorize）またはインターセプターで一貫した認可ロジックを実装
- アクセス制御マトリクス（Role × Endpoint × Condition）を設計文書に明記

### C-3: エラーメッセージでのスタックトレース露出によるシステム情報漏洩
**場所**: セクション 6.1 エラーハンドリング方針

**問題**:
「エラーメッセージには詳細なスタックトレースを含め、デバッグを容易にする」という方針は、本番環境でシステム内部構造（パッケージ名、クラス名、ライブラリバージョン、ファイルパス）を攻撃者に露出する。これにより既知の脆弱性を持つライブラリの特定や、攻撃対象の絞り込みが容易になる。

**影響**:
攻撃者はスタックトレース情報から使用技術スタック（Spring Boot 3.2、Hibernate 6.4等）を特定し、公開されている脆弱性（CVE）を利用した攻撃を仕掛けることができる。また、ファイルパスからディレクトリ構造を推測し、パストラバーサル攻撃などの足がかりとなる。

**対策**:
- 本番環境では汎用的なエラーメッセージのみをクライアントに返却（例: "Internal Server Error"）
- スタックトレースはサーバーサイドログにのみ記録し、ログ管理システムでアクセス制御
- 開発環境と本番環境で異なるエラーハンドリング設定を適用
- エラーレスポンスに一意なエラーIDを含め、サポート時にサーバーログと紐付け

### C-4: ログへの機微情報出力によるプライバシー侵害
**場所**: セクション 6.2 ロギング方針

**問題**:
「すべてのAPIリクエスト・レスポンスをINFOレベルでログ出力」「requestBodyをログ記録」とあるが、これにより以下の機微情報がログに記録される：
- パスワード（`POST /api/auth/register`, `POST /api/auth/login`のリクエストボディ）
- 患者の個人情報（氏名、生年月日、住所、電話番号、保険証番号）
- 診察記録（診断内容、処方薬、検査結果）

ログはCloudWatch Logsに転送されるが、ログへのアクセス制御やマスキング設計が明記されていない。

**影響**:
ログアクセス権限を持つ開発者・運用担当者が医療情報を閲覧可能となり、医療法・個人情報保護法違反、内部関係者による情報漏洩リスクが発生する。パスワードがログに残る場合、ログファイル侵害時にアカウント乗っ取りが可能。

**対策**:
- パスワード・トークン・個人識別情報をログ出力前にマスキング（例: `"password": "***"`, `"full_name": "患者****"`）
- ログ出力前のサニタイゼーション処理を実装（専用Filterやインターセプター）
- 機微情報を含むリクエストボディはログに記録しない、またはハッシュ値のみ記録
- CloudWatch Logsへのアクセスを最小権限原則で制限（IAMポリシー）
- ログ保持期間を定義し、医療情報の保存期間ポリシーと整合性を確保
- 監査ログとアプリケーションログを分離し、機微情報は監査ログにのみ記録

## 重要な問題（Significant Issues）

### S-1: CSRF保護の設計欠如
**場所**: セクション 5.3 認証・認可方式、3.3 データフロー

**問題**:
JWT認証の設計は記載されているが、CSRF（Cross-Site Request Forgery）対策が明記されていない。特に状態変更を伴うエンドポイント（`POST /api/appointments`, `PUT /api/appointments/{id}`, `DELETE /api/appointments/{id}`, `POST /api/records`, `PUT /api/records/{id}`）でCSRF攻撃が可能である。

**影響**:
攻撃者が罠サイトを用意し、ログイン済みユーザーを誘導することで、ユーザーの意図しない予約作成・キャンセル、診察記録の改ざんが可能となる。医療予約の不正操作は患者の受診機会喪失や医療機関の運営混乱を招く。

**対策**:
- Double Submit Cookie パターン: CSRFトークンをCookieとリクエストボディ/ヘッダーの両方で送信し、サーバー側で一致検証
- SameSite Cookie属性（Strict または Lax）で他サイトからのCookie送信を制限
- Spring SecurityのCSRF保護機能を有効化し、状態変更エンドポイントにCSRFトークン検証を適用
- カスタムヘッダー（X-Requested-With: XMLHttpRequest）による検証を併用

### S-2: レート制限の不十分な設計
**場所**: セクション 3.2 主要コンポーネントの責務と依存関係

**問題**:
API Gatewayで「1分あたり100リクエスト」というグローバルなレート制限が記載されているが、エンドポイント単位・ユーザー単位のレート制限が設計されていない。特に以下のエンドポイントで悪用リスクがある：
- `POST /api/auth/login` - ブルートフォース攻撃
- `POST /api/auth/register` - スパムアカウント作成
- `POST /api/appointments` - 予約枠の占拠攻撃

**影響**:
ブルートフォース攻撃によるアカウント侵害、スパム登録による医療機関データベースの汚染、予約枠の大量確保による正規ユーザーの利用阻害、APIリソースの消費によるDoS状態が発生する。

**対策**:
- 認証エンドポイント: IPアドレスごとに5回/分、ユーザー名ごとに3回/5分のレート制限
- 予約作成: ユーザーごとに10回/時間のレート制限
- レート制限超過時は429 Too Many Requestsを返却し、Retry-Afterヘッダーで再試行時刻を通知
- AWS WAFまたはAPI Gatewayのスロットリング機能を活用
- Redis等で分散レート制限カウンターを実装

### S-3: JWTトークンの無効化メカニズムの欠如
**場所**: セクション 5.3 認証・認可方式、5.1 認証API

**問題**:
JWT認証の設計はあるが、トークンの無効化（ログアウト、パスワード変更時、不正アクセス検出時）の仕組みが明記されていない。JWTはステートレスであるため、トークンが漏洩した場合、有効期限（1時間）まで悪用される。

**影響**:
トークン窃取時やデバイス紛失時に、ログアウトしてもトークンが有効なまま残り、最大1時間（アクセストークン）または30日間（リフレッシュトークン）の不正アクセスが可能。医療情報への不正アクセスが継続する。

**対策**:
- トークンブラックリスト方式: Redisに無効化トークンIDを保存し、各リクエストで検証
- トークンバージョニング: ユーザーテーブルにtoken_versionカラムを追加し、パスワード変更時にインクリメント。JWTペイロードのバージョンと比較検証
- 短い有効期限（アクセストークン15分、リフレッシュトークン7日間）に変更
- セッション管理の併用: 重要操作（診察記録更新、予約キャンセル）では追加の再認証を要求

### S-4: 入力検証の詳細設計不足
**場所**: セクション 7.2 セキュリティ要件

**問題**:
「外部入力はSpring Validationで検証」とあるが、具体的な検証ルールが明記されていない。医療情報システムでは以下の入力に対する厳密な検証が必要：
- 氏名・住所: 特殊文字によるスクリプトインジェクション
- メールアドレス: フォーマット検証不備による不正値登録
- 電話番号: 数値以外の文字によるデータ汚染
- 診察記録・処方薬: SQLインジェクション、NoSQLインジェクション

**影響**:
不十分な入力検証により、XSS攻撃（診察記録に悪意あるスクリプトを埋め込み、医療従事者の閲覧時に実行）、SQLインジェクション（PreparedStatementの使用は記載されているが、動的クエリ構築箇所でのリスク）、データ整合性の破壊が発生する。

**対策**:
- Bean Validationアノテーション（@NotNull, @Size, @Pattern, @Email）で各フィールドに検証ルールを定義
- カスタムバリデータで医療固有のルール実装（例: 保険証番号フォーマット）
- ホワイトリスト方式の入力検証（許可文字セットを明確化）
- 出力時のエスケープ処理（HTML, JSON, SQL）を実装
- 診察記録などのテキストフィールドに最大長制限（例: 5000文字）を設定

### S-5: 医療機関間のテナント分離設計の欠如
**場所**: セクション 3.1 全体構成、4.1 主要エンティティと関連

**問題**:
複数の医療機関が同一システムを利用する設計だが、医療機関間のデータ分離（マルチテナント分離）の設計が明記されていない。データモデルでは `medical_institutions` テーブルが存在するが、診察記録や予約データに医療機関IDでのフィルタリングが明示されていない。

**影響**:
医療機関Aの医師が医療機関Bの患者データや診察記録にアクセスできる脆弱性が発生し、医療機関間での情報漏洩、医療法違反のリスクがある。

**対策**:
- 全クエリに医療機関IDフィルタを強制適用（Row-Level Security または JPAフィルター）
- Spring SecurityのMultiTenancyFilterで現在の医療機関コンテキストを管理
- ユーザーテーブルに所属医療機関ID（institution_id）を追加し、認証時にコンテキストに設定
- データベース設計でテナント分離を保証（appointmentsやmedical_recordsに `institution_id` カラムを追加し、複合インデックスを設定）

## 中程度の問題（Moderate Issues）

### M-1: リフレッシュトークンの保存と管理設計の不明確さ
**場所**: セクション 5.3 認証・認可方式

**問題**:
リフレッシュトークンの保存場所（クライアント側）と管理方法（サーバー側での検証・無効化）が明記されていない。JWTと同様にlocalStorageに保存する場合、XSS攻撃で30日間有効なトークンが窃取される。

**対策**:
- リフレッシュトークンはHttpOnly Cookie で保存
- サーバー側でリフレッシュトークンをデータベース（またはRedis）に保存し、使用済みトークンのローテーションを実装
- リフレッシュトークン使用時に新しいペアを発行し、古いトークンを無効化
- デバイスごとのリフレッシュトークン管理（ユーザーが複数デバイスでログイン可能な場合）

### M-2: パスワードポリシーの設計欠如
**場所**: セクション 7.2 セキュリティ要件

**問題**:
「パスワードはbcryptでハッシュ化」とあるが、パスワードの複雑性要件（最小長、文字種の組み合わせ）、パスワード変更ポリシー、使い回し防止の設計が明記されていない。

**対策**:
- パスワードポリシー: 最小12文字、英大文字・小文字・数字・記号を各1文字以上含む
- パスワード履歴管理: 過去5世代のパスワードハッシュを保存し、再利用を禁止
- パスワードリセット機能: メールによるワンタイムトークン（有効期限15分）を使用
- アカウントロックアウト: 5回の連続ログイン失敗で15分間ロック

### M-3: ファイルアップロード機能のセキュリティ設計欠如
**場所**: セクション 2.3 インフラ・デプロイ環境（Amazon S3の記載）

**問題**:
「ストレージ: Amazon S3（画像・ドキュメント）」とあるが、ファイルアップロード機能の詳細（対象ファイル種別、サイズ制限、アクセス制御）が不明確。医療画像や検査結果PDFのアップロードが想定されるが、セキュリティ対策が設計されていない。

**対策**:
- 許可ファイル形式のホワイトリスト定義（例: JPEG, PNG, PDF）
- MIMEタイプとファイル拡張子の二重検証（Content-Typeヘッダーとファイルシグネチャ）
- ファイルサイズ上限設定（例: 10MB）
- ウイルススキャン（ClamAV等）の実装
- S3バケットポリシーで公開アクセスを禁止し、署名付きURL（有効期限付き）で配信
- アップロードファイル名のサニタイゼーション（パストラバーサル防止）

### M-4: データベース暗号化の設計不足
**場所**: セクション 7.2 セキュリティ要件

**問題**:
「すべての通信をTLS 1.3で暗号化」とあるが、保存データ（data at rest）の暗号化設計が明記されていない。特に患者の個人情報（保険証番号）や診察記録は平文でデータベースに保存されるリスクがある。

**対策**:
- PostgreSQLの透過的データ暗号化（TDE）またはAWS RDS暗号化を有効化
- 特に機微な列（insurance_number, diagnosis, prescription）にアプリケーションレベルの列暗号化を適用
- 暗号鍵管理にAWS KMS（Key Management Service）を使用
- バックアップデータの暗号化を確認

### M-5: セキュリティ監査ログの設計不足
**場所**: セクション 6.2 ロギング方針

**問題**:
アプリケーションログの方針は記載されているが、セキュリティ監査ログ（認証失敗、権限エラー、機微データアクセス、設定変更）の設計が不十分。

**対策**:
- セキュリティイベントの監査ログを別ストリームで記録
  - ログイン成功/失敗（ユーザー名、IPアドレス、タイムスタンプ）
  - 認可エラー（アクセス拒否されたリソースとユーザー）
  - 患者情報・診察記録へのアクセス（読み取り・更新・削除）
  - 管理者による設定変更（医療機関追加、ユーザーロール変更）
- 監査ログの改ざん防止（書き込み専用ストレージ、署名）
- 監査ログの長期保存（医療法で定められた保存期間に準拠）
- 異常検知: ログイン失敗の急増、通常時間外のアクセスをアラート

### M-6: 依存ライブラリの脆弱性管理設計の不足
**場所**: セクション 2.4 主要ライブラリ

**問題**:
使用ライブラリのバージョンは明記されているが、脆弱性スキャンと更新ポリシーが設計されていない。Spring Boot 3.2、Hibernate 6.4等のライブラリに脆弱性が発見された場合の対応手順が不明確。

**対策**:
- 依存関係スキャンツール（OWASP Dependency-Check, Snyk, Trivy）をCIパイプラインに組み込み
- 重大度High以上の脆弱性が検出された場合、ビルドを失敗させる
- 定期的な依存関係更新スケジュール（月次）を定義
- セキュリティアドバイザリ（CVE）の監視体制を確立
- 脆弱性対応のSLA定義（Critical: 7日以内、High: 30日以内にパッチ適用）

## 軽微な改善点（Minor Issues）

### I-1: CORS設定の詳細欠如
**場所**: セクション 3.1 全体構成

**問題**:
「コンポーネント間の通信はHTTPS + JSON形式」とあるが、CORS（Cross-Origin Resource Sharing）の設定が明記されていない。

**対策**:
- 許可するオリジンをホワイトリスト化（例: `https://patient-app.example.com`, `https://admin.example.com`）
- ワイルドカード（`*`）の使用を禁止
- 許可HTTPメソッドとヘッダーを明示的に定義
- クレデンシャル（Cookie）送信時は `Access-Control-Allow-Credentials: true` と明示的なオリジン指定が必要

### I-2: セッションタイムアウトの設計明記
**場所**: セクション 5.3 認証・認可方式

**問題**:
JWTの有効期限（1時間）は記載されているが、ユーザーの非アクティブ時の自動ログアウト（セッションタイムアウト）が設計されていない。

**対策**:
- 非アクティブ30分でアクセストークンを無効化
- クライアント側でアクティビティ監視（キーボード入力、マウス移動）を実装
- タイムアウト1分前に警告ダイアログを表示し、継続の意思確認

### I-3: HTTPセキュリティヘッダーの明記
**場所**: セクション 7.2 セキュリティ要件

**問題**:
TLS暗号化は記載されているが、HTTPセキュリティヘッダー（CSP, X-Frame-Options等）の設計が不足。

**対策**:
以下のヘッダーを全レスポンスに含める設計を明記：
- `Content-Security-Policy: default-src 'self'; script-src 'self'` （XSS対策）
- `X-Frame-Options: DENY` （クリックジャッキング対策）
- `X-Content-Type-Options: nosniff` （MIMEスニッフィング対策）
- `Strict-Transport-Security: max-age=31536000; includeSubDomains` （HTTPS強制）
- `Referrer-Policy: strict-origin-when-cross-origin` （リファラー情報漏洩対策）

## ポジティブな点

### P-1: 基本的な暗号化設計
TLS 1.3による通信暗号化とbcryptによるパスワードハッシュ化（コスト係数10）は適切な選択である。

### P-2: PreparedStatementによるSQLインジェクション対策
「SQLインジェクション対策としてPreparedStatementを使用」と明記されており、基本的な対策が設計されている。

### P-3: Multi-AZ構成による可用性確保
データベースのMulti-AZ構成と定期バックアップにより、障害時のデータ損失リスクが軽減されている。

### P-4: レート制限の導入
API Gatewayでのレート制限が設計されており、DoS攻撃に対する基礎的な防御が考慮されている（詳細設計は改善が必要）。

## 総合評価

本設計書は基本的なセキュリティ要素（TLS暗号化、パスワードハッシュ化、JWT認証）を含んでいるが、医療情報システムに求められるセキュリティレベルには重大な不足がある。

**最優先で対処すべき問題**:
1. JWTのlocalStorage保存（XSS脆弱性） → HttpOnly Cookie化
2. APIエンドポイントの認可チェック欠如 → 所有者検証の実装
3. エラーメッセージのスタックトレース露出 → 本番環境での情報制限
4. ログへの機微情報出力 → マスキング処理の実装

これらは患者の医療情報漏洩に直結するため、実装前に設計を修正する必要がある。また、CSRF対策、レート制限の詳細化、トークン無効化メカニズム、テナント分離設計など、重要な問題についても早期に対処すべきである。
