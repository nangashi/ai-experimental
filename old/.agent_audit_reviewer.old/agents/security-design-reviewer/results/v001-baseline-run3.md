# セキュリティ評価レポート: リアルタイム医療予約システム

## Critical Issues（重大な問題）

### C1. カルテAPIにおける患者データアクセス制御の欠如
**問題箇所**: セクション5.1「カルテAPI」
**問題内容**: `GET /api/records/{id}` および `PUT /api/records/{id}` エンドポイントに、患者本人確認や医療従事者の権限検証が設計されていない。任意の認証済みユーザーが記録IDを推測することで、他人のカルテにアクセス可能となる。

**影響分析**:
- 医療情報という極めて機微な個人情報の漏洩リスク
- プライバシー侵害による法的責任（個人情報保護法、医療法違反）
- システム全体の信頼性喪失

**推奨対策**:
- カルテAPIに患者ID・医療機関IDとの関連性検証を追加
- 医療従事者の場合、所属医療機関と対象患者の予約関係を確認
- 患者の場合、patient_idとJWTペイロードのuserIdの一致を検証
- 監査ログに全カルテアクセスを記録（セクション5参照）

### C2. 患者情報APIにおける認可設計の不在
**問題箇所**: セクション5.1「患者API」
`GET /api/patients/{id}` および `PUT /api/patients/{id}` に、リソース所有者検証が明記されていない。

**影響分析**:
- 氏名、生年月日、住所、電話番号、保険証番号などPIIの大量漏洩
- なりすましによる予約・診察記録の改ざん
- 医療機関の信頼失墜、損害賠償請求

**推奨対策**:
- 患者本人のみ自身のデータにアクセス可能とする所有権検証
- 医療従事者は、診察予約が存在する患者のみ閲覧可能とする関連性検証
- 管理者は全データアクセス可能だが、監査ログに記録

### C3. 予約APIにおけるテナント分離設計の欠如
**問題箇所**: セクション5.1「予約API」
`GET /api/appointments`、`PUT /api/appointments/{id}`、`DELETE /api/appointments/{id}` に、予約の所有権・所属医療機関の検証設計が存在しない。

**影響分析**:
- 患者Aが患者Bの予約をキャンセル・変更可能
- 医療機関Xの従事者が医療機関Yの予約を閲覧・操作可能
- 医療サービスの混乱、不正請求の可能性

**推奨対策**:
- 患者ロール: JWTのuserIdから導出されるpatient_idと予約のpatient_idの一致検証
- 医療従事者ロール: 予約のinstitution_idと従事者の所属医療機関IDの一致検証
- 予約変更・キャンセル時の所有権検証を明示的に設計

### C4. JWT署名鍵の管理設計が不明
**問題箇所**: セクション5.3「認証・認可方式」
JWT発行に使用する署名鍵の生成方法、保存場所、ローテーション方針が一切記載されていない。

**影響分析**:
- 署名鍵が漏洩した場合、攻撃者が任意のロール・ユーザーIDでトークンを偽造可能
- 全ユーザーへのなりすまし、管理者権限の不正取得
- システム全体のセキュリティ基盤の崩壊

**推奨対策**:
- 署名アルゴリズムをHS256からRS256（非対称鍵）に変更
- 秘密鍵はAWS Secrets ManagerまたはParameter Store（SecureString）で管理
- 定期的な鍵ローテーション（例: 90日ごと）と古いトークンの無効化手順を設計
- 環境変数やコードへの埋め込みを禁止

### C5. JWTのlocalStorage保存によるXSS脆弱性
**問題箇所**: セクション5.3「認証・認可方式」
「JWTトークンはlocalStorageに保存」と明記されているが、これはXSS攻撃によるトークン窃取リスクを増大させる。

**影響分析**:
- XSS脆弱性が存在する場合、JavaScriptからlocalStorageに直接アクセス可能
- 攻撃者が患者のJWTを取得し、カルテ・個人情報にアクセス
- 医療従事者のトークン窃取による診察記録の改ざん

**推奨対策**:
- JWTをHttpOnly, Secure, SameSite=Strict属性付きCookieに保存
- CSRF対策として、Cookieとは別にカスタムヘッダーでトークン送信（Double Submit Cookie）
- またはBFF（Backend For Frontend）パターンでセッション管理を行う

### C6. リフレッシュトークンの保存・無効化設計の欠如
**問題箇所**: セクション5.3「認証・認可方式」
リフレッシュトークンの保存場所、無効化メカニズム、ログアウト時の処理が設計されていない。

**影響分析**:
- ログアウト後もリフレッシュトークンが有効なまま残存
- デバイス紛失時にトークンを無効化できず、30日間不正アクセス可能
- セッション乗っ取りの長期化

**推奨対策**:
- リフレッシュトークンをデータベース（またはRedis）に保存し、発行履歴を管理
- ログアウト時にリフレッシュトークンを無効化（ブラックリスト登録またはDB削除）
- デバイス単位でのセッション管理機能を追加（複数デバイスログイン時の個別無効化）

---

## Significant Issues（重要な問題）

### S1. 診察履歴APIにおける認可チェックの欠如
**問題箇所**: セクション5.1「患者API」
`GET /api/patients/{id}/records` に、患者本人または担当医療従事者のみがアクセス可能とする設計が明記されていない。

**影響分析**:
- 過去の診断内容、処方薬、検査結果など機微な医療情報の漏洩
- 患者IDを変更するだけで他人の病歴にアクセス可能

**推奨対策**:
- 患者ロール: JWTのuserIdから導出されるpatient_idとパスパラメータの一致検証
- 医療従事者ロール: 該当患者との診察履歴（appointments）の存在確認
- 管理者ロール: 全アクセス許可だが監査ログに記録

### S2. 予約一覧取得APIのフィルタリング設計の不備
**問題箇所**: セクション5.1「予約API」
`GET /api/appointments` の仕様に、取得範囲のフィルタリング条件（自分の予約のみ、所属医療機関の予約のみ）が明記されていない。

**影響分析**:
- 全ユーザーの予約情報が閲覧可能になる可能性
- 患者の通院先、診療科などプライバシー情報の漏洩

**推奨対策**:
- 患者ロール: 自分のpatient_idに紐づく予約のみ返却
- 医療従事者ロール: 所属医療機関のinstitution_idに紐づく予約のみ返却
- クエリパラメータによるフィルタリングではなく、サーバー側で強制的に適用

### S3. エラーメッセージにおける情報漏洩リスク
**問題箇所**: セクション6.1「エラーハンドリング方針」
「エラーメッセージには詳細なスタックトレースを含め、デバッグを容易にする」と記載されているが、本番環境でのスタックトレース露出は攻撃者に有益な情報を提供する。

**影響分析**:
- サーバー内部のディレクトリ構造、使用ライブラリのバージョン情報の漏洩
- 攻撃対象となる脆弱性の特定が容易になる
- SQL文やファイルパスの露出による更なる攻撃の足がかり

**推奨対策**:
- 本番環境ではスタックトレースを含まない汎用エラーメッセージのみ返却
- 詳細エラー情報はサーバー側のログにのみ記録
- 環境変数で制御し、開発環境のみ詳細情報を表示

### S4. ログ出力における機微情報の記録
**問題箇所**: セクション6.2「ロギング方針」
「すべてのAPIリクエスト・レスポンスをINFOレベルでログ出力」および `"requestBody": "{...}"` の記録設計。

**影響分析**:
- パスワード、保険証番号、診断内容などがログに平文記録される
- ログへのアクセス権を持つ開発者・運用担当者による情報漏洩リスク
- ログ保管システムの侵害時に大量の個人情報流出

**推奨対策**:
- パスワード、トークン、保険証番号、診断内容などをマスキングまたはログ記録対象から除外
- リクエストボディの全記録を避け、重要フィールドのみホワイトリスト方式で記録
- ログアクセスの監査とアクセス制御を厳格化

### S5. セキュリティ監査ログ設計の不足
**問題箇所**: セクション5.3、6.2（全体）
認証失敗、権限変更、機微データアクセスなど、セキュリティイベントの監査ログ設計が存在しない。

**影響分析**:
- 不正アクセスやデータ漏洩の検知が困難
- インシデント発生時の原因調査・影響範囲特定が不可能
- コンプライアンス要件（医療情報システムの安全管理ガイドライン）への不適合

**推奨対策**:
- 以下のイベントを監査ログとして記録:
  - ログイン成功/失敗（ユーザー名、IPアドレス、タイムスタンプ）
  - カルテ・患者情報へのアクセス（誰が、いつ、どの患者の情報を閲覧したか）
  - ロール変更、医療機関の登録・削除
  - 予約の作成・変更・削除（特に他人の予約操作の試行）
- 監査ログは改ざん防止のため、別系統のストレージ（S3 + Object Lock）に保存
- 定期的なログレビューとアラート設定

### S6. CORS設定の具体的な制御が不明
**問題箇所**: セクション3「アーキテクチャ設計」
CORSについて評価基準で言及されているが、設計書に具体的な許可オリジンやHTTPメソッド制限が記載されていない。

**影響分析**:
- ワイルドカード（`*`）設定による、悪意のあるサイトからのAPI呼び出し許可
- CSRF攻撃のリスク増大
- 予約作成・カルテ更新などの機密操作が外部サイトから実行される可能性

**推奨対策**:
- 許可するオリジンを明示的にホワイトリスト化（例: `https://app.example.com`）
- 許可するHTTPメソッドを限定（GET, POST, PUT, DELETE のみ）
- `Access-Control-Allow-Credentials: true` 使用時はワイルドカード禁止
- プリフライトリクエストの適切な処理を設計

### S7. ファイルアップロード機能のセキュリティ設計欠如
**問題箇所**: セクション2.3「インフラ・デプロイ環境」
「Amazon S3（画像・ドキュメント）」と記載されているが、アップロードの検証・制限設計が存在しない。

**影響分析**:
- マルウェア、実行可能ファイルのアップロードによるサーバー侵害
- 大容量ファイルアップロードによるDoS攻撃
- 不適切なファイルの保存によるストレージコスト増大

**推奨対策**:
- ファイルタイプ検証（MIMEタイプだけでなくマジックバイトで検証）
- 許可する拡張子をホワイトリスト化（.jpg, .png, .pdf など）
- ファイルサイズ上限の設定（例: 5MB）
- ウイルススキャン（ClamAV、AWS Security Hubなど）
- S3バケットポリシーで公開アクセスをブロック、署名付きURL経由のアクセスのみ許可

---

## Moderate Issues（中程度の問題）

### M1. パスワードポリシーの具体的要件が不明
**問題箇所**: セクション7.2「セキュリティ要件」
パスワードハッシュ化は記載されているが、強度要件（長さ、複雑性）や変更ポリシーが設計されていない。

**推奨対策**:
- 最小長12文字以上、大小英字・数字・記号の組み合わせを推奨
- よく使われるパスワード（"Password123"など）のブラックリスト検証
- 定期的な変更強制は避け、侵害検知時のみ変更を促す（NIST推奨）

### M2. セッションタイムアウトポリシーの詳細設計欠如
**問題箇所**: セクション5.3「認証・認可方式」
JWTの有効期限は記載されているが、アイドルタイムアウトや医療従事者向けの短縮設定が設計されていない。

**推奨対策**:
- 患者向け: 30分間操作なしで再認証要求
- 医療従事者向け: 15分間操作なしで自動ログアウト（カルテアクセス権限のため）
- 管理者向け: 5分間操作なしで再認証要求

### M3. APIレート制限の粒度と適切性
**問題箇所**: セクション3.2「主要コンポーネントの責務と依存関係」
「1分あたり100リクエスト」とあるが、エンドポイントごとの差別化やIPアドレス・ユーザー単位の制限設計がない。

**推奨対策**:
- ログインAPI: IPアドレス単位で1分間5回まで（ブルートフォース対策）
- 予約作成API: ユーザー単位で1分間10回まで（スパム予約防止）
- 検索API: 1分間30回まで（通常使用に支障なし）
- 段階的なペナルティ（警告→一時ブロック→永久ブロック）

### M4. データ保存時の暗号化設計が不明
**問題箇所**: セクション4「データモデル」、セクション7.2「セキュリティ要件」
通信の暗号化は記載されているが、データベース内の保存データ（特に保険証番号、診断内容）の暗号化が設計されていない。

**推奨対策**:
- PostgreSQL Transparent Data Encryption (TDE) または AWS RDS暗号化を有効化
- 特に機微なカラム（insurance_number, diagnosis, prescription）はアプリケーションレベルで暗号化（AES-256）
- 暗号化キーはAWS KMSで管理

### M5. SQLインジェクション対策の実装検証不足
**問題箇所**: セクション7.2「セキュリティ要件」
「PreparedStatementを使用する」と記載されているが、Spring Data JPAのネイティブクエリやカスタムクエリでの対策が明記されていない。

**推奨対策**:
- すべてのカスタムクエリ（@Query）でパラメータバインディングを強制
- ネイティブSQL使用時はパラメータプレースホルダ（`?`、`:name`）を必須とする
- コードレビューチェックリストに「文字列連結によるSQL構築の禁止」を追加

### M6. NoSQLインジェクション対策の欠如
**問題箇所**: セクション2.2「データベース」、セクション7.2「セキュリティ要件」
Redisを使用しているが、インジェクション対策が記載されていない。

**推奨対策**:
- Redisコマンドに外部入力を直接埋め込まない
- キー名に使用する値はホワイトリスト検証または厳格なサニタイゼーション
- Redis認証（requirepass）の設定と、接続元IPアドレスの制限

### M7. XSS対策の具体的設計が不明
**問題箇所**: セクション7.2「セキュリティ要件」
Spring Validationで検証と記載されているが、出力エスケープ設計が明記されていない。

**推奨対策**:
- React側でdangerouslySetInnerHTMLの使用禁止
- サーバー側でContent-Security-Policy (CSP) ヘッダーを設定
- ユーザー入力を含むデータのレンダリング時、自動エスケープを確認

### M8. CSRF保護設計の不足
**問題箇所**: セクション5.3「認証・認可方式」
JWTベース認証を採用しているが、CSRF対策が明記されていない。

**推奨対策**:
- Spring SecurityのCSRF保護を有効化
- カスタムヘッダー（X-CSRF-Token）による二重送信Cookie方式
- またはSameSite=Strict Cookie属性の活用

---

## Minor Improvements（軽微な改善点）

### I1. 多要素認証（MFA）の検討
医療情報の機微性を考慮し、医療従事者および管理者ロールに対してMFA（TOTPまたはSMS）の導入を推奨。

### I2. 脆弱性スキャンの自動化
セクション2.4「主要ライブラリ」で依存関係を記載しているが、Dependabot、Snyk、Trivyなどの自動脆弱性スキャンツール導入を推奨。

### I3. API Gatewayレベルでの入力検証
AWS API GatewayのRequest Validationを活用し、バックエンド到達前に不正リクエストを遮断。

### I4. データ保持期限とGDPR対応
患者データの保持期限、削除ポリシー、本人による削除要求（Right to be Forgotten）への対応設計を追加推奨。

---

## Positive Aspects（評価できる点）

1. **TLS 1.3の採用**: 最新の暗号化プロトコルによる通信保護
2. **bcryptによるパスワードハッシュ化**: 適切なハッシュアルゴリズムの選択
3. **Multi-AZ構成**: 可用性向上とデータ保護
4. **定期的なバックアップ**: データ損失リスクの軽減
5. **API Gateway + レート制限**: DoS攻撃の基本的な対策

---

## まとめ

本設計書は医療情報システムとしての基本的なアーキテクチャは整っているものの、**認可設計の欠如**という致命的な問題を抱えています。特に、患者データ・カルテ・予約APIにおける所有権検証が設計されていないため、現状のままでは他人の医療情報に容易にアクセス可能です。

最優先で対応すべきは**C1～C6の重大問題**であり、特にAPI単位の認可チェック設計とJWT管理の見直しが不可欠です。また、S1～S7の重要問題も、医療情報保護の観点から早期対応が必要です。

これらの対策を実装せずにシステムを稼働させることは、個人情報保護法違反、医療法違反、損害賠償請求などの重大なリスクを伴います。全Critical/Significant問題の解決を、リリース前の必須条件として設定することを強く推奨します。
