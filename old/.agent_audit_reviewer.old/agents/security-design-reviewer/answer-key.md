# 正解キー

## 実行条件
- **観点**: セキュリティ（設計レビュー）
- **入力型**: 設計書
- **埋め込み問題数**: 15問

## 埋め込み問題一覧

### P01: JWTトークンをlocalStorageに保存
- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **検出難易度**: easy
- **該当箇所**: セクション5.3（認証・認可方式）
- **問題の説明**: JWTトークンをlocalStorageに保存する設計は、XSS攻撃時にトークンが漏洩するリスクがある。HttpOnly属性付きCookieの使用が推奨される。
- **検出判定基準**:
  - ○（検出）: JWTをlocalStorageに保存することのXSS脆弱性リスク、またはHttpOnly Cookie推奨を明示的に指摘している
  - △（部分検出）: トークンの保存方式に関する一般的なセキュリティ懸念に言及しているが、XSS脆弱性やlocalStorageの具体的リスクに触れていない
  - ×（未検出）: 認証設計について言及がない、または保存方式の問題を指摘していない

### P02: CSRF対策の欠如
- **カテゴリ**: 入力検証・攻撃防御
- **深刻度**: 中
- **検出難易度**: medium
- **該当箇所**: セクション5全体（API設計）
- **問題の説明**: state-changing API（POST/PUT/DELETE）にCSRF対策の設計が記載されていない。CORSだけでは不十分で、CSRFトークンまたはSameSite Cookie属性が必要。
- **検出判定基準**:
  - ○（検出）: CSRF対策（CSRFトークン、SameSite Cookie等）の欠如を明示的に指摘している
  - △（部分検出）: state-changing APIのセキュリティ対策に関する一般的な懸念を述べているが、CSRF対策の具体的な欠如を指摘していない
  - ×（未検出）: CSRF対策に関する言及がない

### P03: CORS設定の未定義
- **カテゴリ**: 入力検証・攻撃防御
- **深刻度**: 中
- **検出難易度**: medium
- **該当箇所**: セクション3、5（アーキテクチャ設計、API設計）
- **問題の説明**: CORSポリシーが設計書に記載されていない。SPAとAPIの分離構成において、許可するオリジンを明示する必要がある。
- **検出判定基準**:
  - ○（検出）: CORS設定が未定義であることを指摘し、許可オリジンの明示やワイルドカード禁止を提案している
  - △（部分検出）: オリジン間通信のセキュリティに一般的に言及しているが、CORS設定の欠如を具体的に指摘していない
  - ×（未検出）: CORS設定に関する言及がない

### P04: 認証エンドポイントのレート制限欠如
- **カテゴリ**: 入力検証・攻撃防御
- **深刻度**: 中
- **検出難易度**: medium
- **該当箇所**: セクション3.2（主要コンポーネントの責務と依存関係）、セクション5.1（認証API）
- **問題の説明**: API Gatewayにレート制限（1分100リクエスト）は設定されているが、認証エンドポイント専用のレート制限（ブルートフォース攻撃対策）が記載されていない。ログイン試行回数制限やアカウントロックアウトが必要。
- **検出判定基準**:
  - ○（検出）: 認証エンドポイント専用のレート制限、ブルートフォース対策、またはアカウントロックアウトの欠如を明示的に指摘している
  - △（部分検出）: 全体的なレート制限には言及しているが、認証エンドポイント固有の対策の必要性を指摘していない
  - ×（未検出）: 認証エンドポイントのレート制限に関する言及がない

### P05: エラーメッセージの過度な情報露出
- **カテゴリ**: 脅威モデリング（Information Disclosure）
- **深刻度**: 中
- **検出難易度**: easy
- **該当箇所**: セクション6.1（エラーハンドリング方針）
- **問題の説明**: エラーレスポンスに「詳細なスタックトレース」を含める設計は、攻撃者に内部実装の情報を与えるリスクがある。本番環境ではスタックトレースを公開すべきでない。
- **検出判定基準**:
  - ○（検出）: エラーレスポンスのスタックトレース露出リスク、または本番環境での情報露出を明示的に指摘している
  - △（部分検出）: エラーハンドリングの一般的なセキュリティ懸念に言及しているが、スタックトレース露出の具体的リスクに触れていない
  - ×（未検出）: エラーレスポンスのセキュリティに関する言及がない

### P06: ログへの機密データ出力
- **カテゴリ**: データ保護
- **深刻度**: 重大
- **検出難易度**: easy
- **該当箇所**: セクション6.2（ロギング方針）
- **問題の説明**: すべてのリクエスト・レスポンスをログ出力する方針は、パスワード、保険証番号、診断内容等の機密データをログに記録するリスクがある。PII・PHIのマスキングまたはログ除外が必要。
- **検出判定基準**:
  - ○（検出）: リクエストボディのログ出力による機密データ（パスワード、PII、PHI等）の漏洩リスク、またはマスキング・除外の必要性を明示的に指摘している
  - △（部分検出）: ログのセキュリティに一般的に言及しているが、機密データ出力の具体的リスクに触れていない
  - ×（未検出）: ログの機密データ保護に関する言及がない

### P07: データ分類・保持期間方針の欠如
- **カテゴリ**: データ保護
- **深刻度**: 中
- **検出難易度**: hard
- **該当箇所**: セクション4全体（データモデル）
- **問題の説明**: PII（個人情報）やPHI（医療情報）を含むテーブル設計があるが、データ分類、保持期間、削除方針、プライバシー要件への対応が設計書に記載されていない。医療データは法的規制（個人情報保護法、医療法等）の対象となる。
- **検出判定基準**:
  - ○（検出）: データ分類方針、PII/PHI保持期間、削除ポリシー、またはプライバシー規制対応の欠如を明示的に指摘している
  - △（部分検出）: 個人情報保護の必要性に一般的に言及しているが、分類方針や保持期間の具体的な欠如を指摘していない
  - ×（未検出）: データ分類・保持期間に関する言及がない

### P08: 転送時の暗号化が不十分
- **カテゴリ**: データ保護
- **深刻度**: 軽微
- **検出難易度**: easy
- **該当箇所**: セクション3.1（全体構成）、セクション7.2（セキュリティ要件）
- **問題の説明**: 外部通信（クライアント-API Gateway間）はTLS 1.3で暗号化されているが、内部通信（API Gateway-バックエンド、バックエンド-DB）の暗号化方針が記載されていない。
- **検出判定基準**:
  - ○（検出）: 内部通信（バックエンド-DB間、マイクロサービス間等）の暗号化欠如を明示的に指摘している
  - △（部分検出）: 通信の暗号化に一般的に言及しているが、内部通信の具体的な欠如を指摘していない
  - ×（未検出）: 内部通信の暗号化に関する言及がない

### P09: 保存時データ暗号化の欠如
- **カテゴリ**: データ保護
- **深刻度**: 重大
- **検出難易度**: medium
- **該当箇所**: セクション4.2（テーブル設計）
- **問題の説明**: 患者の氏名、住所、電話番号、保険証番号、診察記録等の機密データが平文で保存される設計となっている。データベースの暗号化（at-rest encryption）や特定カラムの暗号化が必要。
- **検出判定基準**:
  - ○（検出）: データベースまたは特定カラム（PII/PHI）の保存時暗号化の欠如を明示的に指摘している
  - △（部分検出）: データ保護の必要性に一般的に言及しているが、保存時暗号化の具体的な欠如を指摘していない
  - ×（未検出）: 保存時暗号化に関する言及がない

### P10: セキュリティ監査ログの欠如
- **カテゴリ**: 脅威モデリング（Repudiation）、インフラ・依存関係・監査
- **深刻度**: 中
- **検出難易度**: hard
- **該当箇所**: セクション6.2（ロギング方針）
- **問題の説明**: 一般的なアプリケーションログはあるが、セキュリティ監査ログ（ログイン失敗、権限変更、機密データアクセス、管理者操作等）の設計が記載されていない。STRIDE-R（否認）対策として必要。
- **検出判定基準**:
  - ○（検出）: セキュリティ監査ログ（認証失敗、権限変更、機密データアクセス等）の欠如を明示的に指摘している
  - △（部分検出）: ロギングの重要性に一般的に言及しているが、セキュリティ監査ログの具体的な欠如を指摘していない
  - ×（未検出）: セキュリティ監査ログに関する言及がない

### P11: APIエンドポイントの認可チェック詳細が不明
- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **検出難易度**: medium
- **該当箇所**: セクション5.1（エンドポイント一覧）、セクション5.3（認証・認可方式）
- **問題の説明**: RBACを採用するとあるが、各エンドポイントに必要なロールやリソースベースの認可チェック（例: 患者本人または担当医師のみがカルテを閲覧可能）の設計が記載されていない。
- **検出判定基準**:
  - ○（検出）: エンドポイントごとの認可チェック（必要ロール、リソース所有権チェック等）の詳細が不足していることを明示的に指摘している
  - △（部分検出）: 認可設計の一般的な重要性に言及しているが、エンドポイント単位の詳細不足を指摘していない
  - ×（未検出）: 認可チェックの詳細に関する言及がない

### P12: シークレット管理方針の不足
- **カテゴリ**: インフラ・依存関係・監査
- **深刻度**: 中
- **検出難易度**: medium
- **該当箇所**: セクション6.4（デプロイメント方針）
- **問題の説明**: 環境変数をParameter Storeから取得するとあるが、アプリケーション内でのシークレットのローテーション、アクセス制御、暗号化（KMS連携等）の設計が記載されていない。
- **検出判定基準**:
  - ○（検出）: シークレットのローテーション、KMS連携、アクセス制御、または暗号化の欠如を明示的に指摘している
  - △（部分検出）: シークレット管理の重要性に一般的に言及しているが、具体的な管理方針の欠如を指摘していない
  - ×（未検出）: シークレット管理方針に関する言及がない

### P13: 依存ライブラリの脆弱性管理方針の欠如
- **カテゴリ**: インフラ・依存関係・監査
- **深刻度**: 軽微
- **検出難易度**: hard
- **該当箇所**: セクション2.4（主要ライブラリ）
- **問題の説明**: 使用するライブラリのバージョンは記載されているが、脆弱性スキャン、定期的なアップデート、脆弱性検出時の対応フローが設計されていない。
- **検出判定基準**:
  - ○（検出）: 依存ライブラリの脆弱性管理（スキャン、定期更新、対応フロー等）の欠如を明示的に指摘している
  - △（部分検出）: ライブラリ管理の重要性に一般的に言及しているが、脆弱性管理の具体的な欠如を指摘していない
  - ×（未検出）: 依存ライブラリの脆弱性管理に関する言及がない

### P14: データ完全性検証の欠如
- **カテゴリ**: 脅威モデリング（Tampering）
- **深刻度**: 軽微
- **検出難易度**: hard
- **該当箇所**: セクション4.2（テーブル設計）、セクション5（API設計）
- **問題の説明**: 診察記録等の重要データに対する改ざん検知メカニズム（ハッシュ、デジタル署名、監査証跡等）の設計が記載されていない。STRIDE-T（改ざん）対策として必要。
- **検出判定基準**:
  - ○（検出）: 重要データの改ざん検知メカニズム（ハッシュ、デジタル署名、監査証跡等）の欠如を明示的に指摘している
  - △（部分検出）: データの完全性保護に一般的に言及しているが、改ざん検知の具体的な欠如を指摘していない
  - ×（未検出）: データ完全性検証に関する言及がない

### P15: 入力検証方針の詳細不足
- **カテゴリ**: 入力検証・攻撃防御
- **深刻度**: 軽微
- **検出難易度**: medium
- **該当箇所**: セクション7.2（セキュリティ要件）
- **問題の説明**: Spring Validationによる検証とPreparedStatementの使用は記載されているが、XSS対策（出力エスケーピング）、コマンドインジェクション対策、ファイルアップロード検証（拡張子・MIMEタイプ・サイズ制限）等の具体的な入力検証方針が不足している。
- **検出判定基準**:
  - ○（検出）: XSS対策（出力エスケーピング）、コマンドインジェクション対策、またはファイルアップロード検証の欠如を明示的に指摘している
  - △（部分検出）: 入力検証の重要性に一般的に言及しているが、XSSやファイルアップロード等の具体的な対策不足を指摘していない
  - ×（未検出）: 入力検証方針の詳細に関する言及がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 認証・認可設計 | JWTペイロードへのセンシティブデータ格納リスク | JWTペイロードは署名されているが暗号化されていないため、機密情報を含めるべきでないことを指摘している |
| B02 | 脅威モデリング（DoS） | リソース枯渇攻撃への対策不足 | API Gatewayのレート制限以外に、バックエンド側のタイムアウト設定、接続プール制限、メモリ制限等のDoS対策が不足していることを指摘している |
| B03 | 入力検証・攻撃防御 | NoSQLインジェクション対策の欠如 | SQLインジェクション対策は記載されているが、NoSQLインジェクション（MongoDB等）への対策が記載されていないことを指摘している（ただし本設計ではPostgreSQL使用のためスコープ外） |
| B04 | インフラ・依存関係・監査 | コンテナイメージの脆弱性スキャン欠如 | Dockerイメージのビルドプロセスにおける脆弱性スキャン（Trivy等）の欠如を指摘している |
| B05 | データ保護 | バックアップデータの暗号化欠如 | データベースバックアップの暗号化や、バックアップへのアクセス制御が設計されていないことを指摘している |
| B06 | 認証・認可設計 | トークン失効メカニズムの欠如 | ログアウト時やアカウント削除時のJWTトークン失効（ブラックリスト等）のメカニズムが記載されていないことを指摘している |
| B07 | 入力検証・攻撃防御 | Clickjacking対策の欠如 | X-Frame-Optionsヘッダーやコンテンツセキュリティポリシー（CSP）の設計が記載されていないことを指摘している |
| B08 | インフラ・依存関係・監査 | ネットワークセグメンテーション設計の欠如 | VPC設計、セキュリティグループ、サブネット分離等のネットワークレベルのセキュリティ設計が記載されていないことを指摘している |
