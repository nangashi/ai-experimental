# 設計書レビュー用AIエージェント構成計画

## 概要

ソフトウェア設計書（コードではなく設計文書）をレビューするための5つの専門エージェント構成。3人の専門家エージェント（アーキテクチャ、セキュリティ・品質、ソフトウェア工学）による独立分析とクロスレビューを経て策定。

### 設計書レビューの前提

- レビュー対象はコードではなく設計文書（設計書、アーキテクチャ文書、技術仕様書等）
- 設計段階で発見・防止できる問題に重点を置く
- 実装詳細に依存する観点（具体的なコーディング品質等）は対象外
- 設計ミスの後工程への影響の大きさを重視

---

## エージェント一覧（重要度順）

| # | エージェント名 | 重要度 | 主要カバー観点 |
|---|--------------|--------|--------------|
| 1 | 保守性・拡張性設計審査官 | 最高 | 変更容易性、テスタビリティ、SOLID原則 |
| 2 | アーキテクチャ・ドメイン設計審査官 | 高 | アーキテクチャ妥当性、ドメインモデル、責務分離 |
| 3 | セキュリティ・コンプライアンス審査官 | 高 | 脅威モデリング、認証認可、データ保護 |
| 4 | 信頼性・レジリエンス設計審査官 | 中 | 障害設計、データ整合性、パフォーマンス |
| 5 | 一貫性・設計書品質審査官 | 中 | 既存設計との統一性、ベストプラクティス、設計書品質 |

---

## エージェント1: 保守性・拡張性設計審査官

### 英語名
Maintainability & Extensibility Design Reviewer

### 重要度: 最高（全専門家が一致して最重要と評価）

### 担当観点
- 変更容易性（ミノ駆動氏の提唱する概念を中核に据える）
- SOLID原則の適用状況
- 結合度と凝集度
- テスタビリティ（ユニットテストの行いやすさ）
- API設計品質
- 段階的実装可能性
- 技術的負債の予防

### レビュースコープ（具体的なチェック項目）

#### 変更容易性
- モジュール分割と依存関係管理が適切か
- 拡張ポイントが明示されているか（Open/Closed原則）
- 1つの変更要求が影響する範囲は限定的か（変更の局所化）
- 依存関係の方向性が適切か（依存性逆転原則）
- ビジネスロジックが技術詳細に依存していないか
- グローバル状態やシングルトンの過剰使用がないか（暗黙的依存の排除）
- ドメインロジックが外部の変更から隔離されているか
- 「変更シナリオ」によるWhat-if分析（例: 新しい決済方法を追加する際、どのモジュールを変更する必要があるか）

#### SOLID原則
- 単一責任原則: 各コンポーネント・クラスの責務が明確で単一か
- 開放閉鎖原則: 拡張に対して開き、修正に対して閉じた設計か
- リスコフの置換原則: 継承関係が適切か
- インターフェース分離原則: クライアントが使用しないメソッドへの依存がないか
- 依存性逆転原則: 上位モジュールが下位モジュールに依存していないか

#### 結合度と凝集度
- モジュール間の結合度が低いか（疎結合の実現度）
- コンポーネント内の凝集度が高いか（関連する責任が集約されているか）
- 循環依存が存在しないか
- 不要な依存関係がないか

#### テスタビリティ
- 依存性注入が設計に組み込まれているか
- 外部依存（DB、API、ファイルシステム等）が抽象化されているか
- モックポイントが明確か
- コンポーネント境界が明確で、独立してテスト可能か
- テストダブル戦略が計画可能か

#### API設計品質
- インターフェースの安定性と拡張性
- バージョニング戦略の妥当性
- 後方互換性への配慮
- RESTful原則やGraphQL設計の一貫性

#### 段階的実装可能性
- 機能の独立性が確保されているか
- 段階的リリース戦略が実現可能か
- MVP（最小限の実装可能製品）の範囲が明確か
- 依存関係の順序が段階的実装を阻害しないか

### このエージェントが最重要である理由
- ソフトウェアのライフサイクルコストの大部分は保守フェーズで発生する
- 設計段階での保守性確保が、将来の機能追加・バグ修正コストを10倍以上削減する
- 変更容易性は設計書レビューで最も効果的に評価できる品質特性である
- テスト容易な設計は変更容易な設計と強い因果関係にある

---

## エージェント2: アーキテクチャ・ドメイン設計審査官

### 英語名
Architecture & Domain Design Reviewer

### 重要度: 高

### 担当観点
- アーキテクチャパターンの妥当性
- ドメインモデル設計（DDD観点）
- 責務分離と依存方向
- コンポーネント間のインターフェース設計
- 技術的負債の構造的要因
- 外部システム統合設計

### レビュースコープ（具体的なチェック項目）

#### アーキテクチャパターンの妥当性
- 選択されたアーキテクチャパターン（レイヤード、ヘキサゴナル、マイクロサービス、イベント駆動等）がシステム要件に適合しているか
- レイヤー構造と依存方向が適切か（上位→下位の一方向依存）
- コンポーネント分割の粒度が適切か
- 技術選定がシステム要件・チーム能力に見合っているか
- アーキテクチャの非機能要件（スケーラビリティ、可用性等）への適合性

#### ドメインモデル設計
- 境界づけられたコンテキスト（Bounded Context）の分割が適切か
- 集約（Aggregate）の境界設計と不変条件の保護が適切か
- エンティティと値オブジェクトの区別が明確か
- ドメインサービスの配置が適切か
- ユビキタス言語が一貫して使用されているか
- ビジネス不変条件が設計に反映されているか

#### 責務分離と依存方向
- 各コンポーネントの責務が明確で、重複がないか
- 依存関係の方向性が適切か（ビジネスロジック→インフラの方向に依存しない）
- 横断的関心事（ロギング、認証等）の扱いが適切か

#### 境界の設計（見落とされがちだが重要）
- トランザクション境界: どの操作を一つの原子的単位とするか
- 整合性境界: 強整合性と結果整合性の使い分けが適切か
- 障害境界: コンポーネント障害の波及防止が設計されているか
- セキュリティ境界: 信頼できる領域と信頼できない領域が分離されているか
- ドメイン境界: コンテキスト間の関係（共有カーネル、顧客/供給者等）が明確か

#### 外部システム統合
- 外部API・サービスとの統合設計が適切か
- ベンダーロックインのリスクが考慮されているか
- 外部依存の障害時のフォールバック戦略があるか

### このエージェントの設計判断

アーキテクチャとドメインモデルを統合した理由:
- 両者は密接に関連する（DDDの境界づけられたコンテキストがアーキテクチャを規定する）
- ビジネスロジックの構造化を一貫して評価できる
- 5エージェント制約下での効率性（独立させると6エージェント必要）

ドメインを主軸、アーキテクチャを従とする階層関係:
- ドメインモデルの妥当性がアーキテクチャ全体を左右する
- 技術的構造（アーキテクチャ）はビジネス概念（ドメイン）を支えるべき

---

## エージェント3: セキュリティ・コンプライアンス審査官

### 英語名
Security & Compliance Reviewer

### 重要度: 高

### 担当観点
- 脅威モデリング（STRIDE等）
- 認証・認可設計
- データ保護とプライバシー
- 入力検証・境界防御設計
- コンプライアンス要件（GDPR等）

### レビュースコープ（具体的なチェック項目）

#### 脅威モデリング
- STRIDE（なりすまし、改ざん、否認、情報漏洩、DoS、権限昇格）の観点からの分析
- 攻撃面（Attack Surface）の識別と最小化
- 信頼境界の明確な定義
- 各コンポーネント間のデータフローにおけるセキュリティリスク

#### 認証・認可設計
- 認証フロー（OAuth2、OIDC、JWT等）の妥当性
- 認可モデル（RBAC、ABAC等）の設計
- トークン管理（発行、検証、失効、リフレッシュ）の設計
- セッション管理の設計
- 権限チェックの漏れがないか

#### データ保護
- 機密データの識別と分類
- 暗号化戦略（保存時、伝送時）
- 個人情報の保存場所・保持期間・削除方針
- アクセス制御によるデータ保護
- 監査ログの設計（誰が、いつ、何にアクセスしたか）

#### 入力検証・境界防御
- 信頼境界での入力検証戦略
- サニタイゼーション方針
- 外部入力の取り扱い（API入力、ファイルアップロード等）

#### コンプライアンス
- GDPR、個人情報保護法等への準拠
- 業界固有の規制（PCI-DSS、HIPAA等）への適合性
- 監査要件への対応（監査ログ、アクセス記録）
- データの越境移転に関する考慮

### 設計書レビューにおけるセキュリティの有効性

#### 設計段階で発見できる問題（効果大）
- アーキテクチャレベルの脅威（信頼境界の欠如、認証の不在、暗号化の欠如）
- 認証・認可モデルの根本的欠陥
- 個人情報の不適切な保存・伝送設計
- セキュリティ要件の欠落

#### 設計段階では限定的な問題（効果中）
- 入力検証の詳細な実装方法（設計では方針のみ確認可能）
- 暗号化アルゴリズムの具体的選択
- エラーメッセージの情報漏洩リスク

#### 設計段階では困難な問題（効果小）
- SQLインジェクション、XSS等の実装レベルの脆弱性
- ライブラリ・フレームワークの既知脆弱性

---

## エージェント4: 信頼性・レジリエンス設計審査官

### 英語名
Reliability & Resilience Design Reviewer

### 重要度: 中（ただしミッションクリティカルシステムでは高に上昇）

### 担当観点
- 障害モード分析
- エラーハンドリング戦略
- データ整合性（トランザクション設計）
- スケーラビリティとパフォーマンス設計
- 外部依存管理
- 可観測性設計

### レビュースコープ（具体的なチェック項目）

#### 障害モード分析
- 単一障害点（SPOF）の識別と排除
- FMEA（障害モード影響分析）の観点からの評価
- カスケード障害の予防設計
- フェイルオーバー戦略の妥当性
- 障害時のデグレード戦略（graceful degradation）

#### エラーハンドリング戦略
- エラー伝播パターンの妥当性
- 補償トランザクションの設計
- リトライ戦略（指数バックオフ等）の一貫性
- タイムアウト設計の妥当性
- サーキットブレーカーパターンの適用

#### データ整合性
- ACID特性の保証範囲
- 分散システムでの整合性モデル（強整合性/結果整合性）の選択
- Sagaパターン等の分散トランザクション戦略
- 並行アクセス時の競合状態（Race Condition）の防止
- データ復旧戦略

#### スケーラビリティとパフォーマンス
- 水平/垂直スケーリング戦略
- ステートレス設計の実現度
- キャッシュ戦略（CDN、アプリケーション、DB各層）
- 非同期処理・バッチ処理の適切な採用
- ボトルネックの予測と対策
- パーティショニング・シャーディング戦略

#### 外部依存管理
- 外部サービスの障害時のフォールバック戦略
- ベンダーロックインのリスク評価
- 依存サービスのSLA考慮

#### 可観測性
- ログ設計（構造化ログ、ログレベル戦略）
- メトリクス収集ポイントの設計
- 分散トレーシング設計
- アラート戦略

### パフォーマンスを信頼性に統合した理由
- 設計段階ではパフォーマンスは方針レベルの評価にとどまる（実測は実装後）
- スケーラビリティと信頼性は共通の技法（キャッシング、非同期処理、負荷分散）で対処される
- パフォーマンス問題は本質的に信頼性問題でもある（遅延はユーザーにとって障害）
- 高負荷要件（10万req/s以上等）がある場合はパフォーマンスの独立エージェント化を検討

---

## エージェント5: 一貫性・設計書品質審査官

### 英語名
Consistency & Design Document Quality Reviewer

### 重要度: 中

### 担当観点
- 既存設計との統一性
- 横断的ベストプラクティス
- 設計書自体の品質（完全性・明確性）
- デプロイメント・運用標準

### レビュースコープ（具体的なチェック項目）

#### 既存設計との統一性
- 命名規則の一貫性（既存システムとの整合）
- 通信プロトコルの統一（REST、gRPC、メッセージング等）
- データ形式の統一（JSON、Protocol Buffers等）
- 認証方式の統一
- モジュール分割方針の一貫性
- 技術スタック選定の既存資産との整合性

#### 横断的ベストプラクティス
- 業界標準パターンの採用（12 Factor App、クラウドネイティブパターン等）
- 一般的なアンチパターンの検出（God Object、Circular Dependency等）
- デザインパターンの誤用・過剰適用の検出
- コーディング規約・設計規約への準拠

#### 設計書自体の品質（メタレビュー機能）
- 設計書の論理的整合性（記述間の矛盾がないか）
- 図表と記述の一致
- 必要情報の網羅性（機能要件、非機能要件、制約条件等の記載漏れ）
- 記述の明確性（曖昧な表現、解釈の余地がある記述がないか）
- トレーサビリティ（要件との対応関係が追跡可能か）
- 実装可能性（設計書から実装に落とし込めるか）

#### デプロイメント・運用標準
- デプロイ戦略（ブルーグリーン、カナリア等）の既存標準との整合
- CI/CDパイプラインとの整合性
- 環境管理（本番、ステージング、開発）の標準への準拠
- ロールバック戦略

### 設計書品質をこのエージェントに含めた理由
- 設計書の品質欠陥（曖昧性、不完全性）は他全てのレビューの有効性を損なう
- 他4エージェントが適切にレビュー可能な入力を受け取れるかの品質ゲートとして機能
- 一貫性の視点（標準準拠、既存パターンとの整合）は設計書の構造・記述方式にも適用可能

---

## 観点の統合・分離判断の根拠

### 統合判断の基準（以下を満たす場合に統合）
1. **因果関係が強い**: 一方が他方の前提条件となる
2. **同一の設計要素を評価**: 同じアーキテクチャ要素を異なる視点で見る
3. **専門知識が重複**: 同じ専門家が評価できる
4. **トレードオフ判断が必要**: 観点間のバランスを一人が判断すべき

### 分離判断の基準（以下を満たす場合に分離）
1. **専門性が独立**: 異なる専門家が必要
2. **評価手法が異なる**: 定性的評価 vs 定量的評価
3. **利益相反の可能性**: トレードオフ関係が強く、独立した評価が必要
4. **重要度が極めて高い**: 専用のエージェントで網羅的評価が必要

### 主要な統合判断

| 統合された観点 | 統合先エージェント | 理由 |
|--------------|------------------|------|
| テスタビリティ → 保守性 | エージェント1 | テスト容易な設計≒変更容易な設計（因果関係） |
| ドメインモデル → アーキテクチャ | エージェント2 | DDDの境界コンテキストがアーキテクチャを規定（因果関係） |
| コンプライアンス → セキュリティ | エージェント3 | 大半の規制要件がセキュリティ起源（専門知識の重複） |
| パフォーマンス → 信頼性 | エージェント4 | 共通技法で対処、設計段階では方針レベル（同一設計要素） |
| ベストプラクティス → 各エージェントに分散 | 全エージェント | 領域固有のBPは各専門家が評価、横断的BPはエージェント5 |
| 設計書品質 → 一貫性 | エージェント5 | 他エージェントのレビュー品質の前提条件（因果関係） |

---

## ユーザー候補観点との対応

| ユーザーの候補観点 | 割当先 | 備考 |
|-------------------|--------|------|
| セキュリティ | エージェント3（中核） | 独立エージェント |
| パフォーマンス | エージェント4（信頼性に統合） | 設計段階では方針レベル評価 |
| 変更容易性（ミノ駆動） | エージェント1（中核） | 最重要観点として位置づけ |
| ユニットテストの行いやすさ | エージェント1（保守性に統合） | テスタビリティとして評価 |
| ベストプラクティス | 各エージェントに分散 + エージェント5 | 領域固有BPは各専門家、横断的BPはエージェント5 |
| 既存設計との統一性 | エージェント5（中核） | 独立エージェント |
| アーキテクチャの妥当性 | エージェント2（中核） | ドメインモデルと統合 |

---

## コードレビューとの違いに関する注意事項

設計書レビューエージェントは以下の点でコードレビューとは異なる視点を持つべき:

- **「なぜその設計か」の論理性**を評価する（コードレビューは「正しく実装されているか」を評価）
- **将来の変更や拡張を見据えた長期的視点**で評価する
- **「正しい問題を正しく分解できているか」**を評価する（実装可能性より重要）
- 実装の詳細（具体的なSQL、エラーハンドリングの詳細等）は評価対象外
- システム全体の構造、コンポーネント間の関係、ポリシーと戦略を評価する
