# Round 002 Comparison Report: agents/security-design-reviewer

## 実行条件

- **ラウンド**: Round 002
- **テスト文書**: 地域医療機関統合患者向けリアルタイム医療予約システム (287 lines)
- **埋め込み問題数**: 15問（重大4、中6-7、軽微4-5）
- **比較対象**: v001-baseline（現在ベスト）vs v002-specific-checks vs v002-priority-balance
- **評価回数**: 各バリアント3回実行

---

## スコア比較テーブル

| Prompt | Mean | SD | Run1 | Run2 | Run3 | Stability |
|--------|------|-----|------|------|------|-----------|
| **v001-baseline** (現在ベスト) | **11.7** | 0.5 | - | - | - | 高安定 |
| v002-specific-checks | **10.3** | 0.5 | 10.0 | 10.5 | 10.5 | 高安定 |
| v002-priority-balance | **9.5** | 0.5 | 10.0 | 9.0 | 9.5 | 高安定 |

**スコア差**:
- v002-specific-checks: -1.4pt (現在ベスト比)
- v002-priority-balance: -2.2pt (現在ベスト比)

---

## カテゴリ別検出改善/悪化マトリクス

### v002-specific-checks vs v001-baseline

| Category | 問題数 | v001 ○ | v002 ○ | v001 △ | v002 △ | v001 × | v002 × | 変化 |
|----------|--------|--------|--------|--------|--------|--------|--------|------|
| 認証・認可設計 | 2 | 2 | 2 | 0 | 0 | 0 | 0 | 維持 |
| 入力検証・攻撃防御 | 5 | 2 | 1 | 2 | 1 | 1 | 3 | **悪化** |
| データ保護 | 4 | 3 | 3 | 0 | 0 | 2 | 1 | 改善 |
| 脅威モデリング(I) | 1 | 1 | 1 | 0 | 0 | 0 | 0 | 維持 |
| 脅威モデリング(R) | 1 | 0.67 | 0 | 1 | 1 | 0 | 0 | 維持 |
| 脅威モデリング(T) | 1 | 0 | 1 | 0 | 0 | 1 | 0 | **改善** |
| インフラ・依存関係・監査 | 3 | 1.67 | 2 | 1 | 1 | 0 | 0 | 改善 |

**改善**: データ保護(P07検出)、脅威モデリング-T(P14検出)、インフラ(P12検出)
**悪化**: 入力検証・攻撃防御(P02, P03未検出 - ベースラインでは部分検出または完全検出)

### v002-priority-balance vs v001-baseline

| Category | 問題数 | v001 ○ | v002 ○ | v001 △ | v002 △ | v001 × | v002 × | 変化 |
|----------|--------|--------|--------|--------|--------|--------|--------|------|
| 認証・認可設計 | 2 | 2 | 2 | 0 | 0 | 0 | 0 | 維持 |
| 入力検証・攻撃防御 | 5 | 2 | 3 | 2 | 1 | 1 | 1 | 改善 |
| データ保護 | 4 | 3 | 3 | 0 | 0.67 | 2 | 0 | **改善** |
| 脅威モデリング(I) | 1 | 1 | 1 | 0 | 0 | 0 | 0 | 維持 |
| 脅威モデリング(R) | 1 | 0.67 | 1 | 1 | 0 | 0 | 0 | **改善** |
| 脅威モデリング(T) | 1 | 0 | 0 | 0 | 0 | 1 | 1 | 維持 |
| インフラ・依存関係・監査 | 3 | 1.67 | 2.67 | 1 | 0.33 | 0 | 0 | **改善** |

**改善**: データ保護(P08検出向上)、入力検証(P03, P04完全検出化)、脅威モデリング-R(P10完全検出化)、インフラ(P12安定化)
**悪化**: なし（P14は維持、P02未検出はベースラインと同じ）

---

## 推奨判定と根拠

**推奨プロンプト**: **v001-baseline**（現在ベスト維持）

**判定根拠**:
- v002-specific-checks: -1.4pt（1.0pt超の悪化）
- v002-priority-balance: -2.2pt（1.0pt超の悪化）
- **両バリアントとも現在ベストより1.0pt以上低く、推奨判定基準により現在ベストを推奨**

**収束判定**: 継続推奨
- 理由: 初回ラウンドであり、2ラウンド連続の改善幅データなし

---

## 戦略別効果分析

### v002-specific-checks の戦略と効果

**採用戦略**:
- **特定カテゴリ強化**: データ保護（P07: データ分類・保持期間、P08: 内部通信暗号化）、脅威モデリング-T（P14: データ完全性検証）、インフラ（P12: シークレット管理）に対する明示的なチェック項目を追加
- **詳細化アプローチ**: 各カテゴリに具体的な欠如パターンの列挙を追加（例: データ分類・保持期間方針、内部通信暗号化、改ざん検知メカニズム）

**効果分析**:
- **正効果**:
  - P07（データ分類・保持期間）: ×→○（+3pt/3runs）
  - P14（データ完全性検証）: ×→○（+3pt/3runs）
  - P12（シークレット管理）: △→○（+1.5pt/3runs）
  - 合計改善: +7.5pt

- **負効果**:
  - **P02（CSRF対策）**: ○/△→×（-2.5pt/3runs）
  - **P03（CORS設定）**: △/○→×（-2.0pt/3runs）
  - P15（入力検証方針）: △/○→△（-1.5pt/3runs）
  - 合計悪化: -6.0pt

- **正味効果**: +1.5pt（改善分） - 6.0pt（悪化分） = **-4.5pt**（実測値: -1.4pt vs ベースライン11.7pt）

**因果分析**:
- **トレードオフ発生**: 特定カテゴリの強化により、プロンプトの焦点がデータ保護・脅威モデリング・インフラに移行し、入力検証・攻撃防御への注意が相対的に低下
- **検出競合**: P02（CSRF）とP03（CORS）は v001-baseline で安定検出していた項目だが、プロンプトの詳細化により評価基準4（Input Validation & Attack Defense）の優先順位が下がり、未検出に転じた
- **ボーナス効果**: トークン失効メカニズム（M1）を3回とも検出（+1.5pt）したが、重複ペナルティ（MI1: エラーメッセージ詳細）が発生（-1.5pt）し相殺

### v002-priority-balance の戦略と効果

**採用戦略**:
- **包括的カバレッジ**: 全カテゴリに対してバランスよく評価指示を追加
- **明示的ギャップ検出**: 設計書に「記載がある項目」と「未記載の要素」を区別して検証する指示を強化（例: 内部通信暗号化、シークレット管理ライフサイクル）
- **STRIDE完全評価**: STRIDE 6カテゴリの網羅的評価を明示

**効果分析**:
- **正効果**:
  - P08（内部通信暗号化）: ×→○/△（+2.5pt/3runs）
  - P10（セキュリティ監査ログ）: △→○（+1.5pt/3runs）
  - P03（CORS設定）: △/○→○（+0.5pt/3runs）
  - P04（認証エンドポイントのレート制限）: △/○→○（+0.5pt/3runs）
  - P12（シークレット管理）: △→○/△（+0.83pt/3runs）
  - 合計改善: +5.83pt

- **負効果**:
  - P02（CSRF対策）: ○/△→×（-2.5pt/3runs）
  - P14（データ完全性検証）: ×維持（0pt）
  - P15（入力検証方針）: △/○→△（-0.5pt/3runs）
  - 合計悪化: -3.0pt

- **正味効果**: +5.83pt（改善分） - 3.0pt（悪化分） = **+2.83pt**（実測値: -2.2pt vs ベースライン11.7pt）

**因果分析**:
- **検出パターンシフト**: 包括的評価により、多カテゴリで改善が見られたが、P02（CSRF）の完全未検出が致命的（-2.5pt）
- **CSRF検出失敗の原因**: 評価基準4に「CORS/origin control, and CSRF protection are designed」と明記しているが、CORS設定は全回検出したのに対し、CSRF対策は未検出。プロンプト内でCSRFを独立したチェックポイントとして強調する必要あり
- **ボーナス効果**: トークン失効メカニズム（B06）を2回検出（+1.0pt）、ペナルティなし（v002-specific-checks より効率的）
- **安定性低下**: P08（内部通信暗号化）とP12（シークレット管理）でRun間のばらつきが発生（SD=0.5は維持したが、個別問題で△判定が出現）

---

## 考察

### 変更内容と効果の因果分析

#### 1. CSRF検出失敗の構造的原因
- **両バリアントの共通問題**: v002-specific-checks と v002-priority-balance のいずれも P02（CSRF対策）を未検出（v001-baseline では ○/△ で検出していた）
- **プロンプト変更の影響**: 両バリアントとも評価基準4（Input Validation & Attack Defense）を再構成したが、CSRF対策の優先順位が相対的に低下
  - v002-specific-checks: 内部通信暗号化・データ分類に焦点を当てた結果、攻撃防御への注意が分散
  - v002-priority-balance: CORS設定を完全検出したが、CSRF対策は「CORS/origin control, and CSRF protection」と併記されたため、CORSに焦点が集中
- **根本原因**: CSRF対策とCORS設定を同一の評価項目に統合したことで、CORS（P03）の検出が優先され、CSRF（P02）が見落とされた

#### 2. 改善項目の成功パターン
- **明示的チェックリストの有効性**:
  - v002-specific-checks: P07（データ分類・保持期間）、P14（データ完全性検証）、P12（シークレット管理）で明示的なチェック項目を追加 → 完全検出達成
  - v002-priority-balance: P10（セキュリティ監査ログ）で「一般ログと監査ログの区別」を明示 → 完全検出達成
- **ギャップ検出指示の有効性**: 「設計書に記載された項目」と「未記載の要素」の区別を明示することで、欠如の検出精度が向上（P08: 内部通信暗号化、P12: シークレット管理ライフサイクル）

#### 3. トレードオフの発生メカニズム
- **プロンプト長と焦点の分散**: 詳細なチェックリストを追加すると、プロンプト全体の長さが増加し、各項目への注意が分散
  - v002-specific-checks: 特定カテゴリを詳細化 → 他カテゴリ（入力検証・攻撃防御）への注意低下
  - v002-priority-balance: 全カテゴリをバランスよく詳細化 → CSRF検出失敗のような局所的な見落とし発生
- **優先順位の暗黙的変化**: プロンプト内での記述順序や詳細度が、実際の評価優先順位に影響

### 次回への示唆

#### 1. CSRF対策の独立化
- **改善方向**: CSRF対策をCORS設定から分離し、独立したチェックポイントとして明記
- **具体的な記述例**: 「State-changing operations（POST/PUT/DELETE）にCSRF保護（CSRFトークン、SameSite Cookie属性等）が設計されているか確認すること。CORS設定とCSRFは異なる攻撃防御であることに注意。」

#### 2. 段階的改善の採用
- **現状の問題**: 両バリアントとも複数カテゴリを同時に変更したため、改善と悪化が混在
- **推奨アプローチ**: 1ラウンドあたり1-2カテゴリに絞って改善を試行し、トレードオフの発生を監視
  - 例: 次回はCSRF検出失敗の修正のみに集中し、他のカテゴリは現在ベストの記述を保持

#### 3. 安定性の重視
- **v002-priority-balance の教訓**: P08（内部通信暗号化）とP12（シークレット管理）でRun間のばらつきが発生
- **改善方向**: 明示的な指示を追加する際は、「検出基準の具体性」と「評価の安定性」のバランスを考慮
  - 具体例: 「設計書に記載された項目」と「未記載の要素」の区別指示は有効だが、Run間で解釈のばらつきが生じる可能性がある

#### 4. ボーナス・ペナルティの最適化
- **v002-specific-checks の問題**: 重複ペナルティ（MI1）が発生し、ボーナス効果を相殺
- **改善方向**: ボーナス問題候補（トークン失効メカニズム等）を正解キーに追加することで、重複ペナルティのリスクを軽減

---

## 次回戦略提案

1. **CSRF対策の独立化**: 評価基準4でCSRFを独立項目として明記し、CORS設定と分離
2. **段階的改善**: 次回ラウンドは入力検証・攻撃防御カテゴリ（P02, P15）のみに集中
3. **v001-baseline の強みの保持**: 認証・認可設計、データ保護重大問題の検出精度を維持
4. **安定性の検証**: 改善後、3回実行でSD≤0.5を確認
