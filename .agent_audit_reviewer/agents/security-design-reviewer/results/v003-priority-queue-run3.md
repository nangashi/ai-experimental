# セキュリティ設計レビュー: リアルタイム医療予約システム

## 1. 重大な問題（Critical Issues）

### 1.1 [P01-Critical] エラーメッセージにスタックトレース含有（情報漏洩）

**問題**
6.1節でエラーレスポンスに「詳細なスタックトレースを含め、デバッグを容易にする」と明記されており、本番環境で内部構造やファイルパス、フレームワークバージョンなどの機密情報が外部に漏洩する。

**影響**
攻撃者はスタックトレースから内部構成を把握し、既知脆弱性の悪用や標的型攻撃のための偵察情報として利用できる。Information Disclosure（STRIDE）の重大な脅威となる。

**対策**
- 本番環境ではエラーレスポンスに汎用メッセージのみを返し、詳細なスタックトレースは内部ログにのみ記録
- 環境変数で開発環境と本番環境のエラー詳細度を切り替える設計に変更
- エラーIDを発行し、ユーザーには「Error ID: XYZ」のみ表示、詳細はサーバーログで追跡可能にする

**参照**
「6.1 エラーハンドリング方針」

---

### 1.2 [P02-Critical] JWTトークンのlocalStorage保存（XSS脆弱性時の認証情報漏洩）

**問題**
5.3節でJWTトークンをlocalStorageに保存する設計が明記されているが、XSS攻撃が成功した場合、JavaScriptから直接アクセス可能なlocalStorageに保存されたトークンが窃取される。

**影響**
攻撃者はXSS経由でトークンを盗み、被害者になりすまして全API操作を実行可能。医療データの閲覧・改ざん、不正予約作成などの深刻な被害が発生する。

**対策**
- JWTをHttpOnly、Secure、SameSite=Strict属性付きCookieに保存し、JavaScriptからのアクセスを防止
- CSRF対策として、state-changing操作にはCSRFトークンを別途要求
- Content Security Policy (CSP) を設定し、XSS攻撃面を削減

**参照**
「5.3 認証・認可方式」

---

### 1.3 [P03-Critical] 診察記録・患者情報へのアクセス制御設計の欠如

**問題**
5.1節の患者API・カルテAPIエンドポイント（`GET /api/patients/{id}`, `GET /api/records/{id}`等）で、リクエスト送信者が対象患者データにアクセス権限を持つかの検証設計が明記されていない。

**影響**
パスパラメータのID列挙により、他患者の個人情報・診察記録を不正閲覧可能（IDOR: Insecure Direct Object Reference）。医療情報の不正アクセスは法的責任（個人情報保護法・医療法違反）とレピュテーション損失をもたらす。

**対策**
- 各エンドポイントで認証ユーザーのロール・所属・患者IDとリクエスト対象リソースの照合ロジックを明示的に設計
  - 患者: 自身のデータのみアクセス可
  - 医療従事者: 所属医療機関で診療した患者のデータのみアクセス可
  - 管理者: 監査目的の限定的アクセスログ記録
- Spring Securityの@PreAuthorizeアノテーションやカスタムPermissionEvaluatorで実装方針を明記

**参照**
「5.1 エンドポイント一覧」患者API・カルテAPI

---

### 1.4 [P04-Critical] 予約操作の認可設計不備（なりすまし予約・不正キャンセル）

**問題**
予約API（`POST /api/appointments`, `PUT /api/appointments/{id}`, `DELETE /api/appointments/{id}`）で、操作対象予約の所有権検証設計が記載されていない。

**影響**
- 他ユーザーの予約を不正にキャンセルし、診療妨害や枠の不正確保が可能
- 他患者の名義で予約を作成し、医療機関の信頼性を損なう
- Tampering/Elevation of Privilege（STRIDE）の脅威

**対策**
- 予約作成時: リクエストボディのpatient_idが認証ユーザー本人または権限を持つ医療従事者か検証
- 予約更新・削除時: 対象予約のpatient_idとログインユーザーの所有権一致を確認、または医療機関スタッフの権限を検証
- 認可ロジックをサービス層で統一的に実装し、エンドポイント定義に明記

**参照**
「5.1 エンドポイント一覧」予約API

---

## 2. 重要な問題（Significant Issues）

### 2.1 [P05-Significant] ロギングにリクエストボディの全量記録（PII漏洩）

**問題**
6.2節のログフォーマット例で、リクエストボディ全体（`"requestBody": "{...}"`）を記録する設計だが、医療データ（診断内容、処方薬、保険証番号など）がログに平文で残る。

**影響**
CloudWatch Logsへのアクセス権を持つ運用担当者や、ログが不正に漏洩した場合、患者のPIIが大量に露出する。GDPR/個人情報保護法違反のリスク。

**対策**
- ログ記録前にPII項目（full_name、date_of_birth、insurance_number、diagnosis、prescription等）をマスキングまたは除外
- 構造化ログでパラメータ種別を明示し、機密データは`[REDACTED]`で置換
- 監査ログとアプリケーションログを分離し、監査ログは暗号化して厳格なアクセス制御を適用

**参照**
「6.2 ロギング方針」

---

### 2.2 [P06-Significant] セッションタイムアウト・トークン無効化機構の欠如

**問題**
5.3節でJWTの有効期限（1時間/リフレッシュトークン30日）は記載されているが、ログアウト時やパスワード変更時のトークン無効化（ブラックリスト管理）設計が明記されていない。

**影響**
盗まれたトークンが有効期限まで悪用可能。ログアウト後も以前のトークンで認証が通り、セッション管理の信頼性が損なわれる（Spoofing/Repudiation脅威）。

**対策**
- Redisにトークンブラックリストを保持し、ログアウト・パスワード変更時にJTIをブラックリストに追加
- 認証フィルタでブラックリスト照合を実施
- リフレッシュトークンはデータベースに保存し、ローテーション時に旧トークンを無効化する設計を明記

**参照**
「5.3 認証・認可方式」、「3.2 主要コンポーネント」認証サービス

---

### 2.3 [P07-Significant] データベース暗号化と鍵管理の未設計

**問題**
4.2節で患者テーブルに保険証番号、氏名、生年月日などのPIIが含まれるが、7.2節では「通信のTLS暗号化」「パスワードのbcrypt」のみ言及され、データベース内のデータ暗号化（encryption at rest）と鍵管理設計が欠如している。

**影響**
データベースバックアップやストレージの物理的窃取、権限昇格攻撃により、PII・医療記録が平文で露出する（Information Disclosure）。

**対策**
- PostgreSQLのTransparent Data Encryption（TDE）またはAWS RDS暗号化を有効化し、ストレージレベルで暗号化
- 特に機密性の高い項目（insurance_number、診断内容）はアプリケーション層でAES-256暗号化し、列レベル暗号化を実施
- 暗号鍵はAWS KMSで管理し、定期的なキーローテーションポリシーを設計
- バックアップデータも暗号化し、アクセス制御とログ記録を徹底

**参照**
「4.2 テーブル設計」、「7.2 セキュリティ要件」、「7.3 可用性・スケーラビリティ」

---

### 2.4 [P08-Significant] データ保持期限・削除ポリシーの未定義

**問題**
患者データ・診察記録の保持期間、アクセス権喪失後の削除ポリシー、ユーザー削除リクエストへの対応（GDPR Right to Erasure）が設計に含まれていない。

**影響**
不要なデータが無期限に蓄積し、漏洩時の影響範囲が拡大。法令違反（個人情報保護法・GDPR）やプライバシー侵害リスク。

**対策**
- 診察記録は法定保存期間（医療法：5年）に従い、期限後は自動削除またはアーカイブ
- 退会患者の個人情報は、法的義務を満たした後に削除するワークフロー設計
- データ削除時は関連する全テーブル（appointments、medical_records）から完全削除するカスケード設計
- 削除処理の監査ログを記録

**参照**
「4. データモデル」全体

---

## 3. 中程度の問題（Moderate Issues）

### 3.1 [P09-Moderate] CSRF保護設計の欠如

**問題**
5.3節でJWT認証が記載されているが、CSRF（Cross-Site Request Forgery）対策が明記されていない。JWTをCookieで送信する場合、CSRF攻撃のリスクがある。

**影響**
攻撃者が作成した悪意あるサイトから、ログイン中のユーザーのブラウザを経由して予約作成・キャンセル操作を強制実行される（Tampering）。

**対策**
- state-changing操作（POST/PUT/DELETE）には、CSRFトークンをカスタムヘッダーまたはリクエストボディに含めることを要求
- Spring SecurityのCsrfFilterを有効化し、トークン検証を実施
- SameSite=Strict属性のCookieと組み合わせて多層防御

**参照**
「5.3 認証・認可方式」、「5.1 エンドポイント一覧」

---

### 3.2 [P10-Moderate] レート制限の詳細設計不足（DoS攻撃対策の不備）

**問題**
3.2節でAPI Gatewayのレート制限「1分あたり100リクエスト」と記載されているが、IP単位かユーザー単位か、エンドポイント別の制限、制限超過時の動作（429レスポンス、Retry-Afterヘッダー）が不明。

**影響**
単一IPからの大量リクエストでサービス全体が影響を受ける、正当なユーザーが巻き込まれるなど、DoS攻撃への不十分な対策（Denial of Service脅威）。

**対策**
- レート制限をIPアドレス単位とユーザーID単位の両方で設計（例: IP: 100req/min、認証済みユーザー: 300req/min）
- ログインエンドポイントは特に厳しく制限（5失敗/分でアカウントロック）
- 制限超過時は429 Too Many Requests + Retry-Afterヘッダーを返す設計を明記
- API Gatewayのスロットリング設定とCloudWatch Alarmsで異常検知

**参照**
「3.2 主要コンポーネントの責務と依存関係」API Gateway

---

### 3.3 [P11-Moderate] パスワードポリシーとアカウントロックアウト設計の欠如

**問題**
7.2節でbcryptハッシュ化は記載されているが、パスワード強度要件（長さ、複雑性）、辞書攻撃対策、ブルートフォース攻撃時のアカウントロックアウトポリシーが設計されていない。

**影響**
弱いパスワードの使用を許可し、総当たり攻撃や辞書攻撃による不正アクセスのリスクが増大（Spoofing脅威）。

**対策**
- パスワードポリシー: 最小12文字、英大小文字・数字・記号を含む、共通パスワード辞書との照合
- ログイン失敗5回で15分間アカウントロックアウト、CAPTCHAチャレンジ導入
- パスワードリセット時の本人確認フロー（メール認証トークン）を明示的に設計

**参照**
「7.2 セキュリティ要件」、「5.1 エンドポイント一覧」認証API

---

### 3.4 [P12-Moderate] 依存ライブラリの脆弱性管理プロセス欠如

**問題**
2.4節で主要ライブラリのバージョンは記載されているが、脆弱性スキャン、パッチ適用プロセス、サプライチェーン攻撃対策が設計に含まれていない。

**影響**
既知の脆弱性を持つライブラリの使用により、リモートコード実行やデータ漏洩のリスク。Spring、Hibernate、OSSライブラリの脆弱性が定期的に公開される。

**対策**
- CIパイプラインにDependency-Check、Snyk、Trivy等の脆弱性スキャンツールを統合
- 月次での依存ライブラリ更新とセキュリティパッチ適用プロセスを確立
- 脆弱性検出時の緊急対応フローと影響評価基準を定義
- Software Bill of Materials (SBOM) を生成し、サプライチェーンの透明性を確保

**参照**
「2.4 主要ライブラリ」、「6.4 デプロイメント方針」

---

## 4. 軽微な改善提案（Minor Improvements）

### 4.1 [P13-Minor] SQLインジェクション対策の部分的記載

**現状**
7.2節で「PreparedStatementを使用」と記載されているが、Spring Data JPAのクエリメソッド、ネイティブクエリ、動的クエリ生成における対策が明示されていない。

**推奨**
- JPQLクエリでもパラメータバインディングを使用し、文字列連結によるクエリ生成を禁止する実装ガイドラインを追加
- ネイティブクエリ使用時の静的解析ルールを定義

**参照**
「7.2 セキュリティ要件」

---

### 4.2 [P14-Minor] XSS対策の具体的設計

**現状**
入力検証にSpring Validationを使用すると記載されているが、出力エスケープ、Content Security Policy（CSP）設定が明記されていない。

**推奨**
- React側で全ユーザー入力をエスケープ処理（DOMPurify等のライブラリ使用）
- CSPヘッダーで`script-src 'self'`等の厳格なポリシーを設定
- APIレスポンスに`X-Content-Type-Options: nosniff`、`X-Frame-Options: DENY`ヘッダーを追加

**参照**
「7.2 セキュリティ要件」

---

### 4.3 [P15-Minor] セキュリティ監査ログの具体的設計

**現状**
6.2節でロギング方針は記載されているが、セキュリティイベント（認証失敗、権限エラー、機密データアクセス）の監査ログ設計が不明確。

**推奨**
- 以下のイベントを監査ログとして別ファイル/ストリームに記録:
  - ログイン成功/失敗（ユーザーID、IPアドレス、タイムスタンプ）
  - 権限エラー（403: アクセス試行リソース、リクエスト元）
  - 患者情報・診察記録へのアクセス（閲覧・更新・削除）
- 監査ログは改ざん防止のため、暗号署名または外部SIEM（Splunk、AWS Security Hub）に転送
- Repudiation対策として、ログの完全性保証機構を設計

**参照**
「6.2 ロギング方針」

---

## 5. 設計の良い点（Positive Aspects）

### 5.1 基本的な暗号化の採用

- TLS 1.3による通信暗号化、bcryptによるパスワードハッシュ化は適切な選択
- コスト係数10のbcryptは現時点で推奨される強度

### 5.2 ロールベースアクセス制御の基本設計

- PATIENT/DOCTOR/ADMINのロール分離は医療システムの要件に適合
- Spring Securityの活用方針は実装の基盤として妥当

### 5.3 可用性対策の考慮

- Multi-AZ構成、定期バックアップ、オートスケーリングは高可用性実現の基本を押さえている

---

## 6. 総評

本設計書は3層アーキテクチャとJWT認証の基本的な枠組みは整っているものの、**医療情報を扱うシステムとして致命的なセキュリティ設計の欠如**が複数存在します。

特に以下の4つの重大な問題は、早急に設計段階で対処すべき課題です：
1. エラーメッセージからの情報漏洩
2. JWTのlocalStorage保存によるXSS脆弱性
3. 患者データへのアクセス制御設計の欠如
4. 予約操作の認可設計不備

これらは実装に進む前に、認可モデルの明確化、トークン保存方式の変更、エラーハンドリング方針の再設計が必須です。また、データ暗号化、保持期限、監査ログなどのデータ保護設計を補完することで、法令遵守と患者プライバシー保護を実現できます。

推奨される対応優先度：
1. **即座に対処**: P01〜P04（重大な問題）
2. **設計段階で対処**: P05〜P08（重要な問題）
3. **実装初期で対処**: P09〜P12（中程度の問題）
4. **実装中に組み込み**: P13〜P15（軽微な改善）
