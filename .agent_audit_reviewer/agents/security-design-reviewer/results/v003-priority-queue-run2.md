# セキュリティ設計評価レポート: リアルタイム医療予約システム

## 評価サマリー

本設計書は医療情報という機密性の高いデータを扱うシステムであるにもかかわらず、複数の重大なセキュリティ上の欠陥が存在します。特に、認可設計の不備、データ保護の不足、監査ログの欠如は、患者のプライバシー侵害や不正アクセスに直結する深刻な問題です。

---

## Critical Issues（重大な問題）

### C1. API エンドポイントの認可チェック設計が欠如

**問題点:**
API 設計（5.1節）において、各エンドポイントに対する認可チェックの設計が一切記載されていません。RBAC の採用は記載されているものの（5.3節）、以下の重要な認可要件が設計されていません:

- `GET /api/patients/{id}`: 患者本人または担当医療従事者のみがアクセス可能とする所有権検証
- `GET /api/patients/{id}/records`: 診察履歴へのアクセス制御（患者本人、担当医、同一医療機関の医師）
- `GET /api/records/{id}`, `PUT /api/records/{id}`: カルテへのアクセス制御（作成した医師、同一医療機関の医師）
- `PUT /api/patients/{id}`: 患者情報更新の権限制御（本人のみ、または医療従事者が特定項目のみ更新可能）
- `DELETE /api/appointments/{id}`: 予約キャンセルの権限制御（予約者本人または医療機関スタッフ）

**影響:**
認可チェックが実装されない場合、認証済みの任意のユーザーが他人の患者情報や診察記録にアクセス可能となり、個人情報保護法・医療法に違反する重大なデータ漏洩が発生します。

**推奨対策:**
1. 各APIエンドポイントに対して、アクセス可能なロールと所有権検証ロジックを明示的に設計
2. Spring Security の `@PreAuthorize` アノテーションで実装する認可ルールを設計書に記載
3. リソース所有権検証のための設計例:
   ```
   GET /api/patients/{id}
   - 認可要件: (role=PATIENT AND userId=患者のuser_id) OR (role=DOCTOR AND 担当医療機関が一致) OR (role=ADMIN)
   - 実装: PatientService.verifyAccess(patientId, currentUser) メソッドで検証
   ```

### C2. 機密医療情報の暗号化設計が欠如

**問題点:**
データベースに保存される以下の機密情報に対する暗号化設計が明記されていません:

- `patients.insurance_number`（保険証番号）
- `medical_records.diagnosis`（診断内容）
- `medical_records.prescription`（処方薬）
- `medical_records.lab_results`（検査結果）

7.2節で「通信をTLS 1.3で暗号化」と記載されていますが、これは転送中暗号化（encryption in transit）であり、保存時暗号化（encryption at rest）の設計がありません。PostgreSQL が稼働するストレージが侵害された場合、平文で機密データが露出します。

**影響:**
データベースバックアップの漏洩、ストレージメディアの物理的盗難、インサイダー攻撃により、患者の診断内容・処方薬情報が漏洩し、プライバシー侵害および個人情報保護法違反が発生します。

**推奨対策:**
1. 機密フィールドに対してアプリケーション層での暗号化を設計:
   - Spring JPA の `@Convert` アノテーションでカラム暗号化コンバーターを適用
   - 暗号化アルゴリズム: AES-256-GCM
   - 鍵管理: AWS KMS を使用し、データ暗号化鍵（DEK）をエンベロープ暗号化
2. PostgreSQL の Transparent Data Encryption (TDE) またはディスク暗号化（AWS EBS暗号化）を併用
3. 暗号化対象カラムと暗号化方式をテーブル設計（4.2節）に明記

### C3. JWT トークンの安全な保存設計の欠如

**問題点:**
5.3節で「JWTトークンはlocalStorageに保存」と設計されていますが、これは XSS 攻撃に対して脆弱です。localStorage はJavaScript から自由にアクセス可能であるため、XSS 脆弱性が存在する場合、攻撃者がトークンを窃取し、患者・医療従事者になりすましてカルテデータにアクセス可能となります。

**影響:**
XSS 攻撃によるセッション乗っ取り、患者情報の不正閲覧、医療記録の改ざんが可能となります。

**推奨対策:**
1. JWT トークンを `HttpOnly`, `Secure`, `SameSite=Strict` 属性付きのクッキーに保存する設計に変更
2. CSRF 対策として、Double Submit Cookie パターンまたは Synchronizer Token パターンを併用
3. トークン保存方式を 5.3節に明記:
   ```
   - アクセストークン: HttpOnly cookie（XSS攻撃からの保護）
   - リフレッシュトークン: HttpOnly cookie（別ドメインまたはパス制限）
   - CSRF トークン: カスタムヘッダー（X-CSRF-Token）で送信
   ```

### C4. セキュリティ監査ログ設計の欠如

**問題点:**
6.2節のロギング方針には一般的なアプリケーションログの記載はありますが、以下のセキュリティ監査ログの設計が欠如しています:

- 認証失敗イベント（ブルートフォース攻撃検知のため）
- 権限変更イベント（ロール昇格の追跡）
- 患者カルテへのアクセスイベント（誰がいつ閲覧したか）
- 機密データの変更・削除イベント（診察記録の更新・削除）
- 管理者操作イベント（医療機関の追加・削除）

医療情報システムでは、アクセスログの保存は法的要件であり、監査証跡がない場合、コンプライアンス違反となります。

**影響:**
セキュリティインシデント発生時に原因調査ができず、不正アクセスの検知・対応が遅延します。また、医療法・個人情報保護法で求められる監査証跡が不足し、法的責任を問われる可能性があります。

**推奨対策:**
1. セキュリティ監査ログの要件を 6.2節に追加:
   ```
   - ログ対象イベント: 認証失敗、認可失敗、カルテアクセス、データ変更、権限変更、管理者操作
   - ログ項目: タイムスタンプ、ユーザーID、操作種別、対象リソース、IPアドレス、結果（成功/失敗）
   - ログ保存期間: 3年間（医療情報システム安全管理ガイドラインに準拠）
   - ログ改竄防止: CloudWatch Logs への書き込み専用アクセス設定、ログ整合性検証
   ```
2. Spring Security の `@EventListener` で認証・認可イベントをキャプチャ
3. AOP（Aspect-Oriented Programming）でカルテアクセス操作をインターセプトし監査ログ記録

---

## Significant Issues（重大度の高い問題）

### S1. セッションタイムアウトおよびトークン失効機構の設計不備

**問題点:**
5.3節で「トークンの有効期限は1時間」と記載されていますが、以下の設計が欠如しています:

- ユーザーの明示的なログアウト時にトークンを失効させる機構
- トークン失効リスト（ブラックリスト）の管理方式
- セッションのアイドルタイムアウト設計

JWT はステートレスであるため、サーバー側でトークンを無効化する仕組みがない場合、ログアウト後も有効期限まではトークンが利用可能となり、セキュリティリスクとなります。

**影響:**
ログアウト後もトークンが有効であるため、トークンが漏洩した場合に攻撃者が最大1時間不正アクセス可能です。

**推奨対策:**
1. トークン失効機構を設計:
   - Redis にトークン失効リスト（ブラックリスト）を保存
   - ログアウト時に `POST /api/auth/logout` でトークンIDをブラックリストに追加（TTL=トークン残存有効期限）
   - JWTフィルターでブラックリスト照合を実施
2. セッションタイムアウトポリシーを 5.3節に追加:
   ```
   - アイドルタイムアウト: 30分間操作がない場合はトークン失効
   - 絶対タイムアウト: ログインから8時間後は強制再認証
   ```

### S2. レート制限の不十分な設計

**問題点:**
3.2節で「レート制限（1分あたり100リクエスト）」が記載されていますが、以下の問題があります:

- レート制限がAPI Gateway レベルのみで、認証エンドポイント（`/api/auth/login`）に対する個別の制限がない
- IPアドレス単位の制限か、ユーザー単位の制限かが不明
- ブルートフォース攻撃対策としての認証失敗回数制限が設計されていない

**影響:**
認証エンドポイントへのブルートフォース攻撃により、弱いパスワードのアカウントが侵害されるリスクがあります。

**推奨対策:**
1. 認証エンドポイントに対する厳格なレート制限を設計:
   ```
   - /api/auth/login: IPアドレスあたり 1分間に5回まで
   - 認証失敗5回でアカウントを15分間ロック（Redis に失敗カウント保存）
   - ロック解除は時間経過または管理者による手動解除
   ```
2. レート制限設計を 3.2節または 7.2節に明記

### S3. 入力検証の詳細設計が不明確

**問題点:**
7.2節で「外部入力はSpring Validationで検証」と記載されていますが、具体的な検証ルールが設計されていません。特に以下のエンドポイントで懸念があります:

- `POST /api/auth/register`: ユーザー名・パスワードの複雑性要件、メールアドレス形式検証
- `POST /api/appointments`: 予約日時の妥当性検証（過去日時の禁止、営業時間内のチェック）
- `POST /api/records`: 診察記録の入力サイズ制限、特殊文字のエスケープ

**影響:**
不十分な入力検証により、以下の攻撃が可能となります:
- 弱いパスワードによるアカウント侵害
- 不正な予約データによるシステムの不整合
- 大量データ送信によるDoS攻撃

**推奨対策:**
1. 各APIエンドポイントの入力検証ルールを 5.2節に追加:
   ```
   POST /api/auth/register 入力検証:
   - username: 3-50文字、英数字とアンダースコアのみ
   - password: 8文字以上、大文字・小文字・数字・記号を各1文字以上含む
   - email: RFC 5322準拠のメールアドレス形式

   POST /api/appointments 入力検証:
   - appointment_time: 現在時刻より未来、医療機関の受付時間内
   - department: 許可された診療科リストに含まれる値のみ

   POST /api/records 入力検証:
   - diagnosis, prescription, lab_results: 最大5000文字
   - HTML タグの禁止（プレーンテキストのみ許可）
   ```

### S4. CORS 設定および Origin 検証の設計が欠如

**問題点:**
3.1節で「HTTPS + JSON形式で通信」と記載されていますが、CORS（Cross-Origin Resource Sharing）設定の設計が一切ありません。不適切なCORS設定（例: `Access-Control-Allow-Origin: *`）は、以下のリスクを引き起こします:

- 悪意のあるWebサイトからのAPIアクセス
- CSRF攻撃の容易化

**影響:**
攻撃者が偽のWebサイトを作成し、患者を誘導してAPI操作を実行させることで、予約の不正作成・キャンセル、個人情報の窃取が可能となります。

**推奨対策:**
1. CORS 設定を 7.2節または 5.3節に追加:
   ```
   - Access-Control-Allow-Origin:
     - 本番環境: https://medical-reservation.example.com のみ許可
     - 開発環境: http://localhost:3000 のみ許可
   - Access-Control-Allow-Credentials: true（クッキー送信を許可）
   - Access-Control-Allow-Methods: GET, POST, PUT, DELETE
   - Access-Control-Allow-Headers: Content-Type, Authorization
   ```
2. Originヘッダーの検証をSpring Security設定で実装

### S5. リフレッシュトークンの保存および失効設計の不備

**問題点:**
5.3節で「リフレッシュトークンは30日間」と記載されていますが、以下の設計が欠如しています:

- リフレッシュトークンの保存場所（DBまたはRedis）
- リフレッシュトークンの失効条件（ログアウト時、パスワード変更時）
- リフレッシュトークンのローテーション（使用時に新しいトークンを発行し、古いトークンを無効化）

**影響:**
リフレッシュトークンが漏洩した場合、最大30日間にわたり攻撃者がアクセストークンを再発行可能となり、被害が長期化します。

**推奨対策:**
1. リフレッシュトークン管理設計を 5.3節に追加:
   ```
   - 保存場所: PostgreSQL の refresh_tokens テーブル（user_id, token_hash, expires_at, created_at）
   - 失効条件:
     - ログアウト時: 該当トークンを削除
     - パスワード変更時: ユーザーの全リフレッシュトークンを削除
     - 新規発行時: 古いリフレッシュトークンを無効化（トークンローテーション）
   - セキュリティ強化: リフレッシュトークンは1回のみ使用可能とし、再利用検知時は全トークンを無効化（トークン盗難検知）
   ```

---

## Moderate Issues（中程度の問題）

### M1. 第三者ライブラリの脆弱性管理ポリシーが未設計

**問題点:**
2.4節で主要ライブラリのバージョンが記載されていますが、継続的な脆弱性管理ポリシーが設計されていません。Spring Boot、Spring Security、Hibernate などのライブラリに脆弱性が発見された場合の対応プロセスが不明です。

**影響:**
ライブラリの既知の脆弱性を悪用した攻撃（例: Spring4Shell）により、リモートコード実行やデータ漏洩が発生する可能性があります。

**推奨対策:**
1. 脆弱性管理ポリシーを 6.4節または 7.2節に追加:
   ```
   - 脆弱性スキャン: GitHub Dependabot または Snyk を使用し、依存関係の脆弱性を自動検出
   - パッチ適用: Critical/High 脆弱性は検出後48時間以内にパッチ適用
   - 定期更新: 四半期ごとにライブラリのマイナーバージョンアップデートを実施
   - 脆弱性対応フロー: 検出 → 影響評価 → パッチ適用 → テスト → デプロイ
   ```

### M2. シークレット管理の詳細設計が不十分

**問題点:**
6.4節で「環境変数はAWS Systems Manager Parameter Storeから取得」と記載されていますが、以下の詳細が不明です:

- どのシークレット（DB接続文字列、JWT署名鍵、暗号化鍵、外部API鍵）を管理するか
- Parameter Store のアクセス制御設計（IAMロールの最小権限設定）
- シークレットのローテーションポリシー

**影響:**
不適切なシークレット管理により、認証情報が漏洩し、データベースへの不正アクセスやトークン偽造が可能となります。

**推奨対策:**
1. シークレット管理設計を 6.4節に追加:
   ```
   管理対象シークレット:
   - DB_PASSWORD: PostgreSQL 接続パスワード
   - JWT_SIGNING_KEY: JWT署名用秘密鍵（HS256の場合）または公開鍵証明書（RS256の場合）
   - ENCRYPTION_KEY: 患者データ暗号化用のマスターキー（AWS KMS Customer Master Key ID）

   アクセス制御:
   - ECS Task Role に Parameter Store の GetParameter 権限を付与（特定パスのみ）
   - 開発環境と本番環境でパラメータパスを分離（/dev/*, /prod/*）

   ローテーションポリシー:
   - DB_PASSWORD: 90日ごとにローテーション
   - JWT_SIGNING_KEY: 1年ごとにローテーション（古い鍵は30日間並行運用）
   ```

### M3. エラーレスポンスに機密情報が含まれるリスク

**問題点:**
6.1節で「エラーメッセージには詳細なスタックトレースを含め、デバッグを容易にする」と設計されていますが、これは本番環境では重大なセキュリティリスクです。スタックトレースには以下の機密情報が含まれる可能性があります:

- データベースの内部構造（テーブル名、カラム名）
- ファイルパス（アプリケーションの内部構造）
- 使用しているライブラリのバージョン情報

**影響:**
攻撃者がエラーメッセージから内部構造を把握し、標的型攻撃（SQL インジェクション、パストラバーサル等）の精度を向上させます。

**推奨対策:**
1. エラーハンドリング方針を環境別に設計:
   ```
   本番環境:
   - クライアントへのエラーレスポンス: 汎用的なエラーメッセージのみ（例: "An error occurred. Please contact support."）
   - スタックトレース: サーバー側ログのみに記録（CloudWatch Logs）
   - エラーID: クライアントにユニークなエラーIDを返し、サポートチームがログを追跡可能にする

   開発環境:
   - 詳細なスタックトレースをレスポンスに含めることを許可
   ```
2. Spring Boot の `server.error.include-stacktrace=never` を本番環境で設定

### M4. データ保持期間およびデータ削除ポリシーの欠如

**問題点:**
診察記録（medical_records）や患者情報（patients）の保持期間およびデータ削除ポリシーが設計されていません。個人情報保護法では、利用目的が終了したデータは速やかに削除する義務があります。

**影響:**
不要なデータを長期間保持することで、データ漏洩時の被害範囲が拡大し、個人情報保護法違反のリスクが高まります。

**推奨対策:**
1. データ保持ポリシーを 7.2節または新規セクションに追加:
   ```
   - 診察記録: 最終診察日から5年間保持（医師法に準拠）
   - 患者アカウント: 最終ログインから3年間非アクティブの場合、アカウント削除の通知を送付し、30日後に削除
   - 予約データ: 予約日時から2年間保持
   - 監査ログ: 3年間保持

   削除プロセス:
   - 論理削除フラグ（deleted_at カラム）でソフトデリート
   - 保持期間終了後、バッチジョブで物理削除
   - 削除操作の監査ログ記録
   ```

### M5. XSS 対策の設計が不明確

**問題点:**
7.2節で入力検証について言及されていますが、出力エスケープ（XSS対策）の設計が明記されていません。特に、診察記録（diagnosis, prescription）など、医師が自由形式で入力するフィールドが将来的にWeb画面に表示される際、XSS脆弱性が発生する可能性があります。

**影響:**
XSS攻撃により、患者または医療従事者のセッショントークンが窃取され、アカウント乗っ取りが発生します。

**推奨対策:**
1. XSS 対策を 7.2節に追加:
   ```
   - フロントエンド（React）: デフォルトのJSXエスケープに依存し、dangerouslySetInnerHTML は使用禁止
   - バックエンド: JSON レスポンスの Content-Type を application/json に設定し、文字エンコーディングを UTF-8 に明示
   - CSP (Content Security Policy) ヘッダー設定:
     - default-src 'self'
     - script-src 'self'
     - style-src 'self' 'unsafe-inline'（必要最小限）
   ```

---

## Minor Improvements（軽微な改善提案）

### I1. パスワード複雑性要件の明記

現状、パスワードは「bcryptでハッシュ化」とのみ記載されていますが、パスワードポリシー（最小長、文字種要件）が設計されていません。5.3節に以下を追加することを推奨します:

```
パスワードポリシー:
- 最小長: 8文字
- 文字種: 大文字、小文字、数字、記号のうち3種類以上
- 禁止パターン: 連続文字（123456, abcdef）、一般的な辞書語
- パスワード履歴: 過去3回分のパスワードを再利用禁止
```

### I2. Multi-Factor Authentication (MFA) の検討

医療情報という高いセキュリティ要件を考慮すると、特に医療従事者アカウントには多要素認証（MFA）の導入を検討すべきです。設計書に将来の拡張として記載することを推奨します。

### I3. セキュリティヘッダーの設定

Spring Security による以下のセキュリティヘッダー設定を 7.2節に追加することを推奨します:

```
- X-Content-Type-Options: nosniff
- X-Frame-Options: DENY
- X-XSS-Protection: 1; mode=block
- Strict-Transport-Security: max-age=31536000; includeSubDomains
```

---

## Positive Aspects（評価できる点）

- TLS 1.3による通信暗号化の採用
- bcryptによるパスワードハッシュ化（適切なコスト係数10）
- PreparedStatementの使用によるSQLインジェクション対策
- Multi-AZ構成による可用性確保
- レート制限の導入（ただし改善の余地あり）

---

## 総合推奨事項

本設計書は、医療情報システムとして**Critical Issues に分類した4項目（C1-C4）を最優先で対処する必要があります**。特に:

1. **C1（API認可設計）**: 各エンドポイントの認可要件を設計し、実装前にレビューを実施
2. **C2（データ暗号化）**: 機密医療情報の保存時暗号化を設計し、鍵管理方式を確定
3. **C3（JWT保存方式）**: localStorage からHttpOnly クッキーへの変更とCSRF対策の追加
4. **C4（監査ログ）**: セキュリティ監査ログ要件を定義し、法的要件への適合を確認

これらの対策を実装せずにシステムを本番環境に展開することは、重大なセキュリティリスクおよび法的リスクを伴います。
