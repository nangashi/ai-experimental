# セキュリティ設計レビュー結果

## 重大な問題（Critical Issues）

### C1. カルテAPI・患者APIに認可チェックの設計が欠如

**問題点:**
カルテAPI（`GET /api/records/{id}`, `POST /api/records`, `PUT /api/records/{id}`）および患者API（`GET /api/patients/{id}`, `PUT /api/patients/{id}`, `GET /api/patients/{id}/records`）において、リソース所有権・アクセス権限の検証設計が明示されていない。現在の設計では「ロールベースアクセス制御（RBAC）により、エンドポイントごとに必要なロールを定義」とあるが、これはロールの有無のみをチェックする粗い認可であり、患者Aが患者Bのカルテを閲覧できてしまう可能性がある。

**影響分析:**
- **データ侵害:** 患者が他の患者の個人情報（氏名、生年月日、住所、保険証番号、診断内容、処方薬、検査結果）を取得可能
- **プライバシー侵害:** 医療情報の不正アクセスは医療法・個人情報保護法違反のリスク
- **信頼性の喪失:** 医療データの漏洩は組織の信用を致命的に損なう

**対策:**
1. **リソース所有権検証の設計:**
   - `GET /api/patients/{id}`: JWTから取得したユーザーIDと患者レコードのuser_idが一致することを検証、または医師ロールの場合は担当患者リストとの照合を設計
   - `GET /api/records/{id}`: 診察記録のpatient_idが呼び出し元患者のIDと一致するか、担当医師であることを検証
   - `PUT /api/patients/{id}`, `PUT /api/records/{id}`: 同様の所有権検証を設計

2. **医師による患者データアクセスの設計:**
   - 医師が患者データにアクセスする場合、事前に患者-医師の紐付け（担当関係）が存在することを検証する設計を追加
   - 診察記録作成時（`POST /api/records`）に、予約レコードのappointment_idを検証し、その予約が該当医師のものであることを確認

3. **監査ログの設計:**
   - 患者情報・カルテへのアクセスを全て記録し、不正アクセスの検知を可能にする

**該当箇所:** セクション5.1（患者API、カルテAPI）、セクション5.3（認証・認可方式）

---

### C2. 予約APIに認可チェックの設計が欠如

**問題点:**
予約API（`GET /api/appointments/{id}`, `PUT /api/appointments/{id}`, `DELETE /api/appointments/{id}`）において、予約レコードの所有権検証が設計されていない。患者が他の患者の予約を閲覧・変更・キャンセルできる可能性がある。

**影響分析:**
- **サービス妨害:** 他人の予約をキャンセルすることで、患者の診療機会を奪う
- **プライバシー侵害:** 予約情報（予約日時、診療科、医療機関）から個人の健康状態を推測可能
- **業務混乱:** 不正な予約変更により医療機関のスケジュール管理が破綻

**対策:**
1. **予約所有権検証の設計:**
   - `GET /api/appointments/{id}`: 予約レコードのpatient_idとJWTから取得した患者IDが一致することを検証、または医療従事者ロールの場合は所属医療機関のinstitution_idと一致することを検証
   - `PUT /api/appointments/{id}`, `DELETE /api/appointments/{id}`: 同様の所有権検証を設計

2. **医療機関側のアクセス制御設計:**
   - 医療従事者が予約を操作する場合、その予約のinstitution_idが従事者の所属医療機関と一致することを検証する設計を追加

**該当箇所:** セクション5.1（予約API）、セクション5.3（認証・認可方式）

---

### C3. JWTトークンのlocalStorage保存によるXSSリスク

**問題点:**
設計書5.3節で「JWTトークンはlocalStorageに保存」とあるが、localStorageはJavaScriptから自由にアクセス可能なため、XSS攻撃が成功した場合にトークンが窃取される。医療情報を扱うシステムでは、トークン窃取による不正アクセスのリスクは極めて深刻である。

**影響分析:**
- **アカウント乗っ取り:** XSS脆弱性が存在する場合、攻撃者がトークンを窃取し、被害者になりすまして医療情報にアクセス可能
- **セッションハイジャック:** リフレッシュトークン（30日間有効）も窃取されると、長期間の不正アクセスが可能

**対策:**
1. **HttpOnly Cookie への変更:**
   - JWTおよびリフレッシュトークンをHttpOnly属性付きCookieに保存する設計に変更
   - JavaScriptからのアクセスを防止し、XSSによるトークン窃取を緩和

2. **SameSite属性の設定:**
   - Cookie に `SameSite=Strict` または `SameSite=Lax` 属性を設定し、CSRF攻撃を緩和

3. **XSS対策の強化設計:**
   - Content Security Policy (CSP) ヘッダーの設定を設計に追加し、インラインスクリプトの実行を制限
   - React のデフォルトエスケープに依存するだけでなく、外部入力の厳格なサニタイゼーション方針を設計

**該当箇所:** セクション5.3（認証・認可方式）

---

## 重要な問題（Significant Issues）

### S1. CSRF保護の設計が欠如

**問題点:**
状態変更API（予約作成・更新・削除、患者情報更新、診察記録作成・更新など）に対するCSRF（Cross-Site Request Forgery）対策が設計されていない。攻撃者が悪意のあるサイトに誘導し、ユーザーの意図しない操作を実行させる可能性がある。

**影響分析:**
- **不正操作:** ユーザーが悪意のあるサイトを閲覧中に、意図せず予約をキャンセルされたり、患者情報を改ざんされたりする可能性
- **医療業務への影響:** 不正な予約変更により医療機関のスケジュールが混乱

**対策:**
1. **CSRFトークンの導入:**
   - Spring Securityの CSRF保護機能を有効化し、状態変更APIに対してCSRFトークンの検証を行う設計を追加
   - フロントエンドはCSRFトークンをリクエストヘッダーまたはリクエストボディに含める

2. **SameSite Cookie属性の設定:**
   - C3対策で提案したSameSite属性により、CSRF攻撃を二重に緩和

**該当箇所:** セクション5.1（全API）、セクション7.2（セキュリティ要件）

---

### S2. CORS設定の具体的な許可オリジンが未設計

**問題点:**
設計書にCORS（Cross-Origin Resource Sharing）設定の記載がない。本番環境で不適切なCORS設定（特に`Access-Control-Allow-Origin: *`とクレデンシャル付きリクエストの組み合わせ）を行うと、任意のオリジンからの認証付きリクエストを許可してしまう。

**影響分析:**
- **CSRF緩和策の無効化:** ワイルドカードのCORS設定により、悪意のあるサイトから認証付きリクエストが可能になる
- **データ漏洩:** クレデンシャル付きリクエストを許可すると、攻撃者のサイトから患者情報を取得可能

**対策:**
1. **明示的なオリジン許可リストの設計:**
   - 許可するオリジンを明示的にリスト化（例: `https://patient-app.example.com`, `https://admin.example.com`）
   - クレデンシャル付きリクエストを許可する場合、`Access-Control-Allow-Origin` にワイルドカード（`*`）を使用しない

2. **環境ごとの設定分離:**
   - 開発環境・ステージング環境・本番環境で異なるオリジンリストを設定する方針を設計

**該当箇所:** セクション3.1（全体構成）、セクション7.2（セキュリティ要件）

---

### S3. 内部通信（バックエンド-DB、マイクロサービス間）の暗号化が未設計

**問題点:**
設計書7.2節で「すべての通信をTLS 1.3で暗号化」とあるが、これは主に外部通信（クライアント-API Gateway）を指すと推測される。内部通信（Spring Boot - PostgreSQL、Spring Boot - Redis、ECS タスク間通信）の暗号化設計が明示されていない。

**影響分析:**
- **内部ネットワーク盗聴:** AWS内部ネットワークが侵害された場合、平文通信により医療情報が漏洩する可能性
- **コンプライアンス違反:** 医療データ保護規制では、通信経路全体の暗号化が求められる場合がある

**対策:**
1. **データベース接続の暗号化:**
   - PostgreSQL への接続にSSL/TLSを有効化し、証明書検証を行う設計を追加
   - Redis への接続もTLS有効化を検討（Redis 6.0以降でサポート）

2. **マイクロサービス間通信の暗号化:**
   - 将来的にマイクロサービス化する場合、サービス間通信にmTLS（相互TLS認証）を設計
   - 現時点ではモノリシック構成だが、設計時点で方針を明記

**該当箇所:** セクション7.2（セキュリティ要件）

---

### S4. 認証エンドポイントのレート制限設計が不十分

**問題点:**
API Gateway のレート制限は「1分あたり100リクエスト」とあるが、これは全エンドポイント一律の制限と推測される。認証エンドポイント（`POST /api/auth/login`, `POST /api/auth/register`）には、より厳格なレート制限が必要である。

**影響分析:**
- **ブルートフォース攻撃:** ログインエンドポイントへの大量リクエストにより、パスワード推測攻撃が成功する可能性
- **アカウント列挙:** 登録エンドポイントへの大量リクエストにより、既存ユーザー名を特定される可能性

**対策:**
1. **エンドポイント別レート制限の設計:**
   - `POST /api/auth/login`: IPアドレスあたり1分間に5回まで、または1時間に20回までなど、より厳格な制限を設計
   - `POST /api/auth/register`: 同様に厳格な制限を設計
   - `POST /api/auth/refresh`: トークンリフレッシュの乱用防止のため、適切な制限を設計

2. **アカウントロックアウト機構の設計:**
   - 連続ログイン失敗時にアカウントを一時ロックする機構を設計
   - ロックアウト時にはアカウント列挙を防ぐため、エラーメッセージを工夫（「ユーザー名またはパスワードが間違っています」等）

**該当箇所:** セクション3.2（API Gateway）、セクション5.1（認証API）

---

## 中程度の問題（Moderate Issues）

### M1. 保存データ（データベース、S3）の暗号化設計が未記載

**問題点:**
設計書7.2節で通信の暗号化は記載されているが、保存データ（at-rest）の暗号化設計が明示されていない。医療情報を含むデータベースおよびS3に保存される画像・ドキュメントの暗号化は、コンプライアンス要件として必須である。

**影響分析:**
- **物理的侵害時のデータ漏洩:** ストレージが物理的に侵害された場合、暗号化がないと医療情報が平文で漏洩
- **コンプライアンス違反:** 医療データ保護規制では保存データの暗号化が要求される場合がある

**対策:**
1. **データベース暗号化の設計:**
   - Amazon RDS for PostgreSQL の暗号化オプション（透過的データ暗号化）を有効化する設計を追加
   - 暗号化キーの管理にAWS KMSを使用

2. **S3暗号化の設計:**
   - S3バケットのデフォルト暗号化（SSE-S3またはSSE-KMS）を有効化する設計を追加

3. **バックアップの暗号化:**
   - データベースバックアップも暗号化されることを設計に明記

**該当箇所:** セクション2.2（データベース）、セクション2.3（ストレージ）、セクション7.2（セキュリティ要件）

---

### M2. ファイルアップロード機能のセキュリティ設計が欠如

**問題点:**
S3を「画像・ドキュメント」の保存に使用するとあるが、ファイルアップロード機能のセキュリティ設計（ファイルタイプ検証、サイズ制限、ストレージ分離、マルウェアスキャン）が記載されていない。

**影響分析:**
- **マルウェアアップロード:** 悪意のあるファイルがアップロードされ、他のユーザーがダウンロードすることで感染拡大
- **ストレージ枯渇:** サイズ制限がないと、大容量ファイルのアップロードによりストレージが枯渇
- **スクリプトインジェクション:** HTMLファイルがアップロードされ、ブラウザで開かれるとXSS攻撃が成立する可能性

**対策:**
1. **ファイルタイプ検証の設計:**
   - アップロードファイルの拡張子とMIMEタイプを検証し、許可リスト（例: JPG, PNG, PDF）のみ受け入れる設計を追加
   - ファイルのマジックナンバーを検証し、拡張子偽装を防止

2. **ファイルサイズ制限の設計:**
   - アップロードファイルのサイズ上限を設計（例: 10MB）

3. **ストレージ分離の設計:**
   - ユーザーアップロードファイルは専用のS3バケットに保存し、アプリケーションコードとは分離
   - S3バケットのパブリックアクセスをブロックし、署名付きURLによる一時的なアクセスのみ許可

4. **Content-Dispositionヘッダーの設計:**
   - ファイルダウンロード時に `Content-Disposition: attachment` ヘッダーを設定し、ブラウザでの直接実行を防止

**該当箇所:** セクション2.3（ストレージ）

---

### M3. セキュリティ監査ログの具体的な設計が不足

**問題点:**
設計書6.2節で一般的なログ方針は記載されているが、セキュリティ監査ログ（認証失敗、権限エラー、患者情報アクセス、管理者操作）の具体的な記録項目と保持期間が設計されていない。

**影響分析:**
- **インシデント対応の遅延:** 不正アクセスが発生した場合、詳細なログがないと原因究明が困難
- **コンプライアンス違反:** 医療情報保護規制では、アクセスログの記録と一定期間の保持が求められる場合がある

**対策:**
1. **監査ログ記録項目の設計:**
   - **認証イベント:** ログイン成功/失敗、ログアウト、トークンリフレッシュ（ユーザーID、IPアドレス、タイムスタンプ、結果）
   - **認可エラー:** 権限不足によるアクセス拒否（ユーザーID、リクエストされたリソース、操作、タイムスタンプ）
   - **機密データアクセス:** 患者情報・カルテ・診察記録へのアクセス（アクセス元ユーザーID、対象患者ID、操作種別、タイムスタンプ）
   - **管理者操作:** 医療機関登録・削除、ユーザー権限変更（操作者ID、対象、変更内容、タイムスタンプ）

2. **ログ保持期間の設計:**
   - セキュリティ監査ログは最低1年間保持する設計を追加（規制要件に応じて調整）

3. **ログの改ざん防止:**
   - ログをCloudWatch Logsに転送し、アプリケーション側から削除不可能にする

**該当箇所:** セクション6.2（ロギング方針）、セクション7.2（セキュリティ要件）

---

### M4. エラーメッセージにスタックトレースを含める設計が危険

**問題点:**
設計書6.1節で「エラーメッセージには詳細なスタックトレースを含め、デバッグを容易にする」とあるが、本番環境でスタックトレースを外部に公開すると、攻撃者にシステム内部情報（使用ライブラリ、ファイルパス、内部ロジック）を漏洩する。

**影響分析:**
- **情報漏洩:** スタックトレースから使用中のライブラリのバージョンを特定され、既知の脆弱性を突かれる可能性
- **攻撃の容易化:** 内部ロジックやファイルパスが露呈し、攻撃者が効率的に攻撃を計画できる

**対策:**
1. **環境別エラーレスポンスの設計:**
   - **本番環境:** エラーレスポンスには一般的なエラーメッセージのみを含め、スタックトレースは含めない
   - **開発環境・ステージング環境:** デバッグ目的でスタックトレースを含めることは許容

2. **内部ログへの詳細記録:**
   - スタックトレースは内部ログ（CloudWatch Logs）に記録し、運用チームのみがアクセス可能にする

**該当箇所:** セクション6.1（エラーハンドリング方針）

---

### M5. パスワードポリシーの設計が未記載

**問題点:**
設計書でパスワードは「bcryptアルゴリズム（コスト係数10）でハッシュ化」とあるが、パスワードの強度要件（最小文字数、複雑性）が設計されていない。

**影響分析:**
- **弱いパスワードの許容:** ユーザーが「123456」などの脆弱なパスワードを設定できると、ブルートフォース攻撃やリスト型攻撃が成功しやすい

**対策:**
1. **パスワードポリシーの設計:**
   - 最小文字数: 12文字以上（NIST推奨）
   - 複雑性要件: 大文字・小文字・数字・記号のうち3種類以上を含む
   - 一般的な辞書語やよくあるパスワードのブラックリストチェック

2. **パスワード変更時の検証:**
   - 古いパスワードと同一または類似するパスワードを拒否

**該当箇所:** セクション5.1（認証API）、セクション7.2（セキュリティ要件）

---

## 軽微な改善提案（Minor Improvements）

### I1. 依存ライブラリの脆弱性管理方針が未記載

**問題点:**
設計書に第三者ライブラリの脆弱性管理方針が記載されていない。使用しているライブラリ（Spring Boot, React, PostgreSQL driver等）に脆弱性が発見された場合の検知・対応プロセスが不明である。

**対策:**
- 依存ライブラリのバージョン管理ツール（Dependabot, Snyk等）を使用し、脆弱性を自動検知する方針を設計に追加
- 脆弱性発見時のパッチ適用・リリースプロセスを設計

**該当箇所:** セクション2.4（主要ライブラリ）、セクション6.4（デプロイメント方針）

---

### I2. シークレット管理の具体的な設計が不足

**問題点:**
設計書6.4節で「環境変数はECS Task Definitionに記載し、AWS Systems Manager Parameter Storeから取得」とあるが、JWTシークレットキー、データベース認証情報、外部API キー等のシークレット管理の具体的な設計が不足している。

**対策:**
- AWS Secrets Manager を使用し、シークレットを暗号化して保存する設計を追加
- シークレットのローテーション方針を設計（例: データベースパスワードは90日ごとに自動ローテーション）
- IAMロールによる最小権限の原則に基づくアクセス制御設計

**該当箇所:** セクション6.4（デプロイメント方針）

---

### I3. セッションタイムアウト後の自動ログアウト設計が未記載

**問題点:**
JWTの有効期限は1時間とあるが、フロントエンド側でトークン期限切れ時の自動ログアウト処理が設計されていない。

**対策:**
- フロントエンドでトークン有効期限を監視し、期限切れ時に自動的にログアウトしてログイン画面に遷移する設計を追加
- リフレッシュトークンが無効な場合も同様に処理

**該当箇所:** セクション5.3（認証・認可方式）

---

## ポジティブな点（Positive Aspects）

### P1. 通信の暗号化（TLS 1.3）が設計されている
設計書7.2節で「すべての通信をTLS 1.3で暗号化」と明記されており、外部通信の基本的な保護が考慮されている。

### P2. パスワードハッシュ化にbcryptを採用
bcryptアルゴリズム（コスト係数10）によるパスワードハッシュ化が設計されており、レインボーテーブル攻撃への耐性がある。

### P3. PreparedStatementによるSQLインジェクション対策
設計書7.2節で「SQLインジェクション対策としてPreparedStatementを使用」と明記されており、基本的なインジェクション対策が考慮されている。

### P4. API Gatewayでのレート制限
API Gatewayで「1分あたり100リクエスト」のレート制限が設計されており、DoS攻撃の基本的な緩和策が存在する。

### P5. Multi-AZ構成による可用性確保
データベースのMulti-AZ構成により、障害時の自動フェイルオーバーが設計されており、可用性が考慮されている。
