# セキュリティ設計レビュー結果

## 重大な問題（Critical Issues）

### C1. JWTトークンのlocalStorage保存による窃取リスク
**問題箇所**: 5.3節「認証・認可方式」
> JWTトークンはlocalStorageに保存し、各APIリクエストのAuthorizationヘッダーで送信する

**詳細**:
JWTトークンをlocalStorageに保存する設計は、XSS攻撃によるトークン窃取の脆弱性を生じさせます。XSS脆弱性が一箇所でも存在すれば、攻撃者はJavaScriptからlocalStorageにアクセスし、患者の医療情報や予約情報に不正アクセスできます。

**影響**:
- 医療データへの不正アクセス（個人情報保護法、GDPR違反のリスク）
- なりすましによる予約の不正操作
- 患者カルテの閲覧・改ざん

**対策**:
- JWTをHttpOnly/Secure属性付きCookieに保存する設計に変更
- CSRF対策としてSameSite=Strict/Lax属性を設定
- または、短命なアクセストークンとHttpOnly Cookieによるリフレッシュトークンを組み合わせたダブルトークン方式を採用

### C2. 患者カルテAPIにおける認可チェックの欠如
**問題箇所**: 5.1節「カルテAPI」
- `GET /api/records/{id}` - 診察記録取得
- `POST /api/records` - 診察記録作成
- `PUT /api/records/{id}` - 診察記録更新

**詳細**:
カルテ関連エンドポイントに対して、患者本人または担当医のみがアクセスできるという認可設計が明記されていません。ロールベースアクセス制御（RBAC）の言及はありますが、リソースレベルの所有権確認設計が欠如しています。これにより、DOCTOR ロールを持つ任意の医師が、担当外の患者のカルテにアクセスできる可能性があります。

**影響**:
- 担当外医師による患者カルテの不正閲覧
- 医療プライバシーの重大な侵害
- 医療法・個人情報保護法違反のリスク

**対策**:
- カルテアクセス時に以下の認可チェックを明示的に設計:
  - 患者ロールの場合: `patient_id == JWT.userId` を検証
  - 医師ロールの場合: 医師と患者の紐付け（担当医リレーション）を検証
  - 管理者ロールの場合: 監査ログ出力を必須とする
- エンドポイントごとの認可ロジックをAPI設計書に明記

### C3. 予約APIにおける患者データ越境アクセスのリスク
**問題箇所**: 5.1節「予約API」、「患者API」
- `GET /api/appointments` - 予約一覧取得
- `GET /api/patients/{id}` - 患者情報取得
- `GET /api/patients/{id}/records` - 診察履歴取得

**詳細**:
予約・患者情報取得APIにおいて、リクエストユーザーと対象患者IDの一致確認が設計されていません。患者Aが患者BのIDを指定することで、Bの予約情報や診察履歴にアクセスできる脆弱性（IDOR: Insecure Direct Object Reference）が存在します。

**影響**:
- 他患者の個人情報・医療履歴の漏洩
- 予約情報の不正取得によるプライバシー侵害

**対策**:
- 各エンドポイントに以下の認可ロジックを追加:
  - `GET /api/appointments`: JWTから取得したuser_idに紐付く予約のみ返却
  - `GET /api/patients/{id}`: `{id} == JWT.userId.patientId` を検証
  - `GET /api/patients/{id}/records`: 同上
- 医師・管理者ロールの場合の例外処理（担当患者確認、監査ログ）を設計

### C4. エラーメッセージにおける詳細情報漏洩
**問題箇所**: 6.1節「エラーハンドリング方針」
> エラーメッセージには詳細なスタックトレースを含め、デバッグを容易にする

**詳細**:
本番環境でスタックトレースを含むエラーレスポンスを返却する設計は、システム内部構造（使用フレームワーク、ディレクトリ構造、クラス名）を攻撃者に露呈します。これにより、既知の脆弱性を持つライブラリバージョンの特定や、攻撃対象の絞り込みが容易になります。

**影響**:
- フレームワーク・ライブラリの詳細情報漏洩による攻撃表面の拡大
- 内部実装ロジックの推測を可能にする

**対策**:
- 本番環境ではスタックトレースを含まない汎用的なエラーメッセージを返却
- 詳細なエラー情報はサーバー側のログにのみ記録
- 開発環境と本番環境で異なるエラーハンドリング設定を採用
- エラーレスポンスには一意のエラーIDのみを含め、詳細はログと紐付けて管理

### C5. ログへの機密情報出力によるデータ漏洩リスク
**問題箇所**: 6.2節「ロギング方針」
> すべてのAPIリクエスト・レスポンスをINFOレベルでログ出力する
> ログフォーマット例に `"requestBody": "{...}"` を含む

**詳細**:
リクエストボディ全体をログ出力する設計は、患者の個人情報（氏名、生年月日、住所、保険証番号）、パスワード、診断内容などの機密データがログに平文記録されることを意味します。ログファイルへのアクセス権限管理が不適切な場合、内部関係者による情報漏洩や、ログ保管サービス（CloudWatch Logs）の侵害時のデータ流出リスクがあります。

**影響**:
- 医療情報・個人情報の平文ログ記録による漏洩リスク
- ログアクセス権限を持つ開発者・運用担当者による不正閲覧
- ログ保管期間中の長期的な情報漏洩リスク

**対策**:
- ログ出力時に機密フィールドをマスキング（例: `"password": "***"`, `"insurance_number": "****1234"`）
- PII（個人識別情報）を含むフィールドのリストを定義し、自動マスキング処理を実装
- ログアクセス権限を最小限に制限し、監査ログで追跡
- ログ保管期間とデータ保持ポリシーを医療情報管理規則に準拠させる

## 重要な問題（Significant Issues）

### S1. リフレッシュトークンの保存場所と無効化機構の未設計
**問題箇所**: 5.3節「認証・認可方式」
> トークンの有効期限は1時間、リフレッシュトークンは30日間

**詳細**:
リフレッシュトークンの保存方法（localStorage/Cookie）、サーバー側での無効化機構（トークンブラックリスト、データベース管理）が設計されていません。これにより、デバイス紛失時やアカウント侵害時に、盗まれたリフレッシュトークンを無効化できず、最大30日間不正アクセスが継続するリスクがあります。

**影響**:
- デバイス紛失・盗難時のアカウント乗っ取り継続
- ログアウト後もリフレッシュトークンが有効なセッション固定化

**対策**:
- リフレッシュトークンをデータベースまたはRedisに保存し、サーバー側で管理
- ログアウト時、パスワード変更時にリフレッシュトークンを無効化
- リフレッシュトークンのローテーション（使用時に新しいトークンを発行し、旧トークンを無効化）を実装

### S2. レート制限の不十分な設定
**問題箇所**: 3.2節「主要コンポーネントの責務と依存関係」
> レート制限（1分あたり100リクエスト）

**詳細**:
全エンドポイントに一律のレート制限（100 req/min）を適用する設計は、攻撃対象となりやすいエンドポイント（ログイン、パスワードリセット）への保護が不十分です。ブルートフォース攻撃やクレデンシャルスタッフィング攻撃を受けやすく、また、正規ユーザーの利用にも影響を与える可能性があります。

**影響**:
- ログインエンドポイントへのブルートフォース攻撃
- パスワードリセット機能の悪用による DoS 攻撃

**対策**:
- エンドポイント別のレート制限を設計:
  - ログイン: 5回/分/IPアドレス、10回/時間/ユーザー名
  - パスワードリセット: 3回/時間/メールアドレス
  - 予約作成: 10回/分/ユーザー
  - 参照系API: 100回/分/ユーザー
- アカウントロックアウト機構（5回連続失敗で15分間ロック）を追加

### S3. CORS設定の未定義
**問題箇所**: 設計書全体
CORS（Cross-Origin Resource Sharing）ポリシーの設計が欠如しています。

**詳細**:
CORS設定が未定義のため、開発段階で `Access-Control-Allow-Origin: *` のような緩い設定が行われ、本番環境にそのまま展開されるリスクがあります。これにより、悪意のあるサイトからのクロスオリジンリクエストを受け付け、CSRF攻撃やデータ窃取の脆弱性が生じます。

**影響**:
- 悪意のあるサイトからのAPIアクセス許可
- CSRF攻撃によるユーザーの意図しない操作実行

**対策**:
- 許可するオリジンを明示的に定義（例: `https://patient.example.com`, `https://admin.example.com`）
- 本番環境では `Access-Control-Allow-Credentials: true` と組み合わせて、特定ドメインのみ許可
- CORS設定をインフラコード（API Gateway設定）に明記

### S4. セッションタイムアウトとアクティブセッション管理の未設計
**問題箇所**: 5.3節「認証・認可方式」
セッションタイムアウトポリシーとアクティブセッション数の制限が設計されていません。

**詳細**:
JWTの有効期限（1時間）は記載されていますが、ユーザーの無操作時の自動ログアウト、同時ログインセッション数の制限が未設計です。これにより、公共端末でのログアウト忘れや、アカウント共有による不正利用のリスクがあります。

**影響**:
- 公共端末でのセッション放置による不正アクセス
- アカウント共有による複数デバイスからの同時不正利用

**対策**:
- アクティビティベースのセッションタイムアウト（15分間無操作で自動ログアウト）を設計
- 同時アクティブセッション数の制限（最大3セッション）を実装
- 新規ログイン時に既存セッションリストを表示し、不審なセッションの強制終了機能を提供

### S5. 医療機関管理者による不正操作の監査ログ不足
**問題箇所**: 6.2節「ロギング方針」、5.1節「API設計」
管理者向け機能（医療機関登録・管理）の監査ログ設計が不明確です。

**詳細**:
管理者による医療機関の追加・削除、患者データへのアクセスなど、高権限操作の監査ログ要件が明記されていません。内部不正や権限濫用を検出・追跡できないリスクがあります。

**影響**:
- 管理者による不正な医療機関登録
- 患者データへの不正アクセスの追跡不能

**対策**:
- 以下の操作を必ず監査ログに記録する設計を追加:
  - 管理者による医療機関の作成・更新・削除（操作者ID、タイムスタンプ、変更内容）
  - 管理者による患者カルテへのアクセス（アクセス理由の入力を必須化）
  - ロール変更操作（誰が誰のロールを変更したか）
- 監査ログは改ざん防止のため別テーブルに保存し、削除不可とする
- 定期的な監査ログレビュープロセスを確立

## 中程度の問題（Moderate Issues）

### M1. パスワードポリシーの未定義
**問題箇所**: 5.1節「認証API」、7.2節「セキュリティ要件」
bcryptによるハッシュ化は記載されていますが、パスワードの複雑性要件が未定義です。

**影響**: 弱いパスワードによるブルートフォース攻撃の成功率上昇

**対策**:
- パスワードポリシーを定義（最小12文字、大小英字・数字・記号を含む）
- パスワード強度チェック機能の実装
- よく使われるパスワードのブラックリスト適用

### M2. SQL インジェクション対策の不完全性
**問題箇所**: 7.2節「セキュリティ要件」
> SQLインジェクション対策としてPreparedStatementを使用する

**詳細**:
PreparedStatementの使用は記載されていますが、動的クエリ生成や ORDER BY 句、LIKE検索におけるエスケープ処理の設計が欠如しています。

**影響**: 特殊なクエリパターンでのSQLインジェクション脆弱性の残存

**対策**:
- 動的クエリが必要な箇所（検索フィルタ、ソート）でのホワイトリスト検証を明記
- Spring Data JPAのクエリメソッド使用を基本とし、ネイティブクエリの利用基準を定義
- コードレビューチェックリストにSQLインジェクション対策項目を追加

### M3. XSS対策の不明確さ
**問題箇所**: 7.2節「セキュリティ要件」
出力エスケープやContent Security Policy（CSP）の設計が記載されていません。

**影響**: 診断内容や患者名などユーザー入力値を含むフィールドでのXSS脆弱性

**対策**:
- フロントエンドでのReact自動エスケープに依存するだけでなく、`dangerouslySetInnerHTML` の使用禁止ルールを明記
- Content Security Policyヘッダーの設定（script-src 'self' など）
- 入力検証とサニタイゼーションのルール定義

### M4. ファイルアップロード機能のセキュリティ設計欠如
**問題箇所**: 2.3節「インフラ・デプロイ環境」
> ストレージ: Amazon S3（画像・ドキュメント）

**詳細**:
S3を利用した画像・ドキュメント保存は記載されていますが、アップロードファイルの検証、サイズ制限、マルウェアスキャン、アクセス制御が未設計です。

**影響**:
- 悪意のあるファイルのアップロードによるマルウェア配布
- 大容量ファイルアップロードによる DoS 攻撃

**対策**:
- ファイルタイプのホワイトリスト検証（MIMEタイプとマジックナンバーの両方）
- ファイルサイズ上限（例: 10MB）の設定
- アップロードファイルのウイルススキャン（AWS GuardDutyやサードパーティツール）
- S3バケットポリシーによるアクセス制限（CloudFront経由のみアクセス許可）

### M5. 依存ライブラリの脆弱性管理プロセス未定義
**問題箇所**: 2.4節「主要ライブラリ」
使用ライブラリは記載されていますが、脆弱性スキャンや更新プロセスが未設計です。

**影響**: 既知の脆弱性を持つライブラリの使用継続

**対策**:
- Dependabotや Snyk を使用した依存ライブラリの自動脆弱性スキャン
- Critical/High脆弱性の対応SLA（検出後7日以内にパッチ適用）を定義
- 定期的な依存ライブラリ更新サイクルの確立

### M6. データベース接続情報の保護強化
**問題箇所**: 6.4節「デプロイメント方針」
> 環境変数はECS Task Definitionに記載し、AWS Systems Manager Parameter Storeから取得

**詳細**:
Parameter Storeの使用は適切ですが、データベース認証情報の暗号化（SecureString）や、IAMロールベースのアクセス制御の明記がありません。

**影響**: タスク定義へのアクセス権限を持つ攻撃者によるDB認証情報の窃取

**対策**:
- Parameter StoreでSecureStringタイプを使用（KMS暗号化）
- IAMロールによるParameter Storeアクセス制御を設計
- RDS IAM認証の採用を検討（パスワード不要のトークンベース認証）

## 軽微な改善提案（Minor Improvements）

### I1. JWTの署名アルゴリズム明記
現在「JWT」とのみ記載されていますが、HS256/RS256などの署名アルゴリズムを明記することを推奨します。医療システムの場合、RS256（非対称鍵）の使用が望ましいです。

### I2. APIバージョニング戦略の追加
将来的なAPI仕様変更に備え、バージョニング戦略（URLパス `/api/v1/...` またはヘッダーベース）を設計することを推奨します。

### I3. セキュリティヘッダーの設定
以下のHTTPセキュリティヘッダーの設定を推奨します:
- `Strict-Transport-Security`（HSTS）
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `Referrer-Policy: strict-origin-when-cross-origin`

## ポジティブな評価

以下の設計は適切なセキュリティ対策として評価できます:

1. **TLS 1.3の採用**: 最新の暗号化プロトコルによる通信保護
2. **bcryptによるパスワードハッシュ化**: 適切なコスト係数（10）の設定
3. **JWTベース認証の採用**: ステートレスな認証設計
4. **Spring Validationの使用**: 入力検証フレームワークの活用
5. **PreparedStatementの使用**: SQLインジェクション対策の基本実装
6. **Multi-AZ構成**: データベースの可用性確保
7. **定期バックアップ**: データ保護とインシデント対応の準備

## まとめ

本設計書は医療予約システムとして基本的なセキュリティ要素を含んでいますが、**認可設計の詳細化**と**機密情報保護の強化**が最優先課題です。特に、患者カルテへのアクセス制御（C2）、認証トークンの安全な保存（C1）、APIレベルの認可チェック（C3）は、医療情報を扱うシステムとして必須の対策です。

重大な問題5件、重要な問題5件の対処を完了することで、システムのセキュリティ基盤が大幅に向上します。また、ログへの機密情報出力（C5）とエラーメッセージの情報漏洩（C4）の修正は、インシデント発生時の被害拡大を防ぐために不可欠です。
