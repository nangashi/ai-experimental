# 正解キー（Validation用）

## 実行条件
- **観点**: セキュリティ（設計レビュー）
- **入力型**: 設計書
- **ドメイン**: 暗号資産取引プラットフォーム
- **埋め込み問題数**: 15問

## 埋め込み問題一覧

### P01: JWTのリフレッシュトークン未実装
- **カテゴリ**: 認証・認可設計
- **深刻度**: 中
- **検出難易度**: medium
- **該当箇所**: セクション5.3（認証・認可方式）「リフレッシュトークンは実装しない（再ログインを要求する設計）」
- **問題の説明**: アクセストークンの有効期限が15分と短く、リフレッシュトークンが実装されていない。これにより取引中に頻繁なログインが必要となり、ユーザーエクスペリエンスが低下するだけでなく、パスワード再入力時のフィッシングリスクが増大する。
- **検出判定基準**:
  - ○（検出）: リフレッシュトークンの欠如によるセキュリティリスク（フィッシング機会増加、セッション管理の脆弱性）またはUX低下を指摘している
  - △（部分検出）: トークン有効期限の短さへの言及はあるが、リフレッシュトークン実装の必要性に触れていない
  - ×（未検出）: 言及なし

### P02: JWT署名アルゴリズムの未定義
- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **検出難易度**: hard
- **該当箇所**: セクション5.3（認証・認可方式）
- **問題の説明**: JWTの署名アルゴリズム（HS256, RS256等）および鍵管理方針が設計書に記載されていない。アルゴリズム選択を誤るとトークン偽造のリスクがある。
- **検出判定基準**:
  - ○（検出）: JWT署名アルゴリズムまたは鍵管理方針の欠如を指摘している
  - △（部分検出）: JWTの設定不足を指摘しているが、署名アルゴリズムに特定していない
  - ×（未検出）: 言及なし

### P03: KYC書類の暗号化方針の欠如
- **カテゴリ**: データ保護
- **深刻度**: 重大
- **検出難易度**: medium
- **該当箇所**: セクション4.2（kyc_documentsテーブル）、セクション7.2（セキュリティ要件）
- **問題の説明**: KYC書類（身分証明書画像等）をS3に保存する設計だが、保存時の暗号化方針（SSE-S3, SSE-KMS等）が明記されていない。機密性の高い個人情報を平文で保存する可能性がある。
- **検出判定基準**:
  - ○（検出）: KYC書類または機密ファイルの保存時暗号化（at-rest encryption）の欠如を指摘している
  - △（部分検出）: データ暗号化への言及はあるが、ファイルストレージ（S3）への適用に触れていない
  - ×（未検出）: 言及なし

### P04: データベース暗号化の欠如
- **カテゴリ**: データ保護
- **深刻度**: 重大
- **検出難易度**: hard
- **該当箇所**: セクション7.2（セキュリティ要件）
- **問題の説明**: ユーザー情報、取引履歴、ウォレット残高など機密データを扱うデータベースに対し、暗号化（Transparent Data Encryption等）の記載がない。データベースファイルへのアクセスで情報漏洩のリスクがある。
- **検出判定基準**:
  - ○（検出）: データベースの保存時暗号化（at-rest encryption）の欠如を指摘している
  - △（部分検出）: 転送時暗号化（TLS）への言及はあるが、保存時暗号化に触れていない
  - ×（未検出）: 言及なし

### P05: 個人情報のログ出力リスク
- **カテゴリ**: データ保護
- **深刻度**: 中
- **検出難易度**: easy
- **該当箇所**: セクション6.2（ロギング方針）のログフォーマット例に `"user_id"` を含む記載
- **問題の説明**: ロギング方針でユーザーIDを含むログフォーマット例が示されているが、PIIのログ出力に関する方針（マスキング、除外対象フィールド）が未定義。emailやアドレス等の個人情報がログに混入するリスクがある。
- **検出判定基準**:
  - ○（検出）: ログへの個人情報（PII）出力のリスクまたはマスキング方針の欠如を指摘している
  - △（部分検出）: ログセキュリティへの言及はあるが、PII出力に特定していない
  - ×（未検出）: 言及なし

### P06: CORS設定の未定義
- **カテゴリ**: 入力検証・攻撃防御
- **深刻度**: 中
- **検出難易度**: hard
- **該当箇所**: セクション5（API設計）
- **問題の説明**: CORSポリシー（許可するオリジン、メソッド、ヘッダー）の設計が記載されていない。適切に設定されないと、意図しないドメインからのAPIアクセスを許可してしまう可能性がある。
- **検出判定基準**:
  - ○（検出）: CORS設定の欠如またはオリジン制御の必要性を指摘している
  - △（部分検出）: クロスオリジンセキュリティへの言及はあるが、具体的なCORS設定に触れていない
  - ×（未検出）: 言及なし

### P07: 出力エスケーピング方針の不明確さ
- **カテゴリ**: 入力検証・攻撃防御
- **深刻度**: 軽微
- **検出難易度**: medium
- **該当箇所**: セクション7.2（セキュリティ要件）「XSS対策として出力時にHTMLエスケープ処理を実施」
- **問題の説明**: HTMLエスケープの記載があるが、JSON APIレスポンスが主体の設計でHTMLエスケープの適用箇所が不明確。実装時の混乱を招く可能性がある。
- **検出判定基準**:
  - ○（検出）: HTMLエスケープ適用箇所の不明確さまたはJSON APIでの不適切さを指摘している
  - △（部分検出）: XSS対策の不足を指摘しているが、エスケープ方式に触れていない
  - ×（未検出）: 言及なし

### P08: WebSocket認証の脆弱性
- **カテゴリ**: 認証・認可設計
- **深刻度**: 中
- **検出難易度**: easy
- **該当箇所**: セクション5.3（認証・認可方式）「WebSocket接続時は初回メッセージでJWTを送信し認証」
- **問題の説明**: WebSocket接続時に初回メッセージでJWTを送信する設計だが、接続確立時の認証が行われていない。接続後の初回メッセージまでの間、未認証の接続が存在する状態となる。
- **検出判定基準**:
  - ○（検出）: WebSocket接続確立時の認証欠如またはハンドシェイク時のトークン検証の必要性を指摘している
  - △（部分検出）: WebSocketセキュリティへの言及はあるが、接続タイミングに触れていない
  - ×（未検出）: 言及なし

### P09: エラーメッセージの情報漏洩リスク
- **カテゴリ**: 脅威モデリング（Information Disclosure）
- **深刻度**: 軽微
- **検出難易度**: medium
- **該当箇所**: セクション6.1（エラーハンドリング方針）のエラーレスポンス例に `"field": "quantity"` を含む詳細情報
- **問題の説明**: エラーレスポンスに詳細なフィールド名を含めている。攻撃者にシステム内部の構造情報を提供する可能性がある（情報漏洩の観点で問題）。
- **検出判定基準**:
  - ○（検出）: エラーメッセージによる内部情報漏洩のリスクを指摘している
  - △（部分検出）: エラーハンドリングセキュリティへの言及はあるが、情報漏洩に特定していない
  - ×（未検出）: 言及なし

### P10: レート制限の不十分な設計
- **カテゴリ**: 脅威モデリング（DoS）
- **深刻度**: 中
- **検出難易度**: medium
- **該当箇所**: セクション3.2（API Gateway）および7.2（セキュリティ要件）のレート制限設定
- **問題の説明**: レート制限が全体レベル（1000 req/min）のみで、エンドポイント別・機能別の制限が設定されていない。特定の重いエンドポイント（注文作成等）への集中的なアクセスでDoSが発生する可能性がある。
- **検出判定基準**:
  - ○（検出）: エンドポイント別レート制限の欠如またはきめ細かいDoS対策の必要性を指摘している
  - △（部分検出）: レート制限の不足を指摘しているが、エンドポイント別設定に触れていない
  - ×（未検出）: 言及なし

### P11: 監査ログ設計の欠如
- **カテゴリ**: 脅威モデリング（Repudiation）
- **深刻度**: 中
- **検出難易度**: hard
- **該当箇所**: セクション6.2（ロギング方針）
- **問題の説明**: アプリケーションログの記載はあるが、セキュリティイベント専用の監査ログ（認証失敗、権限変更、管理者操作、異常な取引パターン）の設計が欠如している。インシデント調査時の証跡が不十分となる。
- **検出判定基準**:
  - ○（検出）: セキュリティ監査ログまたはセキュリティイベント記録の欠如を指摘している
  - △（部分検出）: ロギングの不足を指摘しているが、監査ログに特定していない
  - ×（未検出）: 言及なし

### P12: 入金トランザクションの完全性検証の欠如
- **カテゴリ**: 脅威モデリング（Tampering）
- **深刻度**: 重大
- **検出難易度**: hard
- **該当箇所**: セクション3.3（データフロー - 入出金フロー）
- **問題の説明**: ブロックチェーンからの入金検出処理でトランザクション署名の検証や完全性確認の記載がない。偽造トランザクションを検出できず、不正入金の可能性がある。
- **検出判定基準**:
  - ○（検出）: ブロックチェーントランザクションの署名検証または完全性検証の欠如を指摘している
  - △（部分検出）: 入金処理のセキュリティ不足を指摘しているが、完全性検証に特定していない
  - ×（未検出）: 言及なし

### P13: 脆弱性管理の具体的プロセス欠如
- **カテゴリ**: インフラ・依存関係・監査
- **深刻度**: 軽微
- **検出難易度**: easy
- **該当箇所**: セクション7.4（コンプライアンス要件）に外部監査の記載あり、ただし依存ライブラリの脆弱性管理プロセスは未記載
- **問題の説明**: 外部セキュリティ監査の記載はあるが、日常的な依存ライブラリの脆弱性スキャン・パッチ適用プロセスが設計されていない。CVE対応が遅延するリスクがある。
- **検出判定基準**:
  - ○（検出）: 依存ライブラリの脆弱性管理プロセス（スキャン、パッチ適用）の欠如を指摘している
  - △（部分検出）: ライブラリセキュリティへの言及はあるが、継続的管理プロセスに触れていない
  - ×（未検出）: 言及なし

### P14: シークレットのローテーション方針の欠如
- **カテゴリ**: インフラ・依存関係・監査
- **深刻度**: 中
- **検出難易度**: hard
- **該当箇所**: セクション6.4（デプロイメント方針）「シークレット管理はGoogle Secret Managerを使用」
- **問題の説明**: Secret Managerの使用は記載されているが、シークレット（DB認証情報、APIキー等）のローテーション方針が定義されていない。長期間同一の認証情報を使用し続けると、漏洩時の影響が拡大する。
- **検出判定基準**:
  - ○（検出）: シークレットローテーション方針の欠如または定期的な更新の必要性を指摘している
  - △（部分検出）: シークレット管理の不足を指摘しているが、ローテーションに触れていない
  - ×（未検出）: 言及なし

### P15: TOTP実装の詳細設計欠如
- **カテゴリ**: 認証・認可設計
- **深刻度**: 軽微
- **検出難易度**: medium
- **該当箇所**: セクション4.2（usersテーブル）に `totp_secret` カラムあり、セクション5.1にTOTP APIの記載あり
- **問題の説明**: TOTPシークレットをデータベースに保存する設計だが、暗号化方式やバックアップコードの設計が欠如している。シークレット漏洩時に2段階認証が無効化されるリスクがある。
- **検出判定基準**:
  - ○（検出）: TOTPシークレットの暗号化またはバックアップコード設計の欠如を指摘している
  - △（部分検出）: 2段階認証のセキュリティ不足を指摘しているが、シークレット保護に特定していない
  - ×（未検出）: 言及なし

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 脅威モデリング（DoS） | Kafkaへのメッセージ送信時のバックプレッシャー制御の欠如 | Kafkaメッセージングの過負荷対策またはバックプレッシャー設計の欠如を指摘 |
| B02 | データ保護 | Multi-AZ構成のレプリカ間データ転送の暗号化方針が未定義 | レプリケーション時の転送暗号化の必要性を指摘 |
| B03 | 認証・認可設計 | APIキー認証の鍵管理・無効化プロセスが未設計 | APIキーのライフサイクル管理の欠如を指摘 |
| B04 | 入力検証・攻撃防御 | WebSocketメッセージの入力検証方針が未定義 | WebSocketペイロードの検証・サニタイゼーションの欠如を指摘 |
| B05 | インフラ・依存関係・監査 | コンテナイメージの脆弱性スキャンプロセスが未記載 | イメージスキャンまたはコンテナセキュリティの欠如を指摘 |
| B06 | 脅威モデリング（Elevation of Privilege） | 管理者権限の昇格操作に対する承認フローが未設計 | 権限変更の承認プロセスまたは監視の欠如を指摘 |
| B07 | データ保護 | ホットウォレット秘密鍵の保護方式（HSM等）が未定義 | 秘密鍵の保護レベルまたはHSM使用の欠如を指摘 |
| B08 | 入力検証・攻撃防御 | 出金先アドレスのホワイトリスト機能の欠如 | アドレス検証またはホワイトリスト制御の欠如を指摘 |
