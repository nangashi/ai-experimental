# エージェント利用ガイドライン

スキル実装時にエージェントを使うべきか、使うならどの仕組み（Task tool サブエージェント / TeamCreate チーム）を採用すべきかの判断基準をまとめたもの。

## 判断フロー

```
タスクを分析
├─ サブタスクが完全に独立している？
│   └─ YES → サブエージェント（Task tool）
├─ エージェント間対話が必要？（下記4類型に該当するか）
│   ├─ 類型1: 反復フィードバックループ → TeamCreate
│   ├─ 類型2: 発見の動的連鎖 → TeamCreate
│   ├─ 類型3: コンテキスト保持型ハンドオフ → TeamCreate
│   └─ 類型4: 交渉・合意形成 → TeamCreate
└─ いずれにも該当しない → サブエージェントで十分
```

**ケースが最重要**: 上記4類型のいずれかに該当しなければ、TeamCreate はコスト（サブエージェントの 3-4 倍）に見合わない。ただし同じケースでも指示の出し方で効果は大きく変わる（「効果を高めるポイント」参照）。

## サブエージェント（Task tool）が適するケース

- 独立した並列タスク（複数ファイルの検索、複数観点の独立レビュー等）
- レポートバック型の処理（各サブが調査結果を親に返すだけで完結）
- 並列レビュー → 親が統合のパターン（レビュー観点が相互に独立している場合）
- **メインコンテキストの保護**（コンテキスト分離）: 大量のファイル読み取りやWeb検索など、コンテキストを大きく消費するタスクをサブエージェントに委譲し、結果のみ受け取ることでメインのコンテキスト品質を維持する
- Anthropic 自身のリサーチシステムも orchestrator-worker 型（＝サブエージェント相当）で 90% の性能向上を達成

サブエージェントの本質的な利点は**コンテキスト分離**であり、組織的な役割のシミュレーションではない。使用判断は「タスクが独立しているか」に加えて「メインコンテキストを汚染から守る必要があるか」で行う。

## TeamCreate が必要な4類型

### 類型1: 反復フィードバックループ

A が生成 → B が検証 → B の指摘に基づき A が修正 → B が再検証（収束まで反復）。

- サブエージェントの限界: 毎回親を経由するため修正履歴のコンテキストが劣化し、ラウンドトリップが倍増

**該当する対話パターン**:
- **批評・改善（Actor-Critic）**: Generator と Critic の 1:1 反復。コード生成→レビュー→修正、文書作成→品質チェック→リライト
- **合議制投票（Round-Table）**: 全員が回答提示 → 他者の回答を見て修正 → 再投票。知識集約タスクで投票より有効（推論タスクでは投票が優位）
- **グループチャット**: 共有会話空間で LLM が次の話者を動的に選択。Critic が他エージェントの中間出力にリアルタイム介入可能

### 類型2: 発見の動的連鎖

A が調査中に発見X → B に「X が見つかった、方針転換せよ」と通知 → B が方針変更。

- サブエージェントの限界: 各エージェントが独立に最後まで走りきるため、途中の発見を他のエージェントの進行中の作業に反映できない

**該当する対話パターン**:
- **ブラックボード協調**: 共有ワークスペースに部分解を書き込み、他エージェントがそれを読んで貢献を追加。矛盾検知時に関係エージェントを招集して議論
- **階層的委任（Orchestrator-Workers の拡張）**: Lead が Worker の報告を分析し、不足を動的に判断して追加タスクを生成。単純な scatter-gather との違いは「報告内容に基づく動的な追加委任」がある点

### 類型3: コンテキスト保持型ハンドオフ

A が対応中 → 状況変化を検知 → 会話コンテキストごと B に制御権を移譲。

- サブエージェントの限界: 親が常に制御を保持するためエージェント自身の判断による自律的な移譲ができない。親経由でコンテキストが圧縮される

**該当する対話パターン**:
- **動的ハンドオフ（Swarm）**: エージェントが文脈を読んで自律的に制御権を移譲
- **ロールプレイ協調**: CEO→Architect→Developer→Tester の役割チェーンで成果物を引き継ぎつつ、テスト失敗時に Developer に差し戻す逆方向フローも含む

### 類型4: 交渉・合意形成

A（目的X）と B（目的Y）が提案 → 反提案 → 論拠交換を繰り返し、合意点を見つける。

- サブエージェントの限界: 各エージェントが自分の最適解を独立に出すだけで、トレードオフの動的解決ができない

**該当する対話パターン**:
- **討論（Multi-Agent Debate）**: 複数エージェントが主張→反論を繰り返し、Judge または合議で結論。弱いモデル・困難な問題・異種モデル構成で効果が高い
- **交渉（Argumentation-Based Negotiation）**: 異なる目的関数を持つエージェントが論拠を交換しながら妥協点を探索。提案内容が相手の前回提案に条件付けられる
- **契約ネット（Contract Net）**: Manager がタスクを公告し、エージェントが能力・コスト・負荷を考慮して入札。状態が動的に変化する環境で有効

## 対話パターンの構造的次元

4類型に該当するか判断する際、以下の構造的次元でタスクを分析すると、どの類型に近いか特定しやすい。

| 次元 | サブエージェントで十分 | TeamCreate が必要 |
|------|---------------------|------------------|
| **トポロジー** | Star（親→子の一方向） | 全結合（全員が相互通信）、P2P、Chain+Loop |
| **制御構造** | 集中（親が常に制御） | 分散またはハイブリッド |
| **同期性** | 非同期（fire-and-forget） | 同期的ラウンド制または動的切替 |
| **反復性** | 1回（生成して返すだけ） | 反復的（収束まで繰り返す） |
| **関係性** | 協調のみ | 協調+対立、競争、混合 |

サブエージェントで代替不可能な本質的条件は「**エージェントの出力が他のエージェントの入力に条件付けられ、かつその条件付けが事前に静的に決定できない**」こと。

## コスト比較

| 構成 | トークン消費 |
|------|------------|
| 単一セッション | 1x（基準） |
| サブエージェント（Task tool） | 1x + 各サブの 20K+ オーバーヘッド。小タスクではメインスレッドの方が 10x 安い |
| TeamCreate | サブエージェントの 3-4 倍。各チームメイトがフル Claude セッション |
| TeamCreate + plan モード | 単一セッションの約 7 倍 |

## TeamCreate の効果を高めるポイント

- **エージェントの多様性を明示する**: 同じペルソナだと追従的に同調し効果が消失する
- **対話ラウンドは 3-4 回が最適**: それ以上は追従性（Sycophancy）+ コスト増で逆効果
- **「いつ誰に何を伝えるか」を明示する**: 曖昧だと重複作業やギャップが発生する
- **構造化フィードバックを使う**: 自然言語チャットより構造化成果物（型定義、テスト結果等）経由の方が効率的

## マルチエージェント対話の実証的エビデンス（注意点）

- **Majority Voting で大半を説明可能**: 独立実行 + 多数決だけでマルチエージェント討論の性能向上の大部分を説明できる
- **能力飽和**: 単一エージェントの成功率が 45% 超でエージェント追加は漸減的リターン
- **逐次推論タスクには不向き**: 全マルチエージェント構成が 39-70% 性能低下
- **エラー増幅**: 独立エージェントはエラーを 17.2 倍に増幅するが、集中型協調では 4.4 倍に抑制
- **追従性問題**: LLM は他エージェントに同調しやすく、3 対 1 の多数派-少数派分裂時に少数派が正しくても多数派に同調する傾向がある

## エージェントの典型的失敗モード

Anthropic がマルチエージェントリサーチシステムの開発で、本番同一のプロンプト・ツールによるステップバイステップ・シミュレーションにより特定した失敗モード。エージェント設計時のチェック項目として使用する。

1. **過剰継続**: 十分な結果が得られているのに検索・分析を続ける。「もう少し調べれば良い結果が見つかるかもしれない」という傾向に対し、停止条件を明示的に定義する
2. **冗長クエリ**: 検索クエリが不必要に長く詳細になる。短く焦点を絞ったクエリの方が検索精度が高い
3. **ツール選択ミス**: 利用可能なツールの中から不適切なものを選ぶ。ツールの説明文が曖昧だとこの問題が悪化する
4. **停止失敗**: タスク完了後も次のアクションを探し続ける。明示的な完了条件がないと発生しやすい

**設計上の対策**: エージェントのプロンプトに「十分な結果の定義」「完了条件」を明示する。ツール定義の説明文を具体的にし、用途の重複を減らす。
