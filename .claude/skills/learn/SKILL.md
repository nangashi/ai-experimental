---
allowed-tools: Glob, Grep, Read, Write, Edit, AskUserQuestion
description: 対話から得られた知見を構造化してknowledgeファイルに保存するスキル
---

対話の中で得られた知見をユーザーと確認しながら `.claude/knowledge/` に保存し、CLAUDE.md の知識一覧を更新します。

## 使い方

```
/learn
```

引数なし。現在の対話コンテキストから知見を抽出します。

## 出力先

- 知見ファイル: `.claude/knowledge/{slug}.md`
- 知識一覧: `CLAUDE.md` の `## Knowledge` セクション

## 記述原則

knowledgeファイルはAIがコンテキストとして読み込む前提で記述する。目標は「AIが会話コンテキストなしで読んで、正確かつ安定した判断に使える文書」。

### 知見の記述パターン

各知見は以下の統一パターンで記述する:

```
- **太字の主張**: 説明・根拠
```

例:
```
- **ヒントは2件が最適閾値**: 3件以上で満足化バイアスが起動。方向性だけ示す軽量ヒントが有効（2件 +2.25pt、4件 -2.75pt。5ラウンドで再現確認）
```

主張と説明・根拠を1つの箇条書きに含める。テーブルと散文の混在は避け、このパターンに統一することでAIが「これは判断基準か、背景情報か」を区別しやすくする。

### 用語と参照

- **未定義語の禁止**: 一般知識で意味を判断できない語（対話中の造語、プロジェクト固有の略語、実験ID等）は初出時に括弧書きで定義する。定義できない内部コード（実験ID等）は除去する
- **セクション間参照**: セクションが他セクションと関連する場合は `（詳細→セクションN）` で明示する。AIが文書を部分的に参照した際の見落としを防ぐ
- **セクションのスコープ**: セクションが複数ある場合、各セクション冒頭で他セクションとの違い・関係を1文で記述する

### 残すべき情報

- **判断基準**: 閾値、条件分岐、「○○の場合は△△」は省略しない
- **理由**: 理由がないと例外ケースで誤適用される
- **代表例**: 抽象的な指針には最低1つの具体例を添える

### 削ってよい情報

- 経緯の詳細、試行錯誤の過程
- 感想、冗長な修飾
- **AIが既に知っている情報**: 公式ドキュメントの基本事項、LLMの訓練データに広く含まれる公知の手法・原則。判断基準: 「この情報がなくてもAIは同じ行動を取るか？」— YESなら不要
- **出典・ソース情報**: 出典ラベル（「○○研究より」等）は不要。定量データや根拠自体は残すが、どこから得たかは記載しない。knowledgeはユーザー確認済みであり出典で信頼性を補強する必要がない
- **外部ファイルへの参照**: `docs/xxx.md` 等へのリンクはリンク切れリスクがあるため含めない。参照先の情報が重要ならknowledge内に取り込む

## ワークフロー

Phase 1（トピック提案・確定）→ Phase 2（知見集約・ファイル出力 + 訂正ループ）→ Phase 3（CLAUDE.md 更新）

---

### Phase 1: トピック提案・確定

対話から個別の知見ではなく、**トピック（= 1ファイルの単位）** を先に決める。
トピックは分類（カテゴリ）ではなく、**利用シーン**（「いつ・どんな作業でこの知識を参照するか」）を基準に切る。

**トピック名 = CLAUDE.md の use-when フィールド**: ここで決めるトピック名が、Phase 3 で CLAUDE.md に記載する「いつ使うか」にそのまま使われる。AIがタスク実行中にCLAUDE.mdの use-when を見て該当ファイルを Read する判断材料になるため、利用シーンが具体的に伝わる名前にする。

#### Step 1: 既存knowledgeの把握

1. `.claude/knowledge/` 配下の既存ファイル一覧を Glob で取得する
2. 既存ファイルがある場合、各ファイルを Read し、タイトルと要点を把握する
3. 既存ファイルの一覧を `{existing_knowledge}` として保持する（トピック提案時の判断材料にする）

#### Step 2: トピック候補の抽出

1. 現在の対話コンテキストを分析し、知見を抽出する
2. 抽出基準 — 以下を**すべて**満たす知見のみ対象:
   - **再利用価値がある**: 将来の別セッションで役立つ
   - **非自明**: 以下に該当する情報は除外
     - 公式ドキュメントで確認できる基本事項
     - LLMの訓練データに広く含まれる公知のベストプラクティス（例: 「禁止より代替行動指示が有効」「理由を付記すると汎化する」等の標準的プロンプト工学原則）
     - AI が既に内在化している知識の再提示
   - **行動変容がある**: この知見がknowledgeに存在することで、AIの具体的な行動（判断、出力、自己チェック等）が変わるか。以下は除外:
     - 統計・背景情報（例: 「AI生成PRの67.3%が却下される」— 知っていても新しい行動指針がない）
     - AIが自ら測定・制御できないメトリクス（例: コードチャーン — 知っていても行動に反映できない）
     - 行動指針なしの定量データ（数値自体は印象的でも、具体的な判断基準や自己チェックに変換できないもの）
   - **確度が高い**: 対話中に実験・動作確認・定量データで裏付けられた知見のみ対象。推論や類推だけの知見はknowledgeにしない（ノイズになる）
3. 抽出した知見を**利用シーン**でグルーピングし、トピック候補を決定する:
   - トピック名は「○○するとき」「○○の設計時」など、参照タイミングが想像できる名前にする
   - 例: 「エージェント協調タスクを設計するとき」「CI/CDパイプラインのデバッグ時」
   - 分類名（「アンチパターン集」「設定値一覧」等）は避ける
   - **トピック分割の原則**: 作業Aの中で知識Xが条件付きでしか使われない場合、AとXは別トピックにする。判断基準は「この知識がなくてもその作業を完了できるケースがあるか？」。YESなら別トピック（独立した use-when を持つべき）、NOなら同一トピック可。例: 「スキルを作る」とき、エージェント協調の判断基準は協調設計が必要な場合のみ参照する → 別トピック
4. `{existing_knowledge}` と照合し、重複・追加を判定する:
   - 既存ファイルに実質的に同じ知見が既に含まれている → 除外（重複）
   - 既存ファイルの利用シーンと一致するが、知見の内容が新規 → 「既存ファイルに追加」候補とする
5. トピック候補をテキスト出力する:
   ```
   ## 既存knowledge
   {既存ファイルがあれば一覧表示、なければ「なし」}

   ## トピック候補

   1. **{トピック名}** → 新規作成
      含まれる知見: {知見A}、{知見B}、{知見C}

   2. **{既存ファイルのトピック名}** → 既存ファイルに追加 ({slug}.md)
      追加する知見: {知見D}、{知見E}
   ```

   知見が見つからない場合: 「この対話から保存すべき知見は見つかりませんでした。」と出力してスキル終了。

#### Step 3: トピックの確定

1. `AskUserQuestion` でトピックを確認する:
   - トピックが1件の場合: 「このトピックで保存しますか？」（選択肢: このまま保存 / キャンセル）
   - トピックが複数の場合: 「どのトピックを保存しますか？」（multiSelect: true、各トピック名を選択肢に。選択肢の末尾に「すべて保存」を追加）
   - ユーザーが Other でトピック名の変更・統合・分割・既存ファイルへの振り替えを指示した場合はそれに従って調整し、再度確認する

2. 保存対象が0件の場合: 「保存をキャンセルしました。」と出力してスキル終了。

---

### Phase 2: 知見集約・ファイル出力 + 訂正ループ

確定した各トピックについて以下を実行する。

#### Step 1: ファイル出力

Phase 1 で「既存ファイルに追加」と確定したトピックは Step 1a、「新規作成」は Step 1b へ。

#### Step 1a: 既存ファイルの更新

既存ファイルを直接編集せず、新ファイルとして再生成してから上書きする。

1. 対象の既存ファイル（`{slug}.md`）を Read する
2. 既存ファイルの内容 + 今回追加する知見 + 現在のテンプレート形式・記述原則に基づき、`{slug}_new.md` を Write で新規作成する
   - 既存内容の追記ではなく、全体を現在のテンプレートで再構成する
3. **批判的レビュー**: `Task` ツールで以下を実行する（`subagent_type: "general-purpose"`, `model: "sonnet"`）:

   > 以下の2つのknowledgeファイルを比較レビューしてください。
   >
   > - 旧バージョン: `{.claude/knowledge/{slug}.md の絶対パス}`
   > - 新バージョン: `{.claude/knowledge/{slug}_new.md の絶対パス}`
   >
   > 両ファイルを Read で読み込み、以下の観点で新バージョンを評価してください:
   >
   > **評価観点**: AIがこのファイルを会話コンテキストなしで読んだとき、誤解なく正確に情報を受け取れるか
   >
   > 具体的なチェック項目:
   > 1. **情報欠落**: 旧バージョンにあった有用な情報が新バージョンで失われていないか
   > 2. **曖昧さの増加**: 旧バージョンでは明確だった記述が、新バージョンで曖昧になっていないか
   > 3. **未定義語**: 一般知識で意味を判断できない語（造語、プロジェクト固有の略語、独自概念）が補足なしで使われていないか
   > 4. **誤解リスク**: AIが一般知識で解釈したときに、意図と異なる意味に取りうる記述がないか
   >
   > 返答フォーマット（問題がない項目は省略可）:
   > ```
   > issues: {検出数}
   > ---
   > 1. [{観点名}] {問題の概要}
   >    旧: {旧バージョンの該当箇所の引用}
   >    新: {新バージョンの該当箇所の引用}
   >    推奨: {具体的な修正案}
   > ```
   > 問題が0件の場合: `issues: 0` のみ返答してください。

4. レビュー結果の反映:
   - `issues: 0` の場合: ステップ5へ進む
   - issues がある場合: レビュー指摘を `{slug}_new.md` に Edit で反映し、ステップ5へ進む
5. 新旧ファイルの内容をテキスト出力する（レビュー反映後の `{slug}_new.md` を使用）:
   ```
   ### 既存: {slug}.md
   {既存ファイルの内容}

   ### 更新案: {slug}_new.md
   {新ファイルの内容}

   ### レビュー結果
   {レビュー指摘のサマリ。0件の場合は「問題なし」}
   ```
6. `AskUserQuestion` で確認: 「更新案で置き換えますか？」
   - 選択肢: 置き換える / 修正指示がある / キャンセル（既存のまま）
7. 「修正指示がある」または Other で修正内容が入力された場合:
   - 修正を反映して `{slug}_new.md` を Edit で更新し、ステップ5に戻る
8. 「置き換える」の場合:
   - `{slug}_new.md` の内容を Read し、`{slug}.md` に Write で上書きする
   - `{slug}_new.md` を Bash で削除する: `rm .claude/knowledge/{slug}_new.md`
   - 次のトピックへ進む（全トピック完了なら Phase 3 へ）
9. 「キャンセル」の場合:
   - `{slug}_new.md` を Bash で削除する: `rm .claude/knowledge/{slug}_new.md`
   - このトピックをスキップし、次のトピックへ進む

#### Step 1b: 新規ファイル作成

1. ファイル名を `{slug}.md` として決定する（slug: トピックを表す英語のケバブケース、短く）
2. トピックに属する全知見を1ファイルにまとめて、以下の形式で Write する:

```markdown
# {トピック名}

{トピックの概要。1-2文で利用シーンと結論を述べる}

## {サブトピック名}

{サブトピック内の他セクションとの関係を1文で記述（セクションが複数ある場合）}

### 知見

- **{太字の主張}**: {説明・根拠}
- **{太字の主張}**: {説明・根拠}

### 判断基準

- {条件} → {行動}（例: {具体例}）

```

テンプレート補足:
- 知見が少量（3件以下）の場合: サブトピック分割は不要。`## 知見` と `## 判断基準` をトップレベルで直接配置する
- 知見が多い場合: 関連する知見をサブトピックでグルーピングし、各サブトピック内に「知見」「判断基準」を持たせる
- 「判断基準」: 条件分岐がある知見の場合に記載。条件分岐がない知見では省略可
- 確度が低い知見（推論や類推だけのもの）は含めない（抽出基準で除外済みのはず）
- 初出の専門用語・略語・プロジェクト固有語は括弧書きで定義する（記述原則「用語と参照」参照）

3. Step 2 へ

#### Step 2: ユーザー確認（訂正ループ）

1. 保存/更新したファイルの内容をテキスト出力する
2. `AskUserQuestion` で確認: 「この内容で問題ありませんか？」
   - 選択肢: 問題なし / 訂正がある
3. 「訂正がある」または Other で訂正内容が入力された場合:
   - 訂正を反映して Edit でファイルを更新し、Step 2 に戻る
4. 「問題なし」の場合: 次のトピックへ進む（全トピックの処理が完了したら Phase 3 へ）

---

### Phase 3: CLAUDE.md 更新

#### Step 1: 知識一覧セクションの確認

1. `CLAUDE.md` を Read する
2. `## Knowledge` セクションが存在するか確認する

#### Step 2: 一覧の更新

`.claude/knowledge/` 配下の全ファイルを Glob で取得し、各ファイルの use-when（Phase 1 で確定したトピック名）を生成する。

`## Knowledge` セクションが存在しない場合は新規追加、存在する場合はセクション内容を置換する。

**コンテキスト消費削減のため英語で記載する。**

フォーマット:
```markdown
## Knowledge

| file | use-when |
|------|----------|
| `.claude/knowledge/{slug}.md` | {when to reference this file, in English} |
```

- `use-when`: Phase 1 で確定したトピック名を英語に翻訳したもの。AIがタスク実行中に現在の作業とマッチングするためのトリガー

Edit で CLAUDE.md を更新する。

#### Step 3: 完了出力

```
## /learn 完了

- 保存: {N}件（新規: {n1}件, 統合: {n2}件）
- ファイル: {保存したファイルパスのリスト}
- CLAUDE.md: Knowledge セクションを更新しました
```
