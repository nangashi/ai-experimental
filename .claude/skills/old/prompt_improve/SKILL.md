---
allowed-tools: Glob, Grep, Read, Write, Edit, Task, AskUserQuestion
description: Improve agent definition files based on experimental findings about prompt structure effectiveness
---

実験的に検証された構造改善戦略を適用して、エージェント定義ファイルの性能を向上させます。

## 使い方

```
/prompt_improve <エージェント定義ファイルパス>
```

引数がない場合は、対象ファイルのパスを `AskUserQuestion` で質問してください。

## 実験的根拠

このスキルの改善戦略は、`plan-architect.md` に対する構造バリエーション比較実験（10バリエーション × 2回実行）の結果に基づいています。実験で効果と安定性が確認された上位の構造変化を、改善戦略として定式化しています。

## ワークフロー

以下の5フェーズを順に実行してください。

---

### Phase 1: 構造分析 + ギャップ分析

**目的**: 対象プロンプトの現状を分析し、改善可能な構造次元を特定する。

1. 対象ファイルを `Read` で読み込む
2. `.claude/skills/prompt_improve/improvement-strategies.md` を `Read` で読み込む
3. 以下の **6つの構造次元** について現状を分析する:

| 構造次元 | 分析観点 | 最適状態（実験結果より） |
|---------|---------|----------------------|
| 見出し数 | `##`レベルのセクション数 | ドメインに対応した適切な数 |
| サブ項目粒度 | 箇条書きの行数・詳細度 | 骨格のみ（見出し + 1行説明） |
| 出力形式詳細度 | テンプレートの構造化レベル | セクション名のみ、サブ項目テンプレートなし |
| 原則/制約の明示度 | ルール・原則の数と具体性 | 簡潔5項目以内 |
| 具体例の有無 | Few-shot例があるか | 2-3個の具体例あり |
| スコアリング基準の有無 | 定量評価基準があるか | カテゴリ別5段階評価あり |

4. 各次元について **ギャップ**（現状と最適状態の差）を判定し、改善要否を決定する
5. ギャップ分析テーブルをユーザーに提示する

**出力**: ギャップ分析テーブル（次元 / 現状の水準 / 最適状態 / 改善要否）

---

### Phase 2: 改善戦略の選択 + ユーザー確認

**目的**: 適用する改善戦略をユーザーと合意する。

1. Phase 1 のギャップ分析結果に基づき、適用を推奨する戦略を選定する
2. 以下の5戦略を効果順に提示する（既に満たしている戦略は「適用済み」と表示）:

| 優先度 | 戦略 | 効果 | 安定性 | 概要 |
|-------|------|------|--------|------|
| 1 | S1: Few-shot例の追加 | +6.0pt | ±0.0 | タスクに応じた具体的な出力例を2-3個追加 |
| 2 | S2: スコアリング基準の追加 | +5.25pt | ±0.5 | カテゴリ別の5段階評価基準を追加 |
| 3 | S3: 出力フォーマットの簡素化 | +5.0pt | ±1.0 | 詳細なテンプレートをセクション名のみに簡素化 |
| 4 | S4: サブ項目の削減 | +4.25pt | ±0.5 | 箇条書き説明を骨格のみに削減 |
| 5 | S5: 問題検出指示の明示化 | 基盤 | — | 入力の問題検出と出力への反映を明示的に指示 |

3. `AskUserQuestion` でユーザーに確認する:
   - 推奨戦略の一覧を提示
   - ユーザーが戦略を選択・除外できるようにする（multiSelect: true）
   - 「全て適用（推奨）」をデフォルト選択肢とする

---

### Phase 3: 改善版プロンプトの生成

**目的**: 選択された改善戦略を適用して、改善版プロンプトを生成する。

`improvement-strategies.md` の各戦略の変換ルールに従い、以下の順序で改善版を生成する:

1. **YAML frontmatter を保持**: `name`, `description`, `tools`, `model` は変更しない
2. **ロール定義を保持**: 冒頭の役割説明は保持する（簡素化のみ可、削除不可）
3. **S4 適用時: サブ項目の削減**: 評価項目・原則セクション内の詳細な箇条書き説明を削減し、見出し + 核心の1行説明のみにする
4. **S5 適用時: 問題検出指示の追加**: 原則セクションに「入力の問題検出と計画/出力への反映」を追加する
5. **S1 適用時: Few-shot例の生成・追加（最重要ステップ）**:
   - エージェントのタスク種別を特定する（レビュー / 計画作成 / コード生成 / 分析）
   - `improvement-strategies.md` の「S1: Few-shot例の追加」セクションに記載されたタスク種別別ガイダンスに従う
   - 2-3個の具体的な出力例を生成する
   - 各例は異なるカテゴリ・深刻度をカバーする（重大 / 中 / 軽微）
   - 各例の構造: **シチュエーション** → **発見/判断** → **具体的な出力例** → **根拠**
   - 例は元プロンプトの出力フォーマットに準拠する
   - 例はリアルで具体的なものにする（技術名、ライブラリ名、パラメータ値を含む）
   - 出力フォーマットセクションの直後に「出力例」セクションとして挿入する
6. **S2 適用時: スコアリング基準の追加**: `improvement-strategies.md` のテンプレートに従い、エージェントの評価カテゴリに対応した5段階評価基準を追加する
7. **S3 適用時: 出力フォーマットの簡素化**: 詳細なテンプレート指定をセクション名 + 括弧書き1行説明に簡素化する
8. **注意事項を最小化**: 冗長な注意事項を3-4項目以内に削減する

**改善版の理想的なセクション順序**:

```
[YAML frontmatter]
[ロール定義（簡潔に）]
[原則/評価項目（骨格のみ）]
[スコアリング基準（S2）]
[出力フォーマット（セクション名のみ）]
[出力例 — Few-shot（S1）]
[注意事項（最小限）]
```

---

### Phase 4: Before/After 比較 + ユーザー承認

**目的**: 改善内容をユーザーに提示し、承認を得る。

1. 以下の構造変化テーブルを作成して提示する:

```markdown
| 構造次元 | Before | After | 変化 |
|---------|--------|-------|------|
| 見出し数 | N個 | N個 | (変化の説明) |
| サブ項目粒度 | 詳細 | 骨格のみ | 削減 |
| 出力形式詳細度 | フルテンプレート | セクション名のみ | 簡素化 |
| 具体例 | なし | 3例 | 追加 |
| スコアリング基準 | なし | 8カテゴリ | 追加 |
| 総行数 | N行 | N行 | (増減) |
```

2. 主要な変更点を箇条書きでサマリする
3. 改善版プロンプトの全文を提示する
4. `AskUserQuestion` で承認を確認する:
   - 「このまま適用する」
   - 「修正してから適用する」（フィードバック入力可）
   - 「適用しない」

---

### Phase 5: ファイル出力

**目的**: 承認された改善版をファイルに書き込む。

1. 元ファイルを `{元のファイル名}.bak.md` としてバックアップする（`Write` ツール）
   - 例: `.claude/agents/plan-architect.md` → `.claude/agents/plan-architect.bak.md`
   - `.bak.md` が既に存在する場合は上書きする
2. 改善版を元のファイルパスに上書きする（`Write` ツール）
3. ユーザーに完了を報告する:
   - バックアップファイルのパス
   - 適用した戦略の一覧
   - 構造変化のサマリ（Before/After の行数比較）
