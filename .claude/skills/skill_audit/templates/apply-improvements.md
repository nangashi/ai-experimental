# 改善適用テンプレート

改善計画に基づいてスキルファイルを修正してください。

## パス変数
- `{skill_path}`: スキルディレクトリの絶対パス
- `{skill_name}`: スキル名
- `{plan_path}`: 改善計画ファイルのパス
- `{agent_path}`: エージェント定義ファイルの絶対パス（変更対象）
- `{agent_content}`: エージェント定義ファイルの内容（Phase 0 Step 2 で Read して保持されたもの）
- `{approved_findings_path}`: 承認済みfindings（`.agent_audit/{agent_name}/audit-approved.md`）の絶対パス

## 手順

1. Read で `{plan_path}` を読み込み、改善計画の全内容を確認する
2. 改善計画の「変更ステップ」セクションの各 Step を順に処理する
3. 各 Step について以下を実行する:

### a. 対象ファイルの読み込み
- Step の「対象ファイル」一覧を確認する
- 各対象ファイルを Read で読み込む。Read 失敗時は skipped リストに追加し次の Step へ進む

### b. 変更の適用
- Step の「変更内容」に記載された変更を各対象ファイルに対して Edit で適用する
- 変更が広範囲に及ぶ場合（変更対象行数 ÷ ファイル総行数 > 0.5）は Write で全体を書き換える
- 新規ファイル作成が必要な場合は Write で作成する

### c. 変更確認
- Step の**全対象ファイル**について、変更が反映されたか確認する
- 各対象ファイルを再度 Read し、変更後の記述の特徴的な文字列が存在するか確認する
- 変更が反映されていないファイルがある場合、そのファイルに対して変更を再試行する（1回のみ）
- 再試行後も未反映の場合は skipped リストに追加し理由を記録する

### d. 次の Step へ進む

4. 「削除推奨ファイル」セクションがある場合:
   - ファイルの削除は**実行しない**
   - 削除推奨ファイルのリストを返答に含める（ユーザーが手動で削除する）

## 変更適用ルール
1. **順序**: Step 番号順に処理する。各 Step 内では削除 → 修正 → 追加の順
2. **二重適用防止**: Edit前に現在内容を確認し、一致しない場合はスキップ
3. **ツール優先度**: Edit優先（部分変更）、Write は全体書き換え時のみ
4. **Read必須**: 変更前に必ず Read を実行
5. **スコープ厳守**: 承認済みfindings以外の変更禁止、ファイル削除禁止
6. **ユーザー修正優先**: 「修正内容」記載時は推奨を無視し修正内容のみ適用

## 返答フォーマット

以下のフォーマットで**結果のみ**返答する:
```
modified: {N}件
  - {ファイルパス1}: {変更概要}
  - {ファイルパス2}: {変更概要}
created: {M}件
  - {ファイルパス1}: {目的}
skipped: {K}件
  - {ファイルパス1}: {スキップ理由}
delete_recommended: {L}件
  - {ファイルパス1}: {削除理由}
```

**上限**: 30行。30行を超える場合は重要度順（critical findings → improvement findings）に上位30行まで記載し、残りは `...（他 N 件）` と省略する。
