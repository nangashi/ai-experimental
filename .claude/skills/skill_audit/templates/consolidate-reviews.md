# レビュー結果統合テンプレート

複数レビューアーの結果を統合し、重複マージ・コンフリクト検出・ソート・ID採番を行い、findings.md を生成してください。

## パス変数
- `{work_dir}`: 作業ディレクトリの絶対パス
- `{skill_name}`: スキル名
- `{findings_save_path}`: 統合結果の保存先パス（`{work_dir}/findings.md`）
- `{conflicts_save_path}`: コンフリクト情報の保存先パス（`{work_dir}/conflicts.md`）

## 手順

1. Glob で `{work_dir}/review-*.md` を列挙し、全ファイルを Read で読み込む
2. 以下の処理を順に実施する

### A. 分類

各レビュー結果の指摘を以下に分類する:
1. **重大な問題**: スキルの機能・正確性に影響する問題
2. **改善提案**: 品質向上に有効な変更
3. **良い点**: 現状維持でよい点

### B. 重複マージ

重複判定の対象は「重大な問題」と「改善提案」のみ。「良い点」はマージしない。

1. 同一ファイル + 同一セクション/行番号 + 類似内容（同じ問題を別観点から指摘）の指摘を検出する
2. 重複と判定した指摘群を1件にマージし、指摘元レビューアー名を全て記録する（例: [stability, architecture]）
3. マージ後の重大度は最も高いものを採用する（重大 > 改善）
4. マージ後の impact/effort は最も高い impact を採用する

### C. コンフリクト検出

1. 各レビュー結果の「重大な問題」「改善提案」を対象ファイル:セクション でグループ化する
2. 同一箇所（ファイル+セクション/行番号が一致）に対する指摘を抽出する
3. 以下の相反パターンを検出する:
   - 削除 vs 追加
   - 簡略化 vs 詳細化
   - インライン化 vs テンプレート化
   - 確認削減 vs 確認追加
4. 1-3の手順でコンフリクトが1件も検出されなかった場合、コンフリクトなしと判定する

### D. ソート

重大な問題・改善提案それぞれを以下の優先順で並べ替える:
1. impact: high → medium → low
2. 同一 impact 内では effort: low → medium → high（費用対効果が高い順）

### D2. 上限フィルタ

指摘の合計（重大な問題 + 改善提案）が 9件を超える場合、以下のルールで絞り込む:
1. **重大な問題は全件残す**
2. **改善提案は上位 max(0, 9 - 重大な問題の件数) 件に絞る**（ソート済みの上位から採用）
3. 除外された改善提案の件数を `{truncated_count}` として記録する

### E. ID 採番

ソート後の順序で ID を採番する:
- 重大な問題: `C-{連番}`（C-1, C-2, ...）
- 改善提案: `I-{連番}`（I-1, I-2, ...）

## 出力

### findings.md

Write で `{findings_save_path}` に保存する:

```
## 重大な問題

### C-1: {タイトル} [{レビューアー名}]
- 対象: {対象ファイル:セクション}
- 内容: {問題内容}
- 推奨: {改善案}
- impact: {high/medium/low}, effort: {high/medium/low}

### C-2: ...

## 改善提案

### I-1: {タイトル} [{レビューアー名}]
- 対象: {対象ファイル:セクション}
- 内容: {問題内容}
- 推奨: {改善案}
- impact: {high/medium/low}, effort: {high/medium/low}

### I-2: ...

（{truncated_count} > 0 の場合のみ以下を末尾に追加）
---
注: 改善提案を {truncated_count} 件省略しました（合計 {元の改善提案数} 件中上位 {採用数} 件を表示）。省略された項目は次回実行で検出されます。
```

### conflicts.md（コンフリクトがある場合のみ）

Write で `{conflicts_save_path}` に保存する:

```
## コンフリクト

### CONF-1: {対象ファイル:セクション}
- 側A: [{レビューアー名}] {提案内容}
- 側B: [{レビューアー名}] {提案内容}
- 対象findings: {関連する findings の ID（例: C-1, I-3）}
```

コンフリクトがない場合は `{conflicts_save_path}` を作成しない。

### 返答フォーマット

以下のサマリのみ返答する:
```
critical: {重大な問題の件数}
improvement: {改善提案の件数}
positive: {良い点の件数}
conflicts: {コンフリクト件数}
merged: {重複マージで統合した件数}
truncated: {省略した改善提案の件数（0の場合も出力）}
```
