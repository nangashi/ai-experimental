以下の手順で、入力ファイルから行動指示（instruction）を抽出し .med.md ファイルを生成してください。

## 入力

- `{source_path}`: 調査メモ・実験結果のマークダウンファイル
- `{med_path}`: 出力先の med ファイルパス
- `{med_version}`: 現在の抽出条件バージョン
- `{use_when_map}`: CLAUDE.md Instructions and Knowledge テーブルの use-when テキスト ↔ ファイルパスの対応表

## 抽出フィルタ

以下を**すべて**満たす指示のみ抽出する:

1. **再利用価値**: 将来の別セッションで役立つ
2. **遵守改善効果**: 明示的に指示することでAIの遵守率が有意に改善するか。判断軸は「AIがこの知識を持っているか」ではなく「明示的指示なしで一貫して正しい適用境界を守れるか」。
   **重要: ソース文書にAIの誤適用・逆解釈パターンが記録されている場合（テーブル、専用セクション等）、その項目は無条件で「高」と判定する。**「AIは理論上正しく適用できるはず」という推論より、ソース文書の実証記録を常に優先する。
   改善効果が高い（含める）:
   - ソース文書でAIの誤適用・逆解釈パターンが記録されている（過剰適用、過少適用、逆解釈のいずれも該当）
   - AIのデフォルト判断と逆方向の指示（例: 一般に「良い設計」とされるパターンに適用条件で制限をかける）
   - 適用境界が複雑で、条件を無視した過剰適用・過少適用が起きやすい
   改善効果が低い（除外）:
   - ソース文書にAIの誤適用パターンが記録されて**おらず**、かつAIが指示なしでも一貫して正しく適用できる（デフォルト判断と同方向、かつ適用条件が単純）
   - AIのAPI仕様やモデル特性の説明（AIは自身の機能・制約について既に知っている）
   - 定量データが付いていても、その数値がなくてもAIが同じ判断をする場合
3. **行動変容**: この指示が存在することで、AI の具体的な行動が変わる。以下は除外:
   - 行動指針なしの統計・背景情報（「AI生成PRの67.3%が却下される」等）
   - AI が自ら測定・制御できないメトリクス
   - 数値自体は印象的でも、判断基準や自己チェックに変換できないもの
   - 参照知識（レビュー観点リスト、分類体系、フレームワーク等）はこのスキルの抽出対象外
   - actionが「認識する」「考慮する」「意識する」「判断基準とする」で終わる指示は、具体的な行動（何をする/何をしない）に変換できない限り除外
   - 開発方法論やプロセス説明（「観察する」「評価する」等）は、AIが実行時に取る具体的アクションに変換できない限り除外
4. **確度**: 実験・動作確認・定量データで裏付けられた指示のみ。推論や類推だけの指示は除外
5. **削除テスト**: 「この指示をコンテキストから削除した場合、AIの遵守率が低下するか？」にYESと言えない場合は除外する。AIが原則自体を知っていても、適用境界を一貫して守れない場合はYESと判定する。ソース文書にAIの誤適用・逆解釈パターンが記録されている項目は、経験的に遵守率低下が確認されているためYESと判定する。反直感的な知見（AIのデフォルト判断と逆方向の指示）や、具体的な閾値・条件分岐を提供する指示はYESになりやすい

## 各項目のフィールド生成

抽出した各指示について、以下のフィールドを生成する:

### use-when
`{use_when_map}` の use-when テキストの中から最も適切なものを選び、**そのテキストをそのまま転記**する。

該当する use-when が見つからない場合は、use-when フィールドを空欄にし、代わりに `proposed-use-when` フィールドに提案する利用シーンを記載する。

proposed-use-when はトリガー条件（いつ必要か）であり、トピックラベル（何についてか）ではない。AI がタスク実行中に「今この状況だからこの指示を参照しよう」と判断できる、具体的な活動・判断場面を記述する。

- Bad: 「出力フォーマット設計」（トピックラベル）
- Bad: 「推論時コンピュート拡張の設定」（ソース文書の見出しの転記）
- Good: 「LLMタスクの出力形式を決定するとき」（判断場面）
- Good: 「推論強化手法を選択するとき」（判断場面）

use-when の選択後、以下の適合性を確認する:
- この指示が必要になる**具体的な作業場面**と、選択した use-when の**トリガー条件**が一致しているか
- 同じ use-when に割り当てられた他の指示と、**同時に参照される場面**があるか（同時に参照されないなら、use-when の粒度が粗すぎる可能性がある → proposed-use-when で新しいカテゴリを提案する）

### scope
この指示が適用される具体的な状況・ドメインを記載する。「いつこれが当てはまるか」に答える。

### action
AI が取るべき具体的な行動を命令形で1-2文で記載する。「何をすべきか」に答える。

### rationale
核心の主張と根拠を記載する。定量データがあれば含む。「なぜそうすべきか」に答える。

### conditions（省略可）
この指示の効果が逆転・無効化する条件を記載する。条件がなければフィールド自体を省略する。

## 出力フォーマット

Write で `{med_path}` に以下の形式で出力する。**全候補**を列挙し、フィルタ評価結果と判定（PASS/FILTERED）を記録する。

手順:
1. 入力ファイルから行動指示の候補を**全て**列挙する（フィルタ適用前）
2. 各候補にフィルタ基準を適用し、評価結果を記録する
3. PASS 項目には「抽出内容」セクションを付与する。FILTERED 項目はフィルタ評価のみ
4. 全候補を通し番号 KE-001〜KE-{N} で管理する

```markdown
---
source: {source_path}
extracted: {today's date in YYYY-MM-DD}
med_version: {med_version}
passed: {M}
total: {N}
---

# Instruction Extract: {source filename without .md}

## KE-001: {短いタイトル} → PASS

### フィルタ評価
- 再利用価値: ○ — {1文の理由}
- 遵守改善効果: {高/低} — {1文の理由}
- 行動変容: ○ — {1文の理由}
- 確度: ○ — {1文の理由}
- 削除テスト: YES — {1文の理由}

### 抽出内容
- **use-when**: {use-when テキスト}
- **scope**: {適用される状況}
- **action**: {AIが取るべき行動}
- **rationale**: {根拠}
- **conditions**: {逆転条件。なければこの行を省略}

---

## KE-002: {短いタイトル} → FILTERED

### フィルタ評価
- 再利用価値: ○ — {1文の理由}
- 遵守改善効果: {高/低} — {1文の理由}
- 行動変容: {○/×} — {1文の理由}
- 確度: {○/×} — {1文の理由}
- 削除テスト: {YES/NO} — {1文の理由}
- **除外理由**: {主な除外フィルタと要約}
```

proposed-use-when がある PASS 項目のフォーマット:

```markdown
## KE-003: {短いタイトル} → PASS

### フィルタ評価
（同上）

### 抽出内容
- **use-when**:
- **proposed-use-when**: {提案する利用シーン}
- **scope**: ...
```

## 注意事項

- 1項目 = 1指示。複数の指示を1項目に混ぜない
- 入力ファイルの同じセクションから複数の独立した指示が得られる場合は別項目にする
- 指示のタイトルは内容を端的に表す日本語にする
- フィールドの値は日本語で記載する
