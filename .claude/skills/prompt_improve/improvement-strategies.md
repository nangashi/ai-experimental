# 改善戦略定義

このファイルは、エージェント定義プロンプトに適用する構造改善戦略を定義する。
各戦略は実験的に効果と安定性が検証されている。

## 実験的根拠

`plan-architect.md` に対する構造バリエーション比較実験の結果（Sonnet 4.5、10バリエーション × 2回実行）:

| 順位 | バリエーション | 平均スコア(/10) | 安定性(±pt) |
|-----|--------------|----------------|------------|
| 1 | I: Few-shot例付き | 10.0 | ±0.0 |
| 2 | B: ミニマル | 9.75 | ±0.5 |
| 3 | J: スコアリング基準 | 9.25 | ±0.5 |
| 4 | G: 出力形式自由 | 9.0 | ±1.0 |
| 5 | E: 骨格のみ | 8.25 | ±0.5 |
| — | A: ベースライン（元プロンプト） | 4.0 | ±1.0 |

**主要な知見**:
- Few-shot例は最大効果（+6.0pt）かつ完全安定（±0.0）の唯一の手法
- プロンプトの総量と検出能力は逆相関（最小プロンプトが2位）
- 出力フォーマットの過剰な構造指定は分析能力を阻害する
- 詳細チェックリスト(F)とCoT(H)は効果があるが不安定（±1.5）
- 定性的出力品質（具体性・構造性）は全バリエーションで均一に高い（4.7-5.0/5.0）

---

## 共通ルール

全ての戦略に共通する制約:

- 元プロンプトの **YAML frontmatter**（`name`, `description`, `tools`, `model`）は変更しない
- 元プロンプトの **言語**（日本語/英語）をそのまま維持する
- 元プロンプトの **ロール定義**（冒頭の役割説明）を保持する（簡素化のみ可、削除不可）
- 元プロンプトの **ドメイン固有の用語** をそのまま維持する
- 元プロンプトの **核心的な目的と専門知識** を保存する
- 改善の目的はフォーマット制約を緩和しモデルの自律的分析能力を引き出すことであり、ドメイン知識を削ることではない

---

## S1: Few-shot例の追加

### 効果データ

- **平均改善**: +6.0pt（4.0 → 10.0）
- **安定性**: ±0.0（全バリエーション中最高、2回とも10/10を達成）
- **推奨度**: ★★★ 最優先

### 適用条件

- 対象プロンプトに具体的な出力例（Few-shot例）が **存在しない** 場合に適用する
- 既に出力例がある場合は、内容を確認し不十分であれば強化する

### 変換ルール

1. エージェントのタスク種別を特定する（下記ガイダンス参照）
2. タスク種別に応じた「良い出力例」を **2-3個** 生成する
3. 各例は **異なるカテゴリ・深刻度** をカバーする（重大 / 中 / 軽微）
4. 各例は以下の構造とする:
   - **シチュエーション**: 入力の状況を1-2文で説明
   - **発見/判断**: 何を検出・判断したか
   - **出力例**: 元プロンプトの出力フォーマットに準拠した具体的な出力
   - **根拠**: なぜその判断が正しいか（1文）
5. 出力フォーマットセクションの直後に「## 出力例」セクションとして挿入する

### 品質基準

- **リアルで具体的**であること（汎用的・抽象的な例は効果が薄い）
- 元プロンプトの **出力フォーマットに完全に準拠** すること
- 具体的な **技術名、ライブラリ名、パラメータ値** を含むこと
- 例同士で内容が **重複しない** こと

### タスク種別別ガイダンス

#### レビュー系エージェント（plan-reviewer, code-reviewer 等）

パターン: **問題検出 → 影響説明 → 具体的対策**

例の構造:
```markdown
### 例N: [問題カテゴリ]の検出例（[深刻度]）

[入力の計画/コード]に「[具体的な問題状況]」が含まれていた場合:

**良い指摘の例**:
> **[問題タイトル]**: [問題の具体的な説明]
>   - **影響**: [悪用/障害シナリオ]
>   - **推奨対策**: [具体的な修正内容（技術名・バージョン含む）]
>   - **該当箇所**: [計画/コード内の該当セクション]
```

#### 計画作成系エージェント（plan-architect 等）

パターン: **入力の問題検出 → 計画への反映**

例の構造:
```markdown
### 例N: [問題カテゴリ]の検出と対策（[深刻度]）

入力要件に「[具体的な問題状況]」と記載されていた場合:

**良い計画での反映**:
```markdown
### [セクション番号] [セクション名]

#### [サブセクション名]
- [具体的な設計判断（技術名・バージョン・設定値含む）]
- [根拠: なぜその判断が正しいか]
```（閉じ）
```

#### 分析系エージェント

パターン: **データ/状況の分析 → 洞察の抽出 → 推奨アクション**

例の構造:
```markdown
### 例N: [分析カテゴリ]の分析例（[重要度]）

[入力データ/状況]に「[具体的な事象]」が見られた場合:

**良い分析の例**:
> **[洞察タイトル]**: [分析結果の具体的な説明]
>   - **根拠**: [データ/証拠に基づく理由]
>   - **推奨アクション**: [具体的な次のステップ]
```

#### その他のエージェント

上記に当てはまらない場合は、エージェントの役割定義からタスクの入出力パターンを推測し、最も近い種別のガイダンスを適用する。いずれの種別にも当てはまらない場合は「入力 → 判断/処理 → 出力」の汎用パターンで例を構成する。

---

## S2: スコアリング基準の追加

### 効果データ

- **平均改善**: +5.25pt（4.0 → 9.25）
- **安定性**: ±0.5（高安定）
- **推奨度**: ★★★

### 適用条件

- 対象プロンプトに定量的な評価基準（スコアリング、深刻度分類等）が **存在しない** 場合に適用する
- 既に深刻度分類がある場合は、5段階スコアリング表の追加で強化する

### 変換ルール

1. 元プロンプトの評価カテゴリ（セクション見出しから抽出）を特定する
2. カテゴリごとの5段階評価基準を生成する
3. 以下のテンプレートを使用し、原則セクションの直後（出力フォーマットの前）に挿入する
4. カテゴリ名は元プロンプトのドメインに合わせて調整する

### テンプレート

```markdown
## スコアリング基準

各評価観点について、以下の5段階で評価し、スコアを出力に必ず含めてください:

| スコア | 基準 |
|-------|------|
| 5 | 問題なし: ベストプラクティスに完全に準拠 |
| 4 | 軽微な改善余地: 動作に影響しないが、改善が望ましい |
| 3 | 中程度の問題: 将来的にリスクとなる可能性がある |
| 2 | 重要な問題: 本番環境で問題を引き起こす可能性が高い |
| 1 | 重大な問題: 即時の対応が必要 |

### 必須出力: スコアサマリ

全観点のスコアを以下の表形式で出力してください:

| 観点 | スコア (1-5) | 主な理由 |
|-----|-------------|---------|
| (カテゴリ1) | (スコア) | (1文で理由) |
| (カテゴリ2) | (スコア) | (1文で理由) |
| ... | ... | ... |
| **総合** | **(平均)** | |
```

**注意**: `(カテゴリN)` は元プロンプトの評価カテゴリに置き換えること。

---

## S3: 出力フォーマットの簡素化

### 効果データ

- **平均改善**: +5.0pt（4.0 → 9.0）
- **安定性**: ±1.0（中安定）
- **推奨度**: ★★

### 適用条件

- 出力フォーマットに **詳細なテンプレート**（コードブロック内のサブ項目指定、括弧書きの詳細説明が複数行にわたるもの）がある場合に適用する
- 既にセクション名のみの簡素な指定であれば適用不要

### 変換ルール

1. 出力フォーマットセクション内の **コードブロックテンプレート**（````markdown` 〜 ````）を削除する
2. 各セクションは **セクション名 + 括弧書き1行説明** のみにする
3. 「以下のセクション構成で出力してください」等の全体指示は維持する

### 変換例

**Before**（詳細テンプレート）:
```markdown
### セクション3: アーキテクチャ設計

```markdown
## 3. アーキテクチャ設計

### 3.1 全体構成
（コンポーネント間の関係、データフロー）

### 3.2 主要コンポーネント
（各コンポーネントの責務、インターフェース、依存関係）

### 3.3 データモデル
（新規/変更されるデータ構造、型定義）

### 3.4 エラーハンドリング方針
（エラーの種類、伝播方式、ユーザーへの通知方式）
```（閉じ）
```

**After**（簡素化）:
```markdown
3. **アーキテクチャ設計**: 全体構成、主要コンポーネント、データモデル、エラーハンドリング方針
```

---

## S4: サブ項目の削減

### 効果データ

- **平均改善**: +4.25pt（4.0 → 8.25）
- **安定性**: ±0.5（高安定）
- **推奨度**: ★★

### 適用条件

- 評価項目・原則セクション内に **1項目あたり2行以上の説明** が含まれる場合に適用する
- 見出し + 1行の核心説明のみであれば適用不要

### 変換ルール

1. 各評価項目・原則の **見出し名** を維持する
2. 各項目の説明を **核心の1行** のみに削減する
3. 詳細な箇条書き、確認用の問い、アンチパターン例、判断基準を削除する
4. 原則自体（項目名 + 核心説明）は必ず維持する

### 変換例

**Before**:
```markdown
### 1. 脅威モデリング（STRIDE）

- **Spoofing（なりすまし）**: 認証メカニズムの設計は適切か。なりすましの攻撃経路はないか
- **Tampering（改ざん）**: データの整合性を保護する仕組みがあるか。改ざん検知が必要な箇所は考慮されているか
- **Repudiation（否認）**: 重要な操作の監査ログは設計されているか。否認防止が必要な箇所はあるか
- **Information Disclosure（情報漏洩）**: 機密データの取り扱い方針は適切か。ログや例外に機密情報が含まれないか
- **Denial of Service（サービス拒否）**: レート制限やリソース制限は設計されているか。DoS攻撃の影響を受ける箇所はないか
- **Elevation of Privilege（権限昇格）**: 権限管理の設計は最小権限の原則に従っているか
```

**After**:
```markdown
### 1. 脅威モデリング（STRIDE）

Spoofing, Tampering, Repudiation, Information Disclosure, Denial of Service, Elevation of Privilege の各脅威について設計レベルで評価する
```

---

## S5: 問題検出指示の明示化

### 効果データ

- **間接的効果**: ベースライン(A)の低スコア（4.0）の主因が問題検出の明示的指示の欠如であったことから、全戦略の基盤となる改善
- **推奨度**: ★★

### 適用条件

- 対象プロンプトに「入力の問題を検出し、出力に反映する」旨の **明示的な指示が存在しない** 場合に適用する

### 変換ルール

1. 原則/評価の姿勢セクションに以下の趣旨を追加する（元プロンプトの文体に合わせる）:

```
入力（要件、計画、コード等）に問題がある場合は、問題点を指摘し、改善案を出力に反映すること。
検出すべき問題のカテゴリ: セキュリティ、パフォーマンス、設計原則、一貫性、エラーハンドリング、データ設計、依存関係管理
```

2. カテゴリ名は元プロンプトのドメインに合わせて調整する

---

## 推奨プロンプト構成

全戦略を適用した場合の理想的なセクション順序:

```
[YAML frontmatter — 変更なし]

[ロール定義（簡潔に）]

[原則 / 評価項目（骨格のみ — S4）]
  └ 問題検出指示を含む（S5）

[スコアリング基準（S2）]

[出力フォーマット（セクション名のみ — S3）]

[出力例 — Few-shot × 2-3個（S1）]

[注意事項（最小限、3-4項目）]
```

この順序は実験で最も効果的だったバリエーション（I: Few-shot例付き）の構造を基にしており、ロール定義 → 何を評価するか → どう評価するか → 出力形式 → 具体例 → 補足、という認知的に自然な流れになっている。
