# 要件定義書の生成

Phase 2-6 の確定結果と入力ユーザー要求書の内容を統合し、12セクション構成の要件定義書を生成する。

## 入力の読み込み

1. Read で以下のファイルを読み込む:
   - `{input_path}`: ユーザー要求書（パススルーセクションのソース）
   - `{template_path}`: 出力テンプレート
   - `{sr_draft_path}`: SR 一覧ドラフト

2. 以下の情報を確認する:
   - `{actors_and_interfaces}`: Phase 2 確定結果
   - `{nfr_quantified}`: Phase 4 確定結果
   - `{interface_requirements}`: Phase 5 確定結果
   - `{gap_resolutions}`: Phase 1 ギャップ解決結果
   - `{deferred_gaps}`: Phase 1 で保留された未解決ギャップ

## ドキュメント組み立て

テンプレートの各セクションに対応するデータを埋める。

### セクション 1-3: パススルー（問題定義・背景・アプローチ選定）

`{input_path}` から以下のセクションを読み取り、テンプレートの構造に合わせて配置する:
- セクション 1 (問題定義): 入力の「問題定義」セクション全体
- セクション 2 (背景): 入力の「背景」セクションから**制約サブセクションを除外**した内容（現状のプロセス、過去の試行、ステークホルダー）
- セクション 3 (アプローチ選定): 入力の「アプローチ選定」セクション全体

内容は変更しない。見出しレベルのみテンプレートに合わせる。

### セクション 4: 制約（抽出・独立化）

`{input_path}` の「背景 > 制約」サブセクションを独立セクションとして抽出する。
テーブル内容はそのまま配置する。見出しを H2 レベルに昇格する。

`{gap_resolutions}` に制約関連の回答（認証モデル、接続性の前提等）がある場合、テーブルに行を追加する。

### セクション 5: スコープ

`{input_path}` の「スコープ」セクションから以下のみを配置する:
- 5.1 Must
- 5.2 Nice-to-have
- 5.3 スコープ外

**含めないもの:**
- 「スコープ > MVP」: Must と実質重複のため
- 「スコープ > 非機能要求」: Phase 4 で定量化済み、Section 9 として出力されるため

### セクション 6: ユースケース（パススルー）

`{input_path}` の「ユースケース」セクション全体を配置する。内容は変更しない。

### セクション 7: システム境界（導出）

`{actors_and_interfaces}` の内容を使用する:
- 7.1 システム概要: タイトルとスコープから一文要約を生成
- 7.2 アクター一覧: アクターテーブル
- 7.3 外部インターフェース: インターフェーステーブル
- 7.4 スコープ: 内部/外部の範囲記述

### セクション 8: 機能要件（導出）

`{sr_draft_path}` の内容を使用する。
テーブルヘッダーは「要件」とする（「要求」ではない）。

### セクション 9: 非機能要件（導出）

`{nfr_quantified}` の内容を使用する。
テーブルヘッダーは「要件」とする。

### セクション 10: インターフェース要件（導出）

`{interface_requirements}` の内容を使用する。
テーブルヘッダーは「要件」とする。

### セクション 11: 成功基準・リスク（パススルー）

`{input_path}` の「成功基準」セクション全体を配置する。内容は変更しない。

### セクション 12: 未解決事項（統合）

以下の3つのソースを統合した1つのリストにする:
1. `{input_path}` の「未解決事項」セクション
2. `{deferred_gaps}` (Phase 1 で保留されたギャップ)
3. Phase 2-6 で新たに発見された未確定事項（該当がなければ省略）

### 付録 A: 用語集

ドキュメント全セクション（パススルー + 導出の両方）で使用された専門用語を抽出して定義する。

## メタデータの設定

- ステータス: `Confirmed`
- 日付: 今日の日付（YYYY-MM-DD 形式）

## 最終チェック

組み立てたドキュメントに対して以下を確認する:
- 空セクションがないこと（該当なしの場合は「なし」と明記）
- SR テーブルの並び順がトレース元の UC 順であること
- 全テーブルヘッダーが「要件」であること（「要求」が混在していないこと）
- パススルーセクションの内容が入力文書と一致していること

## 保存

`{output_save_path}` に Write で保存する。

## 返答

以下のフォーマットのみ返答する（本文は含めない）:

```
result: success
total_requirements: SR:{N}, NFR:{N}, IR:{N}
sections_completed: {完了セクション数}/{総セクション数}
```
