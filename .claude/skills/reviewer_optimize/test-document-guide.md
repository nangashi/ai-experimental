# テスト対象文書生成ガイド

このファイルは、`reviewer_optimize` スキルの Phase 2 で生成するテスト対象文書と正解キーの作成ガイドラインを定義する。

---

## 1. テスト対象文書の基本構成

### target = design（設計レビュー用）

以下のセクション構成でシステム設計書を生成する。実在のプロジェクトとして自然な内容にすること。

```
# {プロジェクト名} システム設計書

## 1. 概要
- プロジェクトの目的と背景
- 主要機能の一覧
- 対象ユーザーと利用シナリオ

## 2. 技術スタック
- 言語・フレームワーク
- データベース
- インフラ・デプロイ環境
- 主要ライブラリ

## 3. アーキテクチャ設計
- 全体構成（レイヤー構成、コンポーネント図）
- 主要コンポーネントの責務と依存関係
- データフロー

## 4. データモデル
- 主要エンティティと関連
- テーブル設計（カラム、型、制約）

## 5. API設計
- エンドポイント一覧
- リクエスト/レスポンス形式
- 認証・認可方式

## 6. 実装方針
- エラーハンドリング方針
- ロギング方針
- テスト方針
- デプロイメント方針

## 7. 非機能要件
- パフォーマンス目標
- セキュリティ要件
- 可用性・スケーラビリティ
```

**分量目安**: 150-250行。短すぎると問題の自然な埋め込みが困難になり、長すぎるとサブエージェントのトークン制限に影響する。

### target = code（実装レビュー用）

レビュー対象のソースコードを生成する。以下の方針に従う:

- **言語**: プロジェクトの主要言語に合わせる（不明な場合は Java/Spring Boot または TypeScript/Node.js）
- **構成**: 1-3ファイルのコードを含む。関連するクラスやモジュールをまとめて提示する
- **分量**: 100-200行（合計）
- **実在感**: 実際のプロダクションコードとして自然な内容にする

```
# コードレビュー対象

## ファイル1: {パス}

```{言語}
// {ソースコード}
```

## ファイル2: {パス}

```{言語}
// {ソースコード}
```
```

---

## 2. 問題埋め込みガイドライン

### 問題数と分布

| 項目 | 基準 |
|------|------|
| **総数** | 8-10個 |
| **深刻度分布** | 重大 3個 / 中 4個 / 軽微 3個 |
| **カテゴリ分布** | 指定観点の主要問題 5-6個 + 隣接領域 2-3個 + 微妙な問題 1-2個 |

### 埋め込みの原則

1. **自然さ**: 問題はわざとらしくならないよう自然に埋め込む。明らかなエラーや「TODO: セキュリティ対策を追加」のような露骨なヒントは避ける
2. **多様性**: 同じカテゴリの問題でも異なるパターンを使う
3. **深さのバリエーション**: 表面的に見つかる問題と、深い分析が必要な問題を混在させる
4. **文脈依存**: 単独では問題に見えないが、他のセクションとの関連で問題になるケースを含める
5. **隣接領域**: 指定観点のスコープ外だが検出できると有益な問題を2-3個含める

### 深刻度の定義

| 深刻度 | 定義 | 例（セキュリティ） |
|-------|------|------------------|
| **重大** | 即時対応が必要。重大なリスクがある | 認証バイパスの可能性、機密データの平文保存 |
| **中** | 本番環境で問題を引き起こす可能性が高い | CSRF対策の欠如、不十分なレート制限 |
| **軽微** | 改善が望ましいが、直接的なリスクは低い | ログレベルの不適切さ、不要な情報の公開 |

---

## 3. 観点別の問題バンク

問題バンクは観点定義ファイル（`{perspective_path}`）の「問題バンク」セクションに統合されている。Phase 2 のサブエージェント指示で `{perspective_path}` を読み込む際に、問題バンクも同時に参照される。

---

## 4. 正解キーのフォーマット

以下のフォーマットで `answer-key.md` を作成する:

```markdown
# 正解キー

## 実行条件
- **観点**: {perspective}
- **対象**: {target}
- **埋め込み問題数**: N問

## 埋め込み問題一覧

### P01: {問題タイトル}
- **カテゴリ**: {perspective.md の評価項目に対応するカテゴリ}
- **深刻度**: 重大 / 中 / 軽微
- **該当箇所**: テスト対象文書のセクション{N} または 行{N}-{M}
- **問題の説明**: {何が問題で、なぜ問題なのかの説明}
- **検出判定基準**:
  - ○（検出）: {この条件を満たす指摘があれば検出と判定}
  - △（部分検出）: {この条件の場合は部分検出}
  - ×（未検出）: {この場合は未検出}

### P02: {問題タイトル}
（同上の構造）

...

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | ... | ... | {この指摘があればボーナス} |
| B02 | ... | ... | ... |
```

### 検出判定基準の書き方

- **具体的** であること。「セキュリティの指摘がある」ではなく「JWTの保存先としてlocalStorageの危険性を指摘している」のように書く
- **○と△の境界** を明確にする。核心的なポイントを○の条件に、周辺的な指摘を△の条件にする
- **△の基準** は「関連カテゴリへの言及はあるが、{核心的なポイント}に触れていない」の形式とする

---

## 5. テスト対象文書の品質チェックリスト

生成したテスト対象文書を保存する前に、以下を確認する:

- [ ] 全体の分量が適切か（design: 150-250行, code: 100-200行）
- [ ] 埋め込み問題が8-10個あるか
- [ ] 深刻度の分布が適切か（重大3 / 中4 / 軽微3）
- [ ] 指定観点の問題が5-6個あるか
- [ ] 隣接領域の問題が2-3個あるか
- [ ] 問題の埋め込みが自然か（わざとらしくないか）
- [ ] 正解キーの検出判定基準が具体的で曖昧さがないか
- [ ] ボーナス問題リストが含まれているか

---

## 6. ラウンド間多様性の確保

### テスト対象文書のドメイン多様性

各ラウンドで異なるドメイン/業界のシステムを題材にすること。
knowledge.md の「テスト対象文書履歴」で過去に使用したテーマを確認し、重複を避ける。

ドメイン例（参考）:
- 教育（オンライン学習、学生管理）
- 医療（予約管理、電子カルテ）
- EC（マーケットプレイス、在庫管理）
- 金融（決済、口座管理）
- SaaS（プロジェクト管理、CRM）
- IoT（デバイス管理、センサーデータ）
- メディア（コンテンツ配信、SNS）

### 問題の多様性

- 同じ脆弱性カテゴリでも、ドメインに応じて異なる具体的表現を使用する
- 問題バンクの全カテゴリから均等に選出し、特定カテゴリに偏らないようにする
- 深刻度分布（重大3/中4/軽微3）とカテゴリ分布の要件は維持する
