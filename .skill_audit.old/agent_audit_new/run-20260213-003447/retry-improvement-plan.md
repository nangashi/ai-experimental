# 改善計画: agent_audit_new

## 変更対象ファイル
| # | ファイル | 変更種別 | 変更概要 | 対応フィードバック |
|---|---------|---------|---------|------------------|
| 1 | SKILL.md | 修正 | Phase 0-3 の冗長な説明・エラーハンドリング詳細・条件分岐を圧縮し、約119行削減（369行→250行目標） | efficiency: C-5 SKILL.md 行数超過 |

## 各ファイルの変更詳細

### 1. /home/toyama-ryosuke/ghq/github.com/nangashi/ai-experimental/.claude/skills/agent_audit_new/SKILL.md（修正）
**対応フィードバック**: efficiency: C-5: SKILL.md 行数超過（369行/目標250行） - Phase 0 のグループ分類確認ロジック、Phase 1 の進捗表示・エラーハンドリング詳細、Phase 3 の条件分岐を圧縮

**変更内容**:

#### 1. Phase 0 グループ分類確認ロジックの圧縮（行90-114: 25行 → 10行、削減15行）
- **現在の記述**:
  - グループ分類サブエージェント委譲（4行）
  - 返答抽出の詳細説明（1行）
  - AskUserQuestion 確認の詳細（選択肢3つ、各選択肢の動作説明）（5行）
  - 「開始する」「手動で変更」「キャンセル」の各動作を別々に記述（3行）
- **改善後の記述**:
  - サブエージェント委譲とプロンプト（2行に圧縮）
  - 返答抽出と確認ダイアログを1行に統合
  - 「開始/変更/キャンセル」の動作を1行に集約

#### 2. Phase 0 初期化ステップの圧縮（行92-97: 6行 → 3行、削減3行）
- **現在の記述**:
  - Fast mode フラグ確認の詳細説明（1行）
  - agent_path 読み込みの手順（1行）
  - 読み込み失敗時のエラーメッセージ全文記載（1行）
  - YAML frontmatter 確認の詳細手順（1行）
  - frontmatter 不在時の警告メッセージ全文（コードブロック含む、2行）
- **改善後の記述**:
  - Fast mode フラグ確認、agent_path 読み込み、YAML 確認を1ステップに統合（1行）
  - エラー/警告メッセージは「出力」とのみ記載し、全文記載を省略（1行）

#### 3. Phase 0 agent_name 導出ルールの圧縮（行117-121: 5行 → 2行、削減3行）
- **現在の記述**:
  - 導出ルールの説明（2行）
  - `.claude/` 配下の例（1行）
  - それ以外の例（1行）
- **改善後の記述**:
  - 導出ルールと例をテーブル形式で1行に統合

#### 4. Phase 0 分析次元セット決定の圧縮（行124-148: 25行 → 15行、削減10行）
- **現在の記述**:
  - 次元マッピングテーブル（各 agent_group ごとに dimensions と ID_PREFIX を列挙、17行）
  - テーブル説明（2行）
- **改善後の記述**:
  - テーブルの説明文を削減（1行）
  - 既に存在する「グループと分析次元」セクション（行62-82）への参照に置き換え、重複を除去

#### 5. Phase 1 並列分析開始時の進捗表示削減（行169-177: 9行 → 3行、削減6行）
- **現在の記述**:
  - Glob での既存ファイル検索手順（1行）
  - 既存ファイル照合の詳細条件分岐（分析対象外/分析対象の場合の動作、4行）
  - テキスト出力フォーマット（3行）
  - 各次元の開始メッセージ（1行）
- **改善後の記述**:
  - 既存ファイル処理を1行に圧縮（「バックアップ作成」とのみ記載）
  - テキスト出力フォーマットを1行に圧縮

#### 6. Phase 1 エラーハンドリング詳細の圧縮（行198-218: 21行 → 10行、削減11行）
- **現在の記述**:
  - 成功/失敗判定の詳細手順（findings ファイル存在確認、件数抽出、例外情報抽出の3段階、8行）
  - 全失敗時のエラー出力フォーマット全文（2行）
  - 部分失敗の判定基準詳細（中止条件/継続条件、6行）
  - Fast mode/通常モードの分岐説明（3行）
- **改善後の記述**:
  - 成功/失敗判定を1行に圧縮（「findings ファイル存在確認で判定」とのみ記載）
  - 全失敗/部分失敗のエラー出力を1行に統合
  - Fast mode/通常モードの分岐を1行に統合

#### 7. Phase 1 完了メッセージの圧縮（行219-237: 19行 → 8行、削減11行）
- **現在の記述**:
  - 各次元の完了メッセージフォーマット（3行）
  - Phase 1 完了サマリのテキスト出力フォーマット（7行）
  - 部分失敗時の警告メッセージ（2行）
  - findings 0件時の Phase 2 スキップ処理（2行）
- **改善後の記述**:
  - 完了メッセージとサマリを1つのコードブロックに統合（4行）
  - 部分失敗警告と Phase 2 スキップ処理を1行に圧縮

#### 8. Phase 2 Step 1 エラーハンドリングの圧縮（行257-268: 12行 → 5行、削減7行）
- **現在の記述**:
  - findings-summary.md 存在確認手順（Bash 実行、Read 実行、2行）
  - Read 失敗時の処理（エラー出力、Phase 3 直行、2行）
  - 返答抽出手順（正規表現の詳細記載、1行）
  - テキスト出力フォーマット（1行）
  - 整合性チェックの詳細手順（3行）
- **改善後の記述**:
  - 存在確認と Read を1行に統合
  - エラー処理と返答抽出を1行に統合
  - 整合性チェックを1行に圧縮

#### 9. Phase 2 Step 2 承認方針選択の圧縮（行270-288: 19行 → 8行、削減11行）
- **現在の記述**:
  - findings 一覧のテーブルフォーマット全文記載（7行）
  - AskUserQuestion の選択肢と各動作説明（4行）
  - Per-item 承認ループの詳細説明（2行）
- **改善後の記述**:
  - テーブルフォーマットを1行に圧縮（「テーブル形式で出力」とのみ記載）
  - 選択肢と動作を1行に統合

#### 10. Phase 2 Step 4 改善適用の圧縮（行296-318: 23行 → 12行、削減11行）
- **現在の記述**:
  - テキスト出力フォーマット（1行）
  - バックアップ作成手順（Bash コマンド全文、パス記録の詳細、2行）
  - バックアップ失敗時の処理（エラー出力全文、Phase 3 直行、3行）
  - Task 実行プロンプト全文（パス変数3つの詳細、6行）
  - サブエージェント完了後の処理（返答抽出、テキスト出力、2行）
  - エラーハンドリング（復旧コマンド全文記載、2行）
- **改善後の記述**:
  - バックアップ作成と失敗時処理を1行に統合
  - Task 実行プロンプトをパス変数リストのみに圧縮（3行）
  - 完了後処理とエラーハンドリングを1行に統合

#### 11. Phase 2 検証ステップの圧縮（行320-341: 22行 → 10行、削減12行）
- **現在の記述**:
  - サブエージェント委譲プロンプト全文（パス変数3つの詳細、6行）
  - サブエージェント失敗時の処理（エラー出力、Phase 3 進行、2行）
  - 返答抽出（正規表現記載、1行）
  - validation_status が "failed" の場合の処理（rollback_executed 分岐、テキスト出力2パターン、6行）
  - validation_status が "passed" の場合の処理（テキスト出力、1行）
- **改善後の記述**:
  - サブエージェント委譲プロンプトをパス変数リストのみに圧縮（3行）
  - 失敗時処理と返答抽出を1行に統合
  - validation_status 分岐を1つのコードブロックに統合（3行）

#### 12. Phase 3 完了サマリの圧縮（行343-370: 28行 → 15行、削減13行）
- **現在の記述**:
  - 完了サマリフォーマット全文（条件分岐ごとに詳細記載、22行）
  - 次のステップ説明（critical/improvement 別の推奨、2行）
- **改善後の記述**:
  - サマリフォーマットを必須項目のみに絞り、条件分岐を `{条件時のみ表示}` 形式で圧縮（10行）
  - 次のステップ説明を1行に圧縮

#### 13. 共通の圧縮技法
- **正規表現の詳細記載を削減**: 「抽出する（正規表現: `pattern`）」→「抽出する」に統一（複数箇所で適用）
- **エラーメッセージ全文記載を削減**: 「エラー出力して終了: `{詳細メッセージ}`」→「エラー出力して終了」に統一
- **テキスト出力フォーマットのコードブロック削減**: 複数行のコードブロックを1行に圧縮、または「以下のフォーマット」を「サマリ形式」に置き換え
- **手順の詳細説明を統合**: 「A を実行する。B を実行する。C を実行する。」→「A, B, C を実行する」に統合

## 新規作成ファイル
（なし）

## 削除推奨ファイル
（なし）

## 実装順序
1. SKILL.md を上記変更内容に従って圧縮（依存なし、単独で実施可能）

依存関係の検出方法:
- 今回の変更は SKILL.md のみで完結し、他ファイルへの依存なし

## 注意事項
- **機能削減なし**: 圧縮はあくまで「説明の簡潔化」「冗長な記載の除去」であり、実際のワークフロー・エラーハンドリング・検証ステップの機能は維持する
- **可読性の維持**: 過度な圧縮で理解不能にならないよう、各フェーズの主要ステップは明確に残す
- **外部参照の維持**: テンプレートファイル（collect-findings.md, apply-improvements.md, validate-agent-structure.md, classify-agent-group.md）への参照は変更しない
- **テスト**: 圧縮後に `/agent_audit` を実行し、全フェーズが正常動作することを確認する
- **目標達成**: 369行 → 250行（削減119行）を目標とするが、可読性を損なわない範囲で調整する
