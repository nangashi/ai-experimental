# 改善計画: agent_audit_new

## 変更対象ファイル
| # | ファイル | 変更種別 | 変更概要 | 対応フィードバック |
|---|---------|---------|---------|------------------|
| 1 | SKILL.md | 修正 | パス変数セクション追加、エラーハンドリング強化、バリデーション処理の明確化 | C-2, C-3, C-4, C-5, I-1, I-5, I-6, I-7, I-8 |
| 2 | group-classification.md | 修正 | 参照整合性の保証（処理ロジックとの一致確認） | C-1, I-2 |
| 3 | templates/apply-improvements.md | 修正 | 変更適用ルールの簡潔化 | I-9 |
| 4 | agents/shared/instruction-clarity.md | 修正 | テンプレートサイズ削減（172行→150行以下） | I-3 |
| 5 | agents/evaluator/criteria-effectiveness.md | 修正 | テンプレートサイズ削減（185行→150行以下） | I-3 |
| 6 | agents/evaluator/scope-alignment.md | 修正 | テンプレートサイズ削減（169行→150行以下） | I-3 |
| 7 | agents/evaluator/detection-coverage.md | 修正 | テンプレートサイズ削減（201行→150行以下） | I-3 |
| 8 | agents/producer/workflow-completeness.md | 修正 | テンプレートサイズ削減（191行→150行以下） | I-3 |
| 9 | agents/producer/output-format.md | 修正 | テンプレートサイズ削減（196行→150行以下） | I-3 |
| 10 | agents/unclassified/scope-alignment.md | 修正 | テンプレートサイズ削減（151行→150行以下） | I-3 |

## 各ファイルの変更詳細

### 1. SKILL.md（修正）
**対応フィードバック**:
- C-2: 参照整合性: プレースホルダの未定義
- C-3: 冪等性: 再実行時の状態破壊
- C-4: 条件分岐の完全性: デフォルト処理の欠落
- C-5: 出力フォーマット決定性: サブエージェント返答の不完全検証
- I-1: Phase 0 でエージェント定義内容を保持し続ける
- I-5: 冪等性: バックアップの重複生成
- I-6: 欠落ステップ - 検証結果のユーザー報告が不完全
- I-7: 親が各次元の findings ファイルを Phase 2 Step 1 で全件 Read する
- I-8: Phase 1 返答バリデーション処理の長さ

**変更内容**:

#### 1-1: パス変数セクションの追加（L12-L19の後に挿入）
- 変更: 「使い方」セクションの後に「パス変数」セクションを新規追加
- 追加内容:
```markdown
## パス変数

スキル内で使用するパス変数の定義:
- `{agent_path}`: エージェント定義ファイルの絶対パス（Phase 0で取得）
- `{agent_name}`: エージェント名（Phase 0で導出）
- `{agent_content}`: エージェント定義の内容（Phase 0でのみ使用、グループ分類後は破棄）
- `{agent_group}`: エージェントグループ（hybrid/evaluator/producer/unclassified）
- `{findings_save_path}`: findings保存先（`.agent_audit/{agent_name}/audit-{ID_PREFIX}.md`）
- `{approved_findings_path}`: 承認済みfindings（`.agent_audit/{agent_name}/audit-approved.md`）
- `{backup_path}`: バックアップファイルパス（`{agent_path}.backup-{timestamp}`）
```

#### 1-2: Phase 0 Step 2 の変更（L57）
- 現在: `2. Read で `agent_path` のファイルを読み込み、`{agent_content}` として保持する。読み込み失敗時はエラー出力して終了`
- 変更後: `2. Read で `agent_path` のファイルを読み込み、`{agent_content}` として一時保持する。読み込み失敗時はエラー出力して終了`

#### 1-3: Phase 0 グループ分類後の追記（L72の後に追加）
- 追加内容: `グループ分類完了後、`{agent_content}` を破棄する（次元サブエージェントは `{agent_path}` を直接Readするため、親コンテキストでの保持は不要）`

#### 1-4: group-classification.md 参照エラーハンドリング（L64の後に追加）
- 現在: `エージェント定義の **主たる機能** に注目して分類する。分類基準の詳細は `group-classification.md` を参照。`
- 追加内容（L64の直後）: `（`group-classification.md` が存在しない場合はエラー出力して終了する）`

#### 1-5: Phase 0 Step 6 の冪等性明記（L81）
- 現在: `6. 出力ディレクトリを作成する: `mkdir -p .agent_audit/{agent_name}/``
- 変更後: `6. 出力ディレクトリを作成する: `mkdir -p .agent_audit/{agent_name}/`（既存ディレクトリが存在する場合はそのまま使用する。既存ファイルは上書きせず、各Phaseで必要に応じて新規作成または更新する）`

#### 1-6: Phase 1 返答バリデーション処理の簡潔化（L125-L130を削除し、外部参照に置換）
- 現在: 15行のバリデーション・エラーハンドリング・部分成功判定ロジック
- 変更後: `**返答バリデーション・エラーハンドリング**: 詳細は別ファイルで定義する。要約: 各サブエージェントの返答フォーマット検証、findings ファイルの存在確認、部分成功判定（全失敗/IC失敗+固有次元全失敗→終了、それ以外→継続）`
- 注記: 実際の外部化は新規テンプレート作成が必要（次の改善サイクルで対応）

#### 1-7: Phase 1 '?' 処理の明確化（L125の行内追加）
- 現在: `フォーマット不正時は件数を「?」として表示し、後続の findings ファイル読み込み時にファイル内容から件数を推定する。`
- 変更後: `フォーマット不正時は件数を「?」として表示し、後続の findings ファイル読み込み時にファイル内容から件数を推定する。推定失敗時は件数を0として扱い、該当次元を失敗として扱う。`

#### 1-8: Phase 2 Step 1 の遅延読み込み（L154-L157）
- 現在: `Phase 1 で成功した全次元の findings ファイル（`.agent_audit/{agent_name}/audit-{ID_PREFIX}.md`）を Read する。各ファイルから severity が critical または improvement の finding（`###` ブロック単位）を抽出し、critical → improvement の順にソートする。`
- 変更後: `Phase 1 で成功した全次元の件数（critical + improvement）を集計し、合計が0の場合はPhase 2をスキップしてPhase 3へ直行する。合計が1以上の場合、全次元の findings ファイル（`.agent_audit/{agent_name}/audit-{ID_PREFIX}.md`）を Read する。各ファイルから severity が critical または improvement の finding（`###` ブロック単位）を抽出し、critical → improvement の順にソートする。`

#### 1-9: Phase 2 Step 2 AskUserQuestion のタイムアウト処理（L172-L175の後に追加）
- 追加内容: `（AskUserQuestionのタイムアウトまたは不正入力時は「キャンセル」として扱う）`

#### 1-10: Phase 2 Step 2a AskUserQuestion のタイムアウト処理（L190-L195の後に追加）
- 追加内容: `（AskUserQuestionのタイムアウトまたは不正入力時は「キャンセル」として扱い、Phase 3へ直行する）`

#### 1-11: Phase 2 Step 2a 修正内容バリデーション（L192の後に追加）
- 追加内容: `入力が空または不明確な場合は「入力内容が不明確です。この指摘をスキップします。」と表示し、「スキップ」として扱う。`

#### 1-12: Phase 2 Step 4 バックアップ方針の明確化（L233-L236）
- 現在: バックアップの既存チェックと新規作成のロジック
- 追加内容（L236の後に追加）: `（Phase 2を複数回実行する場合、最初のバックアップを保持し、2回目以降は既存バックアップを再利用する。これにより最初の正常状態へのロールバックが常に可能になる）`

#### 1-13: Phase 2 Step 4 改善適用確認のタイムアウト処理（L227-L229の後に追加）
- 追加内容: `（AskUserQuestionのタイムアウトまたは不正入力時は「キャンセル」として扱う）`

#### 1-14: Phase 2 検証ステップの結果保存（L265の後に追加）
- 追加内容:
```markdown
6. 検証結果を `.agent_audit/{agent_name}/verification.md` に Write で保存する:
   - 検証成否
   - 各検証項目の結果（frontmatter存在、finding適用状況）
   - 失敗理由（失敗時のみ）
   - ロールバック手順（失敗時のみ）
```

### 2. group-classification.md（修正）
**対応フィードバック**:
- C-1: 参照整合性: ファイル不在時の挙動
- I-2: Phase 0 グループ分類ロジックの重複

**変更内容**:

#### 2-1: SKILL.md との整合性チェックコメント追加（ファイル先頭に追加）
- 追加内容:
```markdown
# エージェントグループ分類基準

**整合性**: この基準は SKILL.md の Phase 0 Step 4 で参照される。判定ルールの変更時は SKILL.md の記述も同期更新すること。

```

#### 2-2: 判定ルールの詳細度向上（現行の簡潔さは維持）
- 現在の内容は適切であり、変更不要。SKILL.md 側で詳細参照として位置付けを明確化する。

### 3. templates/apply-improvements.md（修正）
**対応フィードバック**: I-9: apply-improvements.md テンプレートの変更適用ルール詳細度

**変更内容**:

#### 3-1: 変更適用ルールの簡潔化（L20-L27）
- 現在: 8行にわたる詳細ルール
- 変更後:
```markdown
## 変更適用ルール
1. **順序**: 削除 → 統合 → 修正 → 追加（範囲大→小）
2. **二重適用防止**: Edit前に現在内容を確認し、一致しない場合はスキップ
3. **ツール優先度**: Edit優先（部分変更）、Write は全体書き換え時のみ
4. **Read必須**: 変更前に必ず Read を実行
5. **スコープ厳守**: 承認済みfindings以外の変更禁止、ファイル削除禁止
6. **ユーザー修正優先**: 「修正内容」記載時は推奨を無視し修正内容のみ適用
```

### 4-10. agents/配下の次元エージェントテンプレート（修正）
**対応フィードバック**: I-3: 次元エージェントテンプレートのサイズ

**変更内容**（全テンプレート共通）:
- 各テンプレートの詳細な例示セクション・重複説明を削減
- 評価基準の説明を箇条書きに簡潔化
- 出力フォーマット例を1-2例に縮小
- 目標: 各テンプレート150行以下に削減

具体的な削減箇所は各ファイルの内容確認後に決定する（現時点では構造分析のみ）。

## 新規作成ファイル

なし（I-8のバリデーション処理外部化は次の改善サイクルで対応）

## 削除推奨ファイル

なし

## 実装順序

1. **group-classification.md の整合性コメント追加**（2-1）
   - 理由: 後続の SKILL.md 変更時の参照基準を確立

2. **SKILL.md のパス変数セクション追加**（1-1）
   - 理由: 以降の変更で参照される変数定義を先に確立

3. **SKILL.md の Phase 0 エラーハンドリング・冪等性改善**（1-2, 1-3, 1-4, 1-5）
   - 理由: スキル初期化の安定性を確保

4. **SKILL.md の Phase 1 バリデーション改善**（1-6, 1-7）
   - 理由: 並列分析の結果処理を明確化

5. **SKILL.md の Phase 2 改善**（1-8 から 1-14 まで）
   - 理由: ユーザーインタラクション・改善適用の安定性向上

6. **templates/apply-improvements.md の簡潔化**（3-1）
   - 理由: SKILL.md Phase 2 Step 4 で参照されるため、SKILL.md の変更後に対応

7. **agents/ 配下のテンプレートサイズ削減**（4-10）
   - 理由: SKILL.md Phase 1 で参照されるが、並列実行のため最後に一括対応可能

## 注意事項

- **SKILL.md の変更は段階的に適用し、各段階で構文チェックを実行すること**（長大ファイルのため一括変更は避ける）
- **I-8 のバリデーション処理外部化は新規テンプレート作成を伴うため、本サイクルでは「簡潔化コメント追加」に留め、次サイクルで完全外部化を実施**
- **I-4 の自動ロールバック確認は Phase 2 検証ステップに統合されている（1-14で対応）**
- **テンプレートサイズ削減（4-10）は各ファイルの内容精査が必要なため、別途詳細設計を実施すること**
