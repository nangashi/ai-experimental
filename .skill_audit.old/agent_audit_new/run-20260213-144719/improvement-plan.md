# 改善計画: agent_bench_new

## 変更対象ファイル
| # | ファイル | 変更種別 | 変更概要 | 対応フィードバック |
|---|---------|---------|---------|------------------|
| 1 | SKILL.md | 修正 | Phase 4 返答処理の簡略化、Phase 0 perspective フォールバック処理の条件追加、Phase 0 Step 4 critic 受信処理の明示化、perspective 生成失敗時の再試行処理、agent_exists フラグ初期化の明示化、Phase 1B Deep モード枯渇処理の定義 | I-1, I-2, I-3, I-4, I-5, I-6 |
| 2 | templates/perspective/generate-perspective.md | 修正 | reference_perspective_path が空の場合の処理を明記 | I-7 |
| 3 | templates/phase1a-variant-generation.md | 修正 | 返答フォーマットを1行に簡略化 | I-8 |
| 4 | templates/phase1b-variant-generation.md | 修正 | 返答フォーマットを1行に簡略化 | I-8 |
| 5 | templates/phase2-test-document.md | 修正 | 返答フォーマットを1行に簡略化 | I-9 |

## 各ファイルの変更詳細

### 1. SKILL.md（修正）
**対応フィードバック**: I-1, I-2, I-3, I-4, I-5, I-6

**変更内容**:

- **Phase 0 Step 2 (62-70行付近)**: perspective フォールバック処理に上書き防止条件を追加
  - 現在: パターンマッチで見つかった場合に既存ファイルを確認なく上書きする
  - 改善後: `perspective-source.md` が存在しない場合のみコピーする条件を追加

- **Phase 0 Step 2-3 (62-103行付近)**: agent_exists フラグの初期化を明示化
  - 現在: agent_exists の設定処理が明示されていない
  - 改善後: Phase 0 Step 2 でエージェントファイル読み込み時に `agent_exists` を明示的に設定する記述を追加（エージェント定義ファイルが存在する場合は "true"、存在しない場合は "false"）

- **Phase 0 Step 3-5 (104-140行付近)**: perspective 初期生成失敗時の再試行処理を定義
  - 現在: Step 3 失敗時の再試行処理が未定義
  - 改善後: Step 3 でサブエージェントが失敗した場合は1回再試行し、2回とも失敗した場合はエラー出力して終了する

- **Phase 0 Step 4 (114-131行付近)**: 4並列批評エージェントの受信処理を構造化
  - 現在: 受信処理が非構造化（「各サブエージェントは SendMessage で報告する」のみ）
  - 改善後: 4並列エージェントからのメッセージ受信後、以下の処理を実行する:
    1. 各批評メッセージから「## 重大な問題」「## 改善提案」セクションを抽出する
    2. 4件の批評全てについて「## 重大な問題」セクションの項目数を確認する
    3. 全て0件の場合は再生成をスキップし、1件でも問題がある場合はフィードバック統合と再生成を実行する

- **Phase 1B (216-234行付近)**: Deep モード枯渇ケースの処理を定義
  - 現在: EFFECTIVE カテゴリ内の全バリエーションが TESTED になった場合の処理が未定義
  - 改善後: Deep モードで選択可能な UNTESTED バリエーションが枯渇した場合は Broad モードにフォールバックし、他カテゴリの UNTESTED 基本バリエーションを選択する。全てのバリエーションが TESTED の場合は EFFECTIVE カテゴリの最高スコアバリエーションを再テストする

- **Phase 4 (303-323行付近)**: 採点サブエージェントの返答処理を簡略化
  - 現在: 「各サブエージェントの返答（スコアサマリ）をテキスト出力し、Phase 5 へ進む」
  - 改善後: 「全採点完了後、「Phase 4 完了: 採点完了」とテキスト出力し、Phase 5 へ進む」（スコアサマリの中継を削除。Phase 5 は採点ファイルを直接 Read する）

### 2. templates/perspective/generate-perspective.md（修正）
**対応フィードバック**: I-7

**変更内容**:

- **Step 1 (3-5行付近)**: reference_perspective_path が空の場合の処理を明記
  - 現在: `{reference_perspective_path}` が指定されている場合: 参照用の観点定義（構造とフォーマットを把握する）
  - 改善後: 以下を追記
    ```
    - {reference_perspective_path} が指定されている場合: Read で参照用の観点定義（構造とフォーマットを把握する）
    - {reference_perspective_path} が空文字列の場合: 参照をスキップし、必須スキーマと生成ガイドラインのみに基づいて生成する
    ```

### 3. templates/phase1a-variant-generation.md（修正）
**対応フィードバック**: I-8

**変更内容**:

- **返答フォーマット (26-46行付近)**: 詳細な返答フォーマットを1行に簡略化
  - 現在: 9-26行の返答（エージェント定義サマリ、構造分析結果テーブル、生成バリアント詳細）
  - 改善後:
    ```
    9. 以下のフォーマットで1行のみ返答する:

    生成完了: 3バリアント (v001-baseline, v001-variant-{name1}, v001-variant-{name2})
    ```

### 4. templates/phase1b-variant-generation.md（修正）
**対応フィードバック**: I-8

**変更内容**:

- **返答フォーマット (30-44行付近)**: 詳細な返答フォーマットを1行に簡略化
  - 現在: 5-30行の返答（選定プロセス、生成バリアント詳細）
  - 改善後:
    ```
    5. 以下のフォーマットで1行のみ返答する:

    生成完了: 3バリアント (v{NNN}-baseline, v{NNN}-variant-{name1}, v{NNN}-variant-{name2})
    ```

### 5. templates/phase2-test-document.md（修正）
**対応フィードバック**: I-9

**変更内容**:

- **返答フォーマット (14-32行付近)**: 詳細な返答フォーマットを1行に簡略化
  - 現在: 7-32行の返答（テスト対象文書サマリ、埋め込み問題一覧テーブル、ボーナス問題リスト）
  - 改善後:
    ```
    7. 以下のフォーマットで1行のみ返答する:

    生成完了: テスト文書 (埋め込み問題: {N}件, ボーナス: {M}件)
    ```
    ここで {N} は埋め込み問題数、{M} はボーナス問題数

## 新規作成ファイル

なし

## 削除推奨ファイル

なし

## 実装順序

1. **templates/perspective/generate-perspective.md** — 参照パス空処理の明記（独立変更）
2. **templates/phase1a-variant-generation.md** — 返答フォーマット簡略化（独立変更）
3. **templates/phase1b-variant-generation.md** — 返答フォーマット簡略化（独立変更）
4. **templates/phase2-test-document.md** — 返答フォーマット簡略化（独立変更）
5. **SKILL.md** — 全ての修正を反映（テンプレート変更完了後に実施。Phase 4 返答処理の変更は Phase 5 テンプレートが採点ファイルを直接読むことを前提とするため、テンプレート側の動作確認後に変更推奨）

依存関係の検出方法:
- テンプレートファイルの返答フォーマット変更（改善2-5）は SKILL.md の期待する返答形式と整合する必要がある
- SKILL.md の変更はテンプレート変更完了後に実施することで、整合性を保つ

## 注意事項

- **Phase 4 の変更**: Phase 5 テンプレート (templates/phase5-analysis-report.md) は採点ファイルを直接 Read する設計のため、Phase 4 のスコアサマリ中継削除は安全。ただし、SKILL.md の Phase 2 で「埋め込み問題数」を answer-key から抽出している処理との整合性を確認すること
- **Phase 0 Step 4 の変更**: 4並列批評エージェント受信処理の構造化により、フィードバック統合判定ロジックが明確化される。ただし、メッセージ受信タイミングと順序に依存しないよう、全4件受信完了後に判定処理を実行すること
- **Phase 1B Deep モード枯渇処理**: フォールバック処理により無限ループを回避。ただし、再テスト実行時は knowledge.md のバリエーションステータスを「RE-TESTED」等の別ステータスで管理するか、再テスト回数を記録することを推奨
- **テンプレート返答の簡略化**: SKILL.md 側で返答を使用している箇所（例: Phase 2 の埋め込み問題数表示）がある場合は、ファイルから直接読み取る処理に変更すること
