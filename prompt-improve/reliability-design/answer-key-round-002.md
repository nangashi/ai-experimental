# 正解キー

## 実行条件
- **観点**: reliability
- **対象**: design
- **埋め込み問題数**: 10問

## 埋め込み問題一覧

### P01: Kafka Streams障害時のデータ損失リスク
- **カテゴリ**: 障害回復設計
- **深刻度**: 重大
- **該当箇所**: セクション3「アーキテクチャ設計」、セクション4「データフロー」
- **問題の説明**: Kafka Streams ProcessorがTimescaleDBへの書き込みに失敗した場合の処理が未定義。リトライ戦略、デッドレターキュー、オフセット管理の方針がなく、ストリーム処理障害時にデータ損失が発生する可能性がある。
- **検出判定基準**:
  - ○（検出）: Kafka Streams処理の障害時におけるデータ損失リスク、またはTimescaleDB書き込み失敗時のリトライ/デッドレターキュー戦略の欠如を指摘している
  - △（部分検出）: ストリーム処理の障害対策に言及しているが、データ損失の具体的なリスクシナリオやリトライ戦略に触れていない
  - ×（未検出）: 指摘なし

### P02: ファームウェア更新のトランザクション整合性欠如
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 重大
- **該当箇所**: セクション4「データモデル」firmware_updates/device_update_statusテーブル、セクション5「POST /api/v1/firmware/updates」
- **問題の説明**: ファームウェア更新スケジュール作成（firmware_updates INSERT）とデバイス別ステータス初期化（device_update_status INSERT）が複数テーブルにまたがるが、トランザクション保証の設計がない。部分的な更新失敗により、更新ジョブが作成されたがデバイスステータスが初期化されない不整合状態が発生しうる。
- **検出判定基準**:
  - ○（検出）: firmware_updatesとdevice_update_status間のトランザクション整合性の欠如、または複数テーブル更新における部分失敗時の不整合リスクを指摘している
  - △（部分検出）: データ整合性の一般的な懸念に言及しているが、ファームウェア更新の具体的なトランザクション境界に触れていない
  - ×（未検出）: 指摘なし

### P03: デバイス認証トークン検証失敗時のフォールバック未定義
- **カテゴリ**: 障害回復設計
- **深刻度**: 重大
- **該当箇所**: セクション3「Device Ingestion Service」、セクション5「デバイス認証」
- **問題の説明**: デバイス認証トークンの検証処理において、AWS IoT Core証明書検証サービスが応答しない場合の動作が未定義。一時的な認証サービス障害時にすべてのデバイスデータ送信が失敗する可能性があるが、グレースフルデグラデーション戦略（キャッシュされた認証情報の利用など）が設計されていない。
- **検出判定基準**:
  - ○（検出）: AWS IoT Core認証サービス障害時のフォールバック戦略の欠如、またはデバイス認証失敗時のグレースフルデグラデーション設計の必要性を指摘している
  - △（部分検出）: 外部サービス依存の障害対策に一般論として言及しているが、デバイス認証の具体的なフォールバックシナリオに触れていない
  - ×（未検出）: 指摘なし

### P04: PostgreSQLとTimescaleDBの障害分離境界が不明確
- **カテゴリ**: 可用性・冗長性・災害復旧
- **深刻度**: 中
- **該当箇所**: セクション2「データベース」、セクション3「アーキテクチャ設計」
- **問題の説明**: デバイスメタデータ（PostgreSQL）と時系列データ（TimescaleDB）が別々のデータストアとして記載されているが、物理的な分離構成（異なるRDSインスタンスか、同一インスタンスの異なるDBか）が不明確。TimescaleDBの障害がPostgreSQLのデバイス管理に波及するか、またはその逆のシナリオにおける影響範囲が設計されていない。
- **検出判定基準**:
  - ○（検出）: PostgreSQLとTimescaleDBの障害分離境界の不明確さ、または一方のDB障害が他方に波及するリスクについて指摘している
  - △（部分検出）: データベースの冗長性や障害対策に言及しているが、PostgreSQLとTimescaleDBの分離構成の具体的な影響範囲に触れていない
  - ×（未検出）: 指摘なし

### P05: ファームウェア更新のべき等性設計欠如
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 中
- **該当箇所**: セクション3「Firmware Update Service」、セクション4「device_update_statusテーブル」
- **問題の説明**: デバイス側のネットワーク不安定により同一ファームウェア更新リクエストが重複送信される可能性があるが、べき等性を保証する設計（リクエストIDベースの重複検出、ステータス遷移の冪等性保証）が未定義。重複リクエストにより、device_update_statusに同一device_id/update_idの複数レコードが作成される可能性がある（PRIMARY KEY制約によりエラーとなるが、リトライ処理との整合性が不明確）。
- **検出判定基準**:
  - ○（検出）: ファームウェア更新リクエストのべき等性欠如、または重複リクエスト処理の設計不足を指摘している
  - △（部分検出）: リトライやネットワーク障害対策に言及しているが、べき等性の具体的な実装メカニズムに触れていない
  - ×（未検出）: 指摘なし

### P06: API Gatewayのタイムアウト設計未定義
- **カテゴリ**: 障害回復設計
- **深刻度**: 中
- **該当箇所**: セクション3「全体構成」[API Gateway]、セクション5「API設計」
- **問題の説明**: API GatewayからBackend APIへのリクエストタイムアウト値が未定義。長時間実行クエリ（GET /api/v1/devices/{device_id}/metrics）がタイムアウトなく継続し、リソース枯渇やカスケード障害を引き起こす可能性がある。P95/P99レイテンシ目標は定義されているが、タイムアウト値との整合性が不明確。
- **検出判定基準**:
  - ○（検出）: API Gatewayのタイムアウト設計の欠如、または長時間実行クエリに対するタイムアウト戦略の必要性を指摘している
  - △（部分検出）: APIのパフォーマンス要件に言及しているが、タイムアウト設計の具体的な必要性に触れていない
  - ×（未検出）: 指摘なし

### P07: Redisキャッシュ障害時のフォールバック戦略欠如
- **カテゴリ**: 可用性・冗長性・災害復旧
- **深刻度**: 中
- **該当箇所**: セクション2「キャッシュ: Redis 7.2」、セクション3「Backend API → [Redis Cache]」
- **問題の説明**: Redisキャッシュが利用不可の場合の動作が未定義。キャッシュミス時の直接DB読み込みフォールバックの有無、Redisの単一障害点（SPOF）としてのリスク評価、Redis障害時のサービスレベル低下の許容範囲が設計されていない。
- **検出判定基準**:
  - ○（検出）: Redis障害時のフォールバック戦略の欠如、またはRedisのSPOFリスクを指摘している
  - △（部分検出）: キャッシュの可用性に言及しているが、障害時の具体的なフォールバック動作に触れていない
  - ×（未検出）: 指摘なし

### P08: SLO/SLAに対応する具体的な監視・アラート設計の欠如
- **カテゴリ**: 監視・アラート設計
- **深刻度**: 中
- **該当箇所**: セクション7「可用性・スケーラビリティ」目標稼働率99.9%、セクション8「監視項目」「アラート設定」
- **問題の説明**: 目標稼働率99.9%（月間ダウンタイム43分以内）という数値目標は定義されているが、この目標を達成するための具体的なSLO指標（エラーバジェット、サービスレベル指標）とアラート閾値設定が未定義。監視項目とアラート設定の記載はあるが、SLO違反を検知する具体的なメトリクス（例: エラー率がエラーバジェットの80%消費時にアラート）との紐付けが不明確。
- **検出判定基準**:
  - ○（検出）: SLO/SLA目標に対応する具体的な監視指標・アラート閾値の欠如、またはエラーバジェットベースの監視設計の必要性を指摘している
  - △（部分検出）: 監視・アラートの一般的な改善提案があるが、SLO/SLA目標との具体的な紐付けに触れていない
  - ×（未検出）: 指摘なし

### P09: データベースバックアップ戦略の詳細欠如
- **カテゴリ**: 可用性・冗長性・災害復旧
- **深刻度**: 軽微
- **該当箇所**: セクション7「可用性・スケーラビリティ」データ保持期間の記載はあるが、バックアップ戦略の記載なし
- **問題の説明**: データ保持期間（ホットデータ90日、コールドデータ2年）は定義されているが、データベースのバックアップ頻度、バックアップ保持期間、リストア手順、RPO/RTOの具体的な数値目標が未定義。災害復旧時のデータ損失許容範囲とリストア時間目標が不明確。
- **検出判定基準**:
  - ○（検出）: データベースバックアップ戦略の欠如、またはRPO/RTO定義の必要性を指摘している
  - △（部分検出）: データ保持やアーカイブに言及しているが、バックアップ戦略やRPO/RTOの具体的な設計に触れていない
  - ×（未検出）: 指摘なし

### P10: Rolling Updateのロールバック計画欠如
- **カテゴリ**: デプロイ・ロールバック
- **深刻度**: 軽微
- **該当箇所**: セクション6「デプロイメント」Kubernetes Rolling Update
- **問題の説明**: デプロイ戦略としてKubernetes Rolling Updateが指定されているが、デプロイ後に問題が発見された場合のロールバック手順（自動ロールバックトリガー、手動ロールバック手順、ロールバック時のデータマイグレーション後方互換性）が未定義。maxUnavailable/maxSurgeパラメータは定義されているが、ロールバック計画がない。
- **検出判定基準**:
  - ○（検出）: Rolling Updateのロールバック計画の欠如、またはデプロイ後の問題発生時の対応手順の必要性を指摘している
  - △（部分検出）: デプロイ戦略に言及しているが、ロールバックの具体的な計画に触れていない
  - ×（未検出）: 指摘なし

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 可用性・冗長性 | AWS IoT Core（MQTTブローカー）の単一リージョン構成によるSPOFリスク | IoT Coreのリージョン障害時の影響またはマルチリージョン構成の必要性を指摘 |
| B02 | 監視・アラート | Kafka Streamsのストリーム処理遅延（Kafka Lag）の監視設計欠如 | Kafka Lagモニタリングまたはストリーム処理遅延の監視必要性を指摘 |
| B03 | 障害回復設計 | MQTT再接続時のデータ補完メカニズム（QoS設定、Persistent Session）の未定義 | MQTTのQoS設定またはデバイスオフライン時のデータ欠損リスクを指摘 |
| B04 | データ整合性 | TimescaleDBのハイパーテーブル圧縮ポリシーとクエリパフォーマンスの整合性 | TimescaleDBの圧縮ポリシーまたは古いデータのクエリパフォーマンス劣化リスクを指摘 |
| B05 | デプロイ・ロールバック | データベーススキーママイグレーション戦略（ゼロダウンタイムマイグレーション、後方互換性）の欠如 | スキーママイグレーションの後方互換性またはゼロダウンタイムマイグレーション戦略の必要性を指摘 |
