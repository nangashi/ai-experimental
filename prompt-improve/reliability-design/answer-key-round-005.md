# 正解キー - Round 005

## 実行条件
- **観点**: reliability
- **対象**: design
- **埋め込み問題数**: 10問

## 埋め込み問題一覧

### P01: 外部サービス呼び出しの障害回復設計が未定義
- **カテゴリ**: 障害回復設計
- **深刻度**: 重大
- **該当箇所**: セクション3.2（IntegrationService）、セクション3.3（NotificationWorker）
- **問題の説明**: Slack API、SendGrid、GitHub API、Google Calendar API等の外部サービス呼び出しに対して、サーキットブレーカー、リトライ戦略、タイムアウト設計、フォールバック戦略のいずれも定義されていない。外部サービスの障害時にアプリケーション全体が影響を受けるリスクがあり、通知遅延やリクエストキューイングの設計も不明確。
- **検出判定基準**:
  - ○（検出）: 外部サービス（Slack/SendGrid/GitHub/Google Calendar）呼び出しに対するサーキットブレーカー、リトライ戦略、タイムアウト、フォールバックのいずれかの欠如を指摘している
  - △（部分検出）: 外部API連携の障害リスクに言及しているが、具体的な回復メカニズム（サーキットブレーカー、リトライ等）の欠如を明示していない
  - ×（未検出）: 外部サービスの障害回復に関する指摘がない

### P02: タスク更新と通知送信の一貫性保証が未設計
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 重大
- **該当箇所**: セクション3.3（タスク作成フロー）
- **問題の説明**: タスク作成フローでは「PostgreSQLにタスク保存」→「SQSに通知メッセージ送信」の順序で処理が行われるが、SQS送信失敗時の扱いが未定義。データベーストランザクションとSQSメッセージ送信の一貫性保証がないため、タスクは作成されたが通知が送信されない状態が発生しうる。Outbox PatternやTransactional Outboxの検討が必要。
- **検出判定基準**:
  - ○（検出）: タスク保存とSQS通知送信の間の一貫性問題、またはデータベーストランザクションとメッセージキュー送信の原子性問題を指摘している
  - △（部分検出）: 通知送信の信頼性やメッセージキューの障害リスクに言及しているが、データベース操作との一貫性問題を明示していない
  - ×（未検出）: データベースとメッセージキューの一貫性に関する指摘がない

### P03: WebSocketサーバーの障害時の影響範囲と復旧設計
- **カテゴリ**: 可用性・冗長性・災害復旧
- **深刻度**: 重大
- **該当箇所**: セクション3.1（WebSocket Tasks）、セクション3.2（WebSocket Server）
- **問題の説明**: WebSocket Tasksは2インスタンス構成だが、障害時のクライアント再接続設計、メッセージ配信保証、未配信メッセージの再送機構が未定義。ALBのsticky sessionにより特定タスクの障害時に接続中クライアントが全断となるリスクがあるが、フェイルオーバー設計が不明確。また、WebSocket経由の活動フィード配信失敗時の代替手段（ポーリング等）の検討が必要。
- **検出判定基準**:
  - ○（検出）: WebSocketサーバー障害時のクライアント再接続、メッセージ配信保証、またはsticky sessionによる単一障害点のリスクを指摘している
  - △（部分検出）: WebSocketの可用性や冗長性に言及しているが、具体的な障害シナリオ（タスク障害時の影響範囲、再接続設計等）を明示していない
  - ×（未検出）: WebSocketの障害回復に関する指摘がない

### P04: ファイルアップロードフローのトランザクション境界
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 中
- **該当箇所**: セクション3.3（ファイルアップロードフロー）、セクション4.1（filesテーブル）
- **問題の説明**: ファイルアップロードは「S3署名付きURL発行」→「Frontend直接アップロード」→「アップロード完了通知」の3段階フローだが、最終ステップ（confirm API）の失敗時にS3上にファイルは存在するがデータベース上にメタデータが存在しない孤児ファイルが発生する。クリーンアップ機構（S3ライフサイクルルールやバッチ削除）の設計が必要だが言及がない。また、confirm APIのべき等性設計も不明確。
- **検出判定基準**:
  - ○（検出）: ファイルアップロード完了通知（confirm API）失敗時のS3孤児ファイル問題、またはconfirm APIのべき等性問題を指摘している
  - △（部分検出）: ファイルアップロードの信頼性やトランザクション境界に言及しているが、孤児ファイルやconfirm失敗時の具体的な整合性問題を明示していない
  - ×（未検出）: ファイルアップロードの整合性に関する指摘がない

### P05: タスク更新の楽観的ロックの競合時の挙動
- **カテゴリ**: データ整合性・べき等性
- **深刻度**: 中
- **該当箇所**: セクション4.1（tasksテーブルのversion列）、セクション5.1（PUT /api/tasks/{id}）
- **問題の説明**: タスク更新に楽観的ロック（version列）を使用しているが、競合検出時（version不一致）のリトライ戦略やクライアント側へのエラーハンドリング指針が未定義。リトライ時のべき等性確保の方針も不明確で、複数ユーザーが同時にタスクを更新する際のユーザー体験が設計されていない。
- **検出判定基準**:
  - ○（検出）: 楽観的ロックの競合時のリトライ戦略、べき等性、またはクライアント側エラーハンドリングの不明確さを指摘している
  - △（部分検出）: タスク同時更新の競合リスクに言及しているが、楽観的ロックversionの具体的な運用設計（競合時の挙動）を明示していない
  - ×（未検出）: 楽観的ロックの運用に関する指摘がない

### P06: Background Jobsのタイムアウトとリトライ設計
- **カテゴリ**: 障害回復設計
- **深刻度**:中
- **該当箇所**: セクション3.2（Background Jobs）
- **問題の説明**: NotificationWorker、SyncWorker、ReportGeneratorの各バックグラウンドジョブに対して、処理タイムアウト、失敗時のリトライポリシー（最大試行回数、バックオフ戦略）、Dead Letter Queue（DLQ）への移動条件が未定義。特に週次レポート生成（月曜朝7:00）の長時間処理に対するタイムアウトとリトライの設計が不明確で、処理が途中で中断された際の再開可能性も考慮されていない。
- **検出判定基準**:
  - ○（検出）: バックグラウンドジョブ（NotificationWorker/SyncWorker/ReportGenerator）のタイムアウト、リトライポリシー、またはDLQ設計の欠如を指摘している
  - △（部分検出）: バックグラウンド処理の信頼性や障害リスクに言及しているが、具体的なタイムアウト・リトライ設計の欠如を明示していない
  - ×（未検出）: バックグラウンドジョブの障害回復に関する指摘がない

### P07: ECS Auto Scalingとデータベース接続プールの整合性
- **カテゴリ**: 可用性・冗長性・災害復旧
- **深刻度**: 中
- **該当箇所**: セクション7.3（スケーリング）
- **問題の説明**: ECS Auto ScalingでCPU 70%を閾値としてスケールアウトするが、PostgreSQLの最大接続数やRDSのインスタンスサイズとの整合性が未検討。急激なスケールアウト時にデータベース接続プールが枯渇するリスクがあり、接続プール設定（最大接続数、タイムアウト）とECSタスク数の関係が設計されていない。また、スケールイン時のグレースフルシャットダウン設計も不明確。
- **検出判定基準**:
  - ○（検出）: ECS Auto Scaling時のデータベース接続プール枯渇リスク、または接続数上限との整合性問題を指摘している
  - △（部分検出）: スケーリング時のリソース制約や接続管理に言及しているが、具体的なデータベース接続プール設計の欠如を明示していない
  - ×（未検出）: スケーリングと接続プールの整合性に関する指摘がない

### P08: 監視・アラート設計の具体性
- **カテゴリ**: 監視・アラート設計
- **深刻度**: 中
- **該当箇所**: セクション2.4（CloudWatch, Datadog APM）、セクション7.1（パフォーマンス目標）
- **問題の説明**: CloudWatchとDatadog APMの利用は記載されているが、SLO/SLA定義、監視対象メトリクス（REDメトリクス：リクエストレート・エラー率・レイテンシ）、アラート閾値、エスカレーションルールが未設計。パフォーマンス目標（p95 < 300ms等）は記載されているが、これらに対応する監視設定やSLOベースのアラート戦略が不明確。障害検知後のインシデント対応手順（ランブック、オンコールローテーション）も言及されていない。
- **検出判定基準**:
  - ○（検出）: SLO/SLA定義、REDメトリクス収集、アラート閾値、エスカレーション戦略、またはインシデント対応手順の欠如を指摘している
  - △（部分検出）: 監視・アラートの必要性に言及しているが、具体的なSLO定義や監視設計の欠如を明示していない
  - ×（未検出）: 監視・アラート設計に関する指摘がない

### P09: データベーススキーマ変更の後方互換性
- **カテゴリ**: デプロイ・ロールバック
- **深刻度**: 軽微
- **該当箇所**: セクション6.4（Blue-Green Deployment）
- **問題の説明**: Blue-Green DeploymentによるECS Task Definition更新は記載されているが、データベーススキーマ変更（マイグレーション）の扱いが未定義。新旧タスクが同時に稼働する期間（Greenタスク起動後、Blueタスク削除までの10分間）にスキーマ変更が必要な場合、expand-contract パターン等の後方互換性を保つ戦略が必要だが考慮されていない。
- **検出判定基準**:
  - ○（検出）: Blue-Green Deployment時のデータベーススキーマ変更の後方互換性、またはexpand-contract パターンの必要性を指摘している
  - △（部分検出）: デプロイ時のデータベースマイグレーションリスクに言及しているが、具体的な後方互換性戦略（expand-contract等）を明示していない
  - ×（未検出）: スキーマ変更の後方互換性に関する指摘がない

### P10: ロールバック時のデータ整合性
- **カテゴリ**: デプロイ・ロールバック
- **深刻度**: 軽微
- **該当箇所**: セクション6.4（デプロイメント）、セクション7.4（バックアップ・復旧）
- **問題の説明**: Blue-Green Deploymentでのロールバック計画（Blue環境を10分間保持）は記載されているが、ロールバック時のデータ整合性保証が未設計。新バージョンで作成されたデータ（新しいプロジェクト、タスク、コメント等）が旧バージョンと互換性がない場合の扱いが不明確。また、RPO 1時間/RTO 4時間の定義はあるが、具体的なロールバック手順やデータ復旧手順が記載されていない。
- **検出判定基準**:
  - ○（検出）: ロールバック時のデータ整合性問題、または新バージョンで作成されたデータの旧バージョンとの互換性問題を指摘している
  - △（部分検出）: ロールバック時のリスクに言及しているが、具体的なデータ整合性問題を明示していない
  - ×（未検出）: ロールバック時のデータ整合性に関する指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 可用性・冗長性 | Redis クラスターモードの障害時の影響範囲分析（キャッシュ障害時のフォールバック戦略、データベース負荷への影響） | Redisクラスター障害時のフォールバック戦略やデータベース負荷への影響を指摘 |
| B02 | 可用性・冗長性 | Auth0の障害時の認証・認可の可用性（ログイン不可時の影響範囲、既存セッションの継続性） | Auth0障害時の認証可用性やセッション継続性を指摘 |
| B03 | 障害回復設計 | Elasticsearchの障害時の検索機能のフォールバック（全文検索不可時の代替検索手段、検索機能の部分的な継続性） | Elasticsearch障害時のフォールバック戦略や代替検索手段を指摘 |
| B04 | 監視・アラート | ヘルスチェックエンドポイントの設計詳細（深さ：データベース接続、外部サービス疎通、ディスク容量等の含有）とALBヘルスチェック設定との整合性 | ヘルスチェックの具体的な項目（DB接続、外部サービス疎通等）やALBヘルスチェック設定を指摘 |
| B05 | データ整合性 | SQS Visibility Timeoutと処理タイムアウトの関係、重複メッセージ処理のべき等性設計 | SQS Visibility Timeout設計や重複メッセージのべき等性を指摘 |
