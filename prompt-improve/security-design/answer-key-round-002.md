# 正解キー

## 実行条件
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 10問

---

## 埋め込み問題一覧

### P01: JWTのlocalStorage保存によるXSSリスク
- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **該当箇所**: セクション5「API設計」→「認証・認可方式」（行103）
- **問題の説明**: JWTトークンをlocalStorageに保存する設計は、XSS攻撃が発生した場合にトークンが窃取されるリスクが高い。HttpOnly Cookieなど、JavaScriptからアクセスできない保存先を使用すべき。
- **検出判定基準**:
  - ○（検出）: JWTのlocalStorage保存の危険性を指摘し、HttpOnly Cookieやメモリ保存など代替手段に言及している
  - △（部分検出）: XSSリスクやトークン保管の問題に触れているが、localStorageの具体的なリスクや代替手段に言及していない
  - ×（未検出）: トークン保存に関する指摘がない

### P02: APIアクセス制御の不十分な設計
- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **該当箇所**: セクション5「API設計」→「認証・認可方式」（行104-105）
- **問題の説明**: 加盟店APIのアクセス制御が「ユーザー属性で判定」という曖昧な記述のみで、具体的な認可モデル（RBAC、ABAC等）やチェックポイントが明示されていない。IDOR（Insecure Direct Object Reference）脆弱性のリスクが高い。
- **検出判定基準**:
  - ○（検出）: アクセス制御が不明確であることを指摘し、認可モデルの明示やリソース単位での権限チェックの必要性に言及している
  - △（部分検出）: 認可設計の不足や権限管理の問題に触れているが、具体的にどこが不十分かを指摘していない
  - ×（未検出）: アクセス制御に関する指摘がない

### P03: CSRF対策の欠如
- **カテゴリ**: 入力検証設計
- **深刻度**: 重大
- **該当箇所**: セクション5「API設計」全体（CSRFトークンに関する記述なし）
- **問題の説明**: 決済や送金など重要な状態変更を伴うAPIに対してCSRF対策（CSRFトークン、SameSite Cookie等）が設計書に明記されていない。JWT認証だけではCSRF攻撃を防げない。
- **検出判定基準**:
  - ○（検出）: CSRF対策の欠如を指摘し、CSRFトークンやSameSite Cookie等の具体的な対策に言及している
  - △（部分検出）: 状態変更APIのセキュリティ不足に触れているが、CSRFという具体的な脅威や対策には言及していない
  - ×（未検出）: CSRF対策に関する指摘がない

### P04: 機密データのログ出力リスク
- **カテゴリ**: データ保護
- **深刻度**: 中
- **該当箇所**: セクション6「実装方針」→「ロギング」（行118-121）
- **問題の説明**: 「全APIリクエスト/レスポンスをINFOレベルで記録」という方針は、クレジットカード情報、トークン、個人情報などの機密データがログに含まれるリスクがある。ログ出力のマスキング方針が必要。
- **検出判定基準**:
  - ○（検出）: ログへの機密データ出力リスクを指摘し、マスキングやフィルタリングの必要性に言及している
  - △（部分検出）: ログ管理の問題に触れているが、機密データの具体的なリスクには言及していない
  - ×（未検出）: ログ出力に関するセキュリティ指摘がない

### P05: Refresh Tokenの保存先とローテーション戦略の欠如
- **カテゴリ**: 認証・認可設計
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」→「認証・認可方式」（行102）
- **問題の説明**: Refresh Token（7日間有効）の保存場所や無効化方針、ローテーション戦略が明示されていない。トークン漏洩時の被害拡大や不正利用のリスクがある。
- **検出判定基準**:
  - ○（検出）: Refresh Tokenの保存先やローテーション、無効化の仕組みが不足していることを指摘している
  - △（部分検出）: トークン管理の問題に触れているが、Refresh Token固有のリスクには言及していない
  - ×（未検出）: Refresh Tokenに関する指摘がない

### P06: 外部API障害時のリトライにおける冪等性保証の欠如
- **カテゴリ**: インフラ・依存関係のセキュリティ
- **深刻度**: 中
- **該当箇所**: セクション6「実装方針」→「エラーハンドリング」（行116）
- **問題の説明**: 外部API（Stripe/Plaid）障害時に「リトライ3回」と記載されているが、決済処理のような冪等性が必要な操作で重複実行を防ぐ仕組み（Idempotency Key等）が明示されていない。二重決済のリスクがある。
- **検出判定基準**:
  - ○（検出）: リトライ処理における冪等性保証や重複実行防止の仕組み（Idempotency Key等）の必要性を指摘している
  - △（部分検出）: リトライの問題やトランザクション整合性に触れているが、冪等性の観点には言及していない
  - ×（未検出）: リトライ処理に関するセキュリティ指摘がない

### P07: 監査ログの設計が不明確
- **カテゴリ**: 脅威モデリング（Repudiation対策）
- **深刻度**: 中
- **該当箇所**: セクション3「アーキテクチャ設計」→「データフロー」（行50）、セクション2「データベース」（MongoDB記載があるのみ）
- **問題の説明**: 「非同期で監査ログ書き込み（MongoDB）」という記述のみで、何を記録するか、改ざん防止、保持期間、アクセス制御が明示されていない。金融システムとして監査要件を満たせない可能性がある。
- **検出判定基準**:
  - ○（検出）: 監査ログの記録内容、改ざん防止、保持期間、アクセス制御のいずれかの不足を具体的に指摘している
  - △（部分検出）: ロギングや監査の不足に触れているが、具体的な設計要素には言及していない
  - ×（未検出）: 監査ログに関する指摘がない

### P08: レート制限の具体的な設計が欠如
- **カテゴリ**: インフラ・依存関係のセキュリティ（DoS対策）
- **深刻度**: 中
- **該当箇所**: セクション7「非機能要件」→「セキュリティ要件」（行145）
- **問題の説明**: 「APIには適切なレート制限を設定する」という抽象的な記述のみで、具体的な閾値（エンドポイント別、ユーザー別、IP別）やアルゴリズム（Token Bucket、Sliding Window等）が示されていない。
- **検出判定基準**:
  - ○（検出）: レート制限の具体性不足を指摘し、エンドポイント別の閾値やアルゴリズムの明示を求めている
  - △（部分検出）: DoS対策やレート制限の不足に触れているが、具体的な設計要素には言及していない
  - ×（未検出）: レート制限に関する指摘がない

### P09: 不正検出サービスの設計詳細が不足
- **カテゴリ**: 脅威モデリング（不正取引対策）
- **深刻度**: 軽微
- **該当箇所**: セクション3「アーキテクチャ設計」→「主要コンポーネント」（行46）
- **問題の説明**: FraudDetectionServiceについて「不正検出ルール実行（外部サービス連携も検討）」という曖昧な記述のみ。具体的なルール、トリガー条件、アラート設計がなく、実装段階で後回しにされるリスクがある。
- **検出判定基準**:
  - ○（検出）: 不正検出の設計不足を指摘し、具体的なルールやアラート設計の必要性に言及している
  - △（部分検出）: 不正対策の重要性に触れているが、設計の不足を指摘していない
  - ×（未検出）: 不正検出に関する指摘がない

### P10: KYC書類の保存とアクセス制御の設計が不明確
- **カテゴリ**: データ保護
- **深刻度**: 軽微
- **該当箇所**: セクション2「データベース」（行29）、セクション4「データモデル」→「users」（行56-66）
- **問題の説明**: KYC書類メタデータをMongoDBに保存する旨は記載されているが、実際の書類ファイル（画像等）の保存先、暗号化、アクセス制御が設計書に含まれていない。個人情報保護の観点で設計が不十分。
- **検出判定基準**:
  - ○（検出）: KYC書類の保存先、暗号化、アクセス制御のいずれかの不足を指摘している
  - △（部分検出）: 個人情報保護やデータ保管の問題に触れているが、KYC書類の具体的な扱いには言及していない
  - ×（未検出）: KYC書類に関する指摘がない

---

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | データ保護 | payment_methodsテーブルのprovider_tokenが平文保存されている可能性（暗号化の記載なし） | provider_tokenの暗号化や保護が必要と指摘 |
| B02 | 認証・認可設計 | パスワードリセット、多要素認証（MFA）の設計が欠如 | パスワードリセットやMFAの設計追加を提案 |
| B03 | インフラ・依存関係 | 依存ライブラリの脆弱性スキャン、更新方針が明示されていない | 脆弱性管理や依存ライブラリスキャンの必要性を指摘 |
| B04 | 入力検証設計 | SQLインジェクション、NoSQLインジェクション対策が明示されていない | インジェクション攻撃への対策（パラメータ化クエリ等）の必要性を指摘 |
| B05 | データ保護 | データベースバックアップの暗号化や安全な保管場所が明示されていない | バックアップの暗号化や保管方針を指摘 |
| B06 | 脅威モデリング | セッション固定攻撃、セッションハイジャック対策が明示されていない | セッション管理のセキュリティ対策を指摘 |
| B07 | インフラ・依存関係 | API GatewayやECSのセキュリティグループ、WAF設定が設計書に含まれていない | インフラレベルのセキュリティ設定の必要性を指摘 |
| B08 | 入力検証設計 | QRコードデータの検証・サニタイズが明示されていない | QRコードデータの検証やインジェクションリスクを指摘 |
