# 正解キー

## 実行条件
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: JWTトークンのクライアント保存方式が未定義
- **カテゴリ**: 認証設計
- **深刻度**: 重大
- **該当箇所**: セクション5「API設計」→「認証・認可方式」
- **問題の説明**: JWT発行後のクライアント側での保存方式（localStorage, sessionStorage, httpOnly cookie等）が設計書に記載されていません。localStorageに保存するとXSS攻撃でトークンが窃取されるリスクがあり、セキュアな保存方式の明示が必要です。
- **検出判定基準**:
  - ○（検出）: JWTの保存先としてlocalStorageの危険性、またはhttpOnly cookieの推奨に言及している
  - △（部分検出）: JWT保管のセキュリティに一般的な言及があるが、具体的な保存方式や攻撃ベクトルに触れていない
  - ×（未検出）: JWT保管に関する指摘がない

### P02: パスワードリセットトークンの有効期限が未定義
- **カテゴリ**: 認証設計
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」→「POST /api/v1/auth/reset-password」
- **問題の説明**: パスワードリセット機能でトークンの有効期限が設計書に記載されていません。有効期限が長すぎるとトークンの不正利用リスクが増大します。通常は15-30分程度の短い有効期限を設定すべきです。
- **検出判定基準**:
  - ○（検出）: パスワードリセットトークンの有効期限の欠如、または有効期限設定の必要性を指摘している
  - △（部分検出）: パスワードリセット機能のセキュリティに一般的な言及があるが、有効期限に触れていない
  - ×（未検出）: パスワードリセットトークンに関する指摘がない

### P03: DELETE/PUT APIエンドポイントの認可チェック設計が不明確
- **カテゴリ**: 認可設計
- **深刻度**: 重大
- **該当箇所**: セクション5「API設計」→「DELETE /api/v1/users/account」「DELETE /api/v1/bookings/{id}」「PUT /api/v1/bookings/{id}」
- **問題の説明**: 予約キャンセル・変更、アカウント削除などのstate-changing APIで、リソース所有者のみがアクセスできる認可チェックの設計が記載されていません。他ユーザーの予約を削除・変更できる脆弱性（IDOR: Insecure Direct Object Reference）のリスクがあります。
- **検出判定基準**:
  - ○（検出）: DELETE/PUT APIでのリソース所有者チェックの欠如、またはIDOR脆弱性のリスクを指摘している
  - △（部分検出）: 認可設計の不足を一般的に指摘しているが、DELETE/PUT APIや所有者チェックに具体的に触れていない
  - ×（未検出）: DELETE/PUT APIの認可チェックに関する指摘がない

### P04: 入力検証の設計方針が未定義
- **カテゴリ**: 入力検証設計
- **深刻度**: 中
- **該当箇所**: セクション6「実装方針」
- **問題の説明**: 外部入力（API リクエストパラメータ、JSONボディ、ファイルアップロード等）の検証方針が設計書に記載されていません。特に予約詳細のJSONB型カラム（booking_details）は任意構造のデータを格納可能で、検証が必要です。インジェクション攻撃や不正データの混入リスクがあります。
- **検出判定基準**:
  - ○（検出）: 入力検証方針の欠如、またはJSONBカラムの検証必要性、インジェクション防止策を指摘している
  - △（部分検出）: 入力検証に一般的な言及があるが、具体的な検証方針やJSONBカラムに触れていない
  - ×（未検出）: 入力検証方針に関する指摘がない

### P05: CSRF対策の設計が欠如
- **カテゴリ**: CSRF
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」
- **問題の説明**: state-changing APIエンドポイント（POST/PUT/DELETE）に対するCSRF（Cross-Site Request Forgery）対策の記載がありません。JWT認証のみではCSRF攻撃を防げず、CSRFトークンやSameSite cookie属性の使用などの対策が必要です。
- **検出判定基準**:
  - ○（検出）: CSRF対策の欠如、またはCSRFトークン/SameSite属性の必要性を指摘している
  - △（部分検出）: state-changing APIのセキュリティに言及しているが、CSRF具体的に触れていない
  - ×（未検出）: CSRF対策に関する指摘がない

### P06: Elasticsearchの保存データ暗号化設計が未定義
- **カテゴリ**: データ保護
- **深刻度**: 中
- **該当箇所**: セクション2「技術スタック」→「Search Engine: Elasticsearch 8.10」
- **問題の説明**: Elasticsearchに格納される検索インデックスデータ（ホテル名、航空便情報など）の暗号化設計が記載されていません。OpenSearch Serviceの暗号化機能（at-rest encryption）を有効化する必要があります。
- **検出判定基準**:
  - ○（検出）: Elasticsearch/OpenSearchデータの暗号化設計の欠如、またはat-rest暗号化の必要性を指摘している
  - △（部分検出）: データベース暗号化に一般的な言及があるが、Elasticsearch/OpenSearchに具体的に触れていない
  - ×（未検出）: Elasticsearch暗号化に関する指摘がない

### P07: データベース接続の最小権限原則が未適用
- **カテゴリ**: インフラ・依存関係のセキュリティ
- **深刻度**: 中
- **該当箇所**: セクション3「アーキテクチャ設計」→「主要コンポーネントの責務」
- **問題の説明**: 各サービス（User Service, Booking Service等）がPostgreSQLに接続する際のデータベースユーザー権限設計が記載されていません。すべてのサービスが同一の管理者権限を持つ構成ではなく、各サービスが必要最小限のテーブル・操作権限のみを持つべきです（最小権限原則）。
- **検出判定基準**:
  - ○（検出）: データベース接続の最小権限原則の欠如、またはサービス別の権限分離の必要性を指摘している
  - △（部分検出）: データベースセキュリティに一般的な言及があるが、最小権限原則や権限分離に具体的に触れていない
  - ×（未検出）: データベース権限設計に関する指摘がない

### P08: JWTペイロードの機密情報保護が未設計
- **カテゴリ**: データ保護
- **深刻度**: 軽微
- **該当箇所**: セクション5「API設計」→「認証・認可方式」
- **問題の説明**: JWTペイロードに含める情報の設計方針が記載されていません。JWTはBase64エンコードされるだけで暗号化されないため、機密情報（メールアドレス、個人情報等）をペイロードに含めるべきではありません。
- **検出判定基準**:
  - ○（検出）: JWTペイロードの機密情報保護の欠如、またはJWTの非暗号化特性と機密情報除外の必要性を指摘している
  - △（部分検出）: JWTのセキュリティに言及しているが、ペイロード内容や機密情報保護に具体的に触れていない
  - ×（未検出）: JWTペイロード設計に関する指摘がない

### P09: ログ出力における個人情報・機密情報のマスキング方針が未定義
- **カテゴリ**: データ保護
- **深刻度**: 軽微
- **該当箇所**: セクション6「実装方針」→「ロギング方針」
- **問題の説明**: ロギング方針でJSON構造化ログを採用していますが、個人情報（氏名、電話番号、パスポート番号等）や機密情報（APIキー等）をログに出力する際のマスキング・除外方針が記載されていません。ログが外部に漏洩した場合のプライバシーリスクがあります。
- **検出判定基準**:
  - ○（検出）: ログ出力時の個人情報・機密情報のマスキング方針の欠如、またはログ漏洩時のプライバシーリスクを指摘している
  - △（部分検出）: ログのセキュリティに一般的な言及があるが、マスキング方針や個人情報保護に具体的に触れていない
  - ×（未検出）: ログ出力のマスキング方針に関する指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 認証設計 | MFA（多要素認証）の設計が欠如 | 管理者アカウントや高額決済にMFAが必要と指摘 |
| B02 | レート制限 | API Gatewayのレート制限が粗い（100req/min）で、エンドポイント別のきめ細かい制限がない | ログイン・決済など特定エンドポイントの厳格なレート制限を指摘 |
| B03 | 監査ログ | 重要操作（決済、アカウント削除、管理者操作）の監査ログ設計が欠如 | 監査ログの必要性を指摘 |
| B04 | セッション管理 | セッション無効化の設計が不明確（ログアウト時のRedis削除は記載あるが、タイムアウト設計等が未記載） | セッションタイムアウトやデバイス別セッション管理を指摘 |
| B05 | データ保護 | RDS/ElastiCacheの通信暗号化（TLS）設計が未記載 | データベース通信の暗号化を指摘 |
| B06 | 依存関係 | ライブラリの脆弱性スキャン・更新方針が未記載 | 定期的な脆弱性スキャンやDependabot等のツール使用を指摘 |
| B07 | データ保護 | Stripe決済時のPCI DSS準拠方針が未記載 | PCI DSSコンプライアンスの必要性を指摘 |
| B08 | 入力検証設計 | ファイルアップロード機能の有無とセキュリティ対策が不明確 | ファイルアップロードのサイズ制限・種類検証を指摘 |
