# セキュリティレビュー結果: SmartHome IoTデバイス管理プラットフォーム

## Step 1: 全体構造の把握

### システムの主要コンポーネントとその責務
- **API Server (ECS)**: REST API提供（ユーザー認証、デバイス管理、データ取得）
- **MQTT Broker (ECS)**: IoTデバイスとの双方向通信
- **Device Gateway Service**: デバイス認証、コマンド検証、データ正規化
- **OTA Update Service**: ファームウェア配信管理
- **PostgreSQL**: ユーザー、デバイス登録情報、アクセス権管理
- **InfluxDB**: センサーデータの時系列蓄積
- **Redis**: セッション、リフレッシュトークン、リアルタイムステータスのキャッシュ
- **S3**: ファームウェアイメージの保存

### データフロー
1. モバイルアプリ → ALB → API Server（HTTPS）
2. API Server → Redis → MQTT Broker（制御コマンド伝達）
3. MQTT Broker → IoTデバイス（MQTT/TLS）
4. IoTデバイス → Device Gateway Service（状態変更の検証・記録）
5. Device Gateway Service → モバイルアプリ（Socket.IO経由のリアルタイム通知）

### 認証・認可のフロー
- **ユーザー認証**: JWT（アクセストークン15分、リフレッシュトークン7日間）
- **デバイス認証**: デバイスごとの一意な`device_key`をクライアントIDとして使用
- **APIアクセス制御**: ユーザーAPIはJWT、デバイスAPIは`device_key`、権限レベル（owner/write/read）による判定

### 外部システムとの統合ポイント
- デバイスメーカー: REST API経由でデバイス登録（`POST /api/devices`）
- IoTデバイス: MQTT/TLS経由で接続、OTA更新確認API（`GET /api/ota/check`）

### インフラ構成
- AWS ECS Fargate（コンテナ実行）
- ALB（ロードバランサ）
- S3（ファームウェアストレージ）
- PostgreSQL、InfluxDB、Redis（データ層）

---

## Step 2: セキュリティ問題の検出

### スコアサマリ

| 観点 | スコア (1-5) | 主な理由 |
|-----|-------------|---------|
| 脅威モデリング（STRIDE） | 2 | デバイスなりすまし、コマンドインジェクション、リプレイ攻撃、DoS攻撃への対策が未設計 |
| 認証・認可設計 | 3 | JWT保存先・取り消し機構が未定義、リフレッシュトークンローテーション未実装、デバイス認証が単一キーのみ |
| データ保護 | 2 | 転送時暗号化のみ定義、保存時暗号化・PIIデータ保護・データ削除方針が未設計 |
| 入力検証設計 | 2 | デバイスコマンドの検証方針が不明確、インジェクション対策・ファイル検証が未設計 |
| インフラ・依存関係 | 3 | 依存関係の脆弱性管理・シークレット管理・ネットワーク分離が未設計 |
| **総合** | **2.4** | |

---

## 1. 重大な問題（設計の修正が必須）

### 1.1 JWTトークンの保存方式と取り消し機構が未定義

**問題の説明**:
設計書にJWTの発行（15分有効期限、7日間のリフレッシュトークン）は記載されているが、**モバイルアプリでのJWTの保存方式**および**トークン取り消し機構**が設計されていない。

**影響**:
- JWTをモバイルアプリのローカルストレージや非暗号化領域に保存すると、デバイス紛失時やマルウェア感染時にトークンが窃取され、15分間の不正アクセスが可能
- リフレッシュトークンの取り消し機構がない場合、ユーザーが「すべてのデバイスからログアウト」を実行しても、窃取されたリフレッシュトークン（7日間有効）で再認証が継続可能

**推奨対策**:
1. **モバイルアプリのトークン保存**: iOS Keychain / Android Keystore を使用した暗号化保存を設計書に明記
2. **リフレッシュトークン取り消し**: Redisにリフレッシュトークンをホワイトリストとして保存し、`/api/auth/logout`および`/api/auth/logout-all`エンドポイントで該当トークンを削除する設計を追加
3. **セッション管理API**: ユーザーがアクティブなセッション一覧を確認し、個別に無効化できる`GET /api/auth/sessions`および`DELETE /api/auth/sessions/:id`を設計

**該当箇所**: セクション5 API設計 > 認証・認可方式

---

### 1.2 デバイス認証の脆弱性: 単一キー方式とローテーション機構の欠如

**問題の説明**:
デバイス認証が`device_key`の単一静的キーのみで、キーのローテーション機構やMQTT接続時の追加認証（証明書ベースなど）が設計されていない。

**影響**:
- `device_key`が漏洩した場合（通信傍受、デバイス解析、ログ誤出力など）、攻撃者はそのデバイスになりすまして無期限に不正コマンドを送信可能
- なりすましデバイスから大量のテレメトリデータを送信してInfluxDBを枯渇させるDoS攻撃が可能
- 複数デバイスの`device_key`を窃取後、オーナーユーザーのデバイス一覧を列挙して家の不在状態を推測するプライバシー侵害が可能

**推奨対策**:
1. **証明書ベースのMQTT認証**: デバイスごとにX.509クライアント証明書を発行し、MQTT Broker側でmTLS認証を実装。`device_key`は補助的な識別子に変更
2. **デバイスキーのローテーション**: 90日ごとの自動ローテーションAPI（`POST /api/devices/:id/rotate-key`）を設計。旧キーは7日間の猶予期間後に無効化
3. **チャレンジレスポンス認証**: MQTT接続時に初回ハンドシェイクでサーバー生成のnonceに対する署名を要求し、リプレイ攻撃を防止
4. **デバイスレジストリのアクセスログ**: `device_access`テーブルに接続元IPアドレスと接続時刻を記録し、異常検知の基盤を構築

**該当箇所**: セクション5 API設計 > 認証・認可方式 > デバイス認証

---

### 1.3 デバイスコマンドのインジェクション攻撃と検証不足

**問題の説明**:
デバイス制御コマンド（`POST /api/devices/:id/command`）のリクエスト検証が`joi`でのスキーマ検証のみと記載され、**コマンド種別ごとのホワイトリスト検証**および**パラメータのサニタイゼーション**が設計されていない。

**影響**:
- 攻撃者が未定義のコマンド（`{"command": "execute_shell", "params": {"script": "rm -rf /"}}`）を送信し、Device Gateway Serviceやデバイス側で任意コード実行が発生する可能性
- パラメータのバリデーション不足により、照明の明る度を`{"brightness": -999999}`や`{"brightness": "'; DROP TABLE devices;--"}`に設定してシステムクラッシュやSQLインジェクションを誘発
- ファームウェアの脆弱性を突くペイロードを`params`に含めたコマンドを送信し、デバイスの制御権を乗っ取り

**推奨対策**:
1. **コマンドホワイトリスト**: デバイスタイプごとに許可コマンドを定義（例: `type=light`なら`set_brightness`, `set_color`のみ）し、データベースまたは設定ファイルで管理
2. **パラメータの厳密な検証**:
   - `set_brightness`コマンドの`brightness`は0〜100の整数のみ許可
   - `set_schedule`コマンドの時刻は`HH:MM`形式のみ許可（正規表現: `^([01]\d|2[0-3]):[0-5]\d$`）
3. **コマンドレート制限**: 同一デバイスに対して1秒間に10コマンドまでに制限し、DoS攻撃を防止
4. **コマンド実行ログの記録**: PostgreSQLに`command_audit`テーブルを追加し、誰がいつどのコマンドを送信したかを記録（不正検知とフォレンジックに活用）

**該当箇所**: セクション5 API設計 > リクエスト/レスポンス形式 > デバイス制御コマンド送信

---

### 1.4 OTAファームウェア更新の改ざん・中間者攻撃リスク

**問題の説明**:
設計書に「ファームウェア更新パッケージの署名検証」が非機能要件として記載されているが、**誰が署名を生成し、どこで検証するのか**の具体的な設計が欠如している。

**影響**:
- 攻撃者がS3へのアクセス権を取得（設定ミス、IAM認証情報の漏洩など）して悪意のあるファームウェアをアップロードし、デバイスに配信してバックドアを仕込む
- HTTPS通信が適切に実装されていない場合、中間者攻撃（MITM）によりファームウェアダウンロード中に改ざんされたバイナリを注入
- デバイスが署名検証をスキップする実装になっている場合、全てのデバイスがマルウェア感染

**推奨対策**:
1. **ファームウェア署名の生成と検証フロー**:
   - 管理者が`POST /api/ota/updates`でファームウェアをアップロード時、OTA Update Serviceが秘密鍵（AWS KMSで管理）でSHA-256ハッシュに署名を生成し、署名を`ota_updates`テーブルの`signature`カラムに保存
   - `GET /api/ota/check`のレスポンスに署名を含める: `{"version": "2.0.1", "url": "https://...", "signature": "base64-encoded-signature"}`
   - デバイスが公開鍵（ファームウェアにハードコード）で署名を検証し、検証失敗時は更新を中止
2. **S3署名付きURL**: `s3_url`カラムに直接URLを保存するのではなく、`GET /api/ota/check`実行時に15分間有効な署名付きURLを動的生成し、不正なダウンロードを防止
3. **ロールバック機能**: デバイスが更新後に異常を検知した場合、前バージョンに自動復帰する設計を追加（`ota_updates`テーブルに`rollback_version`カラムを追加）

**該当箇所**: セクション7 非機能要件 > セキュリティ要件、セクション4 データモデル > ota_updatesテーブル

---

### 1.5 保存時データの暗号化とPIIデータ保護が未設計

**問題の説明**:
設計書に転送時のTLS暗号化のみ記載され、**データベース（PostgreSQL、InfluxDB）およびRedisの保存時暗号化**が設計されていない。また、PIIデータ（メールアドレス、デバイス設置場所など）の保護方針が未定義。

**影響**:
- データベースのバックアップファイルやスナップショットが漏洩した場合、全ユーザーのメールアドレス、パスワードハッシュ、デバイス認証キーが平文で露出
- 元従業員や侵害されたAWSアカウントからRDS/InfluxDBに直接アクセスされた場合、センサーデータ（温度、カメラ映像のメタデータ）から生活パターンを推測され、プライバシー侵害と物理的な窃盗リスクが発生
- GDPR/CCPA等のデータ保護規制に違反し、多額の罰金が課される可能性

**推奨対策**:
1. **RDS保存時暗号化**: PostgreSQLのRDS暗号化オプション（AWS KMS）を有効化し、設計書に明記
2. **Redis暗号化**: ElastiCache for Redisの保存時暗号化（At-Rest Encryption）および転送時暗号化（TLS）を有効化
3. **InfluxDB暗号化**: InfluxDB Enterpriseの暗号化機能を使用、またはEBSボリュームレベルでの暗号化を設計
4. **PIIデータのフィールドレベル暗号化**:
   - `users.email`をアプリケーションレベルでAES-256-GCMで暗号化し、検索用にハッシュ値を別カラム（`email_hash`）に保存
   - 暗号化キーはAWS KMSで管理し、API Server起動時にキャッシュ
5. **データ保持・削除方針**: GDPR準拠のため、ユーザーアカウント削除時に30日以内にセンサーデータを含む全関連データを削除する設計を追加（`DELETE /api/users/me`エンドポイント）

**該当箇所**: セクション7 非機能要件 > セキュリティ要件、セクション2 技術スタック > データベース

---

### 1.6 MQTT Brokerへの認証なしアクセスとDoS攻撃リスク

**問題の説明**:
MQTT Brokerへの接続が`device_key`のみで認証され、**接続レート制限**および**メッセージサイズ制限**が設計されていない。また、MQTT Brokerと他コンポーネント間の通信の認証・暗号化が未定義。

**影響**:
- 攻撃者が10万個の偽デバイス接続を同時に開始し、MQTT Brokerのリソース（メモリ、ファイルディスクリプタ）を枯渇させてサービス停止
- 単一デバイスから1秒間に10万メッセージを送信し、Device Gateway ServiceやInfluxDBを過負荷状態にしてシステム全体がダウン
- 1GB以上の巨大ペイロードを含むMQTTメッセージを送信し、メモリ溢れによるクラッシュを誘発

**推奨対策**:
1. **接続レート制限**: 同一IPアドレスから1分間に100接続までに制限（MQTT Brokerレベルで実装）
2. **メッセージサイズ制限**: MQTTメッセージのペイロードを最大1MBに制限（設定: `max_packet_size`）
3. **メッセージレート制限**: 単一デバイスから1秒間に10メッセージまでに制限し、超過した場合は一時的に接続を切断
4. **内部通信の認証**: MQTT Broker ↔ Device Gateway Service間の通信を内部VPCに分離し、mTLS認証を実装
5. **MQTT ACL（Access Control List）**: デバイスごとにサブスクライブ/パブリッシュ可能なトピックを制限（例: デバイスAは`devices/deviceA/commands`のみサブスクライブ可能）

**該当箇所**: セクション3 アーキテクチャ設計 > 主要コンポーネント > MQTT Broker

---

## 2. 改善提案（設計の品質向上に有効）

### 2.1 リフレッシュトークンのローテーション機構

**提案の説明**:
現在の設計では7日間有効なリフレッシュトークンが発行されるが、**トークンリフレッシュ時に新しいリフレッシュトークンを発行して旧トークンを無効化するローテーション機構**が未設計。

**理由**:
リフレッシュトークンが窃取された場合、攻撃者と正規ユーザーが同じトークンを7日間使い続けることが可能になり、検知が困難。ローテーション機構を実装すると、トークンの再利用を検知して即座にセッションを無効化できる。

**推奨対策**:
1. `POST /api/auth/refresh`実行時に新しいリフレッシュトークンを生成し、レスポンスに含める
2. 旧リフレッシュトークンをRedisから削除（または`revoked`フラグを設定）
3. 既に無効化されたトークンで再度リフレッシュが試行された場合、セキュリティ侵害と判断して該当ユーザーの全セッションを無効化し、メール通知を送信

---

### 2.2 管理者APIへのブルートフォース対策とアカウントロック

**提案の説明**:
設計書にAPIレート制限（100リクエスト/分/IP）が記載されているが、**ログインエンドポイント（`POST /api/auth/login`）への特化した対策**が未設計。

**理由**:
100リクエスト/分の制限では、攻撃者が60種類のパスワードを試行可能であり、弱いパスワードを使用するユーザーのアカウントが侵害される。特にデバイスメーカー向けの管理者アカウントが狙われた場合、全デバイスへの不正アクセスが可能。

**推奨対策**:
1. ログインエンドポイントに5回/15分のレート制限を追加（IPベース）
2. 5回の失敗後、該当アカウントを30分間ロック
3. CAPTCHA（hCaptcha）を3回失敗後に導入
4. ログイン失敗時のログに`attempt_count`を記録し、異常検知システムで監視

---

### 2.3 センサーデータのアクセス権検証と時系列データの改ざん防止

**提案の説明**:
`GET /api/devices/:id/telemetry`でセンサーデータを取得する際、**ユーザーがそのデバイスへのアクセス権を持つかの検証**が設計書に明記されていない。また、InfluxDBへの直接書き込みによるデータ改ざんのリスクが未対策。

**理由**:
アクセス権検証がない場合、攻撃者が他人のデバイスIDをブルートフォースで推測し、カメラの動き検知履歴や温度データから不在時間を特定してプライバシー侵害や物理的侵入が可能。

**推奨対策**:
1. `GET /api/devices/:id/telemetry`実行時、`device_access`テーブルを参照して`user_id`が該当デバイスの`read`権限以上を持つことを検証
2. InfluxDBへの書き込みをDevice Gateway Serviceのみに制限（ネットワークACLで他サービスからのアクセスを遮断）
3. センサーデータに署名（HMAC-SHA256）を付与し、データ改ざんを検知可能にする設計を検討

---

### 2.4 依存関係の脆弱性スキャンと自動更新パイプライン

**提案の説明**:
設計書に主要ライブラリ（`jsonwebtoken`, `joi`, `mqtt`等）のバージョンは記載されているが、**脆弱性スキャンと自動更新の運用プロセス**が未設計。

**理由**:
Node.jsエコシステムは脆弱性の発見頻度が高く、放置すると既知の脆弱性（例: `jsonwebtoken`の署名検証バイパス）を突かれてシステム全体が侵害される。

**推奨対策**:
1. CI/CDパイプラインに`npm audit`を統合し、HighまたはCritical脆弱性が検出された場合はビルドを失敗させる
2. Dependabot（GitHub）またはRenovate Botで依存関係の自動更新PRを週次で生成
3. プロダクション環境で使用するライブラリのバージョンを`package-lock.json`で固定し、手動レビュー後に更新

---

### 2.5 S3バケットのアクセス制御とパブリック公開の防止

**提案の説明**:
ファームウェアイメージを保存するS3バケットのアクセスポリシーが設計書に記載されていない。

**理由**:
S3バケットが誤ってパブリック公開された場合、攻撃者がファームウェアバイナリをダウンロードして脆弱性を解析し、リバースエンジニアリングでデバイス認証キーの抽出やゼロデイ脆弱性の発見が可能。

**推奨対策**:
1. S3バケットのパブリックアクセスをブロック（`BlockPublicAcls`, `BlockPublicPolicy`を有効化）
2. OTA Update ServiceのIAMロールのみに`s3:PutObject`, `s3:GetObject`権限を付与
3. デバイスがファームウェアをダウンロードする際は、署名付きURL（15分有効期限）を使用
4. S3バケットのアクセスログを有効化し、CloudWatch Logsで監視

---

### 2.6 Socket.IOのリアルタイム通信の認証と認可

**提案の説明**:
設計書にSocket.IO経由でリアルタイム通知を送信すると記載されているが、**Socket.IO接続時の認証とチャネルごとの認可**が未設計。

**理由**:
Socket.IO接続が認証なしで可能な場合、攻撃者が任意のデバイスIDのチャネルを購読し、他人のデバイス状態変更をリアルタイムで監視してプライバシー侵害が発生。

**推奨対策**:
1. Socket.IO接続時にJWTトークンを送信し、サーバー側で検証（`socket.handshake.auth.token`）
2. クライアントが`devices/:deviceId/status`チャネルを購読する際、`device_access`テーブルでアクセス権を検証
3. 権限がないチャネルへの購読試行を検知し、接続を切断してログに記録

---

## 3. 確認事項（ユーザーへの確認が必要）

### 3.1 パスワードポリシーの厳格化レベル

**確認理由**:
現在の設計では`bcrypt`によるハッシュ化のみ記載され、パスワードの最小要件（長さ、複雑度）が未定義。

**選択肢とトレードオフ**:
- **オプションA（緩い）**: 8文字以上、制約なし → ユーザビリティ高、セキュリティ低
- **オプションB（中程度）**: 10文字以上、英数字を含む → バランス型
- **オプションC（厳格）**: 12文字以上、英数字+記号必須、辞書単語の禁止 → セキュリティ高、パスワードマネージャー推奨が必要

IoTシステムの性質上、侵害時の物理的リスク（家の鍵の遠隔解除など）があるため、オプションBまたはCの採用を推奨。

---

### 3.2 デバイスアクティビティログの保持期間とストレージコスト

**確認理由**:
センサーデータをInfluxDBに蓄積すると記載されているが、**データ保持期間**（例: 30日、1年、無期限）が未定義。長期保持はストレージコストとプライバシーリスクを増大させる。

**選択肢とトレードオフ**:
- **30日保持**: 直近の分析には十分、コスト低、プライバシーリスク低
- **1年保持**: 季節変動の分析が可能、コスト中、GDPR準拠には削除リクエスト対応が必要
- **無期限保持**: 機械学習やトレンド分析に有用、コスト高、規制違反リスク高

GDPR/CCPAへの準拠を考慮し、30日または1年保持+ユーザーによる削除リクエスト機能の実装を推奨。

---

### 3.3 多要素認証（MFA）の導入範囲

**確認理由**:
設計書にMFAの記載がなく、パスワードのみでアカウントにアクセス可能。デバイスメーカーの管理者アカウントや、ドアロック制御権限を持つユーザーには追加の保護が必要。

**選択肢とトレードオフ**:
- **全ユーザーに必須**: セキュリティ最大、ユーザビリティ低、離脱率上昇の懸念
- **オプトイン（推奨）**: セキュリティ中、ユーザビリティ高、セキュリティ意識の高いユーザーのみが有効化
- **管理者とカメラ/ドアロック所有者のみ必須**: バランス型

TOTP（Google Authenticator）またはSMS OTPを使用したMFAを、少なくとも管理者向けに設計することを推奨。

---

## 4. 評価（良い点）

### 4.1 短命なアクセストークンとリフレッシュトークン分離

アクセストークンの有効期限を15分に設定し、7日間有効なリフレッシュトークンと分離した設計は、トークン窃取時の被害期間を最小化する点で適切。リフレッシュトークンをRedisに保存することで取り消しが可能な点も評価できる（取り消しAPIの追加設計が必要だが、基盤は整っている）。

### 4.2 TLS 1.2以上による転送時暗号化の徹底

全ての通信（HTTPS、MQTT/TLS）でTLS 1.2以上を使用する設計は、中間者攻撃とデータ盗聴を防止する基本的だが重要な対策。特にIoTデバイスとの通信においてTLSを必須とした点は評価できる。

### 4.3 bcryptによるパスワードハッシュ化（コストファクタ10）

パスワードをbcryptでハッシュ化し、コストファクタ10を設定している点は、レインボーテーブル攻撃やブルートフォース攻撃への耐性を高める適切な選択。現代のセキュリティ標準に準拠している。

### 4.4 権限レベルによるアクセス制御（owner/write/read）

`device_access`テーブルで権限レベル（owner/write/read）を管理し、家族メンバーに限定的なアクセス権を付与できる設計は、最小権限の原則に沿っている。この基盤を活用して、各APIエンドポイントで細かい権限チェックを実装することが期待される。

### 4.5 構造化ログとリクエストIDによる監査可能性

構造化ログ（JSON形式）に`X-Request-ID`、ユーザーID、デバイスID、エラー詳細を記録する設計は、セキュリティインシデント発生時のフォレンジック分析とトレーサビリティを向上させる。この設計をベースに、コマンド実行ログやログイン失敗ログを追加することで、より強固な監査基盤が構築可能。
