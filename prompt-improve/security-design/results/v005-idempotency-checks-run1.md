# セキュリティ設計レビュー結果

## 評価対象
オンライン診療予約・電子カルテ統合プラットフォーム システム設計書

## スコアサマリー

| Criterion | Score (1-5) | Main Reason |
|-----------|-------------|-------------|
| Threat Modeling (STRIDE) | 3 | Tampering and Repudiation threats are not adequately addressed in the design |
| Authentication & Authorization Design | 3 | JWT token stored without HttpOnly protection and 24-hour expiration is too long |
| Data Protection | 4 | AES-256 encryption is implemented but key management strategy is not specified |
| Input Validation Design | 2 | No input validation strategy or injection prevention measures are documented |
| Infrastructure & Dependencies | 3 | Third-party library versions are specified but vulnerability management process is missing |
| State Management & Idempotency | 2 | No idempotency design for critical state-changing operations like appointments and payments |
| Error Handling & Information Disclosure | 2 | Error response format may expose internal system details and database schema information |
| **Overall** | **2.7** | |

---

## 1. Critical Issues (design modification required)

### 1.1 予約APIに冪等性保証がない

- **問題**: `POST /api/v1/appointments` (予約作成) および `DELETE /api/v1/appointments/{id}` (予約キャンセル) に冪等性設計が存在しない
- **影響**: ネットワーク障害やクライアントのリトライにより、重複予約や二重キャンセルが発生する可能性がある。医療機関の予約枠が不正確になり、診療業務に重大な支障をきたす
- **推奨対策**:
  - 予約作成APIに `Idempotency-Key` ヘッダー（クライアント生成UUID）を必須化
  - Redisに処理済みキーを24時間保持し、重複リクエストには同一レスポンスを返却
  - 予約キャンセルは既にキャンセル済みの場合でも200 OKを返し、冪等性を保証
- **関連箇所**: セクション5 API設計 - 予約エンドポイント

### 1.2 医療費支払いAPIに冪等性・重複決済防止がない

- **問題**: 設計書に医療費支払い機能（クレジットカード/銀行振込）が記載されているが、決済APIの冪等性設計が完全に欠落している
- **影響**: ネットワークタイムアウト後のリトライにより重複決済が発生し、患者への過剰請求、返金対応コスト、信頼失墜を招く。医療費という金銭が関わるため、法的リスクも高い
- **推奨対策**:
  - 決済APIに `Idempotency-Key` ヘッダーを必須化（24文字以上のランダム文字列）
  - 処理済みキーと決済結果をRedisに24時間保存（TTL: 86400秒）
  - 重複キーの場合は元のレスポンスをキャッシュから返却（新規決済処理を実行しない）
  - 決済トランザクションIDとIdempotency-Keyの対応をDBに永続化（監査証跡）
- **関連箇所**: セクション1 概要 - 主要機能の一覧（患者向け機能）

### 1.3 エラーレスポンスが内部実装の詳細を露出

- **問題**: エラーレスポンス形式に `"error": "INVALID_REQUEST"` のようなエラーコードのみが定義されているが、5xx系エラー時に内部情報（スタックトレース、SQLクエリ、ファイルパス、ライブラリバージョン）を露出する可能性が明示的に排除されていない
- **影響**: 攻撃者が偵察情報（Spring Bootバージョン、PostgreSQLスキーマ、ディレクトリ構造）を収集し、既知脆弱性を悪用した標的型攻撃を実行できる
- **推奨対策**:
  - 5xx系エラーのクライアントレスポンスは汎用メッセージのみ（例: `"message": "An internal error occurred. Please contact support with error ID: ERR-20260210-1234"`）
  - スタックトレース、SQL、内部パスは CloudWatch Logs にのみ記録（クライアントには返さない）
  - エラーID（タイムスタンプ+UUID）をレスポンスに含め、サポート問い合わせ時の相関用に使用
  - Spring Boot のデフォルト設定 `server.error.include-stacktrace=never` および `server.error.include-message=never` を明示的に設定
- **関連箇所**: セクション6 実装方針 - エラーハンドリング方針

### 1.4 JWT認証に複数の脆弱性

- **問題**:
  1. JWTトークンの保存場所が明記されていない（localStorage使用のリスク）
  2. 有効期限24時間は漏洩時の被害期間が長すぎる
  3. トークン取り消しメカニズムが存在しない
- **影響**: XSS攻撃によるトークン窃取、トークン漏洩後24時間の不正アクセス継続、ログアウト後もトークンが有効なままとなる
- **推奨対策**:
  - トークンは HttpOnly + Secure + SameSite=Strict 属性のCookieで保存（XSS対策）
  - アクセストークンの有効期限を15分に短縮
  - リフレッシュトークン（7日間有効）を導入し、アクセストークン更新時にリフレッシュトークンもローテーション
  - ログアウト時やパスワード変更時にトークンを無効化する仕組み（Redisブラックリスト）を実装
- **関連箇所**: セクション3 アーキテクチャ設計 - データフロー、セクション5 API設計 - 認証・認可方式

---

## 2. Improvement Suggestions (effective for improving design quality)

### 2.1 入力バリデーション戦略が未定義

- **提案**: 外部入力（患者登録情報、問診票、カルテ内容）の検証ポリシー、SQLインジェクション防止措置、ファイルアップロード制限が設計書に記載されていない
- **根拠**: 医療システムは個人情報を大量に扱うため、入力検証の不備は SQLインジェクション、XSS、任意ファイルアップロードによる情報漏洩につながる
- **推奨対策**:
  - Bean Validation（Jakarta Validation 3.0）で全APIリクエストを検証（@NotNull, @Email, @Size, @Pattern）
  - SQLインジェクション対策としてJPA Criteria APIまたはPreparedStatementを使用（生SQLの禁止）
  - 医療画像・検査結果PDFのアップロードにはファイル形式ホワイトリスト（image/jpeg, image/png, application/pdf）、最大サイズ10MB、ウイルススキャン（ClamAV）を設定
  - HTMLコンテンツ出力時は OWASP Java Encoder でエスケープ処理

### 2.2 認可チェックが不十分

- **提案**: 「患者は自身の情報のみアクセス可能」とあるが、実装レベルの認可ロジック（リソースレベルの所有権検証）が設計されていない
- **根拠**: JWT内のロール確認だけでは、患者Aが患者Bの電子カルテURLを直接叩くことで他人の医療情報にアクセスできる脆弱性（IDOR: Insecure Direct Object Reference）が発生する
- **推奨対策**:
  - `GET /api/v1/medical-records/{id}` では、JWT内のpatient_idと該当カルテのpatient_idを照合
  - Spring Securityの `@PreAuthorize` アノテーションで所有権検証を実装（例: `@PreAuthorize("@securityService.canAccessMedicalRecord(#id, authentication)")`）
  - 医師が他院患者のカルテにアクセスする際は `is_shared=TRUE` かつ診療連携契約の確認を必須化

### 2.3 APIレート制限が全エンドポイント一律

- **提案**: 「1分間に60リクエスト/ユーザー」が全エンドポイントに一律適用されているが、認証エンドポイント、予約作成、決済APIなど高リスクエンドポイントには個別制限が必要
- **根拠**: ログインAPIへのブルートフォース攻撃、予約枠の買い占め、決済APIの悪用に対する防御が不十分
- **推奨対策**:
  - `/api/v1/auth/login`: 5回/15分（IP単位）+ アカウント5回失敗で30分ロック
  - `/api/v1/appointments`: 10回/時間（患者単位）
  - 決済API: 3回/時間（患者単位）
  - Redisベースのレート制限ライブラリ（Bucket4j 8.x）でエンドポイント別に設定

### 2.4 診療情報共有の認可設計が曖昧

- **提案**: `is_shared` フラグのみで他院共有を制御しているが、どの医療機関が共有可能か、患者の同意管理、共有ログの記録が不明
- **根拠**: 医療情報の無断共有は個人情報保護法・医療法違反となり、患者の信頼を失墜させる
- **推奨対策**:
  - `medical_record_shares` テーブルを追加（共有元clinic_id、共有先clinic_id、患者同意日時、有効期限）
  - 患者が共有先医療機関を明示的に選択・承認するUIフローを設計
  - 他院アクセス時は共有テーブルを確認し、患者同意がない場合は403 Forbiddenを返却
  - 共有アクセスログ（誰がいつどのカルテにアクセスしたか）を監査証跡として記録

### 2.5 データベース暗号化の鍵管理が未定義

- **提案**: 「DB内の機密情報をAES-256で暗号化」とあるが、暗号化キーの保管場所、ローテーション方針、アクセス制御が設計されていない
- **根拠**: キーをアプリケーションコードやS3に平文保存すると、暗号化が無意味化する
- **推奨対策**:
  - AWS KMS（Key Management Service）でマスターキーを管理
  - アプリケーションはKMS APIでデータキーを生成し、使用後は破棄（Envelope Encryption）
  - キーローテーション: 年1回自動実施、侵害検知時は即座に手動ローテーション
  - KMSアクセスはIAMロールで制限（本番環境のECSタスクロールのみ許可）

### 2.6 セッション管理の設計が不明確

- **提案**: Redisがセッション管理に使用されているが、セッションタイムアウト、同時ログイン制限、ログアウト時のセッション破棄が明記されていない
- **根拠**: 無期限セッションや放置されたセッションは、共用端末での情報漏洩リスクを高める
- **推奨対策**:
  - セッションアイドルタイムアウト: 30分（医療従事者）、15分（患者）
  - 絶対タイムアウト: 8時間（再認証を要求）
  - 同一アカウントの同時ログイン: 最大3セッションまで許可、4セッション目は最古をログアウト
  - ログアウト時は Redis からセッションキーを削除

### 2.7 依存ライブラリの脆弱性管理プロセスが欠如

- **提案**: Spring Boot 3.2、jjwt 0.11などバージョンは明記されているが、脆弱性スキャンやアップデート方針が設計されていない
- **根拠**: 2024年にSpring Frameworkで複数のRCE脆弱性が報告されており、定期的なパッチ適用が必須
- **推奨対策**:
  - OWASP Dependency-Check または Snyk を CI/CD パイプラインに統合
  - CVSSスコア7.0以上の脆弱性検出時は24時間以内にパッチ適用
  - 四半期ごとに依存ライブラリのアップデート計画を実施
  - 脆弱性情報は GitHub Security Advisories を購読

### 2.8 WAF設定が未定義

- **提案**: CloudFront + WAF が構成図に記載されているが、WAFルールセット（SQLインジェクション検知、XSS検知、地理的制限）が設計されていない
- **根拠**: WAFを導入しても適切なルールがなければ攻撃を防げない
- **推奨対策**:
  - AWS WAF Managed Rules の以下を有効化:
    - Core rule set (共通脆弱性対策)
    - Known bad inputs (既知の悪意あるパターン)
    - SQL database (SQLインジェクション検知)
  - 日本国外からのアクセスを地理的ブロック（医療機関・患者が国内限定の場合）
  - レート制限ルール: 1IP あたり 2000 req/5分

### 2.9 ログに機密情報が記録される可能性

- **提案**: 「APIリクエスト/レスポンス」をINFOレベルでログ出力すると、パスワード、JWT、診療内容などの機密情報がCloudWatch Logsに平文記録される
- **根拠**: ログへのアクセス権を持つ運用スタッフや侵害者が機密情報を取得できる
- **推奨対策**:
  - リクエストログではパスワード、トークン、カルテ内容をマスキング（`***` に置換）
  - Logbackの `<encoder>` で機密フィールドを検出・マスキングするカスタムフィルタを実装
  - CloudWatch Logs のログ保持期間を90日に設定し、過去ログへのアクセスを監査

---

## 3. Confirmation Items (requiring user confirmation)

### 3.1 患者の本人確認方法

- **確認理由**: 新規患者登録時にメールアドレスとパスワードのみで登録可能な場合、なりすまし登録や架空患者作成のリスクがある
- **選択肢とトレードオフ**:
  - **案A（SMS認証）**: 電話番号にSMS送信で本人確認。コスト: SMS送信料（約3-5円/件）
  - **案B（保険証アップロード）**: 保険証画像をアップロードし、運営側が手動確認。コスト: 人的リソース、OCR導入費用
  - **案C（緩い登録+初回診療時確認）**: 登録は簡易化し、初回診療時に医療機関側で本人確認。UX: 登録ハードル低減、リスク: なりすまし予約

### 3.2 医師免許番号の検証

- **確認理由**: `doctors.license_number` に医師免許番号を保存しているが、登録時に厚生労働省の医師等資格確認検索システムと照合するか不明
- **選択肢とトレードオフ**:
  - **案A（自動照合）**: 厚労省APIまたはスクレイピングで自動検証。技術的難易度: 高、正確性: 高
  - **案B（手動確認）**: 運営スタッフが医師免許証コピーを目視確認。コスト: 人件費
  - **案C（医療機関に委任）**: 医療機関側の責任で医師情報を登録。リスク: 偽医師の混入

### 3.3 診療予約のキャンセルポリシー

- **確認理由**: `DELETE /api/v1/appointments/{id}` で予約キャンセル可能だが、キャンセル期限（例: 診療24時間前まで）やキャンセル料の設計が不明
- **選択肢とトレードオフ**:
  - **案A（24時間前まで無料キャンセル）**: 患者UX向上、医療機関側の空き枠リスク増
  - **案B（当日キャンセルは手数料）**: 医療機関の損失軽減、決済API追加実装が必要
  - **案C（キャンセル不可・日時変更のみ）**: ドタキャン防止、患者UX低下

---

## 4. Positive Evaluation (good points)

### 4.1 パスワードハッシュ化にbcryptを採用

- bcryptのコストファクタ12は現在の推奨値（10-12）に適合しており、辞書攻撃への耐性が高い
- 関連箇所: セクション7 非機能要件 - セキュリティ要件

### 4.2 通信の完全HTTPS化

- TLS 1.2以上の強制により、中間者攻撃（MITM）や盗聴を防止できる
- CloudFrontとALB間もHTTPSとすることで、エンドツーエンド暗号化を実現
- 関連箇所: セクション7 非機能要件 - セキュリティ要件

### 4.3 データベース暗号化の実装

- 診断内容や処方箋など特に機密性の高いデータをAES-256で暗号化している点は評価できる（ただし鍵管理の詳細化が必要）
- 関連箇所: セクション7 非機能要件 - セキュリティ要件

### 4.4 APIレート制限の導入

- Redisベースのレート制限により、DDoS攻撃やAPI乱用を基本的に防御できる（ただしエンドポイント別の調整が望ましい）
- 関連箇所: セクション7 非機能要件 - セキュリティ要件

### 4.5 マルチAZ構成とバックアップ

- PostgreSQLの日次自動バックアップ（30日保持）により、ランサムウェア攻撃やデータ破損時のリカバリが可能
- 読み取りレプリカによる負荷分散で、可用性とパフォーマンスを両立
- 関連箇所: セクション7 非機能要件 - 可用性・スケーラビリティ
