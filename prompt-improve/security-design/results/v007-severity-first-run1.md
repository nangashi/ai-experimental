# TaskFlow システム設計書 - セキュリティ評価レポート

## Critical Issues (design modification required)

### 1. JWT トークンの格納方法と有効期限が危険
**問題**: localStorage へのトークン保存（セクション 5「認証・認可方式」）は XSS 攻撃によるトークン窃取を許し、24時間という長い有効期限は被害期間を延長する
- **影響**: XSS 脆弱性が一つでも存在すれば、攻撃者は24時間有効なトークンを取得し、完全なアカウント乗っ取りが可能になる。特に owner/admin ロールのトークンが盗まれた場合、組織全体のデータ漏洩につながる
- **推奨対策**: Cookie に HttpOnly + Secure + SameSite=Strict 属性を付与して保存する方式に変更。アクセストークンの有効期限を15分に短縮し、リフレッシュトークン（7日間、ローテーション機構付き）による更新メカニズムを実装
- **関連セクション**: セクション 5「API設計 - 認証・認可方式」

### 2. 認証エンドポイントにレート制限と総当たり攻撃対策が欠落
**問題**: `/api/v1/auth/login` および `/api/v1/auth/signup` にレート制限の設計が記載されていない
- **影響**: ログインエンドポイントへの総当たり攻撃により、弱いパスワードのアカウントが侵害される。特に owner/admin アカウントが標的になった場合、組織全体のデータへのアクセスが可能になる。また、signup エンドポイントへの自動攻撃により大量の不正アカウントが作成される可能性がある
- **推奨対策**: express-rate-limit（v7.1.0）を使用し、`/api/v1/auth/login` を IP あたり 5 回/15分、`/api/v1/auth/signup` を IP あたり 3 回/時間に制限。5回の失敗後は30分間のアカウントロックを実装。さらに、組織全体の login 試行回数も監視（100回/時間で管理者アラート）
- **関連セクション**: セクション 5「API設計 - 認証関連」、セクション 3「アーキテクチャ設計 - API Gateway層」

### 3. CSRF 保護機構が設計されていない
**問題**: 状態変更を伴う API エンドポイント（POST/PUT/DELETE）に対する CSRF トークン検証の設計が欠落
- **影響**: 攻撃者が悪意のあるサイトを用意し、認証済みユーザーを誘導することで、ユーザーの意図しないプロジェクト削除、タスク変更、管理者権限の付与などが実行される。特に `/api/v1/projects/:id`（DELETE）や User の role 変更 API が悪用された場合、組織のデータ損失や権限昇格が発生する
- **推奨対策**: csurf ミドルウェア（v1.11.0）を導入し、Double Submit Cookie パターンを実装。すべての状態変更エンドポイントに CSRF トークン検証を適用。Cookie には SameSite=Strict 属性を設定し、多層防御を実現
- **関連セクション**: セクション 5「API設計」全体、セクション 3「アーキテクチャ設計 - API Gateway層」

### 4. ファイルアップロードの検証が不十分（ファイルタイプ検証・スキャン欠落）
**問題**: ドキュメントアップロード機能でファイルサイズ制限（10MB）のみが記載され、MIME タイプ検証、ファイル拡張子ホワイトリスト、マルウェアスキャンが設計されていない
- **影響**: 攻撃者が実行可能ファイル（.exe, .sh）や悪意のある HTML/JavaScript ファイルをアップロードし、他のユーザーがダウンロード・実行することでマルウェア感染やクライアントサイド攻撃が成立する。S3 から直接配信される場合、ブラウザでの自動実行リスクもある
- **推奨対策**: (1) ファイルタイプのホワイトリスト検証（許可: .pdf, .docx, .xlsx, .png, .jpg, .gif, .txt, .md）、(2) MIME タイプと拡張子の一致検証、(3) ファイルコンテンツのマジックバイト検証、(4) ClamAV などのマルウェアスキャンツールによるアップロード時スキャン、(5) S3 オブジェクトに `Content-Disposition: attachment` ヘッダーを設定しブラウザでの直接実行を防止
- **関連セクション**: セクション 5「API設計 - ドキュメント管理」、セクション 7「非機能要件 - セキュリティ要件」

### 5. 権限チェックロジックが未定義（認可モデルの実装仕様欠如）
**問題**: セクション 5 で「リソースごとのアクセスコントロール」が言及されているが、具体的な権限チェックロジック（誰が何にアクセスできるか）が設計されていない
- **影響**: 実装時の認可ロジックの不備により、(1) 他の組織のプロジェクトへの不正アクセス、(2) guest ロールによる削除操作の実行、(3) プロジェクトメンバー外のユーザーによる機密タスクの閲覧、などの権限昇格が発生する
- **推奨対策**: 以下の認可ルールを明示的に設計・文書化する
  - **Organization レベル**: ユーザーは自組織のリソースのみアクセス可能（organization_id 一致チェック必須）
  - **Role レベル**: owner/admin は全操作可能、member は作成・更新のみ、guest は読み取りのみ
  - **Project レベル**: visibility が private の場合は明示的にメンバー追加されたユーザーのみアクセス可能。ProjectMember 中間テーブルの導入を検討
  - すべての API エンドポイントで認可チェックミドルウェアを実装し、リソース取得後に所有権を検証
- **関連セクション**: セクション 5「API設計 - 認証・認可方式」、セクション 4「データモデル」

### 6. 監査ログ設計が欠落（セキュリティイベントの記録・追跡不可）
**問題**: セクション 6 のロギング方針に「API呼び出し」「認証失敗」が含まれているが、セキュリティ監査に必要な詳細（誰が・いつ・何を・どう変更したか）が設計されていない
- **影響**: セキュリティインシデント発生時に (1) 攻撃の侵入経路・影響範囲の特定が不可能、(2) 内部不正（データ削除・権限変更）の証跡が残らない、(3) コンプライアンス要件（SOC2、GDPR）を満たせない
- **推奨対策**: 以下のイベントを AuditLog テーブル（または CloudWatch Logs Insights クエリ可能な形式）に記録する設計を追加
  - **記録対象イベント**: ログイン成功/失敗、ログアウト、パスワード変更、ロール変更、プロジェクト作成/削除、タスク割り当て変更、ドキュメントアップロード/削除、外部連携認可、組織設定変更
  - **記録内容**: タイムスタンプ、ユーザーID、組織ID、イベント種別、対象リソースID、IP アドレス、User-Agent、変更前後の値（JSON diff）
  - **保持期間**: 最低1年間（エンタープライズプランは3年間）
  - **アクセス制限**: owner ロールのみ監査ログを閲覧可能
- **関連セクション**: セクション 6「実装方針 - ロギング方針」

### 7. データ保護設計が不十分（暗号化・データ削除ポリシー欠落）
**問題**: セクション 7 に「すべてのAPI通信はHTTPS経由」とあるが、保存データ（at rest）の暗号化、機密データの扱い、データ削除ポリシーが設計されていない
- **影響**: (1) データベースバックアップやS3バケットが漏洩した場合に機密情報（タスクの description、ドキュメント内容）が平文で露出、(2) GDPR/個人情報保護法の「削除権」要件を満たせない、(3) 退職社員のデータが無期限に残り続けるコンプライアンスリスク
- **推奨対策**: 以下のデータ保護設計を追加
  - **暗号化 at rest**: PostgreSQL の透過的データ暗号化（TDE）を有効化、S3 バケットは SSE-S3 または SSE-KMS で暗号化
  - **機密データの特定**: User.email、Task.description、Document（すべて）を機密データとして分類
  - **データ削除ポリシー**:
    - ユーザーアカウント削除時は関連タスク割り当てを解除し、作成したプロジェクト/タスクは `deleted_by` カラムでソフトデリート（30日後に物理削除）
    - Organization 削除時はすべての関連データを完全削除（S3 オブジェクト含む）
    - ドキュメント削除時は S3 オブジェクトも同時削除（バージョニングで30日間の復元猶予）
  - **データ保持期限**: 非アクティブ組織（最終ログインから2年間）のデータは通知後に削除
- **関連セクション**: セクション 7「非機能要件 - セキュリティ要件」、セクション 2「技術スタック - インフラ」

### 8. 外部連携のOAuth実装にセキュリティ仕様が欠落
**問題**: セクション 3 に「外部連携サービス: OAuth2.0フロー、Webhook処理」とあるが、state パラメータ検証、リダイレクトURI検証、トークン保存方法が設計されていない
- **影響**: (1) CSRF 攻撃により攻撃者のSlack/GitHub アカウントが被害者の組織に接続される、(2) オープンリダイレクト脆弱性によるフィッシング攻撃、(3) 外部サービストークンの漏洩による組織データへの不正アクセス
- **推奨対策**: 以下の OAuth セキュリティ設計を明示
  - **state パラメータ**: 暗号学的に安全なランダム値を生成し、Redis に5分間保存。コールバック時に一致検証
  - **リダイレクトURI**: ホワイトリスト方式（完全一致）で検証。環境変数で管理
  - **スコープ最小化**: Slack は `chat:write`、GitHub は `repo:status` など必要最小限のスコープのみ要求
  - **トークン保存**: 外部サービスのアクセストークン/リフレッシュトークンは DB の専用テーブルに暗号化して保存（AES-256-GCM、暗号化キーは AWS KMS で管理）
  - **Webhook 検証**: Slack/GitHub の署名検証を必須化（HMAC-SHA256）
- **関連セクション**: セクション 3「アーキテクチャ設計 - 外部連携サービス」、セクション 1「主要機能 - 外部サービス連携」

## Improvement Suggestions (effective for improving design quality)

### 9. パスワードポリシーが未定義
**問題**: セクション 7 に「bcryptでハッシュ化（コスト係数10）」とあるが、パスワードの複雑性要件・最小文字数が設計されていない
- **根拠**: 弱いパスワードは bcrypt でハッシュ化しても総当たり攻撃やリスト型攻撃で突破される。パスワードポリシーがないと、ユーザーは「123456」のような脆弱なパスワードを設定可能
- **推奨対策**: サインアップ時に以下のパスワード検証を実装
  - 最小12文字以上
  - 英大文字・小文字・数字・記号のうち3種類以上を含む
  - よくあるパスワードリスト（Have I Been Pwned の Top 10,000）との照合で拒否
  - ユーザー名・メールアドレスの部分文字列を含まない
  - パスワード変更は現在のパスワード入力を必須化

### 10. セッション管理設計が不明確
**問題**: Redis を「セッション管理」に使用するとあるが、セッションタイムアウト、並行セッション制限、強制ログアウトの仕様が記載されていない
- **根拠**: セッション管理の不備により、(1) トークン盗難後の被害が長期化、(2) 共有アカウントの悪用、(3) ログアウト後もトークンが有効なまま残る、などのリスクが発生する
- **推奨対策**:
  - Redis にセッションIDとJWTのマッピングを保存し、ログアウト時に明示的に無効化（JWTのブラックリスト方式）
  - アイドルタイムアウト: 30分間操作がなければ自動ログアウト
  - 並行セッション制限: 同一ユーザーの同時ログインを3セッションまでに制限（新規ログインで最古のセッションを破棄）
  - パスワード変更・ロール変更時にすべてのセッションを強制無効化
  - owner/admin ロールは「すべてのセッションをログアウト」機能を提供

### 11. エラーレスポンスの情報漏洩リスク
**問題**: セクション 6 に「予期しないエラーは500エラーとして返却し、ログに詳細を記録」とあるが、エラーレスポンスに含める情報の制限が設計されていない
- **根拠**: スタックトレース、SQL クエリ、内部パス情報をエラーレスポンスに含めると、攻撃者にシステム構造が露出し、標的型攻撃が容易になる
- **推奨対策**:
  - 本番環境のエラーレスポンスは一般的なメッセージのみ返却（例: "An unexpected error occurred. Please contact support with error ID: ERR-20260210-1234"）
  - エラー詳細（スタックトレース、SQL文、内部パス）はサーバー側のログにのみ記録
  - エラーIDを生成しレスポンスに含めることで、サポートチームがログを特定可能に
  - 開発/ステージング環境では詳細エラーを返却（環境変数で切り替え）

### 12. データベース接続情報とシークレット管理が未設計
**問題**: インフラ設計に PostgreSQL、Redis、S3 の利用が記載されているが、接続情報や API キーの管理方法が設計されていない
- **根拠**: 接続文字列やAPIキーをコードやコンテナイメージにハードコードすると、ソースコード漏洩時に本番環境への不正アクセスが発生する
- **推奨対策**:
  - AWS Secrets Manager を使用して DB 接続情報、外部APIキー、暗号化キーを管理
  - EKS Pod には IAM Roles for Service Accounts (IRSA) を設定し、Secrets Manager へのアクセス権を最小権限で付与
  - 環境変数経由で注入（kubernetes の `secretKeyRef` を使用）
  - シークレットのローテーション: データベースパスワードは90日ごとに自動ローテーション
  - 開発環境では `.env.example` のテンプレートを提供し、実際の `.env` は `.gitignore` に追加

### 13. 依存ライブラリの脆弱性管理が未設計
**問題**: セクション 2 に主要ライブラリが列挙されているが、脆弱性スキャンやアップデート方針が記載されていない
- **根拠**: 既知の脆弱性を持つライブラリ（例: 古いバージョンの jsonwebtoken、express）を使用し続けると、公開された攻撃手法による侵害リスクが高まる
- **推奨対策**:
  - GitHub Dependabot を有効化し、脆弱性のあるパッケージに対する PR を自動作成
  - CI/CD パイプラインに `npm audit` を組み込み、Critical/High の脆弱性が検出された場合はビルド失敗
  - 四半期ごとに依存ライブラリの棚卸しを実施し、メンテナンスされていないライブラリは代替品に移行
  - セキュリティパッチは優先的に適用（リリースから7日以内）

### 14. リアルタイム通信（Socket.IO）のセキュリティ設計が欠落
**問題**: セクション 2 に Socket.IO v4 の使用が記載されているが、認証・認可、メッセージ検証、DoS 対策が設計されていない
- **根拠**: WebSocket 接続は HTTP とは異なるプロトコルのため、適切な認証がなければ匿名ユーザーがリアルタイム通知を盗聴したり、偽の通知を送信したりできる
- **推奨対策**:
  - Socket.IO 接続時に JWT トークンを検証（handshake の auth パラメータまたは Cookie 経由）
  - 接続後も各メッセージで送信者の権限を検証（例: プロジェクトメンバーのみがそのプロジェクトの通知を受信可能）
  - レート制限: 1クライアントあたり 100 メッセージ/分に制限
  - 入力検証: クライアントから送信されるメッセージは express-validator と同等のバリデーションを適用
  - Namespace/Room の分離: Organization ごと、Project ごとに Socket.IO の Room を分離し、クロスリークを防止

### 15. APIのバージョニング戦略が不完全
**問題**: エンドポイントに `/api/v1/` のバージョンプレフィックスがあるが、下位互換性の破壊や廃止プロセスが設計されていない
- **根拠**: セキュリティ強化（例: CSRF トークン必須化）を行う際に既存クライアントを破壊せずに移行する仕組みがないと、セキュリティ改善が遅延する
- **推奨対策**:
  - 破壊的変更時は `/api/v2/` を追加し、v1 は最低6ヶ月間サポート継続
  - 廃止予定の API は `Deprecation` ヘッダーと `Sunset` ヘッダーで事前通知
  - v1 エンドポイントの使用状況を CloudWatch メトリクスで監視し、移行状況を追跡
  - セキュリティクリティカルな変更（CSRF必須化など）は全バージョンに即座にバックポート

## Confirmation Items (requiring user confirmation)

### 16. プロジェクトの `visibility: public` の公開範囲
**問題**: セクション 4 の Project テーブルに `visibility: 'public'` が定義されているが、「public」が意味する範囲（インターネット全体への公開 vs 登録ユーザー全員への公開）が不明確
- **確認理由**: 公開範囲の誤解により、機密プロジェクトが意図せず外部に露出するリスクがある
- **選択肢とトレードオフ**:
  - **Option A: インターネット全体に公開** → SEO効果があるが、認証なしでのアクセスを許すため機密情報の誤公開リスクが高い。この場合、「公開前の確認ダイアログ」「public プロジェクト作成権限を owner/admin のみに制限」などの安全装置が必要
  - **Option B: 登録ユーザー全員に公開** → 誤公開リスクは低いが、外部パートナーとの共有には個別の招待が必要になる
  - **推奨**: Option B を採用し、外部公開が必要な場合は「共有リンク」機能（有効期限付き、読み取り専用トークン）を別途設計

### 17. ゲストユーザーの招待フローと権限範囲
**問題**: セクション 4 の User テーブルに `role: 'guest'` が定義されているが、guest の作成方法（メール招待 vs 自己登録）と許可操作が設計されていない
- **確認理由**: guest ロールのセキュリティ境界が曖昧だと、外部パートナーが意図しないデータにアクセスしたり、内部ユーザーが guest 権限で侵入したりするリスクがある
- **選択肢とトレードオフ**:
  - **Option A: メール招待のみ** → セキュリティは高いが、招待フローの実装コストがかかり、外部パートナーの参加ハードルが上がる
  - **Option B: 一部プロジェクトは公開リンクで guest 登録可能** → 参加は容易だが、スパムアカウント作成のリスクがあり、レート制限と CAPTCHA が必須
  - **推奨**: Option A を採用し、guest は招待されたプロジェクトのタスク閲覧とコメント投稿のみ可能（作成・編集・削除は不可）とする

## Positive Evaluation (good points)

### 18. ロールベースアクセス制御の階層設計
Organization レベルでの4段階ロール（owner/admin/member/guest）の設計は、チーム管理の柔軟性と権限分離の両立を実現している。特に owner ロールを最上位に設定することで、組織の所有権が明確になり、権限昇格攻撃の影響範囲を限定できる。

### 19. bcryptによるパスワードハッシュ化（コスト係数10）
セクション 7 でコスト係数10の bcrypt 使用を明記している点は評価できる。これにより総当たり攻撃に対する十分な計算コストが確保され、将来的なハードウェア性能向上に対してもコスト係数の調整で対応可能な設計になっている。

### 20. Sequelize ORMによるSQLインジェクション対策
セクション 7 で Sequelize ORM 使用を明記し、プリペアドステートメントによる SQL インジェクション対策が組み込まれている。これにより実装者が手動でエスケープ処理を行う必要がなくなり、脆弱性の混入リスクが低減される。

### 21. HTTPS通信の全面採用
すべての API 通信を HTTPS 経由とする設計（セクション 7）により、中間者攻撃による盗聴・改ざんが防止される。特に認証トークンや機密データの送信時に重要な防御層となる。

### 22. マルチリージョン展開を見据えた UUID主キー設計
すべてのテーブルで UUID を主キー（セクション 4）として採用することで、将来的な水平分散やマルチリージョン展開時の ID 衝突リスクが回避される。また、オートインクリメント整数IDと異なり、URLからレコード総数を推測される情報漏洩も防止される。

---

## Score Summary

| Criterion | Score (1-5) | Main Reason |
|-----------|-------------|-------------|
| Threat Modeling (STRIDE) | 2 | CSRF攻撃（Tampering/Spoofing）への対策が欠落し、監査ログ不在により Repudiation への対応も不十分 |
| Authentication & Authorization Design | 1 | localStorage でのJWT保存とレート制限欠如により Critical レベルの認証突破リスクが存在 |
| Data Protection | 2 | at rest 暗号化とデータ削除ポリシーが未設計で、GDPR コンプライアンス違反のリスクあり |
| Input Validation Design | 2 | ファイルアップロードの検証が不十分で、悪意のあるファイルによる攻撃が可能 |
| Infrastructure & Dependencies | 2 | シークレット管理と依存ライブラリの脆弱性管理が未設計で、認証情報漏洩リスクあり |
| **Overall** | **1.8** | |

**総合評価**: 設計書にはセキュリティ要件への言及があるものの、Critical レベルの問題（JWT保存方法、レート制限欠如、CSRF対策欠如、権限チェック未定義）が複数存在し、即座の設計修正が必要。特に認証周りの脆弱性は、サービス公開前に必ず対処すべき重大なリスクである。
