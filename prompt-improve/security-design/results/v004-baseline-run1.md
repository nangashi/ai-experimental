# セキュリティ設計レビュー結果

## スコアサマリ

| 観点 | スコア (1-5) | 主な理由 |
|-----|-------------|---------|
| 脅威モデリング（STRIDE） | 2 | 全てのSTRIDE脅威カテゴリで対策不足。特にRepudiation（監査ログ不足）とElevation of Privilegeが深刻 |
| 認証・認可設計 | 2 | JWT有効期限24時間が危険。リフレッシュトークン未実装で利便性とセキュリティのバランス不良 |
| データ保護 | 1 | マイナンバー・口座番号の平文保存は法令違反レベル。秘密情報の環境変数平文保存も重大 |
| 入力検証設計 | 3 | 入力検証の方針が設計書に明示されていない。インジェクション対策の具体的設計が不足 |
| インフラ・依存関係 | 3 | シークレット管理が不適切。依存関係の脆弱性管理プロセスが未定義 |
| **総合** | **2.2** | |

---

## 1. 重大な問題（設計の修正が必須）

### 1.1 マイナンバー・口座番号の平文保存（データ保護）

**問題**: 4.1節で「マイナンバー・口座番号はデータベースに保存（暗号化なし）」と明記されている。これは個人情報保護法およびマイナンバー法の安全管理措置義務に違反する可能性が極めて高い。

**影響**:
- データベース侵害時に機密個人情報が即座に漏洩
- マイナンバー法違反により最大4年以下の懲役または200万円以下の罰金
- 個人情報保護委員会からの行政指導・勧告のリスク
- 顧客企業の信頼喪失

**推奨対策**:
- マイナンバーと口座番号にAES-256-GCMによる列レベル暗号化を実装
- 暗号化キーはAWS KMS（Key Management Service）で管理
- データベースダンプ・バックアップファイルも暗号化対象とする
- アクセスログで「誰がいつマイナンバーを参照したか」を記録（番号法対応）
- JCEの`Cipher`クラスでGCMモードを使用（パディングオラクル攻撃対策）

**該当箇所**: 4.1節 employees テーブル定義、7.2節 セキュリティ要件

---

### 1.2 JWT署名鍵・DBパスワードの環境変数平文保存（インフラ）

**問題**: 6.5節で「秘密情報（JWT署名鍵、データベースパスワード）は環境変数に平文で設定」と記載。これはコンテナイメージやデプロイログに秘密情報が露出するリスクが高い。

**影響**:
- GitHub Actionsのログ、CloudWatchログに秘密情報が漏洩する可能性
- ECSタスク定義がS3にバックアップされた場合、平文で保存される
- JWT署名鍵が漏洩すると、攻撃者が任意のユーザーになりすました有効なトークンを生成可能

**推奨対策**:
- AWS Secrets Managerを使用してJWT署名鍵とDBパスワードを管理
- ECSタスク定義で`secrets`パラメータを使用し、実行時に取得
- 秘密情報のローテーション機能を有効化（90日ごと）
- Spring Boot設定で`spring.datasource.password=${aws:secretsmanager:db-password}`のような参照方式を採用

**該当箇所**: 6.5節 デプロイメント方針

---

### 1.3 個人情報のログ出力（データ保護）

**問題**: 6.3節で「個人情報（氏名、メール、給与額）はログに出力する」と明記されている。これはDatadogなどのログ集約基盤に機密情報が蓄積され、意図しない第三者アクセスのリスクがある。

**影響**:
- ログ閲覧権限を持つ開発者全員が給与額を参照可能
- Datadogのアクセス制御が不十分な場合、外部漏洩のリスク
- 個人情報保護法の「必要最小限の取得・利用」原則に抵触する可能性

**推奨対策**:
- ログ出力時に個人情報をマスキング（例: `yamada@example.com` → `ya***@example.com`）
- 給与額は絶対にログに出力しない（監査ログとして別途管理）
- Spring Boot Logbackでマスキングフィルタを実装
  ```xml
  <pattern>%d{ISO8601} [%thread] %-5level %logger{36} - %maskedMsg%n</pattern>
  ```
- 監査ログは暗号化した専用ストレージ（S3 + KMS）に保存

**該当箇所**: 6.3節 ロギング方針

---

### 1.4 JWT有効期限24時間の設定（認証・認可）

**問題**: 3.3節でJWT有効期限が24時間と設定されている。リフレッシュトークンが実装されていないため、トークン窃取時の被害期間が長い。

**影響**:
- XSS攻撃やローカルストレージ漏洩でトークンが窃取された場合、攻撃者は最大24時間アクセス可能
- トークン無効化の仕組みがないため、ユーザーがログアウトしてもトークンは有効なまま
- OWASP Top 10の「Broken Access Control」に該当するリスク

**推奨対策**:
- アクセストークンの有効期限を15分に短縮
- リフレッシュトークン（有効期限7日、HttpOnly Cookie）を実装
- リフレッシュトークンローテーション（使用済みトークンは無効化）
- Spring Securityの`RefreshTokenService`で実装
- ログアウト時はリフレッシュトークンをデータベースのブラックリストに登録

**該当箇所**: 3.3節 データフロー、6.1節 認証・認可方式

---

### 1.5 Row-Level Securityのみに依存したテナント分離（脅威モデリング - Elevation of Privilege）

**問題**: 3.3節でテナント分離をPostgreSQLのRow-Level Security（RLS）のみに依存している。アプリケーション層での検証が設計されていない。

**影響**:
- RLSポリシーの設定ミスがあった場合、他テナントのデータに即座にアクセス可能
- JWTのテナントIDを改ざんされた場合、アプリケーション層で検証がないため不正アクセスされる可能性
- マルチテナントSaaSでは「テナント間データ漏洩」が最大のセキュリティリスク

**推奨対策**:
- アプリケーション層でもテナントID検証を二重実装（防御の多層化）
  ```java
  @PreAuthorize("@tenantValidator.validate(#tenantId)")
  public List<Employee> getEmployees(UUID tenantId) { ... }
  ```
- JWTのテナントIDと要求パラメータのテナントIDの一致をミドルウェアで強制検証
- RLSポリシーの設定をIaCコード（Terraform）で管理し、レビュー必須化
- 統合テストで「他テナントデータへのアクセスが拒否されること」を必須検証

**該当箇所**: 3.3節 データフロー、5節 API設計

---

### 1.6 SQLインジェクション対策の明示不足（入力検証）

**問題**: 設計書全体でSQLインジェクション対策が明記されていない。Spring BootのJPAを使用していることが読み取れるが、PreparedStatementの使用方針が不明確。

**影響**:
- 開発者が動的SQL（`createNativeQuery`）を使用した際にインジェクションが発生する可能性
- 特に検索機能（5.2節 `GET /api/employees`のdepartment_idフィルタ）で危険

**推奨対策**:
- JPA Criteria API または Spring Data JPA の Named Parameterを必須とする設計方針を明記
- Native Queryを使用する場合は必ずPreparedStatement（`?`プレースホルダ）を使用
- コードレビューチェックリストに「動的SQL構築の禁止」を追加
- SonarQubeでSQLインジェクションルールを有効化

**該当箇所**: 5節 API設計（全体）

---

## 2. 改善提案（設計の品質向上に有効）

### 2.1 レート制限・ブルートフォース対策の未設計（認証・認可）

**理由**: 5.1節のログインエンドポイント（`POST /api/auth/login`）にレート制限が設計されていない。ブルートフォース攻撃による不正ログインのリスクがある。

**推奨対策**:
- Spring Bootで`Bucket4j`ライブラリ（v8.x）を使用したレート制限を実装
- ログインエンドポイント: IPアドレスあたり10回/分、アカウントあたり5回/15分
- 5回連続失敗で30分間のアカウントロック（Redis に失敗回数を記録）
- レート制限超過時のレスポンス: `429 Too Many Requests` + `Retry-After`ヘッダー

**該当箇所**: 5.1節 POST /api/auth/login

---

### 2.2 CSRF対策の明示不足（脅威モデリング - Tampering）

**理由**: Spring Securityを使用しているがCSRF対策の設計が明記されていない。state-changing API（POST/PUT/DELETE）でCSRF攻撃のリスクがある。

**推奨対策**:
- Spring SecurityのCSRF保護を有効化（デフォルトで有効だが明示的に設計書に記載）
- フロントエンドでCSRFトークンをmetaタグから取得し、全リクエストに`X-XSRF-TOKEN`ヘッダーで送信
- JWTベースのSPAなので、`SameSite=Strict`属性のCookie設定と併用
- APIエンドポイントのCSRF設定を明記:
  ```java
  http.csrf().csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
  ```

**該当箇所**: 6.1節 認証・認可方式

---

### 2.3 S3バケットのアクセス制御が未定義（データ保護）

**理由**: 2.2節でS3に給与明細PDFや契約書類を保存するが、アクセス制御ポリシーが設計されていない。公開設定ミスによる情報漏洩リスクがある。

**推奨対策**:
- S3バケットポリシーで「パブリックアクセスブロック」を全て有効化
- IAMロールベースのアクセス制御（ECSタスクロールのみ読み書き可能）
- 署名付きURL（Presigned URL）で一時的なダウンロードリンクを生成（有効期限15分）
- S3オブジェクトのサーバーサイド暗号化（SSE-KMS）を有効化
- CloudTrailでS3アクセスログを記録

**該当箇所**: 2.2節 データベース、3.1節 全体構成

---

### 2.4 監査ログの改ざん防止策が未設計（脅威モデリング - Repudiation）

**理由**: 6.3節で監査ログを記録するが、改ざん防止策が設計されていない。内部不正や侵害後の証跡隠蔽のリスクがある。

**推奨対策**:
- 監査ログを専用のS3バケット（Write Once Read Many設定）に送信
- S3 Object Lockで変更不可能な状態で保存（保持期間7年）
- CloudWatch Logs Insightsで異常パターン検出（例: 深夜の大量データアクセス）
- ログの完全性検証用にハッシュチェーン（各ログエントリに前エントリのSHA-256を含める）を実装

**該当箇所**: 6.3節 ロギング方針

---

### 2.5 パスワードポリシーが未定義（認証・認可）

**理由**: 7.2節でbcryptハッシュ化は明記されているが、パスワードの強度要件（長さ、複雑性）が設計されていない。

**推奨対策**:
- 最小長さ12文字、大文字・小文字・数字・記号を各1文字以上含む
- NIST SP 800-63Bに準拠した辞書攻撃対策（Have I Been Pwned APIでチェック）
- パスワード有効期限は設定しない（NIST最新ガイドラインでは非推奨）
- パスワード履歴（過去5回分）を保存し、再利用を防止

**該当箇所**: 7.2節 セキュリティ要件

---

### 2.6 APIのバージョニング戦略が未定義（脅威モデリング - Denial of Service）

**理由**: 5節のAPI設計でバージョニングが明記されていない。セキュリティパッチ適用時に後方互換性を壊す可能性がある。

**推奨対策**:
- URLベースのバージョニング（`/api/v1/employees`）を採用
- セキュリティ上の重大な変更時は新バージョンでリリース
- 旧バージョンは6ヶ月間サポート（非推奨警告ヘッダー`Deprecation: true`）

**該当箇所**: 5節 API設計

---

### 2.7 依存関係の脆弱性管理プロセスが未定義（インフラ・依存関係）

**理由**: 7.2節で月次の脆弱性スキャンは記載されているが、依存ライブラリの脆弱性検出と更新プロセスが不明確。

**推奨対策**:
- OWASP Dependency-CheckをCI/CDパイプラインに統合
- GitHub Dependabotで依存関係の自動PR作成
- CVSSスコア7.0以上の脆弱性は検出後48時間以内にパッチ適用
- Spring BootとSpring Securityは四半期ごとにメジャーバージョンアップを検討

**該当箇所**: 7.2節 セキュリティ要件

---

### 2.8 データベースバックアップの暗号化が未明示（データ保護）

**理由**: 7.3節で日次バックアップは記載されているが、バックアップファイルの暗号化が設計されていない。

**推奨対策**:
- RDSの自動バックアップでAES-256暗号化を有効化
- バックアップファイルは別リージョンにレプリケーション（災害対策）
- 復元テストを四半期ごとに実施（RPO検証）

**該当箇所**: 7.3節 可用性・スケーラビリティ

---

## 3. 確認事項（ユーザーへの確認が必要）

### 3.1 JWT保存先の選択（認証・認可）

**確認理由**: 設計書にJWTの保存先（localStorage vs Cookie）が明記されていない。XSS対策とCSRF対策のトレードオフがある。

**選択肢とトレードオフ**:
- **Option A: HttpOnly Cookie**
  - メリット: XSS攻撃でトークン窃取不可、セキュアな選択
  - デメリット: CSRF対策が必須、SameSite=Strict時にサブドメイン間通信が制限される
- **Option B: localStorage**
  - メリット: CSRF攻撃の影響なし、実装がシンプル
  - デメリット: XSS攻撃でトークン窃取可能、OWASP非推奨

**推奨**: Option A（HttpOnly Cookie + CSRF対策）

---

### 3.2 多要素認証（MFA）の実装優先度（認証・認可）

**確認理由**: 給与情報や個人情報を扱うシステムとして、MFAの実装が望ましいが、初期リリースに含めるかの優先度判断が必要。

**選択肢とトレードオフ**:
- **Option A: 初期リリースで実装**
  - メリット: セキュリティ水準の大幅向上、規制対応の強化
  - デメリット: 開発工数増加、ユーザー体験の複雑化
- **Option B: フェーズ2で実装**
  - メリット: 初期リリースの簡素化
  - デメリット: アカウント乗っ取りリスクが残存

**推奨**: 管理者・人事担当者アカウントのみ初期実装（TOTP方式）

---

### 3.3 データ保持期間とGDPR/個人情報保護法対応（データ保護）

**確認理由**: 設計書にデータ保持期間とユーザーの「削除権」実装が明記されていない。法令対応が必要。

**選択肢とトレードオフ**:
- **Option A: 退職後7年保持（法定保存期間準拠）**
  - メリット: 労働基準法・税法の要件を満たす
  - デメリット: ストレージコスト、プライバシーリスク
- **Option B: 退職後3年保持 + アーカイブ（コールドストレージ）**
  - メリット: コスト削減、プライバシー保護
  - デメリット: 一部法令要件に不足する可能性

**推奨**: Option A + 本人の削除要求時は仮名化処理

---

## 4. 評価（良い点）

### 4.1 HTTPSの全面採用（データ保護）
7.2節で「通信は全てHTTPSで暗号化」と明記されており、中間者攻撃（MITM）対策として適切。ALBでTLS 1.2以上を強制する設計も推奨される。

### 4.2 bcryptによるパスワードハッシュ化（認証・認可）
7.2節でbcrypt（work factor 10）の使用が明記されており、レインボーテーブル攻撃に対して効果的。work factorは将来的に12に引き上げを検討。

### 4.3 監査ログの記録方針（脅威モデリング - Repudiation）
6.3節で認証イベント、権限エラー、給与計算実行、従業員情報更新をログ記録する設計は、インシデント調査の観点で評価できる。ログの改ざん防止策を追加すればさらに強化される。

### 4.4 テナントIDによるマルチテナント分離（脅威モデリング - Information Disclosure）
3.1節でテナントIDベースのデータ分離設計を採用しており、基本的なマルチテナントセキュリティが考慮されている。Row-Level Securityとの二重検証を追加すれば理想的。

### 4.5 @PreAuthorizeによる宣言的権限チェック（認証・認可）
6.1節でSpring Securityの`@PreAuthorize`を使用する方針は、権限チェックの実装漏れを防ぐ良い設計。各エンドポイントの権限要件（5.2節など）も明確に記載されている。
