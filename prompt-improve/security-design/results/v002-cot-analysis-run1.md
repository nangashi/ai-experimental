# セキュリティ設計レビュー結果

**レビュー対象**: デジタルウォレット決済システム 設計書
**レビュー日時**: 2026-02-10
**レビュアー**: security-design-reviewer (v002-variant-cot-analysis)

---

## 分析プロセス

### ステップ1: 全体構造の把握

**システムの目的**: モバイルアプリベースのデジタルウォレット決済システム。QRコード決済とP2P送金を提供。

**主要コンポーネント**:
- 認証基盤: Spring Security + JWT
- 決済処理: PaymentService → Stripe/Plaid API連携
- 個人間送金: TransferService
- 加盟店管理: MerchantService（QRコード生成）
- 不正検出: FraudDetectionService

**データフロー**:
1. モバイルアプリ → API Gateway → JWT検証
2. ビジネスロジック層 → 外部決済API
3. トランザクション記録（PostgreSQL）+ 監査ログ（MongoDB）

**アーキテクチャの特徴**:
- 3層アーキテクチャ + 外部API連携層
- AWS ECS Fargate上で稼働
- PostgreSQL（メイン）+ Redis（キャッシュ/レート制限）+ MongoDB（監査ログ）

### ステップ2: セクション別詳細分析

#### 2.1 認証・認可設計（セクション5.3）

**明示的に記述されている対策**:
- JWT（Access Token 15分、Refresh Token 7日）
- Bearer token方式
- 加盟店APIは加盟店オーナーのみアクセス可能（ユーザー属性で判定）

**記述されていない対策**:
- JWTの保存場所: **localStorage** と明記（セキュリティリスク大）
- トークンの無効化メカニズム（ログアウト時、パスワード変更時）
- Refresh Tokenのローテーション
- トークンの署名アルゴリズム
- CSRF対策（state-changing APIに対する保護）
- セッション管理とトークンの関連付け

#### 2.2 データ保護（セクション4, 7.2）

**明示的に記述されている対策**:
- パスワード: bcryptハッシュ化（係数12）
- PCI DSS準拠: カード情報はStripeトークン化
- 通信: HTTPS（TLS 1.3）

**記述されていない対策**:
- データベースの暗号化（at rest）
- 個人情報（PII）の暗号化（phone_number, KYC書類）
- 決済情報（provider_token）の暗号化
- バックアップデータの暗号化
- データ保持・削除ポリシー（GDPR/個人情報保護法対応）
- KYC書類の保存期間と削除ルール

#### 2.3 入力検証設計（セクション5, 6）

**明示的に記述されている対策**:
- （なし）

**記述されていない対策**:
- APIリクエストの入力検証（バリデーション）
- SQLインジェクション対策（JPAのパラメータバインディング前提だが明記なし）
- XSS対策（管理画面のNext.jsでの出力エスケープ）
- QRコードデータの検証（merchants.qr_code_data）
- 金額の範囲チェック（負の値、異常に大きな値の拒否）
- 通貨コード検証（ISO 4217準拠）

#### 2.4 脅威モデリング（全体）

**明示的に記述されている対策**:
- レート制限（セクション7.2で言及あり）

**記述されていないSTRIDE対策**:
- **Spoofing**: 多要素認証（MFA）、デバイス認証
- **Tampering**: トランザクションの改ざん検出（署名、整合性チェック）
- **Repudiation**: 監査ログはあるが、改ざん防止機構（ログの署名、不変性）が未記載
- **Information Disclosure**: データベースアクセス制御、API応答での情報漏洩防止
- **Denial of Service**: レート制限の具体的設定値が未記載、DDoS対策
- **Elevation of Privilege**: 権限昇格防止、管理者APIの特別な保護

#### 2.5 インフラ・依存関係（セクション2, 6.4）

**明示的に記述されている対策**:
- AWS環境（ECS Fargate, RDS, ElastiCache）
- Blue/Green Deployment

**記述されていない対策**:
- シークレット管理（DBパスワード、APIキー、JWT秘密鍵）
- ライブラリの脆弱性スキャン（Snyk, Dependabot）
- コンテナイメージのスキャン
- WAFの導入（AWS WAF）
- ネットワークセグメンテーション（VPC設計、セキュリティグループ）
- IAM最小権限の原則

### ステップ3: 横断的問題の検出

**3.1 金融取引の整合性と監査証跡**
- トランザクションの改ざん検出が設計されていない（例: 金額変更の検出）
- 監査ログの改ざん防止機構がない（MongoDB書き込み後の検証なし）
- トランザクション処理と監査ログ書き込みが「非同期」だが、失敗時のリカバリが未設計

**3.2 不正検出の実効性**
- FraudDetectionServiceが記載されているが、具体的なルールやトリガーが未定義
- 異常な送金パターン（短時間に大量送金、異常金額）の検出ロジックが未記載
- 不正検出後のアクション（アカウント凍結、取引停止）のワークフローが不明

**3.3 P2P送金のリスク管理**
- 送金限度額が設定されていない（マネーロンダリング対策）
- 受取人の確認プロセスが不明（誤送金の防止）
- 送金の取り消し・紛争解決メカニズムが未設計

**3.4 加盟店のなりすまし**
- QRコードの真正性検証がない（偽QRコードによるフィッシング）
- 加盟店の本人確認プロセス（KYC）が未記載

**3.5 レート制限の不十分さ**
- 「適切なレート制限を設定する」と記載があるが、具体的な設定値が不明
- エンドポイント別の制限（ログイン、決済、送金）が未設計
- 分散型DoS（多数のユーザーアカウントからの攻撃）への対策が不明

---

## スコアサマリ

| 観点 | スコア (1-5) | 主な理由 |
|-----|-------------|---------|
| 脅威モデリング（STRIDE） | 2 | STRIDE全6脅威に対する具体的対策が不足。特にRepudiation（監査ログ改ざん防止）とElevation of Privilege（権限昇格防止）が未設計 |
| 認証・認可設計 | 2 | JWTをlocalStorageに保存する設計はXSS攻撃に脆弱。トークン無効化、Refresh Tokenローテーション、CSRF対策が未記載 |
| データ保護 | 3 | 通信暗号化とパスワードハッシュ化は適切だが、データベース暗号化（at rest）、PII暗号化、データ削除ポリシーが未設計 |
| 入力検証設計 | 2 | APIリクエストの入力検証が全く記載されていない。金額検証、QRコード検証、インジェクション対策の明示が必要 |
| インフラ・依存関係 | 3 | AWS環境は適切だが、シークレット管理、WAF、ネットワークセグメンテーション、脆弱性スキャンが未記載 |
| **総合** | **2.4** | 重要な問題が複数存在し、本番環境での攻撃リスクが高い。特に認証設計と入力検証の不備は即時修正が必要 |

---

## 1. 重大な問題（設計の修正が必須）

### 1.1 JWTトークンのlocalStorage保存はXSS攻撃に脆弱

**問題の説明**: 設計書に「トークンはlocalStorageに保存（フロントエンド）」と記載されている（セクション5.3）。localStorageはJavaScriptから自由にアクセス可能であり、XSS脆弱性が1つでもあれば攻撃者はトークンを窃取できる。

**影響**: XSS攻撃によりトークンが窃取されると、攻撃者は15分間（Access Token有効期限）はユーザーになりすまし可能。さらにRefresh Token（7日有効）も窃取されれば、最大7日間アカウントを乗っ取られる。金融アプリケーションでは、これは全残高の不正送金やカード情報へのアクセスにつながる。

**推奨対策**:
1. **HttpOnly + Secure + SameSite=Strict属性のCookieに変更**: トークンをJavaScriptから読み取り不可にする
2. **CSRF対策を追加**: CookieベースのトークンにはCSRF保護（Double Submit Cookieパターンまたはstate-changing APIでのCSRFトークン検証）を実装
3. **Refresh Tokenローテーション**: トークン更新時に新しいRefresh Tokenを発行し、古いものを無効化（リプレイ攻撃対策）

**該当箇所**: セクション5.3 認証・認可方式

---

### 1.2 入力検証が全く設計されていない

**問題の説明**: API設計（セクション5）やデータモデル（セクション4）で、外部入力の検証ルールが一切記載されていない。以下のリスクがある:
- 金額フィールド（`transactions.amount`）に負の値や異常に大きな値（例: 999,999,999,999.99）が入力される
- 通貨コード（`transactions.currency`）に不正な値（"XXX", "HACK"）が入力される
- QRコードデータ（`merchants.qr_code_data`）に任意のスクリプトやURLが埋め込まれる

**影響**:
- **金額の負の値**: 残高の不正増加、決済ロジックのバイパス
- **異常に大きな金額**: システムクラッシュ、不正取引の隠蔽
- **不正なQRコード**: フィッシングサイトへの誘導、マルウェア配布

**推奨対策**:
1. **Spring Validation（Bean Validation）を使用**:
   ```java
   // 決済リクエストの例
   public class PaymentRequest {
       @NotNull
       @DecimalMin(value = "0.01", message = "金額は0.01以上である必要があります")
       @DecimalMax(value = "1000000.00", message = "金額は1,000,000以下である必要があります")
       private BigDecimal amount;

       @NotBlank
       @Pattern(regexp = "^[A-Z]{3}$", message = "通貨コードはISO 4217形式である必要があります")
       private String currency;
   }
   ```
2. **QRコードデータの検証**: 許可されたフォーマット（例: `wallet://pay?merchant_id={id}`）のみを受け入れる正規表現チェック
3. **統一バリデーションエラーレスポンス**: `@ControllerAdvice`で`MethodArgumentNotValidException`をキャッチし、400エラーを返す

**該当箇所**: セクション5（API設計全体）、セクション4（データモデル）

---

### 1.3 監査ログの改ざん防止機構が未設計

**問題の説明**: 設計書では「非同期で監査ログ書き込み（MongoDB）」と記載されているが（セクション3.3）、ログの改ざん防止メカニズムが存在しない。攻撃者がシステムに侵入した場合、自分の不正取引の証拠を消去できる。

**影響**:
- 不正取引の証拠隠滅
- 法的紛争時の証拠能力の欠如
- コンプライアンス違反（PCI DSS要件10: ログの保護）

**推奨対策**:
1. **ログの署名**: 各ログエントリにHMAC-SHA256署名を付与し、改ざんを検出可能にする
2. **ログの不変性**: MongoDBの代わりにAWS CloudWatch Logsまたは専用の監査ログサービス（例: AWS CloudTrail、Datadog Audit Trail）を使用
3. **ログ書き込みの失敗時の処理**: 非同期書き込みが失敗した場合、トランザクション自体をロールバックするか、別の永続化先（例: Dead Letter Queue）に保存

**該当箇所**: セクション3.3 データフロー、セクション6.2 ロギング

---

### 1.4 トークン無効化メカニズムが存在しない

**問題の説明**: JWT方式が採用されているが、トークンの無効化（ログアウト、パスワード変更時、不正検出時）のメカニズムが設計されていない。JWTはステートレスであり、発行後は有効期限まで有効なため、以下のシナリオで問題が発生する:
- ユーザーがログアウトしても、攻撃者が窃取したトークンは15分間有効
- パスワード変更後も、古いトークンで認証可能
- 不正検出でアカウント凍結しても、既存トークンは使用可能

**影響**: アカウント乗っ取り後の被害期間が最大15分（Access Token）+ 7日（Refresh Token）に及ぶ。

**推奨対策**:
1. **Redisでトークンブロックリストを管理**: 無効化されたトークンをRedisに保存し、認証時にチェック
   ```java
   // 例: ログアウト時
   public void logout(String token) {
       long ttl = jwtService.getTokenExpirationTime(token);
       redisTemplate.opsForValue().set("blacklist:" + token, "revoked", ttl, TimeUnit.SECONDS);
   }
   ```
2. **トークンにバージョン番号を含める**: ユーザーのパスワード変更時に`user.token_version`をインクリメントし、古いバージョンのトークンを拒否
3. **短いAccess Token有効期限**: 現状の15分は適切。Refresh Tokenのローテーションを必ず実装

**該当箇所**: セクション5.3 認証・認可方式

---

### 1.5 P2P送金の限度額と受取人確認が未設計

**問題の説明**: 個人間送金（TransferService）の設計で、送金限度額や受取人確認プロセスが記載されていない。以下のリスクがある:
- マネーロンダリング（短時間に大量の小口送金）
- 誤送金（間違った受取人に送金し、取り消し不可）
- なりすまし送金（攻撃者が被害者のアカウントで送金）

**影響**:
- 法的リスク（犯罪収益移転防止法違反）
- ユーザー体験の悪化（誤送金の苦情増加）
- 不正送金の被害拡大

**推奨対策**:
1. **送金限度額の設定**:
   - 1回あたり: 10万円
   - 1日あたり: 30万円
   - 1ヶ月あたり: 100万円
   - KYC未完了ユーザーはさらに低い限度額（1万円/日）
2. **受取人確認フロー**: 初回送金時に受取人の名前を表示し、ユーザーに確認を求める
3. **送金の遅延処理**: 高額送金（例: 5万円以上）は即時実行せず、30分の猶予期間を設け、ユーザーが取り消し可能にする
4. **不正検出ルール**:
   - 短時間（1時間以内）に10件以上の送金 → アラート
   - 通常の送金パターンと大きく異なる金額 → 追加認証要求

**該当箇所**: セクション3（TransferServiceの説明）、セクション5（送金API）

---

## 2. 改善提案（設計の品質向上に有効）

### 2.1 データベース暗号化（at rest）の追加

**提案の説明**: 現在の設計では、データベースの暗号化（at rest）が明示されていない。RDSではデフォルトで暗号化されないため、ディスクが盗難された場合や不適切に廃棄された場合にデータが漏洩する。

**理由**:
- PCI DSS要件3.4: カード会員データを保存する場合、暗号化が必須
- 個人情報保護法: 個人データの安全管理措置

**推奨対策**:
1. **RDS暗号化を有効化**: PostgreSQLインスタンス作成時に「Enable encryption」を選択（AWS KMSで管理）
2. **Redisの暗号化**: ElastiCache for Redisで「At-Rest Encryption」と「In-Transit Encryption」を有効化
3. **機密フィールドのアプリケーション層暗号化**: `payment_methods.provider_token`は特に機密性が高いため、AES-256-GCMでDBレベル暗号化の上に追加で暗号化

**該当箇所**: セクション2.2（データベース）、セクション7.2（セキュリティ要件）

---

### 2.2 多要素認証（MFA）の導入

**提案の説明**: 現在の認証設計はメールアドレス+パスワードのみ。金融アプリケーションでは、MFAが事実上の標準である。

**理由**:
- パスワード漏洩（フィッシング、データベース侵害）への耐性向上
- 不正ログインの防止
- ユーザーの信頼性向上

**推奨対策**:
1. **SMS/アプリベースのTOTP**: 初回ログイン、デバイス変更時、高額取引時にワンタイムパスワードを要求
2. **実装**: Spring SecurityにGoogle Authenticatorライブラリ（例: `java-totp`）を統合
3. **段階的導入**: 初期はオプション、6ヶ月後に必須化

**該当箇所**: セクション5.1（認証API）

---

### 2.3 WAF（Web Application Firewall）の導入

**提案の説明**: API GatewayにWAFが設定されていない。SQLインジェクション、XSS、DDoSなどの一般的な攻撃パターンをブロックする追加の防御層がない。

**理由**:
- アプリケーション層の脆弱性を悪用した攻撃の緩和
- レート制限の補完（IPベースのDDoS対策）

**推奨対策**:
1. **AWS WAFをAPI Gatewayに統合**:
   - AWS Managed Rules（Core Rule Set、Known Bad Inputs）を適用
   - カスタムルール: `/api/v1/auth/login`への過度なリクエストをブロック（100回/5分/IP）
2. **ログ分析**: WAFブロックログをCloudWatchで監視し、攻撃パターンを検出

**該当箇所**: セクション2.3（インフラ・デプロイ環境）

---

### 2.4 シークレット管理の明示

**提案の説明**: 設計書では、データベースパスワード、JWT秘密鍵、Stripe/Plaid APIキーの管理方法が記載されていない。環境変数やソースコードへのハードコーディングは重大なリスク。

**理由**:
- ソースコードリポジトリへのシークレット漏洩防止
- ローテーション時の管理容易性

**推奨対策**:
1. **AWS Secrets Managerを使用**:
   - DBパスワード、APIキー、JWT秘密鍵を保存
   - ECSタスク定義で`secrets`パラメータを使用し、環境変数として注入
   ```json
   {
     "secrets": [
       {
         "name": "DB_PASSWORD",
         "valueFrom": "arn:aws:secretsmanager:region:account-id:secret:db-password"
       }
     ]
   }
   ```
2. **定期ローテーション**: JWT秘密鍵は90日ごとにローテーション（古い鍵で署名されたトークンは猶予期間後に無効化）

**該当箇所**: セクション6.4（デプロイメント方針）

---

### 2.5 レート制限の具体的設定値の明示

**提案の説明**: セクション7.2に「APIには適切なレート制限を設定する」と記載があるが、具体的な設定値が不明。エンドポイントごとに異なる制限が必要。

**理由**:
- ブルートフォース攻撃の防止
- DDoS攻撃の緩和
- リソース枯渇の防止

**推奨対策**:
Redisベースのレート制限（Spring Bootの`bucket4j`ライブラリ使用）:

| エンドポイント | 制限 | 理由 |
|--------------|------|------|
| `POST /api/v1/auth/login` | 5回/15分/IP | ブルートフォース対策 |
| `POST /api/v1/auth/register` | 3回/時間/IP | スパム登録防止 |
| `POST /api/v1/payments` | 10回/分/ユーザー | 不正決済の連続実行防止 |
| `POST /api/v1/transfers` | 5回/分/ユーザー | 不正送金の連続実行防止 |
| `GET /api/v1/*` | 100回/分/ユーザー | 一般的なAPI保護 |
| `POST /api/v1/admin/*` | 20回/分/ユーザー | 管理API保護 |

**該当箇所**: セクション7.2（セキュリティ要件）

---

### 2.6 加盟店のKYCプロセスの追加

**提案の説明**: 加盟店登録（`POST /api/v1/merchants`）で、加盟店の本人確認プロセスが記載されていない。偽の加盟店がQRコードを発行し、フィッシング攻撃を行うリスクがある。

**理由**:
- ユーザー保護（偽加盟店への誤支払い防止）
- 法的リスク（犯罪収益移転防止法）

**推奨対策**:
1. **加盟店KYCフロー**:
   - 事業者情報の提出（商号、所在地、代表者名）
   - 本人確認書類のアップロード
   - 審査プロセス（3営業日以内）
2. **QRコードの署名**: 加盟店QRコードにシステムの署名を含め、アプリ側で検証（偽QRコードの検出）

**該当箇所**: セクション5.5（加盟店管理API）

---

### 2.7 依存関係の脆弱性スキャン

**提案の説明**: 主要ライブラリ（Spring Security、Stripe SDK、Plaid SDK等）の脆弱性管理が設計に含まれていない。

**理由**:
- サプライチェーン攻撃の防止
- 既知の脆弱性の早期検出

**推奨対策**:
1. **GitHub Dependabotを有効化**: 依存関係の脆弱性を自動検出し、PRを作成
2. **CI/CDでのスキャン**: GitHub ActionsでOWASP Dependency-Checkまたは`snyk test`を実行
3. **コンテナイメージスキャン**: ECRプッシュ時にAmazon ECR Image Scanningを有効化

**該当箇所**: セクション2.4（主要ライブラリ）、セクション2.3（CI/CD）

---

## 3. 確認事項（ユーザーへの確認が必要）

### 3.1 データ保持・削除ポリシーの定義

**確認理由**: GDPR、個人情報保護法では、個人データの保持期間を明示し、不要になったデータを削除する義務がある。現在の設計では、以下が不明:
- KYC書類（身分証明書の画像）の保持期間
- 退会ユーザーのデータ削除タイミング
- 取引履歴の保持期間（税務上の要件: 7年）

**選択肢とトレードオフ**:
1. **オプションA: 法定最低限（7年）保持後に削除**
   - メリット: コンプライアンス準拠、ストレージコスト削減
   - デメリット: 長期的なデータ分析が制限される
2. **オプションB: ユーザー要求による即時削除**
   - メリット: プライバシー保護、GDPR準拠
   - デメリット: 不正調査時のデータ不足

**推奨**: オプションA + ユーザーの「削除権」行使時は個人識別情報のみ仮名化（取引記録は統計用に保持）

---

### 3.2 不正検出サービスの選定

**確認理由**: 設計書に「FraudDetectionService（外部サービス連携も検討）」と記載があるが、自社開発か外部サービスかが未決定。

**選択肢とトレードオフ**:
1. **オプションA: 外部サービス（例: Stripe Radar, Sift）**
   - メリット: 高度な機械学習モデル、すぐに導入可能
   - デメリット: コスト（取引あたり数円）、データ共有の懸念
2. **オプションB: 自社開発（ルールベース）**
   - メリット: コスト削減、データ管理の完全なコントロール
   - デメリット: 開発コスト、精度の低さ

**推奨**: 初期はオプションB（ルールベース）で開始し、取引量増加後にオプションAを段階的に導入

---

## 4. 評価（良い点）

### 4.1 PCI DSS準拠の設計

カード情報を自システムに保存せず、Stripeトークン化を採用している点は優れている。PCI DSSのスコープを大幅に削減し、カード情報漏洩のリスクを回避している。

### 4.2 パスワードハッシュ化の適切性

bcryptでストレッチング係数12はNIST推奨（10以上）を満たしており、レインボーテーブル攻撃に対する耐性が高い。

### 4.3 通信暗号化の最新標準

TLS 1.3の採用は適切。TLS 1.2以下の脆弱性（BEAST、POODLE等）を回避できる。

### 4.4 Blue/Green Deploymentの採用

デプロイメント方式としてBlue/Green Deploymentを採用し、ロールバック可能な状態を維持する設計は、セキュリティパッチの迅速な適用とダウンタイムゼロを両立できる。

### 4.5 Multi-AZ構成

データベースのMulti-AZ構成により、可用性とデータ耐久性が確保されている。DDoS攻撃によるサービス停止リスクの軽減にも寄与する。

---

## 総評

本設計書は、基本的なセキュリティ要件（パスワードハッシュ化、HTTPS通信、PCI DSS準拠）を押さえているが、**金融アプリケーションとして本番環境に投入するには重大な欠陥が複数存在する**。

**最優先で修正すべき問題**（スコア1-2）:
1. JWTのlocalStorage保存 → HttpOnly Cookie化 + CSRF対策
2. 入力検証の全面的な欠如 → Bean Validationの導入
3. トークン無効化メカニズムの欠如 → Redisブロックリスト実装
4. 監査ログの改ざん防止 → ログ署名またはCloudWatch Logs移行
5. P2P送金の限度額・受取人確認の欠如 → 限度額設定とフロー設計

これらを修正後、改善提案（データベース暗号化、MFA、WAF等）を段階的に実装することで、金融サービスとして許容可能なセキュリティレベルに到達できる。

**推奨される次のステップ**:
1. 本レビュー結果を元に設計書を改訂
2. セキュリティ専門家によるペネトレーションテスト計画の策定
3. OWASP Top 10（2021版）に対する詳細なチェックリスト作成
