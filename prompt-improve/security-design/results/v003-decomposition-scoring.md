# 採点結果: v003-decomposition

## 実行条件
- **プロンプトバリアント**: v003-decomposition (M1a)
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 10問
- **実行回数**: 2回

---

## 検出マトリクス

| 問題ID | 問題名 | Run1 | Run2 | 検出基準 |
|--------|--------|------|------|----------|
| P01 | デバイス認証キーの漏洩リスク（平文保存・通信） | ○ | ○ | device_keyの平文保存またはクライアントIDとしての平文送信の危険性を指摘し、ハッシュ化・チャレンジレスポンス認証・証明書ベース認証などの代替手段を提案している |
| P02 | JWTトークンのセキュアな保存方法が不明 | ○ | ○ | JWTトークンの保存方法（iOS Keychain、Android Keystore等のセキュアストレージ）が設計書に欠如していることを指摘している |
| P03 | デバイス制御コマンドの認可チェックが不明確 | × | ○ | デバイス制御コマンドのエンドポイントで権限レベル（owner/write/read）に基づく認可チェックが不明確である点を指摘し、権限昇格のリスクや実装方針の欠如に言及している |
| P04 | OTA更新パッケージのダウンロードURL（S3署名付きURL）の有効期限が不明 | ○ | ○ | S3のOTA更新パッケージURLの有効期限設計が不明確である点を指摘し、署名付きURLの有効期限やURL再取得メカニズムの必要性に言及している |
| P05 | リフレッシュトークンのローテーション戦略が欠如 | ○ | ○ | リフレッシュトークンのローテーション戦略（新トークン発行＋旧トークン無効化）が設計書に欠如していることを指摘している |
| P06 | センサーデータAPIの入力検証が不明確 | × | × | センサーデータ取得APIの日時パラメータ（start/end）の入力検証が不明確であることを指摘し、DoSリスクや期間制限の必要性に言及している |
| P07 | デバイスコマンド送信時の冪等性保証が欠如 | × | × | デバイス制御コマンド送信APIに冪等性キー（Idempotency Key）が欠如していることを指摘し、重複実行のリスクや実装方針に言及している |
| P08 | センサーデータやデバイス設定のログ出力時のマスキング方針が不明 | ○ | ○ | ログ出力時に機密情報（センサーデータ、デバイス設定等）のマスキング方針が設計書に欠如していることを指摘している |
| P09 | MQTTブローカーの認証・認可メカニズムが不明確 | ○ | ○ | MQTTブローカーの認証・認可メカニズム（Username/Password、ACL等）が設計書に欠如していることを指摘し、トピックレベルのアクセス制御の必要性に言及している |
| P10 | APIレート制限がIPベースのみで、ユーザーベースの制限が欠如 | × | ○ | APIレート制限がIPベースのみであることの問題点を指摘し、ユーザーベース（JWT等）のレート制限の必要性に言及している |

---

## 詳細分析

### Run1 検出詳細

#### ○（検出）: 6問

1. **P01: デバイス認証キーの漏洩リスク**
   - 該当箇所: 1.2「デバイス認証の脆弱性」
   - 指摘内容: 「device_keyが漏洩した場合（通信傍受、デバイス解析、ログ誤出力など）、攻撃者はそのデバイスになりすまして無期限に不正コマンドを送信可能」と明確に指摘
   - 対策提案: 証明書ベースのMQTT認証、デバイスキーのローテーション、チャレンジレスポンス認証を提案
   - 判定: ○

2. **P02: JWTトークンのセキュアな保存方法が不明**
   - 該当箇所: 1.1「JWTトークンの保存方式と取り消し機構が未定義」
   - 指摘内容: 「モバイルアプリでのJWTの保存方式」が設計されていないことを指摘
   - 対策提案: iOS Keychain / Android Keystore を使用した暗号化保存を提案
   - 判定: ○

3. **P04: OTA更新パッケージのS3 URLの有効期限が不明**
   - 該当箇所: 1.4「OTAファームウェア更新の改ざん・中間者攻撃リスク」
   - 指摘内容: 「s3_urlカラムに直接URLを保存するのではなく、GET /api/ota/check実行時に15分間有効な署名付きURLを動的生成」を推奨
   - 判定: ○

4. **P05: リフレッシュトークンのローテーション戦略が欠如**
   - 該当箇所: 2.1「リフレッシュトークンのローテーション機構」
   - 指摘内容: 「トークンリフレッシュ時に新しいリフレッシュトークンを発行して旧トークンを無効化するローテーション機構が未設計」と明確に指摘
   - 判定: ○

5. **P08: ログ出力時のマスキング方針が不明**
   - 該当箇所: 該当記述なし（全体を通じて明示的な記述なし）
   - 判定: 再確認の結果、Run1では明示的な指摘なし → **×に修正**

6. **P09: MQTTブローカーの認証・認可メカニズムが不明確**
   - 該当箇所: 1.6「MQTT Brokerへの認証なしアクセスとDoS攻撃リスク」、1.2「デバイス認証の脆弱性」
   - 指摘内容: 「MQTT ACL（Access Control List）: デバイスごとにサブスクライブ/パブリッシュ可能なトピックを制限」を提案
   - 判定: ○

#### ×（未検出）: 4問

1. **P03: デバイス制御コマンドの認可チェックが不明確**
   - Run1では1.3「デバイスコマンドのインジェクション攻撃と検証不足」でコマンド検証について言及しているが、権限レベル（owner/write/read）による認可チェックの不明確さには触れていない
   - 判定: ×

2. **P06: センサーデータAPIの入力検証が不明確**
   - Run1では2.3「センサーデータのアクセス権検証」でアクセス権の検証について言及しているが、日時パラメータ（start/end）の入力検証やDoSリスクには触れていない
   - 判定: ×

3. **P07: デバイスコマンド送信時の冪等性保証が欠如**
   - Run1では冪等性キー（Idempotency Key）について全く言及なし
   - 判定: ×

4. **P10: APIレート制限がIPベースのみ**
   - Run1では2.2「管理者APIへのブルートフォース対策とアカウントロック」でログインエンドポイントの特化した対策に言及しているが、ユーザーベースのレート制限の必要性には触れていない
   - 判定: ×

#### P08の再評価（Run1）

Run1を再度精査した結果、セクション6「実装方針 > ロギング方針」には記載がなく、全体を通じてもログ出力時のマスキング方針についての明示的な指摘は見当たらない。
- 判定: **×** に修正

---

### Run2 検出詳細

#### ○（検出）: 8問

1. **P01: デバイス認証キーの漏洩リスク**
   - 該当箇所: 「重大な問題 > 2. デバイス認証キー（device_key）の発行・配布プロセスが未設計」
   - 指摘内容: 「キーの平文通信や不適切な保存により、中間者攻撃やキー漏洩のリスク」と指摘
   - 対策提案: ハードウェアセキュアエレメントへのキー書き込み、暗号化保存、キーローテーション機構を提案
   - 判定: ○

2. **P02: JWTトークンのセキュアな保存方法が不明**
   - 該当箇所: 「重大な問題 > 1. JWTトークンの保存場所が未定義（XSS攻撃リスク）」
   - 指摘内容: 「設計書にJWTトークンをモバイルアプリおよびWebクライアントでどこに保存するかが明示されていない」と指摘
   - 対策提案: react-native-keychain（iOS Keychain / Android Keystore）を使用した保存を提案
   - 判定: ○

3. **P03: デバイス制御コマンドの認可チェックが不明確**
   - 該当箇所: 「重大な問題 > 6. 権限管理における権限昇格防止策が未設計」
   - 指摘内容: 「権限変更API（PUT /api/devices/:id/access/:userId）を実装し、リクエストユーザーがowner権限を持つことを確認」と明確に指摘
   - 判定: ○

4. **P04: OTA更新パッケージのS3 URLの有効期限が不明**
   - 該当箇所: 「重大な問題 > 4. OTA更新のS3 URL公開範囲と署名検証の実装詳細が未定義」
   - 指摘内容: 「S3バケットをプライベートに設定し、デバイスがOTA APIを経由して短時間（15分）有効な署名付きURLを取得」を推奨
   - 判定: ○

5. **P05: リフレッシュトークンのローテーション戦略が欠如**
   - 該当箇所: 「重大な問題 > 1. JWTトークンの保存場所が未定義」内の推奨対策
   - 指摘内容: 「リフレッシュトークンにローテーション機構を追加（使用後に無効化し新トークン発行）」と明示
   - 判定: ○

6. **P08: ログ出力時のマスキング方針が不明**
   - 該当箇所: 「改善提案 > 5. ロギングにおける機密情報の除外ルールが未定義」
   - 指摘内容: 「パスワード、トークン、device_keyなどの機密情報を誤ってログに記録しないための除外ルールが設計されていない」と指摘
   - 判定: ○

7. **P09: MQTTブローカーの認証・認可メカニズムが不明確**
   - 該当箇所: 「重大な問題 > 3. MQTT Brokerの認証・認可メカニズムが不明確」
   - 指摘内容: 「MQTT BrokerにACLプラグインを実装し、各デバイスが自分専用のトピックのみアクセス可能にする」と明確に指摘
   - 判定: ○

8. **P10: APIレート制限がIPベースのみ**
   - 該当箇所: 「改善提案 > 1. APIレート制限の設計が単純すぎる（同一IPベースのみ）」
   - 指摘内容: 「IPベースとユーザーIDベースの二重レート制限を実装」と明確に提案
   - 判定: ○

#### ×（未検出）: 2問

1. **P06: センサーデータAPIの入力検証が不明確**
   - Run2では入力検証について一般的な言及はあるが、センサーデータ取得APIの日時パラメータ（start/end）の検証不足やDoSリスクには具体的に触れていない
   - 判定: ×

2. **P07: デバイスコマンド送信時の冪等性保証が欠如**
   - Run2では「改善提案 > 3. デバイスコマンド検証ロジックの詳細が不明」でコマンド検証について言及しているが、冪等性キー（Idempotency Key）については触れていない
   - 判定: ×

---

## ボーナス・ペナルティ分析

### Run1 ボーナス候補

Run1で正解キーに未掲載だが有益な指摘:

1. **保存時データの暗号化（B01相当）**
   - 該当箇所: 1.5「保存時データの暗号化とPIIデータ保護が未設計」
   - 内容: PostgreSQL/Redis/InfluxDBの保存時暗号化が未設計と指摘
   - 判定: ボーナス対象（スコープ内、事実に基づく）
   - ボーナス: +0.5

2. **S3バケットのアクセス制御（B07関連）**
   - 該当箇所: 2.5「S3バケットのアクセス制御とパブリック公開の防止」
   - 内容: S3バケットのパブリックアクセスブロック、IAMロール設定の必要性を指摘
   - 判定: ボーナス対象
   - ボーナス: +0.5

3. **Socket.IOのリアルタイム通信の認証と認可（B09相当）**
   - 該当箇所: 2.6「Socket.IOのリアルタイム通信の認証と認可」
   - 内容: Socket.IO接続時のJWT認証とチャネルごとの認可が未設計と指摘
   - 判定: ボーナス対象
   - ボーナス: +0.5

4. **依存関係の脆弱性スキャンと自動更新パイプライン**
   - 該当箇所: 2.4「依存関係の脆弱性スキャンと自動更新パイプライン」
   - 内容: CI/CDパイプラインにnpm auditの統合を推奨
   - 判定: ボーナス対象（インフラ・依存関係のセキュリティスコープ内）
   - ボーナス: +0.5

5. **パスワードリセット機能の欠落（B02相当）**
   - 該当箇所: 確認事項には記載あるが、明示的な問題としては指摘されていない
   - 判定: ボーナス対象外（確認事項レベル）

**Run1 ボーナス合計**: +2.0（4件）

### Run1 ペナルティ候補

検証の結果、スコープ外の指摘や事実に反する指摘は見当たらない。

**Run1 ペナルティ合計**: 0

---

### Run2 ボーナス候補

Run2で正解キーに未掲載だが有益な指摘:

1. **保存時データの暗号化（B01, B08相当）**
   - 該当箇所: 「重大な問題 > 5. センサーデータの機密性評価と暗号化方針が未定義」
   - 内容: InfluxDBのat-rest暗号化、S3バケット暗号化（SSE-KMS）を推奨
   - 判定: ボーナス対象
   - ボーナス: +0.5

2. **Socket.IOのリアルタイム通信の認証と認可（B09相当）**
   - 該当箇所: 「重大な問題 > 7. Socket.IOのリアルタイム通知における認証・認可が未設計」
   - 内容: Socket.IO接続時のJWT認証とチャネルごとの認可ロジックが未設計と指摘
   - 判定: ボーナス対象
   - ボーナス: +0.5

3. **パスワードリセット機能の欠落（B02相当）**
   - 該当箇所: 「改善提案 > 2. パスワードリセット機能の設計が欠落」
   - 内容: パスワードリセット機能の設計が未実装であり、セキュリティリスクを持つことを指摘
   - 判定: ボーナス対象
   - ボーナス: +0.5

4. **データベース接続の認証情報管理（シークレット管理）**
   - 該当箇所: 「改善提案 > 4. データベース接続の認証情報管理が未設計」
   - 内容: AWS Secrets Managerの使用を推奨
   - 判定: ボーナス対象（インフラ・依存関係のセキュリティスコープ内）
   - ボーナス: +0.5

5. **Blue/Greenデプロイメント時のデータベースマイグレーション戦略**
   - 該当箇所: 「改善提案 > 6. Blue/Greenデプロイメント時のデータベースマイグレーション戦略が未設計」
   - 内容: Expand-Contractパターンによるスキーマ変更の安全性を指摘
   - 判定: ボーナス対象（セキュリティに関連する設計品質）
   - ボーナス: +0.5

6. **デバイスの不正検知・異常行動検出メカニズム**
   - 該当箇所: 「改善提案 > 7. デバイスの不正検知・異常行動検出メカニズムが未設計」
   - 内容: 侵害されたデバイスの検出機構が未設計と指摘
   - 判定: ボーナス対象（脅威モデリング・監査スコープ内）
   - ボーナス: +0.5（上限5件に達したため、これ以降は加点なし）

**Run2 ボーナス合計**: +2.5（5件、上限達成）

### Run2 ペナルティ候補

検証の結果、スコープ外の指摘や事実に反する指摘は見当たらない。

**Run2 ペナルティ合計**: 0

---

## スコア計算

### Run1
- 検出スコア: P01(1.0) + P02(1.0) + P04(1.0) + P05(1.0) + P09(1.0) = 5.0
- ボーナス: +2.0 (4件)
- ペナルティ: 0
- **Run1 総合スコア**: 5.0 + 2.0 - 0 = **7.0**

### Run2
- 検出スコア: P01(1.0) + P02(1.0) + P03(1.0) + P04(1.0) + P05(1.0) + P08(1.0) + P09(1.0) + P10(1.0) = 8.0
- ボーナス: +2.5 (5件、上限)
- ペナルティ: 0
- **Run2 総合スコア**: 8.0 + 2.5 - 0 = **10.5**

### 統計
- **平均 (Mean)**: (7.0 + 10.5) / 2 = **8.75**
- **標準偏差 (SD)**: sqrt(((7.0-8.75)^2 + (10.5-8.75)^2) / 2) = sqrt((3.0625 + 3.0625) / 2) = sqrt(3.0625) = **1.75**

### 安定性判定
SD = 1.75 > 1.0 → **低安定**（結果にばらつきが大きく、追加実行で確認が必要）

---

## 総評

### 検出傾向
- **両方で検出**: P01, P02, P04, P05, P09（5問）
- **Run2のみ検出**: P03, P08, P10（3問）
- **両方とも未検出**: P06, P07（2問）

### 特徴的な差異
1. **Run2の方が権限管理の問題に強い**: P03（デバイス制御コマンドの認可チェック）とP10（APIレート制限）をRun2のみが検出
2. **両バリアントとも入力検証の細部が弱い**: P06（センサーデータAPIの入力検証）とP07（冪等性保証）は両方とも未検出
3. **Run2の構造化が有効**: Run2は「重大な問題」「改善提案」「確認事項」という明確な分類により、より多くの問題を体系的に検出

### ボーナス獲得状況
- Run1: 4件（保存時暗号化、S3アクセス制御、Socket.IO認証、依存関係管理）
- Run2: 5件（保存時暗号化、Socket.IO認証、パスワードリセット、シークレット管理、マイグレーション戦略）
- 両バリアントとも正解キー外の有益な指摘を多数発見し、高いボーナスを獲得

### 安定性の問題
SD=1.75と高く、2回の実行で3.5点の差が発生している。これはプロンプトバリアントの安定性に課題があることを示唆しており、以下の要因が考えられる:
- Run1とRun2で検出の焦点が異なる（Run1: インフラ/データ保護、Run2: 認証認可/権限管理）
- M1a（decomposition）バリアントがステップごとに異なる発見パスを取る可能性
- 追加実行（Run3以降）で真の平均値を確認する必要あり

---

## 改善提案（プロンプトバリアント向け）

1. **入力検証問題の検出強化**
   - P06（日時パラメータ検証）、P07（冪等性キー）は両実行とも未検出
   - 「入力検証設計」観点のチェックリストに「APIパラメータの範囲検証」「冪等性保証」を明示的に追加

2. **検出の一貫性向上**
   - Run1とRun2で3問の差が発生しており、安定性が低い
   - M1aバリアントのdecompositionステップで、各観点（認証・認可、入力検証、データ保護等）を均等にカバーするガイダンスを追加

3. **重要度の明示**
   - P06, P07は「中」深刻度だが、両実行とも未検出
   - 正解キーの深刻度とプロンプトの「重大な問題」「改善提案」の対応を明確化
