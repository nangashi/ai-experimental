# セキュリティ設計レビュー結果

## スコアサマリ

| 観点 | スコア (1-5) | 主な理由 |
|-----|-------------|---------|
| 脅威モデリング（STRIDE） | 2 | Repudiation対策（否認防止）が不十分、DoS対策が未設計 |
| 認証・認可設計 | 2 | JWT有効期限が長すぎ、リフレッシュトークンなし、セッション管理の脆弱性 |
| データ保護 | 1 | マイナンバー・口座番号が平文保存、秘密情報が環境変数に平文設定 |
| 入力検証設計 | 3 | 入力検証方針が明示されていない、ファイルアップロード制限が未設計 |
| インフラ・依存関係 | 2 | シークレット管理が不適切、依存関係の脆弱性管理が未設計 |
| **総合** | **2.0** | |

## 重大な問題（設計の修正が必須）

### 1. マイナンバー・口座番号の平文保存
- **問題の説明**: セクション7.2で「マイナンバー・口座番号はデータベースに保存（暗号化なし）」と明記されており、個人番号法違反およびデータ漏洩時の重大リスク
- **影響**: データベース侵害時にマイナンバー・口座番号が即座に漏洩。個人番号法第20条（安全管理措置義務）違反により、個人情報保護委員会から是正勧告・罰則の対象となる。最大で4年以下の懲役または200万円以下の罰金
- **推奨対策**:
  - マイナンバー: AES-256-GCMで暗号化し、暗号化鍵はAWS KMSで管理。データキーをテナントごとにローテーション
  - 口座番号: 同様にAES-256-GCMで暗号化。または、トークン化サービス（AWS Payment Cryptographyなど）でマスキング
  - データベース層でのTDE（Transparent Data Encryption）も併用し、多層防御を実現
- **該当箇所**: セクション4.1 employees テーブル、セクション7.2 セキュリティ要件

### 2. JWT署名鍵とデータベースパスワードの平文環境変数設定
- **問題の説明**: セクション6.5で「秘密情報（JWT署名鍵、データベースパスワード）は環境変数に平文で設定」と記載。コンテナイメージの検査やログ出力で鍵が漏洩するリスク
- **影響**: JWT署名鍵が漏洩すると、攻撃者が任意のユーザーになりすました有効なトークンを生成可能。データベースパスワード漏洩で全データへの直接アクセスが可能
- **推奨対策**:
  - AWS Secrets ManagerまたはParameter Store（SecureString）に移行
  - アプリケーション起動時にSDKでシークレットを取得（コード例: `SecretsManagerClient.getSecretValue()`）
  - ECS TaskのIAMロールでシークレットアクセス権限を制限
  - シークレットの自動ローテーション（90日ごと）を有効化
- **該当箇所**: セクション6.5 デプロイメント方針

### 3. JWT有効期限が24時間で長すぎ、リフレッシュトークンなし
- **問題の説明**: セクション3.3で「JWT発行（有効期限24時間）」、セクション6.1で「リフレッシュトークンは発行せず」と記載。トークン窃取時の被害期間が長い
- **影響**: XSS脆弱性やネットワーク盗聴でトークンが窃取された場合、最大24時間にわたってアカウント乗っ取りが可能。給与情報の閲覧、勤怠記録の改ざん、従業員情報の漏洩が発生
- **推奨対策**:
  - アクセストークンの有効期限を15分に短縮
  - リフレッシュトークン（有効期限7日、HttpOnly Cookie）を導入
  - リフレッシュトークンのローテーション（RFC 8693）を実装：新トークン発行時に旧トークンを無効化
  - `/api/auth/refresh`エンドポイントでリフレッシュトークンからアクセストークンを再発行
  - リフレッシュトークンをデータベースに保存し、強制ログアウト機能を実装
- **該当箇所**: セクション3.3 データフロー、セクション6.1 認証・認可方式

### 4. 個人情報をログに出力
- **問題の説明**: セクション6.3で「個人情報（氏名、メール、給与額）はログに出力する」と明記。個人情報保護法違反およびログ経由の情報漏洩リスク
- **影響**: ログ集約サービス（Datadog）の管理画面アクセス権を持つ攻撃者が個人情報を大量に取得可能。また、ログのアクセス制御が不十分な場合、開発者全員が個人情報を閲覧できてしまう
- **推奨対策**:
  - 個人情報をログから完全に除外。デバッグ時はユーザーIDのみを出力
  - やむを得ず出力する場合はマスキング処理（例: `yamada@example.com` → `ya***@ex***.com`）
  - ログ出力前に個人情報検出フィルタを実装（正規表現でメールアドレス、電話番号、数値をスキャン）
  - Datadogのアクセス制御でログ閲覧権限を最小限に制限
- **該当箇所**: セクション6.3 ロギング方針

### 5. Row-Level Securityのみに依存したテナント分離
- **問題の説明**: セクション3.3で「Row-Level SecurityでテナントID自動フィルタ」とあるが、アプリケーション層での検証が明記されていない。PostgreSQL RLSの設定ミスでテナント間データ漏洩が発生するリスク
- **影響**: RLSポリシーの誤設定や無効化により、別テナントのデータが漏洩。例えば、`ALTER TABLE employees DISABLE ROW LEVEL SECURITY`が誤実行されると全テナントのデータが横断アクセス可能
- **推奨対策**:
  - アプリケーション層で多層防御を実装：サービス層で全SQLクエリに`WHERE tenant_id = :tenantId`を強制付与
  - JWTトークンから抽出したテナントIDとリクエストパラメータのテナントIDを照合
  - Spring Bootのインターセプターでテナントコンテキストを検証
  - RLSポリシーの定期監査（週次）と、ポリシー無効化時のアラート設定
  - 統合テストでクロステナントアクセスのネガティブテストを実装
- **該当箇所**: セクション3.3 データフロー

### 6. レート制限・ブルートフォース対策が未設計
- **問題の説明**: ログインエンドポイント（`/api/auth/login`）やAPI全体にレート制限の記載がない。ブルートフォース攻撃でパスワードが突破されるリスク
- **影響**: 攻撃者が自動化ツールで毎秒100回のログイン試行を実行し、弱いパスワードのアカウントを突破。特に管理者アカウントが侵害されると全データへのアクセス権を取得
- **推奨対策**:
  - Spring Bootのrate-limiter（Bucket4j 8.x）で実装
  - `/api/auth/login`: IPアドレスあたり5回/15分、ユーザーアカウントあたり5回/15分
  - 5回失敗後はアカウントを30分間ロック（`account_locked_until`カラムをemployeesテーブルに追加）
  - 全APIエンドポイント: IPあたり1000回/時間のグローバル制限
  - 管理者エンドポイント（`/api/employees/*`, `/api/payroll/*`）: さらに厳しい100回/時間
  - レート制限超過時は429 Too Many Requestsとヘッダー`Retry-After`を返却
- **該当箇所**: セクション5.1 認証・認可エンドポイント

## 改善提案（設計の品質向上に有効）

### 1. CSRF対策が未設計
- **提案の説明**: state-changingエンドポイント（POST/PUT/DELETE）にCSRF対策の記載がない。SPAでもCookieベース認証を併用する場合は必要
- **理由**: 現在の設計ではJWTをAuthorizationヘッダーで送信しているため、CSRFの直接的リスクは低い。ただし、将来的にCookieベース認証に移行する可能性や、ブラウザの認証情報自動送信機能（Cookieなど）を使う場合に備えるべき
- **推奨対策**: Spring SecurityのCSRF保護を有効化（`CsrfTokenRepository`）。または、Cookieを使わない場合は明示的に「CSRFトークンは不要（理由: Authorization ヘッダーのみ使用）」と設計書に記載

### 2. 給与計算バッチのインジェクション防止が未設計
- **提案の説明**: セクション5.3の`POST /api/payroll/calculate`でemployee_idsの配列を受け取るが、SQLインジェクション対策が明記されていない
- **理由**: ユーザー入力（employee_ids）がSQL文字列に連結される場合、`' OR '1'='1`のようなペイロードでクエリが改ざんされるリスク
- **推奨対策**:
  - PreparedStatementまたはJPAのパラメータバインディングを使用（設計書に明記）
  - employee_idsの各要素がUUID形式であることをバリデーション（正規表現: `^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$`）
  - 配列サイズの上限を設定（例: 最大1000件）

### 3. S3バケットのアクセス制御が未設計
- **提案の説明**: セクション2.2で「Amazon S3（給与明細PDF、契約書類）」とあるが、バケットポリシーやIAMロールの設計が記載されていない
- **理由**: S3バケットがパブリックアクセス可能に設定されていると、給与明細PDFがURLを知る誰でもダウンロード可能
- **推奨対策**:
  - S3バケットのパブリックアクセスを完全にブロック（Block Public Access設定）
  - 署名付きURL（Pre-signed URL）で一時的なダウンロードリンクを生成（有効期限15分）
  - ECS TaskのIAMロールでS3アクセス権限を付与（特定バケットのみ）
  - オブジェクトキーにテナントIDを含め、アプリケーション層で検証（例: `s3://bucket/{tenantId}/payroll/{employeeId}/{month}.pdf`）

### 4. パスワード複雑性要件が未定義
- **提案の説明**: セクション6.1で「パスワードはbcryptでハッシュ化」とあるが、パスワード作成時の複雑性要件（最小長、文字種類）が記載されていない
- **理由**: 弱いパスワード（例: `password123`）が許可されると、bcryptでハッシュ化していてもブルートフォース攻撃で突破されるリスクが高まる
- **推奨対策**:
  - パスワード要件を定義：最小12文字、大小英字・数字・記号を各1文字以上含む
  - 共通パスワード辞書（Have I Been Pwned APIなど）との照合
  - パスワード変更時に過去3世代との重複を禁止
  - 初期パスワードは人事担当者が設定し、初回ログイン時に強制変更

### 5. 監査ログの改ざん防止策が未設計
- **提案の説明**: セクション6.3で「監査ログ: 認証イベント、権限エラー、給与計算実行、従業員情報更新をすべて記録」とあるが、ログの改ざん防止策が記載されていない
- **理由**: 攻撃者がデータベースやログサーバーへのアクセス権を得た場合、不正操作の痕跡を消すためにログを削除・改ざんする可能性
- **推奨対策**:
  - ログをCloudWatch Logsに送信し、IAMポリシーで削除権限を制限（Read-Onlyロール）
  - CloudWatch Logs Insightsでログの整合性チェック（タイムスタンプの連続性検証）
  - 重要操作（給与計算、従業員削除）のログをS3にアーカイブし、Object Lockで削除不可能に設定
  - ログの署名付きハッシュチェーン（各ログエントリに前エントリのハッシュを含める）

### 6. セッション管理の脆弱性
- **提案の説明**: セクション3.3でRedisにセッション情報を保存するとあるが、セッション固定攻撃対策やセッションタイムアウトが記載されていない
- **理由**: セッションIDが変更されない場合、攻撃者が事前に取得したセッションIDでユーザーをログインさせ、セッションを乗っ取る（Session Fixation）
- **推奨対策**:
  - ログイン成功時に新しいセッションIDを生成（`HttpSession.invalidate()` → `request.getSession(true)`）
  - RedisのTTL（Time To Live）でセッションを自動期限切れ（24時間→1時間に短縮）
  - 非アクティブタイムアウト（30分操作がない場合は強制ログアウト）を実装

### 7. ファイルアップロード機能のセキュリティ対策が未設計
- **提案の説明**: 採用管理で履歴書や契約書のアップロードが想定されるが、ファイル検証の設計が記載されていない
- **理由**: 悪意あるファイル（Webshell、マルウェア）がアップロードされると、サーバー侵害やストレージ消費攻撃のリスク
- **推奨対策**:
  - ファイルサイズ制限（例: 最大10MB）
  - 許可する拡張子のホワイトリスト（`.pdf`, `.docx`, `.png`, `.jpg`のみ）
  - MIMEタイプ検証（Content-Typeヘッダーとファイル内容の整合性チェック）
  - アップロードされたファイルをS3に直接保存し、アプリケーションサーバーのファイルシステムには保存しない
  - ウイルススキャン（ClamAVまたはAWS Malware Protection）をアップロード後に実行

### 8. データベース接続のTLS暗号化が未設計
- **提案の説明**: セクション2.2でPostgreSQL 15を使用するとあるが、アプリケーション⇔データベース間の通信暗号化が記載されていない
- **理由**: ネットワーク盗聴でSQL文やクエリ結果（マイナンバー、給与額など）が平文で漏洩するリスク
- **推奨対策**:
  - RDS PostgreSQLで強制SSL接続を有効化（`rds.force_ssl=1`）
  - JDBCドライバのSSLモード設定: `jdbc:postgresql://host:5432/db?ssl=true&sslmode=require`
  - RDS証明書の検証（`sslmode=verify-full`）で中間者攻撃を防止

## 確認事項（ユーザーへの確認が必要）

### 1. マルチファクタ認証（MFA）の要否
- **確認理由**: 人事担当者や管理者は給与・個人情報への広範なアクセス権を持つため、パスワード単独では不十分。ただしMFA導入はユーザビリティとコストのトレードオフがある
- **選択肢とトレードオフ**:
  - **選択肢A**: 全ユーザーにTOTP（Time-based One-Time Password）を必須化
    - メリット: セキュリティ最大化、アカウント乗っ取りリスク大幅減少
    - デメリット: 全従業員にMFAアプリ（Google Authenticatorなど）の導入が必要、ヘルプデスク負荷増
  - **選択肢B**: HR_MANAGER, ADMIN ロールのみMFA必須、一般従業員は任意
    - メリット: 高権限アカウントを重点的に保護、従業員の負担は最小限
    - デメリット: 一般従業員アカウントが侵害された場合、自分の給与明細や勤怠記録は漏洩
  - **推奨**: 選択肢Bを推奨（段階的導入）

### 2. データ保持・削除ポリシー
- **確認理由**: 退職者のデータをいつまで保持するか、削除時の手順が設計に含まれていない。個人情報保護法では「利用目的達成後は速やかに削除」が原則
- **選択肢とトレードオフ**:
  - **選択肢A**: 退職後7年間保持（労働基準法の帳簿保存義務）、その後自動削除
    - メリット: 法的義務を満たし、監査対応可能
    - デメリット: 7年間は個人情報が残り続ける
  - **選択肢B**: 退職後1年でアーカイブ（匿名化）、7年後に完全削除
    - メリット: プライバシー保護と法的義務のバランス
    - デメリット: アーカイブ処理の実装コスト

### 3. 本番環境でのデータマスキング要否
- **確認理由**: 開発・ステージング環境で本番データのコピーを使う場合、個人情報保護のためマスキングが必要。ただし、マスキングツールのコストと工数がかかる
- **選択肢とトレードオフ**:
  - **選択肢A**: 非本番環境では合成データのみ使用（実データは使わない）
    - メリット: 個人情報漏洩リスクゼロ
    - デメリット: 本番環境と異なるデータパターンでテストの精度が低下
  - **選択肢B**: 本番データをコピーし、個人情報フィールドをマスキング（例: 氏名→ランダム文字列、給与額→一律30万円）
    - メリット: データ構造は本番と同一、テスト精度向上
    - デメリット: マスキングツール（Delphix, AWS Glue DataBrewなど）のコスト、定期同期の運用負荷

## 評価（良い点）

### 1. パスワードのbcryptハッシュ化
- セクション7.2で「パスワードはbcryptでハッシュ化（work factor 10）」と明記されている点は適切。bcryptは計算コストが高く、レインボーテーブル攻撃に強い。work factor 10は現時点（2024年）で妥当なバランス

### 2. HTTPS通信の全面採用
- セクション7.2で「通信は全てHTTPSで暗号化」と記載されており、中間者攻撃や盗聴を防ぐ基本対策が含まれている

### 3. 監査ログの包括的な記録
- セクション6.3で「認証イベント、権限エラー、給与計算実行、従業員情報更新をすべて記録」とあり、インシデント発生時の追跡が可能な設計。特に給与計算実行のログは不正操作の検出に有効

### 4. テナントIDによるマルチテナント分離
- セクション4.1で全テーブルに`tenant_id`カラムが含まれており、データ分離の基本設計は存在する。Row-Level Securityとの組み合わせで多層防御が可能（ただし、アプリケーション層の追加検証が必要）

### 5. 権限ベースのアクセス制御（RBAC）
- セクション5.2-5.4で各エンドポイントに`HR_MANAGER`, `ADMIN`などのロールベース権限が定義されており、職務分離の原則に従っている。特に`DELETE /api/employees/{id}`がADMINのみに制限されている点は適切
