# TravelHub システム設計書 - セキュリティレビュー結果

## 総合評価

本設計書は基本的なセキュリティ対策（HTTPS通信、パスワードハッシュ化、JWT認証、レート制限）を明示していますが、**複数の重大なセキュリティ設計要素が欠落**しています。特に、入力検証ポリシー、CSRF/XSS対策、監査ログ、冪等性保証、データ保護ポリシー、エラー情報露出対策などが未定義であり、本番環境での運用には重大なセキュリティリスクが存在します。

---

## 評価結果サマリ

| 評価項目 | スコア | 重大度 |
|---------|--------|--------|
| 1. 脅威モデリング（STRIDE） | 2 | 重大 |
| 2. 認証・認可設計 | 3 | 中程度 |
| 3. データ保護 | 2 | 重大 |
| 4. 入力検証設計 | 1 | 致命的 |
| 5. インフラ・依存関係セキュリティ | 3 | 中程度 |

---

## 致命的問題（スコア1: 即座の対応が必要）

### 1. 入力検証設計の欠落（スコア: 1）

**問題の詳細:**
設計書全体を通じて、**入力検証ポリシーが一切定義されていません**。以下の重大な欠陥があります:

1. **バリデーションルールの未定義**
   - 予約APIの `bookingDetails` はJSONB型で任意構造を受け入れるが、検証ルールが不明
   - パスポート番号、フライト番号、日付形式、金額の検証基準が未定義
   - ユーザー入力（email, phone_number, full_name）の形式・長さ制限が未定義

2. **インジェクション攻撃対策の欠落**
   - SQLインジェクション対策（パラメータ化クエリの使用義務）が明示されていない
   - Elasticsearchクエリインジェクション対策が未定義
   - JSONB型への任意JSON注入リスクが検討されていない

3. **出力エスケープ戦略の未定義**
   - XSS対策のための出力エスケープポリシーが存在しない
   - JSONレスポンスのサニタイゼーション方針が不明

4. **ファイルアップロード制限の欠落**
   - パスポート画像や領収書アップロード機能の存在可能性があるが、ファイルタイプ制限・サイズ制限・スキャン要件が未定義

**影響:**
- **SQLインジェクション**: データベース全体の侵害、全ユーザー情報・予約情報・決済履歴の漏洩
- **XSS攻撃**: セッショントークン窃取、フィッシング、ユーザーアカウント乗っ取り
- **JSONB型インジェクション**: 任意データ挿入による決済金額改ざん、予約情報偽装

**推奨対策:**
1. **入力検証ポリシー文書の作成**（設計書セクション6に追加）:
   ```markdown
   ### 入力検証ポリシー

   #### バリデーションルール
   - email: RFC 5322準拠、最大255文字
   - phone_number: E.164形式、10-15桁
   - full_name: 最大255文字、Unicode文字（制御文字除く）
   - passport_number: 6-9文字の英数字
   - total_amount: 0以上1,000,000以下、小数点2桁まで
   - bookingDetails: 事前定義されたJSONスキーマに厳密に準拠

   #### インジェクション対策
   - すべてのDBクエリはSpring Data JPAのパラメータ化クエリを使用（生SQLの禁止）
   - Elasticsearchクエリは専用クエリビルダーAPIを使用（文字列連結の禁止）
   - JSONB型カラムへの書き込みは事前定義スキーマによる検証後のみ許可

   #### 出力エスケープ
   - すべてのJSONレスポンスはJacksonライブラリの自動エスケープを使用
   - HTMLコンテンツを返す場合はOWASP Java HTML Sanitizerを使用

   #### ファイルアップロード
   - 許可ファイルタイプ: image/jpeg, image/png, application/pdf（MIMEタイプ・マジックナンバー両方で検証）
   - 最大ファイルサイズ: 5MB
   - アップロードファイルはClamAVでウイルススキャン実施
   ```

2. **バリデーションレイヤーの設計追加**:
   - Bean Validation (JSR 380)を使用したDTOレベルの検証
   - カスタムバリデータによるビジネスルール検証
   - Elasticsearch入力サニタイゼーションユーティリティの実装

---

## 重大問題（スコア2: 本番環境で高確率の攻撃リスク）

### 2. 脅威モデリング（STRIDE）の不足（スコア: 2）

**問題の詳細:**
STRIDE脅威モデルに基づく設計レベルの検討が欠落しています:

1. **Spoofing（なりすまし）**
   - JWT署名検証の実装詳細が不明（公開鍵管理、鍵ローテーション）
   - サプライヤーAPI呼び出し時の相互TLS認証の有無が未定義

2. **Tampering（改ざん）**
   - 予約変更API（`PUT /api/v1/bookings/{id}`）の改ざん防止策が不明
   - `total_amount` の整合性チェック（クライアント送信額 vs サーバー計算額）が未定義

3. **Repudiation（否認防止）**
   - **監査ログ設計が完全に欠落**（致命的）
   - 決済トランザクション、予約変更、管理者操作のログ記録要件が未定義

4. **Information Disclosure（情報漏洩）**
   - エラーメッセージでのスタックトレース露出防止策が不明
   - CloudWatchログにPII（個人識別情報）が含まれる場合のマスキング方針が未定義

5. **Denial of Service（サービス拒否）**
   - API Gatewayのレート制限（100req/min）は存在するが、リソース消費型攻撃（大量検索、複雑クエリ）への対策が不明
   - サプライヤーAPI遅延時のタイムアウト・サーキットブレーカー設定が未定義

6. **Elevation of Privilege（権限昇格）**
   - USER→ADMIN昇格の防止策が明示されていない（`role`カラムの更新可否、APIでの変更禁止など）

**影響:**
- **監査ログ欠落**: 不正アクセス・内部犯行の検出不能、コンプライアンス違反
- **改ざん**: 決済金額の不正変更、予約内容の偽装
- **情報漏洩**: エラーメッセージ経由でのDB構造・内部実装の露出

**推奨対策:**
1. **監査ログ設計の追加**（セクション6に追加）:
   ```markdown
   ### 監査ログ設計

   #### 記録対象イベント
   - 認証: ログイン成功/失敗、パスワードリセット、JWT発行/無効化
   - 認可: 権限不足による拒否、ロール変更試行
   - データ変更: 予約作成/変更/削除、ユーザー情報変更、管理者操作
   - 決済: 決済実行、払い戻し、Stripe Webhook受信

   #### ログ項目
   - タイムスタンプ、ユーザーID、操作種別、対象リソースID、IPアドレス、User-Agent、操作結果（成功/失敗）

   #### 保存先・保持期間
   - CloudWatch Logsに送信、S3に90日間アーカイブ
   - 決済関連ログは7年間保持（PCI DSS準拠）

   #### ログ保護
   - 監査ログの改ざん防止（S3 Object Lock、CloudWatch Logs暗号化）
   - 管理者による監査ログ削除の禁止
   ```

2. **改ざん防止策の明記**:
   - `total_amount` はサーバー側で再計算し、クライアント送信値と照合
   - 予約変更時は変更前データをバージョン管理テーブルに記録

3. **エラー情報露出防止**:
   - 本番環境ではスタックトレースを返さない（エラーIDのみ返却、詳細はサーバーログに記録）
   - CloudWatchログからPII（email, phone_number, passport_number）を自動マスキング

### 3. データ保護の不備（スコア: 2）

**問題の詳細:**

1. **保存時の暗号化仕様の欠落**
   - PostgreSQL、Redisの保存時暗号化（Encryption at Rest）の有無が未定義
   - 暗号化キー管理方針（AWS KMS使用、鍵ローテーション）が不明

2. **データ保持・削除ポリシーの欠落**
   - アカウント削除時の個人情報削除範囲が不明（予約履歴、決済履歴の取り扱い）
   - GDPR「忘れられる権利」への対応方針が未定義
   - バックアップからの個人情報削除手順が不明

3. **PIIの最小化方針の欠落**
   - パスポート番号の保存必要性が検討されていない（サプライヤー送信後は削除可能か）
   - ログ・分析データへのPII混入防止策が未定義

4. **通信暗号化の詳細不足**
   - サプライヤーAPI呼び出し時のTLS証明書検証方針が不明
   - Redis接続の暗号化（TLS in-transit）の有無が未定義

**影響:**
- **個人情報漏洩**: RDS/Redisのストレージ侵害時にパスポート番号・決済情報が平文で露出
- **コンプライアンス違反**: GDPR、個人情報保護法違反による罰金・信用失墜

**推奨対策:**
1. **データ保護ポリシーの追加**（セクション7に追加）:
   ```markdown
   ### データ保護ポリシー

   #### 保存時暗号化
   - RDS: AES-256暗号化を有効化、AWS KMSでキー管理
   - Redis: ElastiCache暗号化（at-rest/in-transit）を有効化
   - 暗号化キーは年1回ローテーション

   #### データ保持・削除
   - アカウント削除時: users.email/phone_numberを匿名化（"deleted-{uuid}@example.com"）
   - 予約・決済履歴: 法的保持期間（7年）経過後に自動削除
   - バックアップ: 削除リクエストから30日後に手動でバックアップからも削除

   #### PIIの最小化
   - パスポート番号は予約確定後24時間で削除（サプライヤー送信完了後）
   - ログへのPII出力を禁止（Logback PatternLayout でマスキング）
   ```

2. **通信暗号化の明記**:
   - サプライヤーAPI呼び出し時はTLS証明書ピンニングを実施
   - Redis接続は必ずTLS接続を使用

---

## 中程度問題（スコア3: 特定条件下で悪用可能）

### 4. 認証・認可設計の改善余地（スコア: 3）

**問題の詳細:**

1. **CSRF対策の欠落**
   - 状態変更API（予約作成、決済、アカウント削除）のCSRF対策が未定義
   - Spring SecurityのCSRFトークン使用の有無が不明

2. **セッション管理の詳細不足**
   - JWT無効化時の処理詳細が不明（Redisからの削除タイミング、ブラックリスト方式の採用）
   - 複数デバイスログイン時の同時セッション数制限が未定義

3. **パスワードポリシーの欠落**
   - パスワード複雑性要件（最小長、文字種）が未定義
   - パスワード履歴管理（過去N回分の再利用禁止）が不明

4. **トークン署名鍵の管理不足**
   - JWT署名に使用するHS256秘密鍵の保管方法（AWS Secrets Manager使用など）が不明
   - 鍵漏洩時のローテーション手順が未定義

5. **権限管理の粒度不足**
   - USER/ADMINの2ロールのみでは、将来的な要件（サプライヤー管理者、カスタマーサポート）に対応困難
   - リソースレベルの認可（自分の予約のみ変更可能など）の実装方針が不明

**影響:**
- **CSRF攻撃**: ログイン中ユーザーの意図しない予約・決済実行
- **トークン漏洩時の被害拡大**: 鍵ローテーション手順未定義により、漏洩後も長期間不正利用継続

**推奨対策:**
1. **CSRF対策の追加**:
   - Spring SecurityのCSRFトークン機能を有効化
   - SameSite=Strict属性をCookieに設定

2. **トークン管理の強化**:
   - JWT署名鍵はAWS Secrets Managerで管理
   - 鍵ローテーション時は旧鍵での検証も7日間継続（グレースピリオド）

3. **パスワードポリシーの定義**:
   - 最小8文字、英数字+記号を含む
   - 過去3回分のパスワード再利用を禁止

### 5. インフラ・依存関係セキュリティの改善余地（スコア: 3）

**問題の詳細:**

1. **シークレット管理の詳細不足**
   - Stripe APIキー、JWT署名鍵、DB接続情報の保管方法が未定義
   - 環境変数経由での注入方法、ローテーション手順が不明

2. **依存関係の脆弱性管理方針の欠落**
   - Mavenライブラリの脆弱性スキャンツール（OWASP Dependency-Check、Snyk）の使用が未定義
   - 脆弱性発見時の対応SLA（Critical: 24時間以内、High: 7日以内など）が不明

3. **ネットワークセキュリティの詳細不足**
   - VPC設計、サブネット分離（public/private）の有無が未定義
   - セキュリティグループ設定（最小権限の原則）が不明
   - WAF（AWS WAF）の使用有無、ルール設定が未定義

4. **デプロイメントセキュリティの不足**
   - コンテナイメージの脆弱性スキャン（Trivy、ECR Scanning）が未定義
   - 本番環境へのデプロイ承認プロセス（手動承認、4-eyesプリンシプル）が不明

**影響:**
- **シークレット漏洩**: GitHubリポジトリへの誤コミット、CloudWatchログへの露出
- **既知の脆弱性悪用**: Log4Shell等の公開脆弱性を経由した侵害

**推奨対策:**
1. **シークレット管理方針の追加**:
   - すべてのシークレットはAWS Secrets Managerで管理
   - ECS Fargateタスク起動時に環境変数として注入
   - 四半期ごとにシークレットをローテーション

2. **依存関係管理の強化**:
   - GitHub Dependabotを有効化、週次で脆弱性チェック
   - Critical脆弱性は24時間以内にパッチ適用

3. **ネットワーク分離の明記**:
   - VPC内にpublicサブネット（API Gateway）、privateサブネット（ECS、RDS）を分離
   - RDSは外部インターネットからアクセス不可
   - AWS WAFでSQL Injection、XSS署名ルールを有効化

---

## 軽微な改善提案（スコア4相当）

### 6. 冪等性保証の欠落

**問題:**
決済API（`POST /api/v1/payments`）、予約作成APIの冪等性メカニズム（Idempotency Key）が未定義。ネットワークエラー時の重複リクエストによる二重決済・二重予約のリスクがあります。

**推奨対策:**
- Stripe Idempotency Keyをクライアントから受け取り、24時間以内の同一キーリクエストは同一レスポンスを返す
- 冪等性キーテーブル（key, response_cache, expires_at）を用意

### 7. レート制限の粒度不足

**問題:**
API Gateway全体で100req/minの制限のみ。ログイン試行、パスワードリセットなどの機密操作に対する個別制限が未定義。

**推奨対策:**
- ログインAPI: 同一IPから5回/分、10回/時
- パスワードリセット: 同一emailに3回/時
- 決済API: 同一ユーザーに10回/分

### 8. Content Security Policy (CSP) の欠落

**問題:**
フロントエンドのXSS対策として、CSPヘッダーの設定が未定義。

**推奨対策:**
- CloudFrontレスポンスヘッダーでCSPを設定: `default-src 'self'; script-src 'self' https://js.stripe.com`

---

## 評価詳細

### 1. 脅威モデリング（STRIDE）: スコア 2

**評価理由:**
- 監査ログ設計の完全欠落により、Repudiation（否認防止）対策が不在
- 改ざん防止策（total_amount検証、予約変更履歴）が未定義
- エラー情報露出防止策が不明確
- DoS対策が部分的（レート制限のみ、リソース消費型攻撃への対策不足）

**必要な対策:**
- 監査ログ設計の完全な追加（対象イベント、ログ項目、保持期間、保護方法）
- 改ざん防止メカニズムの明記
- サーキットブレーカー、タイムアウト設定の定義

### 2. 認証・認可設計: スコア 3

**評価理由:**
- JWT認証、RBAC、レート制限の基本設計は存在
- CSRF対策、パスワードポリシー、トークン鍵管理の詳細が不足
- 権限管理の将来拡張性に懸念

**必要な対策:**
- CSRF対策の明記
- パスワード複雑性要件、トークン鍵管理方針の追加

### 3. データ保護: スコア 2

**評価理由:**
- TLS通信、パスワードハッシュ化、カード情報非保存は適切
- 保存時暗号化、データ削除ポリシー、PII最小化方針が欠落
- GDPR対応が不明確

**必要な対策:**
- RDS/Redis暗号化、鍵管理方針の明記
- データ保持・削除ポリシーの完全な定義

### 4. 入力検証設計: スコア 1

**評価理由:**
- 入力検証ポリシーが完全に欠落（致命的）
- バリデーションルール、インジェクション対策、出力エスケープが未定義
- JSONB型への任意データ注入リスクが未検討

**必要な対策:**
- 包括的な入力検証ポリシー文書の作成
- バリデーションレイヤーの設計追加

### 5. インフラ・依存関係セキュリティ: スコア 3

**評価理由:**
- 主要ライブラリのバージョン明記は良好
- シークレット管理、脆弱性スキャン、ネットワーク分離の詳細が不足
- WAF使用有無が不明

**必要な対策:**
- Secrets Manager使用の明記
- 依存関係脆弱性管理プロセスの定義
- VPC/WAF設計の追加

---

## 肯定的な側面

1. **基本的な暗号化技術の採用**: TLS 1.3、bcrypt (cost 12)、JWT署名の使用
2. **カード情報の非保存**: Stripeへの委譲によるPCI DSS準拠負担軽減
3. **レート制限の実装**: API Gateway レベルでの基本的なDoS対策
4. **Multi-AZ構成**: RDSの可用性確保
5. **構造化ログ**: JSON形式でのログ出力によるログ解析容易性

---

## 総括

TravelHubの設計書は基本的なセキュリティ対策を含んでいますが、**入力検証ポリシー（致命的欠陥）、監査ログ設計、データ保護ポリシー、CSRF対策などの重要なセキュリティ要素が欠落**しており、現状のままでは本番運用に重大なリスクがあります。

特に優先すべき対策:
1. **即座**: 入力検証ポリシーの完全な定義（SQLインジェクション、XSS対策）
2. **高優先**: 監査ログ設計の追加、データ保護ポリシーの定義
3. **中優先**: CSRF対策、シークレット管理方針、ネットワークセキュリティ設計の明記

これらの対策を実装後、再度セキュリティレビューを実施することを強く推奨します。
