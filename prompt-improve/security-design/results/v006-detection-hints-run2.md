# EduStream セキュリティ評価レポート

## 1. Critical Issues (設計変更が必要)

### 1.1 JWT トークン保存方法と有効期限が危険
- **問題**: localStorage にトークンを保存し、有効期限が 24 時間と長い（5.セクション：認証・認可方式）
- **影響**: XSS 攻撃によりトークンが盗まれた場合、24 時間にわたってアカウントを完全に乗っ取られる危険性がある。特に教師アカウントが乗っ取られると、学生の個人情報やコンテンツへの不正アクセスが可能
- **推奨対策**: Cookie に HttpOnly + Secure + SameSite=Strict 属性を設定してトークンを保存。アクセストークンの有効期限を 15 分に短縮し、リフレッシュトークン（7 日間、ローテーション機能付き）を別途実装
- **関連セクション**: セクション 5 API 設計 - 認証・認可方式

### 1.2 決済処理の冪等性保証が欠落
- **問題**: 決済エンドポイント（`POST /api/payments/create`）に冪等性キーの設計が記載されていない
- **影響**: ネットワークタイムアウトによるリトライ時に二重課金が発生するリスク。Stripe 決済で重複請求が発生すると、返金処理コストと顧客信頼の損失につながる
- **推奨対策**: `Idempotency-Key` ヘッダーを必須とし、24 時間のキー保持期間で重複リクエストを検出。Stripe API 呼び出し時に同じキーを渡し、DB にも処理済みキーを記録（`payments` テーブルに `idempotency_key` カラム追加、UNIQUE 制約）
- **関連セクション**: セクション 5 API 設計 - 決済、セクション 4 データモデル - payments テーブル

### 1.3 ファイルアップロードの検証ポリシーが未定義
- **問題**: `POST /api/videos` と `POST /api/submissions` でファイルアップロードを受け付けるが、ファイル種別・サイズ・内容検証の設計が明記されていない
- **影響**:
  - 動画以外のファイル（実行可能ファイル、スクリプト）がアップロードされ、S3 から配信される危険性
  - 大容量ファイルによる DoS 攻撃（ストレージコスト増大、アップロード処理リソース枯渇）
  - 課題提出でマルウェアがアップロードされ、教師がダウンロード時に感染するリスク
- **推奨対策**:
  - 動画アップロード: MIME タイプ検証（video/mp4, video/webm のみ許可）、マジックバイト検証、最大ファイルサイズ 2GB
  - 課題提出: 許可拡張子リスト（.pdf, .docx, .txt, .zip）、MIME タイプ検証、最大 50MB
  - すべてのファイルにウイルススキャン（ClamAV または AWS S3 Malware Protection）を実装
  - S3 バケットに Content-Type ヘッダーを強制し、ダウンロード時に `Content-Disposition: attachment` を設定
- **関連セクション**: セクション 5 API 設計 - 動画管理・課題管理、セクション 2 技術スタック - 主要ライブラリ（multer）

### 1.4 認可チェックの粒度が不十分
- **問題**: コース削除（`DELETE /api/courses/:id`）が「教師・管理者のみ」となっているが、自身が作成したコースのみ削除可能とする制約が設計されていない
- **影響**: 教師 A が教師 B のコースを削除できる権限昇格の脆弱性。他教師のコンテンツを削除することで妨害行為が可能
- **推奨対策**:
  - コース削除・更新は `teacher_id` が認証済みユーザー ID と一致する場合のみ許可
  - 管理者は全コースの削除権限を保持
  - 認可ミドルウェアで `req.user.id === course.teacher_id || req.user.role === 'admin'` をチェック
- **関連セクション**: セクション 5 API 設計 - コース管理、セクション 3 アーキテクチャ設計 - Auth Service

### 1.5 CSRF 保護の設計が欠落
- **問題**: 状態変更エンドポイント（POST/PUT/DELETE）に CSRF トークン検証の設計が記載されていない
- **影響**: ログイン済みユーザーが悪意あるサイトを訪問した際に、意図しないコース削除・課題提出・決済処理が実行される危険性
- **推奨対策**:
  - Double Submit Cookie パターンを実装（CSRF トークンを Cookie とリクエストヘッダー `X-CSRF-Token` で送信し、サーバー側で一致を検証）
  - Cookie に SameSite=Strict 属性を設定（JWT を Cookie に移行する 1.1 の対策と合わせて実装）
  - すべての状態変更エンドポイントに CSRF 検証ミドルウェアを適用
- **関連セクション**: セクション 5 API 設計、セクション 3 アーキテクチャ設計 - API Gateway

### 1.6 Rate Limiting の設計が不十分
- **問題**: API Gateway でレート制限を行うと記載があるが、具体的な制限値・スコープ・ブルートフォース攻撃対策が設計されていない
- **影響**:
  - ログインエンドポイント（`POST /api/auth/login`）へのブルートフォース攻撃でアカウントが乗っ取られる
  - 決済エンドポイント（`POST /api/payments/create`）の大量リクエストでコスト攻撃が成立
  - 課題提出エンドポイントの悪用で大量ファイルがアップロードされストレージコストが急増
- **推奨対策**:
  - ログインエンドポイント: IP ごとに 5 回/15 分、5 回失敗で 30 分アカウントロック
  - 決済エンドポイント: ユーザーごとに 10 回/時間
  - ファイルアップロード: ユーザーごとに 100MB/時間（動画）、20 ファイル/時間（課題）
  - 一般 API: IP ごとに 1000 回/時間
  - Express-rate-limit（v7.1.0）を使用し、Redis でカウンター共有
- **関連セクション**: セクション 3 アーキテクチャ設計 - API Gateway

### 1.7 Stripe Webhook の署名検証が明記されていない
- **問題**: `POST /api/payments/webhook` で Stripe Webhook を受信するが、署名検証の設計が記載されていない
- **影響**: 攻撃者が偽の Webhook リクエストを送信し、決済完了していないコースへのアクセス権限を不正取得できる
- **推奨対策**:
  - Stripe Webhook シークレットを環境変数で管理
  - `stripe.webhooks.constructEvent()` で署名検証を実装
  - 検証失敗時は 400 エラーを返し、ログに警告を記録
  - Webhook エンドポイントは認証不要だが、署名検証を必須とする
- **関連セクション**: セクション 5 API 設計 - 決済

## 2. Improvement Suggestions (設計品質の向上に有効)

### 2.1 監査ログの設計が不十分
- **提案**: 重要操作（コース削除、課題評価変更、決済処理、管理者操作）の監査ログが設計されていない
- **理由**:
  - 不正アクセス発生時に調査のための証跡がない
  - コンプライアンス要件（GDPR、教育機関の監査）で操作履歴の保持が求められる可能性
  - 評価の改ざん（教師が課題スコアを変更）を後から検証できない
- **推奨対策**:
  - `audit_logs` テーブルを追加（user_id, action, resource_type, resource_id, old_value, new_value, ip_address, timestamp）
  - コース削除、課題評価（`PUT /api/submissions/:id/grade`）、決済処理、ユーザー権限変更を記録
  - ログ保持期間 3 年（教育機関のデータ保持ポリシーに準拠）
  - ログへの書き込みは非同期処理（メインリクエストのパフォーマンス影響を最小化）

### 2.2 パスワードポリシーと複雑性要件が未定義
- **提案**: パスワードの複雑性要件（最小長、文字種）が設計されていない
- **理由**: 弱いパスワード（"password123"）が許可されると、ブルートフォース攻撃やパスワードリスト攻撃の成功率が高まる
- **推奨対策**:
  - 最小 12 文字、大文字・小文字・数字・記号を各 1 文字以上含む
  - よくあるパスワードリスト（Have I Been Pwned の Pwned Passwords API）でチェック
  - パスワード変更時は現在のパスワード入力を必須とする
  - パスワードリセット機能にメール確認フローを実装（トークン有効期限 1 時間）

### 2.3 データ保護とプライバシーポリシーの欠落
- **提案**: 個人情報（email, 課題提出内容）の暗号化・保持期間・削除ポリシーが設計されていない
- **理由**:
  - GDPR やプライバシー規制で個人情報の保護が義務付けられる
  - データ漏洩時に暗号化されていないデータが流出するリスク
  - ユーザーがアカウント削除を要求した場合の対応方針がない
- **推奨対策**:
  - email アドレスは平文で保存（ログイン用途）だが、DB バックアップを暗号化
  - 課題ファイル（S3）はサーバー側暗号化（SSE-S3 または SSE-KMS）を有効化
  - 退会ユーザーのデータ削除ポリシー: 30 日以内にアカウントと提出ファイルを削除（決済記録は 7 年保持、個人情報は仮名化）
  - プライバシーポリシーでデータ保持期間を明示

### 2.4 セッションタイムアウトと並行ログインの制御が未設計
- **提案**: セッション管理（タイムアウト、並行ログイン制限）の設計が記載されていない
- **理由**:
  - 長時間放置された端末から不正アクセスされるリスク
  - トークンが盗まれた場合に正規ユーザーが気づく仕組みがない
- **推奨対策**:
  - アクセストークン: 15 分で自動失効（1.1 の対策で実装）
  - リフレッシュトークン: 30 日間操作がない場合は失効
  - 並行ログインセッション数を 5 に制限（Redis で管理）
  - 新規ログイン時に既存セッション一覧を表示し、強制ログアウト機能を提供

### 2.5 エラーメッセージでの情報漏洩リスク
- **提案**: エラーハンドリングで「スタックトレースを含めない」とあるが、詳細すぎるエラーメッセージによる情報漏洩対策が不十分
- **理由**:
  - ログインエラーで「パスワードが間違っています」と返すとメールアドレスの存在が確認できる（ユーザー列挙攻撃）
  - ファイルアップロードエラーで内部パスが露出するリスク
- **推奨対策**:
  - ログイン失敗時は「メールアドレスまたはパスワードが間違っています」と統一
  - ファイルアップロードエラーは「ファイル形式が無効です」と汎用メッセージを返す
  - 内部エラー詳細はログにのみ記録し、クライアントには `{ "error": { "code": "INTERNAL_ERROR", "message": "An error occurred" } }` を返す

### 2.6 依存関係の脆弱性管理ポリシーが未設計
- **提案**: 使用ライブラリ（Passport.js, jsonwebtoken, multer, Stripe SDK など）の脆弱性管理方針が記載されていない
- **理由**:
  - 既知の脆弱性を持つライブラリを使い続けるとゼロデイ攻撃のリスク
  - 特に認証・決済関連ライブラリの脆弱性は影響が大きい
- **推奨対策**:
  - GitHub Dependabot を有効化し、脆弱性アラートを受信
  - npm audit を CI/CD パイプラインに組み込み、HIGH 以上の脆弱性があればデプロイをブロック
  - 月次で依存関係の更新レビューを実施
  - 使用ライブラリの最小化（不要な依存関係を削除）

### 2.7 API レスポンスヘッダーのセキュリティ設定が欠落
- **提案**: セキュリティ関連 HTTP ヘッダー（CSP, X-Frame-Options など）の設計が記載されていない
- **理由**:
  - Content Security Policy がないと XSS 攻撃のリスクが高まる
  - X-Frame-Options がないとクリックジャッキング攻撃が可能
- **推奨対策**:
  - Helmet.js（v7.1.0）を導入し、以下のヘッダーを設定:
    - `Content-Security-Policy: default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'`
    - `X-Frame-Options: DENY`
    - `X-Content-Type-Options: nosniff`
    - `Strict-Transport-Security: max-age=31536000; includeSubDomains`
    - `Referrer-Policy: no-referrer`

### 2.8 ライブストリーミング視聴権限の認可が不明確
- **提案**: ライブ配信（AWS MediaLive/MediaPackage）への視聴権限チェックが設計されていない
- **理由**:
  - コース購入済みの学生のみが視聴できるべきだが、認可フローが記載されていない
  - 署名付き URL を発行しないと、URL が流出した際に誰でも視聴可能になる
- **推奨対策**:
  - CloudFront で署名付き URL を生成（有効期限 1 時間）
  - 視聴リクエスト時に `GET /api/live/:session_id/token` で署名付き URL を発行
  - コース購入済み（payments テーブルで確認）または無料コースの場合のみ URL を返す

### 2.9 DB 接続の秘匿情報管理が不十分
- **提案**: PostgreSQL 接続文字列、AWS アクセスキー、Stripe API キーの管理方針が「環境変数」としか記載されていない
- **理由**:
  - 環境変数がソースコードにハードコードされるリスク
  - ローテーション方針がないと長期間同じキーを使い続ける
- **推奨対策**:
  - AWS Secrets Manager または AWS Systems Manager Parameter Store で秘匿情報を管理
  - アプリケーション起動時に Secrets Manager から取得
  - Stripe API キーは年次でローテーション
  - RDS 認証は IAM データベース認証を使用（パスワード不要）

### 2.10 動画ストリーミング URL の一時性が未設計
- **提案**: `GET /api/videos/:id/stream` で返される S3 URL に有効期限が設定されていない可能性
- **理由**:
  - 署名なし S3 URL を返すとリンクが永続的に有効となり、コース未購入者に共有されるリスク
- **推奨対策**:
  - S3 署名付き URL（presigned URL）を生成し、有効期限 1 時間を設定
  - CloudFront 署名付き Cookie を使用して動画セグメントへのアクセスを制御
  - URL 生成時にコース購入済みかを確認

## 3. Confirmation Items (ユーザー確認が必要)

### 3.1 管理者の多要素認証（MFA）要件
- **確認理由**: 管理者はすべてのデータにアクセス可能な強力な権限を持つが、MFA の設計が記載されていない
- **選択肢とトレードオフ**:
  - **MFA 必須**: セキュリティは向上するが、初期実装コストと UX の複雑化
  - **MFA オプション**: 実装コストは低いが、管理者アカウント乗っ取りのリスク
- **推奨**: 教育機関向けプラットフォームの場合、個人情報保護の観点から管理者 MFA は必須とすべき（TOTP アプリまたは SMS）

### 3.2 学生の年齢制限とデータ保護規制
- **確認理由**: COPPA（米国児童オンラインプライバシー保護法）や GDPR-K（欧州）では 13 歳未満のユーザーに追加の保護が必要
- **選択肢とトレードオフ**:
  - **13 歳以上に制限**: コンプライアンス簡素化、対象ユーザー減少
  - **保護者同意フロー実装**: 対象拡大、開発コスト増大
- **推奨**: サービス対象年齢を明確化し、13 歳未満を含む場合は保護者同意の取得フローを設計

### 3.3 課題提出のタイムスタンプ改ざん対策
- **確認理由**: `submissions.submitted_at` が締切後に改ざんされるリスク（DB 直接操作、管理者権限悪用）
- **選択肢とトレードオフ**:
  - **変更不可（INSERT のみ）**: 改ざん防止、誤提出時の再提出不可
  - **変更履歴テーブル**: 完全な証跡、ストレージコスト増
- **推奨**: 提出時刻の変更を禁止し、再提出は新規レコードとして記録（最新の提出のみ評価対象）

### 3.4 リアルタイムチャットの内容モデレーション
- **確認理由**: WebSocket チャット機能でハラスメントや不適切コンテンツが投稿されるリスク
- **選択肢とトレードオフ**:
  - **自動フィルタリング**: コスト増、誤検出のリスク
  - **報告機能のみ**: 低コスト、対応が後手に回る
- **推奨**: 報告機能と管理者によるメッセージ削除・ユーザー制限機能を優先実装。将来的に自動フィルタリング追加を検討

## 4. Positive Evaluation (良い点)

### 4.1 パスワードハッシュ化の適切な実装
- bcrypt のコスト係数 10 は適切なバランス（セキュリティとパフォーマンス）。将来的に計算能力が向上した際は 12 への引き上げを検討すべきだが、現時点では良好

### 4.2 HTTPS 通信の徹底
- すべての API 通信を HTTPS で暗号化する設計は、中間者攻撃（MITM）対策として基本的かつ重要。CloudFront の HTTPS 証明書管理も適切

### 4.3 SQLインジェクション対策
- パラメータ化クエリの使用は SQL インジェクション対策の基本。ORM（もし使用している場合）と組み合わせることでさらに堅牢化

### 4.4 データベースレプリケーションとバックアップ
- マスター・スレーブ構成と日次バックアップは、データ損失リスクの軽減と可用性向上に寄与。トランザクションログの継続的バックアップも PITR（Point-in-Time Recovery）に有効

### 4.5 決済処理の Stripe 採用
- PCI DSS 準拠の Stripe を使用することで、カード情報を自システムで保持しないアーキテクチャは適切。Webhook による非同期処理も標準的なベストプラクティス

---

## Score Summary

| Criterion | Score (1-5) | Main Reason |
|-----------|-------------|-------------|
| Threat Modeling (STRIDE) | 2 | CSRF 攻撃（Tampering）、権限昇格（Elevation of Privilege）、DoS 攻撃（Rate Limiting 不足）の対策が不十分 |
| Authentication & Authorization Design | 2 | JWT の localStorage 保存が危険、認可の粒度不足（他教師のコース削除可能）、セッション管理未設計 |
| Data Protection | 3 | HTTPS とパスワードハッシュ化は実装されているが、ファイル暗号化・データ保持ポリシー・プライバシー要件が欠落 |
| Input Validation Design | 2 | ファイルアップロードの検証ポリシー未定義、XSS 対策が出力エスケープのみ（CSP なし）、パスワード複雑性要件なし |
| Infrastructure & Dependencies | 3 | Stripe と AWS の適切な選定、SQLインジェクション対策は良好だが、依存関係脆弱性管理・秘匿情報管理・Webhook 署名検証が不十分 |
| **Overall** | **2.4** | 認証・認可とファイルアップロードに重大な設計上の欠陥があり、本番環境でのセキュリティリスクが高い |
