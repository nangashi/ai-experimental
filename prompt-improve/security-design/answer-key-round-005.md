# 正解キー

## 実行条件
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: JWT有効期限が長すぎる
- **カテゴリ**: 認証・認可設計（セッション管理）
- **深刻度**: 中
- **該当箇所**: セクション3「データフロー」の説明、およびセクション5「認証・認可方式」
- **問題の説明**: JWTの有効期限が24時間と長すぎる。医療情報という機密性の高いデータを扱うシステムでは、トークンの有効期限は短く設定し、リフレッシュトークン機構を使用すべき。24時間の有効期限は、トークンが漏洩した場合のリスク時間窓が大きすぎる。
- **検出判定基準**:
  - ○（検出）: JWTの有効期限24時間が長すぎることを指摘し、短縮（例: 15分-1時間）とリフレッシュトークン機構の導入を提案している
  - △（部分検出）: JWTのセキュリティリスクに言及しているが、有効期限の具体的な問題点や改善案に触れていない
  - ×（未検出）: JWTに関する指摘がない

### P02: JWTの署名アルゴリズムと鍵管理方針が未定義
- **カテゴリ**: 認証・認可設計（認証フロー）
- **深刻度**: 重大
- **該当箇所**: セクション5「認証・認可方式」、セクション2「主要ライブラリ」
- **問題の説明**: JWTを使用することは明記されているが、署名アルゴリズム（HS256/RS256等）と秘密鍵の管理方針が設計書に記載されていない。不適切なアルゴリズム選択や鍵の不適切な管理は、JWT偽造やトークンハイジャックのリスクを生む。
- **検出判定基準**:
  - ○（検出）: JWTの署名アルゴリズムと秘密鍵管理方針（AWS Secrets Manager等のシークレット管理サービス使用）の欠如を指摘している
  - △（部分検出）: JWTのセキュリティに言及しているが、署名アルゴリズムや鍵管理の具体的な欠如には触れていない
  - ×（未検出）: JWTの署名・鍵管理に関する指摘がない

### P03: 他院との診療情報共有における認可設計が不明確
- **カテゴリ**: 認証・認可設計（APIアクセス制御）
- **深刻度**: 重大
- **該当箇所**: セクション1「主要機能の一覧」の「診療情報共有」、セクション4「medical_recordsテーブルのis_sharedフラグ」
- **問題の説明**: 他院との診療情報共有機能が存在するが、どのような認可フローで他院の医師がカルテにアクセスできるのかが設計書に記載されていない。患者の同意確認、アクセス権限の期限、アクセスログの記録といった重要な認可設計が欠如している。
- **検出判定基準**:
  - ○（検出）: 他院との診療情報共有における認可フロー（患者の明示的同意、アクセス権限の期限管理、アクセスログ記録）の欠如を指摘している
  - △（部分検出）: 診療情報共有のセキュリティリスクに言及しているが、認可フローの具体的な欠如には触れていない
  - ×（未検出）: 診療情報共有の認可設計に関する指摘がない

### P04: 入力検証方針の欠如
- **カテゴリ**: 入力検証設計（外部入力の検証方針）
- **深刻度**: 重大
- **該当箇所**: セクション6「実装方針」全体
- **問題の説明**: 患者や医師からの入力データに対する検証方針が設計書に記載されていない。電子カルテの診断内容や処方内容はTEXT型で自由入力が可能であり、SQLインジェクション、XSS、コマンドインジェクション等のリスクがある。入力の型チェック、長さ制限、許可文字の制限、サニタイゼーションといった検証方針を明記すべき。
- **検出判定基準**:
  - ○（検出）: 入力検証方針の欠如を指摘し、SQLインジェクション・XSS等の脆弱性リスクと、入力検証の具体的方針（型チェック、長さ制限、サニタイゼーション等）の必要性を述べている
  - △（部分検出）: 入力検証の必要性に言及しているが、方針の欠如や具体的な脆弱性リスクに触れていない
  - ×（未検出）: 入力検証に関する指摘がない

### P05: 予約キャンセルAPIの冪等性が未定義
- **カテゴリ**: 入力検証設計（外部入力の検証方針）
- **深刻度**: 中
- **該当箇所**: セクション5「DELETE /api/v1/appointments/{id}」
- **問題の説明**: 予約キャンセルAPIがDELETEメソッドで定義されているが、冪等性の保証や重複リクエストの処理方針が設計書に記載されていない。ネットワークエラーによる重複リクエストや、悪意あるユーザーによる多重キャンセルリクエストが発生した場合の挙動が不明確。
- **検出判定基準**:
  - ○（検出）: 予約キャンセルAPIの冪等性保証や重複リクエスト処理方針の欠如を指摘し、ステータス管理や重複検出機構の必要性を述べている
  - △（部分検出）: APIのエラーハンドリングに言及しているが、冪等性や重複リクエストの具体的な問題には触れていない
  - ×（未検出）: 予約キャンセルAPIの冪等性に関する指摘がない

### P06: 監査ログの記録範囲が不十分
- **カテゴリ**: データ保護（プライバシー要件）
- **深刻度**: 中
- **該当箇所**: セクション6「ロギング方針」、およびセクション3「他院との診療情報共有」
- **問題の説明**: ロギング方針として「APIリクエスト/レスポンス」の記録が定義されているが、機密情報へのアクセス監査ログとしては不十分。医療情報という機密性の高いデータに対して、誰が、いつ、どの患者のカルテにアクセスしたかを記録する監査ログ（アクセスログ）の設計が欠如している。特に他院共有機能があるため、アクセス元の医療機関や医師の記録が必須。
- **検出判定基準**:
  - ○（検出）: 医療情報アクセスに対する監査ログ（誰が、いつ、どの患者のカルテにアクセスしたか）の記録範囲が不足していることを指摘し、アクセス元医療機関・医師の記録必要性を述べている
  - △（部分検出）: ロギングの不足に言及しているが、監査ログの具体的な記録項目や他院共有時のアクセス記録には触れていない
  - ×（未検出）: 監査ログに関する指摘がない

### P07: データベース内の暗号化対象が限定的
- **カテゴリ**: データ保護（機密データの保存時の保護）
- **深刻度**: 中
- **該当箇所**: セクション7「セキュリティ要件」のデータ暗号化
- **問題の説明**: 診断内容と処方箋のみが暗号化対象として明記されているが、他の個人情報（患者氏名、生年月日、電話番号、メールアドレス等）や医師免許番号も機密性が高いデータであり、暗号化対象に含めるべき。また、暗号化鍵の管理方針（AWS KMS使用等）が設計書に記載されていない。
- **検出判定基準**:
  - ○（検出）: 暗号化対象が診断内容・処方箋に限定されており、他の個人情報（氏名、生年月日、電話番号等）や暗号化鍵管理方針の欠如を指摘している
  - △（部分検出）: データ暗号化の範囲拡大を提案しているが、具体的な対象データや鍵管理方針には触れていない
  - ×（未検出）: 暗号化対象の範囲に関する指摘がない

### P08: APIレート制限の設計が不十分
- **カテゴリ**: 脅威モデリング（DoS）
- **深刻度**: 中
- **該当箇所**: セクション7「セキュリティ要件」のAPIレート制限
- **問題の説明**: 1分間に60リクエスト/ユーザーというレート制限が定義されているが、未認証ユーザーやログイン試行に対するレート制限が設計書に記載されていない。ブルートフォース攻撃やDoS攻撃への対策として、ログインエンドポイントやアカウント登録エンドポイントに対する独立したレート制限が必要。
- **検出判定基準**:
  - ○（検出）: 未認証ユーザーやログイン試行に対するレート制限の欠如を指摘し、ブルートフォース攻撃やDoS攻撃への対策としてログインエンドポイント独立のレート制限を提案している
  - △（部分検出）: レート制限の不足に言及しているが、未認証ユーザーやログイン試行の具体的な問題には触れていない
  - ×（未検出）: レート制限の設計に関する指摘がない

### P09: エラーメッセージで内部情報が露出する可能性
- **カテゴリ**: データ保護（Information Disclosure）
- **深刻度**: 軽微
- **該当箇所**: セクション6「エラーハンドリング方針」のエラーレスポンス形式
- **問題の説明**: エラーレスポンスの例として「The patient ID is required.」が示されているが、本番環境でのエラーメッセージが詳細すぎる場合、攻撃者に内部実装の情報を与える可能性がある。エラーメッセージの詳細度を環境（開発/本番）によって切り替える方針や、本番環境では汎用的なエラーメッセージを返す設計が望ましい。
- **検出判定基準**:
  - ○（検出）: 本番環境でのエラーメッセージの詳細度が高すぎることによる情報露出リスクを指摘し、環境別のエラーメッセージ切り替えや汎用的メッセージ使用を提案している
  - △（部分検出）: エラーハンドリングのセキュリティリスクに言及しているが、エラーメッセージの詳細度や情報露出の具体的な問題には触れていない
  - ×（未検出）: エラーメッセージに関する指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 脅威モデリング（Spoofing） | パスワードリセット機能の設計が欠如 | パスワードリセット機能の欠如またはアカウントロックアウト機構の欠如を指摘 |
| B02 | 認証・認可設計 | 医師アカウントの多要素認証（MFA）が未定義 | 医療従事者アカウントに対するMFA要件の欠如を指摘 |
| B03 | データ保護 | S3バケットのアクセス制御方針が不明確 | S3バケットのアクセス制御（パブリックアクセス禁止、署名付きURL使用等）の欠如を指摘 |
| B04 | インフラ・依存関係のセキュリティ | WAFのルールセットが未定義 | WAFの具体的な保護ルール（OWASP Top 10対策等）の欠如を指摘 |
| B05 | データ保護 | 通信時のTLS証明書検証方針が未定義 | クライアント側のTLS証明書検証（証明書ピンニング等）の欠如を指摘 |
| B06 | インフラ・依存関係のセキュリティ | 依存ライブラリの脆弱性管理方針が未定義 | サードパーティライブラリの脆弱性スキャンやバージョン管理方針の欠如を指摘 |
| B07 | 脅威モデリング（Repudiation） | 診療情報の改ざん検知機構が未定義 | 電子カルテの改ざん検知（ハッシュ値記録、デジタル署名等）の欠如を指摘 |
