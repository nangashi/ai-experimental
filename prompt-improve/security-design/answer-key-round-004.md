# 正解キー - Round 4

## 実行条件
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 10問

## 埋め込み問題一覧

### P01: 機密データの暗号化欠如（マイナンバー・口座番号）
- **カテゴリ**: データ保護
- **深刻度**: 重大
- **該当箇所**: セクション7.2（セキュリティ要件）、セクション4.1（employeesテーブル）
- **問題の説明**: マイナンバー（my_number）と銀行口座番号（bank_account）がデータベースに平文で保存されている（7.2に「マイナンバー・口座番号はデータベースに保存（暗号化なし）」と明記）。日本の個人情報保護法・マイナンバー法では特定個人情報の適切な安全管理措置が義務付けられており、平文保存は重大なコンプライアンス違反。データベース侵害時に直ちに悪用可能な情報が流出する。
- **検出判定基準**:
  - ○（検出）: マイナンバーまたは口座番号の暗号化が欠如している点を指摘し、データベース保存時の暗号化（AES-256等）を推奨している
  - △（部分検出）: 「個人情報の保護が不十分」と一般的に指摘しているが、マイナンバー・口座番号の具体的な暗号化対策に言及していない
  - ×（未検出）: 機密データ保護に関する指摘がない、または暗号化以外の対策のみ言及

### P02: JWT署名鍵の環境変数平文保存
- **カテゴリ**: インフラ・依存関係のセキュリティ
- **深刻度**: 重大
- **該当箇所**: セクション6.5（デプロイメント方針）
- **問題の説明**: JWT署名鍵（共通鍵）とデータベースパスワードを環境変数に平文で設定している（6.5に「秘密情報は環境変数に平文で設定」と明記）。環境変数はコンテナログ、エラーメッセージ、デプロイ履歴に露出しやすく、署名鍵が漏洩すると任意のJWTトークンを偽造可能になる。AWS環境ではSecrets Manager/Parameter Store（暗号化）を使用すべき。
- **検出判定基準**:
  - ○（検出）: JWT署名鍵またはデータベースパスワードの環境変数平文保存の危険性を指摘し、AWS Secrets ManagerやParameter Storeなどのシークレット管理サービス利用を推奨している
  - △（部分検出）: 「シークレット管理が不十分」と指摘しているが、環境変数の問題点やAWSサービスの具体的推奨がない
  - ×（未検出）: シークレット管理に関する指摘がない

### P03: CSRF保護の欠如
- **カテゴリ**: 入力検証設計
- **深刻度**: 重大
- **該当箇所**: セクション2.1（技術スタック）、セクション6.1（認証・認可方式）
- **問題の説明**: Spring Security 6.2を使用しているが、CSRF（Cross-Site Request Forgery）保護に関する記述がない。給与計算実行（POST /api/payroll/calculate）や従業員削除（DELETE /api/employees/{id}）など状態変更操作が多数存在するが、CSRFトークン検証の実装方針が明示されていない。SPAアーキテクチャでもCORS設定の不備やXSS経由で攻撃される可能性がある。
- **検出判定基準**:
  - ○（検出）: CSRF保護が欠如している点を指摘し、CSRFトークン検証の実装またはSpring SecurityのCSRF保護機能の有効化を推奨している
  - △（部分検出）: 「状態変更APIの保護が不十分」と指摘しているが、CSRF具体的な対策に言及していない
  - ×（未検出）: CSRF保護に関する指摘がない

### P04: API入力検証方針の欠如
- **カテゴリ**: 入力検証設計
- **深刻度**: 中
- **該当箇所**: セクション5（API設計）、セクション6（実装方針）
- **問題の説明**: APIエンドポイントの仕様は詳細に定義されているが、入力検証の方針が明示されていない。employee_code、email、phone_numberなどのフォーマット検証、salary_amountの範囲検証、SQLインジェクション防止のためのパラメータバインド方針などが不明。Spring Validation（@Valid, @NotNull等）の使用方針も記載がない。
- **検出判定基準**:
  - ○（検出）: API入力検証の方針が欠如している点を指摘し、バリデーション（形式・範囲・長さ）の実装方針やSpring Validationの利用を推奨している
  - △（部分検出）: 「入力チェックが必要」と一般的に指摘しているが、検証方針の明示化やフレームワーク機能の活用に言及していない
  - ×（未検出）: 入力検証に関する指摘がない

### P05: 勤怠打刻APIの冪等性欠如
- **カテゴリ**: 入力検証設計
- **深刻度**: 中
- **該当箇所**: セクション5.4（勤怠管理エンドポイント）
- **問題の説明**: 勤怠打刻API（POST /api/attendance/clock-in）は同一リクエストの重複送信を防ぐ冪等性キー（idempotency key）の仕組みがない。ネットワークタイムアウトや誤操作で同じ打刻が複数回記録されるリスクがある。給与計算に直結するため、不正確な勤怠データは重大な影響を及ぼす。リクエストにユニークキーを含め、既存キーがあれば409 Conflictを返すべき。
- **検出判定基準**:
  - ○（検出）: 勤怠打刻APIの重複送信リスクを指摘し、冪等性キー（idempotency key）の実装を推奨している
  - △（部分検出）: 「重複打刻の防止が必要」と指摘しているが、冪等性キーの仕組みに具体的に言及していない
  - ×（未検出）: 勤怠打刻の重複送信対策に関する指摘がない

### P06: 監査ログの範囲不足
- **カテゴリ**: 脅威モデリング（Repudiation対策）
- **深刻度**: 中
- **該当箇所**: セクション6.3（ロギング方針）
- **問題の説明**: 監査ログは「認証イベント、権限エラー、給与計算実行、従業員情報更新」のみ記録されるが、給与明細の閲覧（GET /api/payroll）やマイナンバー・口座番号を含む従業員情報の照会（GET /api/employees）は記録されない。これらは機密性の高い個人情報へのアクセスであり、内部不正や情報流出時の追跡のために監査ログが必須。個人情報保護法の安全管理措置としても不十分。
- **検出判定基準**:
  - ○（検出）: 機密情報の照会操作（給与明細閲覧、従業員情報照会）が監査ログに含まれていない点を指摘し、読み取り操作の監査ログ追加を推奨している
  - △（部分検出）: 「監査ログが不足」と指摘しているが、具体的に照会操作のログ記録を推奨していない
  - ×（未検出）: 監査ログに関する指摘がない、または記録範囲の拡充に言及していない

### P07: 個人情報のログ出力
- **カテゴリ**: データ保護
- **深刻度**: 中
- **該当箇所**: セクション6.3（ロギング方針）
- **問題の説明**: 「個人情報（氏名、メール、給与額）はログに出力する」と明記されており、機密データがログファイルに平文で記録される。ログはDatadogに集約され、開発者やSRE担当者が広範囲にアクセス可能になる。ログローテーションや保管期間によっては長期間残存し、情報流出リスクが高まる。個人情報はマスキング（仮名化）してログ出力すべき。
- **検出判定基準**:
  - ○（検出）: 個人情報（氏名、メール、給与額など）のログ出力の危険性を指摘し、ログマスキングや仮名化を推奨している
  - △（部分検出）: 「ログに機密情報が含まれる」と指摘しているが、マスキング対策に具体的に言及していない
  - ×（未検出）: ログ出力内容に関する指摘がない

### P08: レート制限・DoS対策の欠如
- **カテゴリ**: 脅威モデリング（DoS対策）
- **深刻度**: 中
- **該当箇所**: セクション5（API設計）、セクション7.1（パフォーマンス目標）
- **問題の説明**: APIエンドポイント（特にログインAPI、給与計算API）にレート制限の記述がない。ログインAPIは総当たり攻撃（ブルートフォース）のターゲットになりやすく、給与計算APIは計算コストが高く悪用されるとリソース枯渇を招く。Spring SecurityのRateLimitingやAWS WAFでのレート制限が必要。
- **検出判定基準**:
  - ○（検出）: レート制限の欠如を指摘し、ログインAPIや給与計算APIへのレート制限実装（Spring Security, AWS WAF等）を推奨している
  - △（部分検出）: 「DoS対策が必要」と指摘しているが、レート制限の具体的実装手段に言及していない
  - ×（未検出）: レート制限やDoS対策に関する指摘がない

### P09: データベースエラーメッセージの詳細出力
- **カテゴリ**: 認証・認可設計（Information Disclosure）
- **深刻度**: 軽微
- **該当箇所**: セクション6.2（エラーハンドリング方針）
- **問題の説明**: 「データベースエラーはスタックトレースを含めてログ出力」とあるが、これがクライアントへのレスポンスに含まれるかが不明確。スタックトレースにテーブル名、カラム名、SQL文が含まれると、攻撃者にスキーマ情報を提供してしまう。ログには詳細を記録してもよいが、クライアントには汎用的なエラーメッセージのみ返すべき。
- **検出判定基準**:
  - ○（検出）: データベースエラーのスタックトレース露出リスクを指摘し、クライアントには汎用的エラーメッセージのみ返すべきと推奨している
  - △（部分検出）: 「エラーメッセージの情報漏洩リスク」と指摘しているが、データベースエラーの詳細露出に具体的に言及していない
  - ×（未検出）: エラーメッセージに関する指摘がない

### P10: JWTの有効期限が長すぎる
- **カテゴリ**: 認証・認可設計
- **深刻度**: 軽微
- **該当箇所**: セクション3.3（データフロー）、セクション6.1（認証・認可方式）
- **問題の説明**: JWTの有効期限が24時間と長く、トークン漏洩時の悪用リスクが高い。リフレッシュトークンを発行せず期限切れ時は再ログインを要求する方針だが、利便性とセキュリティのバランスを考慮すると、アクセストークンは短時間（15分〜1時間）にしてリフレッシュトークンで更新する方式が望ましい。給与情報など機密性の高いデータを扱うため、トークン漏洩の影響を最小化すべき。
- **検出判定基準**:
  - ○（検出）: JWTの有効期限24時間が長すぎる点を指摘し、短時間（15分〜1時間）のアクセストークン+リフレッシュトークン方式を推奨している
  - △（部分検出）: 「JWTの有効期限を短くすべき」と指摘しているが、リフレッシュトークン方式の推奨がない、または具体的な期限の目安がない
  - ×（未検出）: JWTの有効期限に関する指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | インフラ・依存関係 | 依存ライブラリの脆弱性スキャンが月次のみで頻度が低い（セクション7.2） | 依存ライブラリの脆弱性スキャン頻度を週次や自動化（CI/CD統合）にすべきと指摘 |
| B02 | 認証・認可設計 | パスワードのwork factor 10が現代基準では低い可能性（セクション7.2） | bcryptのwork factorを12以上に引き上げるべきと指摘 |
| B03 | データ保護 | S3保存の給与明細PDFの暗号化設定が不明（セクション2.2） | S3オブジェクトのサーバーサイド暗号化（SSE-S3/SSE-KMS）を推奨 |
| B04 | 認証・認可設計 | テナントIDの検証漏れによるテナント間データ漏洩リスク（セクション3.3、5.1） | Row-Level Securityだけでなくアプリケーション層でのテナントID検証を推奨 |
| B05 | 脅威モデリング | バックアップの暗号化とアクセス制御の記述欠如（セクション7.3） | データベースバックアップの暗号化とアクセス制限を推奨 |
