# Round 4 Comparison Report: security-design

## 実行条件
- **観点**: security
- **対象**: design
- **ラウンド**: Round 4
- **テスト対象文書**: 従業員給与管理システム（セクション1: 機能概要、セクション2-7: 詳細設計、埋め込み問題10件）
- **実行日**: 2026-02-10
- **採点基準**: scoring-rubric.md（検出判定○/△/×、ボーナス上限5件、ペナルティ-0.5/件）

---

## 比較対象

| プロンプト名 | 独立変数 | Variation ID | 説明 |
|-------------|---------|--------------|------|
| **baseline** | - | - | 現行プロンプト（Round 3推奨版） |
| **english** | 言語 | (未割当) | 英語版プロンプト（システムプロンプトを英語化） |
| **explicit-checks** | 新規アプローチ | (未割当) | 明示的チェックリスト追加（入力検証・冪等性・ログマスキングに特化した3項目チェックリストをperspective.mdに追加） |

---

## 問題別検出マトリクス

| 問題ID | カテゴリ | 深刻度 | baseline | english | explicit-checks | 正解キー検出判定基準 |
|--------|----------|--------|----------|---------|-----------------|---------------------|
| **P01** | データ保護 | 重大 | ○/○ | ○/○ | ○/○ | マイナンバー・口座番号の暗号化欠如を指摘し、AES-256等の暗号化を推奨 |
| **P02** | インフラ・依存関係 | 重大 | ○/○ | ○/○ | ○/○ | JWT署名鍵の環境変数平文保存を指摘し、AWS Secrets Manager利用を推奨 |
| **P03** | 入力検証設計 | 重大 | △/△ | △/△ | ×/△ | CSRF保護の欠如を指摘し、CSRFトークン検証またはSpring Security CSRF機能の有効化を推奨 |
| **P04** | 入力検証設計 | 中 | ×/△ | ○/○ | ○/○ | API入力検証方針の欠如を指摘し、Spring Validationの実装方針を推奨 |
| **P05** | 入力検証設計 | 中 | ×/× | ×/× | ○/○ | 勤怠打刻APIの冪等性欠如を指摘し、Idempotency-Keyの実装を推奨 |
| **P06** | 脅威モデリング | 中 | ×/× | ○/○ | ×/× | 監査ログの範囲不足を指摘し、機密情報の照会操作（給与明細閲覧、従業員情報照会）のログ追加を推奨 |
| **P07** | データ保護 | 中 | ○/○ | ○/○ | ○/○ | 個人情報のログ出力を指摘し、マスキング・仮名化対策を推奨 |
| **P08** | 脅威モデリング | 中 | ○/○ | ○/○ | ○/○ | レート制限・DoS対策の欠如を指摘し、Bucket4j等の実装を推奨 |
| **P09** | 認証・認可設計 | 軽微 | ×/× | ×/× | ×/× | データベースエラーメッセージの詳細出力リスクを指摘し、スタックトレースを含めないエラーハンドリングを推奨 |
| **P10** | 認証・認可設計 | 軽微 | ○/○ | ○/○ | ○/○ | JWTの有効期限が長すぎる点を指摘し、15分アクセストークン+リフレッシュトークン方式を推奨 |

**検出マトリクス表記**: 各セルは「Run1判定/Run2判定」（○=1.0, △=0.5, ×=0.0）

---

## ボーナス/ペナルティ詳細

### baseline ボーナス分析

| Run | 件数 | 主なボーナス指摘 | 合計 |
|-----|------|----------------|------|
| Run1 | 7件 | B04(テナント分離), B05(監査ログ改ざん防止), B01(脆弱性スキャン), B05(バックアップ暗号化), B03(S3アクセス制御) | +2.5 (5件上限適用) |
| Run2 | 7件 | B04(テナント分離), B05(監査ログ改ざん防止), B03(S3アクセス制御), パスワードポリシー, セッション管理, ファイルアップロード, TLS暗号化 | +2.5 (5件上限適用) |

**ペナルティ**: Run1=0件, Run2=0件

### english ボーナス分析

| Run | 件数 | 主なボーナス指摘 | 合計 |
|-----|------|----------------|------|
| Run1 | 10件 | B01-B05全件 + TLS暗号化, MFA, パスワードポリシー, セキュリティヘッダー, セッション管理 | +2.5 (5件上限適用) |
| Run2 | 9件 | B01-B05全件 + TLS暗号化, MFA, パスワードポリシー, セキュリティヘッダー | +2.5 (5件上限適用) |

**ペナルティ**: Run1=0件, Run2=0件

### explicit-checks ボーナス分析

| Run | 件数 | 主なボーナス指摘 | 合計 |
|-----|------|----------------|------|
| Run1 | 4件 | B01(脆弱性スキャン), B05(バックアップ暗号化), 給与計算API再実行防止, SQLインジェクション明示 | +2.0 |
| Run2 | 5件 | B02(bcrypt work factor), 論理削除, ユーザー列挙攻撃, バッチ監視, 暗号化方式選択 | +2.5 |

**ペナルティ**: Run1=0件, Run2=0件

---

## スコアサマリ

| プロンプト名 | Run1 | Run2 | Mean | SD | 安定性判定 |
|-------------|------|------|------|----|---------:|
| **baseline** | 8.0 | 8.5 | **8.25** | 0.25 | 高安定 (SD ≤ 0.5) |
| **english** | 11.0 | 11.0 | **11.0** | 0.0 | 高安定 (SD ≤ 0.5) |
| **explicit-checks** | 9.0 | 10.0 | **9.5** | 0.5 | 高安定 (SD ≤ 0.5) |

### スコア内訳詳細

**baseline**:
- Run1: 検出5.5 + ボーナス2.5 - ペナルティ0.0 = 8.0
- Run2: 検出6.0 + ボーナス2.5 - ペナルティ0.0 = 8.5

**english**:
- Run1: 検出8.5 + ボーナス2.5 - ペナルティ0.0 = 11.0
- Run2: 検出8.5 + ボーナス2.5 - ペナルティ0.0 = 11.0

**explicit-checks**:
- Run1: 検出7.0 + ボーナス2.0 - ペナルティ0.0 = 9.0
- Run2: 検出7.5 + ボーナス2.5 - ペナルティ0.0 = 10.0

---

## 推奨判定

### 判定基準（scoring-rubric.md Section 5）

| 平均スコア差 | 判定ルール |
|-------------|-----------|
| > 1.0pt | スコアが高い方を推奨 |
| 0.5〜1.0pt | 標準偏差が小さい方を推奨（安定性重視） |
| < 0.5pt | ベースラインを推奨（ノイズによる誤判定を回避） |

### 判定プロセス

1. **english vs baseline**:
   - 平均スコア差 = 11.0 - 8.25 = **+2.75pt**
   - 判定: 差 > 1.0pt → **englishを推奨**

2. **explicit-checks vs baseline**:
   - 平均スコア差 = 9.5 - 8.25 = **+1.25pt**
   - 判定: 差 > 1.0pt → explicit-checksも有効だが、englishの方が高スコア

3. **最終推奨**: **english** (平均11.0pt, SD=0.0)
   - 理由: baselineに対して+2.75ptの改善、完全な安定性（SD=0.0）、全ボーナス項目（B01-B05）を両ラン共に検出

---

## 収束判定

### 判定基準（scoring-rubric.md Section 5）

| 条件 | 判定 |
|------|------|
| 2ラウンド連続で改善幅 < 0.5pt | 「最適化が収束した可能性あり」 |
| それ以外 | 「継続推奨」 |

### 判定プロセス

- **Round 3推奨**: baseline (平均9.0pt)
- **Round 4推奨**: english (平均11.0pt)
- **改善幅**: 11.0 - 9.0 = **+2.0pt**

**判定**: 改善幅 > 0.5pt → **継続推奨**

---

## 考察

### 独立変数ごとの効果分析

#### 1. 言語変更（english バリアント）

**効果**: +2.75pt（8.25 → 11.0）

**詳細分析**:
- **検出能力の大幅向上**:
  - P04（API入力検証方針）: baseline ×/△ → english ○/○ （+0.75pt）
  - P06（監査ログ範囲不足）: baseline ×/× → english ○/○ （+2.0pt）
  - 合計検出スコア: baseline 5.75 → english 8.5 （+2.75pt）

- **完璧な安定性**: SD=0.0（baseline SD=0.25から改善）

- **ボーナス項目の完全カバー**: 両ランで全ボーナス項目（B01-B05）を検出

**メカニズム推定**:
- 英語プロンプトはClaudeの事前学習データと言語分布が一致し、セキュリティレビューの専門用語やパターンを高精度で認識
- 特にP06（監査ログの範囲不足）の検出は、英語版が "audit logging only covers writes, not reads" と明確に識別したのに対し、日本語版は「監査ログの改ざん防止」に焦点が偏った

**独立変数の判定**: **EFFECTIVE** (+2.75pt、安定性SD=0.0）

#### 2. 明示的チェックリスト（explicit-checks バリアント）

**効果**: +1.25pt（8.25 → 9.5）

**詳細分析**:
- **チェックリストが機能した問題**:
  - P05（勤怠打刻APIの冪等性）: baseline ×/× → explicit-checks ○/○ （+2.0pt）
  - P04（API入力検証方針）: baseline ×/△ → explicit-checks ○/○ （+0.75pt）

- **チェックリストが機能しなかった問題**:
  - P03（CSRF保護）: baseline △/△ → explicit-checks ×/△ （-0.25pt）
    - Run1で完全未検出となり、逆効果の可能性
  - P06（監査ログ範囲不足）: baseline ×/× → explicit-checks ×/× （±0.0pt）
    - チェックリストに「ログマスキング」はあるが、「ログ記録範囲」は含まれていなかった

- **安定性**: SD=0.5（baseline SD=0.25より低下）

**メカニズム推定**:
- チェックリストは「入力検証・冪等性」という特定領域では効果を発揮（P04, P05検出）
- ただし、チェックリストに明示されていない問題（P06）やチェックリスト外の観点（P03）は見落としのリスク増加
- Round 2の N1a（OWASP標準チェックリスト）と同様の「チェックリスト依存による視野狭窄」が発生

**独立変数の判定**: **EFFECTIVE** (+1.25pt、ただし視野狭窄のリスクあり）

### 検出パターンの詳細比較

#### P04（API入力検証方針の欠如）

- **baseline**: Run1で完全未検出（SQLインジェクションのみ言及）、Run2で部分検出（ファイルアップロードのみ）
- **english**: 両ランで完全検出（"missing input validation policy, recommends Bean Validation (JSR 380)"）
- **explicit-checks**: 両ランで完全検出（明示的チェックリスト項目 "APIリクエストのパラメータ検証方針" が機能）

**示唆**: 入力検証の包括的な方針欠如は、日本語プロンプトでは個別の脆弱性（SQLインジェクション、ファイルアップロード）に焦点が分散し、全体像を捉えにくい。英語プロンプトまたは明示的チェックリストが有効。

#### P05（勤怠打刻APIの冪等性欠如）

- **baseline**: 両ランで未検出
- **english**: 両ランで未検出
- **explicit-checks**: 両ランで完全検出（明示的チェックリスト項目 "重要なAPIエンドポイント（給与計算、勤怠打刻など）における冪等性キー" が機能）

**示唆**: 冪等性は汎用的なセキュリティ知識では検出されにくい、ドメイン特化的な要件。明示的チェックリストが極めて有効。englishでも検出できなかった点は、言語変更のみでは限界があることを示唆。

#### P06（監査ログの範囲不足）

- **baseline**: 両ランで未検出（監査ログの「改ざん防止」のみ指摘）
- **english**: 両ランで完全検出（"audit logging only covers writes, not reads; recommends logging access to PII/salary data"）
- **explicit-checks**: 両ランで未検出（チェックリスト項目が「ログマスキング」に特化し、記録範囲は含まれず）

**示唆**: 監査ログの「何が記録されていないか」という欠如の分析は、日本語プロンプトでは難易度が高い。英語プロンプトは「only covers writes, not reads」と明確に不足を識別。チェックリストは項目外の問題には効果なし。

#### P03（CSRF保護の欠如）

- **baseline**: 両ランで部分検出（「明示不足」として改善提案レベル）
- **english**: 両ランで部分検出（"if JWT stored in cookies" という条件付き言及）
- **explicit-checks**: Run1で完全未検出、Run2で部分検出（不安定）

**示唆**: CSRFは「JWTをAuthorizationヘッダーで送信する場合はリスクが低い」という暗黙的な前提があり、全バリアントで完全検出に至らなかった。設計書に明示的なCSRF保護方針がない点を「欠如」として指摘する難易度が高い。

### 次回への示唆

1. **englishバリアントの採用を推奨**:
   - Round 4で+2.75ptの改善、SD=0.0の完璧な安定性
   - P04（入力検証方針）、P06（監査ログ範囲不足）を確実に検出
   - ボーナス項目（B01-B05）の完全カバー

2. **explicit-checksの局所的統合**:
   - P05（冪等性）は英語プロンプトでも未検出のため、冪等性チェック項目は有効
   - ただし、チェックリスト依存による視野狭窄のリスクあり
   - 次回: englishプロンプトに「冪等性」の明示的チェック項目を1-2項目追加するハイブリッド方式を検討

3. **未解決問題**:
   - **P09（エラーメッセージ詳細出力）**: 全バリアント・全ランで未検出
     - 軽微な問題だが、情報漏洩リスクとして重要
     - エラーハンドリングの観点を明示的に追加する必要あり
   - **P03（CSRF保護）**: 全バリアントで部分検出のみ
     - 「設計書に明示されていないCSRF保護方針」を欠如として指摘する能力が不足
     - "Explicitly document CSRF protection strategy" のような明示的指示が必要か

4. **収束判定**:
   - Round 4で+2.0ptの改善のため、継続推奨
   - 次回（Round 5）で english + 冪等性チェック追加を試験し、P09とP03の残存問題に対処

---

## バリアント効果テーブル

| Variation ID | 独立変数 | 効果 (pt) | SD | 判定 | 備考 |
|-------------|---------|-----------|----|----- |------|
| english | 言語: 英語化 | +2.75 | 0.0 | **EFFECTIVE** | P04, P06を完全検出、ボーナス完全カバー、完璧な安定性 |
| explicit-checks | 新規アプローチ: 明示的チェックリスト（入力検証・冪等性・ログマスキング） | +1.25 | 0.5 | **EFFECTIVE** | P05（冪等性）を確実に検出、ただしP03で逆効果、視野狭窄のリスクあり |

---

## 次回提案

**推奨方針**: englishバリアントをベースラインとし、Round 5では以下を試験:
1. **english + 冪等性チェック項目追加** (english-idempotency)
2. **english + エラーハンドリング明示化** (english-error-handling)
3. **baseline据え置き（比較対照）**

**目標**: P05（冪等性）とP09（エラーメッセージ露出）の完全検出、P03（CSRF）の改善
