# 正解キー: Round 3

## 実行条件
- **観点**: security
- **対象**: design
- **埋め込み問題数**: 10問

---

## 埋め込み問題一覧

### P01: デバイス認証キーの漏洩リスク（平文保存・通信）
- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **該当箇所**: セクション4（データモデル）、セクション5（API設計 - デバイス認証）
- **問題の説明**: `device_key` がデータベースに平文で保存され、MQTT接続時にクライアントIDとして平文で送信される設計となっている。device_keyが漏洩した場合、攻撃者が任意のデバイスになりすまし、制御コマンドを送受信できる重大なリスクがある。device_keyはハッシュ化して保存し、通信時はチャレンジ-レスポンス認証やTLS証明書ベースの認証を併用すべき。
- **検出判定基準**:
  - ○（検出）: device_keyの平文保存またはクライアントIDとしての平文送信の危険性を指摘し、ハッシュ化・チャレンジレスポンス認証・証明書ベース認証などの代替手段を提案している
  - △（部分検出）: デバイス認証の脆弱性に言及しているが、具体的な代替手段やdevice_keyの保存方式の問題に触れていない
  - ×（未検出）: デバイス認証キーの問題に全く触れていない

### P02: JWTトークンのセキュアな保存方法が不明
- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **該当箇所**: セクション5（API設計 - 認証・認可方式）
- **問題の説明**: JWT（アクセストークン、リフレッシュトークン）のモバイルアプリ側での保存方法が設計書に記載されていない。localStorageやSessionStorageに保存すると、XSS攻撃でトークンが窃取されるリスクがある。iOS KeychainやAndroid Keystore等のセキュアストレージを使用すべきであり、この点が設計書に明記されていないのは重大な欠陥。
- **検出判定基準**:
  - ○（検出）: JWTトークンの保存方法（iOS Keychain、Android Keystore等のセキュアストレージ）が設計書に欠如していることを指摘している
  - △（部分検出）: トークンの保存に関するセキュリティリスクに言及しているが、具体的な保存方法やモバイルアプリのセキュアストレージに触れていない
  - ×（未検出）: JWTトークンの保存方法の問題に全く触れていない

### P03: デバイス制御コマンドの認可チェックが不明確
- **カテゴリ**: 認証・認可設計
- **深刻度**: 重大
- **該当箇所**: セクション5（API設計 - デバイス管理）
- **問題の説明**: `POST /api/devices/:id/command` でデバイス制御コマンドを送信する際、権限レベル（owner/write/read）による認可チェックのロジックが設計書に明記されていない。readユーザーが制御コマンドを送信できてしまうと、権限昇格の脆弱性となる。各エンドポイントで必要な権限レベルを明示し、device_accessテーブルを用いた認可チェックの実装方針を記載すべき。
- **検出判定基準**:
  - ○（検出）: デバイス制御コマンドのエンドポイントで権限レベル（owner/write/read）に基づく認可チェックが不明確である点を指摘し、権限昇格のリスクや実装方針の欠如に言及している
  - △（部分検出）: 認可チェックの必要性に言及しているが、権限レベルの詳細や制御コマンド特有の問題に触れていない
  - ×（未検出）: デバイス制御コマンドの認可チェックの問題に全く触れていない

### P04: OTA更新パッケージのダウンロードURL（S3署名付きURL）の有効期限が不明
- **カテゴリ**: データ保護
- **深刻度**: 中
- **該当箇所**: セクション4（データモデル - ota_updates）、セクション5（API設計 - OTA更新）
- **問題の説明**: `ota_updates.s3_url` にS3のURLを保存しているが、このURLが署名付きURLの場合、有効期限の設計が不明確。有効期限が長すぎるとURLが漏洩した際に不正ダウンロードのリスクがあり、短すぎるとデバイスが更新を取得できない。署名付きURLの有効期限設計（例: 1時間）や、デバイスが動的に署名付きURLを取得する仕組みを明記すべき。
- **検出判定基準**:
  - ○（検出）: S3のOTA更新パッケージURLの有効期限設計が不明確である点を指摘し、署名付きURLの有効期限やURL再取得メカニズムの必要性に言及している
  - △（部分検出）: OTA更新のセキュリティに言及しているが、URL有効期限の問題に具体的に触れていない
  - ×（未検出）: OTA更新パッケージURLの問題に全く触れていない

### P05: リフレッシュトークンのローテーション戦略が欠如
- **カテゴリ**: 認証・認可設計
- **深刻度**: 中
- **該当箇所**: セクション5（API設計 - 認証・認可方式）
- **問題の説明**: リフレッシュトークンがRedisに7日間保存されるが、トークンローテーション（リフレッシュ時に新しいリフレッシュトークンを発行し、旧トークンを無効化）の設計が記載されていない。トークンローテーションがない場合、リフレッシュトークンが漏洩した際の検出が困難になり、長期間の不正アクセスを許すリスクがある。
- **検出判定基準**:
  - ○（検出）: リフレッシュトークンのローテーション戦略（新トークン発行＋旧トークン無効化）が設計書に欠如していることを指摘している
  - △（部分検出）: リフレッシュトークンのセキュリティリスクに言及しているが、ローテーション戦略の具体的な欠如に触れていない
  - ×（未検出）: リフレッシュトークンのローテーションの問題に全く触れていない

### P06: センサーデータAPIの入力検証が不明確
- **カテゴリ**: 入力検証設計
- **深刻度**: 中
- **該当箇所**: セクション5（API設計 - センサーデータ）
- **問題の説明**: `GET /api/devices/:id/telemetry` で時系列データを取得する際、`start` と `end` クエリパラメータの検証ロジックが設計書に記載されていない。例えば、`start` が `end` より後の日時である場合や、期間が異常に長い場合（例: 10年分のデータ要求）のバリデーションが不明確。不適切な入力により、InfluxDBへの過大なクエリが発生し、DoS攻撃のリスクがある。
- **検出判定基準**:
  - ○（検出）: センサーデータ取得APIの日時パラメータ（start/end）の入力検証が不明確であることを指摘し、DoSリスクや期間制限の必要性に言及している
  - △（部分検出）: APIの入力検証の必要性に一般的に言及しているが、センサーデータAPIの日時パラメータ特有の問題に触れていない
  - ×（未検出）: センサーデータAPIの入力検証の問題に全く触れていない

### P07: デバイスコマンド送信時の冪等性保証が欠如
- **カテゴリ**: 入力検証設計
- **深刻度**: 中
- **該当箇所**: セクション5（API設計 - デバイス管理）
- **問題の説明**: `POST /api/devices/:id/command` でデバイス制御コマンドを送信する際、冪等性キー（Idempotency Key）の設計が欠如している。ネットワーク障害によりクライアントが同一コマンドを複数回送信した場合、デバイスが同じ操作を繰り返し実行する可能性がある（例: ドアロックの開閉を複数回実行）。Idempotency Keyによる重複実行防止の仕組みを設計すべき。
- **検出判定基準**:
  - ○（検出）: デバイス制御コマンド送信APIに冪等性キー（Idempotency Key）が欠如していることを指摘し、重複実行のリスクや実装方針に言及している
  - △（部分検出）: 冪等性の重要性に一般的に言及しているが、デバイスコマンドAPIの具体的な問題に触れていない
  - ×（未検出）: デバイスコマンドAPIの冪等性保証の問題に全く触れていない

### P08: センサーデータやデバイス設定のログ出力時のマスキング方針が不明
- **カテゴリ**: データ保護
- **深刻度**: 中
- **該当箇所**: セクション6（実装方針 - ロギング方針）
- **問題の説明**: ロギング方針にユーザーIDやデバイスIDを記録すると記載されているが、センサーデータ（例: カメラの映像URL、位置情報）やデバイス設定（例: Wi-Fiパスワード）などの機密情報をログに出力する際のマスキング方針が明記されていない。ログに機密情報が平文で記録されると、ログアクセス権限を持つ管理者や開発者が意図せず機密情報を閲覧でき、プライバシー侵害のリスクがある。
- **検出判定基準**:
  - ○（検出）: ログ出力時に機密情報（センサーデータ、デバイス設定等）のマスキング方針が設計書に欠如していることを指摘している
  - △（部分検出）: ログのセキュリティに一般的に言及しているが、機密情報のマスキング方針の具体的な欠如に触れていない
  - ×（未検出）: ログ出力時のマスキング方針の問題に全く触れていない

### P09: MQTTブローカーの認証・認可メカニズムが不明確
- **カテゴリ**: 認証・認可設計（隣接領域: インフラ）
- **深刻度**: 軽微
- **該当箇所**: セクション3（アーキテクチャ設計 - 全体構成）、セクション5（API設計 - デバイス認証）
- **問題の説明**: MQTT Brokerへのデバイス接続時に `device_key` をクライアントIDとして使用すると記載されているが、MQTTブローカー自体の認証・認可メカニズム（例: MQTT Username/Password認証、ACL設定）が設計書に明記されていない。デバイスが任意のトピックにパブリッシュ/サブスクライブできると、他のデバイスのデータを盗聴したり、不正なコマンドを送信したりするリスクがある。
- **検出判定基準**:
  - ○（検出）: MQTTブローカーの認証・認可メカニズム（Username/Password、ACL等）が設計書に欠如していることを指摘し、トピックレベルのアクセス制御の必要性に言及している
  - △（部分検出）: MQTTのセキュリティに一般的に言及しているが、ブローカーの認証・認可メカニズムの具体的な欠如に触れていない
  - ×（未検出）: MQTTブローカーの認証・認可の問題に全く触れていない

### P10: APIレート制限がIPベースのみで、ユーザーベースの制限が欠如
- **カテゴリ**: インフラ・依存関係のセキュリティ
- **深刻度**: 軽微
- **該当箇所**: セクション7（非機能要件 - セキュリティ要件）
- **問題の説明**: APIレート制限が「同一IPから1分間に100リクエスト」とIPベースで設計されているが、ユーザーベース（JWT sub claim等）のレート制限が欠如している。IPベースのみの制限では、攻撃者が複数のIPアドレスを使用した場合に効果が薄く、また正常なユーザーが同一ネットワーク（例: 企業ネットワーク、公共Wi-Fi）から複数人アクセスする場合に誤検知のリスクがある。
- **検出判定基準**:
  - ○（検出）: APIレート制限がIPベースのみであることの問題点を指摘し、ユーザーベース（JWT等）のレート制限の必要性に言及している
  - △（部分検出）: レート制限の重要性に一般的に言及しているが、IPベースの限界やユーザーベースの制限の欠如に触れていない
  - ×（未検出）: APIレート制限の設計の問題に全く触れていない

---

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | データ保護 | InfluxDBに保存されるセンサーデータの暗号化方針が不明 | データベース暗号化（at-rest encryption）の欠如を指摘 |
| B02 | 認証・認可 | パスワードリセット機能の設計が欠如 | パスワードリセットトークンの有効期限やセキュアな配信方法の欠如を指摘 |
| B03 | データ保護 | OTA更新パッケージの署名検証のアルゴリズムが不明 | 署名アルゴリズム（RSA、ECDSA等）や鍵長の指定が欠如していることを指摘 |
| B04 | 監査・監視 | デバイスアクセス権限変更（招待・削除）の監査ログ設計が欠如 | 誰がいつ誰に権限を付与/削除したかのログ記録が欠如していることを指摘 |
| B05 | 認証・認可 | デバイス登録APIの認証方式（デバイスメーカー向け）が不明 | デバイスメーカー向けAPIの認証方式（API Key、OAuth等）が設計書に欠如していることを指摘 |
| B06 | 入力検証 | デバイス制御コマンドのパラメータ検証が不明 | コマンドパラメータ（brightness: 0-100等）の範囲検証や型検証の設計が欠如していることを指摘 |
| B07 | インフラ | TLS証明書の管理方針（更新、失効）が不明 | TLS証明書のライフサイクル管理やLet's Encrypt等の自動更新方針が欠如していることを指摘 |
| B08 | データ保護 | PostgreSQLのバックアップ暗号化方針が不明 | データベースバックアップの暗号化や保管方針が欠如していることを指摘 |
| B09 | 認証・認可 | Socket.IO（リアルタイム通信）の認証方式が不明 | WebSocket接続時のJWT認証や接続時のセキュリティ検証が設計書に欠如していることを指摘 |
| B10 | 入力検証 | デバイスから受信するテレメトリデータの検証方針が不明 | デバイスが送信するセンサーデータの異常値検証やスキーマ検証の欠如を指摘 |
| B11 | インフラ | ECS Fargateのセキュリティグループ設計が不明 | ネットワークレベルのアクセス制御（セキュリティグループ、NACLs）の設計が欠如していることを指摘 |
| B12 | データ保護 | RedisのTLS接続設定が不明 | Redis接続時の暗号化（TLS in-transit）の設計が欠如していることを指摘 |
