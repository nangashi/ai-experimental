# 正解キー

## 実行条件
- **観点**: consistency
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: テーブル名の命名規則が混在
- **カテゴリ**: 命名規約（データモデル）
- **深刻度**: 重大
- **該当箇所**: セクション4「データモデル」のテーブル定義
- **問題の説明**: テーブル名が User（単数形）と Course（単数形）、Enrollment（単数形）、Video（単数形）となっているが、既存コードベースでは複数形（users, courses, enrollments, videos）を使用している。命名規則の不整合によりマイグレーション時にテーブル名の衝突や、既存クエリとの互換性問題が発生する。
- **検出判定基準**:
  - ○（検出）: テーブル名の単数形/複数形の混在または既存パターンとの不一致を指摘している
  - △（部分検出）: テーブル命名に言及しているが、既存パターンとの比較がない
  - ×（未検出）: テーブル命名規則について指摘がない

### P02: カラム名の命名規則が混在（snake_case と camelCase）
- **カテゴリ**: 命名規約（データモデル）
- **深刻度**: 重大
- **該当箇所**: セクション4「データモデル」のUser, Video テーブル
- **問題の説明**: User テーブルでは userId（camelCase）を使用しているが、created_at（snake_case）も混在。Video テーブルでは videoId, courseId, s3Key, durationSeconds, uploadedAt（camelCase）を使用。既存コードベースではカラム名に一貫して snake_case を使用しており、ORM のマッピング設定が複雑化し、クエリの保守性が低下する。
- **検出判定基準**:
  - ○（検出）: カラム名の snake_case と camelCase の混在、または既存パターンとの不一致を指摘している
  - △（部分検出）: カラム命名に言及しているが、既存パターンとの比較や混在の指摘がない
  - ×（未検出）: カラム命名規則について指摘がない

### P03: レスポンス形式が既存APIと異なる
- **カテゴリ**: API設計
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」のレスポンス形式
- **問題の説明**: 新設計では `{success, data, timestamp}` 形式を採用しているが、既存APIでは `{status, result, metadata}` 形式を使用している。クライアント側で2つの異なるレスポンスパーサーが必要になり、フロントエンドの実装が複雑化する。エラーレスポンスも `{success: false, error: {...}}` だが、既存は `{status: "error", error: {...}}` を使用。
- **検出判定基準**:
  - ○（検出）: レスポンス形式のフィールド名（success/data/timestamp vs 既存パターン）の不一致を指摘している
  - △（部分検出）: レスポンス形式に言及しているが、既存パターンとの具体的な比較がない
  - ×（未検出）: レスポンス形式の一貫性について指摘がない

### P04: エンドポイント命名規則が既存と異なる（複数形/単数形）
- **カテゴリ**: API設計
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」のエンドポイント一覧
- **問題の説明**: 新設計では `/api/v1/courses` （複数形）を使用しているが、既存APIでは一貫して単数形リソース名（`/api/v1/user`, `/api/v1/content`）を採用している。RESTful設計としては複数形が一般的だが、既存パターンとの一貫性が失われる。
- **検出判定基準**:
  - ○（検出）: エンドポイントのリソース名が複数形だが既存は単数形、という不一致を指摘している
  - △（部分検出）: エンドポイント命名に言及しているが、既存パターンとの比較がない
  - ×（未検出）: エンドポイント命名規則について指摘がない

### P05: エラーハンドリング実装パターンの情報欠落
- **カテゴリ**: 実装パターン（情報欠落）
- **深刻度**: 重大
- **該当箇所**: セクション6「実装方針」全体
- **問題の説明**: 設計書にエラーハンドリングの実装方式（グローバル例外フィルタ、個別try-catch、AOP等）が明記されていない。既存コードベースがグローバル例外フィルタを使用している場合、個別try-catchの実装は一貫性を損なう。NestJS プロジェクトではエラーハンドリング方式の統一が重要だが、設計書からは判断できない。
- **検出判定基準**:
  - ○（検出）: エラーハンドリングの実装パターン（グローバルフィルタ/個別catch等）が設計書に記載されておらず、既存パターンとの一貫性が検証できないことを指摘している
  - △（部分検出）: エラーハンドリングに言及しているが、実装パターンの欠落という観点での指摘がない
  - ×（未検出）: エラーハンドリング実装パターンの情報欠落について指摘がない

### P06: データアクセスパターンおよびトランザクション管理の情報欠落
- **カテゴリ**: 実装パターン（情報欠落）
- **深刻度**: 重大
- **該当箇所**: セクション3「アーキテクチャ設計」およびセクション6「実装方針」
- **問題の説明**: 設計書では Repository層の存在は記載されているが、具体的なデータアクセスパターン（Repository パターンの実装詳細、Prisma の直接呼び出しの可否）およびトランザクション管理方式（どのレイヤーでトランザクション境界を設定するか）が明記されていない。既存コードベースが Service層でトランザクションを管理している場合、Repository層での管理は一貫性を損なう。
- **検出判定基準**:
  - ○（検出）: データアクセスパターンおよびトランザクション管理方式が設計書に記載されておらず、既存パターンとの一貫性が検証できないことを指摘している
  - △（部分検出）: データアクセスやトランザクションに言及しているが、実装パターンの欠落という観点での指摘がない
  - ×（未検出）: データアクセスパターンおよびトランザクション管理の情報欠落について指摘がない

### P07: 非同期処理パターンが既存と異なる可能性
- **カテゴリ**: 実装パターン
- **深刻度**: 軽微
- **該当箇所**: セクション3「アーキテクチャ設計」のデータフロー
- **問題の説明**: 動画エンコーディングで SQS → Lambda の非同期処理を採用しているが、既存コードベースでは NestJS の Bull（Redis ベースのジョブキュー）を使用している。新しい非同期処理基盤を導入すると、モニタリング、エラーハンドリング、リトライ戦略が分断され、運用が複雑化する。
- **検出判定基準**:
  - ○（検出）: SQS/Lambda による非同期処理が既存の Bull/Redis ベースの非同期処理パターンと異なることを指摘している
  - △（部分検出）: 非同期処理に言及しているが、既存パターンとの比較がない
  - ×（未検出）: 非同期処理パターンの一貫性について指摘がない

### P08: 環境変数命名規則の情報欠落
- **カテゴリ**: 設定管理（情報欠落）
- **深刻度**: 軽微
- **該当箇所**: 全体（設計書に環境変数の記載がない）
- **問題の説明**: 設計書にデータベース接続情報、AWS認証情報、JWT秘密鍵等の環境変数の命名規則が記載されていない。既存コードベースでは環境変数に一貫した命名規則（例: 全て大文字スネークケース `DATABASE_URL`, `AWS_ACCESS_KEY_ID`）を採用しているが、新機能で異なる規則を使用すると `.env` ファイルの可読性が低下する。
- **検出判定基準**:
  - ○（検出）: 環境変数の命名規則が設計書に記載されておらず、既存パターンとの一貫性が検証できないことを指摘している
  - △（部分検出）: 環境変数や設定に言及しているが、命名規則の欠落という観点での指摘がない
  - ×（未検出）: 環境変数命名規則の情報欠落について指摘がない

### P09: ログメッセージ構造が既存と異なる可能性
- **カテゴリ**: 実装パターン（ログ出力）
- **深刻度**: 軽微
- **該当箇所**: セクション6「実装方針」のロギング方針
- **問題の説明**: 設計書では Winston による構造化ログを採用し、カスタムフィールド（courseId, instructorId, timestamp）を含むログ形式を示しているが、既存コードベースで使用しているログフィールド名（例: `user_id`, `resource_id`, `event_time`）との統一性が検証できない。ログ集約ツール（CloudWatch Logs Insights等）でのクエリ効率が低下する。
- **検出判定基準**:
  - ○（検出）: ログフィールド名（courseId/instructorId/timestamp）が既存ログパターンと異なる可能性、または既存ログパターンとの一貫性が検証できないことを指摘している
  - △（部分検出）: ログ出力に言及しているが、既存パターンとの比較や情報欠落の指摘がない
  - ×（未検出）: ログメッセージ構造の一貫性について指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 実装パターン（認証） | 認証実装方式（Passport.js）が既存の認証ライブラリと異なる可能性を指摘 | Passport.js の採用が既存認証パターンと一貫しているか検証が必要との指摘があればボーナス |
| B02 | ディレクトリ構造 | モジュール構成（コース管理、動画配信、認証・認可）のディレクトリ配置ルールが設計書に明記されておらず、既存パターンとの一貫性が検証できないとの指摘 | ディレクトリ配置方針の欠落を指摘していればボーナス |
| B03 | API設計 | API バージョニング（`/api/v1/`）が既存APIのバージョニング規則と一貫しているか検証が必要との指摘 | バージョニング規則の一貫性について言及していればボーナス |
| B04 | 設定管理 | データベース接続設定、AWS接続設定等の設定ファイル形式（YAML/JSON/.env等）が既存パターンと一致しているか検証が必要との指摘 | 設定ファイル形式の一貫性について言及していればボーナス |
