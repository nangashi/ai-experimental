# 正解キー

## 実行条件
- **観点**: consistency
- **対象**: design
- **埋め込み問題数**: 10問

## 前提: 既存コードベースのパターン

本設計書は既存システムへの機能追加を想定しており、以下の既存パターンが確立されている:

### 既存の命名規則
- テーブル名: 複数形、スネークケース（例: `properties`, `tenants`, `contracts`）
- カラム名: スネークケース（例: `property_id`, `created_at`, `updated_at`）
- 外部キー命名: `{参照先テーブル名単数形}_id`（例: `owner_id`, `tenant_id`, `contract_id`）
- タイムスタンプ列: `created_at`, `updated_at` で統一

### 既存のAPI設計
- エンドポイント: RESTful設計、HTTPメソッドのみで操作を表現（例: `POST /api/v1/properties`, `DELETE /api/v1/properties/{id}`）
- レスポンス形式: `{data, error}` の2フィールド構造

### 既存の実装パターン
- HTTP通信: RestTemplate（Spring 標準クライアント）を全APIで使用
- トランザクション管理: Service層で `@Transactional` を使用
- ロギング: JSON構造化ログ形式

### 既存のディレクトリ構造
- レイヤー別構成（`controller/`, `service/`, `repository/`）

## 埋め込み問題一覧

### P01: テーブル名命名規則の混在（Contracts）
- **カテゴリ**: 命名規約の既存パターンとの一致（データモデル）
- **深刻度**: 重大
- **該当箇所**: セクション4（データモデル）、Contractsテーブル、主キーカラム名
- **問題の説明**: 既存システムでは主キー名は `{テーブル名単数形}_id` パターン（例: `property_id`, `tenant_id`, `owner_id`）だが、Contractsテーブルでは `id` のみを使用しており、既存パターンとの一貫性が欠けている。
- **検出判定基準**:
  - ○（検出）: Contractsテーブルの主キー `id` が既存の命名パターン（`contract_id` とすべき）と一致していないことを指摘している
  - △（部分検出）: Contractsテーブルの主キー命名に言及しているが、「既存パターンとの不一致」ではなく一般的なベストプラクティス評価として指摘している
  - ×（未検出）: Contractsテーブルの主キー命名について言及がない

### P02: 外部キー命名規則の混在（Contracts、Payments、Remittances）
- **カテゴリ**: 命名規約の既存パターンとの一致（データモデル）
- **深刻度**: 重大
- **該当箇所**: セクション4（データモデル）、Contracts/Payments/Remittancesテーブル
- **問題の説明**: 既存システムでは外部キー名は `{参照先テーブル名単数形}_id` パターンだが、Contractsテーブルでは `PropertyID`, `TenantID`（大文字混在）、Paymentsテーブルでは `contract_fk`、Remittancesテーブルでは `owner_fk` を使用しており、既存パターンとの一貫性が欠けている。
- **検出判定基準**:
  - ○（検出）: 外部キー命名の3つ以上のパターン（`owner_id`, `PropertyID/TenantID`, `contract_fk`, `owner_fk`）が混在していることを既存パターンとの不一致として指摘している
  - △（部分検出）: 外部キー命名の混在に言及しているが、全てのテーブルをカバーしていない、または「既存パターンとの不一致」ではなく「設計書内部の一貫性欠如」として指摘している
  - ×（未検出）: 外部キー命名の混在について言及がない

### P03: タイムスタンプ列命名規則の混在
- **カテゴリ**: 命名規約の既存パターンとの一致（データモデル）
- **深刻度**: 中
- **該当箇所**: セクション4（データモデル）、Properties/Payments（`created`, `updated`）、Contracts（`created_timestamp`, `modified_timestamp`）、他（`created_at`, `updated_at`）
- **問題の説明**: 既存システムでは `created_at`, `updated_at` で統一されているが、設計書内で `created/updated`、`created_timestamp/modified_timestamp`、`created_at/updated_at` の3パターンが混在し、既存パターンとの一貫性が欠けている。
- **検出判定基準**:
  - ○（検出）: タイムスタンプ列命名の3つ以上のパターン混在を既存パターン（`created_at/updated_at`）との不一致として指摘している
  - △（部分検出）: タイムスタンプ列命名の混在に言及しているが、「既存パターンとの不一致」ではなく「設計書内部の一貫性欠如」として指摘している
  - ×（未検出）: タイムスタンプ列命名の混在について言及がない

### P04: API設計 - 動詞使用の混在
- **カテゴリ**: API/インターフェース設計の既存パターンとの一致
- **深刻度**: 中
- **該当箇所**: セクション5（API設計）、物件管理エンドポイント
- **問題の説明**: 既存システムではRESTful設計原則に従いHTTPメソッドのみで操作を表現（例: `POST /api/v1/properties`, `DELETE /api/v1/properties/{id}`）しているが、物件管理APIでは `/create`, `/update` のような動詞をパスに含めており、既存APIの設計パターンとの一貫性が欠けている。
- **検出判定基準**:
  - ○（検出）: 物件管理APIのエンドポイント（`/create`, `/update`）が既存のRESTful設計パターンと不一致であることを指摘している
  - △（部分検出）: 動詞使用に言及しているが、「既存パターンとの不一致」ではなく一般的なRESTful原則の評価として指摘している
  - ×（未検出）: エンドポイントのパス設計について言及がない

### P05: API設計 - レスポンス形式の不整合
- **カテゴリ**: API/インターフェース設計の既存パターンとの一致
- **深刻度**: 中
- **該当箇所**: セクション5（API設計）、レスポンス形式
- **問題の説明**: 既存システムでは `{data, error}` の2フィールド構造だが、新設計では `{data/error, status, timestamp}` の3フィールド構造を使用しており、既存APIのレスポンス形式との一貫性が欠けている。
- **検出判定基準**:
  - ○（検出）: レスポンス形式が既存の `{data, error}` パターンと不一致（`status`, `timestamp` フィールドの追加）であることを指摘している
  - △（部分検出）: レスポンス形式の変更に言及しているが、既存パターンとの不一致という観点が明確でない
  - ×（未検出）: レスポンス形式について言及がない

### P06: 実装パターン - HTTP通信ライブラリの不一致
- **カテゴリ**: 実装パターンの既存パターンとの一致
- **深刻度**: 中
- **該当箇所**: セクション2（技術スタック）、主要ライブラリ
- **問題の説明**: 既存システムでは全APIで RestTemplate（Spring 標準クライアント）を使用しているが、新設計では Apache HttpClient 5.2 を導入しており、既存の実装パターンとの一貫性が欠けている。同機能のライブラリを重複導入することで、保守コストが増加する。
- **検出判定基準**:
  - ○（検出）: Apache HttpClient 5.2 の選定が既存の RestTemplate パターンと不一致であることを指摘している
  - △（部分検出）: HTTP通信ライブラリの選定に言及しているが、既存パターンとの不一致という観点が明確でない
  - ×（未検出）: HTTP通信ライブラリの選定について言及がない

### P07: 実装パターン（情報欠落） - エラーハンドリングパターンの未文書化
- **カテゴリ**: 実装パターンの既存パターンとの一致（情報欠落）
- **深刻度**: 中
- **該当箇所**: セクション6（実装方針）
- **問題の説明**: 設計書にエラーハンドリングの方針（グローバルハンドラ使用 or 個別catchによる処理）が明記されておらず、既存パターンとの一貫性が検証できない。既存システムがグローバルExceptionHandlerを使用している場合、新設計でも同一の方針を採用すべきである。
- **検出判定基準**:
  - ○（検出）: エラーハンドリングパターンが設計書に明記されておらず、既存パターンとの一貫性が検証できないことを指摘している
  - △（部分検出）: エラーハンドリングの方針について言及しているが、「既存パターンとの一貫性検証が必要」という観点が明確でない
  - ×（未検出）: エラーハンドリングの方針について言及がない

### P08: 実装パターン（情報欠落） - データアクセス/トランザクション管理パターンの不完全な文書化
- **カテゴリ**: 実装パターンの既存パターンとの一致（情報欠落）
- **深刻度**: 軽微
- **該当箇所**: セクション6（実装方針）、トランザクション管理
- **問題の説明**: トランザクション管理の基本方針（`@Transactional` 使用）は記述されているが、データアクセスパターン（Repository直接呼び出し or Service間呼び出しのトランザクション伝播方針）が明記されておらず、既存パターンとの一貫性が検証できない。既存システムが特定のトランザクション伝播ルール（例: Serviceメソッド間の呼び出しは `REQUIRES_NEW` を使用しない等）を採用している場合、新設計でも同一の方針を採用すべきである。
- **検出判定基準**:
  - ○（検出）: データアクセスパターンまたはトランザクション伝播方針が設計書に明記されておらず、既存パターンとの一貫性が検証できないことを指摘している
  - △（部分検出）: トランザクション管理の方針について言及しているが、「データアクセスパターンの一貫性」や「既存パターンとの照合が必要」という観点が明確でない
  - ×（未検出）: データアクセスパターンまたはトランザクション伝播について言及がない

### P09: ディレクトリ構造 - ファイル配置方針の未文書化
- **カテゴリ**: ディレクトリ構造・ファイル配置の既存パターンとの一致（情報欠落）
- **深刻度**: 軽微
- **該当箇所**: セクション3（アーキテクチャ設計）
- **問題の説明**: 設計書にファイル配置方針（レイヤー別構成 or ドメイン別構成）が明記されていない。既存システムがレイヤー別構成（`controller/`, `service/`, `repository/`）を採用している場合、新設計でも同一の方針を採用すべきだが、検証に必要な情報が欠落している。
- **検出判定基準**:
  - ○（検出）: ファイル配置方針（レイヤー別 or ドメイン別）が設計書に明記されておらず、既存パターンとの一貫性が検証できないことを指摘している
  - △（部分検出）: ディレクトリ構造について言及しているが、「既存パターンとの一貫性検証が必要」という観点が明確でない
  - ×（未検出）: ファイル配置方針について言及がない

### P10: 実装パターン（情報欠落） - JWTトークン保存方式の未文書化
- **カテゴリ**: 実装パターンの既存パターンとの一致（情報欠落）
- **深刻度**: 軽微
- **該当箇所**: セクション5（API設計）、認証・認可方式
- **問題の説明**: JWTトークンの送信方式（`Authorization: Bearer {token}`）は明記されているが、フロントエンドでのトークン保存方式（localStorage, sessionStorage, HttpOnly Cookie等）が明記されていない。既存システムが特定の保存方式（例: HttpOnly Cookie）を採用している場合、新設計でも同一の方針を採用すべきだが、検証に必要な情報が欠落している。
- **検出判定基準**:
  - ○（検出）: JWTトークンのフロントエンド保存方式が設計書に明記されておらず、既存パターンとの一貫性が検証できないことを指摘している
  - △（部分検出）: JWT認証について言及しているが、「トークン保存方式の一貫性」や「既存パターンとの照合が必要」という観点が明確でない
  - ×（未検出）: JWTトークン保存方式について言及がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | 命名規約 | Contractsテーブルの `contract_status` と他テーブルの `status` の命名統一性 | カラム名のサフィックス命名規則（`status` vs `{テーブル名}_status`）の混在を指摘している |
| B02 | 命名規約 | Paymentsテーブルの `billing_year_month`, Remittancesテーブルの `remittance_year_month` の型が VARCHAR(7) で統一されているが、既存システムが DATE型を使用している場合の不整合 | 日付関連データの型選定（VARCHAR vs DATE/TIMESTAMP）の一貫性を指摘している |
| B03 | API設計 | 契約管理APIの `/terminate` エンドポイントが POST メソッドを使用しているが、既存システムが DELETE または PATCH を使用している場合の不整合 | 解約・削除操作のHTTPメソッド選定の一貫性を指摘している |
| B04 | 実装パターン | ログ形式のJSON構造化ログが既存システムの平文ログ形式と異なる可能性 | ログ出力形式（JSON構造化 vs 平文）の一貫性確認が必要と指摘している |
| B05 | 依存管理 | セクション2でTerraformを使用したインフラ管理が記述されているが、既存システムがCloudFormation等の別ツールを使用している場合の不整合 | インフラコード管理ツールの選定の一貫性を指摘している |
| B06 | 依存管理 | セクション2でGitHub Actionsによる CI/CD が記述されているが、既存システムが Jenkins等の別ツールを使用している場合の不整合 | CI/CDツールの選定の一貫性を指摘している |
