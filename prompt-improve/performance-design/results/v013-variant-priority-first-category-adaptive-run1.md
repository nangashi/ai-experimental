# Performance Design Review: スマート農業IoTプラットフォーム

## Pass 1: Critical Issues (System-Wide Impact)

### P01: 単一EC2インスタンス構成による単一障害点（Section 2, 3）
**問題**: システム全体が単一のt3.mediumインスタンス上で動作しており、このインスタンスの障害時にすべてのサービス（データ収集、API、分析、アラート）が停止する。99.0%の可用性目標は単一インスタンス構成では達成困難。

**影響**: インスタンス障害時にセンサーデータ収集が停止し、自動灌水制御や異常アラートが機能しなくなる。農繁期の長時間停止は作物被害に直結。

**推奨**: Auto Scaling Group (最小2インスタンス) + Application Load Balancer構成に変更。MQTTブローカーとRabbitMQも冗長化構成を検討。

### P02: センサーデータ保存のスケーラビリティ欠如（Section 4, 7）
**問題**: sensor_readingsコレクションに対するインデックス設計、TTL設定、パーティショニング戦略が未定義。200センサー×秒間1000メッセージ×長期保存で数億～数十億ドキュメントが蓄積し、クエリ性能が指数関数的に劣化。

**影響**: 数ヶ月後にはダッシュボード表示が3秒目標を大幅超過し、システム全体が実質的に使用不能になる。

**推奨**:
- `{sensor_id: 1, timestamp: -1}` の複合インデックス作成
- 時系列データのパーティショニング（月次/年次）
- 古いデータのアーカイブ戦略（例: 1年以上前は日次集計データのみ保持）
- MongoDB Time Series Collection (v5.0+) の採用検討

### P03: N+1クエリ問題によるダッシュボード性能劣化（Section 5, line 118-146）
**問題**: `/api/farms/:farmId/dashboard`でセンサーごとにMongoDBへの個別クエリを実行（line 130-135）。50-200センサーの大規模圃場では50-200回のデータベース往復が発生し、3秒レスポンス目標の達成が不可能。

**影響**: 大規模農業法人ユーザーでダッシュボードが10秒以上応答しなくなり、サービスレベル目標違反。

**推奨**: MongoDBの`$in`オペレータで全センサーの最新値を一括取得に変更:
```javascript
const sensorIds = sensors.rows.map(s => s.id);
const readings = await mongodb.collection('sensor_readings').aggregate([
  { $match: { sensor_id: { $in: sensorIds } } },
  { $sort: { timestamp: -1 } },
  { $group: { _id: "$sensor_id", latest: { $first: "$$ROOT" } } }
]).toArray();
```

### P04: センサー履歴クエリの結果件数制限欠如（Section 5, line 151-165）
**問題**: `sensor-history` APIで日付範囲のみで絞り込み、結果件数の上限がない。1年間のデータ要求で数百万レコードを返却し、メモリ不足やネットワーク帯域消費で障害を引き起こす。

**影響**: ユーザーが広範囲の履歴データを要求した際にサーバークラッシュまたは極端なレスポンス遅延が発生。

**推奨**: ページネーション実装（limit/offset）とデフォルト上限（例: 10,000件）を設定。長期分析には集計データAPIを別途提供。

## Pass 2: Significant Issues by Category

### 2a. I/O & Data Access Efficiency

### P05: PostgreSQLテーブルへのインデックス未定義（Section 4）
**問題**: `farms.user_id`, `sensors.farm_id`, `irrigation_schedules.farm_id` などの外部キー列にインデックスが明示されていない。ユーザーの圃場一覧取得や圃場のセンサー一覧取得で全表走査が発生。

**影響**: 多数の圃場を管理する農業コンサルタントのクエリで秒単位の遅延が発生。

**推奨**: 以下のインデックスを追加:
```sql
CREATE INDEX idx_farms_user_id ON farms(user_id);
CREATE INDEX idx_sensors_farm_id ON sensors(farm_id);
CREATE INDEX idx_irrigation_schedules_farm_id ON irrigation_schedules(farm_id);
CREATE INDEX idx_sensors_device_id ON sensors(device_id); -- UNIQUE制約で自動作成されるが明示推奨
```

### P06: 外部API呼び出しのキャッシング戦略欠如（Section 1, 3）
**問題**: 収穫予測機能でOpenWeatherMap APIを呼び出すが、キャッシング戦略が未定義。同一地域の気象データを複数ユーザーが重複取得し、APIレート制限に抵触するリスク。

**影響**: API呼び出し制限超過による収穫予測機能の停止、または従量課金コストの増大。

**推奨**:
- 気象データを地域×時刻単位でRedisにキャッシュ（TTL: 30分）
- 同一地域の複数圃場で気象データを共有

### 2b. Real-Time Communication & Scalability

### P07: MQTTブローカーの接続数上限とメッセージ処理能力の未検証（Section 3, 7）
**問題**: 100センサー同時接続・秒間1000メッセージの性能要件が定義されているが、MQTTブローカーの具体的な実装（Mosquitto/EMQX等）と接続数上限、メッセージスループットの検証計画が欠如。

**影響**: 大規模農業法人の200センサー環境で接続拒否やメッセージ損失が発生。

**推奨**:
- MQTTブローカー実装の明記と性能ベンチマーク実施
- クライアント接続数とメッセージレートの監視・アラート設定
- QoS設定の明示（データ損失許容度に応じてQoS 0/1/2を選択）

### P08: WebSocketによるリアルタイム更新の実装欠如（Section 1, 5）
**問題**: ダッシュボードでセンサーデータのリアルタイム表示が要件に含まれるが、API設計はREST（ポーリング）のみ。頻繁なポーリングは帯域消費とサーバー負荷を増大させる。

**影響**: 10秒ごとのポーリングで200ユーザー×複数圃場のダッシュボード更新時に数千req/minの負荷が発生。

**推奨**: WebSocket/Server-Sent Events (SSE) でセンサーデータ更新をpush配信。MQTTブローカーからのメッセージをWebSocketクライアントにブロードキャスト。

### 2c. Caching & Memory Management

### P09: ダッシュボードデータのキャッシング欠如（Section 5）
**問題**: 圃場情報・センサー一覧・灌水スケジュールなど変更頻度の低いデータを毎リクエストでデータベースから取得。同一ユーザーの連続アクセスで重複クエリが発生。

**影響**: データベース負荷の増大と不要なレイテンシ。

**推奨**:
- 圃場メタデータ（farms, sensors）をアプリケーションメモリまたはRedisにキャッシュ（TTL: 10分、更新時invalidate）
- センサー最新値のみリアルタイム取得

## Pass 3: Moderate Issues by Category

### 3a. Resource Management

### P10: データベース接続プーリング設定の未記載（Section 2, 6）
**問題**: PostgreSQLとMongoDBの接続プール設定（最大接続数、接続タイムアウト、アイドルタイムアウト）が未定義。単一EC2インスタンスでコネクション枯渇のリスク。

**影響**: 高負荷時にデータベース接続待ちでリクエスト処理が停滞。

**推奨**:
```javascript
// PostgreSQL (pg)
const pool = new Pool({
  max: 20, // 最大接続数
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000
});

// MongoDB
const client = new MongoClient(uri, {
  maxPoolSize: 50,
  minPoolSize: 10,
  maxIdleTimeMS: 30000
});
```

### P11: 外部API呼び出しのタイムアウト・リトライ設定欠如（Section 3, 6）
**問題**: OpenWeatherMap API呼び出しにタイムアウトやリトライロジックが定義されていない。API障害時に収穫予測機能が無期限ハングする。

**影響**: 外部API遅延時にNode.jsイベントループがブロックされ、他のリクエスト処理にも波及。

**推奨**:
- HTTPクライアントにタイムアウト設定（例: 5秒）
- 指数バックオフによるリトライ（最大3回）
- サーキットブレーカーパターンの適用（連続失敗時は一時的にAPI呼び出しをスキップ）

### P12: RabbitMQジョブキューの並列処理数制限欠如（Section 3）
**問題**: レポート生成の非同期ジョブ処理でワーカー数やprefetch設定が未定義。大量のレポート生成リクエストでメモリ不足やCPU飽和のリスク。

**影響**: 月次レポート一斉生成時にサーバーリソース枯渇。

**推奨**:
- ワーカー並列数を明示（例: CPU数×2）
- RabbitMQ `prefetch: 1` でワーカー1つにつき1ジョブのみ割り当て
- レポート生成ジョブのメモリ使用量監視

### 3b. Infrastructure & Monitoring

### P13: パフォーマンスメトリクスの監視・アラート欠如（Section 6, 7）
**問題**: ロギング方針は定義されているが、APIレスポンスタイム、データベースクエリレイテンシ、MQTT接続数、RabbitMQキュー長などのパフォーマンスメトリクスの監視が未定義。

**影響**: 性能劣化の早期検知ができず、ユーザー影響が拡大してから問題が顕在化。

**推奨**:
- CloudWatch Metrics でカスタムメトリクス送信
  - API P95レスポンスタイム (目標: 3秒以内)
  - データベース接続プール使用率
  - MQTT接続数・メッセージレート
  - RabbitMQキュー滞留数
- SLO違反時の自動アラート（PagerDuty/SNS）

### P14: データベースクエリパフォーマンスの可観測性不足（Section 6）
**問題**: PostgreSQL slow query log、MongoDBプロファイラーの設定が未記載。ボトルネッククエリの特定が困難。

**影響**: 性能問題発生時の原因特定に長時間を要する。

**推奨**:
- PostgreSQL slow query log有効化（閾値: 1秒）
- MongoDB Database Profilerでスロークエリ記録（閾値: 500ms）
- APM (Application Performance Monitoring) ツール導入（New Relic/Datadog等）

## Pass 4: Cross-Cutting Patterns

### P15: 灌水制御の同時実行制御欠如（Section 4, 5）
**問題**: `irrigation_schedules`テーブルの`last_executed_at`更新に楽観的ロックやトランザクション分離レベル指定がない。自動灌水と手動灌水の同時実行で`last_executed_at`が不整合になり、重複灌水や実行記録の欠損が発生。

**影響**: 過剰灌水による作物被害、または灌水記録の不正確さによる分析精度低下。

**推奨**:
- 楽観的ロック（`version`カラム追加）または`SELECT FOR UPDATE`で排他制御
- `/api/farms/:farmId/irrigation/execute`のべき等性保証（リクエストIDによる重複実行防止）

### P16: センサーデータのアーカイブ・削除戦略欠如（Section 4, 7）
**問題**: sensor_readingsコレクションの長期データ保持ポリシーが未定義。数年運用でストレージコストが肥大化し、DocumentDBの容量上限に達するリスク。

**影響**: ストレージコスト増大、バックアップ時間の延伸、クエリ性能の継続的劣化。

**推奨**:
- 生データ保持期間の明示（例: 直近1年間のみ、それ以前は日次/時間単位集計データに変換）
- TTLインデックスによる自動削除、またはアーカイブジョブ（S3 Glacier等への退避）
- ストレージ使用量の監視とアラート

### P17: レポート生成の処理時間制限欠如（Section 3, 5）
**問題**: レポート生成が非同期実行されるが、処理時間上限やタイムアウトが未定義。大規模圃場の年次レポートで数十分～数時間かかる可能性があり、RabbitMQワーカーが長時間占有される。

**影響**: レポート生成ジョブがワーカーを占有し、他のジョブ（アラート送信等）が遅延。

**推奨**:
- レポート生成ジョブにタイムアウト設定（例: 10分）
- 大規模データの場合はストリーミング処理またはバッチ分割
- ジョブ優先度設定（アラート > レポート生成）

### P18: JWT有効期限24時間とセキュリティ・パフォーマンスのトレードオフ（Section 5）
**問題**: JWT有効期限24時間は、トークン無効化の遅延（アカウント無効化後も24時間アクセス可能）とトークン検証コストのトレードオフが未検討。頻繁な再認証は性能に影響。

**影響**: セキュリティリスク（漏洩トークンの長時間有効性）、またはトークン更新頻度増加によるAPI負荷増大。

**推奨**:
- アクセストークン（短期: 15分）+ リフレッシュトークン（長期: 7日）のデュアルトークン方式
- トークン無効化が必要な場合はRedisブラックリスト運用
- トークン検証結果の短期キャッシュ（数秒）

## 総評

本設計は基本的なIoTデータ収集・分析機能を実装していますが、**データ量のスケーラビリティとシステム可用性の観点で重大な欠陥**があります。

**最重要課題**:
1. **N+1クエリ問題**（P03）と**インデックス欠如**（P02, P05）により、大規模農業法人での実用に耐えない
2. **単一インスタンス構成**（P01）で99.0%可用性目標の達成は不可能
3. **データ成長戦略の欠如**（P02, P16）により、数ヶ月～1年でシステム性能が崩壊

**推奨される優先対応順**:
1. P03（N+1クエリ）、P04（結果件数制限）、P05（インデックス）を即座に修正 → 短期的な性能改善
2. P02（センサーデータのインデックス・パーティショニング）、P16（アーカイブ戦略）を設計 → 中長期的な運用可能性確保
3. P01（冗長化構成）、P07（MQTTスケーラビリティ）を検討 → 可用性目標達成
4. その他の推奨事項を段階的に実装

現状のままプロダクション投入すると、初期ユーザー（小規模農家）では動作するものの、大規模農業法人の参加や長期運用で致命的な性能問題が顕在化します。
