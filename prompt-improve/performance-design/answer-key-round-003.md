# 正解キー

## 実行条件
- **観点**: performance
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: N+1問題（フォロワー通知送信）
- **カテゴリ**: I/O・ネットワーク効率
- **深刻度**: 重大
- **該当箇所**: セクション3.3「配信開始フロー」ステップ5
- **問題の説明**: Notification Serviceが「フォロワー全員に通知を送信」する際、フォロワーを1件ずつ取得してループ処理で通知APIを呼び出す実装になる可能性が高い。フォロワーが数千人いる場合、配信開始時に数千回のAPI呼び出しが発生し、配信開始が遅延する。
- **検出判定基準**:
  - ○（検出）: フォロワー通知送信時のN+1問題またはループ処理による大量API呼び出しの指摘がある
  - △（部分検出）: 通知処理の非同期化やバッチ化への言及はあるが、N+1問題の具体的指摘がない
  - ×（未検出）: 通知処理に関する指摘がない

### P02: チャットブロードキャストのN+1問題
- **カテゴリ**: I/O・ネットワーク効率
- **深刻度**: 重大
- **該当箇所**: セクション3.3「チャット送信フロー」ステップ4
- **問題の説明**: Chat Serviceが「同じ配信を視聴中の全視聴者にメッセージをブロードキャスト」する際、視聴者リストを取得してループでWebSocketメッセージを送信する設計になっている。数千人同時視聴時にチャットが遅延し、サーバー負荷が上昇する。
- **検出判定基準**:
  - ○（検出）: チャットブロードキャスト時のループ処理または視聴者数に比例した処理負荷の指摘がある
  - △（部分検出）: チャット配信の負荷軽減策（サブスクリプション、Pub/Sub）への言及はあるが、N+1問題の明示的指摘がない
  - ×（未検出）: チャット配信処理に関する指摘がない

### P03: 視聴者数カウントの頻繁なRedis更新
- **カテゴリ**: I/O・ネットワーク効率
- **深刻度**: 中
- **該当箇所**: セクション3.3「視聴者参加フロー」ステップ4
- **問題の説明**: 視聴者が参加・退出するたびに「視聴者数カウントをRedisでインクリメント」する設計では、視聴者の頻繁な出入りがあるとRedisへの書き込みが頻発し、I/O負荷が上昇する。また、リアルタイム性が不要な場合は過剰な更新となる。
- **検出判定基準**:
  - ○（検出）: 視聴者数カウントの頻繁な更新または書き込み頻度削減策（バッチ更新、間引き）の必要性を指摘している
  - △（部分検出）: Redisの負荷やキャッシュ戦略への言及はあるが、視聴者数カウント更新頻度への具体的指摘がない
  - ×（未検出）: 視聴者数カウント処理に関する指摘がない

### P04: アーカイブ動画の大容量ファイル処理
- **カテゴリ**: メモリ・リソース管理
- **深刻度**: 重大
- **該当箇所**: セクション3.2「Archive Service」、セクション4.2「archivesテーブル」
- **問題の説明**: Archive Serviceが「配信終了後の録画ファイル処理とS3保存」を行う際、長時間配信の場合は数GB～数十GBの動画ファイルをメモリに読み込んでS3にアップロードする可能性がある。ストリーム転送やマルチパートアップロードを使用しない場合、メモリ枯渇やタイムアウトが発生する。
- **検出判定基準**:
  - ○（検出）: アーカイブ動画の大容量ファイル処理におけるメモリ負荷またはストリーム転送・マルチパートアップロードの必要性を指摘している
  - △（部分検出）: S3アップロードの最適化への言及はあるが、大容量ファイルのメモリ処理への具体的指摘がない
  - ×（未検出）: アーカイブ処理に関する指摘がない

### P05: フォロワー一覧取得のインデックス欠如
- **カテゴリ**: レイテンシ・スループット設計とスケーラビリティ
- **深刻度**: 中
- **該当箇所**: セクション4.2「followsテーブル」、セクション5.1「GET /api/users/{user_id}/followers」
- **問題の説明**: followsテーブルにfollower_idとfollowing_idのインデックスが明示されていない。人気配信者のフォロワーが数万人いる場合、フォロワー一覧取得（WHERE following_id = ?）がフルテーブルスキャンとなり、レスポンスが遅延する。
- **検出判定基準**:
  - ○（検出）: followsテーブルへのインデックス追加または大量フォロワー取得時のクエリ効率化の必要性を指摘している
  - △（部分検出）: データベースのインデックス戦略への一般的言及はあるが、followsテーブルへの具体的指摘がない
  - ×（未検出）: followsテーブルまたはフォロワー一覧取得に関する指摘がない

### P06: 配信一覧取得のページネーション欠如
- **カテゴリ**: I/O・ネットワーク効率
- **深刻度**: 中
- **該当箇所**: セクション5.1「GET /api/streams」
- **問題の説明**: 配信一覧取得APIにページネーションやリミット指定が設計されていない。過去配信が数千件蓄積された場合、全件取得によりメモリ消費とレスポンスサイズが肥大化し、フロントエンドの描画パフォーマンスも低下する。
- **検出判定基準**:
  - ○（検出）: 配信一覧取得APIへのページネーション追加または大量データ取得時の性能問題を指摘している
  - △（部分検出）: APIのページネーション設計への一般的言及はあるが、配信一覧取得への具体的指摘がない
  - ×（未検出）: 配信一覧取得APIに関する指摘がない

### P07: 配信メタデータの同期書き込み
- **カテゴリ**: レイテンシ・スループット設計とスケーラビリティ
- **深刻度**: 中
- **該当箇所**: セクション3.3「配信開始フロー」ステップ3-4
- **問題の説明**: 配信開始時に「配信メタデータをPostgreSQLに保存」と「Redisに配信状態を記録」を同期的に実行する設計。PostgreSQL書き込み完了を待ってからRedis書き込みを行うと、配信開始のレイテンシが増加する。並行処理または非同期化が望ましい。
- **検出判定基準**:
  - ○（検出）: 配信開始時のPostgreSQL/Redis書き込みの並行化または非同期化の必要性を指摘している
  - △（部分検出）: データベース書き込みの非同期化への一般的言及はあるが、配信開始フローへの具体的指摘がない
  - ×（未検出）: 配信開始処理の書き込みに関する指摘がない

### P08: パフォーマンス目標値の未定義
- **カテゴリ**: レイテンシ・スループット設計とスケーラビリティ
- **深刻度**: 中
- **該当箇所**: セクション7（非機能要件全体）
- **問題の説明**: 設計書にレスポンスタイム、スループット、同時接続数などのパフォーマンス目標値が記載されていない。負荷テストやスケーリング設計の基準が不明確であり、本番環境で性能要件を満たせない可能性がある。
- **検出判定基準**:
  - ○（検出）: パフォーマンス目標値（レスポンスタイム、スループット、同時接続数）の未定義を指摘している
  - △（部分検出）: 非機能要件の不足への言及はあるが、パフォーマンス目標値への具体的指摘がない
  - ×（未検出）: パフォーマンス目標値に関する指摘がない

### P09: アーカイブデータの長期増大
- **カテゴリ**: レイテンシ・スループット設計とスケーラビリティ
- **深刻度**: 軽微
- **該当箇所**: セクション4.2「archivesテーブル」、セクション7.3「データ保持ポリシー」
- **問題の説明**: アーカイブ動画が無制限に蓄積されるとarchivesテーブルのレコード数が増大し、検索性能が低下する。データ保持ポリシーはS3ストレージクラス移行のみで、テーブルのパーティショニングや古いレコードの削除戦略が欠如している。
- **検出判定基準**:
  - ○（検出）: archivesテーブルの長期データ増大に対するパーティショニングまたは削除戦略の必要性を指摘している
  - △（部分検出）: データベースのパーティショニング戦略への一般的言及はあるが、archivesテーブルへの具体的指摘がない
  - ×（未検出）: archivesテーブルのデータ増大に関する指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | キャッシュ戦略 | ユーザー情報取得（GET /api/users/{user_id}）にキャッシュがない | ユーザー情報のキャッシュ戦略を提案している |
| B02 | I/O効率 | Stripe API呼び出しのリトライ・タイムアウト設計が未定義 | 外部API呼び出しのリトライ・タイムアウト設計を指摘している |
| B03 | 並行処理 | 配信終了時の録画ファイル処理（Archive Service）の非同期化 | アーカイブ処理の非同期化・バックグラウンド処理を提案している |
| B04 | スケーラビリティ | WebSocketゲートウェイの水平スケーリング戦略が未定義 | WebSocketの水平スケーリング（セッション共有、Sticky Session）を指摘している |
| B05 | キャッシュ戦略 | 配信一覧（GET /api/streams）のキャッシュ戦略 | 配信一覧APIのキャッシュまたはRedisキャッシュ戦略を提案している |
| B06 | データベース設計 | streamsテーブルへのインデックス（user_id, status）追加 | streamsテーブルへのインデックス追加を提案している |
| B07 | 監視 | パフォーマンスメトリクス（レスポンスタイム、スループット）の監視設計欠如 | パフォーマンスメトリクス収集・監視の必要性を指摘している |
| B08 | CDN最適化 | CloudFrontのキャッシュ戦略（TTL、キャッシュキー設計）が未定義 | CDNキャッシュ戦略の最適化を提案している |
| B09 | リソース管理 | データベースコネクションプールの設定（最大接続数、タイムアウト）が未定義 | コネクションプールの設定を提案している |
| B10 | 並行処理 | Redis操作のパイプライン化またはバッチ処理 | Redis操作の最適化（パイプライン、Luaスクリプト）を提案している |
