# 正解キー

## 実行条件
- **観点**: structural-quality
- **対象**: design
- **埋め込み問題数**: 9問

---

## 埋め込み問題一覧

### P01: TicketSalesEngineの単一責務原則違反
- **カテゴリ**: SOLID原則・構造設計
- **深刻度**: 重大
- **該当箇所**: セクション3「主要コンポーネント」- TicketSalesEngine
- **問題の説明**: TicketSalesEngineが、チケット販売ロジックに加え、決済処理（Stripe API直接呼び出し）、メール送信、QRコード生成、イベント主催者への通知という4つの異なる責務を持っている。これは単一責務原則（SRP）の違反であり、変更理由が複数存在する（決済プロバイダ変更、メールテンプレート変更、QRコード生成方式変更、通知方式変更）。
- **検出判定基準**:
  - ○（検出）: TicketSalesEngineが複数の責務を持つことを指摘し、決済処理・通知処理・QRコード生成のいずれか1つ以上を別コンポーネントへの分離を提案している
  - △（部分検出）: TicketSalesEngineの責務が多いことに言及しているが、具体的な分離提案がない
  - ×（未検出）: 指摘なし

### P02: EventManagerとTicketSalesEngineの直接的データアクセス層バイパス
- **カテゴリ**: SOLID原則・構造設計（依存方向の逆転）
- **深刻度**: 重大
- **該当箇所**: セクション3「アーキテクチャ設計」- EventManager, TicketSalesEngine
- **問題の説明**: 3層アーキテクチャを謳いながら、EventManagerがPostgreSQLとRedisに直接接続し、TicketSalesEngineがStripe APIを直接呼び出している。Data Access Layerの概念が形骸化しており、ビジネスロジック層が外部依存に直接結合している。これによりテスタビリティが低下し、外部依存のモック化が困難になる。
- **検出判定基準**:
  - ○（検出）: ビジネスロジック層（EventManager/TicketSalesEngine）が外部依存（DB/API）に直接接続していることを指摘し、Data Access Layerやリポジトリパターンの導入を提案している
  - △（部分検出）: 外部依存への直接アクセスに言及しているが、レイヤー分離の観点からの指摘がない
  - ×（未検出）: 指摘なし

### P03: eventsテーブルとticketsテーブルのデータ冗長性
- **カテゴリ**: データモデル設計
- **深刻度**: 重大
- **該当箇所**: セクション4「データモデル」- events, tickets
- **問題の説明**: eventsテーブルに`organizer_name`と`organizer_email`が、ticketsテーブルに`event_title`, `event_date`, `venue_name`が冗長に保存されている。これらは正規化すればusers/eventsテーブルから参照可能な情報であり、データの不整合リスク（主催者名変更時にeventsテーブルのorganizer_nameが更新されない、イベント情報変更時にticketsテーブルのevent_titleが古いまま等）が存在する。
- **検出判定基準**:
  - ○（検出）: events/ticketsテーブルのデータ冗長性を指摘し、正規化または参照整合性の保証方法（参照時のJOIN、イベントスナップショットの意図明示等）を提案している
  - △（部分検出）: データ冗長性に言及しているが、不整合リスクや対策の具体性が不足している
  - ×（未検出）: 指摘なし

### P04: 決済処理・在庫管理のトランザクション境界未定義
- **カテゴリ**: エラーハンドリング・オブザーバビリティ（アプリケーションレベルのリカバリー戦略）
- **深刻度**: 中
- **該当箇所**: セクション3「データフロー」- 決済・在庫更新フロー
- **問題の説明**: 決済成功後にチケット発行・在庫更新を行うフローにおいて、トランザクション境界とエラーリカバリー戦略が未定義。決済成功後にチケット発行が失敗した場合の補償トランザクション（返金処理）、在庫更新が失敗した場合の再試行/整合性保証の設計が記載されていない。
- **検出判定基準**:
  - ○（検出）: 決済処理と在庫更新のトランザクション境界または補償トランザクション（Saga等のアプリケーションレベル戦略）の欠如を指摘し、リカバリー設計の必要性を提案している
  - △（部分検出）: トランザクション/整合性に言及しているが、具体的なリカバリー戦略の提案がない
  - ×（未検出）: 指摘なし

### P05: JWTトークンの不適切な保存先
- **カテゴリ**: 変更影響・モジュール設計（状態管理）
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」- 認証・認可方式
- **問題の説明**: Access TokenとRefresh Tokenをローカルストレージに保存している。これはXSS攻撃によるトークン窃取のリスクがあり、一般的なベストプラクティス（Access TokenはメモリまたはhttpOnly Cookie、Refresh TokenはhttpOnly Cookie）に反する。ただし、本問題はセキュリティ観点のためスコープ外の可能性あり。
- **検出判定基準**:
  - ○（検出）: JWTトークンのローカルストレージ保存のリスクを指摘し、httpOnly Cookieまたはメモリ保存を提案している（ボーナス問題としても扱う）
  - △（部分検出）: トークン管理に言及しているが、具体的な保存先の問題を指摘していない
  - ×（未検出）: 指摘なし

### P06: 単体テスト方針の欠如とDI設計の不在
- **カテゴリ**: テスト設計・テスタビリティ
- **深刻度**: 中
- **該当箇所**: セクション6「実装方針」- テスト方針
- **問題の説明**: テスト方針として「実装完了後に統合テストを実施。単体テストの方針は未定」と記載されている。また、セクション3のアーキテクチャ設計においてDI（Dependency Injection）設計が記載されておらず、EventManagerやTicketSalesEngineが外部依存（DB, Stripe API）に直接結合している。これによりビジネスロジックの単体テストが困難になる。
- **検出判定基準**:
  - ○（検出）: 単体テスト方針の欠如またはDI設計の不在を指摘し、DIコンテナの導入や外部依存の抽象化（インターフェース化）を提案している
  - △（部分検出）: テスト方針の不足に言及しているが、DI設計の必要性に触れていない
  - ×（未検出）: 指摘なし

### P07: RESTful API設計原則の違反（動詞ベースURL）
- **カテゴリ**: API・データモデル品質
- **深刻度**: 軽微
- **該当箇所**: セクション5「API設計」- エンドポイント一覧
- **問題の説明**: エンドポイントが動詞ベースのURL（`/events/create`, `/events/{eventId}/update`, `/events/{eventId}/delete`, `/tickets/purchase`, `/tickets/{ticketId}/cancel`）を使用している。RESTful設計では、リソースを名詞で表現し、HTTPメソッド（POST, PUT, DELETE）で操作を表現すべき（例: `POST /events`, `PUT /events/{eventId}`, `DELETE /events/{eventId}`）。
- **検出判定基準**:
  - ○（検出）: エンドポイントが動詞ベースであることを指摘し、RESTful原則に従った名詞+HTTPメソッドの組み合わせを提案している
  - △（部分検出）: API設計に違和感があることに言及しているが、RESTful原則の具体的な違反を指摘していない
  - ×（未検出）: 指摘なし

### P08: 環境固有設定の管理戦略の脆弱性
- **カテゴリ**: 拡張性・運用設計
- **深刻度**: 軽微
- **該当箇所**: セクション6「実装方針」- デプロイメント方針
- **問題の説明**: 環境変数を`.env`ファイルで管理し、dev/staging/prodを手動切り替えするとされている。これは環境差分の管理が属人的であり、本番環境への誤った設定適用リスクがある。環境ごとに独立した設定ファイル（`.env.dev`, `.env.staging`, `.env.prod`）またはAWS Systems Manager Parameter Store等の設定管理サービスを使用すべき。
- **検出判定基準**:
  - ○（検出）: 手動切り替えによる設定管理のリスクを指摘し、環境別ファイルまたは設定管理サービスの使用を提案している
  - △（部分検出）: 設定管理の脆弱性に言及しているが、具体的な改善策の提案がない
  - ×（未検出）: 指摘なし

### P09: EventManagerとTicketSalesEngineの直接的コンポーネント結合
- **カテゴリ**: 変更容易性・モジュール設計（変更影響範囲の限定）
- **深刻度**: 中
- **該当箇所**: セクション3「主要コンポーネント」- TicketSalesEngine
- **問題の説明**: TicketSalesEngineがEventManagerを直接呼び出してイベント情報を取得している。これによりEventManagerの内部実装変更（メソッドシグネチャ変更、キャッシュロジック追加等）がTicketSalesEngineに波及する。インターフェースを介した疎結合設計またはイベント駆動アーキテクチャによる非同期連携を検討すべき。
- **検出判定基準**:
  - ○（検出）: EventManagerとTicketSalesEngineの直接的結合を指摘し、インターフェース抽象化またはイベント駆動アーキテクチャを提案している
  - △（部分検出）: コンポーネント間の結合に言及しているが、具体的な改善策の提案がない
  - ×（未検出）: 指摘なし

---

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | SOLID原則 | UserAuthServiceの責務範囲: 認証と認可を単一クラスで実装しているが、将来的にロールベースアクセス制御（RBAC）や多要素認証（MFA）を追加する場合、責務分離が望ましい | 認証と認可の責務分離を提案している |
| B02 | エラーハンドリング | エラーハンドリング方針が「HTTPステータスコードで返す」のみで、エラーの分類（業務エラー/システムエラー/外部依存エラー）やログレベル（ERROR/WARN/INFO）の戦略が未定義 | エラー分類やログレベルの戦略の欠如を指摘している |
| B03 | API設計 | APIバージョニング戦略が未定義。将来的な後方互換性のないAPI変更時の対応方法が不明 | APIバージョニング戦略の欠如を指摘している |
| B04 | データモデル設計 | available_seatsの楽観的同時実行制御の欠如。複数ユーザーが同時に最後の1席を購入しようとした場合、競合検出・再試行メカニズムが未定義 | 同時実行制御（楽観ロック、version列等）の欠如を指摘している |
| B05 | テスト設計 | エラーケース（決済失敗、在庫不足、外部API障害等）のテスト戦略が未定義 | エラーケースのテスト戦略の欠如を指摘している |
