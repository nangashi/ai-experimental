# 正解キー

## 実行条件
- **観点**: structural-quality
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: CourseServiceの単一責務原則違反
- **カテゴリ**: SOLID原則・構造設計
- **深刻度**: 重大
- **該当箇所**: セクション3「アーキテクチャ設計」のCourseService説明
- **問題の説明**: CourseServiceが「コース管理、課題管理、進捗トラッキング、証明書発行」という複数の独立した責務を統合している。これはSRP（単一責務原則）に違反し、変更理由が複数存在する（コース管理の変更、課題管理の変更、進捗トラッキングの変更など）。各責務は独立したサービスに分割すべき。
- **検出判定基準**:
  - ○（検出）: CourseServiceが複数の責務（コース管理、課題管理、進捗トラッキング、証明書発行のうち2つ以上）を持つことを指摘し、SRP違反またはサービス分割の必要性に言及している
  - △（部分検出）: CourseServiceの責務が多いことに言及しているが、SRP違反または具体的な分割方針に言及していない
  - ×（未検出）: CourseServiceの責務集中について言及していない

### P02: レイヤー分離の欠如とデータアクセス層の直接結合
- **カテゴリ**: SOLID原則・構造設計
- **深刻度**: 重大
- **該当箇所**: セクション3「アーキテクチャ設計」のCourseService説明およびデータフロー
- **問題の説明**: CourseServiceが「PostgreSQL、MongoDB、Redisに直接アクセス」しており、ビジネスロジック層とデータアクセス層が分離されていない。また「データベースに直接クエリを実行」という記述から、Repositoryパターン等の抽象化層が欠如していることが示唆される。これは結合度を高め、データストア変更時の影響範囲が拡大する。
- **検出判定基準**:
  - ○（検出）: CourseServiceが複数のデータストアに直接アクセスしていることを指摘し、レイヤー分離の欠如、Repositoryパターン等の抽象化層の必要性、またはデータアクセス層の分離に言及している
  - △（部分検出）: データアクセスの直接結合に言及しているが、レイヤー分離や抽象化の必要性に具体的に触れていない
  - ×（未検出）: データアクセス層の結合について言及していない

### P03: データモデルの冗長性と非正規化リスク
- **カテゴリ**: API・データモデル品質
- **深刻度**: 重大
- **該当箇所**: セクション4「データモデル」のPostgreSQLスキーマとMongoDBコレクション
- **問題の説明**: course_enrollmentsテーブルの`progress`カラムとMongoDB learning_progressコレクションで進捗情報が二重管理されている。PostgreSQLでは整数値（`progress INT`）、MongoDBでは詳細な視聴履歴（watched_seconds, last_position等）として保存されており、データの整合性を保つ責任が明示されていない。どちらが信頼できる情報源（Source of Truth）なのか不明確で、更新時の同期戦略も定義されていない。
- **検出判定基準**:
  - ○（検出）: course_enrollmentsの`progress`とMongoDB learning_progressの進捗情報が二重管理されていることを指摘し、データ整合性のリスク、Source of Truthの不明確さ、または同期戦略の欠如に言及している
  - △（部分検出）: 進捗情報が複数箇所に存在することに言及しているが、整合性リスクや同期戦略の必要性に具体的に触れていない
  - ×（未検出）: 進捗情報の二重管理について言及していない

### P04: エラーハンドリング戦略の分類体系欠如
- **カテゴリ**: エラーハンドリング・オブザーバビリティ
- **深刻度**: 中
- **該当箇所**: セクション6「実装方針」のエラーハンドリング方針
- **問題の説明**: エラーハンドリング方針に「例外の種類ごとに異なるメッセージを返す（詳細な分類体系は未定義）」と明記されており、アプリケーションレベルのエラー分類体系（ドメイン例外のカテゴリ、リトライ可能/不可能なエラーの区別、クライアント起因/サーバー起因の分類等）が欠如している。これはエラーリカバリー戦略の設計とクライアント側の適切なエラーハンドリングを困難にする。
- **検出判定基準**:
  - ○（検出）: エラー分類体系の欠如を指摘し、ドメイン例外のカテゴリ化、リトライ可能/不可能なエラーの区別、またはエラーコード設計の必要性に言及している
  - △（部分検出）: エラーハンドリング方針の不十分さに言及しているが、分類体系やリトライ戦略等の具体的な設計項目に触れていない
  - ×（未検出）: エラー分類体系の欠如について言及していない

### P05: RESTful API設計原則違反（動詞ベースURL）
- **カテゴリ**: API・データモデル品質
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」のCourse API
- **問題の説明**: `POST /courses/{id}/enroll`および`POST /courses/{id}/complete`は動詞ベースのURLであり、RESTful設計原則に反する。RESTではリソースを名詞で表現し、HTTPメソッドで操作を示すべき。`POST /courses/{id}/enrollments`（登録リソースの作成）や`PUT /courses/{id}/enrollments/{enrollmentId}`（enrollmentのstatus更新）等のリソース指向設計が望ましい。
- **検出判定基準**:
  - ○（検出）: `/enroll`または`/complete`エンドポイントが動詞ベースのURLであることを指摘し、RESTful原則違反または名詞ベースのリソース指向設計の必要性に言及している
  - △（部分検出）: API設計の問題に言及しているが、動詞ベースURLの問題や具体的な改善案（リソース名詞化）に触れていない
  - ×（未検出）: 動詞ベースURLについて言及していない

### P06: テスタビリティの欠如（外部依存の直接結合とDI設計の不在）
- **カテゴリ**: テスト設計・テスタビリティ
- **深刻度**: 中
- **該当箇所**: セクション3「アーキテクチャ設計」およびセクション6「テスト方針」
- **問題の説明**: アーキテクチャ設計でCourseServiceがPostgreSQL、MongoDB、Redisに直接アクセスし、テスト方針に「モックは使用せず、実際のDBに接続してテスト」と明記されている。これは外部依存の抽象化とDI設計の欠如を示し、単体テストでのモック化が困難になる。統合テストのみに依存すると、テスト実行速度が遅く、障害の特定が困難になる。
- **検出判定基準**:
  - ○（検出）: 外部依存（DB、キャッシュ等）の直接結合を指摘し、DI設計の欠如、抽象化層（Repository等）の必要性、またはモック可能な設計の欠如に言及している
  - △（部分検出）: テスト方針の問題（モック不使用、統合テスト依存）に言及しているが、DI設計や抽象化層の必要性に具体的に触れていない
  - ×（未検出）: 外部依存の結合やテスタビリティの問題について言及していない

### P07: API バージョニング戦略の欠如
- **カテゴリ**: API・データモデル品質
- **深刻度**: 中
- **該当箇所**: セクション5「API設計」
- **問題の説明**: API設計にバージョニング戦略（URL path versioning `/v1/courses`、ヘッダーバージョニング、クエリパラメータバージョニング等）が定義されていない。既存のLMSとの統合を想定する場合、API仕様変更時の後方互換性維持が重要であり、バージョニングと非推奨化（deprecation）の戦略が必要。
- **検出判定基準**:
  - ○（検出）: APIバージョニング戦略の欠如を指摘し、バージョニング方式（URL、ヘッダー等）または後方互換性維持の必要性に言及している
  - △（部分検出）: API仕様変更時の互換性問題に言及しているが、バージョニング戦略の具体的な必要性に触れていない
  - ×（未検出）: APIバージョニングについて言及していない

### P08: 環境差分管理の具体性欠如
- **カテゴリ**: 拡張性・運用設計
- **深刻度**: 軽微
- **該当箇所**: セクション6「デプロイメント方針」
- **問題の説明**: 環境変数で設定を管理すると記載されているが、複数のデータストア（PostgreSQL、MongoDB、Redis）、外部サービス（S3、CloudFront、RabbitMQ、Elasticsearch）を使用する構成において、環境差分の具体的な管理方針（設定ファイルの構造、シークレット管理、環境固有の接続先設定等）が定義されていない。開発環境と本番環境で異なる接続先やリソースの管理方法が不明確。
- **検出判定基準**:
  - ○（検出）: 環境差分管理の具体性欠如を指摘し、設定ファイル構造、シークレット管理、または複数データストアの環境別接続先管理の必要性に言及している
  - △（部分検出）: 環境変数管理の不十分さに言及しているが、複数データストア構成における具体的な管理方針の必要性に触れていない
  - ×（未検出）: 環境差分管理の具体性について言及していない

### P09: 認証トークンの保存先セキュリティリスクとリフレッシュトークン戦略の欠如
- **カテゴリ**: 変更容易性・モジュール設計（状態管理）
- **深刻度**: 軽微
- **該当箇所**: セクション5「API設計」の認証・認可方式
- **問題の説明**: JWTトークンをローカルストレージに保存し、リフレッシュトークンが未実装（短期トークンのみ）となっている。ローカルストレージは状態管理の観点からXSS脆弱性リスクがあり、より安全な保存先（HttpOnly Cookie等）の検討が必要。また、短期トークンのみの実装ではユーザー体験が損なわれ（頻繁な再ログイン）、長期トークンを使用するとセキュリティリスクが高まる。リフレッシュトークン戦略の検討が必要。
- **検出判定基準**:
  - ○（検出）: JWTのローカルストレージ保存とリフレッシュトークン未実装の両方を指摘し、状態管理の観点から保存先の再検討（HttpOnly Cookie等）またはリフレッシュトークン戦略の必要性に言及している
  - △（部分検出）: JWTの保存先またはリフレッシュトークンのいずれか一方の問題に言及しているが、状態管理の観点または具体的な改善案に触れていない
  - ×（未検出）: JWTの保存先とリフレッシュトークン戦略について言及していない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | SOLID原則・構造設計 | UserServiceとCourseServiceの依存方向の問題（CourseServiceがUserServiceを呼ぶ認証フローは、依存方向として不適切な可能性がある。認証はAPI Gatewayレベルで処理し、各サービスは認証済みコンテキストを受け取るべき） | サービス間の依存方向の不適切さ、または認証の責務配置について具体的に指摘している |
| B02 | API・データモデル品質 | エラーレスポンス形式の不十分さ（`error_code`とmessageのみでは、クライアント側のエラーハンドリングが困難。statusコード、詳細情報、ユーザー向けメッセージ/開発者向けメッセージの分離等が必要） | エラーレスポンス形式の拡張必要性について指摘している |
| B03 | エラーハンドリング・オブザーバビリティ | ロギング戦略の具体性欠如（構造化ログ、ログレベル戦略、トレーシングIDの欠如等） | ロギング戦略の具体的な改善点を指摘している |
| B04 | テスト設計・テスタビリティ | テスト戦略の役割分担不明確（単体/統合/E2Eの境界が不明確で、「統合テストで全体動作を確認」という記述は責務が曖昧） | テスト戦略の役割分担について指摘している |
| B05 | 拡張性・運用設計 | 動画エンコーディングの非同期処理設計の欠如（VideoServiceの説明にエンコーディング処理の非同期化やRabbitMQとの連携が明示されていない） | 動画エンコーディングの非同期処理設計について指摘している |
| B06 | 変更容易性・モジュール設計 | MongoDBとPostgreSQLの使い分け方針の不明確さ（どのデータをどちらに保存するかの基準が不明確） | データストアの使い分け基準について指摘している |
| B07 | API・データモデル品質 | assignment_submissionsテーブルの参照整合性制約の欠如（assignment_id、user_idに対するFOREIGN KEY制約が定義されていない） | 参照整合性制約の欠如について指摘している |
| B08 | SOLID原則・構造設計 | VideoServiceの責務範囲の曖昧さ（アップロード、エンコーディング、ストリーミングURLの生成という複数の処理フェーズを単一サービスで担当しており、責務が広すぎる可能性） | VideoServiceの責務範囲について指摘している |
| B09 | 拡張性・運用設計 | スケーラビリティ設計の具体性欠如（オートスケーリングの基準は定義されているが、ステートレス設計の保証、セッション管理戦略、共有状態の扱いが不明確） | スケーラビリティ設計の具体的な考慮事項について指摘している |
| B10 | API・データモデル品質 | MongoDB learning_progressのスキーマ設計の冗長性（video_idとcourse_idの両方を持つが、videoとcourseの関連が正規化されておらず、データ整合性リスクがある） | MongoDB learning_progressのスキーマ設計について指摘している |
