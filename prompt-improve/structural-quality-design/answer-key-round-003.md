# 正解キー

## 実行条件
- **観点**: structural-quality
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: PaymentServiceの単一責務原則(SRP)違反
- **カテゴリ**: SOLID原則・構造設計
- **深刻度**: 重大
- **該当箇所**: セクション3 (アーキテクチャ設計) - PaymentService
- **問題の説明**: PaymentServiceが決済処理、返金処理、サブスクリプション管理、Webhook配信、通知メール送信、マーチャント残高計算、レート制限チェックという7つの異なる責務を持っている。単一のサービスクラスに複数の独立した責務を集約すると、変更理由が複数発生し、テスト容易性・保守性が低下する。
- **検出判定基準**:
  - ○（検出）: PaymentServiceの責務過多またはSRP違反を明示的に指摘し、責務分離（例: NotificationService、SubscriptionService、WebhookService等への分割）を提案している
  - △（部分検出）: PaymentServiceの複雑性やモジュール分割の必要性に言及しているが、SOLID原則や責務分離の観点から具体的な分割案を提示していない
  - ×（未検出）: PaymentServiceの設計に関する言及がない

### P02: 外部依存の直接結合（レイヤー責務違反）
- **カテゴリ**: SOLID原則・構造設計
- **深刻度**: 重大
- **該当箇所**: セクション3 (アーキテクチャ設計) - PaymentController
- **問題の説明**: PaymentController (API Layer) が Stripe/PayPal SDK を直接呼び出している。3層アーキテクチャの原則に反し、プレゼンテーション層がインフラストラクチャ層と直接結合している。これによりテスト容易性が低下し、決済プロバイダーの切り替え時に広範な変更が必要になる。
- **検出判定基準**:
  - ○（検出）: PaymentControllerが外部SDK（Stripe/PayPal）を直接呼び出している点を問題として指摘し、責務分離またはレイヤー違反の観点から改善案（Service層への移動、インターフェース抽象化等）を提示している
  - △（部分検出）: 外部依存の抽象化やインターフェース導入の必要性に言及しているが、PaymentControllerの具体的な責務違反に触れていない
  - ×（未検出）: PaymentControllerの設計に関する言及がない、またはSDK直接呼び出しを問題視していない

### P03: データモデルの正規化違反（データ冗長性）
- **カテゴリ**: API・データモデル品質
- **深刻度**: 重大
- **該当箇所**: セクション4 (データモデル) - Payment テーブル
- **問題の説明**: Payment テーブルに merchant_name と merchant_email が格納されており、merchant_id のみで正規化すべき情報が冗長に保存されている。マーチャント情報の変更時に複数レコードの更新が必要になり、データ不整合のリスクがある。
- **検出判定基準**:
  - ○（検出）: Payment テーブルの merchant_name/merchant_email カラムが正規化違反またはデータ冗長性の問題として指摘され、Merchant テーブルへの分離提案がある
  - △（部分検出）: データモデルの正規化や冗長性の一般的な問題に言及しているが、Payment テーブルの具体的なカラムに触れていない
  - ×（未検出）: データモデル設計に関する言及がない、またはPayment テーブルの冗長性に触れていない

### P04: 変更影響の波及（インターフェース不安定性）
- **カテゴリ**: 変更容易性・モジュール設計
- **深刻度**: 中
- **該当箇所**: セクション3 (データフロー) - PaymentService → 決済プロバイダーSDK直接呼び出し
- **問題の説明**: PaymentServiceが決済プロバイダーSDKを直接呼び出しており、プロバイダーの追加・変更時にPaymentServiceの修正が必要になる。抽象化層（PaymentGatewayインターフェース等）がないため、Open-Closed原則に違反し、変更影響が広範囲に及ぶ。
- **検出判定基準**:
  - ○（検出）: 決済プロバイダーSDKの直接呼び出しによる変更影響の波及またはOpen-Closed原則違反を指摘し、抽象化層（インターフェース、Adapter/Strategyパターン等）の導入を提案している
  - △（部分検出）: 決済プロバイダーの抽象化やインターフェース導入の必要性に言及しているが、変更影響の波及や拡張性の観点から説明していない
  - ×（未検出）: 決済プロバイダー統合設計に関する言及がない

### P05: テスト戦略の欠如
- **カテゴリ**: テスト設計・テスタビリティ
- **深刻度**: 中
- **該当箇所**: セクション6 (実装方針) - テスト方針
- **問題の説明**: テスト方針が「現時点では未定義。今後検討予定」となっており、単体/統合/E2Eテストの役割分担、テストカバレッジ目標、テストデータ管理方針等が定義されていない。決済システムという重要ドメインにおいて、テスト戦略の欠如は品質リスクを高める。
- **検出判定基準**:
  - ○（検出）: テスト戦略が未定義である点を問題として指摘し、単体/統合/E2Eテストの役割分担、テストカバレッジ目標、またはテストデータ管理の必要性を提案している
  - △（部分検出）: テストの重要性やテスト方針の必要性に言及しているが、具体的なテスト戦略（役割分担、カバレッジ目標等）に触れていない
  - ×（未検出）: テスト方針に関する言及がない

### P06: DI設計の欠如によるテスト困難性
- **カテゴリ**: テスト設計・テスタビリティ
- **深刻度**: 中
- **該当箇所**: セクション3 (アーキテクチャ設計) - PaymentController、PaymentService
- **問題の説明**: 設計書に依存性注入(DI)に関する記述がなく、PaymentControllerがSDKを直接インスタンス化する可能性がある。DI設計がない場合、単体テストでのモック化が困難になり、テスト実行時に実際の決済プロバイダーAPIを呼び出すリスクがある。
- **検出判定基準**:
  - ○（検出）: DI設計の欠如またはコンストラクタインジェクションの必要性を明示的に指摘し、テスト容易性（モック可能性）の観点から改善案を提示している
  - △（部分検出）: テスト容易性やモック化の重要性に言及しているが、DI設計の具体的な欠如に触れていない
  - ×（未検出）: DI設計またはテスト容易性に関する言及がない

### P07: エラーハンドリング戦略の不完全性
- **カテゴリ**: エラーハンドリング・オブザーバビリティ
- **深刻度**: 中
- **該当箇所**: セクション6 (実装方針) - エラーハンドリング方針
- **問題の説明**: エラーハンドリング方針が「決済プロバイダーAPIエラー時は即座にエラーレスポンス返却」となっており、一時的なネットワークエラーと恒久的なエラーの区別、エラー分類、リカバリー戦略（再試行ポリシー等）が定義されていない。決済処理において適切なエラーハンドリングは必須である。
- **検出判定基準**:
  - ○（検出）: エラー分類（一時的/恒久的、リトライ可能/不可能等）の欠如またはリカバリー戦略（再試行ポリシー、フォールバック等）の必要性を指摘している
  - △（部分検出）: エラーハンドリングの改善必要性に言及しているが、エラー分類やリカバリー戦略の具体的な欠如に触れていない
  - ×（未検出）: エラーハンドリング方針に関する言及がない

### P08: 環境固有設定のハードコード
- **カテゴリ**: 拡張性・運用設計
- **深刻度**: 軽微
- **該当箇所**: セクション6 (実装方針) - デプロイメント方針
- **問題の説明**: 「環境変数で dev/staging/production の切り替え実施（データベース接続情報、決済プロバイダーAPIキー等をハードコード）」と記載されており、環境固有設定の管理戦略が不明瞭。機密情報のハードコードは避けるべきであり、AWS Secrets Manager等のシークレット管理サービスの利用が推奨される。
- **検出判定基準**:
  - ○（検出）: 環境固有設定のハードコードまたは機密情報管理の問題を指摘し、外部化方式（Secrets Manager、環境変数、設定ファイル等）を提案している
  - △（部分検出）: 設定管理の改善必要性に言及しているが、ハードコードの具体的な問題に触れていない
  - ×（未検出）: 設定管理方針に関する言及がない

### P09: RESTful API設計原則違反
- **カテゴリ**: API・データモデル品質
- **深刻度**: 軽微
- **該当箇所**: セクション5 (API設計) - エンドポイント一覧
- **問題の説明**: `POST /payments/{id}/cancel`, `POST /subscriptions/{id}/pause`, `DELETE /subscriptions/{id}` のエンドポイントがRESTful原則に反している。キャンセルや一時停止は状態更新であり `PATCH /payments/{id}` (body: {status: "cancelled"}) とすべき。削除操作は DELETE を使用しているが、サブスクリプションの論理削除であれば PATCH でステータス更新すべき。
- **検出判定基準**:
  - ○（検出）: POST /payments/{id}/cancel または POST /subscriptions/{id}/pause がRESTful原則違反（状態更新はPATCH使用すべき）であることを指摘している
  - △（部分検出）: RESTful API設計の改善必要性に言及しているが、具体的なエンドポイント（cancel/pause）に触れていない
  - ×（未検出）: API設計に関する言及がない、またはRESTful原則違反に触れていない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | セキュリティ・ロギング | ロギング方針で決済リクエスト/レスポンスの全フィールドをログ出力することが、カード情報等の機密データ漏洩リスクになる点 | 機密情報のログ出力リスクまたはPCI DSS違反の可能性を指摘 |
| B02 | API・データモデル品質 | APIエンドポイントにバージョニング戦略（/v1/payments等）が含まれていない点 | APIバージョニングの欠如または後方互換性戦略の必要性を指摘 |
| B03 | データモデル設計 | Refund テーブルの payment_id に外部キー制約があるが、カスケード削除/更新の戦略が未定義である点 | 参照整合性の保証戦略（カスケード削除、論理削除等）の必要性を指摘 |
| B04 | 変更容易性 | データフローで PaymentService → WebhookPublisher の依存があるが、Webhook配信失敗時の決済処理への影響が不明確（結合度の問題）である点 | Webhook配信と決済処理の結合度または非同期化の必要性を指摘 |
| B05 | エラーハンドリング・オブザーバビリティ | ログレベルがproductionでWARNとなっており、正常系のINFOログが出力されず、トラブルシューティング時に決済フローの追跡が困難になる点 | ログレベル設定の不適切さまたは可観測性の欠如を指摘 |
