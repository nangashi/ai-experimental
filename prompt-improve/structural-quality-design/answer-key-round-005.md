# 正解キー

## 実行条件
- **観点**: structural-quality
- **対象**: design
- **埋め込み問題数**: 9問

## 埋め込み問題一覧

### P01: PropertyManagementServiceの単一責務原則違反
- **カテゴリ**: SOLID原則・構造設計
- **深刻度**: 重大
- **該当箇所**: セクション3.2「PropertyManagementService」
- **問題の説明**: PropertyManagementServiceが物件管理だけでなく、顧客マッチング、内見予約計算、契約ステータス更新、統計データ集計という複数の異なる責務を担当している。これは単一責務原則（SRP）に違反し、変更理由が複数存在する状態（物件管理ロジックの変更、マッチングアルゴリズムの変更、統計計算の変更など）を引き起こす。
- **検出判定基準**:
  - ○（検出）: PropertyManagementServiceが複数の異なる責務（物件管理+マッチング+予約+契約+統計のうち2つ以上）を持つことを指摘し、単一責務原則違反または責務分離の必要性に言及している
  - △（部分検出）: PropertyManagementServiceが多機能すぎることに言及しているが、単一責務原則や責務分離の観点での問題提起がない
  - ×（未検出）: 上記の指摘がない

### P02: NotificationServiceの外部依存直接結合
- **カテゴリ**: テスト設計・テスタビリティ
- **深刻度**: 重大
- **該当箇所**: セクション3.2「NotificationService」
- **問題の説明**: NotificationServiceがSMTP接続やSMS APIを直接呼び出しており、外部依存が抽象化されていない。これにより単体テストでのモック化が困難になり、テスタビリティが著しく低下する。また、メール送信/SMS送信のプロバイダー変更時に実装クラス全体の修正が必要になる。
- **検出判定基準**:
  - ○（検出）: NotificationServiceの外部依存（SMTP、SMS API）が直接結合されていることを指摘し、抽象化の欠如またはテスタビリティの問題に言及している
  - △（部分検出）: 外部依存の存在に言及しているが、抽象化やテスタビリティの観点での問題提起がない
  - ×（未検出）: 上記の指摘がない

### P03: データモデルの冗長性とデータ整合性リスク
- **カテゴリ**: API・データモデル品質
- **深刻度**: 重大
- **該当箇所**: セクション4.1「主要エンティティと関連」、セクション4.2「注意事項」
- **問題の説明**: propertiesテーブルに物件オーナー情報を直接含める設計は、同一オーナーが複数物件を所有する場合にデータ冗長性を引き起こす。また、外部キー制約を設定せずアプリケーション側で整合性を管理する方針は、データの不整合（孤児レコード、存在しないbroker_idへの参照など）リスクを大幅に増大させる。
- **検出判定基準**:
  - ○（検出）: 以下のいずれかまたは両方を指摘している：(a) オーナー情報の冗長性とエンティティ分離の必要性、(b) 外部キー制約の欠如による整合性リスク
  - △（部分検出）: データモデルの改善提案があるが、冗長性や整合性リスクの具体的な問題点に触れていない
  - ×（未検出）: 上記の指摘がない

### P04: PropertyManagementServiceの過剰な依存注入
- **カテゴリ**: SOLID原則・構造設計
- **深刻度**: 中
- **該当箇所**: セクション3.2「PropertyManagementService」
- **問題の説明**: PropertyManagementServiceが6つもの依存（PropertyRepository, CustomerRepository, AppointmentRepository, ContractRepository, ElasticsearchTemplate, RedisTemplate）をAutowiredしている。これは単一責務原則違反の兆候であり、Serviceクラスの責務が過度に広範になっていることを示す。結合度が高く、テストの複雑性も増大する。
- **検出判定基準**:
  - ○（検出）: PropertyManagementServiceの依存数が過剰であることを指摘し、責務分離または依存削減の必要性に言及している
  - △（部分検出）: 依存が多いことに言及しているが、責務分離や設計改善の観点での問題提起がない
  - ×（未検出）: 上記の指摘がない

### P05: RESTful API設計原則違反（動詞ベースURL）
- **カテゴリ**: API・データモデル品質
- **深刻度**: 中
- **該当箇所**: セクション5.1「エンドポイント一覧」
- **問題の説明**: APIエンドポイントが`/properties/create`, `/properties/update/{id}`, `/properties/delete/{id}`のように動詞ベースのURLを使用しており、RESTful設計原則に反している。RESTでは`POST /properties`, `PUT /properties/{id}`, `DELETE /properties/{id}`のようにHTTPメソッドで操作を表現すべき。
- **検出判定基準**:
  - ○（検出）: エンドポイントURLに動詞が含まれていることを指摘し、RESTful原則への不適合またはHTTPメソッドの適切な使用に言及している
  - △（部分検出）: API設計の改善を提案しているが、RESTful原則やHTTPメソッドの観点での問題提起がない
  - ×（未検出）: 上記の指摘がない

### P06: エラー分類・リカバリー戦略の欠如
- **カテゴリ**: エラーハンドリング・オブザーバビリティ
- **深刻度**: 中
- **該当箇所**: セクション6.1「エラーハンドリング方針」
- **問題の説明**: エラーハンドリング方針がHTTPステータスコードによる大まかな分類（400, 404, 500）のみで、アプリケーションレベルのエラー分類体系（ビジネスルール違反、リソース不足、外部サービス障害など）やリカバリー戦略（リトライ可能/不可能の区別、補償トランザクション等）が定義されていない。これにより、障害時の適切な対応や運用時のエラー分析が困難になる。
- **検出判定基準**:
  - ○（検出）: アプリケーションレベルのエラー分類体系またはリカバリー戦略の欠如を指摘している
  - △（部分検出）: エラーハンドリングの改善を提案しているが、エラー分類やリカバリー戦略の観点での問題提起がない
  - ×（未検出）: 上記の指摘がない

### P07: 環境固有設定の管理戦略欠如
- **カテゴリ**: 拡張性・運用設計
- **深刻度**: 中
- **該当箇所**: セクション2.3「インフラ・デプロイ環境」、セクション6.4「デプロイメント方針」
- **問題の説明**: ステージング環境と本番環境が存在するが、環境ごとの設定差分（データベース接続文字列、外部API Key、機能フラグ等）をどのように管理するかの戦略が明示されていない。NotificationServiceのAPIキーがハードコードされている点も環境差分管理の問題を示唆している。
- **検出判定基準**:
  - ○（検出）: 環境固有設定の管理戦略の欠如またはハードコードされた設定値の問題を指摘している
  - △（部分検出）: 設定管理の改善を提案しているが、環境差分や設定外部化の観点での問題提起がない
  - ×（未検出）: 上記の指摘がない

### P08: テスト戦略の具体性不足
- **カテゴリ**: テスト設計・テスタビリティ
- **深刻度**: 軽微
- **該当箇所**: セクション6.3「テスト方針」
- **問題の説明**: 単体テスト、統合テスト、E2Eテストの役割分担が明確でない。「Serviceレイヤーをテスト」「Repository/API全体をテスト」という記述はあるが、各テスト層で何を検証し、何を検証しないかの境界が曖昧。また、外部依存（Elasticsearch、Redis、外部API）をどのようにモック/スタブ化するかの方針が不明。
- **検出判定基準**:
  - ○（検出）: テスト戦略における各層の役割分担の曖昧さまたは外部依存のテスト方針の欠如を指摘している
  - △（部分検出）: テスト改善の提案があるが、役割分担や外部依存の観点での問題提起がない
  - ×（未検出）: 上記の指摘がない

### P09: Cookieベースのトークン保存によるセキュリティリスク
- **カテゴリ**: 変更容易性・モジュール設計（状態管理）
- **深刻度**: 軽微
- **該当箇所**: セクション5.3「認証・認可方式」
- **問題の説明**: JWTトークンをCookieに保存する方針は、CSRF対策が不十分な場合にセキュリティリスクとなる可能性がある。また、セクション7.2でCSRF対策としてSpring Securityのデフォルト設定を使用するとあるが、Cookieベーストークンとの整合性や具体的な対策（SameSite属性、HttpOnly属性等）が明示されていない。状態管理の観点では、トークン保存方式の選択理由とトレードオフが説明されていない。
- **検出判定基準**:
  - ○（検出）: CookieベースのJWT保存におけるCSRFリスクまたはセキュリティ属性（SameSite, HttpOnly）の欠如を指摘している
  - △（部分検出）: JWT保存方式に関する指摘があるが、セキュリティリスクや具体的な対策の観点での問題提起がない
  - ×（未検出）: 上記の指摘がない

## ボーナス問題リスト

正解キーに含めないが、検出された場合にボーナスとして加点する問題の候補:

| ID | カテゴリ | 内容 | ボーナス条件 |
|----|---------|------|------------|
| B01 | SOLID原則・構造設計 | CustomerManagementServiceの責務が不明瞭（顧客管理と希望条件管理が混在） | 顧客管理と希望条件の責務分離またはモジュール化の必要性を指摘 |
| B02 | 拡張性・運用設計 | 通知チャネル追加時にNotificationServiceの大幅修正が必要（Strategy/Pluginパターンの欠如） | 通知チャネルの拡張性問題またはStrategy/Pluginパターンの必要性を指摘 |
| B03 | API・データモデル品質 | APIバージョニング戦略が欠如 | APIのバージョニング戦略または後方互換性の考慮が欠如していることを指摘 |
| B04 | エラーハンドリング・オブザーバビリティ | ロギング設計の具体性不足（構造化ログ、ログレベル戦略、トレーシングの欠如） | ログの構造化、分散トレーシング、またはコンテキスト伝播の必要性を指摘 |
| B05 | 変更容易性・モジュール設計 | DTOとドメインモデルの分離が不明確（MapStructの使用は記載されているが設計方針が不明） | DTOとドメインモデルの分離戦略またはレイヤー間のデータ変換方針の明確化を指摘 |
| B06 | テスト設計・テスタビリティ | DI設計の不足（NotificationServiceのハードコードされた依存により、テスト時のモック化が困難） | DI/DIコンテナの活用不足またはコンストラクタインジェクションの欠如を指摘 |
