# 正解キー

## 埋め込み問題一覧

### 問題1: XSS脆弱性（入力サニタイズ欠如）
- **カテゴリ**: セキュリティ
- **深刻度**: 重大
- **該当箇所**: FR-1のHTMLリッチテキスト入力、FR-2の`dangerouslySetInnerHTML`による直接表示、Controller実装案でのバリデーション欠如
- **期待される指摘**: レビュー本文がHTMLとして入力・表示される設計にXSSリスクがある。サニタイズライブラリ（DOMPurifyなど）の導入、またはサーバーサイドでのHTMLサニタイズが必要。
- **検出判定基準**: XSS、HTMLサニタイズ、dangerouslySetInnerHTMLのリスク、入力バリデーションのいずれかに言及していれば○。セキュリティ一般論のみで具体的にXSSに触れていなければ△。

### 問題2: ページネーション欠如
- **カテゴリ**: パフォーマンス
- **深刻度**: 重大
- **該当箇所**: FR-2「全レビューを新着順で取得」、Controller実装案の`getProductReviews`でLIMIT/OFFSETなし
- **期待される指摘**: レビュー件数が増加した場合にパフォーマンスが劣化する。ページネーション（LIMIT/OFFSET またはカーソルベース）の実装が必要。
- **検出判定基準**: ページネーション/無制限取得の問題に言及していれば○。パフォーマンスの一般論のみなら△。

### 問題3: God Object（Reviewモデルの責務過多）
- **カテゴリ**: 設計原則
- **深刻度**: 中
- **該当箇所**: models/Review.tsにcalculateAverage、sendNotification、generateReportメソッドが含まれている
- **期待される指摘**: Reviewモデルがデータ表現以外の責務（計算、通知、レポート生成）を持ちすぎている。単一責任原則に違反。通知はNotificationService、集計はReviewStatisticsServiceなどに分離すべき。
- **検出判定基準**: Reviewモデルの責務過多、SRP違反、メソッドの分離の必要性のいずれかに言及していれば○。設計の改善を一般的に示唆するのみなら△。

### 問題4: アーキテクチャパターンの不一致
- **カテゴリ**: 一貫性
- **深刻度**: 中
- **該当箇所**: Controller実装案でServiceとRepositoryを経由せず直接DBクエリを実行している（既存コードはController→Service→Repositoryパターン）
- **期待される指摘**: 既存コードベースのRepository+Serviceパターンに従い、ReviewService、ReviewRepositoryを作成すべき。Controllerで直接DBクエリを書くのは既存パターンと不一致。
- **検出判定基準**: 既存パターン（Repository/Service）との不一致を指摘していれば○。アーキテクチャの一般的な改善のみなら△。

### 問題5: エラーケース未定義
- **カテゴリ**: エラーハンドリング
- **深刻度**: 中
- **該当箇所**: Controller実装案にtry-catchなし、エラーケース（重複投稿、削除済商品へのレビュー、未購入商品へのレビュー等）が定義されていない
- **期待される指摘**: 既存パターンに従いtry-catch + next(error)を使用すべき。重複投稿防止、存在しない商品へのレビュー、未購入商品へのレビュー、レート制限等のエラーケースを定義すべき。
- **検出判定基準**: エラーハンドリングの欠如と具体的なエラーケースの列挙があれば○。エラーハンドリング一般の指摘のみなら△。

### 問題6: テスト方針の欠如
- **カテゴリ**: テスト
- **深刻度**: 軽微
- **該当箇所**: 設計方針全体にテストに関する記述がない（既存コードはJest+supertestを使用）
- **期待される指摘**: テスト戦略（ユニットテスト、統合テスト、テストケース）を計画に含めるべき。既存のJest+supertestパターンに従うべき。
- **検出判定基準**: テスト方針・テスト戦略の必要性に言及していれば○。テストに全く触れていなければ×。

### 問題7: 計算ロジックの重複
- **カテゴリ**: 保守性
- **深刻度**: 中
- **該当箇所**: FR-3でフロントエンドとバックエンドの両方で平均評価を計算、Review.calculateAverage静的メソッドも存在
- **期待される指摘**: 平均評価の計算ロジックが3箇所（モデル、Controller、フロントエンド）に重複している。Single Source of Truthの原則に従い、バックエンドAPIのみで計算し、フロントエンドはAPIレスポンスの値を表示するだけにすべき。
- **検出判定基準**: 計算ロジックの重複・DRY違反に言及していれば○。重複を示唆する程度なら△。

### 問題8: インデックス設計の欠如
- **カテゴリ**: データ設計
- **深刻度**: 重大
- **該当箇所**: DBスキーマでproduct_id、user_id、created_atにインデックスが定義されていない
- **期待される指摘**: product_idでの検索が頻繁に行われるため、最低限product_idにインデックスを作成すべき。(product_id, created_at)の複合インデックスが望ましい。user_idにもインデックスが必要。
- **検出判定基準**: インデックスの必要性に具体的に言及していれば○。DBパフォーマンスの一般論のみなら△。

### 問題9: 外部ライブラリの未指定
- **カテゴリ**: 依存関係
- **深刻度**: 軽微
- **該当箇所**: 画像アップロードセクション「ライブラリは適当なものを使う」
- **期待される指摘**: 使用するS3ライブラリ（例: @aws-sdk/client-s3）を具体的に指定し、バージョンを固定すべき。「適当なもの」は実装のブレを招く。画像リサイズのライブラリも指定が必要。
- **検出判定基準**: ライブラリの具体名・バージョン指定の必要性に言及していれば○。依存関係管理の一般論のみなら△。

### 問題10: 平均評価の毎回全件集計
- **カテゴリ**: スケーラビリティ
- **深刻度**: 軽微
- **該当箇所**: FR-3「バックエンドでも全レビューから毎回計算」、Controller実装案のgetProductReviewsで毎回reduce
- **期待される指摘**: レビュー数が増加すると毎回の全件集計がボトルネックになる。productsテーブルにaverage_ratingとreview_countカラムを追加し、レビュー投稿時にインクリメンタル更新するか、マテリアライズドビュー/キャッシュを使用すべき。
- **検出判定基準**: 事前集計/キャッシュの必要性に言及していれば○。パフォーマンスの一般論のみなら△。

---

## ボーナス問題（正解キー外だが、検出された場合は誤検出としない）

- 画像アップロードのファイルサイズ・形式バリデーション
- レビュー投稿の認可チェック（購入済みユーザーのみ）
- 画像URLの署名付きURL使用
- レビュー編集機能の欠如
- 管理者認可のミドルウェア設計
- CSRF対策
- レート制限
