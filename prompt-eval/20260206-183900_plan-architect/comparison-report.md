# プロンプト構造バリエーション比較レポート

## 1. 実行条件

- **対象プロンプト**: `.claude/agents/plan-architect.md`
- **使用モデル**: claude-sonnet-4-5-20250929
- **実行日時**: 2026-02-06 18:35
- **テスト入力**: ECサイト「ShopNow」商品レビュー機能追加（10問題埋め込み）
- **埋め込み問題数**: 10問
- **実行回数**: 2回（再現性検証）

## 2. 定量結果サマリ

### 2.1 検出率マトリクス（Run 1）

| # | カテゴリ: 問題名 | 深刻度 | A | B | C | D | E | F | G | H | I | J |
|---|-----------------|--------|---|---|---|---|---|---|---|---|---|---|
| 1 | セキュリティ: XSS脆弱性 | 重大 | × | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ |
| 2 | パフォーマンス: ページネーション欠如 | 重大 | × | ○ | × | △ | × | × | ○ | × | ○ | ○ |
| 3 | 設計原則: God Object | 中 | × | ○ | × | × | ○ | ○ | ○ | ○ | ○ | ○ |
| 4 | 一貫性: パターン不一致 | 中 | × | ○ | × | × | ○ | ○ | ○ | ○ | ○ | △ |
| 5 | エラーハンドリング: エラーケース未定義 | 中 | ○ | ○ | × | ○ | ○ | ○ | ○ | ○ | ○ | ○ |
| 6 | テスト: テスト方針欠如 | 軽微 | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ |
| 7 | 保守性: 計算ロジック重複 | 中 | × | ○ | △ | × | △ | × | △ | ○ | ○ | ○ |
| 8 | データ設計: インデックス欠如 | 重大 | △ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ |
| 9 | 依存関係: ライブラリ未指定 | 軽微 | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ |
| 10 | スケーラビリティ: 毎回全件集計 | 軽微 | × | ○ | △ | △ | ○ | △ | × | × | ○ | ○ |
| **合計** | | | **3.5** | **10.0** | **5.0** | **7.0** | **8.5** | **7.5** | **8.5** | **8.0** | **10.0** | **9.5** |

### 2.2 検出率マトリクス（Run 2）

| # | カテゴリ: 問題名 | 深刻度 | A | B | C | D | E | F | G | H | I | J |
|---|-----------------|--------|---|---|---|---|---|---|---|---|---|---|
| 1 | セキュリティ: XSS脆弱性 | 重大 | × | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ |
| 2 | パフォーマンス: ページネーション欠如 | 重大 | × | ○ | × | △ | △ | × | ○ | × | ○ | ○ |
| 3 | 設計原則: God Object | 中 | × | ○ | × | × | × | × | ○ | △ | ○ | × |
| 4 | 一貫性: パターン不一致 | 中 | △ | △ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ |
| 5 | エラーハンドリング: エラーケース未定義 | 中 | ○ | ○ | △ | ○ | ○ | ○ | ○ | ○ | ○ | ○ |
| 6 | テスト: テスト方針欠如 | 軽微 | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ |
| 7 | 保守性: 計算ロジック重複 | 中 | × | ○ | △ | × | ○ | ○ | ○ | ○ | ○ | ○ |
| 8 | データ設計: インデックス欠如 | 重大 | ○ | ○ | × | ○ | △ | × | ○ | × | ○ | ○ |
| 9 | 依存関係: ライブラリ未指定 | 軽微 | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ |
| 10 | スケーラビリティ: 毎回全件集計 | 軽微 | × | ○ | △ | × | ○ | × | △ | × | ○ | ○ |
| **合計** | | | **4.5** | **9.5** | **5.5** | **6.5** | **8.0** | **6.0** | **9.5** | **6.5** | **10.0** | **9.0** |

### 2.3 再現性分析（Run 1 vs Run 2）

| バリエーション | R1 | R2 | 平均 | 差分 | 安定性 |
|--------------|-----|-----|------|------|--------|
| I: 具体例付き | 10.0 | 10.0 | **10.0** | 0.0 | ★★★ 完全安定 |
| B: ミニマル | 10.0 | 9.5 | **9.75** | -0.5 | ★★★ 高安定 |
| J: 定量スコアリング | 9.5 | 9.0 | **9.25** | -0.5 | ★★★ 高安定 |
| G: 出力形式簡略 | 8.5 | 9.5 | **9.0** | +1.0 | ★★ 中安定 |
| E: 骨格のみ | 8.5 | 8.0 | **8.25** | -0.5 | ★★★ 高安定 |
| H: 分析手順明示 | 8.0 | 6.5 | **7.25** | -1.5 | ★ 低安定 |
| D: 見出し拡張 | 7.0 | 6.5 | **6.75** | -0.5 | ★★★ 高安定 |
| F: 詳細記述 | 7.5 | 6.0 | **6.75** | -1.5 | ★ 低安定 |
| C: 見出し削減 | 5.0 | 5.5 | **5.25** | +0.5 | ★★★ 高安定 |
| A: ベースライン | 3.5 | 4.5 | **4.0** | +1.0 | ★★ 中安定 |

**安定性基準**: ★★★ |差分| ≤ 0.5pt、★★ |差分| ≤ 1.0pt、★ |差分| > 1.0pt

#### 問題別の再現性

| # | 問題名 | R1検出率 | R2検出率 | 変動 | 備考 |
|---|--------|---------|---------|------|------|
| 1 | XSS脆弱性 | 90% (9/10) | 90% (9/10) | 0% | 安定的に高検出。Aのみ両回で未検出 |
| 2 | ページネーション欠如 | 45% | 45% | 0% | 安定的に検出困難。B,G,I,Jが両回で安定検出 |
| 3 | God Object | 70% | 35% | **-35%** | **最も不安定**。R2で大幅に検出率低下 |
| 4 | パターン不一致 | 65% | 80% | +15% | R2で検出率が改善 |
| 5 | エラーケース未定義 | 80% | 85% | +5% | 安定的に高検出 |
| 6 | テスト方針欠如 | 100% | 100% | 0% | 完全安定。全バリエーションで両回とも検出 |
| 7 | 計算ロジック重複 | 55% | 65% | +10% | やや改善傾向 |
| 8 | インデックス欠如 | 95% | 65% | **-30%** | **不安定**。R2でC,F,Hが未検出に |
| 9 | ライブラリ未指定 | 100% | 100% | 0% | 完全安定。全バリエーションで両回とも検出 |
| 10 | 毎回全件集計 | 60% | 45% | -15% | やや低下傾向 |

### 2.4 定性指標サマリ

| バリエーション | 具体性 | 説明の質 | 構造性 | 平均 |
|--------------|--------|---------|--------|------|
| A: ベースライン | 5/5 | 4/5 | 5/5 | 4.7 |
| B: ミニマル | 5/5 | 5/5 | 5/5 | 5.0 |
| C: 見出し削減 | 5/5 | 5/5 | 5/5 | 5.0 |
| D: 見出し拡張 | 4/5 | 5/5 | 5/5 | 4.7 |
| E: 骨格のみ | 5/5 | 5/5 | 5/5 | 5.0 |
| F: 詳細記述 | 5/5 | 5/5 | 5/5 | 5.0 |
| G: 出力形式簡略 | 5/5 | 5/5 | 5/5 | 5.0 |
| H: 分析手順明示 | 5/5 | 5/5 | 5/5 | 5.0 |
| I: 具体例付き | 5/5 | 5/5 | 5/5 | 5.0 |
| J: 定量スコアリング | 5/5 | 5/5 | 5/5 | 5.0 |

### 2.5 誤検出サマリ

| バリエーション | 誤検出数 | 誤検出の内容（概要） |
|--------------|---------|-------------------|
| A | 0 | なし |
| B | 0 | なし |
| C | 0 | なし |
| D | 0 | なし |
| E | 0 | なし |
| F | 0 | なし |
| G | 0 | なし |
| H | 0 | なし |
| I | 0 | なし |
| J | 0 | なし |

### 2.6 総合ランキング（2回平均）

| 順位 | バリエーション | R1 | R2 | 平均 | 安定性 | 定性平均 | 誤検出 |
|-----|--------------|-----|-----|------|--------|---------|--------|
| 1 | I: 具体例付き | 10.0 | 10.0 | **10.0** | ★★★ | 5.0 | 0 |
| 2 | B: ミニマル | 10.0 | 9.5 | **9.75** | ★★★ | 5.0 | 0 |
| 3 | J: 定量スコアリング | 9.5 | 9.0 | **9.25** | ★★★ | 5.0 | 0 |
| 4 | G: 出力形式簡略 | 8.5 | 9.5 | **9.0** | ★★ | 5.0 | 0 |
| 5 | E: 骨格のみ | 8.5 | 8.0 | **8.25** | ★★★ | 5.0 | 0 |
| 6 | H: 分析手順明示 | 8.0 | 6.5 | **7.25** | ★ | 5.0 | 0 |
| 7 | D: 見出し拡張 | 7.0 | 6.5 | **6.75** | ★★★ | 4.7 | 0 |
| 7 | F: 詳細記述 | 7.5 | 6.0 | **6.75** | ★ | 5.0 | 0 |
| 9 | C: 見出し削減 | 5.0 | 5.5 | **5.25** | ★★★ | 5.0 | 0 |
| 10 | A: ベースライン | 3.5 | 4.5 | **4.0** | ★★ | 4.7 | 0 |

## 3. 構造次元ごとの分析（2回平均ベース）

### 3.1 見出し数の影響（C vs A vs D）

- **C（3見出し）: 5.25** → **A（6見出し）: 4.0** → **D（8見出し）: 6.75**
- **C → A（3→6）**: 見出し数を増やしたが検出率は逆に低下（5.25→4.0）。見出し数の増加が必ずしも問題検出を向上させるわけではない。この傾向はR1・R2とも一貫。
- **A → D（6→8）**: セキュリティ・データモデル・依存関係の専用セクションを追加したことで検出率が向上（4.0→6.75）。
- **再現性**: C(±0.5)、A(±1.0)、D(±0.5)。3バリエーションとも比較的安定しており、この傾向は信頼性が高い。
- **結論**: 見出し数の単純な増減よりも、**問題カテゴリに対応した見出しの存在**が重要。ただし、最適値がD水準（8見出し）にとどまり、見出しの追加だけでは上位バリエーション（I, B, J）には遠く及ばない。

### 3.2 サブ項目粒度の影響（E vs A vs F）

- **E（骨格のみ）: 8.25** → **A（標準）: 4.0** → **F（詳細チェックリスト）: 6.75**
- **E → A（骨格→標準）**: 骨格のみの方が大幅に高い検出率。R1(8.5 vs 3.5)、R2(8.0 vs 4.5)とも一貫。
- **A → F（標準→詳細）**: 詳細チェックリストで改善するが、骨格のみ(E)には及ばない。さらにFはR2で1.5pt低下（7.5→6.0）と不安定。
- **再現性**: E(±0.5 ★★★) vs F(±1.5 ★)。骨格のみの方が安定性も高い。
- **結論**: **サブ項目の粒度は「ゼロ（骨格のみ）」が最も安定して効果的**。詳細チェックリスト(F)は一見効果的だが再現性が低く、実行ごとの当たり外れが大きい。中間粒度（A）は一貫して最も低いスコア。

### 3.3 出力形式の影響（G vs A vs J）

- **G（自由形式）: 9.0** → **A（6セクション構成）: 4.0** → **J（スコアリング付き）: 9.25**
- **G → A（自由→構造化）**: 自由形式の方が大幅に高い検出率。R2でGがさらに改善（8.5→9.5）し平均9.0に。
- **A → J（構造化→スコアリング）**: スコアリング基準の追加が安定的に効果的（R1: 9.5, R2: 9.0）。
- **再現性**: G(±1.0 ★★) vs J(±0.5 ★★★)。J（スコアリング）の方が安定性で優る。
- **結論**: **出力フォーマットの厳密な構造指定は問題検出を阻害する**。自由形式(G)もスコアリング(J)も高い検出率だが、Jの方が安定性に優れるため、**スコアリング基準の追加が推奨**される。

### 3.4 分析手順明示の影響（A vs H）

- **A（暗黙）: 4.0** → **H（5ステップ明示）: 7.25**
- **A → H**: CoT指示の追加が検出率を向上（+3.25pt平均）。ただしR2で1.5pt低下（8.0→6.5）。
- **再現性**: H(±1.5 ★)。CoT指示の効果は認められるが、**再現性が低い**のが課題。
- **結論**: 段階的分析手順の明示は効果的だが単独では不安定。Few-shot例やスコアリングとの組み合わせで安定化が期待される。

### 3.5 具体例の影響（A vs I）

- **A（例なし）: 4.0** → **I（3例付き）: 10.0**
- **A → I**: Few-shot例の追加が最も劇的かつ安定した改善（+6.0pt平均）。R1: 10.0、R2: 10.0で**完全再現**。
- **再現性**: I(±0.0 ★★★)。**全バリエーション中最も安定**。
- **結論**: **具体例（Few-shot）は最も強力かつ最も安定した構造変化**。2回の実行で両方とも10問中10問を完全検出。行動パターンの明示が確実にモデルの問題検出能力を引き出す。

### 3.6 全体量の影響（B vs A vs F/D）

- **B（最小12行）: 9.75** → **A（標準）: 4.0** → **F/D（最大）: 6.75**
- **B → A（最小→標準）**: R2でも最小プロンプトが高スコアを維持（10.0→9.5）。わずか0.5ptの低下のみ。
- **A → F/D（標準→最大）**: 情報量増加の効果は限定的で、F/Dともに平均6.75。
- **再現性**: B(±0.5 ★★★)。最小プロンプトは再現性も高い。
- **結論**: **プロンプトの総量と問題検出能力は逆相関の傾向**。最小プロンプトが安定して高い検出率を示す。フォーマット制約の排除がモデルの自律的分析能力を解放する効果は再現性がある。

## 4. カテゴリ別検出傾向（2回平均）

| カテゴリ | 安定検出（両回○） | 不安定（回により変動） | 安定未検出（両回×） | 考察 |
|---------|-----------------|--------------------|--------------------|------|
| P1: XSS | B,C,D,E,F,G,H,I,J | なし | A | 最も安定的に検出される問題。dangerouslySetInnerHTMLが強いシグナル |
| P2: ページネーション | B,G,I,J | D(△→△),E(×→△) | A,C,F,H | 検出困難だが、検出するバリエーションは安定的に検出 |
| P3: God Object | B,I | E(○→×),F(○→×),G(○→○),H(○→△),J(○→×) | A,C,D | **最も不安定な問題**。R2で大幅に検出率低下。責務分析は実行ごとのばらつきが大きい |
| P4: パターン不一致 | E,F,G,H,I | A(×→△),B(○→△),D(×→○),J(△→○) | C(×→○は改善) | R2で全体的に検出率改善。改善方向の変動 |
| P5: エラーケース | A,B,D,E,F,G,H,I,J | C(×→△) | なし | 安定的に高検出。try-catch欠如が明確なシグナル |
| P6: テスト方針 | 全10バリエーション | なし | なし | **完全安定**。全20回の実行で100%検出 |
| P7: DRY違反 | B,I | C(△→△安定),E(△→○),F(×→○),G(△→○),H(○→○),J(○→○) | A,D | R2で検出率改善傾向。横断的分析は学習効果あり？ |
| P8: インデックス | A(△→○),B,D,I,J | C(○→×),E(○→△),F(○→×),G,H(○→×) | なし | **不安定**。R2で3バリエーションが未検出に転落 |
| P9: ライブラリ | 全10バリエーション | なし | なし | **完全安定**。P6と同様に全20回で100%検出 |
| P10: 毎回集計 | B,E(R2で○),I,J | D(△→×),F(△→×),G(×→△) | A,H | やや不安定。集計最適化の指摘は文脈依存 |

## 5. 深刻度別検出傾向（2回平均）

| 深刻度 | R1平均検出率 | R2平均検出率 | 2回平均 | 最高バリエーション | 最低バリエーション |
|-------|------------|------------|--------|-----------------|-----------------|
| 重大 (P1,P2,P8) | 77% | 67% | 72% | I (100%/100%) | A (17%/33%) |
| 中 (P3,P4,P5,P7) | 66% | 66% | 66% | I (100%/100%) | A (25%/38%) |
| 軽微 (P6,P9,P10) | 80% | 82% | 81% | I (100%/100%) | A (67%/67%) |

- **重大問題の検出率がR2で低下**（77%→67%）。特にインデックス(P8)の検出率低下が影響。
- **軽微問題の検出率は安定**（80%→82%）。テスト方針(P6)とライブラリ(P9)が完全安定で底上げ。
- **I（具体例付き）は全深刻度で両回100%を達成**。唯一の完全検出バリエーション。

## 6. 総合考察

### 6.1 最も効果的だった構造変化（再現性加味）

**1位: Few-shot例の追加（I: 平均10.0, 差分0.0）**
ベースラインから最大かつ最安定の改善。2回とも10問完全検出は唯一。具体例が「問題検出→計画反映」という行動パターンを確実に伝達する。**効果と安定性の両面で最良の選択**。

**2位: プロンプトの最小化（B: 平均9.75, 差分-0.5）**
逆説的だが、最小プロンプトが2番目に高い平均スコアを安定して維持。フォーマット制約の排除がモデルの自律的分析能力を解放する効果は再現可能。

**3位: スコアリング基準の追加（J: 平均9.25, 差分-0.5）**
カテゴリ別の定量評価を要求することで体系的な問題探索を安定的に誘発。安定性もBと同等。

**4位: 出力形式の自由化（G: 平均9.0, 差分+1.0）**
R2で改善し平均9.0に到達。効果は高いが安定性はIやBにやや劣る。

**5位: CoT手順明示（H: 平均7.25, 差分-1.5）**
R1では8.0と高スコアだったがR2で6.5に低下。効果は認められるが単独では不安定。

### 6.2 再現性から得られた新たな知見

1. **Few-shot例は効果と安定性の両方を保証する唯一の手法**: I は2回とも10/10を達成。行動パターンの明示的な例示は、モデルの実行ごとのばらつきを完全に排除する。

2. **最小プロンプトの高性能は再現可能**: Bの高スコア（10.0→9.5）は偶然ではなく再現性がある。これはSonnet 4.5の基本的な分析能力が高いことを示し、「プロンプトは行動パターンを伝えれば十分で、詳細な構造指定は不要」という仮説を支持する。

3. **詳細記述(F)とCoT(H)は不安定**: 両者ともR2で1.5pt低下。長い指示や詳細な手順は、実行ごとにモデルの注意配分を変動させる可能性がある。

4. **God Object検出(P3)は最も不安定な問題**: R1で70%→R2で35%と検出率が半減。責務分析はモデルの「深い分析モード」に依存し、プロンプトの出力構造に注意が向くと見落とされやすい。

5. **テスト方針(P6)とライブラリ指定(P9)は完全安定**: 全20回で100%検出。これらは「計画に含めるべき標準項目」としてモデルに定着しており、プロンプト構造に依存しない。

6. **ページネーション(P2)検出の安定バリエーションは限定的**: B, G, I, Jの4つが両回で安定検出。いずれも「問題検出を促す構造変化」を持つバリエーションであり、明示的な問題検出指示がないと見落とされやすい。

### 6.3 構造次元間の相互作用の示唆

- **Few-shot + スコアリング**: I（10.0）とJ（9.25）の組み合わせは、最高の効果と安定性が期待される。具体例が行動パターンを示し、スコアリングが体系的チェックを保証する。
- **最小化 + Few-shot**: B（9.75）の成功原理にFew-shot例を追加すれば、最小限の指示で最大かつ安定した効果が得られる可能性。
- **CoT + 他手法**: H単独は不安定（±1.5）だが、Few-shotやスコアリングとの組み合わせで安定化が期待される。

### 6.4 対象プロンプトへの改善提案（再現性を考慮した優先度）

現在の `plan-architect.md` に対する具体的改善提案:

1. **Few-shot例の追加（最優先・最安定）**: 「問題検出→計画反映」の具体例を2-3個追加する。variant-Iのような形式で、XSS検出例、キャッシュ戦略例、設計原則違反例を含める。2回の検証で両方とも10/10を達成した唯一の手法。

2. **スコアリング/チェックリストの追加（高優先・安定）**: 計画の最後にセキュリティ・パフォーマンス・設計原則等のカテゴリ別自己評価を義務付ける。variant-Jのスコア表形式が安定的に効果的（平均9.25, ±0.5）。

3. **出力フォーマットの簡素化（中優先）**: 現在の6セクション構成は過度な構造指定の可能性がある。骨格のみ（E: 8.25）や自由形式（G: 9.0）の結果から、セクション構成を維持しつつサブ項目記述を大幅に簡素化すべき。

4. **明示的な問題検出指示（中優先）**: 「入力要件に問題がある場合は、計画内で問題点を指摘し、改善案を反映すること」を原則に追加。現在のプロンプトに問題検出の明示的指示がないことがA（4.0）の低スコアの主因。

5. **CoT手順は組み合わせで使用（低優先）**: 分析手順の明示は単独では不安定（±1.5）なため、Few-shotやスコアリングとの組み合わせで使用することを推奨。

### 6.5 推奨プロンプト構成

再現性検証の結果を踏まえた最適プロンプト構成:

```
[ロール定義（簡潔に）]
[計画作成の原則（5項目、骨格のみ）]
[問題検出→計画反映のFew-shot例 × 2-3個]    ← 最大の効果・最安定
[スコアリング基準表（8カテゴリ）]            ← 安定した効果
[出力フォーマット（セクション名のみ、サブ項目なし）]
[注意事項（最小限）]
```

## 7. 今後の検討事項

- ~~複数回実行での再現性確認~~: **完了**。2回実行の結果、I（Few-shot）が最安定、B（最小）が高安定であることを確認。
- **組み合わせバリエーション**: Few-shot + スコアリング、最小化 + Few-shot 等の複合バリエーションをテスト。
- **異なるテスト入力での検証**: 別ドメイン（認証システム、決済機能等）のテスト入力で同様の傾向が見られるか確認。
- **異なるモデルでの比較**: Haiku、Opus等の異なるモデルサイズでバリエーション感度が変わるか検証。特にHaiku等の小さいモデルでは最小プロンプト(B)の効果が低下し、構造指定の重要性が増す可能性がある。
- **3回以上の実行**: 特にH(CoT)やF(詳細)の不安定性について、追加実行で信頼区間を狭めることが望ましい。
- **God Object検出(P3)の安定化**: 最も不安定だった問題の検出を安定化するプロンプト手法の調査。責務分析を促すFew-shot例の追加が有効か検証。
