---
scope: 複数エージェント間の協調設計
boundary: |
  複数エージェント間の協調設計を対象とする。
  単一LLMへの指示設計は対象外。
  AI生成コードの品質管理は対象外。
research_query: 複数LLMエージェントによる協調動作の性能やコスト効率に関する手法や研究データ
---

# 複数エージェント間の協調設計

複数エージェント間の協調設計に関する研究・実践知見。

## トークンオーバーヘッドの実測

マルチエージェントアーキテクチャは同等性能で**1.6x〜6.2xのトークンオーバーヘッド**を生じる。

- 独立型: 58%オーバーヘッド
- ハイブリッド型: 515%オーバーヘッド
- 理論的に必要な量の1.5x〜7xのトークンを消費
- 入力トークンの大部分は**エージェント間の対話**から発生（ツール出力ではない）

**重要な傾向**: フロンティアLLMの能力向上に伴い、マルチエージェントのシングルエージェントに対する優位性は減少している。

## 効率化の3戦略

### 1. 適応的観察精製付きSupervisorAgent

Supervisorが各エージェントの出力を精製してから次に渡す。約30%のトークン削減。

### 2. 単一エージェントスキルライブラリへのコンパイル

マルチエージェントの能力を単一エージェント+スキルライブラリに統合する。**54%削減+レイテンシ50%削減**。エージェント間通信を排除しつつ能力を保持する。

安定したマルチエージェントワークフローは、単一エージェント+スキルライブラリへのコンパイルを検討すべき（「TeamCreateからTask toolへの卒業」パターン）。

### 3. キャッシュ付きエージェントルーティング

最小オーバーヘッドで適切なエージェントにルーティングする。

## コンテキスト分離としてのサブエージェント

サブエージェントの主目的は**コンテキストの分離**であり、組織的な役割のシミュレーションではない。

**よくある誤解**: 「レビューチーム」「設計チーム」のように人間の組織構造をエージェントにマッピングする。早期の複雑なマルチエージェントスキャフォールディングは、よりシンプルな代替案より一貫してパフォーマンスが悪い。

**実際に有効な使い方**: 各サブエージェントが独立したコンテキストウィンドウで作業し、メインのコンテキストを汚染しない。

- リサーチエージェント（読み取り専用+Web検索）→ 結果だけ返す
- 実装エージェント（フル編集権限）→ コード変更だけ返す
- セキュリティエージェント（脆弱性スキャン）→ 指摘だけ返す

**判断基準**: サブエージェント使用を「役割分担が必要か」ではなく「コンテキスト分離が必要か」で判断する。

## エラーカスケード

エラーカスケードがマルチエージェントシステムの支配的な障害パターン。

- 単一の根本原因エラーが後続の決定に伝播し、各エージェントが誤った基盤の上に構築する
- LLMはタスクを正しく開始するが実行途中で性能が劣化（不正なツールコール、JSON出力構造の崩壊）
- モデルサイズはエージェント堅牢性を予測しない: Llama 4 Maverick (400B) が Granite 4 Small (32B) を僅差でしか上回らない
- 14のマルチエージェント障害モードがシステム設計問題、エージェント間ミスアライメント、タスク検証失敗にクラスタリングされる

**設計指針**: ステップ間でエラーを分離する設計（各フェーズの出力を検証してから次フェーズへ）。ツールコール後にバリデーションチェックポイントを追加する。

## Sycophancyと合意形成の限界

- **Sycophancyは議論ラウンドの進行とともに強化**: エージェント間の不一致率が低下し性能劣化と相関
- **理論的証明**: 議論はエージェントの信念軌跡上のマルチンゲールを誘導し、**議論だけでは期待正確性は改善しない**（分散のみ変化）

**対策**:
- 匿名化でidentity-driven sycophancyをほぼ排除（回答からソース帰属を除去）
- 批判的応答生成器: 「先行回答を批判的に評価し、新しい解決策を提案せよ」という明示的フレーミング
- 対話ラウンドは3-4回が最適

## 7つの運用障害モード

1. **ループ**: 反復サイクルに陥る → 最大反復制限付きループ検出
2. **ツール誤用**: 不正パラメータ/権限超過 → 厳格なパラメータバリデーション
3. **プロンプトインジェクション**: 外部データが行動に影響 → 入力サニタイズ
4. **ドリフト**: 長い対話で元の目標から漸進的に逸脱 → 定期的な目標再アンカリング
5. **幻覚状態**: 内部モデルが実際の環境と非同期 → 状態検証チェックポイント
6. **過剰リトライ**: アプローチを変えずに失敗操作をリトライ → N回リトライ後のエスカレーションポリシー
7. **目標ミスアライメント**: 誤った目的を最適化 → 明示的な成功基準と検証

## シミュレーション観察の実践

Anthropicがマルチエージェントリサーチシステム構築で得た知見。Consoleを使い本番と同一のプロンプト・ツールでエージェントの動作をステップバイステップで観察したところ、以下の失敗モードが即座に判明した。

1. **過剰継続**: 十分な結果が得られているのに検索・分析を続ける
2. **冗長クエリ**: 検索クエリが不必要に長く詳細になる
3. **ツール選択ミス**: 利用可能なツールの中から不適切なものを選ぶ
4. **停止失敗**: タスク完了後も次のアクションを探し続ける

プロンプトエンジニアリングがマルチエージェント行動改善の主要レバーであり、Opus 4（リーダー）+ Sonnet 4（サブエージェント）構成で単一エージェントOpus 4比**90.2%性能向上**を達成した。

**設計指針**: エージェント開発ではステップバイステップ観察が不可欠。「十分な結果が得られたら停止する」を意識的に判断し、検索クエリは簡潔にする。
